<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" >
    <title>بيانات Firebase والإحصائيات - لوحة معلومات احترافية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Modern & Clean Color Palette - Unified */
        :root {
            --modern-bg-primary: #f0f4f8; /* Light gray-blue background */
            --modern-card-bg: #ffffff; /* Pure white card background */
            --modern-primary-accent: #4f46e5; /* Primary accent color (Indigo 600) */
            --modern-secondary-accent: #e0e7ff; /* Light secondary accent (Indigo 100) */
            --modern-text-dark: #1f2937; /* Dark text (Gray 800) */
            --modern-text-secondary: #6b7280; /* Secondary text (Gray 500) */
            --modern-border-light: #e5e7eb; /* Light borders (Gray 200) */
            --modern-success: #22c55e; /* Green for success (Green 500) */
            --modern-warning: #f59e0b; /* Yellow for warning (Yellow 500) */
            --modern-error: #ef4444; /* Red for error (Red 500) */
            --modern-info: #3b82f6; /* Blue for info */
            
            /* RGB values for shadows */
            --modern-primary-accent-rgb: 79, 70, 229;
            --modern-success-rgb: 34, 197, 94;
            --modern-error-rgb: 239, 68, 68;

            /* Card background colors for specific states */
            --modern-bg-light-red: #fee2e2;
            --modern-bg-light-green: #dcfce7;
            --modern-bg-light-orange: #fffbe0;
            --modern-bg-light-blue: #e0e7ff;
        }

        /* Base body styling for RTL, font, and background */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: var(--modern-bg-primary);
            color: var(--modern-text-dark);
            line-height: 1.6;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll on mobile */
        }

        /* --- Header Styles --- */
        .app-header {
            background-color: var(--modern-primary-accent);
            padding: 1rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: white;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            width: 100%;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 30;
        }

        .header-brand {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            justify-content: center;
            flex-wrap: wrap;
        }

        .header-brand .fas {
            font-size: 1.5rem;
            color: white;
        }

        /* Main Layout Container (Flex for Sidebar + Content) */
        .main-layout-container {
            display: flex;
            flex-grow: 1; /* Allow it to take available vertical space */
            width: 100%;
            max-width: 1400px; /* Slightly wider for more content */
            margin: 0 auto;
            padding: 1.5rem 1rem; /* Vertical padding, horizontal handled by children */
            box-sizing: border-box;
            flex-direction: row; /* Changed back to row for sidebar */
        }

        /* Sidebar Styles (File Explorer Tree) */
        .sidebar {
            width: 280px; /* Fixed width for sidebar on larger screens */
            background-color: var(--modern-card-bg);
            border-left: 1px solid var(--modern-border-light); /* RTL border */
            border-top-right-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            padding: 1.5rem 1rem;
            overflow-y: auto; /* Scrollable sidebar */
            flex-shrink: 0; /* Prevent shrinking */
            margin-right: 1.5rem; /* Space between sidebar and content */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }

        @media (max-width: 1023px) { /* Adjust for medium screens and smaller */
            .sidebar {
                position: fixed;
                top: 0; 
                right: -280px; /* Start off-screen to the right (RTL) */
                height: 100%;
                z-index: 50; /* Above main content */
                margin-right: 0;
                border-radius: 0;
                padding-top: 5rem; /* Space for header if fixed */
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); /* Shadow when open */
            }
            .sidebar.open {
                transform: translateX(-280px); /* Slide in from right (RTL) */
            }
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            }
            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }

        .tree-view ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tree-view li {
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--modern-text-dark);
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .tree-view li:hover {
            background-color: var(--modern-secondary-accent);
            color: var(--modern-primary-accent);
        }

        .tree-view li.active {
            background-color: var(--modern-primary-accent);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(var(--modern-primary-accent-rgb), 0.2);
        }

        .tree-view li.active .fas {
            color: white;
        }

        .tree-view li .fas {
            color: var(--modern-text-secondary);
            font-size: 1rem;
            transition: color 0.2s ease;
        }

        .tree-view li.folder > .fas {
            margin-left: 0.5rem;
        }

        .tree-view li.folder.open > .toggle-icon {
            transform: rotate(-90deg); /* Rotate arrow when open */
        }

        .tree-view ul.nested {
            padding-right: 1.5rem;
            display: none;
            margin-top: 0.25rem;
            border-right: 1px dashed var(--modern-border-light); /* Visual guide for nested items */
            padding-bottom: 0.25rem;
        }

        .tree-view ul.nested.active {
            display: block;
        }

        .tree-view li.folder {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tree-view li.folder .folder-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1;
        }

        .tree-view li.folder .toggle-icon {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: var(--modern-text-secondary);
        }

        .tree-view li.folder.active .toggle-icon {
            color: white;
        }

        .tree-view li.file-item {
            font-size: 0.9rem;
        }

        /* Main Content Area */
        .content-area {
            flex-grow: 1;
            padding-left: 1.5rem; /* Space from sidebar */
            padding-right: 1.5rem; /* Right padding */
            overflow-y: auto;
        }

        /* Card Panel Styles */
        .card-panel {
            background-color: var(--modern-card-bg);
            border: 1px solid var(--modern-border-light);
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* More pronounced shadow */
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        .card-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        }

        /* Specific accent borders for cards */
        .card-panel.accent-primary { border-right: 5px solid var(--modern-primary-accent); }
        .card-panel.accent-warning { border-right: 5px solid var(--modern-warning); }
        .card-panel.accent-error { border-right: 5px solid var(--modern-error); }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
            margin-bottom: 1.8rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--modern-border-light);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .section-title { justify-content: flex-start; }
        }

        .section-title .fas {
            font-size: 1.6rem;
            color: var(--modern-primary-accent);
        }

        .kpi-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background-color: var(--modern-card-bg);
            border: 1px solid var(--modern-border-light);
            border-radius: 1rem;
            padding: 1.25rem 1.5rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border-right: 4px solid var(--modern-primary-accent); /* Default KPI accent */
        }

        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }

        .kpi-card-title {
            font-size: 0.95rem;
            color: var(--modern-text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
        }

        /* Dynamic List Items */
        .list-item-card {
            background-color: var(--modern-bg-primary); /* Use primary background for list items */
            border: 1px solid var(--modern-border-light);
            border-radius: 0.75rem;
            padding: 0.8rem 1rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            text-align: right;
            direction: rtl;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .list-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            background-color: var(--modern-secondary-accent);
        }

        .list-item-card .icon-wrapper {
            flex-shrink: 0;
            font-size: 1.4rem;
            color: var(--modern-primary-accent);
            transition: color 0.2s ease-in-out;
        }

        .list-item-card:hover .icon-wrapper { color: var(--modern-primary-accent); }

        .list-item-card .content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .list-item-card .content-wrapper span:first-child {
            font-weight: 600;
            color: var(--modern-text-dark);
            font-size: 1rem;
        }
        .list-item-card .content-wrapper span:last-child {
            color: var(--modern-text-secondary);
            font-size: 0.85rem;
        }

        /* Custom Scrollbar */
        .custom-scrollbar {
            max-height: 350px; /* Slightly taller scrollable lists */
            overflow-y: auto;
            padding-bottom: 10px;
            padding-left: 10px;
            padding-right: 0;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; border-radius: 10px;}
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--modern-bg-primary); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--modern-border-light); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--modern-secondary-accent); }

        /* Form Elements */
        .form-input {
            padding: 0.8rem 1.2rem;
            border: 1px solid var(--modern-border-light);
            border-radius: 0.75rem; /* More rounded */
            background-color: var(--modern-card-bg);
            color: var(--modern-text-dark);
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--modern-primary-accent);
            box-shadow: 0 0 0 4px rgba(var(--modern-primary-accent-rgb), 0.25); /* Stronger focus ring */
        }

        /* Buttons */
        .modern-button {
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem; /* More rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08); /* Stronger button shadow */
            border: 1px solid transparent;
        }

        .modern-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .modern-button:active { box-shadow: inset 0 1px 4px rgba(0,0,0,0.15); transform: translateY(0); }

        .btn-primary-action {
            background-color: var(--modern-primary-accent);
            color: white;
            border-color: var(--modern-primary-accent);
            box-shadow: 0 8px 20px rgba(var(--modern-primary-accent-rgb), 0.35); /* Stronger primary shadow */
        }

        .btn-primary-action:hover { background-color: #4338ca; border-color: #4338ca; }

        .btn-danger-action {
            background-color: var(--modern-error);
            color: white;
            border-color: var(--modern-error);
            box-shadow: 0 8px 20px rgba(var(--modern-error-rgb), 0.35);
        }

        .btn-danger-action:hover { background-color: #dc2626; border-color: #dc2626; }

        .btn-clear-action {
            background-color: var(--modern-secondary-accent);
            color: var(--modern-text-dark);
            border-color: var(--modern-border-light);
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }

        .btn-clear-action:hover { background-color: var(--modern-border-light); border-color: var(--modern-border-light); }

        .btn-success-action {
            background-color: var(--modern-success);
            color: white;
            border-color: var(--modern-success);
            box-shadow: 0 8px 20px rgba(var(--modern-success-rgb), 0.35);
        }

        .btn-success-action:hover { background-color: #16a34a; border-color: #16a34a; }

        /* Loaders */
        .loader {
            border: 5px solid var(--modern-border-light);
            border-top: 5px solid var(--modern-primary-accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
            display: none;
        }

        .loader.active { display: block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Messages */
        #toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 380px; /* Slightly wider toasts */
            align-items: center;
        }

        .toast-message {
            padding: 1.1rem 1.5rem; /* Larger padding */
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            opacity: 0;
            transform: scale(0.9); /* Subtle scale effect */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.05rem;
            color: white;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
        }

        .toast-message.active { opacity: 1; transform: scale(1); }
        .toast-message i { font-size: 1.3rem; }
        .toast-message.success { background-color: var(--modern-success); }
        .toast-message.error { background-color: var(--modern-error); }
        .toast-message.info { background-color: var(--modern-info); } /* Use new info color */
        .toast-message.warning { background-color: var(--modern-warning); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-content {
            background-color: var(--modern-card-bg);
            padding: 2.8rem; /* Larger padding */
            border-radius: 1.25rem; /* More rounded */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* Stronger shadow */
            max-width: 550px; /* Slightly wider */
            width: 90%;
            text-align: center;
            transform: translateY(-50px); /* Deeper initial transform */
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .modal-overlay.active .modal-content { transform: translateY(0); opacity: 1; }

        .modal-title {
            font-size: 2rem; /* Larger title */
            font-weight: 700;
            color: var(--modern-primary-accent);
            margin-bottom: 1.5rem;
        }

        .modal-message {
            font-size: 1.15rem; /* Larger message */
            color: var(--modern-text-secondary);
            margin-bottom: 2.5rem;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Larger gap */
        }

        .invoice-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .invoice-modal-overlay.active { opacity: 1; visibility: visible; }

        .invoice-modal-content {
            background-color: var(--modern-card-bg);
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            max-width: 900px; /* Wider for invoice details */
            width: 95%;
            text-align: right;
            transform: translateY(-50px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
        }

        .invoice-modal-overlay.active .invoice-modal-content { transform: translateY(0); opacity: 1; }

        .invoice-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--modern-border-light); /* Thicker border */
            padding-bottom: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .invoice-modal-header h3 { font-size: 1.8rem; color: var(--modern-primary-accent); margin: 0; }

        .invoice-modal-info p { margin-bottom: 0.7rem; font-size: 1.05rem; color: var(--modern-text-dark); }
        .invoice-modal-info p strong { color: var(--modern-primary-accent); }

        .invoice-modal-table-wrapper {
            max-height: 350px; /* Taller table scroll */
            overflow-y: auto;
            border: 1px solid var(--modern-border-light);
            border-radius: 0.75rem;
        }

        .invoice-modal-table { width: 100%; border-collapse: collapse; text-align: right; }
        .invoice-modal-table th, .invoice-modal-table td {
            padding: 1rem 1.5rem; /* More padding */
            border-bottom: 1px solid var(--modern-border-light);
            text-align: right;
        }

        .invoice-modal-table th {
            background-color: var(--modern-secondary-accent);
            font-weight: 600;
            color: var(--modern-primary-accent);
        }

        .invoice-modal-table tbody tr:last-child td { border-bottom: none; }

        .invoice-products-table, .po-products-table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
            font-size: 0.9rem;
        }
        .invoice-products-table th, .invoice-products-table td,
        .po-products-table th, .po-products-table td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--modern-border-light);
            text-align: right;
        }
        .invoice-products-table th, .po-products-table th {
            background-color: var(--modern-bg-primary);
            color: var(--modern-text-dark);
            font-weight: 600;
        }
        .invoice-products-scrollable, .po-products-scrollable {
            max-height: 150px; /* Limit height for nested product lists */
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid var(--modern-border-light);
            border-radius: 0.75rem;
        }

        .invoice-modal-summary {
            border-top: 2px dashed var(--modern-border-light);
            padding-top: 1.2rem;
            text-align: right;
            direction: rtl;
        }

        .invoice-modal-summary p { margin-bottom: 0.7rem; font-size: 1.1rem; color: var(--modern-text-dark); }
        .invoice-modal-summary strong { color: var(--modern-primary-accent); }
        .invoice-modal-summary .total-row {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
            background-color: var(--modern-secondary-accent);
            border-top: 1px solid var(--modern-border-light);
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 0.75rem;
        }

        .invoice-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1.5rem;
            padding-top: 1.2rem;
            border-top: 2px dashed var(--modern-border-light);
        }

        .invoice-modal-actions .modern-button { flex-grow: 1; max-width: 180px; }

        @media print {
            body > *:not(.invoice-modal-overlay) { display: none; }
            .invoice-modal-overlay {
                position: static;
                background-color: white;
                display: block;
                opacity: 1;
                visibility: visible;
                height: auto;
            }
            .invoice-modal-content {
                box-shadow: none;
                max-width: none;
                width: 100%;
                padding: 0;
                transform: none;
                opacity: 1;
                border-radius: 0;
                overflow: visible;
                margin: 0;
            }
            .invoice-modal-header button, .invoice-modal-actions { display: none; }
            .invoice-modal-table-wrapper, .custom-scrollbar { max-height: none !important; overflow: visible !important; }
            .invoice-modal-table th, .invoice-modal-table td { border-color: #ddd !important; }
            .invoice-modal-summary .total-row {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                color: #000 !important;
            }
        }

        .app-footer {
            background-color: var(--modern-text-dark);
            color: white;
            text-align: center;
            padding: 1.2rem;
            margin-top: 2rem;
            font-size: 0.9rem;
            flex-shrink: 0;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
        }

        /* Burger Menu for Mobile */
        .burger-menu {
            display: none; /* Hidden by default, shown on small screens */
            background-color: transparent;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-left: 1rem; /* Space from brand */
            z-index: 60; /* Above sidebar overlay */
        }

        @media (max-width: 1023px) {
            .burger-menu {
                display: block;
            }
            .app-header .flex-col.md\:flex-row {
                flex-direction: row; /* Keep header items in a row */
                justify-content: space-between;
            }
            .app-header .header-nav-group {
                display: none; /* Hide main nav buttons on mobile when sidebar is active */
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
</head>
<body>
    <header class="app-header">
        <div class="max-w-7xl mx-auto w-full flex flex-col md:flex-row justify-between items-center flex-wrap gap-5 px-6">
            <div class="flex-shrink-0 flex items-center">
                <button type="button" id="burgerMenu" class="burger-menu lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-brand"><i class="fas fa-chart-pie"></i> لوحة تحكم تحليل البيانات</div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 md:gap-6 items-center w-full">
                <!-- Removed redundant button as navigation is now in top-nav-container -->
            </div>
        </div>
    </header>

    <div id="toast-container"></div> 
    <div id="sidebarOverlay" class="sidebar-overlay lg:hidden"></div>

    <div class="main-layout-container">
        <!-- Sidebar (Tree View) -->
        <aside class="sidebar" id="sidebar">
            <h3 class="section-title !text-xl !mb-4 !pb-2 !border-b !border-modern-border-light !justify-start">
                <i class="fas fa-folder-tree"></i> تصفح البيانات
            </h3>
            <div id="treeViewContainer" class="tree-view">
                <!-- Tree will be rendered here by JavaScript -->
                <ul id="mainTreeRoot">
                    <li class="folder" data-type="all" data-phone="all">
                        <div class="folder-label">
                            <i class="fas fa-database"></i> <span>جميع بيانات Firebase</span>
                        </div>
                        <i class="fas fa-chevron-left toggle-icon"></i>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area"> 
            <div class="app-container space-y-10 !p-0">
                <!-- Search and Filter Controls (always visible) -->
                <div class="flex flex-col gap-4 mb-6 search-filter-controls md:flex-row md:items-end md:justify-between card-panel !p-4">
                    <button type="button" id="clearCommonSearchInput"
                        class="modern-button btn-clear-action w-full md:w-auto md:shrink-0 h-11">
                        <i class="fas fa-times-circle"></i> مسح
                    </button>
                    <input type="text" id="commonSearchInput"
                        class="form-input md:flex-1 h-11"
                        placeholder="البحث برقم الهاتف، الاسم، أو المنتج..." list="allSearchOptions">
                    <datalist id="allSearchOptions"></datalist>
                    <label for="commonPhoneDropdown" class="sr-only">تصفية الكل حسب رقم الهاتف</label>
                    <select id="commonPhoneDropdown"
                        class="form-input md:flex-1 h-11">
                    </select>
                </div>

                <!-- Phone-specific Actions (visible only when a phone is selected) -->
                <div id="phoneActions" class="flex flex-wrap gap-4 mb-6 justify-center" style="display: none;">
                    <button type="button" id="exportPhoneDataBtn" class="modern-button btn-primary-action">
                        <i class="fas fa-download"></i> تصدير بيانات هذا الهاتف
                    </button>
                    <button type="button" id="deletePhoneDataBtn" class="modern-button btn-danger-action">
                        <i class="fas fa-trash-alt"></i> حذف بيانات هذا الهاتف
                    </button>
                </div>

                <!-- Sections (dynamically shown/hidden) -->
                <section id="detailed-stats" class="card-panel accent-primary">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i> إحصائيات المبيعات التفصيلية
                    </h2>
                    <div class="kpi-card-grid">
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-money-bill-wave"></i>إجمالي سعر الشراء</h3>
                            <p id="totalPurchaseCost" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-hand-holding-usd"></i>إجمالي الأرباح</h3>
                            <p id="totalProfit" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-cash-register"></i>إجمالي سعر البيع</h3>
                            <p id="totalSellingPrice" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-percent"></i>إجمالي العمولة</h3>
                            <p id="totalCommission" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-calculator"></i>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-file-invoice"></i>إجمالي TVA</h3>
                            <p id="totalTVA" class="kpi-value">0.00 DH</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-card-title"><i class="fas fa-dollar-sign"></i>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC" class="kpi-value">0.00 DH</p>
                        </div>
                    </div>

                    <div id="dynamicStatsListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-8">
                        <div class="card-panel p-4 shadow-sm flex flex-col accent-primary">
                            <h3 class="card-panel-title section-title text-modern-primary-accent !text-xl !mb-4 !pb-2 !border-b !border-modern-border-light">
                                <i class="fas fa-box-open"></i> المنتجات الأكثر مبيعاً
                            </h3>
                            <ul id="topSellingProductsList" class="custom-scrollbar space-y-2">
                                <li class="text-modern-text-dark text-center py-2">لا توجد بيانات</li>
                            </ul>
                        </div>
                        <div class="card-panel p-4 shadow-sm flex flex-col accent-primary">
                            <h3 class="card-panel-title section-title text-modern-primary-accent !text-xl !mb-4 !pb-2 !border-b !border-modern-border-light">
                                <i class="fas fa-user-friends"></i> العملاء الأكثر نشاطاً
                            </h3>
                            <ul id="topCustomersList" class="custom-scrollbar space-y-2">
                                <li class="text-modern-text-dark text-center py-2">لا توجد بيانات</li>
                            </ul>
                        </div>
                        <div class="card-panel p-4 shadow-sm flex flex-col accent-primary">
                            <h3 class="card-panel-title section-title text-modern-primary-accent !text-xl !mb-4 !pb-2 !border-b !border-modern-border-light">
                                <i class="fas fa-file-invoice-dollar"></i> أصحاب الفواتير الأكثر نشاطاً
                            </h3>
                            <ul id="topInvoiceOwnersList" class="custom-scrollbar space-y-2">
                                <li class="text-modern-text-dark text-center py-2">لا توجد بيانات</li>
                            </ul>
                        </div>
                        <div class="card-panel p-4 shadow-sm flex flex-col accent-primary">
                            <h3 class="card-panel-title section-title text-modern-primary-accent !text-xl !mb-4 !pb-2 !border-b !border-modern-border-light">
                                <i class="fas fa-truck"></i> الموردون الأكثر نشاطاً
                            </h3>
                            <ul id="topSuppliersList" class="custom-scrollbar space-y-2">
                                <li class="text-modern-text-dark text-center py-2">لا توجد بيانات</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section id="purchase-orders-list" class="card-panel accent-primary" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-shopping-cart"></i> قائمة أوامر الشراء من Firebase
                    </h2>
                    <div id="firebasePurchaseOrdersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد أوامر شراء لعرضها.</p>
                    </div>
                    <div id="firebasePurchaseOrdersLoader"
                        class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden">
                    </div>
                </section>

                <section id="duplicate-products" class="card-panel accent-warning" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-copy" style="color: var(--modern-warning);"></i> المنتجات المتكررة في المخزون
                    </h2>
                    <div id="firebaseDuplicateProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات متكررة لعرضها.</p>
                    </div>
                    <div id="firebaseDuplicateProductsLoader"
                        class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden">
                    </div>
                </section>

                <section id="inventory-products" class="card-panel accent-primary" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-boxes"></i> قائمة منتجات المخزون من Firebase
                    </h2>
                    <div id="firebaseProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات لعرضها.</p>
                    </div>
                    <div id="firebaseProductsLoader"
                        class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden">
                    </div>
                </section>

                <section id="sold-products" class="card-panel accent-warning" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-receipt" style="color: var(--modern-warning);"></i> المنتجات المباعة في الفواتير
                    </h2>
                    <div id="firebaseInvoiceProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات مباعة في
                            الفواتير لعرضها.</p>
                    </div>
                    <div id="firebaseInvoiceProductsLoader"
                        class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden">
                    </div>
                </section>

                <section id="invoices-list" class="card-panel accent-primary" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-cloud"></i> قائمة فواتير Firebase
                    </h2>
                    <div id="firebaseInvoicesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد فواتير لعرضها.</p>
                    </div>
                    <div id="firebaseInvoicesLoader"
                        class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden">
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="invoiceDisplayModalOverlay" class="invoice-modal-overlay">
        <div id="invoiceDisplayModalContent" class="invoice-modal-content">
            <div class="invoice-modal-header">
                <h3>فاتورة المبيعات</h3>
                <button id="closeInvoiceModalBtn" class="modern-button btn-danger-action">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
            <div class="invoice-modal-info">
                <p><strong>العميل:</strong> <span id="modalCustomerName"></span></p>
                <p><strong>اسم الشركة:</strong> <span id="modalCompanyName"></span></p>
                <p><strong>تاريخ الفاتورة:</strong> <span id="modalInvoiceDate"></span></p>
                <p><strong>مالك الفاتورة:</strong> <span id="modalInvoiceOwner"></span></p>
                <p><strong>عنوان المالك:</strong> <span id="modalInvoiceOwnerAddress"></span></p>
                <p><strong>هاتف المالك:</strong> <span id="modalInvoiceOwnerPhone"></span></p>
            </div>
            <div class="invoice-modal-table-wrapper">
                <table class="invoice-modal-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>المنتج</th>
                            <th>سعر الوحدة</th>
                            <th>الكمية</th>
                            <th>المجموع (قبل الضريبة)</th>
                        </tr>
                    </thead>
                    <tbody id="modalInvoiceProductsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="invoice-modal-summary">
                <p><strong>المجموع قبل العمولة (قبل الضريبة):</strong> <span id="modalTotalAmountBeforeCommission"></span> DH</p>
                <p><strong>العمولة المخصومة:</strong> <span id="modalCommissionDeducted"></span> DH</p>
                <p><strong>المبلغ الإجمالي (قبل الضريبة):</strong> <span id="modalTotalAmount"></span> DH</p>
                <p><strong>الضريبة (TVA):</strong> <span id="modalTVA"></span> DH</p>
                <p class="total-row"><strong>المبلغ الإجمالي (شامل الضريبة):</strong> <span id="modalTotalTTC"></span> DH</p>
                <p><strong>الربح:</strong> <span id="modalTotalProfit"></span> DH</p>
            </div>
            <div class="invoice-modal-actions">
                <button id="printInvoiceModalBtn" class="modern-button btn-primary-action">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
            </div>
            <div id="invoiceModalLoader" class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden"></div>
        </div>
    </div>

    <!-- Modal for Purchase Order Details -->
    <div id="purchaseOrderDisplayModalOverlay" class="invoice-modal-overlay">
        <div id="purchaseOrderDisplayModalContent" class="invoice-modal-content">
            <div class="invoice-modal-header">
                <h3>تفاصيل أمر الشراء</h3>
                <button id="closePurchaseOrderModalBtn" class="modern-button btn-danger-action">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
            <div class="invoice-modal-info">
                <p><strong>المورد:</strong> <span id="modalPOSupplierName"></span></p>
                <p><strong>هاتف المورد:</strong> <span id="modalPOSupplierPhone"></span></p>
                <p><strong>تاريخ أمر الشراء:</strong> <span id="modalPODate"></span></p>
                <p><strong>مالك أمر الشراء:</strong> <span id="modalPOOwnerName"></span></p>
                <p><strong>هاتف المالك:</strong> <span id="modalPOOwnerPhone"></span></p>
                <p><strong>رقم أمر الشراء:</strong> <span id="modalPONumber"></span></p>
                <p><strong>تاريخ التسليم المتوقع:</strong> <span id="modalPODeliveryDate"></span></p>
                <p><strong>الحالة:</strong> <span id="modalPOStatus"></span></p>
            </div>
            <div class="invoice-modal-table-wrapper">
                <table class="invoice-modal-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>المنتج</th>
                            <th>سعر الشراء</th>
                            <th>الكمية</th>
                            <th>المجموع</th>
                        </tr>
                    </thead>
                    <tbody id="modalPOProductsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="invoice-modal-summary">
                <p class="total-row"><strong>إجمالي تكلفة الشراء:</strong> <span id="modalPOTotalCost"></span> DH</p>
            </div>
            <div class="invoice-modal-actions">
                <button id="printPurchaseOrderModalBtn" class="modern-button btn-primary-action">
                    <i class="fas fa-print"></i> طباعة أمر الشراء
                </button>
            </div>
            <div id="purchaseOrderModalLoader" class="loader w-8 h-8 border-4 border-modern-border-light border-t-modern-primary-accent rounded-full mx-auto mt-6 hidden"></div>
        </div>
    </div>

    <footer class="app-footer">
        <p>&copy; 2024 نظام إدارة الفواتير والمنتجات. جميع الحقوق محفوظة.</p>
    </footer>

    <script>
        // Tailwind CSS Configuration to extend colors with CSS variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'modern-bg-primary': 'var(--modern-bg-primary)',
                        'modern-bg-secondary': 'var(--modern-bg-secondary)', 
                        'modern-card-bg': 'var(--modern-card-bg)',
                        'modern-primary-accent': 'var(--modern-primary-accent)',
                        'modern-secondary-accent': 'var(--modern-secondary-accent)',
                        'modern-text-dark': 'var(--modern-text-dark)',
                        'modern-text-secondary': 'var(--modern-text-secondary)',
                        'modern-border-light': 'var(--modern-border-light)',
                        'modern-success': 'var(--modern-success)',
                        'modern-warning': 'var(--modern-warning)',
                        'modern-error': 'var(--modern-error)',
                        'modern-info': 'var(--modern-info)',
                        // Corrected RGB values to be literal strings instead of CSS variables
                        'modern-primary-accent-rgb': '79, 70, 229', 
                        'modern-success-rgb': '34, 197, 94',
                        'modern-error-rgb': '239, 68, 68',
                    },
                },
            },
        };

        // Firebase Configuration (must match your project)
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
            // Add other config properties if needed, e.g., projectId, apiKey, etc.
        };

        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            UI.showToast("فشل تهيئة Firebase. قد لا تعمل ميزات البيانات السحابية.", 'error');
        }

        // App ID (use __app_id if available in your environment, otherwise provide a default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global Data Stores for this section
        let allFirebaseInvoicesData = []; // Stores invoices after mapping to local keys
        let allFirebaseProductsData = []; // Stores products from inventoryProducts after mapping to local keys
        let allFirebaseInvoiceProductsWithDetails = []; // Stores products from invoices with customer/owner details
        let inventoryProductsMap = new Map(); // Use a Map to quickly access original product data from inventoryProducts
        let allFirebaseDuplicateProducts = []; // Stores detected duplicate products
        let allFirebasePurchaseOrdersData = []; // Stores purchase orders

        // Current view state for the file explorer
        let currentSelectedPhone = 'all'; // 'all' or a specific phone number
        let currentSelectedDataType = 'dashboard'; // 'dashboard', 'inventory', 'invoices', 'purchaseOrders', 'duplicates', 'soldProducts'

        // ====== Key Mapping for Firebase (Local Keys <-> French Keys) ======
        // IMPORTANT: These mappings MUST match the ones in your main sales application EXACTLY.
        const KEY_MAPPING_TO_FIREBASE = {
            // Product Keys (fields within the product object)
            id: 'id',
            name: 'nom',
            purchasePrice: 'prixAchat',
            sellingPrice: 'prixVente',
            minStockQuantity: 'quantiteMinimaleStock', // Added minStockQuantity
            supplierName: 'nomFournisseur',
            supplierAddress: 'adresseFournisseur',
            supplierPhone: 'telephoneFournisseur',
            stockQuantity: 'quantiteStock',
            date: 'dateCreationProduit', // This should match what's saved in main app
            // 'quantity' and 'isLocal' are local-only in the sales app, so they are not mapped for Firebase storage.
            // quantity: 'quantiteSelectionnee', 
            // isLocal: 'estLocal', 

            // Invoice Keys (fields within the invoice object)
            // id: 'id', // This is for the invoice ID itself. (handled manually as firebase key)
            date: 'dateFacture', // Formatted date string for display (matches original app)
            isoDate: 'dateIsoFacture', // ISO string for sorting
            customerName: 'nomClient',
            companyName: 'nomSociete', // Added for company name
            ownerName: 'nomProprietaire',
            ownerAddress: 'adresseProprietaire',
            ownerPhone: 'telephoneProprietaire', // Used in path and as data
            products: 'produits', // This is the key for the array of products *within an invoice*
            totalHT: 'totalHT',
            totalHTBeforeCommission: 'totalHTAvantCommission',
            tva: 'tva',
            totalTTC: 'totalTTC',
            totalProfit: 'profitTotal',
            totalCommission: 'commissionTotale',
            invoiceCommissionRate: 'tauxCommissionFacture',
            // Product within Invoice Keys (fields within product objects inside the invoice's products array)
            quantityUsed: 'quantiteUtilisee', // Quantity used in a specific invoice item
            // NEW: Purchase Order Keys (based on provided JSON structure)
            // The actual collection name in the provided JSON is 'purchaseOrders'
            // The fields within each purchase order object are mapped here:
            totalCost: 'montantTotalBonCommande', // Actual key from provided JSON
            poDate: 'dateCreationProduit', // Using this as the main date for PO display
            poIsoDate: 'dateIsoFacture', // Using this as the ISO date for PO sorting (even if named 'dateIsoFacture' in POs)
            poOwnerName: 'nomProprietaireBonCommande', // Actual key from provided JSON
            poOwnerPhone: 'telephoneProprietaireBonCommande', // Actual key from provided JSON
            poSupplierName: 'nomFournisseurBonCommande', // Actual key from provided JSON
            poSupplierAddress: 'adresseFournisseurBonCommande', // Actual key from provided JSON
            poSupplierPhone: 'telephoneFournisseurBonCommande', // Actual key from provided JSON
            poDeliveryDate: 'dateLivraisonEstimee', // Actual key from provided JSON
            poStatus: 'statut', // Actual key from provided JSON
            poNumber: 'numeroBonCommande', // Actual key from provided JSON
            poProducts: 'produitsCommandes', // Actual key for the array of products within a purchase order
            quantityPurchased: 'quantiteCommandee' // Actual key for quantity within a PO product
        };

        // Create reverse mapping for converting from Firebase French keys back to local keys
        const KEY_MAPPING_FROM_FIREBASE = {};
        for (const localKey in KEY_MAPPING_TO_FIREBASE) {
            KEY_MAPPING_FROM_FIREBASE[KEY_MAPPING_TO_FIREBASE[localKey]] = localKey;
        }

        /**
         * Maps an object's keys from French Firebase names back to local JavaScript names.
         * Keys not found in KEY_MAPPING_FROM_FIREBASE are passed through as is.
         * Handles nested 'produits' array within an invoice object and 'produitsCommandes' array within purchase order recursively.
         * @param {object} fbObj - The object with French Firebase keys to map.
         * @returns {object} A new object with keys mapped back to local JavaScript names.
         */
        function mapFromFirebaseKeys(fbObj) {
            if (fbObj === null || typeof fbObj !== 'object') {
                return fbObj;
            }
            const newObj = {};
            for (const fbKey in fbObj) {
                if (fbObj.hasOwnProperty(fbKey)) {
                    const localKey = KEY_MAPPING_FROM_FIREBASE[fbKey];
                    // Handle nested products array for both invoices ('produits') and purchase orders ('produitsCommandes')
                    if (fbKey === 'produits' && Array.isArray(fbObj[fbKey])) {
                        newObj[localKey || fbKey] = fbObj[fbKey].map(p => {
                            const productMapped = {};
                            for (const productFbKey in p) {
                                if (p.hasOwnProperty(productFbKey)) {
                                    productMapped[KEY_MAPPING_FROM_FIREBASE[productFbKey] || productFbKey] = p[productFbKey];
                                }
                            }
                            return productMapped;
                        });
                    } else if (fbKey === 'produitsCommandes' && Array.isArray(fbObj[fbKey])) { // Specific for purchase order products
                         newObj[localKey || fbKey] = fbObj[fbKey].map(p => {
                            const productMapped = {};
                            for (const productFbKey in p) {
                                if (p.hasOwnProperty(productFbKey)) {
                                    productMapped[KEY_MAPPING_FROM_FIREBASE[productFbKey] || productFbKey] = p[productFbKey];
                                }
                            }
                            return productMapped;
                        });
                    }
                    else {
                        newObj[localKey || fbKey] = fbObj[fbKey];
                    }
                }
            }
            return newObj;
        }

        /**
         * Maps an object's keys from local JavaScript names to French Firebase names.
         * Keys not found in KEY_MAPPING_TO_FIREBASE are passed through as is.
         * Handles nested 'products' array within an invoice object and purchase order recursively.
         * @param {object} localObj - The object with local JavaScript keys to map.
         * @returns {object} A new object with keys mapped to French Firebase names.
         */
        function mapToFirebaseKeys(localObj) {
            if (localObj === null || typeof localObj !== 'object') {
                return localObj;
            }
            const newObj = {};
            for (const localKey in localObj) {
                if (localObj.hasOwnProperty(localKey)) {
                    const fbKey = KEY_MAPPING_TO_FIREBASE[localKey];
                    // Handle nested products array for both invoices and purchase orders
                    if (localKey === 'products' && Array.isArray(localObj[localKey])) { // 'products' is the local key for invoice products
                        newObj[fbKey || localKey] = localObj[localKey].map(p => {
                            const productMapped = {};
                            for (const productLocalKey in p) {
                                if (p.hasOwnProperty(productLocalKey)) {
                                    productMapped[KEY_MAPPING_TO_FIREBASE[productLocalKey] || productLocalKey] = p[productLocalKey];
                                }
                            }
                            return productMapped;
                        });
                    } else if (localKey === 'poProducts' && Array.isArray(localObj[localKey])) { // 'poProducts' is the local key for PO products
                         newObj[fbKey || localKey] = localObj[localKey].map(p => {
                            const productMapped = {};
                            for (const productLocalKey in p) {
                                if (p.hasOwnProperty(productLocalKey)) {
                                    productMapped[KEY_MAPPING_TO_FIREBASE[productLocalKey] || productLocalKey] = p[productLocalKey];
                                }
                            }
                            return productMapped;
                        });
                    }
                    else {
                        newObj[fbKey || localKey] = localObj[localKey];
                    }
                }
            }
            return newObj;
        }

        /**
         * Sanitizes a phone number to be used as a Firebase key.
         * Replaces invalid characters with underscores.
         * Must match the sanitization in the sales application.
         * @param {string} phoneNumber - The phone number to sanitize.
         * @returns {string} The sanitized phone number.
         */
        function sanitizePhoneNumber(phoneNumber) {
            return String(phoneNumber).replace(/[.#$[\]]/g, '_');
        }

        let UIElements; // Declared here, assigned in window.onload

        // ====== UI Utility Functions (minimal set for this section) ======
        const UI = {
            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast-message', type); 
                let iconHtml = '';
                if (type === 'success') { iconHtml = '<i class="fas fa-check"></i>'; }
                else if (type === 'error') { iconHtml = '<i class="fas fa-times"></i>'; }
                else if (type === 'info') { iconHtml = '<i class="fas fa-info-circle"></i>'; }
                else if (type === 'warning') { iconHtml = '<i class="fas fa-exclamation-triangle"></i>'; }
                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                
                toast.hidden = false; 
                requestAnimationFrame(() => {
                    toast.classList.add('active'); 
                });
                setTimeout(() => {
                    toast.classList.remove('active'); 
                    toast.addEventListener('transitionend', function handler() {
                        toast.removeEventListener('transitionend', handler);
                        toast.remove(); 
                    }, { once: true });
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 600); 
                }, 3000); 
            },

            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('hidden', !isLoading);
                }
            },

            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            },

            populatePhoneSelect: (selectElement, phoneNumbers) => {
                selectElement.innerHTML = '<option value="all">عرض الكل</option>';
                Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    selectElement.appendChild(option);
                });
            },

            showConfirmModal: (title, message) => { 
                return new Promise(resolve => {
                    const modalOverlay = document.createElement('div');
                    modalOverlay.classList.add('modal-overlay'); 
                    const modalDialog = document.createElement('div');
                    modalDialog.classList.add('modal-content'); 
                    modalDialog.innerHTML = `
                        <h3 class="modal-title">${title}</h3>
                        <p class="modal-message">${message}</p>
                        <div class="modal-actions">
                            <button id="confirmYesBtn" class="modern-button btn-success-action">نعم</button>
                            <button id="confirmNoBtn" class="modern-button btn-danger-action">لا</button>
                        </div>
                    `;
                    modalOverlay.appendChild(modalDialog);
                    document.body.appendChild(modalOverlay);
                    
                    requestAnimationFrame(() => {
                        modalOverlay.classList.add('active'); 
                    });
                    const cleanup = () => {
                        modalOverlay.classList.remove('active');
                        modalOverlay.addEventListener('transitionend', () => modalOverlay.remove(), { once: true });
                    };
                    document.getElementById('confirmYesBtn').addEventListener('click', () => {
                        cleanup();
                        resolve(true);
                    }, { once: true });
                    document.getElementById('confirmNoBtn').addEventListener('click', () => {
                        cleanup();
                        resolve(false);
                    }, { once: true });
                });
            },

            showInvoiceModal: (invoice) => {
                document.getElementById('modalCustomerName').textContent = invoice.customerName || 'N/A';
                document.getElementById('modalCompanyName').textContent = invoice.companyName || 'N/A';
                document.getElementById('modalInvoiceOwner').textContent = invoice.ownerName || 'N/A';
                document.getElementById('modalInvoiceOwnerAddress').textContent = invoice.ownerAddress || 'N/A';
                document.getElementById('modalInvoiceOwnerPhone').textContent = invoice.ownerPhone || 'N/A';
                
                let formattedInvoiceDate = 'N/A';
                if (invoice.isoDate) {
                    try {
                        const dateObj = new Date(invoice.isoDate);
                        const options = {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            timeZone: 'Africa/Casablanca' // Morocco timezone
                        };
                        formattedInvoiceDate = dateObj.toLocaleDateString('ar-MA', options);
                    } catch (e) {
                        console.warn("Invalid ISO date format for modal invoice:", invoice.isoDate, e);
                        formattedInvoiceDate = invoice.date || 'N/A'; // Fallback to original date string
                    }
                } else if (invoice.date) {
                    formattedInvoiceDate = invoice.date;
                }
                document.getElementById('modalInvoiceDate').textContent = formattedInvoiceDate;

                const productsTableBody = document.getElementById('modalInvoiceProductsTableBody');
                productsTableBody.innerHTML = '';
                if (invoice.products && invoice.products.length > 0) {
                    let productNumber = 1;
                    invoice.products.forEach(product => {
                        const row = document.createElement('tr');
                        const productTotalHT = (parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2);
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</td>
                            <td>${product.quantityUsed || 0}</td>
                            <td>${productTotalHT} DH</td>
                        `;
                        productsTableBody.appendChild(row);
                    });
                } else {
                    productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center italic text-modern-text-secondary">لا توجد منتجات في هذه الفاتورة.</td></tr>`;
                }

                document.getElementById('modalTotalAmountBeforeCommission').textContent = parseFloat(invoice.totalHTBeforeCommission || 0).toFixed(2);
                document.getElementById('modalCommissionDeducted').textContent = parseFloat(invoice.totalCommission || 0).toFixed(2);
                document.getElementById('modalTotalAmount').textContent = parseFloat(invoice.totalHT || 0).toFixed(2);
                document.getElementById('modalTVA').textContent = parseFloat(invoice.tva || 0).toFixed(2);
                document.getElementById('modalTotalTTC').textContent = parseFloat(invoice.totalTTC || 0).toFixed(2);
                document.getElementById('modalTotalProfit').textContent = parseFloat(invoice.totalProfit || 0).toFixed(2);
                document.getElementById('invoiceDisplayModalOverlay').classList.add('active');
                document.getElementById('invoiceDisplayModalOverlay').style.visibility = 'visible';
                document.getElementById('invoiceDisplayModalContent').style.transform = 'translateY(0)';
            },

            hideInvoiceModal: () => {
                document.getElementById('invoiceDisplayModalOverlay').classList.remove('active');
                document.getElementById('invoiceDisplayModalContent').style.transform = 'translateY(-30px)'; // Changed to -30px to unify animation
                document.getElementById('invoiceDisplayModalOverlay').addEventListener('transitionend', function handler() {
                    document.getElementById('invoiceDisplayModalOverlay').removeEventListener('transitionend', handler);
                    document.getElementById('invoiceDisplayModalOverlay').style.visibility = 'hidden';
                }, { once: true });
            },

            // NEW: showPurchaseOrderModal
            showPurchaseOrderModal: (po) => {
                document.getElementById('modalPOSupplierName').textContent = po.poSupplierName || 'N/A';
                document.getElementById('modalPOSupplierPhone').textContent = po.poSupplierPhone || 'N/A';
                document.getElementById('modalPODate').textContent = po.poDate || 'N/A'; // Displaying dateCreationProduit as poDate
                document.getElementById('modalPOOwnerName').textContent = po.poOwnerName || 'N/A';
                document.getElementById('modalPOOwnerPhone').textContent = po.poOwnerPhone || 'N/A';
                document.getElementById('modalPONumber').textContent = po.poNumber || 'N/A';
                document.getElementById('modalPODeliveryDate').textContent = po.poDeliveryDate || 'N/A';
                document.getElementById('modalPOStatus').textContent = po.poStatus || 'N/A';

                let formattedPODate = 'N/A';
                if (po.poIsoDate) {
                    try {
                        const dateObj = new Date(po.poIsoDate);
                        const options = {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            timeZone: 'Africa/Casablanca'
                        };
                        formattedPODate = dateObj.toLocaleDateString('ar-MA', options);
                    } catch (e) {
                        console.warn("Invalid ISO date format for modal purchase order:", po.poIsoDate, e);
                        formattedPODate = po.poDate || 'N/A'; // Fallback to original date string
                    }
                } else if (po.poDate) {
                    formattedPODate = po.poDate;
                }
                document.getElementById('modalPODate').textContent = formattedPODate;

                const productsTableBody = document.getElementById('modalPOProductsTableBody');
                productsTableBody.innerHTML = '';
                if (po.poProducts && po.poProducts.length > 0) { // Using poProducts as the local key for nested products
                    let productNumber = 1;
                    po.poProducts.forEach(product => {
                        const row = document.createElement('tr');
                        const productTotal = (parseFloat(product.prixAchat || 0) * (product.quantiteCommandee || 0)).toFixed(2);
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.nom || 'N/A'}</td>
                            <td>${parseFloat(product.prixAchat || 0).toFixed(2)} DH</td>
                            <td>${product.quantiteCommandee || 0}</td>
                            <td>${productTotal} DH</td>
                        `;
                        productsTableBody.appendChild(row);
                    });
                } else {
                    productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center italic text-modern-text-secondary">لا توجد منتجات في أمر الشراء هذا.</td></tr>`;
                }
                document.getElementById('modalPOTotalCost').textContent = parseFloat(po.totalCost || 0).toFixed(2);
                document.getElementById('purchaseOrderDisplayModalOverlay').classList.add('active');
                document.getElementById('purchaseOrderDisplayModalOverlay').style.visibility = 'visible';
                document.getElementById('purchaseOrderDisplayModalContent').style.transform = 'translateY(0)';
            },

            // NEW: hidePurchaseOrderModal
            hidePurchaseOrderModal: () => {
                document.getElementById('purchaseOrderDisplayModalOverlay').classList.remove('active');
                document.getElementById('purchaseOrderDisplayModalContent').style.transform = 'translateY(-30px)';
                document.getElementById('purchaseOrderDisplayModalOverlay').addEventListener('transitionend', function handler() {
                    document.getElementById('purchaseOrderDisplayModalOverlay').removeEventListener('transitionend', handler);
                    document.getElementById('purchaseOrderDisplayModalOverlay').style.visibility = 'hidden';
                }, { once: true });
            },

            toggleSidebar: (open) => {
                const sidebar = UIElements.sidebar;
                const overlay = UIElements.sidebarOverlay;
                if (sidebar) sidebar.classList.toggle('open', open);
                if (overlay) overlay.classList.toggle('active', open);
            }
        };

        // ====== Firebase Data & Statistics Logic (extracted) ======
        const FirebaseData = {
            init: () => {
                // Event listeners for search and filter controls
                if (UIElements.commonSearchInput) UIElements.commonSearchInput.addEventListener('input', FirebaseData.applyCombinedFilters);
                if (UIElements.clearCommonSearchInputButton) UIElements.clearCommonSearchInputButton.addEventListener('click', FirebaseData.clearAndFilter);
                // Listen for changes on the phone dropdown to filter data
                if (UIElements.commonPhoneDropdown) UIElements.commonPhoneDropdown.addEventListener('change', (event) => {
                    currentSelectedPhone = event.target.value; // Update global state for selected phone
                    FirebaseData.applyCombinedFilters(); // Apply filters based on new phone selection
                });
                
                // Event listeners for phone-specific actions
                if (UIElements.exportPhoneDataBtn) UIElements.exportPhoneDataBtn.addEventListener('click', FirebaseData.exportSelectedPhoneData);
                if (UIElements.deletePhoneDataBtn) UIElements.deletePhoneDataBtn.addEventListener('click', FirebaseData.deleteSelectedPhoneData);

                // Event listeners for product cards (delete)
                if (UIElements.firebaseProductsContainer) UIElements.firebaseProductsContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.delete-product-button');
                    if (target) {
                        const productDiv = target.closest('[data-product-id]');
                        const productId = productDiv.dataset.productId;
                        const firebasePhoneKey = productDiv.dataset.firebasePhoneKey;
                        FirebaseData.confirmAndDeleteProduct(productId, firebasePhoneKey);
                    }
                });

                // Event listeners for invoice cards (delete and view details)
                if (UIElements.firebaseInvoicesContainer) UIElements.firebaseInvoicesContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.delete-invoice-button');
                    if (target) {
                        const invoiceDiv = target.closest('[data-invoice-id]');
                        const invoiceFirebaseId = invoiceDiv.dataset.invoiceId; 
                        const firebasePhoneKey = invoiceDiv.dataset.firebasePhoneKey;
                        FirebaseData.confirmAndDeleteInvoice(invoiceFirebaseId, firebasePhoneKey);
                    } else { 
                        const invoiceCard = event.target.closest('.invoice-item-clickable'); 
                        if (invoiceCard) {
                            const invoiceFirebaseId = invoiceCard.dataset.invoiceId;
                            const selectedInvoice = allFirebaseInvoicesData.find(inv => inv.firebaseId === invoiceFirebaseId);
                            if (selectedInvoice) {
                                UI.showInvoiceModal(selectedInvoice);
                            }
                        }
                    }
                });
                if (document.getElementById('closeInvoiceModalBtn')) document.getElementById('closeInvoiceModalBtn').addEventListener('click', UI.hideInvoiceModal);
                if (document.getElementById('printInvoiceModalBtn')) document.getElementById('printInvoiceModalBtn').addEventListener('click', () => {
                    window.print();
                });

                // Event listeners for Purchase Order section (delete and view details)
                if (UIElements.firebasePurchaseOrdersContainer) UIElements.firebasePurchaseOrdersContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.delete-po-button');
                    if (target) {
                        const poDiv = target.closest('[data-po-id]');
                        const poFirebaseId = poDiv.dataset.poId;
                        const firebasePhoneKey = poDiv.dataset.firebasePhoneKey;
                        FirebaseData.confirmAndDeletePurchaseOrder(poFirebaseId, firebasePhoneKey);
                    } else {
                        const poCard = event.target.closest('.po-item-clickable');
                        if (poCard) {
                            const poFirebaseId = poCard.dataset.poId;
                            const selectedPO = allFirebasePurchaseOrdersData.find(po => po.firebaseId === poFirebaseId);
                            if (selectedPO) {
                                UI.showPurchaseOrderModal(selectedPO);
                            }
                        }
                    }
                });
                if (document.getElementById('closePurchaseOrderModalBtn')) document.getElementById('closePurchaseOrderModalBtn').addEventListener('click', UI.hidePurchaseOrderModal);
                if (document.getElementById('printPurchaseOrderModalBtn')) document.getElementById('printPurchaseOrderModalBtn').addEventListener('click', () => {
                    window.print();
                });

                // Burger menu event listener for mobile sidebar
                if (UIElements.burgerMenu) UIElements.burgerMenu.addEventListener('click', () => UI.toggleSidebar(true));
                if (UIElements.sidebarOverlay) UIElements.sidebarOverlay.addEventListener('click', () => UI.toggleSidebar(false));

                // Event listeners for tree view items
                if (UIElements.mainTreeRoot) {
                    UIElements.mainTreeRoot.addEventListener('click', (event) => {
                        const target = event.target.closest('li');
                        if (target) {
                            const dataType = target.dataset.type;
                            const phone = target.dataset.phone;
                            if (dataType === 'all' && phone === 'all' && target.classList.contains('folder')) {
                                // Click on "All Firebase Data" folder, toggle open/close
                                const nestedUl = target.querySelector('ul.nested');
                                if (nestedUl) {
                                    nestedUl.classList.toggle('active');
                                    target.classList.toggle('open');
                                }
                                // Select its dashboard view
                                FirebaseData.selectTreeItem('all', 'dashboard');
                            } else if (target.classList.contains('folder')) {
                                // Click on a phone folder, toggle open/close
                                const nestedUl = target.querySelector('ul.nested');
                                if (nestedUl) {
                                    nestedUl.classList.toggle('active');
                                    target.classList.toggle('open');
                                }
                                // Select its dashboard view
                                FirebaseData.selectTreeItem(phone, 'dashboard');
                            } else if (target.classList.contains('file-item')) {
                                // Click on a file item (specific data type)
                                FirebaseData.selectTreeItem(phone, dataType);
                                // Close sidebar on mobile after selection
                                UI.toggleSidebar(false);
                            }
                            event.stopPropagation(); // Prevent parent elements from also being clicked
                        }
                    });
                }
            },

            populatePhoneDropdowns: (phoneNumbers) => {
                if (UIElements.commonPhoneDropdown) UI.populatePhoneSelect(UIElements.commonPhoneDropdown, phoneNumbers);
            },

            fetchAndDisplayCombinedFirebaseData: async () => {
                // Show all loaders initially
                UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, true); 
                UI.toggleGeneralLoader(UIElements.firebasePurchaseOrdersLoader, true);

                if (!database) {
                    UI.showToast("قاعدة بيانات Firebase غير جاهزة لجلب البيانات.", 'info');
                    // Hide all loaders if Firebase is not ready
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, false); 
                    UI.toggleGeneralLoader(UIElements.firebasePurchaseOrdersLoader, false);
                    return;
                }
                
                if (!navigator.onLine) {
                    UI.showToast("لا يوجد اتصال بالإنترنت. لا يمكن جلب البيانات من Firebase.", "warning");
                    // Hide all loaders if no internet connection
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, false); 
                    UI.toggleGeneralLoader(UIElements.firebasePurchaseOrdersLoader, false);
                    return;
                }

                const alldataRef = database.ref(`${appId}/alldata`);
                try {
                    const snapshot = await alldataRef.once('value');
                    const data = snapshot.val();

                    // Clear previous data
                    allFirebaseInvoicesData = [];
                    inventoryProductsMap.clear(); 
                    allFirebaseProductsData = []; 
                    allFirebaseInvoiceProductsWithDetails = [];
                    allFirebaseDuplicateProducts = []; 
                    allFirebasePurchaseOrdersData = []; 
                    const uniquePhoneNumbers = new Set();
                    const productTracker = new Map(); 
                    
                    if (!data || Object.keys(data).length === 0) { 
                        UI.showToast("لا توجد بيانات في Firebase لعرضها.", 'info');
                        // Reset all counts in navigation buttons (if they existed, now they don't in this version's HTML)
                        // If they were still there, they'd be handled by the next applyCombinedFilters call anyway.

                        // Display empty lists
                        FirebaseData.displayFirebaseInvoices([]);
                        FirebaseData.displayFirebaseProducts([]);
                        FirebaseData.displayFirebaseInvoiceProducts([]);
                        FirebaseData.displayFirebaseDuplicateProducts([]);
                        FirebaseData.displayFirebasePurchaseOrders([]);
                        FirebaseData.displayStatistics([]); // Update stats with empty data
                        FirebaseData.populatePhoneDropdowns(new Set()); // Update phone dropdown with empty set
                        UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, [], 'name'); 
                        // Render tree view with no phones
                        FirebaseData.renderTreeView(new Set());
                        return; 
                    }

                    for (const phoneKey in data) {
                        if (data.hasOwnProperty(phoneKey)) {
                            uniquePhoneNumbers.add(phoneKey); 
                            const phoneData = data[phoneKey];

                            // Process Inventory Products
                            if (phoneData.inventoryProducts) {
                                for (const productId in phoneData.inventoryProducts) {
                                    if (phoneData.inventoryProducts.hasOwnProperty(productId)) {
                                        const productDetails = mapFromFirebaseKeys(phoneData.inventoryProducts[productId]);
                                        const fullProduct = {
                                            id: productId, 
                                            firebasePhoneKey: phoneKey, 
                                            ...productDetails
                                        };
                                        inventoryProductsMap.set(productId, fullProduct);
                                        allFirebaseProductsData.push(fullProduct); 
                                        
                                        const productIdentifier = `${(productDetails.name || '').toLowerCase()}_${(productDetails.supplierName || '').toLowerCase()}_${phoneKey}`;
                                        productTracker.set(productIdentifier, (productTracker.get(productIdentifier) || 0) + 1);
                                    }
                                }
                            }

                            // Process Invoices
                            if (phoneData.invoices) {
                                for (const invoiceFirebaseKey in phoneData.invoices) {
                                    if (phoneData.invoices.hasOwnProperty(invoiceFirebaseKey)) {
                                        const invoiceDetails = mapFromFirebaseKeys(phoneData.invoices[invoiceFirebaseKey]);
                                        invoiceDetails.id = invoiceDetails.id || invoiceFirebaseKey; 
                                        allFirebaseInvoicesData.push({
                                            firebaseId: invoiceFirebaseKey, 
                                            firebasePhoneKey: phoneKey, 
                                            ...invoiceDetails
                                        });
                                        // Extract products from invoices with full details
                                        if (invoiceDetails.products && Array.isArray(invoiceDetails.products)) {
                                            invoiceDetails.products.forEach((product) => {
                                                allFirebaseInvoiceProductsWithDetails.push({
                                                    id: product.id,
                                                    name: product.name,
                                                    sellingPrice: product.sellingPrice,
                                                    quantityUsed: product.quantityUsed,
                                                    invoiceId: invoiceDetails.id, 
                                                    invoiceDate: invoiceDetails.isoDate || invoiceDetails.date, 
                                                    customerName: invoiceDetails.customerName,
                                                    companyName: invoiceDetails.companyName, 
                                                    ownerName: invoiceDetails.ownerName,
                                                    ownerPhone: invoiceDetails.ownerPhone, 
                                                    firebasePhoneKey: phoneKey 
                                                });
                                            });
                                        }
                                    }
                                }
                            }

                            // Process Purchase Orders
                            if (phoneData.purchaseOrders) {
                                for (const poFirebaseKey in phoneData.purchaseOrders) {
                                    if (phoneData.purchaseOrders.hasOwnProperty(poFirebaseKey)) {
                                        const poDetails = mapFromFirebaseKeys(phoneData.purchaseOrders[poFirebaseKey]);
                                        poDetails.firebaseId = poFirebaseKey; // Ensure firebaseId is set for POs
                                        poDetails.firebasePhoneKey = phoneKey; // Ensure firebasePhoneKey is set for POs
                                        allFirebasePurchaseOrdersData.push(poDetails);
                                        // For debugging: log the mapped purchase order details
                                        // console.log("Mapped Purchase Order Details:", poDetails);
                                    }
                                }
                            }
                        }
                    }

                    // Identify duplicate products based on tracking
                    productTracker.forEach((count, identifier) => {
                        if (count > 1) {
                            const duplicateProducts = allFirebaseProductsData.filter(product => {
                                const productIdentifier = `${(product.name || '').toLowerCase()}_${(product.supplierName || '').toLowerCase()}_${product.firebasePhoneKey}`;
                                return productIdentifier === identifier;
                            });
                            // Only add each unique duplicate product once
                            duplicateProducts.forEach(dupProduct => {
                                if (!allFirebaseDuplicateProducts.some(p => p.id === dupProduct.id && p.firebasePhoneKey === dupProduct.firebasePhoneKey)) {
                                    allFirebaseDuplicateProducts.push(dupProduct);
                                }
                            });
                        }
                    });
                    
                    // Populate dropdown and datalists
                    FirebaseData.populatePhoneDropdowns(uniquePhoneNumbers);
                    // Populate datalists with relevant fields for search suggestions
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProductsData, 'name');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProductsData, 'supplierName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'customerName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'ownerName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebasePurchaseOrdersData, 'poSupplierName'); // Add PO supplier names
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebasePurchaseOrdersData, 'poOwnerName'); // Add PO owner names
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebasePurchaseOrdersData, 'poNumber'); // Add PO numbers

                    // Add sanitized phone numbers to the datalist for search suggestions
                    Array.from(uniquePhoneNumbers).sort().forEach(phone => {
                        const option = document.createElement('option');
                        option.value = phone;
                        UIElements.allSearchOptionsDatalist.appendChild(option);
                    });

                    // Render the tree view after data is fetched
                    FirebaseData.renderTreeView(Array.from(uniquePhoneNumbers).sort());

                    // Apply filters to display fetched data based on initial view state
                    FirebaseData.selectTreeItem('all', 'dashboard'); // Initial selection
                    UI.showToast("تم جلب جميع البيانات من Firebase بنجاح.", 'success');
                } catch (error) {
                    UI.showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                    console.error("Failed to fetch Firebase data:", error);
                } finally {
                    // Hide all loaders after fetch attempt
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, false); 
                    UI.toggleGeneralLoader(UIElements.firebasePurchaseOrdersLoader, false);
                }
            },

            exportSelectedPhoneData: async () => {
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;
                if (selectedPhoneNumber === 'all' || !selectedPhoneNumber) {
                    UI.showToast("يرجى اختيار رقم هاتف محدد لتصدير بياناته.", 'warning');
                    return;
                }
                const confirmed = await UI.showConfirmModal("تأكيد التصدير", `هل أنت متأكد من أنك تريد تصدير جميع بيانات (المنتجات والفواتير وأوامر الشراء) المرتبطة بالهاتف ${selectedPhoneNumber}؟`); // Updated message
                if (!confirmed) {
                    UI.showToast("تم إلغاء عملية التصدير.", 'info');
                    return;
                }
                UI.showToast(`جاري تصدير بيانات الهاتف ${selectedPhoneNumber}...`, 'info');
                try {
                    const phoneDataRef = database.ref(`${appId}/alldata/${selectedPhoneNumber}`);
                    const snapshot = await phoneDataRef.once('value');
                    const dataToExport = snapshot.val();

                    if (!dataToExport) {
                        UI.showToast(`لا توجد بيانات لهذا الهاتف ${selectedPhoneNumber} في Firebase لتصديرها.`, 'warning'); 
                        return;
                    }
                    // Map Firebase French keys to local keys for export compatibility with the first app
                    const mappedDataForExport = {};
                    if (dataToExport.inventoryProducts) {
                        mappedDataForExport.products = Object.values(dataToExport.inventoryProducts).map(mapFromFirebaseKeys);
                    } else {
                        mappedDataForExport.products = [];
                    }
                    if (dataToExport.invoices) {
                        mappedDataForExport.invoices = Object.values(dataToExport.invoices).map(mapFromFirebaseKeys);
                    } else {
                        mappedDataForExport.invoices = [];
                    }
                    // NEW: Export purchase orders
                    if (dataToExport.purchaseOrders) {
                        mappedDataForExport.purchaseOrders = Object.values(dataToExport.purchaseOrders).map(mapFromFirebaseKeys);
                    } else {
                        mappedDataForExport.purchaseOrders = [];
                    }

                    const exportDate = new Date().toISOString();
                    const finalExportObject = {
                        metadata: {
                            exportedAt: exportDate,
                            appId: appId,
                            ownerPhone: selectedPhoneNumber,
                            // Attempt to get ownerName/Address/TVA/Commission from the first invoice if available
                            ownerName: mappedDataForExport.invoices.length > 0 ? mappedDataForExport.invoices[0].ownerName : '',
                            ownerAddress: mappedDataForExport.invoices.length > 0 ? mappedDataForExport.invoices[0].ownerAddress : '',
                            tva: mappedDataForExport.invoices.length > 0 ? mappedDataForExport.invoices[0].tva : '0',
                            invoiceCommissionAmount: mappedDataForExport.invoices.length > 0 ? mappedDataForExport.invoices[0].totalCommission : '0',
                            companyName: mappedDataForExport.invoices.length > 0 ? mappedDataForExport.invoices[0].companyName : '', // Export company name
                            description: `بيانات إدارة المبيعات والمخزون - نسخة احتياطية لرقم الهاتف ${selectedPhoneNumber}`
                        },
                        ...mappedDataForExport
                    };

                    const dataStr = JSON.stringify(finalExportObject, null, 4);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_backup_${selectedPhoneNumber}_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    UI.showToast(`تم تصدير بيانات الهاتف ${selectedPhoneNumber} بنجاح إلى ملف JSON.`, 'success');
                } catch (error) {
                    UI.showToast(`فشل تصدير بيانات الهاتف ${selectedPhoneNumber}: ${error.message}`, 'error');
                    console.error("Error exporting phone data:", error);
                }
            },

            deleteSelectedPhoneData: async () => {
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;
                if (selectedPhoneNumber === 'all' || !selectedPhoneNumber) {
                    UI.showToast("يرجى اختيار رقم هاتف محدد لحذف بياناته.", 'warning');
                    return;
                }
                const confirmed = await UI.showConfirmModal("تأكيد الحذف الكلي", `هل أنت متأكد أنك تريد حذف جميع بيانات (المنتجات والفواتير وأوامر الشراء) المرتبطة بالهاتف ${selectedPhoneNumber} من Firebase؟\nهذا الإجراء لا يمكن التراجع عنه!`); // Updated message
                if (!confirmed) {
                    UI.showToast("تم إلغاء عملية الحذف.", 'info');
                    return;
                }
                UI.showToast(`جاري حذف جميع بيانات الهاتف ${selectedPhoneNumber}...`, 'info');
                try {
                    const phoneDataRef = database.ref(`${appId}/alldata/${selectedPhoneNumber}`);
                    await phoneDataRef.remove();
                    UI.showToast(`تم حذف جميع بيانات الهاتف ${selectedPhoneNumber} بنجاح!`, 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch and display data to reflect changes
                } catch (error) {
                    UI.showToast(`فشل حذف جميع بيانات الهاتف ${selectedPhoneNumber}: ${error.message}`, 'error');
                    console.error("Error deleting phone data:", error);
                }
            },

            confirmAndDeleteProduct: async (productId, firebasePhoneKey) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", `هل أنت متأكد أنك تريد حذف هذا المنتج (ID: ${productId}) من رقم الهاتف ${firebasePhoneKey}؟\nهذا الإجراء لا يمكن التراجع عنه!`);
                if (!confirmed) {
                    UI.showToast("تم إلغاء حذف المنتج.", 'info'); 
                    return;
                }
                UI.showToast("جاري حذف المنتج...", 'info');
                try {
                    const productRef = database.ref(`${appId}/alldata/${firebasePhoneKey}/inventoryProducts/${productId}`);
                    await productRef.remove();
                    UI.showToast("تم حذف المنتج بنجاح!", 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`فشل حذف المنتج: ${error.message}`, 'error');
                    console.error("Error deleting product:", error);
                }
            },

            confirmAndDeleteInvoice: async (invoiceFirebaseId, firebasePhoneKey) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", `هل أنت متأكد أنك تريد حذف هذه الفاتورة (ID: ${invoiceFirebaseId}) من رقم الهاتف ${firebasePhoneKey}؟\nهذا الإجراء لا يمكن التراجع عنه!`);
                if (!confirmed) {
                    UI.showToast("تم إلغاء حذف الفاتورة.", 'info'); 
                    return;
                }
                UI.showToast("جاري حذف الفاتورة...", 'info');
                try {
                    const invoiceRef = database.ref(`${appId}/alldata/${firebasePhoneKey}/invoices/${invoiceFirebaseId}`);
                    await invoiceRef.remove();
                    UI.showToast("تم حذف الفاتورة بنجاح!", 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`فشل حذف الفاتورة: ${error.message}`, 'error');
                    console.error("Error deleting invoice:", error);
                }
            },
            
            confirmAndDeletePurchaseOrder: async (poFirebaseId, firebasePhoneKey) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", `هل أنت متأكد أنك تريد حذف أمر الشراء هذا (ID: ${poFirebaseId}) من رقم الهاتف ${firebasePhoneKey}؟\nهذا الإجراء لا يمكن التراجع عنه!`);
                if (!confirmed) {
                    UI.showToast("تم إلغاء حذف أمر الشراء.", 'info');
                    return;
                }
                UI.showToast("جاري حذف أمر الشراء...", 'info');
                try {
                    const poRef = database.ref(`${appId}/alldata/${firebasePhoneKey}/purchaseOrders/${poFirebaseId}`);
                    await poRef.remove();
                    UI.showToast("تم حذف أمر الشراء بنجاح!", 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`فشل حذف أمر الشراء: ${error.message}`, 'error');
                    console.error("Error deleting purchase order:", error);
                }
            },

            /**
             * Applies filters based on selected phone number and data type from the tree view.
             * This function now controls which content section is visible.
             */
            applyCombinedFilters: () => {
                const searchTerm = UIElements.commonSearchInput.value.toLowerCase();
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value; // This is for the dropdown filter
                
                // Determine the active phone and data type from the tree view selection
                const activePhoneInTree = currentSelectedPhone;
                const activeDataTypeInTree = currentSelectedDataType;

                // Toggle visibility of phone-specific action buttons
                if (activePhoneInTree !== 'all' && activePhoneInTree) {
                    if (UIElements.phoneActionsContainer) UIElements.phoneActionsContainer.style.display = 'flex';
                } else {
                    if (UIElements.phoneActionsContainer) UIElements.phoneActionsContainer.style.display = 'none';
                }

                // Hide all content sections first
                if (UIElements.detailedStatsSection) UIElements.detailedStatsSection.style.display = 'none';
                if (UIElements.purchaseOrdersListSection) UIElements.purchaseOrdersListSection.style.display = 'none';
                if (UIElements.duplicateProductsSection) UIElements.duplicateProductsSection.style.display = 'none';
                if (UIElements.inventoryProductsSection) UIElements.inventoryProductsSection.style.display = 'none';
                if (UIElements.soldProductsSection) UIElements.soldProductsSection.style.display = 'none';
                if (UIElements.invoicesListSection) UIElements.invoicesListSection.style.display = 'none';

                // Filter data based on selected phone number from the tree view (or 'all' data)
                const dataFilteredByPhone = allFirebaseProductsData.filter(p => activePhoneInTree === 'all' || p.firebasePhoneKey === activePhoneInTree);
                const invoicesFilteredByPhone = allFirebaseInvoicesData.filter(inv => activePhoneInTree === 'all' || inv.firebasePhoneKey === activePhoneInTree);
                const poFilteredByPhone = allFirebasePurchaseOrdersData.filter(po => activePhoneInTree === 'all' || po.firebasePhoneKey === activePhoneInTree);
                const duplicateFilteredByPhone = allFirebaseDuplicateProducts.filter(dp => activePhoneInTree === 'all' || dp.firebasePhoneKey === activePhoneInTree);
                const invoiceProductsFilteredByPhone = allFirebaseInvoiceProductsWithDetails.filter(ip => activePhoneInTree === 'all' || ip.firebasePhoneKey === activePhoneInTree);

                // Apply search term filter to the phone-filtered data
                const filteredInvoices = invoicesFilteredByPhone.filter(invoice => {
                    const matchesSearch = searchTerm ?
                        ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.companyName || '').toLowerCase().includes(searchTerm) || 
                            (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                            (invoice.products && invoice.products.some(p =>
                                (p.name || '').toLowerCase().includes(searchTerm) ||
                                (p.supplierName || '').toLowerCase().includes(searchTerm))))
                        : true;
                    // Also filter by the commonPhoneDropdown if it's not 'all'
                    const matchesDropdownPhone = (selectedPhoneNumber === 'all' || invoice.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesDropdownPhone;
                });

                const filteredProducts = dataFilteredByPhone.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierPhone && product.supplierPhone.includes(searchTerm)))
                        : true;
                    const matchesDropdownPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesDropdownPhone;
                });

                const filteredInvoiceProducts = invoiceProductsFilteredByPhone.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.customerName || '').toLowerCase().includes(searchTerm) ||
                            (product.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (product.companyName || '').toLowerCase().includes(searchTerm) || 
                            (product.ownerPhone && product.ownerPhone.includes(searchTerm)))
                        : true;
                    const matchesDropdownPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesDropdownPhone;
                });

                const filteredDuplicateProducts = duplicateFilteredByPhone.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierPhone && product.supplierPhone.includes(searchTerm)))
                        : true;
                    const matchesDropdownPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesDropdownPhone;
                });

                const filteredPurchaseOrders = poFilteredByPhone.filter(po => {
                    const matchesSearch = searchTerm ?
                        ((po.poSupplierName || '').toLowerCase().includes(searchTerm) ||
                            (po.poSupplierPhone && po.poSupplierPhone.includes(searchTerm)) ||
                            (po.poOwnerName || '').toLowerCase().includes(searchTerm) ||
                            (po.poOwnerPhone && po.poOwnerPhone.includes(searchTerm)) ||
                            (po.poNumber && po.poNumber.toLowerCase().includes(searchTerm)) ||
                            (po.poProducts && po.poProducts.some(p =>
                                (p.nom || '').toLowerCase().includes(searchTerm))))
                        : true;
                    const matchesDropdownPhone = (selectedPhoneNumber === 'all' || po.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesDropdownPhone;
                });

                // Update counts on the navigation buttons (if they existed, now they don't in this version's HTML)
                // If they were still there, they'd be handled by the next applyCombinedFilters call anyway.

                // Sort and display based on currentSelectedDataType
                switch (activeDataTypeInTree) {
                    case 'dashboard':
                        if (UIElements.detailedStatsSection) UIElements.detailedStatsSection.style.display = 'block';
                        FirebaseData.displayStatistics(filteredInvoices); // Stats based on filtered invoices
                        break;
                    case 'inventory':
                        if (UIElements.inventoryProductsSection) UIElements.inventoryProductsSection.style.display = 'block';
                        filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        FirebaseData.displayFirebaseProducts(filteredProducts);
                        break;
                    case 'invoices':
                        if (UIElements.invoicesListSection) UIElements.invoicesListSection.style.display = 'block';
                        filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                        FirebaseData.displayFirebaseInvoices(filteredInvoices);
                        break;
                    case 'purchaseOrders':
                        if (UIElements.purchaseOrdersListSection) UIElements.purchaseOrdersListSection.style.display = 'block';
                        filteredPurchaseOrders.sort((a, b) => new Date(b.poIsoDate || b.poDate) - new Date(a.poIsoDate || a.poDate));
                        FirebaseData.displayFirebasePurchaseOrders(filteredPurchaseOrders);
                        break;
                    case 'duplicates':
                        if (UIElements.duplicateProductsSection) UIElements.duplicateProductsSection.style.display = 'block';
                        filteredDuplicateProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        FirebaseData.displayFirebaseDuplicateProducts(filteredDuplicateProducts);
                        break;
                    case 'soldProducts':
                        if (UIElements.soldProductsSection) UIElements.soldProductsSection.style.display = 'block';
                        filteredInvoiceProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        FirebaseData.displayFirebaseInvoiceProducts(filteredInvoiceProducts);
                        break;
                    default:
                        // Default to dashboard if nothing is selected or an unknown type
                        if (UIElements.detailedStatsSection) UIElements.detailedStatsSection.style.display = 'block';
                        FirebaseData.displayStatistics(filteredInvoices);
                        break;
                }
            },

            clearAndFilter: () => {
                if (UIElements.commonSearchInput) UIElements.commonSearchInput.value = '';
                if (UIElements.commonPhoneDropdown) UIElements.commonPhoneDropdown.value = 'all';
                // Reset tree selection to 'all' and 'dashboard'
                FirebaseData.selectTreeItem('all', 'dashboard'); // Use new function
                UI.showToast("تم مسح حقول البحث وتحديث القوائم.", 'info');
            },

            displayFirebaseInvoices: (invoices) => {
                const container = UIElements.firebaseInvoicesContainer;
                if (!container) return; // Add check for container existence
                container.innerHTML = '';
                if (invoices.length === 0) {
                    container.innerHTML = '<p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد فواتير لعرضها.</p>';
                    return;
                }
                invoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('card-panel', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'cursor-pointer', 'hover:shadow-md', 'invoice-item-clickable', 'accent-primary'); 
                    invoiceDiv.dataset.invoiceId = invoice.firebaseId;
                    invoiceDiv.dataset.firebasePhoneKey = invoice.firebasePhoneKey;
                    
                    let productsListHtml = '<p class="text-center italic text-modern-text-dark text-xs py-2">لا توجد منتجات في هذه الفاتورة.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="invoice-products-scrollable custom-scrollbar">
                                <table class="invoice-products-table">
                                    <thead>
                                        <tr>
                                            <th>المنتج</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي (HT)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map(product => `
                                            <tr>
                                                <td>${product.name || 'N/A'}</td>
                                                <td>${product.quantityUsed || 0}</td>
                                                <td>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    let formattedInvoiceDate = 'N/A';
                    if (invoice.isoDate) {
                        try {
                            const dateObj = new Date(invoice.isoDate);
                            const options = {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false,
                                timeZone: 'Africa/Casablanca' 
                            };
                            formattedInvoiceDate = dateObj.toLocaleDateString('ar-MA', options);
                        } catch (e) {
                            console.warn("Invalid ISO date format for invoice:", invoice.isoDate, e);
                            formattedInvoiceDate = invoice.date || 'N/A'; 
                        }
                    } else if (invoice.date) {
                        formattedInvoiceDate = invoice.date;
                    }
                    
                    invoiceDiv.innerHTML = `
                        <div class="mb-2">
                            <p class="text-modern-text-dark"><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            ${invoice.companyName ? `<p class="text-modern-text-dark"><strong>الشركة:</strong> ${invoice.companyName}</p>` : ''}
                            <p class="text-modern-text-dark"><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>التاريخ:</strong> ${formattedInvoiceDate}</p>
                            <p class="text-modern-text-dark"><strong>الهاتف:</strong> ${invoice.ownerPhone || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="border-t border-dashed border-modern-border-light pt-2 mt-2 text-right">
                            <p class="text-modern-text-dark"><strong>الإجمالي (TTC):</strong> <span class="text-modern-success font-bold">${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</span></p>
                            <p class="text-modern-text-dark"><strong>الربح:</strong> <span class="text-modern-success font-bold">${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</span></p>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="modern-button btn-danger-action delete-invoice-button">
                                <i class="fas fa-trash-alt"></i> حذف
                            </button>
                        </div>
                    `;
                    container.appendChild(invoiceDiv);
                });
            },

            displayFirebaseProducts: (products) => {
                const container = UIElements.firebaseProductsContainer;
                if (!container) return; // Add check for container existence
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات لعرضها.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('card-panel', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'accent-primary');
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p class="text-modern-text-dark"><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p class="text-modern-text-dark"><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-modern-text-dark"><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>الكمية في المخزون:</strong> ${product.stockQuantity || 0}</p>
                        ${product.date ? `<p class="text-modern-text-dark"><strong>تاريخ الإضافة:</strong> ${product.date}</p>` : ''}
                        <p class="text-modern-text-dark"><strong>الحد الأدنى للمخزون:</strong> ${product.minStockQuantity || 0}</p>
                        ${product.firebasePhoneKey ? `<p class="text-modern-text-dark"><strong>رقم هاتف المالك (في Firebase):</strong> ${product.firebasePhoneKey}</p>` : ''}
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="modern-button btn-danger-action delete-product-button">
                                <i class="fas fa-trash-alt"></i> حذف
                            </button>
                        </div>
                    `;
                    container.appendChild(productDiv);
                });
            },

            displayFirebaseInvoiceProducts: (products) => {
                const container = UIElements.firebaseInvoiceProductsContainer;
                if (!container) return; // Add check for container existence
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات مباعة في الفواتير لعرضها.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('card-panel', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'accent-warning');
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.invoiceId = product.invoiceId;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    
                    let formattedInvoiceDate = 'N/A';
                    if (product.invoiceDate) { 
                        try {
                            const dateObj = new Date(product.invoiceDate);
                            const options = {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false,
                                timeZone: 'Africa/Casablanca'
                            };
                            formattedInvoiceDate = dateObj.toLocaleDateString('ar-MA', options);
                        } catch (e) {
                            console.warn("Invalid invoice date format for sold product:", product.invoiceDate, e);
                            formattedInvoiceDate = product.invoiceDate || 'N/A'; 
                        }
                    }
                    productDiv.innerHTML = `
                        <p class="text-modern-text-dark"><strong>المنتج:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>الكمية المباعة:</strong> ${product.quantityUsed || 0}</p>
                        <p class="text-modern-text-dark"><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-modern-text-dark"><strong>العميل:</strong> ${product.customerName || 'N/A'}</p>
                        ${product.companyName ? `<p class="text-modern-text-dark"><strong>الشركة:</strong> ${product.companyName}</p>` : ''}
                        <p class="text-modern-text-dark"><strong>مالك الفاتورة:</strong> ${product.ownerName || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>تاريخ الفاتورة:</strong> ${formattedInvoiceDate}</p>
                        <p class="text-modern-text-dark"><strong>رقم هاتف المالك (في Firebase):</strong> ${product.ownerPhone || product.firebasePhoneKey || 'N/A'}</p>
                    `;
                    container.appendChild(productDiv);
                });
            },

            displayFirebaseDuplicateProducts: (products) => {
                const container = UIElements.firebaseDuplicateProductsContainer;
                if (!container) return; // Add check for container existence
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد منتجات متكررة لعرضها.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('card-panel', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'accent-error');
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p class="text-modern-text-dark"><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p class="text-modern-text-dark"><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-modern-text-dark"><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                        <p class="text-modern-text-dark"><strong>الكمية في المخزون:</strong> ${product.stockQuantity || 0}</p>
                        ${product.date ? `<p class="text-modern-text-dark"><strong>تاريخ الإضافة:</strong> ${product.date}</p>` : ''}
                        <p class="text-modern-text-dark"><strong>رقم هاتف المالك:</strong> ${product.firebasePhoneKey || 'N/A'}</p>
                        <button class="modern-button btn-danger-action delete-product-button mt-4">
                            <i class="fas fa-trash-alt"></i> حذف هذا المنتج
                        </button>
                    `;
                    container.appendChild(productDiv);
                });
            },

            // NEW: displayFirebasePurchaseOrders
            displayFirebasePurchaseOrders: (purchaseOrders) => {
                const container = UIElements.firebasePurchaseOrdersContainer;
                if (!container) return; // Add check for container existence
                container.innerHTML = '';
                if (purchaseOrders.length === 0) {
                    container.innerHTML = '<p class="text-modern-text-dark text-center py-4 col-span-full">لا توجد أوامر شراء لعرضها.</p>';
                    return;
                }
                purchaseOrders.forEach(po => {
                    const poDiv = document.createElement('div');
                    poDiv.classList.add('card-panel', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'cursor-pointer', 'hover:shadow-md', 'po-item-clickable', 'accent-primary');
                    poDiv.dataset.poId = po.firebaseId;
                    poDiv.dataset.firebasePhoneKey = po.firebasePhoneKey;

                    let productsListHtml = '<p class="text-center italic text-modern-text-dark text-xs py-2">لا توجد منتجات في أمر الشراء هذا.</p>';
                    if (po.poProducts && po.poProducts.length > 0) { // Using poProducts as the local key for nested products
                        productsListHtml = `
                            <div class="po-products-scrollable custom-scrollbar">
                                <table class="po-products-table">
                                    <thead>
                                        <tr>
                                            <th>المنتج</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${po.poProducts.map(product => `
                                            <tr>
                                                <td>${product.nom || 'N/A'}</td>
                                                <td>${product.quantiteCommandee || 0}</td>
                                                <td>${(parseFloat(product.prixAchat || 0) * (product.quantiteCommandee || 0)).toFixed(2)} DH</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    let formattedPODate = 'N/A';
                    if (po.poIsoDate) {
                        try {
                            const dateObj = new Date(po.poIsoDate);
                            const options = {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false,
                                timeZone: 'Africa/Casablanca'
                            };
                            formattedPODate = dateObj.toLocaleDateString('ar-MA', options);
                        } catch (e) {
                            console.warn("Invalid ISO date format for purchase order:", po.poIsoDate, e);
                            formattedPODate = po.poDate || 'N/A';
                        }
                    } else if (po.poDate) {
                        formattedPODate = po.poDate;
                    }
                    poDiv.innerHTML = `
                        <div class="mb-2">
                            <p class="text-modern-text-dark"><strong>رقم أمر الشراء:</strong> ${po.poNumber || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>المورد:</strong> ${po.poSupplierName || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>هاتف المورد:</strong> ${po.poSupplierPhone || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>تاريخ الأمر:</strong> ${formattedPODate}</p>
                            <p class="text-modern-text-dark"><strong>مالك أمر الشراء:</strong> ${po.poOwnerName || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>هاتف المالك:</strong> ${po.poOwnerPhone || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>تاريخ التسليم المتوقع:</strong> ${po.poDeliveryDate || 'N/A'}</p>
                            <p class="text-modern-text-dark"><strong>الحالة:</strong> ${po.poStatus || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="border-t border-dashed border-modern-border-light pt-2 mt-2 text-right">
                            <p class="text-modern-text-dark"><strong>إجمالي التكلفة:</strong> <span class="text-modern-primary-accent font-bold">${parseFloat(po.totalCost || 0).toFixed(2)} DH</span></p>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="modern-button btn-danger-action delete-po-button">
                                <i class="fas fa-trash-alt"></i> حذف
                            </button>
                        </div>
                    `;
                    container.appendChild(poDiv);
                });
            },

            displayStatistics: (invoices) => {
                let totalSalesHT = 0;
                let totalTVA = 0;
                let totalSalesTTC = 0;
                let totalOverallProfit = 0;
                let totalOverallCommission = 0;
                let totalPurchaseCostAllProducts = 0;
                let totalSellingPriceAllProducts = 0;
                const productSales = {}; // { productName: { quantitySold, totalRevenue } }
                const customerActivity = {}; // { customerName: { invoiceCount, totalProfit, totalTTC } }
                const invoiceOwnerActivity = {}; // { ownerName: { invoiceCount, totalProfit, totalTTC } }
                const supplierActivity = {}; // { supplierName: { totalPurchaseCost, productsCount } }

                invoices.forEach(invoice => {
                    totalSalesHT += parseFloat(invoice.totalHT || 0);
                    totalTVA += parseFloat(invoice.tva || 0);
                    totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                    totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                    totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                    if (invoice.products) {
                        invoice.products.forEach(invoiceProduct => {
                            const productName = invoiceProduct.name || 'N/A';
                            const quantityUsed = parseInt(invoiceProduct.quantityUsed || 0);
                            const sellingPrice = parseFloat(invoiceProduct.sellingPrice || 0);
                            // Get original product data from inventoryProductsMap to access purchasePrice and supplierName
                            const originalProduct = inventoryProductsMap.get(String(invoiceProduct.id));
                            const purchasePrice = parseFloat(originalProduct ? originalProduct.purchasePrice || 0 : 0);
                            const supplierName = (originalProduct ? originalProduct.supplierName : 'مورد غير محدد');
                            
                            totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                            totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                            // Update product sales
                            productSales[productName] = (productSales[productName] || { quantitySold: 0, totalRevenue: 0 });
                            productSales[productName].quantitySold += quantityUsed;
                            productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                            // Update supplier activity
                            supplierActivity[supplierName] = (supplierActivity[supplierName] || { totalPurchaseCost: 0, productsCount: 0 });
                            supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                            supplierActivity[supplierName].productsCount += quantityUsed;
                        });
                    }

                    const customer = invoice.customerName || 'N/A';
                    const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                    const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                    const owner = invoice.ownerName || 'N/A';

                    // Update customer activity
                    customerActivity[customer] = (customerActivity[customer] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    customerActivity[customer].invoiceCount += 1;
                    customerActivity[customer].totalProfit += invoiceProfit;
                    customerActivity[customer].totalTTC += invoiceTTC;

                    // Update invoice owner activity
                    invoiceOwnerActivity[owner] = (invoiceOwnerActivity[owner] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    invoiceOwnerActivity[owner].invoiceCount += 1;
                    invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                    invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
                });

                // Update main statistics display
                if (UIElements.totalPurchaseCost) UIElements.totalPurchaseCost.textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
                if (UIElements.totalSellingPrice) UIElements.totalSellingPrice.textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
                if (UIElements.totalCommission) UIElements.totalCommission.textContent = `${totalOverallCommission.toFixed(2)} DH`;
                if (UIElements.totalProfit) UIElements.totalProfit.textContent = `${totalOverallProfit.toFixed(2)} DH`;
                if (UIElements.totalSalesHT) UIElements.totalSalesHT.textContent = `${totalSalesHT.toFixed(2)} DH`;
                if (UIElements.totalTVA) UIElements.totalTVA.textContent = `${totalTVA.toFixed(2)} DH`;
                if (UIElements.totalSalesTTC) UIElements.totalSalesTTC.textContent = `${totalSalesTTC.toFixed(2)} DH`;

                // Prepare data for dynamic lists
                const topSellingProductsData = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue, icon: 'fas fa-box' }));
                const topCustomersData = Object.entries(customerActivity).sort(([, a], [, b]) => b.totalTTC - a.totalTTC).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC, icon: 'fas fa-user' }));
                const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity).sort(([, a], [, b]) => b.totalProfit - a.totalProfit).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit, icon: 'fas fa-id-badge' }));
                const topSuppliersData = Object.entries(supplierActivity)
                    .sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost)
                    .map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount, icon: 'fas fa-truck-moving' }));

                // Render dynamic lists
                FirebaseData.renderSimpleList(UIElements.topSellingProductsList, topSellingProductsData, (item) => item.name, (item) => `الكمية: ${item.value} وحدة - الإجمالي: ${item.secondaryValue.toFixed(2)} د.م.`, 'fas fa-box');
                FirebaseData.renderSimpleList(UIElements.topCustomersList, topCustomersData, (item) => item.name, (item) => `فواتير: ${item.value} - الإجمالي: ${item.secondaryValue.toFixed(2)} د.م.`, 'fas fa-user');
                FirebaseData.renderSimpleList(UIElements.topInvoiceOwnersList, topInvoiceOwnersData, (item) => item.name, (item) => `فواتير: ${item.value} - الربح: ${item.secondaryValue.toFixed(2)} د.م.`, 'fas fa-id-badge');
                FirebaseData.renderSimpleList(
                    UIElements.topSuppliersList,
                    topSuppliersData,
                    (item) => item.name,
                    (item) => `قيمة المشتريات: ${item.value.toFixed(2)} د.م. - عدد المنتجات: ${item.secondaryValue}`,
                    'fas fa-truck-moving'
                );
            },

            renderSimpleList: (listEl, data, primaryTextFn, secondaryTextFn, iconClass) => {
                if (!listEl) return; // Add check for list element existence
                listEl.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.classList.add(
                            'list-item-card', 'p-3', 'rounded-lg', 'shadow-sm',
                            'flex', 'items-center', 'w-full', 'text-right', 'cursor-pointer',
                            'group' 
                        );
                        li.innerHTML = `
                            <div class="icon-wrapper">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="content-wrapper">
                                <span class="font-bold text-modern-primary-accent text-base mb-1 group-hover:text-modern-primary-accent transition-colors duration-200">${primaryTextFn(item)}</span>
                                <span class="text-modern-text-dark text-sm">${secondaryTextFn(item)}</span>
                            </div>
                        `;
                        li.dataset.searchTerm = primaryTextFn(item);
                        li.addEventListener('click', () => {
                            if (UIElements.commonSearchInput) UIElements.commonSearchInput.value = li.dataset.searchTerm;
                            FirebaseData.applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                    listEl.classList.toggle('has-more-items', listEl.children.length > 3);
                } else {
                    listEl.innerHTML = '<li class="text-modern-text-dark text-center py-2">لا توجد بيانات</li>';
                    listEl.classList.remove('has-more-items');
                }
            },

            /**
             * Renders the file explorer tree view.
             * @param {Array<string>} phoneNumbers - Array of unique phone numbers.
             */
            renderTreeView: (phoneNumbers) => {
                const treeRoot = UIElements.mainTreeRoot;
                if (!treeRoot) return; // Add check for treeRoot existence
                treeRoot.innerHTML = ''; // Clear existing tree

                // Add "All Firebase Data" root node
                const allDataNode = document.createElement('li');
                allDataNode.classList.add('folder');
                allDataNode.dataset.type = 'all';
                allDataNode.dataset.phone = 'all';
                allDataNode.innerHTML = `
                    <div class="folder-label">
                        <i class="fas fa-database"></i> <span>جميع بيانات Firebase</span>
                    </div>
                    <i class="fas fa-chevron-left toggle-icon"></i>
                `;
                treeRoot.appendChild(allDataNode);

                const allDataNestedList = document.createElement('ul');
                allDataNestedList.classList.add('nested');
                allDataNode.appendChild(allDataNestedList);

                // Add sub-nodes for "All Data" (Dashboard, All Inventory, All Invoices, etc.)
                const dashboardNode = document.createElement('li');
                dashboardNode.classList.add('file-item');
                dashboardNode.dataset.type = 'dashboard';
                dashboardNode.dataset.phone = 'all';
                dashboardNode.innerHTML = `<i class="fas fa-chart-line"></i> <span>لوحة التحكم (الكل)</span>`;
                allDataNestedList.appendChild(dashboardNode);

                const allInventoryNode = document.createElement('li');
                allInventoryNode.classList.add('file-item');
                allInventoryNode.dataset.type = 'inventory';
                allInventoryNode.dataset.phone = 'all';
                allInventoryNode.innerHTML = `<i class="fas fa-boxes"></i> <span>منتجات المخزون (الكل)</span>`;
                allDataNestedList.appendChild(allInventoryNode);

                const allInvoicesNode = document.createElement('li');
                allInvoicesNode.classList.add('file-item');
                allInvoicesNode.dataset.type = 'invoices';
                allInvoicesNode.dataset.phone = 'all';
                allInvoicesNode.innerHTML = `<i class="fas fa-cloud"></i> <span>الفواتير (الكل)</span>`;
                allDataNestedList.appendChild(allInvoicesNode);

                const allPurchaseOrdersNode = document.createElement('li');
                allPurchaseOrdersNode.classList.add('file-item');
                allPurchaseOrdersNode.dataset.type = 'purchaseOrders';
                allPurchaseOrdersNode.dataset.phone = 'all';
                allPurchaseOrdersNode.innerHTML = `<i class="fas fa-shopping-cart"></i> <span>أوامر الشراء (الكل)</span>`;
                allDataNestedList.appendChild(allPurchaseOrdersNode);

                const allSoldProductsNode = document.createElement('li');
                allSoldProductsNode.classList.add('file-item');
                allSoldProductsNode.dataset.type = 'soldProducts';
                allSoldProductsNode.dataset.phone = 'all';
                allSoldProductsNode.innerHTML = `<i class="fas fa-receipt"></i> <span>المنتجات المباعة (الكل)</span>`;
                allDataNestedList.appendChild(allSoldProductsNode);

                const allDuplicateProductsNode = document.createElement('li');
                allDuplicateProductsNode.classList.add('file-item');
                allDuplicateProductsNode.dataset.type = 'duplicates';
                allDuplicateProductsNode.dataset.phone = 'all';
                allDuplicateProductsNode.innerHTML = `<i class="fas fa-copy"></i> <span>المنتجات المتكررة (الكل)</span>`;
                allDataNestedList.appendChild(allDuplicateProductsNode);

                // Add phone number nodes
                phoneNumbers.forEach(phone => {
                    const phoneNode = document.createElement('li');
                    phoneNode.classList.add('folder');
                    phoneNode.dataset.type = 'phone';
                    phoneNode.dataset.phone = phone;
                    phoneNode.innerHTML = `
                        <div class="folder-label">
                            <i class="fas fa-mobile-alt"></i> <span>${phone}</span>
                        </div>
                        <i class="fas fa-chevron-left toggle-icon"></i>
                    `;
                    treeRoot.appendChild(phoneNode);

                    const nestedList = document.createElement('ul');
                    nestedList.classList.add('nested');
                    phoneNode.appendChild(nestedList);

                    // Add sub-nodes for each phone number
                    const dashboardPhoneNode = document.createElement('li');
                    dashboardPhoneNode.classList.add('file-item');
                    dashboardPhoneNode.dataset.type = 'dashboard';
                    dashboardPhoneNode.dataset.phone = phone;
                    dashboardPhoneNode.innerHTML = `<i class="fas fa-chart-line"></i> <span>لوحة التحكم</span>`;
                    nestedList.appendChild(dashboardPhoneNode);

                    const inventoryPhoneNode = document.createElement('li');
                    inventoryPhoneNode.classList.add('file-item');
                    inventoryPhoneNode.dataset.type = 'inventory';
                    inventoryPhoneNode.dataset.phone = phone;
                    inventoryPhoneNode.innerHTML = `<i class="fas fa-boxes"></i> <span>منتجات المخزون</span>`;
                    nestedList.appendChild(inventoryPhoneNode);

                    const invoicesPhoneNode = document.createElement('li');
                    invoicesPhoneNode.classList.add('file-item');
                    invoicesPhoneNode.dataset.type = 'invoices';
                    invoicesPhoneNode.dataset.phone = phone;
                    invoicesPhoneNode.innerHTML = `<i class="fas fa-cloud"></i> <span>الفواتير</span>`;
                    nestedList.appendChild(invoicesPhoneNode);

                    const purchaseOrdersPhoneNode = document.createElement('li');
                    purchaseOrdersPhoneNode.classList.add('file-item');
                    purchaseOrdersPhoneNode.dataset.type = 'purchaseOrders';
                    purchaseOrdersPhoneNode.dataset.phone = phone;
                    purchaseOrdersPhoneNode.innerHTML = `<i class="fas fa-shopping-cart"></i> <span>أوامر الشراء</span>`;
                    nestedList.appendChild(purchaseOrdersPhoneNode);

                    const soldProductsPhoneNode = document.createElement('li');
                    soldProductsPhoneNode.classList.add('file-item');
                    soldProductsPhoneNode.dataset.type = 'soldProducts';
                    soldProductsPhoneNode.dataset.phone = phone;
                    soldProductsPhoneNode.innerHTML = `<i class="fas fa-receipt"></i> <span>المنتجات المباعة</span>`;
                    nestedList.appendChild(soldProductsPhoneNode);

                    const duplicateProductsPhoneNode = document.createElement('li');
                    duplicateProductsPhoneNode.classList.add('file-item');
                    duplicateProductsPhoneNode.dataset.type = 'duplicates';
                    duplicateProductsPhoneNode.dataset.phone = phone;
                    duplicateProductsPhoneNode.innerHTML = `<i class="fas fa-copy"></i> <span>المنتجات المتكررة</span>`;
                    nestedList.appendChild(duplicateProductsPhoneNode);
                });

                // Initial selection: "All Firebase Data" -> Dashboard
                // This is handled by selectTreeItem at the end of fetchAndDisplayCombinedFirebaseData
            },

            /**
             * Handles selection of an item in the tree view.
             * Updates active classes and global state, then applies filters.
             * @param {string} phone - The selected phone number ('all' or specific number).
             * @param {string} type - The selected data type ('dashboard', 'inventory', etc.).
             */
            selectTreeItem: (phone, type) => {
                // Remove active class from all items
                if (UIElements.mainTreeRoot) {
                    UIElements.mainTreeRoot.querySelectorAll('li').forEach(item => {
                        item.classList.remove('active');
                    });
                }

                // Find and add active class to the selected item
                let selectedNode;
                if (phone === 'all' && type === 'dashboard') {
                     selectedNode = UIElements.mainTreeRoot.querySelector(`li.folder[data-phone="all"][data-type="all"]`);
                     if (selectedNode) {
                         selectedNode.classList.add('active', 'open');
                         const nestedUl = selectedNode.querySelector('ul.nested');
                         if (nestedUl) nestedUl.classList.add('active');
                         // Also activate the specific dashboard sub-item
                         const dashboardFileItem = selectedNode.querySelector(`li.file-item[data-phone="all"][data-type="dashboard"]`);
                         if (dashboardFileItem) dashboardFileItem.classList.add('active');
                     }
                } else if (phone === 'all' && type !== 'dashboard') {
                    selectedNode = UIElements.mainTreeRoot.querySelector(`li.file-item[data-phone="all"][data-type="${type}"]`);
                    if (selectedNode) {
                        selectedNode.classList.add('active');
                        // Ensure parent folder is open
                        const parentFolder = selectedNode.closest('li.folder');
                        if(parentFolder) {
                            parentFolder.classList.add('active', 'open');
                            const nestedUl = parentFolder.querySelector('ul.nested');
                            if(nestedUl) nestedUl.classList.add('active');
                        }
                    }
                }
                else { // Specific phone number selected
                    selectedNode = UIElements.mainTreeRoot.querySelector(`li.file-item[data-phone="${phone}"][data-type="${type}"]`);
                    if (selectedNode) {
                        selectedNode.classList.add('active');
                        // Ensure parent folder is open
                        const parentFolder = selectedNode.closest('li.folder');
                        if(parentFolder) {
                            parentFolder.classList.add('active', 'open');
                            const nestedUl = parentFolder.querySelector('ul.nested');
                            if(nestedUl) nestedUl.classList.add('active');
                        }
                    }
                }
                
                currentSelectedPhone = phone;
                currentSelectedDataType = type;

                // Update the common phone dropdown to reflect the selected phone from the tree
                if (UIElements.commonPhoneDropdown) UIElements.commonPhoneDropdown.value = phone;

                // Apply filters based on new selection
                FirebaseData.applyCombinedFilters();
            }
        };

        // ====== Initialization on Window Load for this section ======
        window.addEventListener('load', () => {
            // Initialize UIElements after DOM is loaded
            UIElements = {
                commonPhoneDropdown: document.getElementById('commonPhoneDropdown'),
                commonSearchInput: document.getElementById('commonSearchInput'),
                clearCommonSearchInputButton: document.getElementById('clearCommonSearchInput'),
                allSearchOptionsDatalist: document.getElementById('allSearchOptions'),
                // Removed nav button count spans as top nav is removed
                // navProductListCountSpan: document.getElementById('navProductListCount'),
                // navInvoiceListCountSpan: document.getElementById('navInvoiceListCount'),
                // navPurchaseOrderListCountSpan: document.getElementById('navPurchaseOrderListCount'),
                // navSoldProductListCount: document.getElementById('navSoldProductListCount'),
                // navDuplicateProductListCount: document.getElementById('navDuplicateProductListCount'),

                firebaseProductsContainer: document.getElementById('firebaseProductsContainer'),
                firebaseInvoicesContainer: document.getElementById('firebaseInvoicesContainer'),
                firebaseInvoiceProductsContainer: document.getElementById('firebaseInvoiceProductsContainer'),
                firebaseDuplicateProductsContainer: document.getElementById('firebaseDuplicateProductsContainer'), 
                firebasePurchaseOrdersContainer: document.getElementById('firebasePurchaseOrdersContainer'), 
                // Corrected loader IDs as per HTML
                firebaseProductsLoader: document.getElementById('firebaseProductsLoader'),
                firebaseInvoicesLoader: document.getElementById('firebaseInvoicesLoader'),
                firebaseInvoiceProductsLoader: document.getElementById('firebaseInvoiceProductsLoader'),
                firebaseDuplicateProductsLoader: document.getElementById('firebaseDuplicateProductsLoader'), 
                firebasePurchaseOrdersLoader: document.getElementById('firebasePurchaseOrdersLoader'), 
                totalPurchaseCost: document.getElementById('totalPurchaseCost'),
                totalSellingPrice: document.getElementById('totalSellingPrice'),
                totalCommission: document.getElementById('totalCommission'),
                totalProfit: document.getElementById('totalProfit'),
                totalSalesHT: document.getElementById('totalSalesHT'),
                totalTVA: document.getElementById('totalTVA'),
                totalSalesTTC: document.getElementById('totalSalesTTC'),
                dynamicStatsListContainer: document.getElementById('dynamicStatsListContainer'),
                topSellingProductsList: document.getElementById('topSellingProductsList'),
                topCustomersList: document.getElementById('topCustomersList'),
                topInvoiceOwnersList: document.getElementById('topInvoiceOwnersList'),
                topSuppliersList: document.getElementById('topSuppliersList'),
                toastContainer: document.getElementById('toast-container'), 
                // Phone-specific action buttons and their container
                phoneActionsContainer: document.getElementById('phoneActions'),
                exportPhoneDataBtn: document.getElementById('exportPhoneDataBtn'),
                deletePhoneDataBtn: document.getElementById('deletePhoneDataBtn'),
                // Invoice Modal elements
                invoiceDisplayModalOverlay: document.getElementById('invoiceDisplayModalOverlay'),
                invoiceDisplayModalContent: document.getElementById('invoiceDisplayModalContent'),
                modalCustomerName: document.getElementById('modalCustomerName'),
                modalCompanyName: document.getElementById('modalCompanyName'),
                modalInvoiceDate: document.getElementById('modalInvoiceDate'),
                modalInvoiceOwner: document.getElementById('modalInvoiceOwner'),
                modalInvoiceOwnerAddress: document.getElementById('modalInvoiceOwnerAddress'),
                modalInvoiceOwnerPhone: document.getElementById('modalInvoiceOwnerPhone'),
                modalInvoiceProductsTableBody: document.getElementById('modalInvoiceProductsTableBody'),
                modalTotalAmountBeforeCommission: document.getElementById('modalTotalAmountBeforeCommission'),
                modalCommissionDeducted: document.getElementById('modalCommissionDeducted'),
                modalTotalAmount: document.getElementById('modalTotalAmount'),
                modalTVA: document.getElementById('modalTVA'),
                modalTotalTTC: document.getElementById('modalTotalTTC'),
                modalTotalProfit: document.getElementById('modalTotalProfit'),
                closeInvoiceModalBtn: document.getElementById('closeInvoiceModalBtn'),
                printInvoiceModalBtn: document.getElementById('printInvoiceModalBtn'),
                invoiceModalLoader: document.getElementById('invoiceModalLoader'),
                // Purchase Order Modal elements
                purchaseOrderDisplayModalOverlay: document.getElementById('purchaseOrderDisplayModalOverlay'),
                purchaseOrderDisplayModalContent: document.getElementById('purchaseOrderDisplayModalContent'),
                modalPOSupplierName: document.getElementById('modalPOSupplierName'),
                modalPOSupplierPhone: document.getElementById('modalPOSupplierPhone'),
                modalPODate: document.getElementById('modalPODate'),
                modalPOOwnerName: document.getElementById('modalPOOwnerName'),
                modalPOOwnerPhone: document.getElementById('modalPOOwnerPhone'),
                modalPOProductsTableBody: document.getElementById('modalPOProductsTableBody'),
                modalPOTotalCost: document.getElementById('modalPOTotalCost'),
                modalPONumber: document.getElementById('modalPONumber'), 
                modalPODeliveryDate: document.getElementById('modalPODeliveryDate'), 
                modalPOStatus: document.getElementById('modalPOStatus'), 
                closePurchaseOrderModalBtn: document.getElementById('closePurchaseOrderModalBtn'),
                printPurchaseOrderModalBtn: document.getElementById('printPurchaseOrderModalBtn'),
                purchaseOrderModalLoader: document.getElementById('purchaseOrderModalLoader'),
                // NEW: Tree View elements
                mainTreeRoot: document.getElementById('mainTreeRoot'),
                // NEW: Section elements for toggling visibility
                detailedStatsSection: document.getElementById('detailed-stats'),
                purchaseOrdersListSection: document.getElementById('purchase-orders-list'),
                duplicateProductsSection: document.getElementById('duplicate-products'),
                inventoryProductsSection: document.getElementById('inventory-products'),
                soldProductsSection: document.getElementById('sold-products'),
                invoicesListSection: document.getElementById('invoices-list'),
                // NEW: Burger Menu and Overlay (re-added for mobile sidebar)
                burgerMenu: document.getElementById('burgerMenu'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebarOverlay')
            };

            // Log UIElements after initialization to debug if elements are null
            console.log("UIElements after initialization:", UIElements);

            FirebaseData.init();
            FirebaseData.fetchAndDisplayCombinedFirebaseData();
        });
    </script>
</body>
</html>
