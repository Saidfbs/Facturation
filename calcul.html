<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Corrected viewport meta tag -->
    <title>Ø¨ÙŠØ§Ù†Ø§Øª Firebase ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù„ÙˆØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for Arabic typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js CDN for charts (REMOVED as charts are no longer used) -->

    <style>
        /* Professional Dashboard Color Palette (CSS Variables) */
        :root {
            --dashboard-bg-primary: hsl(210, 10%, 97%); /* Very light off-white/gray */
            --dashboard-card-bg: hsl(0, 0%, 100%);      /* Pure white for cards */
            --dashboard-primary-blue: hsl(210, 29%, 29%); /* Deep professional blue */
            --dashboard-accent-blue: hsl(205, 78%, 42%); /* Vibrant accent blue */
            --dashboard-accent-green: hsl(120, 50%, 50%); /* Clear success green */
            --dashboard-accent-orange: hsl(45, 80%, 65%); /* Soft orange for distinction */
            --dashboard-accent-red: hsl(0, 70%, 55%);    /* Standard error red */
            --dashboard-text-dark: hsl(210, 10%, 15%);   /* Dark gray for primary text */
            --dashboard-text-secondary: hsl(210, 5%, 40%); /* Medium gray for secondary text */
            --dashboard-border-light: hsl(210, 5%, 90%); /* Light gray border */
            --dashboard-hover-bg: hsl(210, 30%, 96%); /* Light hover background */
            --dashboard-shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.08);
            --dashboard-shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.12);
            --dashboard-shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.18);
            /* Added RGB values for focus rings */
            --dashboard-accent-blue-rgb: 59, 130, 246;
            --dashboard-accent-green-rgb: 16, 185, 129;
            --dashboard-accent-red-rgb: 239, 68, 68;
        }

        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl; /* Ensure right-to-left direction */
            background: linear-gradient(to bottom right, #e0e7ff, #bfdbfe); /* Soft blue gradient background for Vista feel */
            color: var(--dashboard-text-dark);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
        }

        /* Windows Vista Aero Glass effect simulation */
        .aero-glass {
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white */
            backdrop-filter: blur(10px); /* Blur effect */
            -webkit-backdrop-filter: blur(10px); /* Safari support */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); /* Soft shadow */
            border-radius: 16px;
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbars */
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--dashboard-bg-primary);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--dashboard-accent-blue);
            border-radius: 10px;
            border: 2px solid var(--dashboard-bg-primary);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--dashboard-primary-blue);
        }

        /* Hide number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Toast specific animations */
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .toast-firebase.animate-fade {
            animation: fadeinout 4s forwards;
        }

        /* Loader animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            animation: spin 1s linear infinite;
        }

        /* Action buttons styling (Vista-like) */
        .vista-button {
            background: linear-gradient(to bottom, #d9e8fb 0%, #c1d9f7 100%); /* Vista blue gradient */
            border: 1px solid #94b9e7;
            color: #1f4f8b; /* Dark blue text */
            font-weight: 600;
            padding: 10px 16px; /* Increased padding for better touch target */
            border-radius: 6px; /* Slightly less rounded than modern */
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
            cursor: pointer;
            display: inline-flex; /* Use inline-flex for icon alignment */
            align-items: center;
            gap: 8px; /* Increased gap for icon */
            justify-content: center;
        }
        .vista-button:hover {
            background: linear-gradient(to bottom, #e0efff 0%, #c8e0ff 100%);
            border-color: #8bb1e6;
            transform: translateY(-2px); /* More pronounced hover effect */
            box-shadow: var(--dashboard-shadow-medium);
        }
        .vista-button:active {
            background: linear-gradient(to bottom, #c1d9f7 0%, #d9e8fb 100%);
            border-color: #7da8e0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(0);
        }

        /* Specific styles for delete/action buttons to override vista-button if needed */
        .delete-button {
            background-color: var(--dashboard-accent-red);
            color: white;
            border: none;
            box-shadow: var(--dashboard-shadow-subtle);
        }
        .delete-button:hover {
            background-color: hsl(0, 80%, 45%);
        }

        .action-button.blue {
            background-color: var(--dashboard-accent-blue);
            color: white;
            border: none;
            box-shadow: var(--dashboard-shadow-subtle);
        }
        .action-button.blue:hover {
            background-color: var(--dashboard-primary-blue);
        }

        /* Section titles with icons */
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px; /* Increased gap */
            padding-bottom: 12px; /* More padding */
            margin-bottom: 24px; /* More margin */
            border-bottom: 2px solid var(--dashboard-border-light); /* Thicker border */
            font-size: 1.8rem; /* Larger font size */
            font-weight: 700; /* Bolder font */
            color: var(--dashboard-primary-blue);
            justify-content: flex-start; /* Align to start for RTL */
        }
        .section-title i {
            color: var(--dashboard-accent-blue);
            font-size: 1.5em; /* Make icon larger relative to text */
        }

        /* Input and Select field styling */
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            padding: 12px; /* More padding */
            border-radius: 8px; /* More rounded */
            border: 1px solid var(--dashboard-border-light);
            background-color: var(--dashboard-card-bg);
            color: var(--dashboard-text-dark);
            transition: all 0.2s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--dashboard-accent-blue);
            box-shadow: 0 0 0 3px rgba(var(--dashboard-accent-blue-rgb), 0.2); /* Soft focus ring */
        }

        /* Specific styling for the commonPhoneDropdown to align with professional look */
        #commonPhoneDropdown {
            padding-left: 40px; /* Space for custom arrow icon (adjusted for RTL) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%234B5563\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><polyline points=\'6 9 12 15 18 9\'></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center; /* Position for RTL */
            background-size: 18px;
            -webkit-appearance: none; /* Remove default arrow */
            -moz-appearance: none;
            appearance: none;
        }

        /* Specific styling for the commonSearchInput */
        #commonSearchInput {
            padding-left: 50px; /* Space for custom search icon (adjusted for RTL) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%234B5563\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><circle cx=\'11\' cy=\'11\' r=\'8\'></circle><line x1=\'21\' y1=\'21\' x2=\'16.65\' y2=\'16.65\'></line></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center; /* Position for RTL */
            background-size: 20px;
        }

        /* Ensure the toast container is correctly positioned and styled */
        #toast-container-firebase {
            position: fixed;
            bottom: 1rem;
            right: 1rem; /* Adjusted for RTL */
            z-index: 50;
            display: flex;
            flex-direction: column-reverse; /* New toasts appear on top */
            gap: 0.75rem;
            align-items: flex-end; /* Align toasts to the right for RTL */
            width: auto;
            max-width: 90vw;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            position: relative;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            backdrop-filter: blur(15px); /* Stronger blur for modal */
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px; /* Adjusted for RTL */
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: #ef4444; /* Red on hover */
        }
    </style>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
</head>
<body>

    <!-- Header / Navigation Bar -->
    <header class="bg-white shadow-sm py-4 px-6 md:px-10 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-3">
                <i class="fas fa-database text-dashboard-accent-blue"></i>
                <span class="text-dashboard-primary-blue">Ø¨ÙŠØ§Ù†Ø§Øª</span> Firebase ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </h1>
            <nav>
                <ul class="flex space-x-4 space-x-reverse">
                    <li><a href="#detailed-stats" class="text-gray-600 hover:text-dashboard-accent-blue font-medium transition duration-200">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                    <!-- Add more navigation links if needed -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto space-y-10">
            <!-- Section: Detailed Sales Statistics -->
            <section id="detailed-stats" class="aero-glass p-6 rounded-xl shadow-lg border border-dashboard-border-light">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
                </h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex-1 min-w-[250px]">
                        <label for="commonPhoneDropdown" class="sr-only">ØªØµÙÙŠØ© Ø§Ù„ÙƒÙ„ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <select id="commonPhoneDropdown"
                            class="w-full p-3 rounded-md border border-dashboard-border-light bg-dashboard-card-bg text-dashboard-text-dark focus:ring-2 focus:ring-dashboard-accent-blue focus:border-dashboard-accent-blue">
                        </select>
                    </div>
                </div>
                <div id="phoneActions" class="flex flex-wrap gap-4 mb-6 justify-center" style="display: none;">
                    <button type="button" id="exportPhoneDataBtn" class="vista-button">
                        <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ
                    </button>
                    <button type="button" id="deletePhoneDataBtn" class="vista-button delete-button">
                        <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Metric Cards -->
                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
                        <p id="totalPurchaseCost" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</h3>
                        <p id="totalSellingPrice" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</h3>
                        <p id="totalCommission" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
                        <p id="totalProfit" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (HT)</h3>
                        <p id="totalSalesHT" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ TVA</h3>
                        <p id="totalTVA" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>

                    <div class="aero-glass p-4 text-center shadow-sm hover:translate-y-[-5px] hover:scale-[1.02] hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                        <div class="absolute -top-5 -right-5 w-20 h-20 bg-dashboard-accent-blue rounded-full opacity-10 transform scale-0 group-hover:scale-100 transition-transform duration-500 z-0"></div>
                        <h3 class="text-dashboard-text-secondary text-sm sm:text-base mb-2 relative z-10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (TTC)</h3>
                        <p id="totalSalesTTC" class="text-dashboard-primary-blue text-2xl sm:text-3xl font-bold relative z-10 font-mono">0.00 DH</p>
                    </div>
                </div>

                <!-- Removed Charts Section -->
                <!-- The grid layout for charts is removed, so the dynamicStatsListContainer will now take full width if no other elements are next to it. -->

                <div id="dynamicStatsListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                    <div class="aero-glass p-4 shadow-sm flex flex-col">
                        <h3 class="section-title text-xl">
                            <i class="fas fa-box-open"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
                        </h3>
                        <ul id="topSellingProductsList" class="custom-scrollbar overflow-y-auto min-h-[150px] max-h-[204px] space-y-2 pr-2">
                            <li class="text-dashboard-text-secondary text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>
                        </ul>
                    </div>

                    <div class="aero-glass p-4 shadow-sm flex flex-col">
                        <h3 class="section-title text-xl">
                            <i class="fas fa-user-friends"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹
                        </h3>
                        <ul id="topCustomersList" class="custom-scrollbar overflow-y-auto min-h-[150px] max-h-[204px] space-y-2 pr-2">
                            <li class="text-dashboard-text-secondary text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>
                        </ul>
                    </div>

                    <div class="aero-glass p-4 shadow-sm flex flex-col">
                        <h3 class="section-title text-xl">
                            <i class="fas fa-file-invoice-dollar"></i> Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹
                        </h3>
                        <ul id="topInvoiceOwnersList" class="custom-scrollbar overflow-y-auto min-h-[150px] max-h-[204px] space-y-2 pr-2">
                            <li class="text-dashboard-text-secondary text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>
                        </ul>
                    </div>

                    <div class="aero-glass p-4 shadow-sm flex flex-col">
                        <h3 class="section-title text-xl">
                            <i class="fas fa-truck"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹
                        </h3>
                        <ul id="topSuppliersList" class="custom-scrollbar overflow-y-auto min-h-[150px] max-h-[204px] space-y-2 pr-2">
                            <li class="text-dashboard-text-secondary text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>
                        </ul>
                    </div>
                </div>
                <div class="relative flex items-center gap-2 mt-6">
                    <button type="button" id="clearCommonSearchInput"
                        class="vista-button delete-button px-4 py-2 rounded-full shadow-sm flex items-center justify-center gap-1 h-11">
                        <i class="fas fa-times-circle"></i> Ù…Ø³Ø­
                    </button>
                    <input type="text" id="commonSearchInput"
                        class="flex-1 p-3 rounded-full border border-dashboard-border-light bg-dashboard-card-bg text-dashboard-text-dark focus:ring-2 focus:ring-dashboard-accent-blue focus:border-dashboard-accent-blue pr-12 text-right"
                        placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬" list="allSearchOptions">
                    <datalist id="allSearchOptions"></datalist>
                </div>
            </section>

            <!-- Section: Duplicate Products -->
            <section id="duplicate-products" class="aero-glass p-6 rounded-xl shadow-lg border border-dashboard-border-light">
                <h2 class="section-title">
                    <i class="fas fa-copy text-dashboard-accent-orange"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    (<span id="firebaseDuplicateProductListCount">0</span>)
                </h2>
                <div id="firebaseDuplicateProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªÙƒØ±Ø±Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
                </div>
                <div id="firebaseDuplicateProductsLoader" class="loader w-8 h-8 border-4 border-dashboard-border-light border-t-dashboard-accent-blue rounded-full mx-auto mt-6 hidden"></div>
            </section>

            <!-- Section: Inventory Products List -->
            <section id="inventory-products" class="aero-glass p-6 rounded-xl shadow-lg border border-dashboard-border-light">
                <h2 class="section-title">
                    <i class="fas fa-boxes"></i> Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Firebase
                    (<span id="firebaseProductListCount">0</span>)
                </h2>
                <button class="vista-button bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 mb-6" onclick="openModal('addProductModal')">
                    â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                </button>
                <div id="firebaseProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
                </div>
                <div id="firebaseProductsLoader" class="loader w-8 h-8 border-4 border-dashboard-border-light border-t-dashboard-accent-blue rounded-full mx-auto mt-6 hidden"></div>
            </section>

            <!-- Section: Sold Products in Invoices -->
            <section id="sold-products" class="aero-glass p-6 rounded-xl shadow-lg border border-dashboard-border-light">
                <h2 class="section-title">
                    <i class="fas fa-receipt text-dashboard-accent-orange"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                    (<span id="firebaseInvoiceProductListCount">0</span>)
                </h2>
                <div id="firebaseInvoiceProductsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
                </div>
                <div id="firebaseInvoiceProductsLoader" class="loader w-8 h-8 border-4 border-dashboard-border-light border-t-dashboard-accent-blue rounded-full mx-auto mt-6 hidden"></div>
            </section>

            <!-- Section: Firebase Invoices List -->
            <section id="invoices-list" class="aero-glass p-6 rounded-xl shadow-lg border border-dashboard-border-light">
                <h2 class="section-title">
                    <i class="fas fa-cloud"></i> Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ§ØªÙŠØ± Firebase
                    (<span id="firebaseInvoiceListCount">0</span>)
                </h2>
                <button class="vista-button bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 mb-6" onclick="openModal('addInvoiceModal')">
                    ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
                <div id="firebaseInvoicesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
                </div>
                <div id="firebaseInvoicesLoader" class="loader w-8 h-8 border-4 border-dashboard-border-light border-t-dashboard-accent-blue rounded-full mx-auto mt-6 hidden"></div>
            </section>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container-firebase" class="fixed bottom-4 right-4 z-50 flex flex-col-reverse gap-3 items-end w-auto max-w-[90vw] p-4 box-border"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 text-center text-sm mt-10">
        <p>&copy; 2024 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </footer>

    <!-- Modals for Input Forms -->

    <!-- Add/Edit Product Modal -->
    <div id="addProductModal" class="modal-overlay">
        <div class="modal-content aero-glass">
            <button class="close-button" onclick="closeModal('addProductModal')">âœ–</button>
            <h3 class="text-2xl font-bold text-gray-900 mb-6">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h3>
            <form id="productForm" onsubmit="event.preventDefault(); handleProductFormSubmit();">
                <input type="hidden" id="productId" value="">
                <input type="hidden" id="productFirebasePhoneKey" value="">
                <div class="mb-4">
                    <label for="productName" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                    <input type="text" id="productName" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required>
                </div>
                <div class="mb-4">
                    <label for="productPurchasePrice" class="block text-gray-700 text-sm font-bold mb-2">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (DH):</label>
                    <input type="number" id="productPurchasePrice" class="w-full" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" required>
                </div>
                <div class="mb-4">
                    <label for="productSellingPrice" class="block text-gray-700 text-sm font-bold mb-2">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (DH):</label>
                    <input type="number" id="productSellingPrice" class="w-full" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" required>
                </div>
                <div class="mb-4">
                    <label for="productSupplierName" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                    <input type="text" id="productSupplierName" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" required>
                </div>
                <div class="mb-4">
                    <label for="productSupplierAddress" class="block text-gray-700 text-sm font-bold mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                    <input type="text" id="productSupplierAddress" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯">
                </div>
                <div class="mb-4">
                    <label for="productSupplierPhone" class="block text-gray-700 text-sm font-bold mb-2">Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                    <input type="text" id="productSupplierPhone" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯" required>
                </div>
                <div class="mb-6">
                    <label for="productStockQuantity" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</label>
                    <input type="number" id="productStockQuantity" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©" required>
                </div>
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" class="vista-button bg-gray-300 hover:bg-gray-400 text-gray-800" onclick="closeModal('addProductModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="vista-button bg-blue-500 hover:bg-blue-600 text-white">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Invoice Modal -->
    <div id="addInvoiceModal" class="modal-overlay">
        <div class="modal-content aero-glass">
            <button class="close-button" onclick="closeModal('addInvoiceModal')">âœ–</button>
            <h3 class="text-2xl font-bold text-gray-900 mb-6">Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</h3>
            <form id="invoiceForm" onsubmit="event.preventDefault(); handleInvoiceFormSubmit();">
                <input type="hidden" id="invoiceId" value="">
                <input type="hidden" id="invoiceFirebasePhoneKey" value="">
                <div class="mb-4">
                    <label for="invoiceCustomerName" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                    <input type="text" id="invoiceCustomerName" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
                </div>
                <div class="mb-4">
                    <label for="invoiceOwnerName" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                    <input type="text" id="invoiceOwnerName" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" required>
                </div>
                <div class="mb-4">
                    <label for="invoiceOwnerAddress" class="block text-gray-700 text-sm font-bold mb-2">Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                    <input type="text" id="invoiceOwnerAddress" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                </div>
                <div class="mb-4">
                    <label for="invoiceOwnerPhone" class="block text-gray-700 text-sm font-bold mb-2">Ù‡Ø§ØªÙ Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                    <input type="text" id="invoiceOwnerPhone" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ Ù‡Ø§ØªÙ Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" required>
                </div>
                <div class="mb-4">
                    <label for="invoiceDate" class="block text-gray-700 text-sm font-bold mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                    <input type="date" id="invoiceDate" class="w-full" required>
                </div>
                <div class="mb-6">
                    <label for="invoiceCommissionRate" class="block text-gray-700 text-sm font-bold mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%):</label>
                    <input type="number" id="invoiceCommissionRate" class="w-full" step="0.01" value="0" min="0" max="100" placeholder="Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©">
                </div>
                <h4 class="text-lg font-bold text-gray-800 mb-3">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h4>
                <div id="invoiceProductsContainer" class="space-y-4 mb-6 border p-4 rounded-lg bg-gray-50 custom-scrollbar max-h-60 overflow-y-auto">
                    <!-- Products will be dynamically added here -->
                    <p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</p>
                </div>
                <button type="button" class="vista-button bg-blue-500 hover:bg-blue-600 text-white mb-6 w-full" onclick="addInvoiceProductRow()">
                    â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
                <div class="flex justify-end space-x-4 space-x-reverse">
                    <button type="button" class="vista-button bg-gray-300 hover:bg-gray-400 text-gray-800" onclick="closeModal('addInvoiceModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="vista-button bg-blue-500 hover:bg-blue-600 text-white">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Tailwind CSS Configuration to extend colors with CSS variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dashboard-bg-primary': 'var(--dashboard-bg-primary)',
                        'dashboard-card-bg': 'var(--dashboard-card-bg)',
                        'dashboard-primary-blue': 'var(--dashboard-primary-blue)',
                        'dashboard-accent-blue': 'var(--dashboard-accent-blue)',
                        'dashboard-accent-green': 'var(--dashboard-accent-green)',
                        'dashboard-accent-orange': 'var(--dashboard-accent-orange)',
                        'dashboard-accent-red': 'var(--dashboard-accent-red)',
                        'dashboard-text-dark': 'var(--dashboard-text-dark)',
                        'dashboard-text-secondary': 'var(--dashboard-text-secondary)',
                        'dashboard-border-light': 'var(--dashboard-border-light)',
                        'dashboard-hover-bg': 'var(--dashboard-hover-bg)',
                    },
                },
            },
        };

        // Firebase Configuration (must match your project)
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
            // Add other config properties if needed, e.g., projectId, apiKey, etc.
        };
        let firebaseApp;
        let database;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            UI.showToast("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase. Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.", 'error');
        }

        // App ID (use __app_id if available in your environment, otherwise provide a default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global Data Stores for this section
        let allFirebaseInvoicesData = []; // Stores invoices after mapping to local keys
        let allFirebaseProductsData = []; // Stores products from inventoryProducts after mapping to local keys
        let allFirebaseInvoiceProductsWithDetails = []; // Stores products from invoices with customer/owner details
        let inventoryProductsMap = new Map(); // Use a Map to quickly access original product data from inventoryProducts
        let allFirebaseDuplicateProducts = []; // Stores detected duplicate products
        let currentInvoiceProducts = []; // For managing products in the invoice modal

        // ====== Key Mapping for Firebase (Local Keys <-> French Keys) ======
        // IMPORTANT: These mappings MUST match the ones in your main sales application EXACTLY.
        const KEY_MAPPING_TO_FIREBASE = {
            // Product Keys (fields within the product object)
            id: 'id',
            name: 'nom',
            purchasePrice: 'prixAchat',
            sellingPrice: 'prixVente',
            supplierName: 'nomFournisseur',
            supplierAddress: 'adresseFournisseur',
            supplierPhone: 'telephoneFournisseur',
            stockQuantity: 'quantiteStock',
            date: 'dateCreationProduit', // This should match what's saved in main app
            // 'quantity' and 'isLocal' are local-only in the sales app, so they are not mapped for Firebase storage.
            // quantity: 'quantiteSelectionnee', 
            // isLocal: 'estLocal', 
            // Invoice Keys (fields within the invoice object)
            // id: 'id', // This is for the invoice ID itself. (handled manually as firebase key)
            date: 'dateFacture', // Formatted date string for display (matches original app)
            isoDate: 'dateIsoFacture', // ISO string for sorting
            customerName: 'nomClient',
            ownerName: 'nomProprietaire',
            ownerAddress: 'adresseProprietaire',
            ownerPhone: 'telephoneProprietaire', // Used in path and as data
            products: 'produits', // This is the key for the array of products *within an invoice*
            totalHT: 'totalHT',
            totalHTBeforeCommission: 'totalHTAvantCommission',
            tva: 'tva',
            totalTTC: 'totalTTC',
            totalProfit: 'profitTotal',
            totalCommission: 'commissionTotale',
            invoiceCommissionRate: 'tauxCommissionFacture',
            // Product within Invoice Keys (fields within product objects inside the invoice's products array)
            quantityUsed: 'quantiteUtilisee' // Quantity used in a specific invoice item
        };

        // Create reverse mapping for converting from Firebase French keys back to local keys
        const KEY_MAPPING_FROM_FIREBASE = {};
        for (const localKey in KEY_MAPPING_TO_FIREBASE) {
            KEY_MAPPING_FROM_FIREBASE[KEY_MAPPING_TO_FIREBASE[localKey]] = localKey;
        }

        /**
         * Maps an object's keys from French Firebase names back to local JavaScript names.
         * Keys not found in KEY_MAPPING_FROM_FIREBASE are passed through as is.
         * Handles nested 'produits' array within an invoice object recursively.
         * @param {object} fbObj - The object with French Firebase keys to map.
         * @returns {object} A new object with keys mapped back to local JavaScript names.
         */
        function mapFromFirebaseKeys(fbObj) {
            if (fbObj === null || typeof fbObj !== 'object') {
                return fbObj;
            }
            const newObj = {};
            for (const fbKey in fbObj) {
                if (fbObj.hasOwnProperty(fbKey)) {
                    const localKey = KEY_MAPPING_FROM_FIREBASE[fbKey];
                    if (fbKey === 'produits' && Array.isArray(fbObj[fbKey])) {
                        newObj[localKey || fbKey] = fbObj[fbKey].map(p => {
                            const productMapped = {};
                            for (const productFbKey in p) {
                                if (p.hasOwnProperty(productFbKey)) {
                                    productMapped[KEY_MAPPING_FROM_FIREBASE[productFbKey] || productFbKey] = p[productFbKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[localKey || fbKey] = fbObj[fbKey];
                    }
                }
            }
            return newObj;
        }

        /**
         * Maps an object's keys from local JavaScript names to French Firebase names.
         * Keys not found in KEY_MAPPING_TO_FIREBASE are passed through as is.
         * Handles nested 'products' array within an invoice object recursively.
         * @param {object} localObj - The object with local JavaScript keys to map.
         * @returns {object} A new object with keys mapped to French Firebase names.
         */
        function mapToFirebaseKeys(localObj) {
            if (localObj === null || typeof localObj !== 'object') {
                return localObj;
            }
            const newObj = {};
            for (const localKey in localObj) {
                if (localObj.hasOwnProperty(localKey)) {
                    const fbKey = KEY_MAPPING_TO_FIREBASE[localKey];
                    if (localKey === 'products' && Array.isArray(localObj[localKey])) {
                        newObj[fbKey || localKey] = localObj[localKey].map(p => {
                            const productMapped = {};
                            for (const productLocalKey in p) {
                                if (p.hasOwnProperty(productLocalKey)) {
                                    productMapped[KEY_MAPPING_TO_FIREBASE[productLocalKey] || productLocalKey] = p[productLocalKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[fbKey || localKey] = localObj[localKey];
                    }
                }
            }
            return newObj;
        }

        /**
         * Sanitizes a phone number to be used as a Firebase key.
         * Replaces invalid characters with underscores.
         * Must match the sanitization in the sales application.
         * @param {string} phoneNumber - The phone number to sanitize.
         * @returns {string} The sanitized phone number.
         */
        function sanitizePhoneNumber(phoneNumber) {
            return String(phoneNumber).replace(/[.#$[\]]/g, '_');
        }

        let UIElements; // Declared here, assigned in window.onload

        // ====== UI Utility Functions (minimal set for this section) ======
        const UI = {
            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast-firebase', `bg-dashboard-card-bg`, `text-dashboard-text-dark`, `p-4`, `rounded-lg`, `shadow-lg`, `min-w-[250px]`, `max-w-[350px]`, `opacity-0`, `translate-y-5`, `animate-fade`, `flex`, `items-center`, `gap-2`, `border`, `border-dashboard-border-light`);
                let iconHtml = '';
                let borderColorClasses = '';
                if (type === 'success') {
                    iconHtml = '<span class="text-dashboard-accent-green text-xl leading-none"><i class="fas fa-check-circle"></i></span>';
                    borderColorClasses = 'border-r-4 border-dashboard-accent-green';
                } else if (type === 'error') {
                    iconHtml = '<span class="text-dashboard-accent-red text-xl leading-none"><i class="fas fa-times-circle"></i></span>';
                    borderColorClasses = 'border-r-4 border-dashboard-accent-red';
                } else if (type === 'info') {
                    iconHtml = '<span class="text-dashboard-accent-blue text-xl leading-none"><i class="fas fa-info-circle"></i></span>';
                    borderColorClasses = 'border-r-4 border-dashboard-accent-blue';
                } else if (type === 'warning') { // Added warning type
                    iconHtml = '<span class="text-dashboard-accent-orange text-xl leading-none"><i class="fas fa-exclamation-triangle"></i></span>';
                    borderColorClasses = 'border-r-4 border-dashboard-accent-orange';
                }
                toast.classList.add(...borderColorClasses.split(' '));
                toast.innerHTML = `${iconHtml}<span class="flex-1 text-right">${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            },

            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('hidden', !isLoading);
                }
            },

            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            },

            populatePhoneSelect: (selectElement, phoneNumbers) => {
                selectElement.innerHTML = '<option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>';
                Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    selectElement.appendChild(option);
                });
            },

            showConfirmModal: (title, message) => { // Re-using from previous code for consistency
                return new Promise(resolve => {
                    const modalOverlay = document.createElement('div');
                    modalOverlay.classList.add('fixed', 'inset-0', 'bg-black', 'bg-opacity-50', 'flex', 'justify-center', 'items-center', 'z-50', 'opacity-0', 'transition-opacity', 'duration-300');
                    const modalDialog = document.createElement('div');
                    modalDialog.classList.add('bg-dashboard-card-bg', 'p-8', 'rounded-lg', 'shadow-2xl', 'text-center', 'max-w-md', 'mx-4', 'transform', 'scale-90', 'transition-transform', 'duration-300');
                    modalDialog.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4 text-dashboard-primary-blue">${title}</h3>
                        <p class="text-dashboard-text-secondary mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmYesBtn" class="vista-button bg-dashboard-accent-green text-white px-6 py-2 rounded-md hover:bg-green-600 transition-colors">Ù†Ø¹Ù…</button>
                            <button id="confirmNoBtn" class="vista-button bg-dashboard-accent-red text-white px-6 py-2 rounded-md hover:bg-red-600 transition-colors">Ù„Ø§</button>
                        </div>
                    `;
                    modalOverlay.appendChild(modalDialog);
                    document.body.appendChild(modalOverlay);
                    requestAnimationFrame(() => {
                        modalOverlay.classList.add('opacity-100');
                        modalDialog.classList.add('scale-100');
                    });
                    const cleanup = () => {
                        modalOverlay.classList.remove('opacity-100');
                        modalDialog.classList.remove('scale-100');
                        modalOverlay.addEventListener('transitionend', () => modalOverlay.remove(), { once: true });
                    };
                    document.getElementById('confirmYesBtn').addEventListener('click', () => {
                        cleanup();
                        resolve(true);
                    }, { once: true });
                    document.getElementById('confirmNoBtn').addEventListener('click', () => {
                        cleanup();
                        resolve(false);
                    }, { once: true });
                });
            }
        };

        // ====== Firebase Data & Statistics Logic (extracted) ======
        const FirebaseData = {
            init: () => {
                UIElements.commonSearchInput.addEventListener('input', FirebaseData.applyCombinedFilters);
                UIElements.clearCommonSearchInputButton.addEventListener('click', FirebaseData.clearAndFilter);
                UIElements.commonPhoneDropdown.addEventListener('change', FirebaseData.applyCombinedFilters);
                // NEW: Add event listeners for phone-specific action buttons
                UIElements.exportPhoneDataBtn.addEventListener('click', FirebaseData.exportSelectedPhoneData);
                UIElements.deletePhoneDataBtn.addEventListener('click', FirebaseData.deleteSelectedPhoneData);

                // Add click listeners for individual product/invoice delete buttons
                UIElements.firebaseProductsContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.delete-product-button');
                    if (target) {
                        const productDiv = target.closest('[data-product-id]');
                        const productId = productDiv.dataset.productId;
                        const firebasePhoneKey = productDiv.dataset.firebasePhoneKey;
                        FirebaseData.confirmAndDeleteProduct(productId, firebasePhoneKey);
                    }
                });

                UIElements.firebaseInvoicesContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.delete-invoice-button');
                    if (target) {
                        const invoiceDiv = target.closest('[data-invoice-id]');
                        const invoiceFirebaseId = invoiceDiv.dataset.invoiceId; // Use firebaseId here
                        const firebasePhoneKey = invoiceDiv.dataset.firebasePhoneKey;
                        FirebaseData.confirmAndDeleteInvoice(invoiceFirebaseId, firebasePhoneKey);
                    }
                });

                // Add click listeners for individual product/invoice edit buttons
                UIElements.firebaseProductsContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.edit-product-button');
                    if (target) {
                        const productDiv = target.closest('[data-product-id]');
                        const productId = productDiv.dataset.productId;
                        const firebasePhoneKey = productDiv.dataset.firebasePhoneKey;
                        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬. ID: ${productId}, PhoneKey: ${firebasePhoneKey}`); // Debugging line
                        const product = allFirebaseProductsData.find(p => p.id === productId && p.firebasePhoneKey === firebasePhoneKey);
                        if (product) {
                            console.log('Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', product); // Debugging line
                            populateProductModal(product);
                            openModal('addProductModal');
                        } else {
                            console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', productId, firebasePhoneKey); // Debugging line
                            UI.showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø©.", 'warning');
                        }
                    }
                });

                UIElements.firebaseInvoicesContainer.addEventListener('click', (event) => {
                    const target = event.target.closest('.edit-invoice-button');
                    if (target) {
                        const invoiceDiv = target.closest('[data-invoice-id]');
                        const invoiceFirebaseId = invoiceDiv.dataset.invoiceId;
                        const firebasePhoneKey = invoiceDiv.dataset.firebasePhoneKey;
                        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. Firebase ID: ${invoiceFirebaseId}, PhoneKey: ${firebasePhoneKey}`); // Debugging line
                        const invoice = allFirebaseInvoicesData.find(inv => inv.firebaseId === invoiceFirebaseId && inv.firebasePhoneKey === firebasePhoneKey);
                        if (invoice) {
                            console.log('Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', invoice); // Debugging line
                            populateInvoiceModal(invoice);
                            openModal('addInvoiceModal');
                        } else {
                            console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', invoiceFirebaseId, firebasePhoneKey); // Debugging line
                            UI.showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø©.", 'warning');
                        }
                    }
                });
            },

            populatePhoneDropdowns: (phoneNumbers) => {
                UI.populatePhoneSelect(UIElements.commonPhoneDropdown, phoneNumbers);
            },

            fetchAndDisplayCombinedFirebaseData: async () => {
                UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, true); // NEW loader

                if (!database) {
                    UI.showToast("Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", 'info');
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, false); // NEW loader
                    return;
                }

                const alldataRef = database.ref(`${appId}/alldata`);
                try {
                    const snapshot = await alldataRef.once('value');
                    const data = snapshot.val();

                    allFirebaseInvoicesData = [];
                    inventoryProductsMap.clear(); // Clear existing map data
                    allFirebaseProductsData = []; // Clear for re-population
                    allFirebaseInvoiceProductsWithDetails = [];
                    allFirebaseDuplicateProducts = []; // NEW: Clear duplicate products array

                    const uniquePhoneNumbers = new Set();
                    const productTracker = new Map(); // For duplicate product detection: Map<productName_supplierName_ownerPhone, count>

                    if (data) {
                        for (const phoneKey in data) {
                            if (data.hasOwnProperty(phoneKey)) {
                                uniquePhoneNumbers.add(phoneKey); // Add sanitized phone key
                                const phoneData = data[phoneKey];

                                // Process Inventory Products first for the map
                                if (phoneData.inventoryProducts) {
                                    for (const productId in phoneData.inventoryProducts) {
                                        if (phoneData.inventoryProducts.hasOwnProperty(productId)) {
                                            const productDetails = mapFromFirebaseKeys(phoneData.inventoryProducts[productId]);
                                            const fullProduct = {
                                                id: productId, // Use Firebase key for inventory product ID
                                                firebasePhoneKey: phoneKey, // Store sanitized phone key
                                                ...productDetails
                                            };
                                            inventoryProductsMap.set(productId, fullProduct);
                                            allFirebaseProductsData.push(fullProduct); // Add to general products list

                                            // Track for duplicates
                                            const productIdentifier = `${(productDetails.name || '').toLowerCase()}_${(productDetails.supplierName || '').toLowerCase()}_${phoneKey}`;
                                            productTracker.set(productIdentifier, (productTracker.get(productIdentifier) || 0) + 1);
                                        }
                                    }
                                }

                                // Process Invoices
                                if (phoneData.invoices) {
                                    for (const invoiceFirebaseKey in phoneData.invoices) {
                                        if (phoneData.invoices.hasOwnProperty(invoiceFirebaseKey)) {
                                            const invoiceDetails = mapFromFirebaseKeys(phoneData.invoices[invoiceFirebaseKey]);
                                            // Ensure a unique ID is present for the invoice itself, use Firebase key if local ID not set
                                            invoiceDetails.id = invoiceDetails.id || invoiceFirebaseKey; // This ID is for display/internal use, firebaseId is the actual key
                                            allFirebaseInvoicesData.push({
                                                firebaseId: invoiceFirebaseKey, // Original Firebase key (used for deletion/update)
                                                firebasePhoneKey: phoneKey, // Store sanitized phone key for filtering and deletion
                                                ...invoiceDetails
                                            });

                                            // Extract products from invoices with full details
                                            if (invoiceDetails.products && Array.isArray(invoiceDetails.products)) {
                                                invoiceDetails.products.forEach((product) => {
                                                    allFirebaseInvoiceProductsWithDetails.push({
                                                        id: product.id,
                                                        name: product.name,
                                                        sellingPrice: product.sellingPrice,
                                                        quantityUsed: product.quantityUsed,
                                                        invoiceId: invoiceDetails.id, // Original ID from invoice
                                                        invoiceDate: invoiceDetails.date,
                                                        customerName: invoiceDetails.customerName,
                                                        ownerName: invoiceDetails.ownerName,
                                                        ownerPhone: invoiceDetails.ownerPhone, // Actual owner phone from invoice data
                                                        firebasePhoneKey: phoneKey // Sanitized phone key from path
                                                    });
                                                });
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Identify duplicate products based on tracking
                    productTracker.forEach((count, identifier) => {
                        if (count > 1) {
                            // Find all products matching this identifier to add to duplicates list
                            const duplicateProducts = allFirebaseProductsData.filter(product => {
                                const productIdentifier = `${(product.name || '').toLowerCase()}_${(product.supplierName || '').toLowerCase()}_${product.firebasePhoneKey}`;
                                return productIdentifier === identifier;
                            });
                            allFirebaseDuplicateProducts.push(...duplicateProducts);
                        }
                    });

                    // Populate dropdown and datalists
                    FirebaseData.populatePhoneDropdowns(uniquePhoneNumbers);
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProductsData, 'name');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProductsData, 'supplierName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'customerName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'ownerName');
                    
                    // Add sanitized phone numbers to the datalist for search suggestions
                    Array.from(uniquePhoneNumbers).sort().forEach(phone => {
                        const option = document.createElement('option');
                        option.value = phone;
                        UIElements.allSearchOptionsDatalist.appendChild(option);
                    });

                    console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©:', allFirebaseProductsData); // Debugging line
                    console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©:', allFirebaseInvoicesData); // Debugging line

                    FirebaseData.applyCombinedFilters(); // Apply filters to display fetched data
                    UI.showToast("ØªÙ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­.", 'success');

                } catch (error) {
                    UI.showToast(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Firebase: ${error.message}`, 'error');
                    console.error("Failed to fetch Firebase data:", error);
                } finally {
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoiceProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseDuplicateProductsLoader, false); // NEW loader
                }
            },

            // NEW: Export data for selected phone number
            exportSelectedPhoneData: async () => {
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;
                if (selectedPhoneNumber === 'all' || !selectedPhoneNumber) {
                    UI.showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø­Ø¯Ø¯ Ù„ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.", 'warning');
                    return;
                }
                const confirmed = await UI.showConfirmModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµØ¯ÙŠØ±", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±) Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}ØŸ`);
                if (!confirmed) {
                    UI.showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ±.", 'info');
                    return;
                }
                UI.showToast(`Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}...`, 'info');
                try {
                    const phoneDataRef = database.ref(`${appId}/alldata/${selectedPhoneNumber}`);
                    const snapshot = await phoneDataRef.once('value');
                    const dataToExport = snapshot.val();

                    if (!dataToExport) {
                        UI.showToast(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber} ÙÙŠ Firebase.`, 'warning');
                        return;
                    }

                    // Map Firebase French keys to local keys for export compatibility with the first app
                    const mappedDataForExport = {};
                    if (dataToExport.inventoryProducts) {
                        mappedDataForExport.products = Object.values(dataToExport.inventoryProducts).map(mapFromFirebaseKeys);
                    } else {
                        mappedDataForExport.products = [];
                    }
                    if (dataToExport.invoices) {
                        mappedDataForExport.invoices = Object.values(dataToExport.invoices).map(mapFromFirebaseKeys);
                    } else {
                        mappedDataForExport.invoices = [];
                    }

                    const exportDate = new Date().toISOString();
                    const finalExportObject = {
                        metadata: {
                            exportedAt: exportDate,
                            appId: appId,
                            ownerPhone: selectedPhoneNumber,
                            description: `Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}`
                        },
                        ...mappedDataForExport
                    };
                    const dataStr = JSON.stringify(finalExportObject, null, 4);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_backup_${selectedPhoneNumber}_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    UI.showToast(`ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber} Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ù„Ù JSON.`, 'success');
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}: ${error.message}`, 'error');
                    console.error("Error exporting phone data:", error);
                }
            },

            // NEW: Delete data for selected phone number
            deleteSelectedPhoneData: async () => {
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;
                if (selectedPhoneNumber === 'all' || !selectedPhoneNumber) {
                    UI.showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø­Ø¯Ø¯ Ù„Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.", 'warning');
                    return;
                }
                const confirmed = await UI.showConfirmModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙƒÙ„ÙŠ", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±) Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber} Ù…Ù† FirebaseØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`);
                if (!confirmed) {
                    UI.showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.", 'info');
                    return;
                }
                UI.showToast(`Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}...`, 'info');
                try {
                    const phoneDataRef = database.ref(`${appId}/alldata/${selectedPhoneNumber}`);
                    await phoneDataRef.remove();
                    UI.showToast(`ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    // Re-fetch and display data to reflect changes
                    FirebaseData.fetchAndDisplayCombinedFirebaseData();
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ${selectedPhoneNumber}: ${error.message}`, 'error');
                    console.error("Error deleting phone data:", error);
                }
            },

            confirmAndDeleteProduct: async (productId, firebasePhoneKey) => {
                const confirmed = await UI.showConfirmModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ (ID: ${productId}) Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ${firebasePhoneKey}ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`);
                if (!confirmed) {
                    return;
                }
                UI.showToast("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬...", 'info');
                try {
                    const productRef = database.ref(`${appId}/alldata/${firebasePhoneKey}/inventoryProducts/${productId}`);
                    await productRef.remove();
                    UI.showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ${error.message}`, 'error');
                    console.error("Error deleting product:", error);
                }
            },

            confirmAndDeleteInvoice: async (invoiceFirebaseId, firebasePhoneKey) => {
                const confirmed = await UI.showConfirmModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ID: ${invoiceFirebaseId}) Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ${firebasePhoneKey}ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`);
                if (!confirmed) {
                    return;
                }
                UI.showToast("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©...", 'info');
                try {
                    const invoiceRef = database.ref(`${appId}/alldata/${firebasePhoneKey}/invoices/${invoiceFirebaseId}`);
                    await invoiceRef.remove();
                    UI.showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${error.message}`, 'error');
                    console.error("Error deleting invoice:", error);
                }
            },

            applyCombinedFilters: () => {
                const searchTerm = UIElements.commonSearchInput.value.toLowerCase();
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;

                // Toggle visibility of phone-specific action buttons
                if (selectedPhoneNumber !== 'all' && selectedPhoneNumber) {
                    UIElements.phoneActionsContainer.style.display = 'flex';
                } else {
                    UIElements.phoneActionsContainer.style.display = 'none';
                }

                // Filter Invoices
                const filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                    const matchesSearch = searchTerm ?
                        ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                            (invoice.products && invoice.products.some(p => 
                                (p.name || '').toLowerCase().includes(searchTerm) || 
                                (p.supplierName || '').toLowerCase().includes(searchTerm))))
                        : true;
                    const matchesPhone = (selectedPhoneNumber === 'all' || invoice.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesPhone;
                });

                // Filter Inventory Products
                const filteredProducts = allFirebaseProductsData.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierPhone && product.supplierPhone.includes(searchTerm)))
                        : true;
                    const matchesPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesPhone;
                });

                // Filter Invoice Products (sold items)
                const filteredInvoiceProducts = allFirebaseInvoiceProductsWithDetails.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.customerName || '').toLowerCase().includes(searchTerm) ||
                            (product.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (product.ownerPhone && product.ownerPhone.includes(searchTerm)))
                        : true;
                    const matchesPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesPhone;
                });

                // NEW: Filter Duplicate Products
                const filteredDuplicateProducts = allFirebaseDuplicateProducts.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierPhone && product.supplierPhone.includes(searchTerm)))
                        : true;
                    const matchesPhone = (selectedPhoneNumber === 'all' || product.firebasePhoneKey === selectedPhoneNumber);
                    return matchesSearch && matchesPhone;
                });

                // Update counts
                UIElements.firebaseInvoiceListCountSpan.textContent = filteredInvoices.length;
                UIElements.firebaseProductListCountSpan.textContent = filteredProducts.length;
                UIElements.firebaseInvoiceProductListCount.textContent = filteredInvoiceProducts.length;
                UIElements.firebaseDuplicateProductListCount.textContent = filteredDuplicateProducts.length; // NEW count

                // Sort and display
                filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                filteredInvoiceProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                filteredDuplicateProducts.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // NEW sort

                FirebaseData.displayFirebaseInvoices(filteredInvoices);
                FirebaseData.displayFirebaseProducts(filteredProducts);
                FirebaseData.displayFirebaseInvoiceProducts(filteredInvoiceProducts);
                FirebaseData.displayFirebaseDuplicateProducts(filteredDuplicateProducts); // NEW display function
                FirebaseData.displayStatistics(filteredInvoices); // Recalculate stats based on filtered invoices
            },

            clearAndFilter: () => {
                UIElements.commonSearchInput.value = '';
                UIElements.commonPhoneDropdown.value = 'all';
                FirebaseData.applyCombinedFilters();
                UI.showToast("ØªÙ… Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù….", 'info');
            },

            displayFirebaseInvoices: (invoices) => {
                const container = UIElements.firebaseInvoicesContainer;
                container.innerHTML = '';
                if (invoices.length === 0) {
                    container.innerHTML = '<p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
                    return;
                }
                invoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('aero-glass', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'cursor-pointer', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'hover:border-dashboard-accent-green');
                    invoiceDiv.dataset.invoiceId = invoice.firebaseId;
                    invoiceDiv.dataset.firebasePhoneKey = invoice.firebasePhoneKey;

                    let productsListHtml = '<p class="text-center italic text-dashboard-text-secondary text-xs py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="bg-dashboard-bg-primary p-2 rounded-md border border-dashboard-border-light mt-2 mb-2 text-xs custom-scrollbar overflow-y-auto max-h-32">
                                <div class="grid grid-cols-3 gap-1 p-1 bg-dashboard-primary-blue text-white font-bold rounded-sm text-right">
                                    <div>Ø§Ù„Ù…Ù†ØªØ¬</div>
                                    <div>Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                                    <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (HT)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="grid grid-cols-3 gap-1 p-1 bg-dashboard-card-bg border-b border-dashboard-border-light last:border-b-0 rounded-sm mt-1">
                                        <div class="text-dashboard-text-dark">${product.name || 'N/A'}</div>
                                        <div class="text-dashboard-text-secondary">${product.quantityUsed || 0}</div>
                                        <div class="text-dashboard-text-secondary">${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    invoiceDiv.innerHTML = `
                        <div class="mb-2">
                            <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${invoice.customerName || 'N/A'}</p>
                            <p class="text-dashboard-text-dark"><strong>Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p class="text-dashboard-text-dark"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${invoice.date || 'N/A'}</p>
                            <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${invoice.ownerPhone || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="border-t border-dashed border-dashboard-border-light pt-2 mt-2 text-right">
                            <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (TTC):</strong> <span class="text-dashboard-accent-green font-bold">${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</span></p>
                            <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø±Ø¨Ø­:</strong> <span class="text-dashboard-accent-green font-bold">${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</span></p>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="vista-button text-blue-600 hover:text-blue-800 edit-invoice-button">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="vista-button delete-button delete-invoice-button">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    `;
                    container.appendChild(invoiceDiv);
                });
            },

            displayFirebaseProducts: (products) => {
                const container = UIElements.firebaseProductsContainer;
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('aero-glass', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'hover:border-dashboard-accent-green');
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p class="text-dashboard-text-dark"><strong>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${product.supplierName || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${product.supplierPhone || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</strong> ${product.stockQuantity || 0}</p>
                        ${product.date ? `<p class="text-dashboard-text-dark"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</strong> ${product.date}</p>` : ''}
                        ${product.firebasePhoneKey ? `<p class="text-dashboard-text-dark"><strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙÙŠ Firebase):</strong> ${product.firebasePhoneKey}</p>` : ''}
                        <div class="flex justify-end gap-2 mt-4">
                            <button class="vista-button text-blue-600 hover:text-blue-800 edit-product-button">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="vista-button delete-button delete-product-button">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    `;
                    container.appendChild(productDiv);
                });
            },

            displayFirebaseInvoiceProducts: (products) => {
                const container = UIElements.firebaseInvoiceProductsContainer;
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('aero-glass', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'hover:border-dashboard-accent-orange');
                    // No delete button here, as these are part of invoices
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.invoiceId = product.invoiceId;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©:</strong> ${product.quantityUsed || 0}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${product.customerName || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${product.ownerName || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${product.invoiceDate || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙÙŠ Firebase):</strong> ${product.ownerPhone || product.firebasePhoneKey || 'N/A'}</p>
                    `;
                    container.appendChild(productDiv);
                });
            },

            // NEW: Display duplicate products
            displayFirebaseDuplicateProducts: (products) => {
                const container = UIElements.firebaseDuplicateProductsContainer;
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-dashboard-text-secondary text-center py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªÙƒØ±Ø±Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('aero-glass', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'flex', 'flex-col', 'justify-between', 'items-stretch', 'text-right', 'text-sm', 'leading-relaxed', 'hover:translate-y-[-8px]', 'hover:shadow-lg', 'hover:border-dashboard-accent-red');
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${product.name || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p class="text-dashboard-text-dark"><strong>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${product.supplierName || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${product.supplierPhone || 'N/A'}</p>
                        <p class="text-dashboard-text-dark"><strong>Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</strong> ${product.stockQuantity || 0}</p>
                        ${product.date ? `<p class="text-dashboard-text-dark"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</strong> ${product.date}</p>` : ''}
                        <p class="text-dashboard-text-dark"><strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${product.firebasePhoneKey || 'N/A'}</p>
                        <button class="vista-button delete-button delete-product-button mt-4">
                            ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬
                        </button>
                    `;
                    container.appendChild(productDiv);
                });
            },

            displayStatistics: (invoices) => {
                let totalSalesHT = 0;
                let totalTVA = 0;
                let totalSalesTTC = 0;
                let totalOverallProfit = 0;
                let totalOverallCommission = 0;
                let totalPurchaseCostAllProducts = 0;
                let totalSellingPriceAllProducts = 0;

                const productSales = {}; // { productName: { quantitySold, totalRevenue } }
                const customerActivity = {}; // { customerName: { invoiceCount, totalProfit, totalTTC } }
                const invoiceOwnerActivity = {}; // { ownerName: { invoiceCount, totalProfit, totalTTC } }
                const supplierActivity = {}; // { supplierName: { totalPurchaseCost, productsCount } }

                invoices.forEach(invoice => {
                    totalSalesHT += parseFloat(invoice.totalHT || 0);
                    totalTVA += parseFloat(invoice.tva || 0);
                    totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                    totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                    totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                    if (invoice.products) {
                        invoice.products.forEach(invoiceProduct => {
                            const productName = invoiceProduct.name || 'N/A';
                            const quantityUsed = parseInt(invoiceProduct.quantityUsed || 0);
                            const sellingPrice = parseFloat(invoiceProduct.sellingPrice || 0);
                            
                            // Get original product data from inventoryProductsMap to access purchasePrice and supplierName
                            const originalProduct = inventoryProductsMap.get(String(invoiceProduct.id)); 
                            const purchasePrice = parseFloat(originalProduct ? originalProduct.purchasePrice || 0 : 0);
                            const supplierName = (originalProduct ? originalProduct.supplierName : 'Ù…ÙˆØ±Ø¯ ØºÙŠØ± Ù…Ø­Ø¯Ø¯');

                            totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                            totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                            // Update product sales
                            productSales[productName] = (productSales[productName] || { quantitySold: 0, totalRevenue: 0 });
                            productSales[productName].quantitySold += quantityUsed;
                            productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                            // Update supplier activity
                            supplierActivity[supplierName] = (supplierActivity[supplierName] || { totalPurchaseCost: 0, productsCount: 0 });
                            supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                            supplierActivity[supplierName].productsCount += quantityUsed;
                        });
                    }

                    const customer = invoice.customerName || 'N/A';
                    const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                    const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                    const owner = invoice.ownerName || 'N/A';

                    // Update customer activity
                    customerActivity[customer] = (customerActivity[customer] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    customerActivity[customer].invoiceCount += 1;
                    customerActivity[customer].totalProfit += invoiceProfit;
                    customerActivity[customer].totalTTC += invoiceTTC;

                    // Update invoice owner activity
                    invoiceOwnerActivity[owner] = (invoiceOwnerActivity[owner] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    invoiceOwnerActivity[owner].invoiceCount += 1;
                    invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                    invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
                });

                // Update main statistics display
                UIElements.totalPurchaseCost.textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
                UIElements.totalSellingPrice.textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
                UIElements.totalCommission.textContent = `${totalOverallCommission.toFixed(2)} DH`;
                UIElements.totalProfit.textContent = `${totalOverallProfit.toFixed(2)} DH`;
                UIElements.totalSalesHT.textContent = `${totalSalesHT.toFixed(2)} DH`;
                UIElements.totalTVA.textContent = `${totalTVA.toFixed(2)} DH`;
                UIElements.totalSalesTTC.textContent = `${totalSalesTTC.toFixed(2)} DH`;

                // Prepare data for dynamic lists
                const topSellingProductsData = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 10).map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue }));
                const topCustomersData = Object.entries(customerActivity).sort(([, a], [, b]) => b.totalTTC - a.totalTTC).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC }));
                const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity).sort(([, a], [, b]) => b.totalProfit - a.totalProfit).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit }));
                const topSuppliersData = Object.entries(supplierActivity)
                    .sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost)
                    .slice(0, 10)
                    .map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount }));

                // Render dynamic lists
                FirebaseData.renderSimpleList(UIElements.topSellingProductsList, topSellingProductsData, (item) => item.name, (item) => `Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.value} ÙˆØ­Ø¯Ø© - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.secondaryValue.toFixed(2)} Ø¯.Ù….`, 'fas fa-box-open');
                FirebaseData.renderSimpleList(UIElements.topCustomersList, topCustomersData, (item) => item.name, (item) => `ÙÙˆØ§ØªÙŠØ±: ${item.value} - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.secondaryValue.toFixed(2)} Ø¯.Ù….`, 'fas fa-user-friends');
                FirebaseData.renderSimpleList(UIElements.topInvoiceOwnersList, topInvoiceOwnersData, (item) => item.name, (item) => `ÙÙˆØ§ØªÙŠØ±: ${item.value} - Ø§Ù„Ø±Ø¨Ø­: ${item.secondaryValue.toFixed(2)} Ø¯.Ù….`, 'fas fa-file-invoice-dollar');
                FirebaseData.renderSimpleList(
                    UIElements.topSuppliersList,
                    topSuppliersData,
                    (item) => item.name,
                    (item) => `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${item.value.toFixed(2)} Ø¯.Ù…. - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${item.secondaryValue}`,
                    'fas fa-truck'
                );

                // Charts are removed, so no need to call initializeCharts
            },

            renderSimpleList: (listEl, data, primaryTextFn, secondaryTextFn, iconClass = 'fas fa-circle') => {
                listEl.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.classList.add(
                            'aero-glass', 'p-3', 'rounded-lg', 'border', 'border-dashboard-border-light', 'shadow-sm',
                            'flex', 'items-center', 'gap-3', 'w-full', 'text-right', 'cursor-pointer',
                            'hover:bg-dashboard-hover-bg', 'hover:shadow-md', 'hover:translate-y-[-1px]',
                            'transition-all', 'duration-200'
                        );
                        li.innerHTML = `
                            <div class="flex-shrink-0 text-dashboard-accent-blue text-xl">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-grow flex flex-col items-end">
                                <span class="font-bold text-dashboard-primary-blue text-base mb-1">${primaryTextFn(item)}</span>
                                <span class="text-dashboard-text-secondary text-sm">${secondaryTextFn(item)}</span>
                            </div>
                        `;
                        li.dataset.searchTerm = primaryTextFn(item);
                        li.addEventListener('click', () => {
                            UIElements.commonSearchInput.value = li.dataset.searchTerm;
                            FirebaseData.applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                    listEl.classList.toggle('has-more-items', listEl.children.length > 3);
                } else {
                    listEl.innerHTML = '<li class="text-dashboard-text-secondary text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>';
                    listEl.classList.remove('has-more-items');
                }
            },

            // Firebase Save/Update functions for modals
            saveProduct: async (productData, productId, firebasePhoneKey) => {
                const sanitizedPhone = sanitizePhoneNumber(productData.supplierPhone);
                // If productId is provided, it's an update. Otherwise, it's a new push.
                const productRef = database.ref(`${appId}/alldata/${sanitizedPhone}/inventoryProducts/${productId || ''}`);

                try {
                    if (productId) { // Update existing product
                        await productRef.update(mapToFirebaseKeys(productData));
                        UI.showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    } else { // Add new product
                        const newProductRef = productRef.push(); // Generate new unique ID
                        await newProductRef.set(mapToFirebaseKeys(productData));
                        UI.showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    }
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬: ${error.message}`, 'error');
                    console.error("Error saving product:", error);
                }
            },

            saveInvoice: async (invoiceData, invoiceFirebaseId, firebasePhoneKey) => {
                const sanitizedPhone = sanitizePhoneNumber(invoiceData.ownerPhone);
                // If invoiceFirebaseId is provided, it's an update. Otherwise, it's a new push.
                const invoiceRef = database.ref(`${appId}/alldata/${sanitizedPhone}/invoices/${invoiceFirebaseId || ''}`);

                try {
                    if (invoiceFirebaseId) { // Update existing invoice
                        await invoiceRef.update(mapToFirebaseKeys(invoiceData));
                        UI.showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    } else { // Add new invoice
                        const newInvoiceRef = invoiceRef.push(); // Generate new unique ID
                        await newInvoiceRef.set(mapToFirebaseKeys(invoiceData));
                        UI.showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    }
                    FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Re-fetch all data
                } catch (error) {
                    UI.showToast(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${error.message}`, 'error');
                    console.error("Error saving invoice:", error);
                }
            }
        };

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('open');
            // Reset form when opening for new entry
            if (modalId === 'addProductModal') {
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                document.getElementById('productFirebasePhoneKey').value = '';
            } else if (modalId === 'addInvoiceModal') {
                document.getElementById('invoiceForm').reset();
                document.getElementById('invoiceId').value = '';
                document.getElementById('invoiceFirebasePhoneKey').value = '';
                currentInvoiceProducts = []; // Clear products for new invoice
                renderInvoiceProducts();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }

        // Populate Product Modal for editing
        function populateProductModal(product) {
            document.getElementById('productId').value = product.id;
            document.getElementById('productFirebasePhoneKey').value = product.firebasePhoneKey;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productPurchasePrice').value = product.purchasePrice || 0;
            document.getElementById('productSellingPrice').value = product.sellingPrice || 0;
            document.getElementById('productSupplierName').value = product.supplierName || '';
            document.getElementById('productSupplierAddress').value = product.supplierAddress || '';
            document.getElementById('productSupplierPhone').value = product.supplierPhone || '';
            document.getElementById('productStockQuantity').value = product.stockQuantity || 0;
        }

        // Handle Product Form Submission
        async function handleProductFormSubmit() {
            const productId = document.getElementById('productId').value;
            const productFirebasePhoneKey = document.getElementById('productFirebasePhoneKey').value; // This is the original phone key from Firebase path
            const productData = {
                name: document.getElementById('productName').value,
                purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value),
                sellingPrice: parseFloat(document.getElementById('productSellingPrice').value),
                supplierName: document.getElementById('productSupplierName').value,
                supplierAddress: document.getElementById('productSupplierAddress').value,
                supplierPhone: document.getElementById('productSupplierPhone').value, // This is the new/updated phone number for the product
                stockQuantity: parseInt(document.getElementById('productStockQuantity').value),
                date: new Date().toISOString().slice(0, 10) // Current date
            };

            // If it's an update and the phone number has changed, we need to delete the old record
            // and create a new one under the new phone number.
            const newSanitizedPhone = sanitizePhoneNumber(productData.supplierPhone);
            let finalProductId = productId; // Keep the same ID if phone key doesn't change or if it's a new product

            if (productId && productFirebasePhoneKey && newSanitizedPhone !== productFirebasePhoneKey) {
                // Phone number changed for an existing product, delete old record first
                const confirmed = await UI.showConfirmModal("ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", `Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬. Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (${productFirebasePhoneKey}) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡ ØªØ­Øª Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${newSanitizedPhone}). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`);
                if (confirmed) {
                    try {
                        const oldProductRef = database.ref(`${appId}/alldata/${productFirebasePhoneKey}/inventoryProducts/${productId}`);
                        await oldProductRef.remove();
                        UI.showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.", 'info');
                        finalProductId = null; // Treat as a new product for the new phone key
                    } catch (error) {
                        UI.showToast(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…: ${error.message}`, 'error');
                        console.error("Error deleting old product record:", error);
                        return; // Stop if deletion fails
                    }
                } else {
                    UI.showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«.", 'info');
                    return;
                }
            }

            await FirebaseData.saveProduct(productData, finalProductId, productFirebasePhoneKey);
            closeModal('addProductModal');
        }

        // Populate Invoice Modal for editing
        function populateInvoiceModal(invoice) {
            document.getElementById('invoiceId').value = invoice.firebaseId; // Use firebaseId for actual Firebase key
            document.getElementById('invoiceFirebasePhoneKey').value = invoice.firebasePhoneKey; // Original phone key from Firebase path
            document.getElementById('invoiceCustomerName').value = invoice.customerName || '';
            document.getElementById('invoiceOwnerName').value = invoice.ownerName || '';
            document.getElementById('invoiceOwnerAddress').value = invoice.ownerAddress || '';
            document.getElementById('invoiceOwnerPhone').value = invoice.ownerPhone || '';
            document.getElementById('invoiceDate').value = invoice.date || new Date().toISOString().slice(0, 10);
            document.getElementById('invoiceCommissionRate').value = invoice.invoiceCommissionRate || 0;
            // Deep copy the products array from the invoice to currentInvoiceProducts
            currentInvoiceProducts = invoice.products ? JSON.parse(JSON.stringify(invoice.products)) : [];
            renderInvoiceProducts();
        }

        // Handle Invoice Form Submission
        async function handleInvoiceFormSubmit() {
            const invoiceFirebaseId = document.getElementById('invoiceId').value;
            const invoiceFirebasePhoneKey = document.getElementById('invoiceFirebasePhoneKey').value; // Original phone key from Firebase path

            const invoiceData = {
                customerName: document.getElementById('invoiceCustomerName').value,
                ownerName: document.getElementById('invoiceOwnerName').value,
                ownerAddress: document.getElementById('invoiceOwnerAddress').value,
                ownerPhone: document.getElementById('invoiceOwnerPhone').value, // This is the new/updated phone number for the invoice owner
                date: document.getElementById('invoiceDate').value,
                isoDate: new Date(document.getElementById('invoiceDate').value).toISOString(),
                invoiceCommissionRate: parseFloat(document.getElementById('invoiceCommissionRate').value),
                products: currentInvoiceProducts // Use the dynamically managed products
            };

            // Calculate totals (simplified for this example, adjust as per your app's logic)
            let totalHT = 0;
            let totalProfit = 0;
            let totalCommission = 0;
            invoiceData.products.forEach(p => {
                const productTotal = (parseFloat(p.sellingPrice || 0) * parseInt(p.quantityUsed || 0));
                totalHT += productTotal;
                
                // Find original purchase price from inventoryProductsMap
                const originalProduct = inventoryProductsMap.get(String(p.id));
                const purchasePrice = parseFloat(originalProduct ? originalProduct.purchasePrice || 0 : 0);
                
                const productProfit = (productTotal - (purchasePrice * parseInt(p.quantityUsed || 0)));
                totalProfit += productProfit;
            });

            invoiceData.totalHT = totalHT;
            invoiceData.totalHTBeforeCommission = totalHT; // Assuming no pre-commission calculation here
            invoiceData.tva = totalHT * 0.20; // Example TVA 20%
            invoiceData.totalTTC = totalHT + invoiceData.tva;
            invoiceData.totalProfit = totalProfit;
            invoiceData.totalCommission = totalHT * (invoiceData.invoiceCommissionRate / 100);

            // If it's an update and the phone number has changed, we need to delete the old record
            // and create a new one under the new phone number.
            const newSanitizedPhone = sanitizePhoneNumber(invoiceData.ownerPhone);
            let finalInvoiceFirebaseId = invoiceFirebaseId; // Keep the same ID if phone key doesn't change or if it's a new invoice

            if (invoiceFirebaseId && invoiceFirebasePhoneKey && newSanitizedPhone !== invoiceFirebasePhoneKey) {
                // Phone number changed for an existing invoice, delete old record first
                const confirmed = await UI.showConfirmModal("ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", `Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø§Ù„Ùƒ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (${invoiceFirebasePhoneKey}) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ ØªØ­Øª Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${newSanitizedPhone}). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`);
                if (confirmed) {
                    try {
                        const oldInvoiceRef = database.ref(`${appId}/alldata/${invoiceFirebasePhoneKey}/invoices/${invoiceFirebaseId}`);
                        await oldInvoiceRef.remove();
                        UI.showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.", 'info');
                        finalInvoiceFirebaseId = null; // Treat as a new invoice for the new phone key
                    } catch (error) {
                        UI.showToast(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…: ${error.message}`, 'error');
                        console.error("Error deleting old invoice record:", error);
                        return; // Stop if deletion fails
                    }
                } else {
                    UI.showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«.", 'info');
                    return;
                }
            }

            await FirebaseData.saveInvoice(invoiceData, finalInvoiceFirebaseId, invoiceFirebasePhoneKey);
            closeModal('addInvoiceModal');
        }

        // Invoice Product Management in Modal
        function addInvoiceProductRow() {
            currentInvoiceProducts.push({
                id: '', // Will be populated from selected product
                name: '',
                quantityUsed: 1,
                sellingPrice: 0
            });
            renderInvoiceProducts();
        }

        function removeInvoiceProductRow(index) {
            currentInvoiceProducts.splice(index, 1);
            renderInvoiceProducts();
        }

        function renderInvoiceProducts() {
            const container = document.getElementById('invoiceProductsContainer');
            container.innerHTML = '';
            if (currentInvoiceProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</p>';
                return;
            }

            currentInvoiceProducts.forEach((product, index) => {
                const productRow = document.createElement('div');
                productRow.classList.add('flex', 'flex-col', 'md:flex-row', 'items-center', 'gap-3', 'p-3', 'border', 'border-gray-200', 'rounded-lg', 'bg-white', 'shadow-sm');
                productRow.innerHTML = `
                    <select class="flex-grow w-full md:w-auto p-2 border rounded-md product-select" data-index="${index}" required>
                        <option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬</option>
                        ${allFirebaseProductsData.map(p => `
                            <option value="${p.id}" ${product.id === p.id ? 'selected' : ''}>
                                ${p.name} (Ù…Ø®Ø²ÙˆÙ†: ${p.stockQuantity})
                            </option>
                        `).join('')}
                    </select>
                    <input type="number" class="w-full md:w-24 p-2 border rounded-md quantity-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="${product.quantityUsed}" min="1" data-index="${index}" required>
                    <input type="number" class="w-full md:w-32 p-2 border rounded-md selling-price-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" value="${product.sellingPrice}" step="0.01" data-index="${index}" required>
                    <button type="button" class="vista-button delete-button flex-shrink-0" onclick="removeInvoiceProductRow(${index})">
                        ğŸ—‘ï¸
                    </button>
                `;
                container.appendChild(productRow);
            });

            // Add event listeners for product selection and quantity change
            container.querySelectorAll('.product-select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    const selectedProductId = event.target.value;
                    const selectedProduct = allFirebaseProductsData.find(p => p.id === selectedProductId);
                    if (selectedProduct) {
                        currentInvoiceProducts[index].id = selectedProduct.id;
                        currentInvoiceProducts[index].name = selectedProduct.name;
                        currentInvoiceProducts[index].sellingPrice = selectedProduct.sellingPrice;
                        // Update the selling price input field in the UI
                        event.target.closest('.flex').querySelector('.selling-price-input').value = selectedProduct.sellingPrice;
                    } else {
                        // If product is not found (e.g., deleted from inventory), clear values
                        currentInvoiceProducts[index].id = '';
                        currentInvoiceProducts[index].name = '';
                        currentInvoiceProducts[index].sellingPrice = 0;
                        event.target.closest('.flex').querySelector('.selling-price-input').value = 0;
                    }
                });
            });

            container.querySelectorAll('.quantity-input, .selling-price-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    if (event.target.classList.contains('quantity-input')) {
                        currentInvoiceProducts[index].quantityUsed = parseInt(event.target.value) || 0;
                    } else if (event.target.classList.contains('selling-price-input')) {
                        currentInvoiceProducts[index].sellingPrice = parseFloat(event.target.value) || 0;
                    }
                });
            });
        }


        // ====== Initialization on Window Load for this section ======
        window.addEventListener('load', () => {
            // Initialize UIElements after DOM is loaded
            UIElements = {
                firebaseProductsDisplay: document.getElementById('firebaseProductsDisplay'), // This is now the main content wrapper
                commonPhoneDropdown: document.getElementById('commonPhoneDropdown'),
                commonSearchInput: document.getElementById('commonSearchInput'),
                clearCommonSearchInputButton: document.getElementById('clearCommonSearchInput'),
                allSearchOptionsDatalist: document.getElementById('allSearchOptions'),
                firebaseProductListCountSpan: document.getElementById('firebaseProductListCount'),
                firebaseInvoiceListCountSpan: document.getElementById('firebaseInvoiceListCount'),
                firebaseInvoiceProductListCount: document.getElementById('firebaseInvoiceProductListCount'),
                firebaseDuplicateProductListCount: document.getElementById('firebaseDuplicateProductListCount'), // NEW span for duplicate count
                firebaseProductsContainer: document.getElementById('firebaseProductsContainer'),
                firebaseInvoicesContainer: document.getElementById('firebaseInvoicesContainer'),
                firebaseInvoiceProductsContainer: document.getElementById('firebaseInvoiceProductsContainer'),
                firebaseDuplicateProductsContainer: document.getElementById('firebaseDuplicateProductsContainer'), // NEW container for duplicates
                
                // Corrected loader IDs as per HTML
                firebaseProductsLoader: document.getElementById('firebaseProductsLoader'),
                firebaseInvoicesLoader: document.getElementById('firebaseInvoicesLoader'),
                firebaseInvoiceProductsLoader: document.getElementById('firebaseInvoiceProductsLoader'),
                firebaseDuplicateProductsLoader: document.getElementById('firebaseDuplicateProductsLoader'), // NEW loader for duplicates

                totalPurchaseCost: document.getElementById('totalPurchaseCost'),
                totalSellingPrice: document.getElementById('totalSellingPrice'),
                totalCommission: document.getElementById('totalCommission'),
                totalProfit: document.getElementById('totalProfit'),
                totalSalesHT: document.getElementById('totalSalesHT'),
                totalTVA: document.getElementById('totalTVA'),
                totalSalesTTC: document.getElementById('totalSalesTTC'),
                dynamicStatsListContainer: document.getElementById('dynamicStatsListContainer'),
                topSellingProductsList: document.getElementById('topSellingProductsList'),
                topCustomersList: document.getElementById('topCustomersList'),
                topInvoiceOwnersList: document.getElementById('topInvoiceOwnersList'),
                topSuppliersList: document.getElementById('topSuppliersList'),
                toastContainer: document.getElementById('toast-container-firebase'),
                
                // NEW: Phone-specific action buttons and their container
                phoneActionsContainer: document.getElementById('phoneActions'),
                exportPhoneDataBtn: document.getElementById('exportPhoneDataBtn'),
                deletePhoneDataBtn: document.getElementById('deletePhoneDataBtn')
            };

            FirebaseData.init();
            FirebaseData.fetchAndDisplayCombinedFirebaseData();
        });
    </script>
</body>
</html>
