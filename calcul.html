<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة كهربائية متكاملة - الإصدار المحسن</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --main-color: #004e92;
            --accent-color: #000428;
            --background: #f1f4f9;
            --white: #ffffff;
            --border-radius: 12px;
            --error-color: #e63946;
            --success-color: #2a9d8f;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            direction: rtl;
            text-align: right;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin: 0;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--main-color);
            width: 100%;
            flex-shrink: 0;
        }

        .header h1 {
            color: var(--main-color);
            margin-bottom: 10px;
        }

        .section {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            flex-basis: calc(33.33% - 13.33px); /* 3 أعمدة مع حساب الفجوة */
            max-width: calc(33.33% - 13.33px);
            margin-bottom: 0;
        }
        
        h2 {
            background: linear-gradient(to left, var(--main-color), var(--accent-color));
            color: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%; /* لملء المساحة المخصصة في .section */
            height: 180px; /* ارتفاع ثابت لجعل الأزرار مربعة */
            box-sizing: border-box;
            font-size: 1.1em;
            font-weight: 600;
        }

        h2 .icon {
            font-size: 2.5em;
            margin-bottom: 5px;
            line-height: 1;
        }

        h2 .text {
            font-size: 0.85em;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        h2:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: slideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            left: 15px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .calculator {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 10px;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            border: none;
            animation: none;
        }

        .calculator-description {
            background-color: #e7f3ff;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 0.9em;
            border-right: 3px solid var(--main-color);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--main-color);
        }

        .calculator input,
        .calculator select,
        .calculator button {
            padding: 12px;
            font-size: 1em;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            transition: all 0.2s ease;
            text-align: right;
        }

        .calculator input:focus,
        .calculator select:focus {
            border-color: var(--main-color);
            box-shadow: 0 0 0 2px rgba(0, 78, 146, 0.2);
            outline: none;
        }

        .calculator input.error {
            border-color: var(--error-color);
        }

        button {
            background-color: var(--main-color);
            color: var(--white);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: var(--border-radius);
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
            font-size: 1.1em;
            border-left: 4px solid var(--main-color);
        }

        .result ul {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .result ul li {
            margin-bottom: 8px;
            padding-right: 15px;
            position: relative;
            font-weight: normal;
            font-size: 0.95em;
        }

        .result ul li::before {
            content: "•";
            color: var(--main-color);
            position: absolute;
            right: 0;
            top: 0;
            font-size: 1.2em;
            line-height: 1.4;
        }

        .result.success {
            background-color: #e8f8f6;
            border-left-color: var(--success-color);
        }

        .result.error {
            background-color: #fee8e9;
            border-left-color: var(--error-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>⚡ الحاسبة الكهربائية المتكاملة</h1>
            <p>أداة متكاملة لحل جميع حساباتك الكهربائية والهندسية</p>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-percentage-calculator">
                <span class="icon">📊</span>
                <span class="text">حساب النسبة المئوية</span>
            </h2>
            <div id="modal-percentage-calculator" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>📊 حساب النسبة المئوية</h2>
                    <div class="calculator" id="percentage-calculator">
                        <div class="calculator-description">
                            حساب النسبة المئوية لقيمة معينة من عدد أصلي.
                        </div>
                        <div class="input-group">
                            <label for="original-number">العدد الأصلي</label>
                            <input type="number" id="original-number" placeholder="أدخل العدد الأصلي" min="0">
                        </div>
                        <div class="input-group">
                            <label for="percentage-value">النسبة المئوية المطلوبة (%)</label>
                            <input type="number" id="percentage-value" placeholder="أدخل النسبة المئوية" min="0" max="100">
                        </div>
                        <button id="calculate-percentage-btn">احسب الناتج</button>
                        <div class="result" id="percentage-result">الناتج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-unit-converter">
                <span class="icon">🔌</span>
                <span class="text">محول الوحدات الكهربائية</span>
            </h2>
            <div id="modal-unit-converter" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>🔌 محول الوحدات الكهربائية</h2>
                    <div class="calculator" id="unit-converter">
                        <div class="calculator-description">
                            أدخل قيمة بوحدة معينة (كيلوواط، كيلو فولت أمبير، حصان، أو أمبير) مع الجهد، الطور، ومعامل
                            القدرة، وسنقوم بتحويلها إلى الوحدات الأخرى.
                        </div>
                        <div class="input-group">
                            <label for="uc-voltage">الجهد (V)</label>
                            <input type="number" id="uc-voltage" placeholder="مثال: 230 أو 400" min="1">
                        </div>
                        <div class="input-group">
                            <label for="uc-phase">الطور</label>
                            <select id="uc-phase">
                                <option value="single">أحادي الطور</option>
                                <option value="three">ثلاثي الطور</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="uc-power-factor">معامل القدرة (cos φ)</label>
                            <input type="number" id="uc-power-factor" value="0.8" step="0.01" min="0.1" max="1"
                                placeholder="مثال: 0.8">
                        </div>
                        <div class="input-group">
                            <label for="uc-input-value">القيمة المدخلة</label>
                            <input type="number" id="uc-input-value" placeholder="أدخل القيمة" min="0">
                        </div>
                        <div class="input-group">
                            <label for="uc-input-unit">وحدة القيمة المدخلة</label>
                            <select id="uc-input-unit">
                                <option value="kw">كيلوواط (kW)</option>
                                <option value="kva">كيلو فولت أمبير (kVA)</option>
                                <option value="hp">حصان (HP)</option>
                                <option value="amp">أمبير (Amp)</option>
                            </select>
                        </div>
                        <button id="convert-unit-btn">تحويل</button>
                        <div class="result" id="uc-result">
                            <p>النتائج: ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-solar-panels">
                <span class="icon">☀️</span>
                <span class="text">حساب عدد الألواح الشمسية لمضخة</span>
            </h2>
            <div id="modal-solar-panels" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>☀️ حساب عدد الألواح الشمسية لمضخة</h2>
                    <div class="calculator" id="solar-panels-calculator">
                        <div class="calculator-description">
                            حساب عدد الألواح الشمسية المطلوبة لتشغيل مضخة بناءً على قدرتها بالكيلوواط، مع الأخذ في الاعتبار جهد و طور المضخة (للمعلومات)، و معامل أداء الألواح وكفاءة المحول.
                        </div>
                        <div class="input-group">
                            <label for="pump-voltage">جهد المضخة (V)</label>
                            <input type="number" id="pump-voltage" placeholder="جهد المضخة بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="pump-power-kw">قدرة المضخة (kW)</label>
                            <input type="number" id="pump-power-kw" placeholder="أدخل قدرة المضخة بالكيلوواط" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="pump-phase">طور المضخة</label>
                            <select id="pump-phase">
                                <option value="single">أحادي الطور</option>
                                <option value="three">ثلاثي الطور</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="pump-power-factor">معامل قدرة المضخة (cos φ)</label>
                            <input type="number" id="pump-power-factor" value="0.8" step="0.01" min="0.1" max="1" placeholder="مثال: 0.8">
                        </div>
                        <div class="input-group">
                            <label for="panel-voltage">جهد اللوح الشمسي (Vmp)</label>
                            <input type="number" id="panel-voltage" placeholder="جهد اللوح بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="panel-current">تيار اللوح الشمسي (Imp)</label>
                            <input type="number" id="panel-current" placeholder="تيار اللوح بالأمبير" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="solar-performance-factor">عامل أداء الألواح (%)</label>
                            <input type="number" id="solar-performance-factor" value="80" min="50" max="100" step="1"
                                placeholder="مثال: 80 (80%)">
                        </div>
                        <div class="input-group">
                            <label for="inverter-efficiency">كفاءة المحول (Inverter Efficiency %)</label>
                            <input type="number" id="inverter-efficiency" value="90" min="50" max="100" step="1"
                                placeholder="مثال: 90 (90%)">
                        </div>
                        <div class="input-group">
                            <label for="ideal-series-voltage">التوتر المثالي للألواح على التوالي (V)</label>
                            <input type="number" id="ideal-series-voltage" placeholder="مثال: 300V" min="1">
                        </div>
                        <button id="calculate-solar-panels-btn">احسب الألواح</button>
                        <div class="result" id="solar-panels-result">النتائج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-pulley-calculator">
                <span class="icon">⚙️</span>
                <span class="text">حساب سرعة أو قطر البكرة</span>
            </h2>
            <div id="modal-pulley-calculator" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>⚙️ حساب سرعة أو قطر البكرة</h2>
                    <div class="calculator" id="pulley-calculator">
                        <div class="calculator-description">
                            احسب السرعة أو القطر المجهول للبكرة بناءً على ثلاثة قيم معلومة.
                        </div>
                        <div class="input-group">
                            <label for="pulley-d1">قطر البكرة الأولى (مم)</label>
                            <input type="number" id="pulley-d1" placeholder="قطر البكرة الأولى (اتركه فارغاً إذا كان مجهولاً)"
                                min="0">
                        </div>
                        <div class="input-group">
                            <label for="pulley-rpm1">سرعة البكرة الأولى (RPM)</label>
                            <input type="number" id="pulley-rpm1" placeholder="سرعة البكرة الأولى (اتركه فارغاً إذا كان مجهولاً)"
                                min="0">
                        </div>
                        <div class="input-group">
                            <label for="pulley-d2">قطر البكرة الثانية (مم)</label>
                            <input type="number" id="pulley-d2" placeholder="قطر البكرة الثانية (اتركه فارغاً إذا كان مجهولاً)"
                                min="0">
                        </div>
                        <div class="input-group">
                            <label for="pulley-rpm2">سرعة البكرة الثانية (RPM)</label>
                            <input type="number" id="pulley-rpm2" placeholder="سرعة البكرة الثانية (اتركه فارغاً إذا كان مجهولاً)"
                                min="0">
                        </div>
                        <button id="calculate-pulley-btn">احسب المجهول</button>
                        <div class="result" id="pulley-result">النتائج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-battery-calculator">
                <span class="icon">🔋</span>
                <span class="text">حاسبة سعة البطارية</span>
            </h2>
            <div id="modal-battery-calculator" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>🔋 حاسبة سعة البطارية</h2>
                    <div class="calculator" id="battery-calculator">
                        <div class="calculator-description">
                            حساب سعة البطارية المطلوبة بالأمبير-ساعة بناءً على متطلبات الجهاز وجهد البطارية، مع مراعاة
                            عمق التفريغ وكفاءة البطارية، ونوع الجهاز (DC/AC)، وطوره ومعامل قدرته وكفاءة المحول (لأحمال
                            التيار المتردد).
                        </div>
                        <div class="input-group">
                            <label for="battery-device-type">نوع الجهاز</label>
                            <select id="battery-device-type">
                                <option value="dc">تيار مستمر (DC)</option>
                                <option value="ac">تيار متردد (AC)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="device-voltage">جهد الجهاز (V)</label>
                            <input type="number" id="device-voltage" placeholder="توتر الجهاز بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="device-current">تيار الجهاز (A)</label>
                            <input type="number" id="device-current" placeholder="تيار الجهاز بالأمبير" min="0.1">
                        </div>

                        <div class="input-group battery-ac-only" style="display: none;">
                            <label for="battery-device-phase">طور الجهاز</label>
                            <select id="battery-device-phase">
                                <option value="single">أحادي الطور</option>
                                <option value="three">ثلاثي الطور</option>
                            </select>
                        </div>
                        <div class="input-group battery-ac-only" style="display: none;">
                            <label for="battery-device-power-factor">معامل قدرة الجهاز (cos φ)</label>
                            <input type="number" id="battery-device-power-factor" value="0.8" step="0.01" min="0.1"
                                max="1" placeholder="مثال: 0.8">
                        </div>
                        <div class="input-group battery-ac-only" style="display: none;">
                            <label for="inverter-efficiency-battery">كفاءة المحول (Inverter Efficiency %)</label>
                            <input type="number" id="inverter-efficiency-battery" value="90" min="50" max="100" step="1"
                                placeholder="مثال: 90 (90%)">
                        </div>

                        <div class="input-group">
                            <label for="operation-duration">مدة التشغيل (بالساعات)</label>
                            <input type="number" id="operation-duration" placeholder="مدة التشغيل بالساعات" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="battery-voltage">توتر البطارية (V)</label>
                            <input type="number" id="battery-voltage" placeholder="توتر البطارية بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="battery-dod">عمق التفريغ الأقصى (%)</label>
                            <input type="number" id="battery-dod" value="80" min="10" max="100" step="1"
                                placeholder="مثال: 80 (80%)">
                        </div>
                        <div class="input-group">
                            <label for="battery-efficiency">كفاءة البطارية (%)</label>
                            <input type="number" id="battery-efficiency" value="90" min="50" max="100" step="1"
                                placeholder="مثال: 90 (90%)">
                        </div>
                        <button id="calculate-battery-btn">احسب السعة</button>
                        <div class="result" id="battery-result">النتائج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-flow-converter">
                <span class="icon">💧</span>
                <span class="text">تحويل وحدات التدفق</span>
            </h2>
            <div id="modal-flow-converter" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>💧 تحويل وحدات التدفق</h2>
                    <div class="calculator" id="flow-converter">
                        <div class="calculator-description">
                            تحويل معدل التدفق بين متر مكعب في الساعة ولتر في الثانية.
                        </div>
                        <div class="input-group">
                            <label for="flow-input-value">القيمة</label>
                            <input type="number" id="flow-input-value" placeholder="أدخل القيمة للتحويل" min="0">
                        </div>
                        <div class="input-group">
                            <label for="flow-conversion-type">نوع التحويل</label>
                            <select id="flow-conversion-type">
                                <option value="m3h-to-lps">من م³/ساعة إلى لتر/ثانية</option>
                                <option value="lps-to-m3h">من لتر/ثانية إلى م³/ساعة</option>
                            </select>
                        </div>
                        <button id="convert-flow-btn">تحويل</button>
                        <div class="result" id="flow-result">النتيجة: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-tank-calculator">
                <span class="icon">🧱</span>
                <span class="text">حساب سعة الخزان والتدفق</span>
            </h2>
            <div id="modal-tank-calculator" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>🧱 حساب سعة الخزان والتدفق</h2>
                    <div class="calculator" id="tank-calculator">
                        <div class="calculator-description">
                            حساب سعة الخزان ومدة تفريغه بناءً على الأبعاد وشكل الخزان ومعدل التدفق.
                        </div>
                        <div class="input-group">
                            <label for="tank-shape">شكل الخزان</label>
                            <select id="tank-shape">
                                <option value="cube">مكعب</option>
                                <option value="cylinder">أسطواني</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="tank-length">الطول (متر) / القطر (متر)</label>
                            <input type="number" id="tank-length" placeholder="للمكعب: الطول / للأسطواني: القطر"
                                min="0.1">
                        </div>
                        <div class="input-group" id="tank-width-group">
                            <label for="tank-width">العرض (متر)</label>
                            <input type="number" id="tank-width" placeholder="العرض بالمتر" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="tank-height">الارتفاع (متر)</label>
                            <input type="number" id="tank-height" placeholder="الارتفاع بالمتر" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="tank-flow-rate">تدفق المياه (م³/ساعة)</label>
                            <input type="number" id="tank-flow-rate" placeholder="معدل تدفق المياه لتفريغ الخزان"
                                min="0.1">
                        </div>
                        <button id="calculate-tank-btn">احسب السعة والوقت</button>
                        <div class="result" id="tank-result">النتائج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-resistance-voltage-drop">
                <span class="icon">📏</span>
                <span class="text">حاسبة مساحة مقطع الموصل (فقد الجهد)</span>
            </h2>
            <div id="modal-resistance-voltage-drop" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>📏 حاسبة مساحة مقطع الموصل (فقد الجهد)</h2>
                    <div class="calculator" id="resistance-voltage-drop">
                        <div class="calculator-description">
                            احسب مساحة المقطع العرضي المطلوبة للموصل لضمان أن فقد الجهد لا يتجاوز النسبة المسموح بها، مع
                            مراعاة نوع الطور ومعامل القدرة.
                        </div>
                        <div class="input-group">
                            <label for="rvd-voltage">الجهد الكهربائي (V)</label>
                            <input type="number" id="rvd-voltage" placeholder="الجهد بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="rvd-current">التيار الكهربائي (A)</label>
                            <input type="number" id="rvd-current" placeholder="التيار بالأمبير" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="rvd-phase">نوع الطور</label>
                            <select id="rvd-phase">
                                <option value="single">أحادي الطور</option>
                                <option value="three">ثلاثي الطور</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="rvd-power-factor">معامل القدرة (cos φ)</label>
                            <input type="number" id="rvd-power-factor" value="0.8" step="0.01" min="0.1" max="1"
                                placeholder="مثال: 0.8">
                        </div>
                        <div class="input-group">
                            <label for="rvd-material">نوع المادة</label>
                            <select id="rvd-material">
                                <option value="copper">نحاس (0.0172 Ω·mm²/m)</option>
                                <option value="aluminum">ألمنيوم (0.0282 Ω·mm²/m)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="rvd-length">طول الموصل (متر) - (طول في اتجاه واحد)</label>
                            <input type="number" id="rvd-length" placeholder="طول الكابل بالمتر" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="rvd-allowed-voltage-drop-percentage">الحد الأقصى لفقد الجهد المسموح به (%)</label>
                            <input type="number" id="rvd-allowed-voltage-drop-percentage" value="3" min="0.1" max="10"
                                step="0.1" placeholder="مثال: 3 (3%)">
                        </div>
                        <button id="calculate-rvd-btn">احسب مساحة المقطع</button>
                        <div class="result" id="rvd-result">النتائج: ...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-modal-target="modal-capacitor-calculator">
                <span class="icon">⚡</span>
                <span class="text">حساب سعة المكثف لتحسين معامل القدرة</span>
            </h2>
            <div id="modal-capacitor-calculator" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>⚡ حساب سعة المكثف لتحسين معامل القدرة</h2>
                    <div class="calculator" id="capacitor-calculator">
                        <div class="calculator-description">
                            حساب سعة المكثف المطلوبة (µF) لتحسين معامل القدرة في الدوائر الكهربائية، مع إمكانية تحديد
                            التردد ونوع الطور.
                        </div>
                        <div class="input-group">
                            <label for="cap-voltage">جهد التشغيل (V)</label>
                            <input type="number" id="cap-voltage" placeholder="جهد التشغيل بالفولت" min="1">
                        </div>
                        <div class="input-group">
                            <label for="cap-phase">نوع الطور</label>
                            <select id="cap-phase">
                                <option value="single">أحادي الطور</option>
                                <option value="three">ثلاثي الطور</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="cap-real-power">القدرة الحقيقية (kW)</label>
                            <input type="number" id="cap-real-power" placeholder="القدرة بالكيلوواط" min="0.1">
                        </div>
                        <div class="input-group">
                            <label for="cap-current-pf">معامل القدرة الحالي (cos φ)</label>
                            <input type="number" id="cap-current-pf" placeholder="مثال: 0.7" min="0.1" max="0.99"
                                step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="cap-desired-pf">معامل القدرة المستهدف (cos φ^)</label>
                            <input type="number" id="cap-desired-pf" placeholder="مثال: 0.95" min="0.1" max="0.99"
                                step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="cap-frequency">التردد (Hz)</label>
                            <input type="number" id="cap-frequency" value="50" min="1" step="1"
                                placeholder="مثال: 50 أو 60">
                        </div>
                        <button id="calculate-capacitor-btn">احسب السعة</button>
                        <div class="result" id="capacitor-result">السعة المطلوبة: ...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sectionTitles = document.querySelectorAll(".section-title");
            const modals = document.querySelectorAll(".modal");
            const closeButtons = document.querySelectorAll(".close-button");

            function displayResult(elementId, message, isSuccess) {
                const resultElement = document.getElementById(elementId);
                if (!resultElement) {
                    console.error(`Result element with ID '${elementId}' not found.`);
                    return;
                }
                resultElement.innerHTML = message;
                resultElement.className = `result ${isSuccess ? 'success' : 'error'}`;
            }

            function saveCalculatorState(calculatorId, data) {
                try {
                    localStorage.setItem(calculatorId + '_state', JSON.stringify(data));
                    // console.log(`State of ${calculatorId} saved:`, data); // For debugging
                } catch (e) {
                    console.error("Error saving data to localStorage:", e);
                }
            }

            function loadCalculatorState(calculatorId) {
                try {
                    const storedData = localStorage.getItem(calculatorId + '_state');
                    if (storedData) {
                        // console.log(`State of ${calculatorId} loaded:`, JSON.parse(storedData)); // For debugging
                        return JSON.parse(storedData);
                    }
                } catch (e) {
                    console.error("Error loading data from Local Storage:", e);
                }
                return null;
            }
            
            function populateInputs(calculatorId, inputsData, targetElement) {
                // console.log(`Populating inputs for ${calculatorId}`); // For debugging
                // console.log('Inputs data:', inputsData); // For debugging
                if (!targetElement || !inputsData) return;

                const currentDefaultValues = {
                    'unit-converter': {
                        'uc-power-factor': "0.8",
                        'uc-input-unit': "kw",
                        'uc-phase': "single"
                    },
                    'tank-calculator': {
                        'tank-shape': "cube"
                    },
                    'resistance-voltage-drop': {
                        'rvd-material': "copper",
                        'rvd-allowed-voltage-drop-percentage': "3",
                        'rvd-phase': "single",
                        'rvd-power-factor': "0.8"
                    },
                    'flow-converter': {
                        'flow-conversion-type': "m3h-to-lps"
                    },
                    'capacitor-calculator': {
                        'cap-current-pf': "0.7",
                        'cap-desired-pf': "0.95",
                        'cap-frequency': "50",
                        'cap-phase': "single"
                    },
                    'solar-panels-calculator': {
                        'solar-performance-factor': "80",
                        'inverter-efficiency': "90",
                        'pump-voltage': "230",
                        'pump-phase': "single",
                        'pump-power-factor': "0.8",
                        'ideal-series-voltage': ""
                    },
                    'battery-calculator': {
                        'battery-dod': "80",
                        'battery-efficiency': "90",
                        'battery-device-type': "dc",
                        'battery-device-phase': "single",
                        'battery-device-power-factor': "0.8",
                        'inverter-efficiency-battery': "90"
                    },
                    'pulley-calculator': {
                        'pulley-d1': "",
                        'pulley-rpm1': "",
                        'pulley-d2': "",
                        'pulley-rpm2': ""
                    }
                };

                // First, apply default values if they exist for the current calculator
                if (currentDefaultValues[calculatorId]) {
                    for (const defaultKey in currentDefaultValues[calculatorId]) {
                        const defaultInputElement = targetElement.querySelector(`#${defaultKey}`);
                        if (defaultInputElement) {
                            defaultInputElement.value = currentDefaultValues[calculatorId][defaultKey];
                        }
                    }
                }

                // Then, populate fields with saved data, overriding defaults if saved data exists
                for (const key in inputsData) {
                    let inputElementId = key.replace(/([A-Z])/g, '-$1').toLowerCase();

                    // Special handling for some IDs that don't follow direct conversion pattern
                    if (calculatorId === 'unit-converter') {
                        if (key === 'voltage') inputElementId = 'uc-voltage';
                        else if (key === 'inputValue') inputElementId = 'uc-input-value';
                        else if (key === 'inputUnit') inputElementId = 'uc-input-unit';
                        else if (key === 'powerFactor') inputElementId = 'uc-power-factor';
                        else if (key === 'phase') inputElementId = 'uc-phase';
                    } else if (calculatorId === 'solar-panels-calculator') {
                        if (key === 'pumpPowerKw') inputElementId = 'pump-power-kw';
                        else if (key === 'pumpVoltage') inputElementId = 'pump-voltage';
                        else if (key === 'pumpPhase') inputElementId = 'pump-phase';
                        else if (key === 'pumpPowerFactor') inputElementId = 'pump-power-factor';
                        else if (key === 'panelVoltage') inputElementId = 'panel-voltage';
                        else if (key === 'panelCurrent') inputElementId = 'panel-current';
                        else if (key === 'solarPerformanceFactor') inputElementId = 'solar-performance-factor';
                        else if (key === 'inverterEfficiency') inputElementId = 'inverter-efficiency';
                        else if (key === 'idealSeriesVoltage') inputElementId = 'ideal-series-voltage';
                    } else if (calculatorId === 'battery-calculator') {
                        if (key === 'deviceType') inputElementId = 'battery-device-type';
                        else if (key === 'devicePhase') inputElementId = 'battery-device-phase';
                        else if (key === 'devicePowerFactor') inputElementId = 'battery-device-power-factor';
                        else if (key === 'inverterEfficiencyBattery') inputElementId = 'inverter-efficiency-battery';
                        else if (key === 'deviceVoltage') inputElementId = 'device-voltage';
                        else if (key === 'deviceCurrent') inputElementId = 'device-current';
                        else if (key === 'operationDuration') inputElementId = 'operation-duration';
                        else if (key === 'batteryVoltage') inputElementId = 'battery-voltage';
                        else if (key === 'dod') inputElementId = 'battery-dod';
                        else if (key === 'efficiency') inputElementId = 'battery-efficiency';
                    } else if (calculatorId === 'percentage-calculator') {
                        if (key === 'originalNumber') inputElementId = 'original-number';
                        else if (key === 'percentageValue') inputElementId = 'percentage-value';
                    } else if (calculatorId === 'capacitor-calculator') {
                        if (key === 'voltage') inputElementId = 'cap-voltage';
                        else if (key === 'realPowerKW') inputElementId = 'cap-real-power';
                        else if (key === 'currentPF') inputElementId = 'cap-current-pf';
                        else if (key === 'desiredPF') inputElementId = 'cap-desired-pf';
                        else if (key === 'frequency') inputElementId = 'cap-frequency';
                        else if (key === 'phase') inputElementId = 'cap-phase';
                    } else if (calculatorId === 'flow-converter') {
                        if (key === 'inputValue') inputElementId = 'flow-input-value';
                        else if (key === 'conversionType') inputElementId = 'flow-conversion-type';
                    } else if (calculatorId === 'tank-calculator') {
                        if (key === 'tankShape') inputElementId = 'tank-shape';
                        else if (key === 'lengthOrDiameter') inputElementId = 'tank-length';
                        else if (key === 'width') inputElementId = 'tank-width';
                        else if (key === 'height') inputElementId = 'tank-height';
                        else if (key === 'flowRateM3H') inputElementId = 'tank-flow-rate';
                    } else if (calculatorId === 'resistance-voltage-drop') {
                        if (key === 'voltage') inputElementId = 'rvd-voltage';
                        else if (key === 'current') inputElementId = 'rvd-current';
                        else if (key === 'material') inputElementId = 'rvd-material';
                        else if (key === 'length') inputElementId = 'rvd-length';
                        else if (key === 'allowedVoltageDropPercentage') inputElementId = 'rvd-allowed-voltage-drop-percentage';
                        else if (key === 'phase') inputElementId = 'rvd-phase';
                        else if (key === 'powerFactor') inputElementId = 'rvd-power-factor';
                    } else if (calculatorId === 'pulley-calculator') {
                        if (key === 'd1') inputElementId = 'pulley-d1';
                        else if (key === 'rpm1') inputElementId = 'pulley-rpm1';
                        else if (key === 'd2') inputElementId = 'pulley-d2';
                        else if (key === 'rpm2') inputElementId = 'pulley-rpm2';
                    }

                    const inputElement = targetElement.querySelector(`#${inputElementId}`);
                    // console.log(`Attempting to set ${inputElementId} to ${inputsData[key]}`); // For debugging
                    if (inputElement && (inputElement.type === 'number' || inputElement.type === 'text' || inputElement.tagName === 'SELECT') && inputsData[key] !== null && inputsData[key] !== undefined) {
                        inputElement.value = inputsData[key];
                    }
                }

                // Manually dispatch change events for select fields that affect other field visibility
                if (calculatorId === 'tank-calculator') {
                    const tankShapeSelect = targetElement.querySelector('#tank-shape');
                    if (tankShapeSelect) {
                        const event = new Event('change');
                        tankShapeSelect.dispatchEvent(event);
                    }
                }
                if (calculatorId === 'battery-calculator') {
                    const deviceTypeSelect = targetElement.querySelector('#battery-device-type');
                    if (deviceTypeSelect) {
                        const event = new Event('change');
                        deviceTypeSelect.dispatchEvent(event);
                    }
                }
            }

            const calculatorFunctions = {
                "unit-converter": {
                    calculate: function () {
                        const voltage = parseFloat(document.getElementById("uc-voltage").value);
                        const phase = document.getElementById("uc-phase").value;
                        const powerFactor = parseFloat(document.getElementById("uc-power-factor").value);
                        const inputValue = parseFloat(document.getElementById("uc-input-value").value);
                        const inputUnit = document.getElementById("uc-input-unit").value;

                        if (isNaN(voltage) || voltage <= 0) { displayResult("uc-result", "الرجاء إدخال جهد صحيح وموجب.", false); return; }
                        if (isNaN(powerFactor) || powerFactor <= 0.1 || powerFactor > 1) { displayResult("uc-result", "معامل القدرة يجب أن يكون بين 0.1 و 1.", false); return; }
                        if (isNaN(inputValue) || inputValue < 0) { displayResult("uc-result", "الرجاء إدخال قيمة صحيحة وموجبة للتحويل.", false); return; }

                        const sqrt3 = Math.sqrt(3);
                        const HP_TO_KW_FACTOR = 0.7457;

                        let kw = 0, kva = 0, hp = 0, amp = 0;
                        let basePowerWatts = 0;
                        let baseApparentPowerVA = 0;

                        switch (inputUnit) {
                            case 'kw':
                                basePowerWatts = inputValue * 1000;
                                baseApparentPowerVA = basePowerWatts / powerFactor;
                                break;
                            case 'kva':
                                baseApparentPowerVA = inputValue * 1000;
                                basePowerWatts = baseApparentPowerVA * powerFactor;
                                break;
                            case 'hp':
                                basePowerWatts = inputValue * HP_TO_KW_FACTOR * 1000;
                                baseApparentPowerVA = basePowerWatts / powerFactor;
                                break;
                            case 'amp':
                                if (phase === "single") {
                                    baseApparentPowerVA = voltage * inputValue;
                                } else {
                                    baseApparentPowerVA = sqrt3 * voltage * inputValue;
                                }
                                basePowerWatts = baseApparentPowerVA * powerFactor;
                                break;
                        }

                        kw = basePowerWatts / 1000;
                        kva = baseApparentPowerVA / 1000;
                        hp = kw / HP_TO_KW_FACTOR;

                        if (voltage === 0) {
                            displayResult("uc-result", "خطأ في الجهد الكهربائي. لا يمكن أن يكون صفرًا.", false); return;
                        }
                        if (phase === "single") {
                            amp = baseApparentPowerVA / voltage;
                        } else {
                            if (sqrt3 * voltage === 0) {
                                displayResult("uc-result", "خطأ في الجهد الكهربائي للطور الثلاثي. لا يمكن أن يكون صفرًا.", false); return;
                            }
                            amp = baseApparentPowerVA / (sqrt3 * voltage);
                        }

                        const resultMessage = `
                            <p><strong>قيمة الإدخال الأصلية:</strong> ${inputValue.toFixed(2)} ${inputUnit.toUpperCase()}</p>
                            <p><strong>الجهد المستخدم:</strong> ${voltage.toFixed(0)} V, <strong>الطور:</strong> ${phase === "single" ? "أحادي" : "ثلاثي"}, <strong>معامل القدرة:</strong> ${powerFactor.toFixed(2)}</p>
                            <h3>النتائج المحوّلة:</h3>
                            <ul>
                                <li>القدرة الحقيقية (Real Power): <strong>${kw.toFixed(2)} kW</strong></li>
                                <li>القدرة الظاهرية (Apparent Power): <strong>${kva.toFixed(2)} kVA</strong></li>
                                <li>القدرة بالحصان (Horsepower): <strong>${hp.toFixed(2)} HP</strong></li>
                                <li>التيار الكهربائي (Current): <strong>${amp.toFixed(2)} A</strong></li>
                            </ul>
                            <p><small>ملاحظة: تُحسب القدرة بالحصان بناءً على 1 حصان = 0.7457 كيلوواط.</small></p>
                        `;
                        displayResult("uc-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                voltage: voltage,
                                phase: phase,
                                powerFactor: powerFactor,
                                inputValue: inputValue,
                                inputUnit: inputUnit
                            }
                        };
                        saveCalculatorState("unit-converter", dataToSave);
                    },
                },

                "solar-panels-calculator": {
                    calculate: function () {
                        const pumpPowerKw = parseFloat(document.getElementById("pump-power-kw").value);
                        const pumpVoltage = parseFloat(document.getElementById("pump-voltage").value);
                        const pumpPhase = document.getElementById("pump-phase").value;
                        const pumpPowerFactor = parseFloat(document.getElementById("pump-power-factor").value);
                        
                        const idealSeriesVoltage = parseFloat(document.getElementById("ideal-series-voltage").value);
                        const panelVoltage = parseFloat(document.getElementById("panel-voltage").value);
                        const panelCurrent = parseFloat(document.getElementById("panel-current").value);
                        const solarPerformanceFactor = parseFloat(document.getElementById("solar-performance-factor").value) / 100;
                        const inverterEfficiency = parseFloat(document.getElementById("inverter-efficiency").value) / 100;

                        if (isNaN(pumpPowerKw) || pumpPowerKw <= 0) { displayResult("solar-panels-result", "الرجاء إدخال قدرة مضخة صحيحة وموجبة بالكيلوواط.", false); return; }
                        if (isNaN(pumpVoltage) || pumpVoltage <= 0) { displayResult("solar-panels-result", "الرجاء إدخال جهد مضخة صحيح وموجب.", false); return; }
                        if (isNaN(pumpPowerFactor) || pumpPowerFactor <= 0.1 || pumpPowerFactor > 1) { displayResult("solar-panels-result", "معامل قدرة المضخة يجب أن يكون بين 0.1 و 1.", false); return; }

                        if (isNaN(panelVoltage) || panelVoltage <= 0) { displayResult("solar-panels-result", "الرجاء إدخال جهد لوح شمسي صحيح وموجب.", false); return; }
                        if (isNaN(panelCurrent) || panelCurrent <= 0) { displayResult("solar-panels-result", "الرجاء إدخال تيار لوح شمسي صحيح وموجب.", false); return; }
                        if (isNaN(solarPerformanceFactor) || solarPerformanceFactor <= 0 || solarPerformanceFactor > 1) { displayResult("solar-panels-result", "عامل أداء الألواح يجب أن يكون بين 50% و 100%.", false); return; }
                        if (isNaN(inverterEfficiency) || inverterEfficiency <= 0 || inverterEfficiency > 1) { displayResult("solar-panels-result", "كفاءة المحول يجب أن تكون بين 50% و 100%.", false); return; }
                        if (isNaN(idealSeriesVoltage) || idealSeriesVoltage <= 0) { displayResult("solar-panels-result", "الرجاء إدخال التوتر المثالي للألواح على التوالي صحيح وموجب.", false); return; }

                        const pumpRealPowerWatts = pumpPowerKw * 1000;

                        let actualPumpCurrentAC;
                        const sqrt3 = Math.sqrt(3);
                        if (pumpPhase === "single") {
                            if (pumpVoltage * pumpPowerFactor === 0) {
                                displayResult("solar-panels-result", "خطأ: لا يمكن حساب تيار المضخة (AC). جهد المضخة أو معامل القدرة لا يمكن أن يكون صفرًا.", false); return;
                            }
                            actualPumpCurrentAC = pumpRealPowerWatts / (pumpVoltage * pumpPowerFactor);
                        } else {
                            if (sqrt3 * pumpVoltage * pumpPowerFactor === 0) {
                                displayResult("solar-panels-result", "خطأ: لا يمكن حساب تيار المضخة (AC). جهد المضخة أو معامل القدرة لا يمكن أن يكون صفرًا للطور الثلاثي.", false); return;
                            }
                            actualPumpCurrentAC = pumpRealPowerWatts / (sqrt3 * pumpVoltage * pumpPowerFactor);
                        }

                        const nominalPanelPower = panelVoltage * panelCurrent;
                        if (nominalPanelPower === 0) {
                            displayResult("solar-panels-result", "خطأ: قدرة اللوح الشمسي الاسمية لا يمكن أن تكون صفرًا. الرجاء التحقق من جهد وتيار اللوح.", false);
                            return;
                        }

                        if (inverterEfficiency * solarPerformanceFactor === 0) {
                            displayResult("solar-panels-result", "خطأ: كفاءة المحول أو عامل أداء الألواح لا يمكن أن يكون صفرًا للحساب الكلي.", false);
                            return;
                        }
                        const totalRequiredDcPowerAfterLosses = pumpRealPowerWatts / (inverterEfficiency * solarPerformanceFactor);

                        const totalPanelsNeeded = Math.ceil(totalRequiredDcPowerAfterLosses / nominalPanelPower);

                        if (panelVoltage === 0) {
                            displayResult("solar-panels-result", "خطأ: جهد اللوح الواحد لا يمكن أن يكون صفرًا لحساب عدد الألواح في السلسلة.", false);
                            return;
                        }
                        const panelsInSeries = Math.ceil(idealSeriesVoltage / panelVoltage);
                        if (panelsInSeries === 0) {
                               displayResult("solar-panels-result", "خطأ: عدد الألواح في السلسلة لا يمكن أن يكون صفرًا. تأكد من أن الجهد المثالي للسلسلة أكبر من جهد اللوح الواحد.", false);
                               return;
                        }

                        const parallelStrings = Math.ceil(totalPanelsNeeded / panelsInSeries);

                        const actualTotalPanelsInArray = panelsInSeries * parallelStrings;
                        const actualSystemVoltageDC = panelsInSeries * panelVoltage;
                        const actualSystemCurrentDC = parallelStrings * panelCurrent;
                        const actualSystemTotalPower = actualTotalPanelsInArray * nominalPanelPower;

                        const resultMessage = `
                        <h3>قدرة النظام الشمسي الفعلية المركبة:</h3>
                            <ul>
                                <li><strong>العدد الفعلي الكلي للألواح في المصفوفة:</strong> ${actualTotalPanelsInArray} لوح</li>
                                <li><strong>عدد الألواح في السلسلة الواحدة (Series):</strong> ${panelsInSeries} لوح</li>
                                <li><strong>عدد السلاسل المتوازية (Parallel Strings):</strong> ${parallelStrings} سلسلة</li>
                                <li><strong>الجهد الكلي للسلسلة (Vmp_array):</strong> <strong>${actualSystemVoltageDC.toFixed(2)} V</strong></li>
                                <li><strong>التيار الكلي للسلاسل (Imp_array):</strong> <strong>${actualSystemCurrentDC.toFixed(2)} A</strong></li>
                                <li><strong>جهد المضخة المدخل:</strong> ${pumpVoltage} V</li>
                                <li><strong>تيار المضخة المقدر (AC):</strong> <strong>${actualPumpCurrentAC.toFixed(2)} A</strong> <small></small></li>
                                <li><strong>مجموع القدرة الاسمية الفعلية للنظام:</strong> <strong>${actualSystemTotalPower.toFixed(2)} W</strong></li>
                            </ul>
                            <hr>
                            <h3>ملخص الحسابات:</h3>
                            <ul>
                                <li><strong>القدرة الحقيقية للمضخة المطلوبة:</strong> ${pumpRealPowerWatts.toFixed(2)} W</li>
                                <li><strong>قدرة اللوح الواحد الاسمية:</strong> ${nominalPanelPower.toFixed(2)} W </li>
                                <li><strong>عامل أداء الألواح:</strong> ${solarPerformanceFactor * 100}%</li>
                                <li><strong>كفاءة المحول:</strong> ${inverterEfficiency * 100}%</li>
                                <li><strong>القدرة الإجمالية المطلوبة من الألواح (DC) بعد الخسائر:</strong> ${totalRequiredDcPowerAfterLosses.toFixed(2)} W</li>
                                <li><strong>العدد الإجمالي للألواح الشمسية المطلوبة:</strong> <span style="color: var(--success-color); font-size: 1.2em;">${totalPanelsNeeded} لوح</span></li>
                                <li><strong>القدرة الاسمية الإجمالية للألواح المطلوبة (الحد الأدنى):</strong> ${totalPanelsNeeded * nominalPanelPower.toFixed(2)} W</li>
                            </ul>
                        `;
                        displayResult("solar-panels-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                pumpPowerKw: pumpPowerKw,
                                pumpVoltage: pumpVoltage,
                                pumpPhase: pumpPhase,
                                pumpPowerFactor: pumpPowerFactor,
                                panelVoltage: panelVoltage,
                                panelCurrent: panelCurrent,
                                solarPerformanceFactor: parseFloat(document.getElementById("solar-performance-factor").value),
                                inverterEfficiency: parseFloat(document.getElementById("inverter-efficiency").value),
                                idealSeriesVoltage: idealSeriesVoltage
                            }
                        };
                        saveCalculatorState("solar-panels-calculator", dataToSave);
                    },
                },

                "battery-calculator": {
                    calculate: function () {
                        const deviceType = document.getElementById("battery-device-type").value;
                        const deviceVoltage = parseFloat(document.getElementById("device-voltage").value);
                        const deviceCurrent = parseFloat(document.getElementById("device-current").value);
                        const operationDuration = parseFloat(document.getElementById("operation-duration").value);
                        const batteryVoltage = parseFloat(document.getElementById("battery-voltage").value);
                        const dod = parseFloat(document.getElementById("battery-dod").value) / 100;
                        const efficiency = parseFloat(document.getElementById("battery-efficiency").value) / 100;

                        const devicePhase = document.getElementById("battery-device-phase").value;
                        const devicePowerFactor = parseFloat(document.getElementById("battery-device-power-factor").value);
                        const inverterEfficiencyBattery = parseFloat(document.getElementById("inverter-efficiency-battery").value) / 100;

                        if (isNaN(deviceVoltage) || deviceVoltage <= 0) { displayResult("battery-result", "الرجاء إدخال جهد جهاز صحيح وموجب.", false); return; }
                        if (isNaN(deviceCurrent) || deviceCurrent <= 0) { displayResult("battery-result", "الرجاء إدخال تيار جهاز صحيح وموجب.", false); return; }
                        if (isNaN(operationDuration) || operationDuration <= 0) { displayResult("battery-result", "الرجاء إدخال مدة تشغيل صحيحة وموجبة.", false); return; }
                        if (isNaN(batteryVoltage) || batteryVoltage <= 0) { displayResult("battery-result", "الرجاء إدخال توتر بطارية صحيح وموجب.", false); return; }
                        if (isNaN(dod) || dod <= 0 || dod > 1) { displayResult("battery-result", "عمق التفريغ الأقصى يجب أن يكون بين 10% و 100%.", false); return; }
                        if (isNaN(efficiency) || efficiency <= 0 || efficiency > 1) { displayResult("battery-result", "كفاءة البطارية يجب أن تكون بين 50% و 100%.", false); return; }

                        const sqrt3 = Math.sqrt(3);

                        let devicePowerWatts;
                        let energyRequiredFromBatteryWh_before_battery_losses;

                        if (deviceType === "dc") {
                            devicePowerWatts = deviceVoltage * deviceCurrent;
                            energyRequiredFromBatteryWh_before_battery_losses = devicePowerWatts * operationDuration;
                        } else {
                            if (isNaN(devicePowerFactor) || devicePowerFactor <= 0.1 || devicePowerFactor > 1) { displayResult("battery-result", "معامل قدرة الجهاز يجب أن يكون بين 0.1 و 1.", false); return; }
                            if (isNaN(inverterEfficiencyBattery) || inverterEfficiencyBattery <= 0 || inverterEfficiencyBattery > 1) { displayResult("battery-result", "كفاءة المحول يجب أن تكون بين 50% و 100%.", false); return; }

                            if (devicePhase === "single") {
                                devicePowerWatts = deviceVoltage * deviceCurrent * devicePowerFactor;
                            } else {
                                devicePowerWatts = sqrt3 * deviceVoltage * deviceCurrent * devicePowerFactor;
                            }

                            if (inverterEfficiencyBattery === 0) {
                                displayResult("battery-result", "خطأ: كفاءة المحول للبطارية لا يمكن أن تكون صفرًا.", false); return;
                            }
                            energyRequiredFromBatteryWh_before_battery_losses = (devicePowerWatts * operationDuration) / inverterEfficiencyBattery;
                        }

                        let nominalBatteryWhCapacity = 0;
                        if (dod > 0 && efficiency > 0) {
                            nominalBatteryWhCapacity = energyRequiredFromBatteryWh_before_battery_losses / dod / efficiency;
                        } else {
                            displayResult("battery-result", "خطأ: عمق التفريغ أو كفاءة البطارية لا يمكن أن يكون صفرًا.", false); return;
                        }

                        let nominalBatteryAhCapacity = 0;
                        if (batteryVoltage > 0) {
                            nominalBatteryAhCapacity = nominalBatteryWhCapacity / batteryVoltage;
                        } else {
                            displayResult("battery-result", "خطأ: توتر البطارية لا يمكن أن يكون صفرًا.", false); return;
                        }

                        const usableBatteryWhCapacity = nominalBatteryWhCapacity * dod;

                        let resultMessage = `
                            <h3>ملخص الحسابات:</h3>
                            <ul>
                                <li><strong>قدرة الجهاز الحقيقية:</strong> <strong>${devicePowerWatts.toFixed(2)} W</strong></li>
                                <li><strong>إجمالي الطاقة المطلوبة لتشغيل الجهاز:</strong> <strong>${(devicePowerWatts * operationDuration).toFixed(2)} Wh</strong></li>
                        `;

                        if (deviceType === "ac") {
                            resultMessage += `<li><strong>الطاقة المطلوبة من جانب DC من البطارية:</strong> <strong>${energyRequiredFromBatteryWh_before_battery_losses.toFixed(2)} Wh</strong> (بعد ضياع المحول بنسبة ${((1 - inverterEfficiencyBattery) * 100).toFixed(1)}%)</li>`;
                        } else {
                            resultMessage += `<li><strong>الطاقة المطلوبة من البطارية (نقطة التحميل DC):</strong> <strong>${energyRequiredFromBatteryWh_before_battery_losses.toFixed(2)} Wh</strong></li>`;
                        }

                        resultMessage += `
                                <li><strong>السعة الفعلية للبطارية التي يمكن استخدامها (Usable Capacity):</strong> <strong>${usableBatteryWhCapacity.toFixed(2)} Wh</strong> (بناءً على عمق التفريغ ${dod * 100}%)</li>
                            </ul>
                            <h3>النتائج النهائية:</h3>
                            <p><strong>السعة الاسمية المطلوبة للبطارية: <span style="color: var(--success-color); font-size: 1.2em;">${nominalBatteryAhCapacity.toFixed(2)} Ah</span></strong></p>
                            <p><strong>القدرة الإجمالية للبطارية (Wh): <span style="color: var(--success-color); font-size: 1.1em;">${nominalBatteryWhCapacity.toFixed(2)} Wh</span></strong></p>
                        `;

                        displayResult("battery-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                deviceType: deviceType,
                                deviceVoltage: deviceVoltage,
                                deviceCurrent: deviceCurrent,
                                operationDuration: operationDuration,
                                batteryVoltage: batteryVoltage,
                                dod: parseFloat(document.getElementById("battery-dod").value),
                                efficiency: parseFloat(document.getElementById("battery-efficiency").value),
                                devicePhase: deviceType === 'ac' ? devicePhase : null,
                                devicePowerFactor: deviceType === 'ac' ? parseFloat(document.getElementById("battery-device-power-factor").value) : null,
                                inverterEfficiencyBattery: deviceType === 'ac' ? parseFloat(document.getElementById("inverter-efficiency-battery").value) : null
                            }
                        };
                        saveCalculatorState("battery-calculator", dataToSave);
                    },
                },

                "percentage-calculator": {
                    calculate: function () {
                        const originalNumber = parseFloat(document.getElementById("original-number").value);
                        const percentageValue = parseFloat(document.getElementById("percentage-value").value);

                        if (isNaN(originalNumber) || originalNumber < 0) { displayResult("percentage-result", "الرجاء إدخال عدد أصلي صحيح وموجب.", false); return; }
                        if (isNaN(percentageValue) || percentageValue < 0 || percentageValue > 100) { displayResult("percentage-result", "النسبة المئوية يجب أن تكون بين 0 و 100.", false); return; }

                        const calculatedValue = (originalNumber * percentageValue) / 100;
                        const addedValue = originalNumber + calculatedValue;
                        const subtractedValue = originalNumber - calculatedValue;

                        const resultMessage = `
                            <h3>ملخص الحسابات:</h3>
                            <ul>
                                <li><strong>العدد الأصلي:</strong> ${originalNumber.toFixed(2)}</li>
                                <li><strong>النسبة المئوية المدخلة:</strong> ${percentageValue.toFixed(2)}%</li>
                                <li><strong>القيمة المحسوبة (${percentageValue.toFixed(2)}% من ${originalNumber.toFixed(2)}):</strong> ${calculatedValue.toFixed(2)}</li>
                            </ul>
                            <hr>
                            <h3>النتائج التفصيلية:</h3>
                            <ul>
                                <li>إذا أضفنا النسبة المئوية: <strong><span style="color: var(--success-color); font-size: 1.2em;">${addedValue.toFixed(2)}</span></strong> ( ${originalNumber.toFixed(2)} + ${calculatedValue.toFixed(2)} )</li>
                                <li>إذا خصمنا النسبة المئوية: <strong><span style="color: var(--success-color); font-size: 1.2em;">${subtractedValue.toFixed(2)}</span></strong> ( ${originalNumber.toFixed(2)} - ${calculatedValue.toFixed(2)} )</li>
                                <li>القيمة المئوية فقط: <strong><span style="color: var(--success-color); font-size: 1.2em;">${calculatedValue.toFixed(2)}</span></strong></li>
                            </ul>
                        `;
                        displayResult("percentage-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                originalNumber: originalNumber,
                                percentageValue: percentageValue
                            }
                        };
                        saveCalculatorState("percentage-calculator", dataToSave);
                    },
                },

                "capacitor-calculator": {
                    calculate: function () {
                        const voltage = parseFloat(document.getElementById("cap-voltage").value);
                        const phase = document.getElementById("cap-phase").value;
                        const realPowerKW = parseFloat(document.getElementById("cap-real-power").value);
                        const currentPF = parseFloat(document.getElementById("cap-current-pf").value);
                        const desiredPF = parseFloat(document.getElementById("cap-desired-pf").value);
                        const frequency = parseFloat(document.getElementById("cap-frequency").value);

                        if (isNaN(voltage) || voltage <= 0) { displayResult("capacitor-result", "الرجاء إدخال جهد تشغيل صحيح وموجب.", false); return; }
                        if (isNaN(realPowerKW) || realPowerKW <= 0) { displayResult("capacitor-result", "الرجاء إدخال قدرة حقيقية صحيحة وموجبة.", false); return; }
                        if (isNaN(currentPF) || currentPF <= 0.1 || currentPF >= 1) { displayResult("capacitor-result", "معامل القدرة الحالي يجب أن يكون بين 0.1 و 0.99.", false); return; }
                        if (isNaN(desiredPF) || desiredPF <= 0.1 || desiredPF >= 1) { displayResult("capacitor-result", "معامل القدرة المستهدف يجب أن يكون بين 0.1 و 0.99. ويجب أن يكون أكبر من الحالي.", false); return; }
                        if (desiredPF <= currentPF) { displayResult("capacitor-result", "معامل القدرة المستهدف يجب أن يكون أكبر من معامل القدرة الحالي لتحسينه.", false); return; }
                        if (isNaN(frequency) || frequency <= 0) { displayResult("capacitor-result", "الرجاء إدخال تردد صحيح وموجب.", false); return; }

                        const realPowerWatts = realPowerKW * 1000;

                        const angle1 = Math.acos(currentPF);
                        const angle2 = Math.acos(desiredPF);

                        const reactivePower1 = realPowerWatts * Math.tan(angle1);
                        const reactivePower2 = realPowerWatts * Math.tan(angle2);

                        const qCompensation = reactivePower1 - reactivePower2;

                        let resultMessage;

                        if (phase === "single") {
                            if (voltage === 0 || frequency === 0) {
                                displayResult("capacitor-result", "لا يمكن حساب السعة. تأكد من أن الجهد والتردد صحيحين وموجبين.", false); return;
                            }
                            const capacitorValueFarads = qCompensation / (2 * Math.PI * frequency * Math.pow(voltage, 2));
                            const capacitorValueMicroFarads = capacitorValueFarads * 1e6;

                            resultMessage = `
                                <h3>ملخص الحسابات:</h3>
                                <ul>
                                    <li><strong>القدرة الحقيقية (P):</strong> ${realPowerKW.toFixed(2)} kW</li>
                                    <li><strong>معامل القدرة الحالي (cos φ<sub>1</sub>):</strong> ${currentPF.toFixed(2)} (زاوية φ<sub>1</sub>: ${(angle1 * 180 / Math.PI).toFixed(2)}&deg;)</li>
                                    <li><strong>معامل القدرة المستهدف (cos φ<sub>2</sub>):</strong> ${desiredPF.toFixed(2)} (زاوية φ<sub>2</sub>: ${(angle2 * 180 / Math.PI).toFixed(2)}&deg;)</li>
                                    <li><strong>التردد (f):</strong> ${frequency.toFixed(0)} Hz</li>
                                    <li><strong>الجهد (V):</strong> ${voltage.toFixed(0)} V</li>
                                </ul>
                                <h4>القدرة التفاعلية المطلوبة للتعويض (Qc):</h4>
                                <p>
                                    القدرة التفاعلية الحالية (Q<sub>1</sub>) = ${reactivePower1.toFixed(2)} Var<br>
                                    القدرة التفاعلية المستهدفة (Q<sub>2</sub>) = ${reactivePower2.toFixed(2)} Var<br>
                                    فرق القدرة التفاعلية (Qc) = Q<sub>1</sub> - Q<sub>2</sub> = <strong>${qCompensation.toFixed(2)} Var</strong>
                                </p>
                                <h3>النتائج النهائية:</h3>
                                <p>بناءً على نظام <strong>أحادي الطور</strong>:</p>
                                <p><strong>السعة المطلوبة للمكثف: <span style="color: var(--success-color); font-size: 1.2em;">${capacitorValueMicroFarads.toFixed(2)} µF</span></strong></p>
                                <p><small>ملاحظة: القيمة المحسوبة هي لمكثف واحد.</small></p>
                            `;
                        } else {
                            if (voltage === 0 || frequency === 0) {
                                displayResult("capacitor-result", "لا يمكن حساب السعة. تأكد من أن الجهد والتردد صحيحين وموجبين.", false); return;
                            }
                            const C_delta_per_phase_farads = qCompensation / (3 * 2 * Math.PI * frequency * Math.pow(voltage, 2));
                            const C_delta_per_phase_microFarads = C_delta_per_phase_farads * 1e6;

                            const V_phase = voltage / Math.sqrt(3);
                            if (V_phase === 0) {
                                displayResult("capacitor-result", "خطأ في حساب جهد الطور. تأكد من صحة الجهد المدخل.", false); return;
                            }
                            const C_star_per_phase_farads = qCompensation / (3 * 2 * Math.PI * frequency * Math.pow(V_phase, 2));
                            const C_star_per_phase_microFarads = C_star_per_phase_farads * 1e6;

                            resultMessage = `
                                <h3>ملخص الحسابات:</h3>
                                <ul>
                                    <li><strong>القدرة الحقيقية (P):</strong> ${realPowerKW.toFixed(2)} kW</li>
                                    <li><strong>معامل القدرة الحالي (cos φ<sub>1</sub>):</strong> ${currentPF.toFixed(2)} (زاوية φ<sub>1</sub>: ${(angle1 * 180 / Math.PI).toFixed(2)}&deg;)</li>
                                    <li><strong>معامل القدرة المستهدف (cos φ<sub>2</sub>):</strong> ${desiredPF.toFixed(2)} (زاوية φ<sub>2</sub>: ${(angle2 * 180 / Math.PI).toFixed(2)}&deg;)</li>
                                    <li><strong>التردد (f):</strong> ${frequency.toFixed(0)} Hz</li>
                                    <li><strong>جهد الخط (V<sub>L</sub>):</strong> ${voltage.toFixed(0)} V</li>
                                </ul>
                                <h4>القدرة التفاعلية المطلوبة للتعويض (Qc):</h4>
                                <p>
                                    القدرة التفاعلية الحالية (Q<sub>1</sub>) = ${reactivePower1.toFixed(2)} Var<br>
                                    القدرة التفاعلية المستهدفة (Q<sub>2</sub>) = ${reactivePower2.toFixed(2)} Var<br>
                                    فرق القدرة التفاعلية (Qc) = Q<sub>1</sub> - Q<sub>2</sub> = <strong>${qCompensation.toFixed(2)} Var</strong>
                                </p>
                                <h3>النتائج النهائية:</h3>
                                <p>بناءً على نظام <strong>ثلاثي الطور</strong>:</p>
                                <p>لتحقيق تحسين معامل القدرة، ستحتاج إلى إجمالي <strong>${qCompensation.toFixed(2)} Var</strong> من القدرة التفاعلية.</p>
                                <h4>خيارات التوصيل (لكل طور):</h4>
                                <ul>
                                    <li><strong>للتوصيل دلتا (Δ):</strong> كل مكثف يجب أن تكون سعته <strong>${C_delta_per_phase_microFarads.toFixed(2)} µF</strong>.<br>
                                        <small>(ثلاث مكثفات متصلة بين الخطوط، جهد كل مكثف = جهد الخط ${voltage.toFixed(0)}V)</small></li>
                                    <li><strong>للتوصيل ستار (Y):</strong> كل مكثف يجب أن تكون سعته <strong>${C_star_per_phase_microFarads.toFixed(2)} µF</strong>.<br>
                                        <small>(ثلاث مكثفات متصلة بين الخطوط ونقطة النجمة، جهد كل مكثف = جهد الطور ${V_phase.toFixed(0)}V)</small></li>
                                </ul>
                                <p><small>ملاحظة: توصيل دلتا هو الأكثر شيوعاً لتحسين معامل القدرة في الأحمال الصناعية.</small></p>
                            `;
                        }

                        displayResult("capacitor-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                voltage: voltage,
                                phase: phase,
                                realPowerKW: realPowerKW,
                                currentPF: currentPF,
                                desiredPF: desiredPF,
                                frequency: frequency
                            }
                        };
                        saveCalculatorState("capacitor-calculator", dataToSave);
                    },
                },

                "flow-converter": {
                    calculate: function () {
                        const inputValue = parseFloat(document.getElementById("flow-input-value").value);
                        const conversionType = document.getElementById("flow-conversion-type").value;

                        if (isNaN(inputValue) || inputValue < 0) { displayResult("flow-result", "الرجاء إدخال قيمة صحيحة وموجبة للتحويل.", false); return; }

                        let result = 0;
                        let unitFrom = "";
                        let unitTo = "";
                        let explanation = "";

                        if (conversionType === "m3h-to-lps") {
                            result = (inputValue * 1000) / 3600;
                            unitFrom = "م³/ساعة";
                            unitTo = "لتر/ثانية";
                            explanation = " (بضرب القيمة في 1000 للتحويل إلى لتر، ثم القسمة على 3600 للتحويل إلى ثانية)";
                        } else {
                            result = (inputValue * 3600) / 1000;
                            unitFrom = "لتر/ثانية";
                            unitTo = "م³/ساعة";
                            explanation = " (بضرب القيمة في 3600 للتحويل إلى ساعة، ثم القسمة على 1000 للتحويل إلى متر مكعب)";
                        }

                        const resultMessage = `
                            <h3>ملخص الحسابات:</h3>
                            <ul>
                                <li><strong>القيمة المدخلة:</strong> ${inputValue.toFixed(2)} ${unitFrom}</li>
                                <li><strong>نوع التحويل:</strong> من ${unitFrom} إلى ${unitTo}</li>
                            </ul>
                            <h3>النتيجة: <strong><span style="color: var(--success-color); font-size: 1.2em;">${result.toFixed(2)} ${unitTo}</span></strong></h3>
                            <p><small>كيف تم الحساب: ${explanation}</small></p>
                        `;
                        displayResult("flow-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                inputValue: inputValue,
                                conversionType: conversionType
                            }
                        };
                        saveCalculatorState("flow-converter", dataToSave);
                    },
                },

                "tank-calculator": {
                    calculate: function () {
                        const tankShape = document.getElementById("tank-shape").value;
                        const lengthOrDiameter = parseFloat(document.getElementById("tank-length").value);
                        const width = parseFloat(document.getElementById("tank-width").value);
                        const height = parseFloat(document.getElementById("tank-height").value);
                        const flowRateM3H = parseFloat(document.getElementById("tank-flow-rate").value);

                        if (isNaN(lengthOrDiameter) || lengthOrDiameter <= 0) { displayResult("tank-result", "الرجاء إدخال قيمة صحيحة وموجبة للطول أو القطر.", false); return; }
                        if (isNaN(height) || height <= 0) { displayResult("tank-result", "الرجاء إدخال قيمة صحيحة وموجبة للارتفاع.", false); return; }
                        if (isNaN(flowRateM3H) || flowRateM3H <= 0) { displayResult("tank-result", "الرجاء إدخال معدل تدفق صحيح وموجب.", false); return; }

                        let volume = 0;

                        if (tankShape === "cube") {
                            if (isNaN(width) || width <= 0) { displayResult("tank-result", "الرجاء إدخال قيمة صحيحة وموجبة للعرض للخزان المكعب.", false); return; }
                            volume = lengthOrDiameter * width * height;
                        } else {
                            volume = Math.PI * Math.pow(lengthOrDiameter / 2, 2) * height;
                        }

                        if (volume === 0) {
                            displayResult("tank-result", "خطأ في حساب سعة الخزان. تأكد من أن الأبعاد صحيحة وموجبة.", false); return;
                        }
                        const timeToEmptyHours = volume / flowRateM3H;
                        const timeToEmptyMinutes = timeToEmptyHours * 60;

                        const resultMessage = `
                            <h3>ملخص الحسابات:</h3>
                            <ul>
                                <li><strong>شكل الخزان:</strong> ${tankShape === 'cube' ? 'مكعب' : 'أسطواني'}</li>
                                <li><strong>الأبعاد:</strong> ${lengthOrDiameter.toFixed(2)} م (الطول/القطر) ${tankShape === 'cube' ? ' x ' + width.toFixed(2) + ' م (العرض)' : ''} x ${height.toFixed(2)} م (الارتفاع)</li>
                                <li><strong>معدل التدفق:</strong> ${flowRateM3H.toFixed(2)} متر مكعب/ساعة</li>
                            </ul>
                            <h3>النتائج النهائية:</h3>
                            <ul>
                                <li><strong>السعة الكلية للخزان: <span style="color: var(--success-color); font-size: 1.2em;">${volume.toFixed(2)} متر مكعب (م³)</span></strong></li>
                                <li><strong>الوقت اللازم لتفريغ الخزان: <span style="color: var(--success-color); font-size: 1.2em;">${timeToEmptyMinutes.toFixed(2)} دقيقة</span></strong></li>
                            </ul>
                            <p><small>ملاحظة: 1 متر مكعب يعادل 1000 لتر. هذا الحساب يفترض تدفقًا ثابتًا.</small></p>
                        `;

                        displayResult("tank-result", resultMessage, true);
                        const dataToSave = {
                            inputs: {
                                tankShape: tankShape,
                                lengthOrDiameter: lengthOrDiameter,
                                width: width,
                                height: height,
                                flowRateM3H: flowRateM3H
                            }
                        };
                        saveCalculatorState("tank-calculator", dataToSave);
                    },
                },

                "resistance-voltage-drop": {
                    calculate: function () {
                        const voltage = parseFloat(document.getElementById("rvd-voltage").value);
                        const current = parseFloat(document.getElementById("rvd-current").value);
                        const phase = document.getElementById("rvd-phase").value;
                        const powerFactor = parseFloat(document.getElementById("rvd-power-factor").value);
                        const material = document.getElementById("rvd-material").value;
                        const length = parseFloat(document.getElementById("rvd-length").value);
                        const allowedVoltageDropPercentage = parseFloat(document.getElementById("rvd-allowed-voltage-drop-percentage").value);

                        let resistivity;
                        let materialName = "";
                        if (material === "copper") {
                            resistivity = 0.0172;
                            materialName = "النحاس (0.0172 Ω·mm²/m)";
                        } else {
                            resistivity = 0.0282;
                            materialName = "الألمنيوم (0.0282 Ω·mm²/m)";
                        }

                        if (isNaN(voltage) || voltage <= 0) { displayResult("rvd-result", "الرجاء إدخال جهد كهربائي صحيح وموجب.", false); return; }
                        if (isNaN(current) || current <= 0) { displayResult("rvd-result", "الرجاء إدخال تيار كهربائي صحيح وموجب.", false); return; }
                        if (isNaN(length) || length <= 0) { displayResult("rvd-result", "الرجاء إدخال طول موصل صحيح وموجب.", false); return; }
                        if (isNaN(allowedVoltageDropPercentage) || allowedVoltageDropPercentage <= 0 || allowedVoltageDropPercentage > 100) { displayResult("rvd-result", "الحد الأقصى لفقد الجهد المسموح به يجب أن يكون بين 0.1% و 100%.", false); return; }
                        if (isNaN(powerFactor) || powerFactor <= 0.1 || powerFactor > 1) { displayResult("rvd-result", "معامل القدرة يجب أن يكون بين 0.1 و 1.", false); return; }

                        const maxAllowedVoltageDrop = (allowedVoltageDropPercentage / 100) * voltage;

                        if (current === 0 || maxAllowedVoltageDrop === 0) {
                            displayResult("rvd-result", "لا يمكن حساب مساحة المقطع. تأكد من أن التيار والجهد المسموح به لفقد الجهد موجبان وغير صفريين.", false);
                            return;
                        }

                        let requiredArea;
                        if (phase === "single") {
                            requiredArea = (2 * resistivity * length * current * powerFactor) / maxAllowedVoltageDrop;
                        } else {
                            requiredArea = (Math.sqrt(3) * resistivity * length * current * powerFactor) / maxAllowedVoltageDrop;
                        }

                        if (isNaN(requiredArea) || requiredArea <= 0 || !isFinite(requiredArea)) {
                            displayResult("rvd-result", "حدث خطأ في حساب مساحة المقطع. تأكد من صحة المدخلات وأن النتائج منطقية (تجنب القيم الصغيرة جداً أو الكبيرة جداً).", false);
                            return;
                        }

                        let resultMessage = `
                            <h3>ملخص المدخلات:</h3>
                            <ul>
                                <li><strong>الجهد الكهربائي:</strong> ${voltage.toFixed(0)} V</li>
                                <li><strong>التيار الكهربائي:</strong> ${current.toFixed(2)} A</li>
                                <li><strong>نوع الطور:</strong> ${phase === 'single' ? 'أحادي' : 'ثلاثي'}</li>
                                <li><strong>معامل القدرة:</strong> ${powerFactor.toFixed(2)}</li>
                                <li><strong>مادة الموصل:</strong> ${materialName}</li>
                                <li><strong>طول الموصل (اتجاه واحد):</strong> ${length.toFixed(1)} متر</li>
                                <li><strong>الحد الأقصى لفقد الجهد المسموح به:</strong> ${allowedVoltageDropPercentage.toFixed(1)}%</li>
                            </ul>
                            <h3>النتائج النهائية:</h3>
                            <ul>
                                <li>الجهد الأقصى المسموح بفقده: <strong>${maxAllowedVoltageDrop.toFixed(2)} V</strong></li>
                                <li><strong>مساحة المقطع العرضي المطلوبة للموصل: <span style="color: var(--success-color); font-size: 1.2em;">${requiredArea.toFixed(2)} mm²</span></strong></li>
                            </ul>
                            <p><small>ملاحظة: هذا الحساب يوفر الحد الأدنى لمساحة المقطع. يوصى باختيار مقطع عرضي قياسي أكبر قليلاً لضمان الأداء الأمثل.</small></p>
                        `;

                        displayResult("rvd-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                voltage: voltage,
                                current: current,
                                material: material,
                                length: length,
                                allowedVoltageDropPercentage: allowedVoltageDropPercentage,
                                phase: phase,
                                powerFactor: powerFactor
                            }
                        };
                        saveCalculatorState("resistance-voltage-drop", dataToSave);
                    },
                },

                "pulley-calculator": {
                    calculate: function () {
                        const d1 = parseFloat(document.getElementById("pulley-d1").value);
                        const rpm1 = parseFloat(document.getElementById("pulley-rpm1").value);
                        const d2 = parseFloat(document.getElementById("pulley-d2").value);
                        const rpm2 = parseFloat(document.getElementById("pulley-rpm2").value);

                        let knownInputsCount = 0;
                        if (!isNaN(d1) && d1 > 0) knownInputsCount++;
                        if (!isNaN(rpm1) && rpm1 > 0) knownInputsCount++;
                        if (!isNaN(d2) && d2 > 0) knownInputsCount++;
                        if (!isNaN(rpm2) && rpm2 > 0) knownInputsCount++;

                        if (knownInputsCount !== 3) {
                            displayResult("pulley-result", "الرجاء إدخال ثلاث قيم معلومة فقط (موجبة وغير صفرية) وترك حقل واحد فارغًا للمجهول.", false);
                            return;
                        }

                        let unknownValue;
                        let unknownType = "";
                        let resultMessage = "";

                        if (isNaN(d1) || d1 <= 0) {
                            if (rpm1 > 0 && d2 > 0 && rpm2 > 0) {
                                unknownValue = (d2 * rpm2) / rpm1;
                                unknownType = "قطر البكرة الأولى (D1)";
                                resultMessage = `
                                    <p><strong>القيم المدخلة:</strong> D2=${d2} مم, RPM1=${rpm1} RPM, RPM2=${rpm2} RPM</p>
                                    <h3>القيمة المجهولة: <strong>${unknownType} = <span style="color: var(--success-color); font-size: 1.2em;">${unknownValue.toFixed(2)} مم</span></strong></h3>
                                    <p><small>معادلة البكرات: D1 × RPM1 = D2 × RPM2</small></p>
                                `;
                            }
                        } else if (isNaN(rpm1) || rpm1 <= 0) {
                            if (d1 > 0 && d2 > 0 && rpm2 > 0) {
                                unknownValue = (d2 * rpm2) / d1;
                                unknownType = "سرعة البكرة الأولى (RPM1)";
                                resultMessage = `
                                    <p><strong>القيم المدخلة:</strong> D1=${d1} مم, D2=${d2} مم, RPM2=${rpm2} RPM</p>
                                    <h3>القيمة المجهولة: <strong>${unknownType} = <span style="color: var(--success-color); font-size: 1.2em;">${unknownValue.toFixed(2)} RPM</span></strong></h3>
                                    <p><small>معادلة البكرات: D1 × RPM1 = D2 × RPM2</small></p>
                                `;
                            }
                        } else if (isNaN(d2) || d2 <= 0) {
                            if (d1 > 0 && rpm1 > 0 && rpm2 > 0) {
                                unknownValue = (d1 * rpm1) / rpm2;
                                unknownType = "قطر البكرة الثانية (D2)";
                                resultMessage = `
                                    <p><strong>القيم المدخلة:</strong> D1=${d1} مم, RPM1=${rpm1} RPM, RPM2=${rpm2} RPM</p>
                                    <h3>القيمة المجهولة: <strong>${unknownType} = <span style="color: var(--success-color); font-size: 1.2em;">${unknownValue.toFixed(2)} مم</span></strong></h3>
                                    <p><small>معادلة البكرات: D1 × RPM1 = D2 × RPM2</small></p>
                                `;
                            }
                        } else if (isNaN(rpm2) || rpm2 <= 0) {
                            if (d1 > 0 && rpm1 > 0 && d2 > 0) {
                                unknownValue = (d1 * rpm1) / d2;
                                unknownType = "سرعة البكرة الثانية (RPM2)";
                                resultMessage = `
                                    <p><strong>القيم المدخلة:</strong> D1=${d1} مم, RPM1=${rpm1} RPM, D2=${d2} مم</p>
                                    <h3>القيمة المجهولة: <strong>${unknownType} = <span style="color: var(--success-color); font-size: 1.2em;">${unknownValue.toFixed(2)} RPM</span></strong></h3>
                                    <p><small>معادلة البكرات: D1 × RPM1 = D2 × RPM2</small></p>
                                `;
                            }
                        }

                        if (isNaN(unknownValue) || unknownValue <= 0 || !isFinite(unknownValue)) {
                            displayResult("pulley-result", "حدث خطأ في الحساب. تأكد من إدخال ثلاث قيم صحيحة وموجبة وتجنب قسمة على صفر.", false);
                            return;
                        }

                        displayResult("pulley-result", resultMessage, true);

                        const dataToSave = {
                            inputs: {
                                d1: document.getElementById("pulley-d1").value === '' ? null : d1,
                                rpm1: document.getElementById("pulley-rpm1").value === '' ? null : rpm1,
                                d2: document.getElementById("pulley-d2").value === '' ? null : d2,
                                rpm2: document.getElementById("pulley-rpm2").value === '' ? null : rpm2
                            }
                        };
                        saveCalculatorState("pulley-calculator", dataToSave);
                    },
                }
            };

            sectionTitles.forEach(title => {
                title.addEventListener("click", function () {
                    const modalId = this.dataset.modalTarget;
                    const targetModal = document.getElementById(modalId);
                    const calculatorId = targetModal.querySelector('.calculator').id;

                    if (targetModal) {
                        targetModal.classList.add("active");
                        const inputsInModal = targetModal.querySelectorAll('input, select');
                        inputsInModal.forEach(input => {
                            input.classList.remove("error");
                        });
                        loadAndDisplayCalculatorState(calculatorId, targetModal);
                    }
                });
            });

            closeButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const modal = this.closest(".modal");
                    if (modal) {
                        modal.classList.remove("active");
                    }
                });
            });

            modals.forEach(modal => {
                modal.addEventListener("click", function (event) {
                    if (event.target === modal) {
                        modal.classList.remove("active");
                    }
                });
            });

            document.querySelectorAll(".calculator button").forEach(button => {
                button.addEventListener("click", function () {
                    const calculatorId = this.closest(".calculator").id;
                    const originalText = this.innerHTML;

                    this.innerHTML = `<span class="loading"></span> ${originalText}`;
                    this.disabled = true;

                    const inputs = this.closest('.calculator').querySelectorAll('input[type="number"], select');
                    let allInputsValid = true;

                    inputs.forEach(input => {
                        if (input.type === 'number') {
                            if (calculatorId === 'pulley-calculator') {
                                if (input.value !== '' && (isNaN(parseFloat(input.value)) || parseFloat(input.value) <= 0)) {
                                    input.classList.add("error");
                                    allInputsValid = false;
                                } else {
                                    input.classList.remove("error");
                                }
                            } else {
                                const value = parseFloat(input.value);
                                const min = parseFloat(input.min);
                                const max = parseFloat(input.max);
                                if (isNaN(value) || (input.hasAttribute('min') && value < min) || (input.hasAttribute('max') && value > max)) {
                                    input.classList.add("error");
                                    allInputsValid = false;
                                } else {
                                    input.classList.remove("error");
                                }
                            }
                        } else if (input.checkValidity && !input.checkValidity()) {
                            input.classList.add("error");
                            allInputsValid = false;
                        } else {
                            input.classList.remove("error");
                        }
                    });

                    if (calculatorId === 'pulley-calculator') {
                        let emptyCount = 0;
                        inputs.forEach(input => {
                            if (input.id.startsWith('pulley-') && input.value === '') {
                                emptyCount++;
                            }
                        });
                        if (emptyCount !== 1) {
                            displayResult(this.closest('.calculator').querySelector('.result').id, "الرجاء ترك حقل واحد فقط فارغاً للمجهول في حاسبة البكرة.", false);
                            allInputsValid = false;
                            inputs.forEach(input => {
                                if (input.value === '') {
                                    input.classList.add("error");
                                }
                            });
                        } else {
                            inputs.forEach(input => {
                                if (input.value === '') {
                                    input.classList.remove("error");
                                }
                            });
                        }
                    }

                    setTimeout(() => {
                        if (allInputsValid && calculatorFunctions[calculatorId]) {
                            calculatorFunctions[calculatorId].calculate();
                        } else if (!allInputsValid) {
                            displayResult(this.closest('.calculator').querySelector('.result').id, "الرجاء تصحيح الأخطاء في الإدخالات المحددة.", false);
                        } else {
                            console.error(`Calculation function for ID '${calculatorId}' not found.`);
                        }
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 300);
                });
            });

            document.querySelectorAll("input[type='number']").forEach(input => {
                input.addEventListener("input", function () {
                    this.classList.remove("error");

                    if (this.closest('.calculator').id === 'pulley-calculator' || (this.closest('.calculator').id === 'tank-calculator' && this.id === 'tank-width' && this.disabled)) {
                        return;
                    }

                    const value = parseFloat(this.value);
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    let isValid = true;

                    if (this.value === '') {
                        isValid = true;
                    } else if (isNaN(value)) {
                        isValid = false;
                    } else if (this.hasAttribute('min') && value < min) {
                        isValid = false;
                    } else if (this.hasAttribute('max') && value > max) {
                        isValid = false;
                    }

                    if (!isValid) {
                        this.classList.add("error");
                    } else {
                        this.classList.remove("error");
                    }
                });
            });

            const tankShapeSelect = document.getElementById('tank-shape');
            const tankWidthInput = document.getElementById('tank-width');
            const tankWidthGroup = document.getElementById('tank-width-group');
            
            if (tankShapeSelect && tankWidthInput && tankWidthGroup) {
                tankShapeSelect.addEventListener('change', function () {
                    if (this.value === 'cube') {
                        tankWidthGroup.style.display = 'flex';
                        tankWidthInput.disabled = false;
                        tankWidthInput.setAttribute('required', 'required');
                    } else {
                        tankWidthGroup.style.display = 'flex';
                        tankWidthInput.disabled = true;
                        tankWidthInput.removeAttribute('required');
                        tankWidthInput.classList.remove("error");
                    }
                });
                const event = new Event('change');
                tankShapeSelect.dispatchEvent(event);
            }

            const batteryDeviceTypeSelect = document.getElementById('battery-device-type');
            const batteryACFields = document.querySelectorAll('.battery-ac-only');

            if (batteryDeviceTypeSelect && batteryACFields.length > 0) {
                batteryDeviceTypeSelect.addEventListener('change', function () {
                    if (this.value === 'ac') {
                        batteryACFields.forEach(group => group.style.display = 'flex');
                        document.getElementById('battery-device-phase').setAttribute('required', 'required');
                        document.getElementById('battery-device-power-factor').setAttribute('required', 'required');
                        document.getElementById('inverter-efficiency-battery').setAttribute('required', 'required');
                    } else {
                        batteryACFields.forEach(group => {
                            group.style.display = 'none';
                            const input = group.querySelector('input, select');
                            if (input) {
                                if (input.id === 'battery-device-power-factor') {
                                    input.value = '0.8';
                                } else if (input.id === 'inverter-efficiency-battery') {
                                    input.value = '90';
                                } else if (input.id === 'battery-device-phase') {
                                    input.value = 'single';
                                } else {
                                    input.value = '';
                                }
                                input.classList.remove("error");
                                input.removeAttribute('required');
                            }
                        });
                    }
                });
                const event = new Event('change');
                batteryDeviceTypeSelect.dispatchEvent(event);
            }

            const defaultValues = {
                'unit-converter': {
                    'uc-power-factor': "0.8",
                    'uc-input-unit': "kw",
                    'uc-phase': "single"
                },
                'tank-calculator': {
                    'tank-shape': "cube"
                },
                'resistance-voltage-drop': {
                    'rvd-material': "copper",
                    'rvd-allowed-voltage-drop-percentage': "3",
                    'rvd-phase': "single",
                    'rvd-power-factor': "0.8"
                },
                'flow-converter': {
                    'flow-conversion-type': "m3h-to-lps"
                },
                'capacitor-calculator': {
                    'cap-current-pf': "0.7",
                    'cap-desired-pf': "0.95",
                    'cap-frequency': "50",
                    'cap-phase': "single"
                },
                'solar-panels-calculator': {
                    'solar-performance-factor': "80",
                    'inverter-efficiency': "90",
                    'pump-voltage': "230",
                    'pump-phase': "single",
                    'pump-power-factor': "0.8",
                    'ideal-series-voltage': ""
                },
                'battery-calculator': {
                    'battery-dod': "80",
                    'battery-efficiency': "90",
                    'battery-device-type': "dc",
                    'battery-device-phase': "single",
                    'battery-device-power-factor': "0.8",
                    'inverter-efficiency-battery': "90"
                },
                'pulley-calculator': {
                    'pulley-d1': "",
                    'pulley-rpm1': "",
                    'pulley-d2': "",
                    'pulley-rpm2': ""
                }
            };

            function loadAndDisplayCalculatorState(calculatorId, targetElement) {
                // console.log(`Loading and displaying state for ${calculatorId}`); // For debugging
                const resultElement = targetElement.querySelector('.result');

                const savedState = loadCalculatorState(calculatorId);
                if (savedState && savedState.inputs) {
                    // console.log('Found saved state, populating inputs...'); // For debugging
                    populateInputs(calculatorId, savedState.inputs, targetElement);
                } else {
                    // console.log('No saved state, applying defaults.'); // For debugging
                    const inputs = targetElement.querySelectorAll('input[type="number"], select');
                    inputs.forEach(input => {
                        const defaultValue = defaultValues[calculatorId] ? defaultValues[calculatorId][input.id] : undefined;
                        if (defaultValue !== undefined) {
                            input.value = defaultValue;
                        } else {
                            if (calculatorId === 'pulley-calculator' && (input.id === 'pulley-d1' || input.id === 'pulley-rpm1' || input.id === 'pulley-d2' || input.id === 'pulley-rpm2')) {
                                input.value = '';
                            } else {
                                input.value = "";
                            }
                        }
                        input.classList.remove("error");
                    });
                }

                if (resultElement) {
                    let initialResultText = "النتائج: ...";
                    if (calculatorId === 'percentage-calculator') {
                        initialResultText = "الناتج: ...";
                    } else if (calculatorId === 'capacitor-calculator') {
                        initialResultText = "السعة المطلوبة: ...";
                    } else if (calculatorId === 'flow-converter') {
                        initialResultText = "النتيجة: ...";
                    } else if (calculatorId === 'unit-converter') {
                        initialResultText = '<p>النتائج:</p><ul><li>kW: <span>...</span></li><li>kVA: <span>...</span></li><li>HP: <span>...</span></li><li>Ampere: <span>...</span></li></ul>';
                    } else if (calculatorId === 'battery-calculator') {
                        initialResultText = 'النتائج: ...';
                    }

                    resultElement.innerHTML = initialResultText;
                    resultElement.className = "result";
                }

                if (calculatorId === 'tank-calculator' && tankShapeSelect) {
                    const event = new Event('change');
                    tankShapeSelect.dispatchEvent(event);
                }
                if (calculatorId === 'battery-calculator' && batteryDeviceTypeSelect) {
                    const event = new Event('change');
                    batteryDeviceTypeSelect.dispatchEvent(event);
                }
            }
        });
    </script>

</body>
</html>
