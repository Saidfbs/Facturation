<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" >
    <title>بيانات Firebase والإحصائيات (مستقل)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Ethereal Harmony Color Palette (copied for self-containment) */
        :root {
            --primary-bg-light: hsla(220, 10%, 97%, 1);
            --card-bg-white: hsla(0, 0%, 100%, 1);
            --primary-blue-dark: hsla(210, 29%, 29%, 1);
            --accent-blue: hsla(205, 78%, 42%, 1);
            --accent-green: hsla(120, 50%, 50%, 1);
            --accent-orange: hsla(45, 80%, 65%, 1);
            --accent-red: hsla(0, 70%, 55%, 1);
            --text-primary-dark: hsla(210, 10%, 15%, 1);
            --text-secondary-gray: hsla(210, 5%, 40%, 1);
            --text-light: hsla(0, 0%, 100%, 1);
            --border-light: hsla(210, 5%, 90%, 1);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-small: 6px;
            --border-radius-medium: 10px;
            --border-radius-large: 14px;
            --border-radius-pill: 999px;
            --shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.12);
            --shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.18);
        }

        [hidden] {
            display: none !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: var(--spacing-md);
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: var(--primary-bg-light);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--text-primary-dark);
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Specific styles for the Firebase section and its children */
        .firebase-stats-combined-container {
            background-color: transparent;
            box-shadow: none;
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            flex-grow: 1;
            width: 100%;
            /* Ensure it takes full width */
            max-width: 1200px;
            /* Match main container for consistency */
            margin: 0 auto;
            /* Center it */
        }

        .firebase-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            width: 100%;
            flex-grow: 1;
        }

        .main-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xl);
            font-size: 2.4em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .section-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .section-title .icon {
            font-size: 1.3em;
            line-height: 1;
            color: var(--accent-blue);
        }

        .list-subtitle {
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
            text-align: center;
            width: 100%;
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .card-container {
            border: 1px solid var(--border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card-list {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: stretch;
            width: 100%;
        }

        .stat-card {
            background: var(--card-bg-white);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 auto;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-medium);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            width: 80px;
            height: 80px;
            background-color: var(--accent-blue);
            border-radius: var(--border-radius-pill);
            opacity: 0.1;
            transform: scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
        }

        .stat-card:hover::before {
            transform: scale(1);
        }

        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2em;
            color: var(--text-secondary-gray);
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin: 0;
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums;
        }

        .scrollable-list-in-card {
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            background-color: var(--primary-bg-light);
            margin-top: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            gap: var(--spacing-xs);
            justify-content: flex-start;
            align-items: stretch;
            padding: var(--spacing-md);
            list-style: none;
            margin-right: 0;
            margin-left: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) var(--primary-bg-light);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-height: 150px;
            overflow-y: hidden;
            flex-shrink: 0;
        }

        .scrollable-list-in-card.has-more-items {
            max-height: 204px;
            overflow-y: auto;
        }

        .scrollable-list-in-card::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-track {
            background: var(--primary-bg-light);
            border-radius: 10px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
            border: 2px solid var(--primary-bg-light);
            transition: background-color 0.3s ease;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue-dark);
        }

        .scrollable-list-in-card li {
            background-color: var(--card-bg-white);
            padding: 8px 12px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease, border-color 0.3s ease;
        }

        .scrollable-list-in-card li:hover {
            background-color: hsla(210, 30%, 96%, 1);
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .scrollable-list-in-card li span {
            display: block;
            text-align: right;
            white-space: normal;
            word-break: break-word;
        }

        .scrollable-list-in-card li span:first-child {
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xs);
            font-size: 1.1em;
        }

        .scrollable-list-in-card li span:last-child {
            font-weight: normal;
            font-size: 0.95em;
            color: var(--text-secondary-gray);
            flex-shrink: 0;
        }

        #dynamicStatsListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            flex: 1 1 auto;
        }

        #dynamicStatsListContainer>div {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .search-input {
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--card-bg-white);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            padding-left: 45px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%237f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 18px;
        }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.3);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .search-input-wrapper input {
            margin-bottom: 0;
        }

        .clear-search-btn {
            background-color: var(--accent-red);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-subtle);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 45px;
        }

        .clear-search-btn:hover {
            background-color: hsla(350, 70%, 45%, 1);
            transform: translateY(-1px);
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--primary-bg-light);
            border-radius: var(--border-radius-medium);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .firebase-product-list-wrapper>.filter-controls {
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }

        .filter-controls .form-group {
            flex: 1 1 48%;
            min-width: 250px;
            margin-bottom: 0;
        }

        .filter-controls .form-group label {
            display: none;
        }

        .filter-controls select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            font-size: 1em;
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%237f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 12px;
            padding-left: 30px;
            padding-right: 0.8rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .filter-controls select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px hsla(205, 78%, 42%, 0.3);
        }

        .product-list-grid {
            display: grid;
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            padding: var(--spacing-md);
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow-y: visible;
            max-height: none;
            padding-right: 0;
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
        }

        .product-list-grid.invoice-cards-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            justify-items: stretch;
        }

        .mini-invoice-card {
            border: 1px solid var(--border-light);
            border-right: 5px solid var(--accent-blue);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            text-align: right;
            font-size: 0.85em;
            line-height: 1.4;
            cursor: pointer;
            /* Keep cursor pointer for general card click */
            position: relative;
            box-sizing: border-box;
        }

        .mini-invoice-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
            border-right-color: var(--accent-green);
        }

        .mini-invoice-card .invoice-mini-header p,
        .mini-invoice-card .invoice-mini-footer p {
            margin: 2px 0;
            color: var(--text-primary-dark);
        }

        .mini-invoice-card .invoice-mini-header p strong {
            color: var(--primary-blue-dark);
            font-size: 1.1em;
        }

        .mini-product-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.8em;
            width: 100%;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            padding: var(--spacing-xs);
            box-sizing: border-box;
            background-color: var(--primary-bg-light);
        }

        .mini-product-item-header,
        .mini-product-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr;
            gap: var(--spacing-xs);
            align-items: center;
            padding: 4px 6px;
            text-align: right;
        }

        .mini-product-item-header {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row:nth-child(even) {
            background-color: var(--primary-bg-light);
        }

        .mini-product-item-row div {
            white-space: normal;
            word-break: break-word;
            text-align: right;
            color: var(--text-secondary-gray);
        }

        .mini-product-item-row div:first-child {
            color: var(--text-primary-dark);
        }

        .mini-invoice-card .invoice-mini-footer {
            border-top: 1px dashed var(--border-light);
            padding-top: var(--spacing-sm);
            text-align: right;
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-mini-footer p strong {
            color: var(--accent-green);
            font-size: 1.1em;
        }

        .mini-invoice-card .invoice-actions {
            display: none;
            /* Hide actions container */
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light {
            flex: 0 0 auto;
            width: fit-content;
            padding: 0.5rem 1rem;
            height: auto;
            font-size: 0.8em;
            margin-top: 0;
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
        }

        .loader {
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast styles (for this self-contained section) */
        #toast-container-firebase {
            position: fixed;
            bottom: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            pointer-events: none;
            align-items: center;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            padding: var(--spacing-md);
        }

        .toast-firebase {
            background-color: var(--card-bg-white);
            color: var(--text-primary-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
            direction: rtl;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .toast-firebase.success {
            border-right: 5px solid var(--accent-green);
            border-left: none;
        }

        .toast-firebase.error {
            border-right: 5px solid var(--accent-red);
            border-left: none;
        }

        .toast-firebase.info {
            border-right: 5px solid var(--accent-blue);
            border-left: none;
        }

        .toast-firebase .icon {
            font-size: 1.5em;
            line-height: 1;
        }

        .toast-firebase.success .icon {
            color: var(--accent-green);
        }

        .toast-firebase.error .icon {
            color: var(--accent-red);
        }

        .toast-firebase.info .icon {
            color: var(--accent-blue);
        }

        @keyframes fadeinout {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            10% {
                opacity: 1;
                transform: translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* Responsive adjustments for this section */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }

            .stat-card h3 {
                font-size: 1em;
            }

            .stat-card p {
                font-size: 1.4em;
            }

            #dynamicStatsListContainer {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-title {
                font-size: 1.8em;
            }

            .section-title {
                font-size: 1.5em;
            }

            .stat-card p {
                font-size: 1.3em;
            }

            .statistics-section .section-title {
                font-size: 1.5em;
            }

            #dynamicStatsListContainer {
                grid-template-columns: 1fr;
            }

            .filter-controls .form-group {
                min-width: unset;
                flex: 1 1 100%;
            }

            .stat-card-list {
                flex-direction: column;
            }

            .stat-card-list>div {
                flex: 1 1 100%;
            }
        }

        @media (max-width: 480px) {
            .main-title {
                font-size: 1.8em;
            }

            .section-title {
                font-size: 1.5em;
            }

            .stat-card h3 {
                font-size: 0.9em;
            }

            .stat-card p {
                font-size: 1.2em;
            }
        }

        /* Styles for Firebase Product Cards */
        .firebase-product-card {
            border: 1px solid var(--border-light);
            border-right: 5px solid var(--accent-blue);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            text-align: right;
            font-size: 0.85em;
            line-height: 1.4;
            position: relative;
            box-sizing: border-box;
        }

        .firebase-product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
            border-right-color: var(--accent-green);
        }

        .firebase-product-card p {
            margin: 2px 0;
            color: var(--text-primary-dark);
        }

        .firebase-product-card p strong {
            color: var(--primary-blue-dark);
            font-size: 1.1em;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
</head>
<body>
    <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay">
        <h1 class="main-title">بيانات Firebase والإحصائيات</h1>
        <div class="firebase-content-wrapper">
            <section class="statistics-section card-container">
                <h2 class="section-title"><span class="icon"><i class="fas fa-chart-pie"></i></span>إحصائيات
                    المبيعات التفصيلية</h2>
                <div class="filter-controls" style="background-color: transparent; box-shadow: none; padding:0;">
                    <div class="form-group">
                        <label for="commonPhoneDropdown" class="sr-only">تصفية الكل حسب رقم الهاتف</label>
                        <select id="commonPhoneDropdown"></select>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>إجمالي سعر الشراء</h3>
                        <p id="totalPurchaseCost">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي سعر البيع</h3>
                        <p id="totalSellingPrice">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي العمولة</h3>
                        <p id="totalCommission">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي الأرباح</h3>
                        <p id="totalProfit">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي المبيعات (HT)</h3>
                        <p id="totalSalesHT">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي TVA</h3>
                        <p id="totalTVA">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي المبيعات (TTC)</h3>
                        <p id="totalSalesTTC">0.00 DH</p>
                    </div>
                    <div class="stat-card-list">
                        <div id="dynamicStatsListContainer">
                            <div>
                                <h3 class="list-subtitle">المنتجات الأكثر مبيعاً</h3>
                                <ul id="topSellingProductsList" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="list-subtitle">العملاء الأكثر نشاطاً</h3>
                                <ul id="topCustomersList" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="list-subtitle">أصحاب الفواتير الأكثر نشاطاً</h3>
                                <ul id="topInvoiceOwnersList" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="list-subtitle">الموردون الأكثر نشاطاً</h3>
                                <ul id="topSuppliersList" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="search-input-wrapper">
                    <button type="button" class="clear-search-btn" id="clearCommonSearchInput"><span
                            class="icon"><i class="fas fa-times-circle"></i></span>مسح</button>
                    <input type="text" id="commonSearchInput" class="search-input"
                        placeholder="البحث برقم الهاتف، الاسم، أو المنتج" list="allSearchOptions">
                    <datalist id="allSearchOptions"></datalist>
                </div>
            </section>
            <section class="firebase-product-list-wrapper card-container">
                <h2 class="section-title"><span class="icon"><i class="fas fa-boxes"></i></span>قائمة منتجات Firebase
                    (<span id="firebaseProductListCount">0</span>)</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="productPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                        <select id="productPhoneDropdown"></select>
                    </div>
                </div>
                <div class="product-list-grid" id="firebaseProductsContainer">
                    <p class="empty-list-message">لا توجد منتجات لعرضها.</p>
                </div>
                <div class="loader" id="firebaseProductsLoader"></div>
            </section>
            <section class="firebase-invoice-list-wrapper card-container">
                <h2 class="section-title"><span class="icon"><i class="fas fa-cloud"></i></span>قائمة فواتير
                    Firebase (<span id="firebaseInvoiceListCount">0</span>)</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="invoicePhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                        <select id="invoicePhoneDropdown"></select>
                    </div>
                </div>
                <div class="product-list-grid invoice-cards-grid" id="firebaseInvoicesContainer"></div>
                <div class="loader" id="firebaseInvoicesLoader"></div>
            </section>
        </div>
    </section>
    <div id="toast-container-firebase"></div>
    <datalist id="allSearchOptions"></datalist>

    <script>
        // Firebase Configuration (must match your project)
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            UI.showToast("فشل تهيئة Firebase. قد لا تعمل ميزات البيانات السحابية.", 'error');
        }

        // App ID (use __app_id if available in your environment, otherwise provide a default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global Data Stores for this section
        let allFirebaseInvoicesData = []; // Stores invoices after mapping to local keys
        let allFirebaseProductsData = []; // Stores products after mapping to local keys

        // ====== Key Mapping for Firebase (Local Keys <-> French Keys) ======
        // Define mapping from local JavaScript object keys to French keys for Firebase
        const KEY_MAPPING_TO_FIREBASE = {
            // Product Keys (fields within the product object)
            id: 'id', // Keep ID as is for Firebase path
            name: 'nom',
            purchasePrice: 'prixAchat',
            sellingPrice: 'prixVente',
            supplierName: 'nomFournisseur',
            supplierAddress: 'adresseFournisseur',
            supplierPhone: 'telephoneFournisseur',
            stockQuantity: 'quantiteStock',
            date: 'dateCreationProduit', // Specific for product creation date
            quantity: 'quantiteSelectionnee', // Quantity selected for invoice (transient local state)
            isLocal: 'estLocal', // Whether it's a locally managed product
            // Invoice Keys (fields within the invoice object)
            date: 'dateFacture', // Formatted date string for display
            isoDate: 'dateIsoFacture', // ISO string for sorting
            customerName: 'nomClient',
            ownerName: 'nomProprietaire',
            ownerAddress: 'adresseProprietaire',
            ownerPhone: 'telephoneProprietaire', // Used in path and as data
            products: 'produits', // Array of products within invoice
            totalHT: 'totalHT',
            totalHTBeforeCommission: 'totalHTAvantCommission',
            tva: 'tva',
            totalTTC: 'totalTTC',
            totalProfit: 'profitTotal',
            totalCommission: 'commissionTotale',
            invoiceCommissionRate: 'tauxCommissionFacture',
            // Product within Invoice Keys (fields within product objects inside the invoice's products array)
            quantityUsed: 'quantiteUtilisee' // Quantity used in a specific invoice item
        };

        // Create reverse mapping for converting from Firebase French keys back to local keys
        const KEY_MAPPING_FROM_FIREBASE = {};
        for (const localKey in KEY_MAPPING_TO_FIREBASE) {
            KEY_MAPPING_FROM_FIREBASE[KEY_MAPPING_TO_FIREBASE[localKey]] = localKey;
        }

        /**
         * Maps an object's keys from local JavaScript names to French names for Firebase.
         * Keys not found in KEY_MAPPING_TO_FIREBASE are passed through as is (e.g., 'id').
         * Handles nested 'products' array within an invoice object recursively.
         * @param {object} obj - The object with local keys to map.
         * @returns {object} A new object with keys mapped to French for Firebase.
         */
        function mapToFirebaseKeys(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            const newObj = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    if (key === 'products' && Array.isArray(obj[key])) {
                        // Recursively map keys for products array within an invoice
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key].map(p => mapToFirebaseKeys(p));
                    } else {
                        // Map key if a mapping exists, otherwise use the original key
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key];
                    }
                }
            }
            return newObj;
        }

        /**
         * Maps an object's keys from French Firebase names back to local JavaScript names.
         * Keys not found in KEY_MAPPING_FROM_FIREBASE are passed through as is.
         * Handles nested 'produits' array within an invoice object recursively.
         * @param {object} fbObj - The object with French Firebase keys to map.
         * @returns {object} A new object with keys mapped back to local JavaScript names.
         */
        function mapFromFirebaseKeys(fbObj) {
            if (fbObj === null || typeof fbObj !== 'object') {
                return fbObj;
            }

            const newObj = {};
            for (const fbKey in fbObj) {
                if (fbObj.hasOwnProperty(fbKey)) {
                    // Find the local key that maps to this Firebase key
                    const localKey = KEY_MAPPING_FROM_FIREBASE[fbKey];
                    if (fbKey === 'produits' && Array.isArray(fbObj[fbKey])) {
                        // Recursively map keys for 'produits' array
                        newObj[localKey || fbKey] = fbObj[fbKey].map(p => mapFromFirebaseKeys(p));
                    } else {
                        // Map key if a reverse mapping exists, otherwise use the original Firebase key
                        newObj[localKey || fbKey] = fbObj[fbKey];
                    }
                }
            }
            return newObj;
        }

        // ====== UI Elements References for this section ======
        let UIElements; // Declare UIElements here, assign inside window.onload

        // ====== UI Utility Functions (minimal set for this section) ======
        const UI = {
            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast-firebase', type); // Use specific class for this module's toasts
                let iconHtml = '';
                if (type === 'success') { iconHtml = '<span class="icon"><i class="fas fa-check"></i></span>'; }
                else if (type === 'error') { iconHtml = '<span class="icon"><i class="fas fa-times"></i></span>'; }
                else if (type === 'info') { iconHtml = '<span class="icon"><i class="fas fa-info-circle"></i></span>'; }
                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            },
            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('active', isLoading);
                }
            },
            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            }
        };

        // ====== Firebase Data & Statistics Logic (extracted) ======
        const FirebaseData = {
            init: () => {
                // Now UIElements are guaranteed to be defined
                UIElements.commonSearchInput.addEventListener('input', FirebaseData.applyCombinedFilters);
                UIElements.clearCommonSearchInputButton.addEventListener('click', FirebaseData.clearAndFilter);

                // Event listeners for phone dropdowns
                UIElements.commonPhoneDropdown.addEventListener('change', FirebaseData.applyCombinedFilters);
                UIElements.productPhoneDropdown.addEventListener('change', FirebaseData.applyCombinedFilters);
                UIElements.invoicePhoneDropdown.addEventListener('change', FirebaseData.applyCombinedFilters);

                // Ensure search input has style
                UIElements.commonSearchInput.classList.add('search-input');
            },
            // Populates phone number dropdowns from Firebase data structure
            populatePhoneDropdowns: (phoneNumbers) => {
                const dropdowns = [
                    UIElements.commonPhoneDropdown,
                    UIElements.productPhoneDropdown,
                    UIElements.invoicePhoneDropdown
                ];
                dropdowns.forEach(dropdown => {
                    dropdown.innerHTML = '<option value="all">عرض الكل</option>';
                    Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                        const option = document.createElement('option');
                        option.value = phoneNumber;
                        option.textContent = phoneNumber;
                        dropdown.appendChild(option);
                    });
                });
            },
            // Fetches all data (invoices and products) from Firebase
            fetchAndDisplayCombinedFirebaseData: async () => {
                UI.toggleGeneralLoader(UIElements.firebaseLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, true);
                UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, true);

                if (!database) {
                    UI.showToast("قاعدة بيانات Firebase غير جاهزة لجلب البيانات.", 'info');
                    UI.toggleGeneralLoader(UIElements.firebaseLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                    return;
                }

                const alldataRef = database.ref(`${appId}/alldata`);

                try {
                    const snapshot = await alldataRef.once('value');
                    const data = snapshot.val();

                    allFirebaseInvoicesData = [];
                    // Using a Map to handle unique products, avoiding duplicates from different sources
                    const uniqueProductsMap = new Map();
                    const uniquePhoneNumbers = new Set();

                    if (data) {
                        for (const phoneKey in data) {
                            if (data.hasOwnProperty(phoneKey)) {
                                uniquePhoneNumbers.add(phoneKey); // Collect all phone numbers
                                const phoneData = data[phoneKey];

                                // Process Invoices
                                if (phoneData.invoices) {
                                    for (const invoiceFirebaseKey in phoneData.invoices) {
                                        if (phoneData.invoices.hasOwnProperty(invoiceFirebaseKey)) {
                                            const invoiceDetails = mapFromFirebaseKeys(phoneData.invoices[invoiceFirebaseKey]);
                                            // Ensure id is present or create a stable one for the invoice
                                            invoiceDetails.id = invoiceDetails.id || invoiceFirebaseKey;

                                            allFirebaseInvoicesData.push({
                                                firebaseId: invoiceFirebaseKey, // Firebase's unique key for this invoice
                                                firebasePhoneKey: phoneKey, // The phone key under which this invoice is
                                                ...invoiceDetails
                                            });

                                            // Process products within this invoice
                                            if (invoiceDetails.products && Array.isArray(invoiceDetails.products)) {
                                                invoiceDetails.products.forEach((product, index) => {
                                                    // Generate a more robust ID for products coming from invoices if they don't have one
                                                    // This ensures uniqueness for product display in case original IDs are missing or conflicting
                                                    const productId = product.id || `${phoneKey}-${invoiceFirebaseKey}-${index}`;

                                                    uniqueProductsMap.set(productId, {
                                                        id: productId,
                                                        firebasePhoneKey: phoneKey,
                                                        invoiceId: invoiceFirebaseKey, // Link to its invoice
                                                        invoiceDate: invoiceDetails.date,
                                                        customerName: invoiceDetails.customerName,
                                                        ownerName: invoiceDetails.ownerName,
                                                        ownerPhone: invoiceDetails.ownerPhone,
                                                        ...product // Contains product details with local keys
                                                    });
                                                });
                                            }
                                        }
                                    }
                                }

                                // Process standalone Products (if they exist directly under phoneKey)
                                // This assumes products are stored directly under `/alldata/{phone}/products`
                                if (phoneData.products) {
                                    for (const productId in phoneData.products) {
                                        if (phoneData.products.hasOwnProperty(productId)) {
                                            const productDetails = mapFromFirebaseKeys(phoneData.products[productId]);
                                            // Add or update product in the uniqueProductsMap
                                            uniqueProductsMap.set(productId, {
                                                id: productId, // Use the actual product ID from Firebase
                                                firebasePhoneKey: phoneKey, // The phone key under which it was found
                                                ...productDetails
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Convert Map values back to an array for display
                    allFirebaseProductsData = Array.from(uniqueProductsMap.values());

                    // Populate phone dropdowns with collected numbers
                    FirebaseData.populatePhoneDropdowns(uniquePhoneNumbers);

                    // Populate datalist for search within this module
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProductsData, 'name');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'customerName');
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseInvoicesData, 'ownerName');
                    // Add phone numbers to search options from the unique set
                    UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, Array.from(uniquePhoneNumbers).map(p => ({ value: p })), 'value');

                    FirebaseData.applyCombinedFilters(); // Apply filters after fetching data
                    UI.showToast("تم جلب جميع البيانات من Firebase بنجاح.", 'success');
                } catch (error) {
                    UI.showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                    console.error("Failed to fetch Firebase data:", error);
                } finally {
                    UI.toggleGeneralLoader(UIElements.firebaseLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseProductsLoader, false);
                    UI.toggleGeneralLoader(UIElements.firebaseInvoicesLoader, false);
                }
            },
            // Applies search and phone filters to both invoices and products
            applyCombinedFilters: () => {
                const searchTerm = UIElements.commonSearchInput.value.toLowerCase();
                const selectedInvoicePhoneNumber = UIElements.invoicePhoneDropdown.value;
                const selectedProductPhoneNumber = UIElements.productPhoneDropdown.value;
                const selectedCommonPhoneNumber = UIElements.commonPhoneDropdown.value; // Get value from the new dropdown

                // Filter Invoices
                const filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                    const matchesSearch = searchTerm ?
                        ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                            (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm) || (p.supplierName || '').toLowerCase().includes(searchTerm))))
                        : true;

                    const matchesInvoicePhone = (selectedInvoicePhoneNumber === 'all' || invoice.ownerPhone === selectedInvoicePhoneNumber);
                    const matchesCommonPhone = (selectedCommonPhoneNumber === 'all' || invoice.ownerPhone === selectedCommonPhoneNumber);

                    return matchesSearch && matchesInvoicePhone && matchesCommonPhone;
                });

                // Filter Products
                const filteredProducts = allFirebaseProductsData.filter(product => {
                    const matchesSearch = searchTerm ?
                        ((product.name || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                            (product.supplierPhone && product.supplierPhone.includes(searchTerm)) ||
                            (product.customerName || '').toLowerCase().includes(searchTerm) || // Products can also be linked to customer via invoice
                            (product.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (product.ownerPhone && product.ownerPhone.includes(searchTerm)))
                        : true;

                    const matchesProductPhone = (selectedProductPhoneNumber === 'all' || product.firebasePhoneKey === selectedProductPhoneNumber);
                    const matchesCommonPhone = (selectedCommonPhoneNumber === 'all' || product.firebasePhoneKey === selectedCommonPhoneNumber);


                    return matchesSearch && matchesProductPhone && matchesCommonPhone;
                });

                UIElements.firebaseInvoiceListCountSpan.textContent = filteredInvoices.length;
                UIElements.firebaseProductListCountSpan.textContent = filteredProducts.length;

                filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // Sort products by name

                FirebaseData.displayFirebaseInvoices(filteredInvoices);
                FirebaseData.displayFirebaseProducts(filteredProducts); // Display filtered products
                FirebaseData.displayStatistics(filteredInvoices); // Statistics based on filtered invoices
            },
            clearAndFilter: () => {
                UIElements.commonSearchInput.value = '';
                UIElements.commonPhoneDropdown.value = 'all';
                UIElements.productPhoneDropdown.value = 'all';
                UIElements.invoicePhoneDropdown.value = 'all';
                FirebaseData.applyCombinedFilters();
                UI.showToast("تم مسح حقول البحث وتحديث القوائم.", 'info');
            },
            // Displays invoices in the dedicated container
            displayFirebaseInvoices: (invoices) => {
                UIElements.firebaseInvoicesContainer.innerHTML = '';
                if (invoices.length === 0) {
                    UIElements.firebaseInvoicesContainer.innerHTML = '<p class="empty-list-message">لا توجد فواتير لعرضها.</p>';
                    return;
                }
                invoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('mini-invoice-card');
                    invoiceDiv.dataset.invoiceId = invoice.id;
                    invoiceDiv.dataset.firebasePhoneKey = invoice.firebasePhoneKey;
                    let productsListHtml = '<p style="text-align: center; font-style: italic; color: var(--text-secondary-gray);">لا توجد منتجات في هذه الفاتورة.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="mini-product-list">
                                <div class="mini-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية</div>
                                    <div>الإجمالي (HT)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="mini-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.quantityUsed || 0}</div>
                                        <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    invoiceDiv.innerHTML = `
                        <div class="invoice-mini-header">
                            <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                            <p><strong>الهاتف:</strong> ${invoice.ownerPhone || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="invoice-mini-footer">
                            <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                            <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                        </div>
                    `;
                    UIElements.firebaseInvoicesContainer.appendChild(invoiceDiv);
                });
            },
            // NEW: Displays products in the dedicated container
            displayFirebaseProducts: (products) => {
                UIElements.firebaseProductsContainer.innerHTML = '';
                if (products.length === 0) {
                    UIElements.firebaseProductsContainer.innerHTML = '<p class="empty-list-message">لا توجد منتجات لعرضها.</p>';
                    return;
                }
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('firebase-product-card'); // Use a distinct class for product cards
                    productDiv.dataset.productId = product.id;
                    productDiv.dataset.firebasePhoneKey = product.firebasePhoneKey;
                    productDiv.innerHTML = `
                        <p><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                        <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                        <p><strong>الكمية في المخزون:</strong> ${product.stockQuantity || 0}</p>
                        ${product.invoiceDate ? `<p><strong>تاريخ آخر فاتورة:</strong> ${product.invoiceDate}</p>` : ''}
                        ${product.customerName ? `<p><strong>عميل آخر فاتورة:</strong> ${product.customerName}</p>` : ''}
                        ${product.ownerName ? `<p><strong>مالك آخر فاتورة:</strong> ${product.ownerName}</p>` : ''}
                    `;
                    UIElements.firebaseProductsContainer.appendChild(productDiv);
                });
            },
            // Calculates and displays various statistics based on filtered invoices
            displayStatistics: (invoices) => {
                let totalSalesHT = 0;
                let totalTVA = 0;
                let totalSalesTTC = 0;
                let totalOverallProfit = 0;
                let totalOverallCommission = 0;
                let totalPurchaseCostAllProducts = 0;
                let totalSellingPriceAllProducts = 0;

                const productSales = {}; // { productName: { quantitySold, totalRevenue } }
                const customerActivity = {}; // { customerName: { invoiceCount, totalProfit, totalTTC } }
                const invoiceOwnerActivity = {}; // { ownerName: { invoiceCount, totalProfit, totalTTC } }
                const supplierActivity = {}; // { supplierName: { totalPurchaseCost, productsCount } }

                invoices.forEach(invoice => {
                    totalSalesHT += parseFloat(invoice.totalHT || 0);
                    totalTVA += parseFloat(invoice.tva || 0);
                    totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                    totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                    totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                    if (invoice.products) {
                        invoice.products.forEach(product => {
                            const productName = product.name || 'N/A';
                            const quantityUsed = parseInt(product.quantityUsed || 0);
                            const purchasePrice = parseFloat(product.purchasePrice || 0);
                            const sellingPrice = parseFloat(product.sellingPrice || 0);
                            // Use product.supplierName from product object, fallback to invoice owner if product doesn't have it
                            const supplierName = product.supplierName || invoice.ownerName || 'N/A';

                            totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                            totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                            productSales[productName] = (productSales[productName] || { quantitySold: 0, totalRevenue: 0 });
                            productSales[productName].quantitySold += quantityUsed;
                            productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                            supplierActivity[supplierName] = (supplierActivity[supplierName] || { totalPurchaseCost: 0, productsCount: 0 });
                            supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                            supplierActivity[supplierName].productsCount += quantityUsed;
                        });
                    }

                    const customer = invoice.customerName || 'N/A';
                    const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                    const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                    const owner = invoice.ownerName || 'N/A';

                    customerActivity[customer] = (customerActivity[customer] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    customerActivity[customer].invoiceCount += 1;
                    customerActivity[customer].totalProfit += invoiceProfit;
                    customerActivity[customer].totalTTC += invoiceTTC;

                    invoiceOwnerActivity[owner] = (invoiceOwnerActivity[owner] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    invoiceOwnerActivity[owner].invoiceCount += 1;
                    invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                    invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
                });

                // Update display elements
                UIElements.totalPurchaseCost.textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
                UIElements.totalSellingPrice.textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
                UIElements.totalCommission.textContent = `${totalOverallCommission.toFixed(2)} DH`;
                UIElements.totalProfit.textContent = `${totalOverallProfit.toFixed(2)} DH`;
                UIElements.totalSalesHT.textContent = `${totalSalesHT.toFixed(2)} DH`;
                UIElements.totalTVA.textContent = `${totalTVA.toFixed(2)} DH`;
                UIElements.totalSalesTTC.textContent = `${totalSalesTTC.toFixed(2)} DH`;

                // Prepare data for top lists
                const topSellingProductsData = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 10).map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue }));
                const topCustomersData = Object.entries(customerActivity).sort(([, a], [, b]) => b.totalTTC - a.totalTTC).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC }));
                const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity).sort(([, a], [, b]) => b.totalProfit - a.totalProfit).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit }));
                const topSuppliersData = Object.entries(supplierActivity).sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost).slice(0, 10).map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount }));

                // Render top lists
                FirebaseData.renderSimpleList(UIElements.topSellingProductsList, topSellingProductsData, (item) => item.name, (item) => `الكمية: ${item.value} وحدة - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topCustomersList, topCustomersData, (item) => item.name, (item) => `فواتير: ${item.value} - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topInvoiceOwnersList, topInvoiceOwnersData, (item) => item.name, (item) => `فواتير: ${item.value} - الربح: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topSuppliersList, topSuppliersData, (item) => item.name, (item) => `الشراء: ${item.value.toFixed(2)} DH - المنتجات: ${item.secondaryValue}`);
            },
            // Generic function to render simple lists (e.g., top products, customers)
            renderSimpleList: (listEl, data, primaryTextFn, secondaryTextFn) => {
                listEl.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span><strong>${primaryTextFn(item)}</strong></span><span>${secondaryTextFn(item)}</span>`;
                        // Add data-searchTerm for direct search functionality on click
                        li.dataset.searchTerm = primaryTextFn(item); // Use primary text for search term
                        li.addEventListener('click', () => {
                            UIElements.commonSearchInput.value = li.dataset.searchTerm;
                            FirebaseData.applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                    listEl.classList.toggle('has-more-items', listEl.children.length > 3);
                } else {
                    listEl.innerHTML = '<li>لا توجد بيانات</li>';
                    listEl.classList.remove('has-more-items');
                }
            }
        };

        // ====== Initialization on Window Load for this section ======
        window.addEventListener('load', () => {
            // Initialize UIElements after the DOM is fully loaded
            UIElements = {
                firebaseProductsDisplay: document.getElementById('firebaseProductsDisplay'),
                // Make sure this ID matches your HTML for the new dropdown
                commonPhoneDropdown: document.getElementById('commonPhoneDropdown'), 
                productPhoneDropdown: document.getElementById('productPhoneDropdown'),
                invoicePhoneDropdown: document.getElementById('invoicePhoneDropdown'),
                commonSearchInput: document.getElementById('commonSearchInput'),
                clearCommonSearchInputButton: document.getElementById('clearCommonSearchInput'),
                allSearchOptionsDatalist: document.getElementById('allSearchOptions'),
                firebaseProductListCountSpan: document.getElementById('firebaseProductListCount'),
                firebaseInvoiceListCountSpan: document.getElementById('firebaseInvoiceListCount'),
                firebaseProductsContainer: document.getElementById('firebaseProductsContainer'),
                firebaseInvoicesContainer: document.getElementById('firebaseInvoicesContainer'),
                firebaseLoader: document.getElementById('firebaseLoader'),
                firebaseProductsLoader: document.getElementById('firebaseProductsLoader'),
                firebaseInvoicesLoader: document.getElementById('firebaseInvoicesLoader'),
                totalPurchaseCost: document.getElementById('totalPurchaseCost'),
                totalSellingPrice: document.getElementById('totalSellingPrice'),
                totalCommission: document.getElementById('totalCommission'),
                totalProfit: document.getElementById('totalProfit'),
                totalSalesHT: document.getElementById('totalSalesHT'),
                totalTVA: document.getElementById('totalTVA'),
                totalSalesTTC: document.getElementById('totalSalesTTC'),
                dynamicStatsListContainer: document.getElementById('dynamicStatsListContainer'),
                topSellingProductsList: document.getElementById('topSellingProductsList'),
                topCustomersList: document.getElementById('topCustomersList'),
                topInvoiceOwnersList: document.getElementById('topInvoiceOwnersList'),
                topSuppliersList: document.getElementById('topSuppliersList'),
                toastContainer: document.getElementById('toast-container-firebase'),
            };
            FirebaseData.init(); // Initialize event listeners
            FirebaseData.fetchAndDisplayCombinedFirebaseData(); // Fetch and display all data

            // Initially display the section (it's standalone)
            UIElements.firebaseProductsDisplay.hidden = false;
        });
    </script>
</body>
</html>
