<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون - لوحة معلومات عصرية ومحدثة</title>

    <!-- Google Fonts: Cairo for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for modern icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Custom CSS styles -->
    <style>
        /* Ethereal Harmony Color Palette */
        :root {
            --primary-bg-light: hsla(220, 10%, 97%, 1); /* Very light, subtle off-white */
            --card-bg-white: hsla(0, 0%, 100%, 1);      /* Pure white for cards */
            --primary-blue-dark: hsla(210, 29%, 29%, 1); /* Deep Teal-Blue */
            --accent-blue: hsla(205, 78%, 42%, 1);       /* Vibrant Blue */
            --accent-green: hsla(120, 50%, 50%, 1);     /* Lively Green (Success) */
            --accent-orange: hsla(45, 80%, 65%, 1);      /* Warm Gold (Warning) */
            --accent-red: hsla(0, 70%, 55%, 1);          /* Muted Red (Danger) */

            --text-primary-dark: hsla(210, 10%, 15%, 1); /* Near black for primary text */
            --text-secondary-gray: hsla(210, 5%, 40%, 1); /* Softer gray for secondary text */
            --text-light: hsla(0, 0%, 100%, 1);          /* White for text on dark backgrounds */

            --border-light: hsla(210, 5%, 90%, 1); /* Very light gray for borders */

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            --border-radius-small: 6px;
            --border-radius-medium: 10px;
            --border-radius-large: 14px;
            --border-radius-pill: 999px;

            --shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.12);
            --shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.18);
        }

        /* Base styles and resets */
        [hidden] {
            display: none !important;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: var(--primary-bg-light);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--text-primary-dark);
            font-size: 16px; /* Base font size for desktop */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            padding: var(--spacing-md);
            padding-bottom: calc(var(--spacing-md) + 60px); /* Space for mobile nav */
        }

        /* Main controls for desktop navigation */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
            display: none; /* Hidden by default, shown on desktop */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--text-secondary-gray);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-large);
            text-align: center;
            background-color: transparent;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-decoration: none;
        }

        .main-controls .btn-panel .icon {
            font-size: 1.2em;
            line-height: 1;
        }

        .main-controls .btn-panel:hover {
            background-color: var(--primary-bg-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
            color: var(--text-primary-dark);
        }

        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px hsla(205, 78%, 42%, 0.3);
        }

        /* Active button state */
        .main-controls .btn-panel.active {
            background-color: var(--accent-blue);
            color: var(--text-light);
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px);
            border: 2px solid var(--accent-blue);
        }

        .main-controls .btn-panel.active:hover {
            background-color: var(--accent-blue);
            transform: translateY(-4px);
        }

        /* Bottom navigation bar (fixed for mobile) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-bg-white);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--spacing-sm) 0;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* Hidden by default, shown on mobile */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .bottom-nav .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary-gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xs);
            gap: var(--spacing-xs);
            font-size: 0.85em;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease;
            border-radius: var(--border-radius-medium);
            flex: 1;
            max-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .bottom-nav .nav-button .icon {
            font-size: 1.8em;
            line-height: 1;
        }

        .bottom-nav .nav-button:hover {
            background-color: var(--primary-bg-light);
            transform: translateY(-3px);
            color: var(--text-primary-dark);
        }

        /* Ripple effect for mobile nav buttons */
        .bottom-nav .nav-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(0, 0, 0, 0.05) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .bottom-nav .nav-button:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        /* Active mobile nav button */
        .bottom-nav .nav-button.active {
            color: var(--accent-blue);
            background-color: var(--primary-bg-light);
            transform: translateY(-6px);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05), 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav .nav-button.active .icon {
            transform: scale(1.25);
            transition: transform 0.3s ease;
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px; /* Max width for desktop content */
            margin: 0 auto;
            transition: max-width 0.3s ease, padding 0.3s ease;
        }

        /* Full width for specific sections */
        .container.full-width {
            max-width: 100%;
            margin: 0;
            padding: 0;
            height: 100%;
            box-sizing: border-box;
        }

        /* Ensure direct children of full-width container have internal padding */
        .container.full-width > section,
        .container.full-width > article {
            padding-left: var(--spacing-md);
            padding-right: var(--spacing-md);
            box-sizing: border-box;
            flex-grow: 1;
        }

        /* Unified card container styles for all main content sections */
        .card-container {
            border: 1px solid var(--border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Local archive container takes full width and available height */
        /* Changed to transparent container for multiple cards inside */
        .local-archive-container {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            padding: var(--spacing-md); /* Add internal padding for the transparent wrapper */
            flex-grow: 1;
            box-sizing: border-box;
            background-color: transparent; /* Explicitly set to transparent */
            box-shadow: none;
            border: none;
            display: flex; /* Enable flex for its children (newly added cards) */
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* Special style for combined Firebase stats container (transparent wrapper) */
        .firebase-stats-combined-container {
            background-color: transparent;
            box-shadow: none;
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* Class for fade-in/fade-out animation on section visibility */
        .fade-in-section {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-in-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Dashboard view layout */
        .dashboard-view {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: flex-start;
            width: 100%;
        }

        /* Unified main titles (h1) */
        .main-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xl);
            font-size: 2.4em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        /* Unified section titles (h2) */
        .section-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .section-title .icon {
            font-size: 1.3em;
            line-height: 1;
            color: var(--accent-blue); /* Section title icon color */
        }

        /* Subtitles for lists/sections within main containers (h3) */
        .list-subtitle {
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
            text-align: center;
            width: 100%;
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        /* Specific override for h3 within stat cards - smaller, no border, dark text */
        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2em;
            color: var(--text-secondary-gray);
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Adjust width of individual containers within dashboard view */
        .dashboard-view > .product-form-section,
        .dashboard-view > .invoice-creation-section {
            flex: 1 1 48%; /* Allows two columns on wider screens */
            min-width: 350px; /* Minimum width before wrapping */
        }

        /* Saved products list below forms */
        .dashboard-view > .saved-products-section {
            flex: 1 1 100%; /* Takes full width */
            margin-top: var(--spacing-md);
        }

        /* Layout for combined Firebase/stats container */
        .firebase-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            width: 100%;
            flex-grow: 1;
        }

        /* Styles for lists that should display full content without scrolling (saved products, Firebase products) */
        .product-list-grid {
            display: grid;
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            padding: var(--spacing-md);
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow-y: visible; /* Ensure full content is visible by default */
            max-height: none; /* Allow content to dictate height */
            padding-right: 0;
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
        }

        /* Specific grid columns for saved products */
        .product-list-grid.saved-products-grid {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        /* Specific grid columns for invoice-like cards (Firebase and Local) */
        .product-list-grid.invoice-cards-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            justify-items: stretch;
        }

        /* Styles for .scrollable-list-in-card (used for dynamic stats lists) - stacked appearance */
        .scrollable-list-in-card {
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            background-color: var(--primary-bg-light); /* Lighter background for nested scrollable lists */
            margin-top: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            gap: var(--spacing-xs);
            justify-content: flex-start;
            align-items: stretch;
            padding: var(--spacing-md);
            list-style: none;
            margin-right: 0;
            margin-left: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) var(--primary-bg-light);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-height: 150px;
            overflow-y: hidden; /* Default to hidden */
            flex-shrink: 0;
        }

        /* Styles to make .scrollable-list-in-card scrollable when it has more than 3 items */
        .scrollable-list-in-card.has-more-items {
            max-height: 204px; /* Sufficient for 3 full items. Adjust based on exact line heights if needed. */
            overflow-y: auto;
        }

        /* Custom scrollbar for scrollable lists */
        .scrollable-list-in-card::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-track {
            background: var(--primary-bg-light);
            border-radius: 10px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
            border: 2px solid var(--primary-bg-light);
            transition: background-color 0.3s ease;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue-dark);
        }

        .scrollable-list-in-card li {
            background-color: var(--card-bg-white);
            padding: 8px 12px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end; /* Align right for RTL */
            width: 100%;
            box-sizing: border-box;
            text-align: right;
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease, border-color 0.3s ease;
        }

        .scrollable-list-in-card li:hover {
            background-color: hsla(210, 30%, 96%, 1); /* Slightly darker on hover */
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .scrollable-list-in-card li:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        .scrollable-list-in-card li span {
            display: block;
            text-align: right;
            white-space: normal;
            word-break: break-word;
        }

        .scrollable-list-in-card li span:first-child {
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xs);
            font-size: 1.1em;
        }

        .scrollable-list-in-card li span:last-child {
            font-weight: normal;
            font-size: 0.95em;
            color: var(--text-secondary-gray);
            flex-shrink: 0;
        }

        /* Make #dynamicStatsListContainer a grid for its children (individual stat list cards) */
        #dynamicStatsListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            flex: 1 1 auto;
        }

        /* Styles for individual dynamic list cards (e.g., top products, top customers) */
        #dynamicStatsListContainer > div {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Chart-specific styles */
        .chart-container {
            position: relative;
            height: 200px; /* Fixed height for charts */
            width: 100%;
            margin-top: var(--spacing-md);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: center;
        }

        p {
            margin: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--text-primary-dark);
            font-size: 0.95em;
            transition: color 0.3s ease;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--accent-red);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--text-primary-dark);
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.3);
            transform: scale(1.005);
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown),
        .form-group input.error, .form-group select.error {
            border-color: var(--accent-red);
        }

        .form-group .validation-error-message {
            color: var(--accent-red);
            font-size: 0.85em;
            padding-right: var(--spacing-xs);
            margin-top: 5px;
            display: none;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message,
        .form-group input.error + .validation-error-message, .form-group select.error + .validation-error-message {
            display: flex;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* General button styles */
        .btn-base {
            display: flex;
            flex: 1;
            height: 50px;
            padding: 1rem 0;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            box-shadow: var(--shadow-medium);
            font-size: 0.95em;
            outline: none;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            background-color: var(--accent-blue);
            background-image: linear-gradient(135deg, var(--accent-blue), hsla(205, 78%, 35%, 1));
        }

        .btn-base:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 3px;
            box-shadow: 0 0 0 5px hsla(205, 78%, 42%, 0.4);
        }

        .btn-primary {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
        }

        .btn-primary:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), hsla(210, 29%, 22%, 1));
        }

        .btn-success {
            background-color: var(--accent-green);
            background-image: linear-gradient(135deg, var(--accent-green), hsla(135, 60%, 35%, 1));
        }

        .btn-success:hover {
            background-image: linear-gradient(135deg, hsla(135, 60%, 35%, 1), var(--accent-green));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-success:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(135, 60%, 35%, 1), hsla(135, 60%, 35%, 1));
        }

        .btn-danger {
            background-color: var(--accent-red);
            background-image: linear-gradient(135deg, var(--accent-red), hsla(350, 70%, 45%, 1));
            margin-top: var(--spacing-sm);
        }

        .btn-danger:hover {
            background-image: linear-gradient(135deg, hsla(350, 70%, 45%, 1), var(--accent-red));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(350, 70%, 45%, 1), hsla(350, 70%, 45%, 1));
        }

        .btn-warning {
            background-color: var(--accent-orange);
            background-image: linear-gradient(135deg, var(--accent-orange), hsla(39, 90%, 50%, 1));
            color: var(--text-primary-dark);
            margin-top: var(--spacing-sm);
        }

        .btn-warning:hover {
            background-image: linear-gradient(135deg, hsla(39, 90%, 50%, 1), var(--accent-orange));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-warning:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(39, 90%, 50%, 1), hsla(39, 90%, 50%, 1));
        }

        .btn-secondary-light { /* For "Add to Local" button */
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
            color: var(--text-light);
        }

        .btn-secondary-light:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-secondary-light:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        /* Invoice specific styles (full view) */
        .invoice-header-section {
            border: none;
            background-color: var(--primary-bg-light);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            align-items: flex-end; /* Align right for RTL */
        }

        .invoice-header-section h2 {
            width: 100%;
            text-align: center;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            color: var(--primary-blue-dark);
        }

        .invoice-header-section p {
            width: 100%; /* Make each paragraph take full width on small screens */
            text-align: right;
            font-size: 1em;
            color: var(--text-primary-dark);
        }

        /* Enhance invoice summary table appearance */
        .invoice-summary-section {
            background-color: var(--primary-bg-light);
            text-align: center;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            margin-bottom: var(--spacing-md);
            transition: background-color 0.3s ease;
        }

        .invoice-summary-section table {
            width: 100%;
            margin: 0 auto;
            border-collapse: separate; /* Use this with border-spacing */
            border-spacing: 0 5px; /* Space between rows */
        }

        .invoice-summary-section tfoot tr td {
            text-align: right;
            font-weight: bold;
            padding: 0.5rem 1rem;
            color: var(--text-primary-dark);
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            box-shadow: var(--shadow-subtle);
        }

        .invoice-summary-section tfoot tr:last-child td {
            background-color: var(--accent-blue);
            color: var(--text-light);
            font-size: 1.1em;
            box-shadow: var(--shadow-medium);
        }

        /* Responsive table wrapper */
        .table-responsive {
            overflow-x: auto; /* Allows horizontal scrolling for large tables on small screens */
            -webkit-overflow-scrolling: touch; /* Improves scrolling on iOS */
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            border: 1px solid var(--border-light);
            background-color: var(--card-bg-white);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg-white);
            font-size: 0.95em;
            border: none;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--border-light);
            padding: 0.6rem;
            text-align: right;
            white-space: nowrap; /* Prevent text wrapping in table cells by default */
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .invoice-table th {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: left; /* Align amounts to the left in RTL */
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.1em;
        }

        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
            color: var(--text-primary-dark);
        }

        .invoice .divider {
            border-top: 1px dashed var(--border-light);
            margin: var(--spacing-lg) 0;
            transition: border-color 0.3s ease;
        }

        /* Unified product/item cards */
        .product-card {
            border: 1px solid var(--border-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end; /* Align right for RTL */
            text-align: right;
            font-size: 0.95em;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
        }

        /* Status indicators for product cards (left border) */
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0; /* Align to the left for RTL */
            width: 8px;
            height: 100%;
            border-radius: var(--border-radius-medium) 0 0 var(--border-radius-medium);
            transition: background-color 0.3s ease;
        }

        /* Styles for mini-invoice cards in local archive / Firebase */
        .mini-invoice-card {
            border: 1px solid var(--border-light);
            border-right: 5px solid var(--accent-blue); /* Distinct border for invoices */
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            text-align: right;
            font-size: 0.85em; /* Smaller base font size for mini-invoices */
            line-height: 1.4;
            cursor: pointer;
            position: relative;
            box-sizing: border-box;
        }

        .mini-invoice-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
            border-right-color: var(--accent-green); /* Highlight on hover */
        }

        .mini-invoice-card .invoice-mini-header p,
        .mini-invoice-card .invoice-mini-footer p {
            margin: 2px 0;
            color: var(--text-primary-dark);
        }

        .mini-invoice-card .invoice-mini-header p strong {
            color: var(--primary-blue-dark);
            font-size: 1.1em;
        }

        /* New styles for mini-product list within local invoice item */
        .mini-product-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.8em;
            width: 100%;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            padding: var(--spacing-xs);
            box-sizing: border-box;
            background-color: var(--primary-bg-light);
        }

        .mini-product-item-header, .mini-product-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr; /* Name, Quantity, Total */
            gap: var(--spacing-xs);
            align-items: center;
            padding: 4px 6px;
            text-align: right;
        }

        .mini-product-item-header {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row:nth-child(even) {
             background-color: var(--primary-bg-light);
        }

        .mini-product-item-row div {
            white-space: normal;
            word-break: break-word;
            text-align: right;
            color: var(--text-secondary-gray);
        }
        .mini-product-item-row div:first-child {
             color: var(--text-primary-dark);
        }


        .mini-invoice-card .invoice-mini-footer {
            border-top: 1px dashed var(--border-light);
            padding-top: var(--spacing-sm);
            text-align: right;
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-mini-footer p strong {
            color: var(--accent-green);
            font-size: 1.1em;
        }

        .mini-invoice-card .invoice-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light { /* Adjusted to apply to the add-to-local button specifically */
            flex: 0 0 auto;
            width: fit-content;
            padding: 0.5rem 1rem;
            height: auto;
            font-size: 0.8em;
            margin-top: 0;
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
        }

        /* Specific styles for local/matched products */
        .product-card.is-local {
            background-color: var(--card-bg-white) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }

        .product-card.is-local::before {
            background-color: var(--accent-blue); /* A vibrant blue for local products indicator */
        }

        .product-card.is-local p {
            color: var(--text-secondary-gray);
        }

        .product-card.is-local p strong {
            color: var(--text-primary-dark);
        }

        .product-card.is-local-match {
            background-color: var(--accent-green) !important;
            border-color: var(--accent-green) !important;
            color: var(--text-light) !important;
            box-shadow: 0 4px 10px hsla(135, 60%, 42%, 0.4); /* Green shadow */
        }

        .product-card.is-local-match::before {
            background-color: var(--accent-green);
        }

        .product-card.is-local-match p {
            color: var(--text-light) !important;
        }

        .product-card.is-local-match p strong {
            color: var(--text-light) !important;
        }

        .product-card.is-local-match .product-actions button {
            background-color: var(--card-bg-white);
            color: var(--primary-blue-dark);
        }

        .product-card.is-local-match .product-actions button:hover {
            background-color: var(--primary-bg-light);
        }

        /* Product details and actions within cards */
        .product-card .product-details, .mini-invoice-card .invoice-summary-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
            width: 100%;
        }

        .product-card .product-details p, .mini-invoice-card .invoice-summary-details p {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: var(--text-secondary-gray);
        }

        .product-card .product-details p:first-child strong {
            font-size: 1.2em;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xs);
        }

        .product-card .product-actions, .mini-invoice-card .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }

        .product-card .product-actions button, .mini-invoice-card .invoice-actions button {
            flex: 1 1 48%; /* Allows two buttons per row on wider screens */
            min-width: 120px;
            height: 45px;
            padding: 0.8rem 0;
            font-size: 0.9em;
        }

        /* Calculator-like quantity controls */
        .quantity-controls {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
            border-radius: var(--border-radius-medium);
            overflow: hidden;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-subtle);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .quantity-controls button {
            width: auto;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background-color: var(--accent-blue);
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.3s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
            box-shadow: none;
        }

        .quantity-controls button:first-child {
            border-top-right-radius: var(--border-radius-small);
            border-bottom-right-radius: var(--border-radius-small);
        }

        .quantity-controls button:last-child {
            border-top-left-radius: var(--border-radius-small);
            border-bottom-left-radius: var(--border-radius-small);
        }

        .quantity-controls button:hover { background-color: hsla(205, 78%, 35%, 1); }
        .quantity-controls button:active { transform: scale(0.95); }

        .quantity-controls button:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px hsla(205, 78%, 42%, 0.4);
            z-index: 1;
        }

        .quantity-controls input {
            width: 100%;
            max-width: none;
            height: 45px;
            margin: 0;
            font-size: 1.1em;
            text-align: center;
            border-radius: 0;
            background-color: var(--primary-bg-light);
            border: none;
            border-left: 1px solid var(--border-light);
            border-right: 1px solid var(--border-light);
            color: var(--text-primary-dark);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .quantity-controls input:focus {
            border-color: var(--accent-blue);
            box-shadow: inset 0 0 0 2px hsla(205, 78%, 42%, 0.3);
        }

        /* Product status colors */
        .product-card.status-insufficient {
            background-color: var(--accent-red) !important;
            color: var(--text-light);
            border-color: var(--accent-red) !important;
            box-shadow: 0 2px 8px hsla(350, 70%, 55%, 0.3);
        }

        .product-card.status-insufficient::before {
            background-color: var(--accent-red);
        }

        .product-card.status-insufficient p { color: var(--text-light); }
        .product-card.status-insufficient p strong { color: var(--text-light); }

        .product-card.status-selected-sufficient {
            background-color: hsla(205, 78%, 95%, 1) !important; /* Light blueish for selected but sufficient */
            border-color: var(--accent-blue) !important;
            box-shadow: 0 2px 8px hsla(205, 78%, 42%, 0.3);
            color: var(--text-primary-dark);
        }

        .product-card.status-selected-sufficient::before {
            background-color: var(--accent-blue);
        }

        .product-card.status-selected-sufficient p { color: var(--text-secondary-gray); }
        .product-card.status-selected-sufficient p strong { color: var(--text-primary-dark); }
        
        .product-card.status-stock-positive, .product-card.status-default {
            background-color: var(--card-bg-white) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }

        .product-card.status-stock-positive::before, .product-card.status-default::before {
            background-color: var(--accent-green); /* Positive stock indicator */
        }

        /* Search fields */
        .search-input { /* Applies to #searchProduct, #searchLocalInvoice, #commonSearchInput */
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--card-bg-white);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            padding-left: 45px; /* Space for icon */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%237f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>'); /* Gray search icon */
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 18px;
        }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.3);
        }

        /* Search field with clear button adjustments */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .search-input-wrapper input {
            margin-bottom: 0;
        }

        .clear-search-btn {
            background-color: var(--accent-red);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-subtle);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 45px;
        }

        .clear-search-btn:hover {
            background-color: hsla(350, 70%, 45%, 1);
            transform: translateY(-1px);
        }

        /* Filter controls in Firebase section */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--primary-bg-light);
            border-radius: var(--border-radius-medium);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Override filters within Firebase product list wrapper to be transparent */
        .firebase-product-list-wrapper > .filter-controls {
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }

        .filter-controls .form-group {
            flex: 1 1 48%; /* Allows two columns on wider screens */
            min-width: 250px;
            margin-bottom: 0;
        }

        .filter-controls .form-group label {
            display: none; /* Hide labels for dropdowns in filter controls */
        }

        /* Select element styles (for dropdowns) */
        .filter-controls select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            font-size: 1em;
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            appearance: none; /* Remove default dropdown arrow */
            /* Custom arrow using SVG data URI */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%22292.4%22%20height%22292.4%22%3E%3Cpath%20fill%3D%22%237f8c8d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E'); /* Gray arrow */
            background-repeat: no-repeat;
            background-position: left 10px center; /* Position arrow on the left for RTL */
            background-size: 12px;
            padding-left: 30px; /* Space for custom arrow */
            padding-right: 0.8rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .filter-controls select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px hsla(205, 78%, 42%, 0.3);
        }

        /* Statistics section styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        /* Specific style for stat cards that contain a list to span full grid width */
        .stat-card-list {
            grid-column: 1 / -1; /* Spans all columns available in the grid */
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: stretch; /* Ensures cards stretch to fill height */
            width: 100%;
        }

        /* Individual stat cards */
        .stat-card {
            background: var(--card-bg-white);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 auto; /* Allows cards to grow and shrink */
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-medium);
        }

        /* Visual element behind numbers */
        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px; /* Position for RTL */
            width: 80px;
            height: 80px;
            background-color: var(--accent-blue);
            border-radius: var(--border-radius-pill);
            opacity: 0.1;
            transform: scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
        }

        .stat-card:hover::before {
            transform: scale(1);
        }

        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin: 0;
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums; /* Ensures numbers have consistent width */
        }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            bottom: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; /* New toasts appear below older ones */
            gap: 10px;
            pointer-events: none; /* Allows clicks to pass through empty space */
            align-items: center;
            width: auto;
            max-width: 90vw; /* Responsive width */
            box-sizing: border-box;
            padding: var(--spacing-md);
        }

        .toast {
            background-color: var(--card-bg-white);
            color: var(--text-primary-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto; /* Re-enable clicks on the toast itself */
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
            direction: rtl;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .toast.success { border-right: 5px solid var(--accent-green); border-left: none;}
        .toast.error { border-right: 5px solid var(--accent-red); border-left: none;}
        .toast.info { border-right: 5px solid var(--accent-blue); border-left: none;}
        .toast .icon { font-size: 1.5em; line-height: 1; }
        .toast.success .icon { color: var(--accent-green); }
        .toast.error .icon { color: var(--accent-red); }
        .toast.info .icon { color: var(--accent-blue); }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        /* Custom confirmation modal */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #confirm-modal-dialog {
            background-color: var(--card-bg-white);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-medium);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            direction: rtl;
        }

        #confirm-modal-overlay.active #confirm-modal-dialog { transform: scale(1); }

        #confirm-modal-dialog h3 {
            color: var(--text-primary-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
        }

        #confirm-modal-dialog p {
            color: var(--text-secondary-gray);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-pill);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #confirm-yes-btn { background-color: var(--accent-blue); color: var(--text-light); }
        #confirm-yes-btn:hover { background-color: hsla(205, 78%, 35%, 1); }

        #confirm-no-btn { background-color: var(--border-light); color: var(--text-primary-dark); }
        #confirm-no-btn:hover { background-color: hsla(210, 10%, 75%, 1); }

        /* Media queries for responsiveness */
        @media (min-width: 769px) {
            body {
                font-size: 16px; /* Base font size for desktop */
                padding-bottom: var(--spacing-md); /* Remove extra padding when bottom nav is hidden */
            }

            .main-controls {
                display: flex; /* Show desktop nav */
            }

            .bottom-nav {
                display: none; /* Hide mobile nav */
            }

            /* Invoice details grid for two columns on larger screens */
            .invoice-details-grid { /* This class is currently not explicitly in HTML for invoice-header-section, but it's a good pattern. */
                grid-template-columns: 1fr 1fr;
            }

            .invoice-header-section p {
                width: auto; /* Allow items to take natural width in grid */
                text-align: right; /* Keep right alignment */
            }
        }

        @media (max-width: 1024px) {
            .container { max-width: 960px; }
            .main-controls .btn-panel { font-size: 0.9em; padding: 0.6rem 0.8rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); }
            .stat-card h3 { font-size: 1em; }
            .stat-card p { font-size: 1.4em; }
            #dynamicStatsListContainer {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 15px; /* Slightly smaller font for tablets/larger mobiles */
                padding: var(--spacing-sm);
                padding-bottom: calc(var(--spacing-sm) + 60px); /* Adjust padding for mobile nav */
            }

            .main-controls { display: none; } /* Hide desktop nav */
            .bottom-nav { display: flex; } /* Show mobile nav */
            .container { max-width: 100%; } /* Allow container to be full width */

            /* Product and invoice creation forms take full width */
            .dashboard-view > .product-form-section, .dashboard-view > .invoice-creation-section { min-width: unset; flex: 1 1 100%; }
            .invoice h1 { font-size: 1.8em; }
            .invoice h2 { font-size: 1.4em; }
            .invoice-table th, .invoice-table td { padding: 0.5rem; font-size: 0.8em; }

            /* Product and invoice lists take single column */
            .product-list-grid.saved-products-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: none; /* Allow full height */
                overflow-y: visible; /* No scrollbar */
            }

            .product-list-grid.invoice-cards-grid {
                grid-template-columns: 1fr; /* Single column on smaller screens */
                max-height: none;
                overflow-y: visible;
            }

            .stat-card p { font-size: 1.3em; }
            .statistics-section .section-title { font-size: 1.5em; }
            .toast { min-width: unset; max-width: 90%; }
            .toast .icon { font-size: 1.2em; }
            .dashboard-view > section { flex: 1 1 100%; }
            .filter-controls .form-group { min-width: unset; flex: 1 1 100%; }
            .quantity-controls input { width: 60px; margin: 0 5px; }
            .stat-card-list { flex-direction: column; }
            .stat-card-list > div { flex: 1 1 100%; }
            #dynamicStatsListContainer {
                grid-template-columns: 1fr;
            }

            /* Adjust invoice header element order on small screens */
            .invoice-header-section {
                align-items: flex-start;
                text-align: right;
            }

            .invoice-header-section h2 {
                text-align: right;
            }

            .invoice-header-section p {
                text-align: right;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px; /* Even smaller base font for very small mobiles */
                padding: var(--spacing-sm);
                padding-bottom: calc(var(--spacing-sm) + 60px);
            }
            .button-container { flex-direction: column; } /* Stack buttons vertically */
            .btn-base { flex: 1 1 100%; } /* Buttons take full width */
            .product-list-grid.invoice-cards-grid {
                grid-template-columns: 1fr;
                max-height: none;
                overflow-y: visible;
            }
            .main-title, .firebase-stats-combined-container .main-title { font-size: 1.8em; }
            .section-title, .firebase-stats-combined-container .section-title { font-size: 1.5em; }
            .stat-card h3 { font-size: 0.9em; }
            .stat-card p { font-size: 1.2em; }
            .toast { padding: 10px 15px; font-size: 0.9em; }
            .toast .icon { font-size: 1.2em; }
        }

        /* Print styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
                color: #000;
                font-size: 12pt; /* Specific font size for print */
            }

            .main-controls,
            .bottom-nav,
            .theme-switch-wrapper,
            .invoice-actions-print-group {
                display: none !important; /* Hide UI elements not needed for print */
            }

            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 1cm !important; /* Standard print margins */
            }

            .invoice {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background-color: #fff !important;
            }

            .invoice-table {
                border: 1px solid #000 !important;
            }

            .invoice-table th,
            .invoice-table td {
                border: 1px solid #000 !important;
                color: #000 !important;
                background-color: #fff !important;
            }

            .invoice-table th {
                background-color: #f2f2f2 !important;
            }

            #displayTotalAmountBeforeCommission,
            #displayCommissionDeducted,
            #displayTotalAmount,
            #displayTVA,
            #displayTotalTTC {
                color: #000 !important;
            }

            .main-title, .section-title, .list-subtitle {
                color: #000 !important;
                border-bottom-color: #ccc !important;
            }

            .icon {
                display: none; /* Hide icons in print */
            }

            /* Reset invoice margins and footer for print */
            .invoice-header-section,
            .invoice-summary-section,
            .invoice-footer {
                background-color: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
                margin-bottom: 0.5cm !important; /* Space for print */
            }

            .invoice-summary-section table {
                border-spacing: 0; /* Remove spacing for print */
            }

            .invoice-summary-section tfoot tr td {
                background-color: transparent !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                color: #000 !important;
                padding: 0.3rem 0.5rem !important; /* Smaller padding for print */
            }

            .invoice-header-section p {
                margin: 0; /* Remove extra margins */
            }

            .invoice-header-section {
                display: grid; /* Use grid for layout info */
                grid-template-columns: 1fr 1fr; /* Two columns for invoice header summary */
                gap: 5px 20px; /* Space between items */
                align-items: start;
                text-align: right;
            }

            .invoice-header-section h2 {
                grid-column: 1 / -1; /* Make title span full width */
                text-align: center;
            }

            .invoice-header-section p:nth-of-type(1), /* Nom du client */
            .invoice-header-section p:nth-of-type(2), /* Propriétaire de la facture */
            .invoice-header-section p:nth-of-type(3) /* Date de la facture */ {
                text-align: right; /* Right align for RTL */
            }

            /* Ensure font sizes are reduced to fit print */
            .invoice-table th,
            .invoice-table td,
            .invoice-header-section p,
            .invoice-summary-section tfoot tr td,
            .invoice-footer p {
                font-size: 10pt !important; /* Smaller font size for print */
            }

            .invoice .main-title {
                font-size: 16pt !important;
            }

            .invoice .section-title {
                font-size: 14pt !important;
            }
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- JsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
</head>
<body>

    <!-- شريط التنقل العلوي (لشاشات الكمبيوتر اللوحي والكمبيوتر المكتبي) -->
    <header class="main-controls" id="desktopNav">
        <button type="button" class="btn-panel" id="showDashboardButton"><span class="icon"><i class="fas fa-home"></i></span>الرئيسية (الإدارة)</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton"><span class="icon"><i class="fas fa-chart-bar"></i></span>بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showLocalArchiveButton"><span class="icon"><i class="fas fa-archive"></i></span>أرشيف الفواتير</button>
    </header>

    <main class="container">
        <!-- لوحة التحكم الرئيسية: إدارة المنتجات، إنشاء الفواتير، أرشيف -->
        <section id="mainDashboardView" class="dashboard-view fade-in-section">
            <h1 class="main-title">لوحة التحكم الرئيسية</h1>

            <!-- قسم إدارة المنتجات -->
            <section class="product-form-section card-container" id="productFormContainer">
                <h2 class="section-title" id="productFormTitle"><span class="icon"><i class="fas fa-box"></i></span>إدارة المنتجات</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on" list="productNames">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>اسم المنتج مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>سعر الشراء مطلوب (غير سالب).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>سعر البيع مطلوب (غير سالب).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on" list="supplierNames">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>اسم المورد مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on" list="supplierAddresses">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>عنوان المورد مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric" list="supplierPhones">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>رقم هاتف المورد مطلوب (10 أرقام).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantité initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn-base btn-primary" id="addProduct"><span class="icon"><i class="fas fa-plus-circle"></i></span>إضافة منتج</button>
                        <button type="submit" class="btn-base btn-warning" id="saveEditProduct" style="display: none;"><span class="icon"><i class="fas fa-edit"></i></span>تعديل المنتج</button>
                    </div>
                </form>
            </section>

            <!-- قسم إنشاء الفواتير -->
            <section class="invoice-creation-section card-container" id="clientFormContainer">
                <h2 class="section-title"><span class="icon"><i class="fas fa-file-invoice"></i></span>إنشاء الفواتير</h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>تاريخ الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" list="customerNames">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>اسم العميل مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on" list="invoiceOwners">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>اسم مالك الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la facture</label>
                        <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on" list="invoiceOwnerAddresses">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>عنوان مالك الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric" list="invoiceOwnerPhones">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>رقم هاتف مالك الفاتورة مطلوب (10 أرقام).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>نسبة TVA مطلوبة (بين 0 و 100).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                        <input type="number" id="invoiceCommissionPercentage" placeholder="مثال: 10" value="0" min="0" max="100" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>نسبة العمولة للفاتورة (بين 0 و 100).
                        </span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn-base btn-success" id="createInvoiceButton"><span class="icon"><i class="fas fa-check-circle"></i></span>إنشاء الفاتورة وعرضها</button>
                    </div>
                </form>
            </section>

            <!-- المنتجات المحفوظة -->
            <section class="saved-products-section card-container" id="savedProductsDisplay">
                <div class="divider"></div>
                <h2 class="section-title"><span class="icon"><i class="fas fa-shopping-cart"></i></span>المنتجات المحفوظة (سلة الفاتورة)</h2>
                <div class="form-group">
                    <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                    <input type="text" id="searchProduct" class="search-input" placeholder="البحث عن منتج">
                </div>
                <div class="product-list-grid saved-products-grid" id="savedProductsList"></div>
            </section>
        </section>

        <!-- عرض الفاتورة (مخفي افتراضيًا) -->
        <article class="invoice card-container fade-in-section" id="invoiceDisplay" hidden>
            <h1 class="main-title">DEVIS</h1>
            <section class="invoice-header-section">
                <h2 class="section-title"><span class="icon"><i class="fas fa-user"></i></span>تفاصيل الفاتورة</h2>
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Date de la facture: <time datetime="" id="displayInvoiceDate"></time></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
            </section>

            <div class="table-responsive">
                <table class="invoice-table" id="invoiceDetails">
                    <thead>
                        <tr>
                            <th>N°</th>
                            <th>Nom du produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantité</th>
                            <th>Montant HT</th>
                        </tr>
                    </thead>
                    <tbody id="displayDetails">
                    </tbody>
                </table>
            </div>

            <div class="invoice-summary-section">
                <h2 class="section-title"><span class="icon"><i class="fas fa-chart-line"></i></span>ملخص الفاتورة</h2>
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <footer class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </footer>

            <!-- أزرار لتحديث المخزون والطباعة -->
            <div class="button-container invoice-actions-print-group">
                <button type="button" class="btn-base btn-primary" id="savePdfButton"><span class="icon"><i class="fas fa-boxes"></i></span>تحديث المخزون (بعد الفاتورة)</button>
                <button type="button" class="btn-base btn-success" id="printButton"><span class="icon"><i class="fas fa-print"></i></span>طباعة الفاتورة</button>
            </div>
        </article>

        <!-- بيانات Firebase والإحصائيات (مخفي افتراضيًا) -->
        <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay" hidden>
            <h1 class="main-title">بيانات Firebase والإحصائيات</h1>
            <div class="firebase-content-wrapper">
                <!-- قسم الإحصائيات -->
                <section class="statistics-section card-container">
                    <h2 class="section-title"><span class="icon"><i class="fas fa-chart-pie"></i></span>إحصائيات المبيعات التفصيلية</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي سعر الشراء</h3>
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي سعر البيع</h3>
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي العمولة</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي الأرباح</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card-list">
                            <div id="dynamicStatsListContainer">
                                <div>
                                    <h3 class="list-subtitle">المنتجات الأكثر مبيعاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topSellingProductsChart"></canvas>
                                    </div>
                                    <ul id="topSellingProductsList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">العملاء الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topCustomersChart"></canvas>
                                    </div>
                                    <ul id="topCustomersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">أصحاب الفواتير الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topInvoiceOwnersChart"></canvas>
                                    </div>
                                    <ul id="topInvoiceOwnersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">الموردون الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topSuppliersChart"></canvas>
                                    </div>
                                    <ul id="topSuppliersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-input-wrapper">
                        <input type="text" id="commonSearchInput" class="search-input" placeholder="البحث برقم الهاتف، الاسم، أو المنتج" list="allSearchOptions">
                        <datalist id="allSearchOptions"></datalist>
                        <button type="button" class="clear-search-btn" id="clearCommonSearchInput"><span class="icon"><i class="fas fa-times-circle"></i></span>مسح</button>
                    </div>
                </section>
                <!-- قسم قائمة منتجات Firebase -->
                <section class="firebase-product-list-wrapper card-container">
                    <h2 class="section-title"><span class="icon"><i class="fas fa-cloud"></i></span>قائمة فواتير Firebase (<span id="firebaseProductListCount">0</span>)</h2>
                    <div class="filter-controls">
                        <div class="form-group">
                            <label for="commonPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                            <select id="commonPhoneDropdown">
                                <!-- سيتم تعبئة خيارات أرقام الهواتف بواسطة JS -->
                            </select>
                        </div>
                    </div>
                    <!-- This div will now display invoice-like cards, not individual product cards -->
                    <div class="product-list-grid invoice-cards-grid" id="productListContainerdata"></div>
                </section>
            </div>
        </section>

        <!-- أرشيف الفواتير المحلية (مخفي افتراضيًا) -->
        <section class="local-archive-container fade-in-section" id="localArchiveView" hidden>
            <h1 class="main-title">أرشيف الفواتير المحلية</h1>
            
            <!-- قسم البحث عن الفواتير المحلية (داخل نفس بطاقة القائمة) -->
            <section class="card-container">
                <h2 class="section-title"><span class="icon"><i class="fas fa-search"></i></span>بحث في الأرشيف</h2>
                <div class="form-group">
                    <label for="searchLocalInvoice" class="sr-only">البحث في الفواتير المحلية</label>
                    <input type="text" id="searchLocalInvoice" class="search-input" placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتج)" list="localInvoiceSearchOptions">
                    <datalist id="localInvoiceSearchOptions"></datalist>
                </div>
                
                <h2 class="section-title" style="margin-top: var(--spacing-lg);"><span class="icon"><i class="fas fa-file-invoice"></i></span>الفواتير المحفوظة محلياً</h2>
                <div class="product-list-grid invoice-cards-grid" id="localInvoicesList">
                    <p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>
                </div>
            </section>
        </section>
    </main>

    <!-- شريط التنقل السفلي (للجوال) -->
    <nav class="bottom-nav" id="mobileNav">
        <button type="button" class="nav-button" id="mobileShowDashboardButton">
            <span class="icon"><i class="fas fa-home"></i></span>
            <span>الرئيسية</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowFirebaseDataButton">
            <span class="icon"><i class="fas fa-chart-bar"></i></span>
            <span>البيانات</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowLocalArchiveButton">
            <span class="icon"><i class="fas fa-archive"></i></span>
            <span>الأرشيف</span>
        </button>
        <button type="button" class="nav-button" id="mobileCreateInvoiceButton">
            <span class="icon"><i class="fas fa-file-invoice"></i></span>
            <span>فاتورة</span>
        </button>
    </nav>

    <!-- حاوية إشعارات التوست -->
    <div id="toast-container"></div>

    <!-- نافذة التأكيد المخصصة -->
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

    <!-- Datalist elements for autocomplete suggestions -->
    <datalist id="productNames"></datalist>
    <datalist id="supplierNames"></datalist>
    <datalist id="supplierAddresses"></datalist>
    <datalist id="supplierPhones"></datalist>
    <datalist id="customerNames"></datalist>
    <datalist id="invoiceOwners"></datalist>
    <datalist id="invoiceOwnerAddresses"></datalist>
    <datalist id="invoiceOwnerPhones"></datalist>
    <datalist id="localInvoiceSearchOptions"></datalist>


    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        // تهيئة تطبيق Firebase
        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("فشل تهيئة Firebase:", e);
            showToast("فشل تهيئة Firebase. قد لا تعمل الميزات المتعلقة بالبيانات السحابية.", 'error');
        }

        // معرف التطبيق لأسماء مساحات البيانات في Firebase
        // يتم توفيره بواسطة بيئة Canvas، إذا لم يكن متاحاً، يتم استخدام قيمة افتراضية.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ====== مراجع عناصر واجهة المستخدم العامة ======
        const mainDashboardView = document.getElementById('mainDashboardView');
        const productFormContainer = document.getElementById('productFormContainer');
        const clientFormContainer = document.getElementById('clientFormContainer');
        const invoiceDisplay = document.getElementById('invoiceDisplay');
        const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay');
        const localArchiveView = document.getElementById('localArchiveView');

        const desktopNavButtons = [
            document.getElementById('showDashboardButton'),
            document.getElementById('showFirebaseDataButton'),
            document.getElementById('showLocalArchiveButton')
        ];

        const mobileNavButtons = [
            document.getElementById('mobileShowDashboardButton'),
            document.getElementById('mobileShowFirebaseDataButton'),
            document.getElementById('mobileShowLocalArchiveButton'),
            document.getElementById('mobileCreateInvoiceButton')
        ];

        const productForm = document.getElementById('productForm');
        const productFormTitle = document.getElementById('productFormTitle');
        const productNameInput = document.getElementById('productName');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const supplierNameInput = document.getElementById('supplierName');
        const supplierAddressInput = document.getElementById('supplierAddress');
        const supplierPhoneInput = document.getElementById('supplierPhone');
        const productQuantityInput = document.getElementById('productQuantity');

        const invoiceForm = document.getElementById('invoiceForm');
        const customerNameInput = document.getElementById('customerName');
        const invoiceOwnerInput = document.getElementById('invoiceOwner');
        const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
        const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const tvaInput = document.getElementById('tva');
        const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage');

        const addProductButton = document.getElementById('addProduct');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        const savedProductsList = document.getElementById('savedProductsList');
        const searchProductInput = document.getElementById('searchProduct');

        const commonPhoneDropdown = document.getElementById('commonPhoneDropdown');
        const commonSearchInput = document.getElementById('commonSearchInput');
        const clearCommonSearchInputButton = document.getElementById('clearCommonSearchInput');
        const allSearchOptionsDatalist = document.getElementById('allSearchOptions');
        const firebaseProductListCountSpan = document.getElementById('firebaseProductListCount');
        const firebaseProductListContainer = document.getElementById('productListContainerdata');

        const localInvoicesList = document.getElementById('localInvoicesList');
        const searchLocalInvoiceInput = document.getElementById('searchLocalInvoice');

        const dynamicStatsListContainer = document.getElementById('dynamicStatsListContainer');

        const toastContainer = document.getElementById('toast-container');
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmResolve;

        let allFirebaseInvoicesData = [];
        let allFirebaseProducts = [];
        let allLocalInvoices = [];

        const mainContainer = document.querySelector('main.container');
        let isNewInvoice = false;
        let currentInvoiceBeingProcessed = null; // Global variable to hold the invoice data before final save

        let topSellingProductsChartInstance = null;
        let topCustomersChartInstance = null;
        let topInvoiceOwnersChartInstance = null;
        let topSuppliersChartInstance = null;

        // ====== مراجع لعناصر datalist جديدة ======
        const productNamesDatalist = document.getElementById('productNames');
        const supplierNamesDatalist = document.getElementById('supplierNames');
        const supplierAddressesDatalist = document.getElementById('supplierAddresses');
        const supplierPhonesDatalist = document.getElementById('supplierPhones');
        const customerNamesDatalist = document.getElementById('customerNames');
        const invoiceOwnersDatalist = document.getElementById('invoiceOwners');
        const invoiceOwnerAddressesDatalist = document.getElementById('invoiceOwnerAddresses');
        const invoiceOwnerPhonesDatalist = document.getElementById('invoiceOwnerPhones');
        const localInvoiceSearchOptionsDatalist = document.getElementById('localInvoiceSearchOptions');

        // ====== وظائف مساعدة ======

        /**
         * تعبئة datalist معين بالقيم الفريدة من مصفوفة بيانات.
         * @param {HTMLElement} datalistElement - عنصر الـ datalist لملئه.
         * @param {Array<object>} sourceArray - المصفوفة المصدرية (مثل savedProducts أو allFirebaseInvoicesData).
         * @param {string} propertyName - اسم الخاصية في كائنات المصفوفة التي نريد استخراج القيم منها.
         */
        function populateUniqueDatalist(datalistElement, sourceArray, propertyName) {
            const uniqueValues = new Set();
            sourceArray.forEach(item => {
                if (item && item[propertyName]) {
                    uniqueValues.add(item[propertyName].trim());
                }
            });
            // Also add values from nested products array if applicable (e.g., product names, supplier names within invoice products)
            if (propertyName === 'name' || propertyName === 'supplierName') {
                allFirebaseInvoicesData.forEach(invoice => {
                    if (invoice.products) {
                        invoice.products.forEach(product => {
                            if (propertyName === 'name' && product.name) {
                                uniqueValues.add(product.name.trim());
                            }
                            if (propertyName === 'supplierName' && product.supplierName) {
                                uniqueValues.add(product.supplierName.trim());
                            }
                        });
                    }
                });
            }

            datalistElement.innerHTML = ''; // Clear existing options
            Array.from(uniqueValues).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                datalistElement.appendChild(option);
            });
        }

        /**
         * تعبئة جميع قوائم البيانات (datalists) في التطبيق.
         */
        function populateAllDatalists() {
            // For product management form
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            populateUniqueDatalist(productNamesDatalist, savedProducts, 'name');
            populateUniqueDatalist(supplierNamesDatalist, savedProducts, 'supplierName');
            populateUniqueDatalist(supplierAddressesDatalist, savedProducts, 'supplierAddress');
            populateUniqueDatalist(supplierPhonesDatalist, savedProducts, 'supplierPhone');

            // For invoice creation form
            // Get combined data for customers/owners/suppliers from both local and Firebase
            const allInvoiceRelatedData = [...allLocalInvoices, ...allFirebaseInvoicesData];
            populateUniqueDatalist(customerNamesDatalist, allInvoiceRelatedData, 'customerName');
            populateUniqueDatalist(invoiceOwnersDatalist, allInvoiceRelatedData, 'ownerName');
            populateUniqueDatalist(invoiceOwnerAddressesDatalist, allInvoiceRelatedData, 'ownerAddress');
            populateUniqueDatalist(invoiceOwnerPhonesDatalist, allInvoiceRelatedData, 'ownerPhone');

            // For common search input
            populateUniqueDatalist(allSearchOptionsDatalist, savedProducts, 'name'); // Product names from local
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'customerName');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerName');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerPhone');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'supplierName');


            // For local invoice search
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'customerName');
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'ownerName');
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'date');
            // Can also add product names from local invoices, which might be helpful
            allLocalInvoices.forEach(invoice => {
                if (invoice.products) {
                    invoice.products.forEach(p => {
                        if (p.name) {
                            const option = document.createElement('option');
                            option.value = p.name.trim();
                            localInvoiceSearchOptionsDatalist.appendChild(option);
                        }
                    });
                }
            });
        }

        /**
         * تخفي جميع أقسام المحتوى الرئيسية.
         */
        function hideAllSections() {
            const sectionsToHide = [mainDashboardView, invoiceDisplay, firebaseProductsDisplay, localArchiveView];
            sectionsToHide.forEach(section => {
                if (section.classList.contains('visible')) {
                    section.classList.remove('visible');
                    // Add a small delay before hiding completely to allow fade-out animation
                    setTimeout(() => { section.hidden = true; }, 500);
                }
            });
        }

        /**
         * تعرض قسماً محدداً من المحتوى مع رسوم متحركة متلاشية.
         * @param {HTMLElement} sectionToShow - عنصر القسم المراد عرضه.
         * @returns {Promise<void>} وعد يحل عند ظهور القسم.
         */
        function showSection(sectionToShow) {
            return new Promise(resolve => {
                hideAllSections();
                sectionToShow.hidden = false;
                // Add a slight delay before adding 'visible' class to ensure CSS transition works
                setTimeout(() => {
                    sectionToShow.classList.add('visible');
                    resolve();
                }, 10);
            });
        }

        /**
         * تعيين الحالة النشطة لأزرار التنقل.
         * @param {HTMLElement} activeBtn - الزر المراد تمييزه كنشط.
         * @param {HTMLElement[]} buttonGroup - مصفوفة تحتوي على جميع الأزرار في المجموعة.
         */
        function setActiveButton(activeBtn, buttonGroup) {
            buttonGroup.forEach(btn => { btn.classList.remove('active'); });
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        /**
         * إعادة تعيين رسائل وأنماط أخطاء التحقق لنموذج معين.
         * @param {HTMLFormElement} form - عنصر النموذج المراد إعادة تعيينه.
         */
        function resetValidationMessages(form) {
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');
            fields.forEach(field => {
                field.classList.remove('error');
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.textContent = '';
                    errorMessageSpan.style.display = 'none';
                }
            });
        }

        /**
         * عرض إشعار توست.
         * @param {string} message - الرسالة المراد عرضها.
         * @param {'success'|'error'|'info'} type - نوع التوست (يحدد اللون/الأيقونة).
         */
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let iconHtml = '';
            // Using Font Awesome icons
            if (type === 'success') { iconHtml = '<span class="icon"><i class="fas fa-check"></i></span>'; }
            else if (type === 'error') { iconHtml = '<span class="icon"><i class="fas fa-times"></i></span>'; }
            else if (type === 'info') { iconHtml = '<span class="icon"><i class="fas fa-info-circle"></i></span>'; }
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        /**
         * عرض نافذة تأكيد مخصصة وإرجاع وعد يحل إلى صحيح/خطأ.
         * @param {string} title - العنوان للنافذة.
         * @param {string} message - الرسالة للنافذة.
         * @returns {Promise<boolean>} يحل إلى صحيح إذا تم التأكيد، وإلا خطأ.
         */
        function showConfirmModal(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalOverlay.hidden = false;
                confirmModalOverlay.classList.add('active'); // Activate animation

                const handleYes = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        // ====== معالجات أحداث التنقل ======

        desktopNavButtons[0].addEventListener('click', async () => { // showDashboardButton
            await showSection(mainDashboardView);
            setActiveButton(desktopNavButtons[0], desktopNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to dashboard
        });

        desktopNavButtons[1].addEventListener('click', async () => { // showFirebaseDataButton
            await showSection(firebaseProductsDisplay);
            setActiveButton(desktopNavButtons[1], desktopNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = '';
            if (database) {
                populateCommonDropdown();
                fetchAndDisplayCombinedFirebaseData();
            } else {
                showToast("قاعدة بيانات Firebase غير مهيأة. لا يمكن جلب بيانات Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to Firebase data
        });

        desktopNavButtons[2].addEventListener('click', async () => { // showLocalArchiveButton
            await showSection(localArchiveView);
            setActiveButton(desktopNavButtons[2], desktopNavButtons);
            mainContainer.classList.add('full-width');
            displayLocalInvoices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to local archive
        });

        // أزرار التنقل في الجوال
        mobileNavButtons[0].addEventListener('click', async () => { // mobileShowDashboardButton
            await showSection(mainDashboardView);
            setActiveButton(mobileNavButtons[0], mobileNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to dashboard
        });

        mobileNavButtons[1].addEventListener('click', async () => { // mobileShowFirebaseDataButton
            await showSection(firebaseProductsDisplay);
            setActiveButton(mobileNavButtons[1], mobileNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = '';
            if (database) {
                populateCommonDropdown();
                fetchAndDisplayCombinedFirebaseData();
            } else {
                showToast("قاعدة بيانات Firebase غير مهيأة. لا يمكن جلب بيانات Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to Firebase data
        });

        mobileNavButtons[2].addEventListener('click', async () => { // mobileShowLocalArchiveButton
            await showSection(localArchiveView);
            setActiveButton(mobileNavButtons[2], mobileNavButtons);
            mainContainer.classList.add('full-width');
            displayLocalInvoices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            populateAllDatalists(); // Update datalists when navigating to local archive
        });

        mobileNavButtons[3].addEventListener('click', async () => { // mobileCreateInvoiceButton
            await showSection(mainDashboardView);
            setActiveButton(mobileNavButtons[3], mobileNavButtons);
            mainContainer.classList.remove('full-width');
            window.scrollTo({ top: clientFormContainer.offsetTop, behavior: 'smooth' });
            // Keep selected quantities when going to invoice creation
            displaySavedProducts();
            showToast("يرجى تحديد المنتجات والكميات للفاتورة.", 'info');
            populateAllDatalists(); // Update datalists when navigating to invoice creation
        });

        // ====== التحقق من صحة النموذج ======

        /**
         * يتحقق من صحة جميع الحقول المطلوبة في نموذج.
         * @param {HTMLFormElement} form - عنصر النموذج للتحقق من صحته.
         * @returns {boolean} صحيح إذا كانت جميع الحقول المطلوبة صالحة، خطأ بخلاف ذلك.
         */
        function checkFields(form) {
            let allFieldsValid = true;
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');

            // إعادة تعيين جميع الأخطاء السابقة
            fields.forEach(field => {
                field.classList.remove('error');
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.textContent = '';
                    errorMessageSpan.style.display = 'none';
                }
            });

            // التحقق من صحة الحقول
            fields.forEach(field => {
                const fieldValue = field.value.trim();
                const errorMessageSpan = field.nextElementSibling;

                if (!fieldValue) {
                    allFieldsValid = false;
                    field.classList.add('error');
                    if (errorMessageSpan) {
                        errorMessageSpan.innerHTML = `<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> ${field.placeholder || field.labels[0].textContent} مطلوب.`;
                        errorMessageSpan.style.display = 'flex';
                    }
                } else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                        if (isNaN(numValue) || numValue < 0) {
                            allFieldsValid = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> القيمة يجب أن تكون رقماً موجباً.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    } else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                        if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                            allFieldsValid = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> النسبة يجب أن تكون بين 0 و 100.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    const regex = new RegExp(field.pattern);
                    if (!regex.test(fieldValue)) {
                        allFieldsValid = false;
                        field.classList.add('error');
                        if (errorMessageSpan) {
                            errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                            errorMessageSpan.style.display = 'flex';
                        }
                    }
                }
            });
            return allFieldsValid;
        }

        // ====== إدارة المنتجات (التخزين المحلي) ======

        /**
         * يتعامل مع إرسال نموذج المنتج (إضافة أو تعديل).
         * @param {number|null} productId - معرف المنتج الذي يتم تعديله، أو null لمنتج جديد.
         */
        async function handleProductFormSubmission(productId = null) {
            if (!checkFields(productForm)) {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                return;
            }

            const name = productNameInput.value.trim();
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const sellingPrice = parseFloat(sellingPriceInput.value);
            const supplierName = supplierNameInput.value.trim();
            const supplierAddress = supplierAddressInput.value.trim();
            const supplierPhone = supplierPhoneInput.value.trim();
            const stockQuantity = parseInt(productQuantityInput.value);
            const date = new Date().toLocaleDateString('ar-MA');

            // حفظ معلومات المورد في التخزين المحلي (لأنها غالباً ما يعاد استخدامها)
            localStorage.setItem('supplierName', supplierName);
            localStorage.setItem('supplierAddress', supplierAddress);
            localStorage.setItem('supplierPhone', supplierPhone);

            let products = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let isEditing = productId !== null;
            let productIndex = -1;

            if (isEditing) {
                productIndex = products.findIndex(p => p.id == productId);
                if (productIndex === -1) {
                    console.error("Attempted to edit product but it was not found in array:", productId);
                    showToast("خطأ: المنتج المراد تعديله غير موجود في القائمة.", 'error');
                    resetProductFormAndButtons();
                    return;
                }
            }

            // التحقق من وجود منتج مكرر (نفس الاسم ورقم هاتف المورد)
            const duplicateCheck = products.some((p, idx) =>
                (isEditing ? idx !== productIndex : true) &&
                (p.name || '').toLowerCase() === name.toLowerCase() &&
                p.supplierPhone === supplierPhone
            );

            if (duplicateCheck) {
                showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
                return;
            }

            const confirmTitle = isEditing ? "تأكيد التعديل" : "تأكيد الإضافة";
            const confirmMessage = isEditing ? "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟" : "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟";
            const confirmed = await showConfirmModal(confirmTitle, confirmMessage);

            if (!confirmed) {
                showToast(isEditing ? "تم إلغاء تعديل المنتج." : "تم إلغاء إضافة المنتج.", 'info');
                return;
            }

            if (isEditing) {
                products[productIndex] = {
                    ...products[productIndex],
                    name, purchasePrice, sellingPrice, supplierName, supplierAddress, supplierPhone, stockQuantity, date
                };
                showToast("تم تحديث المنتج بنجاح.", 'success');
                console.log('Product updated successfully:', products[productIndex]);
            } else {
                const newProduct = {
                    id: Date.now(),
                    name, purchasePrice, sellingPrice, supplierName, supplierAddress, supplierPhone, stockQuantity, date,
                    quantity: 0, // Quantity selected for invoice
                    isLocal: true // Mark as locally added product
                };
                products.push(newProduct);
                showToast("المنتج تم إضافته بنجاح.", 'success');
                console.log('New product added successfully:', newProduct);
            }

            products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            localStorage.setItem('savedProducts', JSON.stringify(products));
            displaySavedProducts();
            resetProductFormAndButtons();
            populateAllDatalists(); // Update datalists after product submission
        }

        addProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            handleProductFormSubmission(null);
        });

        saveEditProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const idToEdit = event.target.dataset.editingId;
            handleProductFormSubmission(parseInt(idToEdit));
        });

        /**
         * إعادة تعيين نموذج المنتج إلى حالته الأولية.
         */
        function resetProductFormAndButtons() {
            productForm.reset();
            productFormTitle.innerHTML = '<span class="icon"><i class="fas fa-box"></i></span>إدارة المنتجات';
            addProductButton.style.display = 'flex'; /* Use flex for button display */
            saveEditProductButton.style.display = 'none';
            delete saveEditProductButton.dataset.editingId;
            resetValidationMessages(productForm);
        }

        /**
         * تعبئة نموذج المنتج ببيانات لتحرير منتج معين.
         * @param {number} productId - معرف المنتج المراد تحريره.
         */
        async function editProduct(productId) {
            console.log('Attempting to edit product with ID:', productId);
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productToEdit = savedProducts.find(p => p.id == productId);

            if (productToEdit) {
                console.log('Product found for editing:', productToEdit);
                // Check if the mainDashboardView is currently hidden.
                // Only switch to it if not already visible to avoid unnecessary re-rendering.
                if (mainDashboardView.hidden) {
                    console.log('Switching to mainDashboardView...');
                    await showSection(mainDashboardView);
                    // Also ensure the correct navigation button is active after switching sections
                    if (window.innerWidth <= 768) {
                        setActiveButton(mobileNavButtons[0], mobileNavButtons); // mobileShowDashboardButton
                    } else {
                        setActiveButton(desktopNavButtons[0], desktopNavButtons); // desktopShowDashboardButton
                    }
                } else {
                    console.log('Already on mainDashboardView, skipping section switch.');
                    // If already on dashboard, just ensure its button is active
                    if (window.innerWidth <= 768) {
                        setActiveButton(mobileNavButtons[0], mobileNavButtons);
                    } else {
                        setActiveButton(desktopNavButtons[0], desktopNavButtons);
                    }
                }

                mainContainer.classList.remove('full-width'); // Ensure dashboard view is not full-width
                // Always reset and populate the form to ensure fresh data
                resetProductFormAndButtons(); 
                productFormTitle.innerHTML = '<span class="icon"><i class="fas fa-edit"></i></span>تعديل المنتج';
                productNameInput.value = productToEdit.name || '';
                purchasePriceInput.value = productToEdit.purchasePrice || 0;
                sellingPriceInput.value = productToEdit.sellingPrice || 0;
                supplierNameInput.value = productToEdit.supplierName || '';
                supplierAddressInput.value = productToEdit.supplierAddress || '';
                supplierPhoneInput.value = productToEdit.supplierPhone || '';
                productQuantityInput.value = productToEdit.stockQuantity || 0;

                addProductButton.style.display = 'none';
                saveEditProductButton.style.display = 'flex';
                saveEditProductButton.dataset.editingId = productId;
                // Scroll to the form after populating
                window.scrollTo({ top: productFormContainer.offsetTop, behavior: 'smooth' });
                populateAllDatalists(); // Update datalists after editing a product
            } else {
                showToast("المنتج المراد تعديله غير موجود.", 'error');
            }
        }

        /**
         * حذف منتج من التخزين المحلي.
         * @param {number} id - معرف المنتج المراد حذفه.
         */
        async function deleteProduct(id) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
            if (confirmed) {
                let products = JSON.parse(localStorage.getItem('savedProducts') || '[]');
                products = products.filter(product => product.id !== id);
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts();
                showToast("تم حذف المنتج بنجاح.", 'success');
                populateAllDatalists(); // Update datalists after deleting a product
            } else {
                showToast("تم إلغاء حذف المنتج.", 'info');
            }
        }

        /**
         * إعادة تعيين الكمية المحددة للفاتورة إلى صفر لجميع المنتجات.
         * هذه الدالة لم تعد تستخدم تلقائياً بعد إنشاء الفاتورة، ولكنها قد تكون مفيدة لسيناريوهات أخرى.
         */
        function resetAllProductQuantities() {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            savedProducts.forEach(product => { product.quantity = 0; });
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        }

        /**
         * عرض المنتجات من التخزين المحلي في قائمة "المنتجات المحفوظة".
         * يطبق مرشح البحث والفرز.
         */
        function displaySavedProducts() {
            const searchTerm = searchProductInput.value.toLowerCase();
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            savedProductsList.innerHTML = '';

            const filteredProducts = savedProducts
                .filter(product => (product.name || '').toLowerCase().includes(searchTerm))
                .sort((a, b) => {
                    const stockQuantityA = a.stockQuantity || 0;
                    const stockQuantityB = b.stockQuantity || 0;
                    const quantityA = a.quantity || 0;
                    const quantityB = b.quantity || 0;

                    const statusA = getProductStatusPriority(quantityA, stockQuantityA);
                    const statusB = getProductStatusPriority(quantityB, stockQuantityB);

                    if (statusA !== statusB) { return statusA - statusB; }
                    
                    // Prioritize local products in the main dashboard view
                    if (a.isLocal && !b.isLocal) return -1;
                    if (!a.isLocal && b.isLocal) return 1;

                    return stockQuantityB - stockQuantityA || (a.name || '').localeCompare(b.name || '');
                });

            if (filteredProducts.length === 0) {
                savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
                return;
            }

            filteredProducts.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-card'; /* Use product-card class */
                productDiv.dataset.id = product.id;
                if (product.isLocal) { productDiv.classList.add('is-local'); }
                const quantityToDisplay = product.quantity || 0;
                const stockQuantityToDisplay = product.stockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay);

                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                        <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                    </div>
                    <p><strong>الكمية في المخزون:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" class="stock-adjust-btn" data-action="plus">+</button>
                        <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" data-product-id="${product.id}" class="stock-input">
                        <button type="button" class="stock-adjust-btn" data-action="minus">-</button>
                    </div>
                    <p><strong>الكمية المحددة للفاتورة:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-adjust-btn" data-action="plus">+</button>
                        <input type="number" class="product-quantity-input" data-id="${product.id}" value="${quantityToDisplay}" min="0">
                        <button type="button" class="quantity-adjust-btn" data-action="minus">-</button>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn-base btn-danger" data-product-id="${product.id}"><span class="icon"><i class="fas fa-trash-alt"></i></span>حذف</button>
                        <button type="button" class="btn-base btn-warning" data-product-id="${product.id}"><span class="icon"><i class="fas fa-edit"></i></span>تعديل</button>
                    </div>
                `;
                savedProductsList.appendChild(productDiv);
            });
        }

        // تفويض الأحداث لإجراءات قائمة المنتجات المحفوظة
        savedProductsList.addEventListener('click', (event) => {
            const target = event.target;
            const productDiv = target.closest('.product-card'); /* Use product-card class */
            if (!productDiv) return;

            const productId = parseInt(productDiv.dataset.id);
            if (isNaN(productId)) return;

            // Check if the clicked element or its parent is one of the buttons
            if (target.classList.contains('btn-warning') || target.closest('.btn-warning')) {
                editProduct(productId);
            } else if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) {
                deleteProduct(productId);
            } else if (target.classList.contains('stock-adjust-btn')) {
                const stockInput = productDiv.querySelector('.stock-input');
                let currentVal = parseInt(stockInput.value) || 0;
                if (target.dataset.action === 'plus') currentVal++;
                else if (target.dataset.action === 'minus') currentVal--;
                stockInput.value = Math.max(0, currentVal);
                updateStockInLocalStorage(productId, currentVal);
            } else if (target.classList.contains('quantity-adjust-btn')) {
                const quantityInput = productDiv.querySelector('.product-quantity-input');
                let currentVal = parseInt(quantityInput.value) || 0;
                if (target.dataset.action === 'plus') currentVal++;
                else if (target.dataset.action === 'minus') currentVal--;
                quantityInput.value = Math.max(0, currentVal);
                updateInvoiceQuantityInLocalStorage(productId, currentVal);
            }
        });

        // معالجات أحداث لتغييرات الإدخال داخل قائمة المنتجات المحفوظة (المخزون والكمية)
        savedProductsList.addEventListener('change', (event) => {
            const target = event.target;
            const productDiv = target.closest('.product-card'); /* Use product-card class */
            if (!productDiv) return;

            const productId = parseInt(productDiv.dataset.id);
            if (isNaN(productId)) return;

            if (target.classList.contains('stock-input')) {
                updateStockInLocalStorage(productId, parseInt(target.value));
            } else if (target.classList.contains('product-quantity-input')) {
                updateInvoiceQuantityInLocalStorage(productId, parseInt(target.value));
            }
        });

        searchProductInput.classList.add('search-input'); // Apply search-input class to #searchProduct
        searchProductInput.addEventListener('input', displaySavedProducts);

        /**
         * وظيفة مساعدة لتحديد أولوية حالة بطاقة المنتج للفرز والتصميم.
         * @param {number} quantitySelected - الكمية المحددة للفاتورة الحالية.
         * @param {number} stockQuantity - الكمية الحالية في المخزون.
         * @returns {number} قيمة الأولوية (الأقل يعني أولوية أعلى).
         */
        function getProductStatusPriority(quantitySelected, stockQuantity) {
            // Prioritize items with insufficient stock for the selected quantity
            if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1;
            // Then items selected for invoice (sufficient stock)
            if (quantitySelected > 0) return 4;
            // Then items with positive stock
            if (stockQuantity > 0) return 5;
            // Default (zero stock, not selected)
            return 6;
        }

        /**
         * تحديث فئات CSS لبطاقة المنتج بناءً على حالة المخزون والكمية المحددة.
         * @param {HTMLElement} productDiv - عنصر div للمنتج.
         * @param {number} quantitySelected - الكمية المحددة للفاتورة.
         * @param {number} stockQuantity - الكمية الحالية في المخزون.
         */
        function updateProductDivClass(productDiv, quantitySelected, stockQuantity) {
            // Preserve existing classes like 'is-local' or 'is-local-match'
            const existingClasses = Array.from(productDiv.classList).filter(cls => 
                cls === 'is-local' || cls === 'is-local-match'
            );
            productDiv.className = 'product-card'; // Reset all other classes
            existingClasses.forEach(cls => productDiv.classList.add(cls)); // Re-add preserved classes

            if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                productDiv.classList.add('status-insufficient');
            } else if (quantitySelected > 0) {
                productDiv.classList.add('status-selected-sufficient');
            } else if (stockQuantity > 0) {
                productDiv.classList.add('status-stock-positive');
            } else {
                productDiv.classList.add('status-default');
            }
        }

        /**
         * تحديث كمية المخزون في التخزين المحلي وتحديث واجهة المستخدم.
         * @param {number} id - معرف المنتج.
         * @param {number} newStockQuantity - قيمة المخزون الجديدة.
         */
        function updateStockInLocalStorage(id, newStockQuantity) {
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].stockQuantity = Math.max(0, newStockQuantity);
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product-card[data-id="${id}"]`);
                if (productDiv) {
                    const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                    updateProductDivClass(productDiv, quantityToDisplay, savedProducts[productIndex].stockQuantity);
                }
            }
        }

        /**
         * تحديث كمية الفاتورة في التخزين المحلي وتحديث واجهة المستخدم.
         * @param {number} id - معرف المنتج.
         * @param {number} newQuantity - كمية الفاتورة الجديدة.
         */
        function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].quantity = Math.max(0, newQuantity);
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product-card[data-id="${id}"]`);
                if (productDiv) {
                    const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                    updateProductDivClass(productDiv, savedProducts[productIndex].quantity, stockQuantityToDisplay);
                }
            }
        }

        // ====== إنشاء وعرض الفاتورة ======

        /**
         * يعرض فاتورة كاملة في قسم الفاتورة المخصص.
         * @param {object} invoiceData - كائن بيانات الفاتورة.
         * @param {boolean} isNew - صحيح إذا كانت فاتورة تم إنشاؤها حديثاً، خطأ إذا كانت من الأرشيف.
         */
        async function displayFullInvoice(invoiceData, isNew = false) {
            await showSection(invoiceDisplay);
            mainContainer.classList.add('full-width');

            // تعبئة تفاصيل الفاتورة
            document.getElementById('displayCustomerName').textContent = invoiceData.customerName || 'N/A';
            document.getElementById('displayInvoiceOwner').textContent = invoiceData.ownerName || 'N/A';
            document.getElementById('displayInvoiceDate').textContent = invoiceData.date || 'N/A';
            document.getElementById('displayTotalAmountBeforeCommission').textContent = `${parseFloat(invoiceData.totalHTBeforeCommission || 0).toFixed(2)} DH`;
            document.getElementById('displayCommissionDeducted').textContent = `${parseFloat(invoiceData.totalCommission || 0).toFixed(2)} DH`;
            document.getElementById('displayTotalAmount').textContent = `${parseFloat(invoiceData.totalHT || 0).toFixed(2)} DH`;
            document.getElementById('displayTVA').textContent = `${parseFloat(invoiceData.tva || 0).toFixed(2)} DH`;
            document.getElementById('displayTotalTTC').textContent = `${parseFloat(invoiceData.totalTTC || 0).toFixed(2)} DH`;
            document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceData.ownerPhone || 'N/A';
            document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceData.ownerAddress || 'N/A';

            // تعبئة جدول المنتجات
            const detailsTbody = document.getElementById('displayDetails');
            detailsTbody.innerHTML = '';
            let productNumber = 1;
            if (invoiceData.products && invoiceData.products.length > 0) {
                invoiceData.products.forEach(product => {
                    const productDetailsRow = document.createElement('tr');
                    productDetailsRow.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${product.name || 'N/A'}</td>
                        <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</td>
                        <td>${product.quantityUsed || 0}</td>
                        <td>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetailsRow);
                });
            } else {
                const noProductsRow = document.createElement('tr');
                noProductsRow.innerHTML = `<td colspan="5" style="text-align: center; font-style: italic;">لا توجد منتجات في هذه الفاتورة.</td>`;
                detailsTbody.appendChild(noProductsRow);
            }

            // إدارة رؤية زر "تحديث المخزون"
            const savePdfButton = document.getElementById('savePdfButton');
            savePdfButton.style.display = isNew ? 'flex' : 'none';
            isNewInvoice = isNew; // Set flag for if this is a new invoice

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
            e.preventDefault();

            // Store current TVA value
            localStorage.setItem('tva', tvaInput.value);

            if (!checkFields(invoiceForm)) {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                return;
            }

            let totalHTBeforeCommission = 0;
            let totalProfit = 0;
            let totalCommission = 0;

            let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);

            let productsToProcessForInvoice = []; // This will be the array actually used for calculation and display

            if (selectedProductsForInvoice.length === 0) {
                const confirmed = await showConfirmModal(
                    "تحديد المنتجات",
                    "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة جميع المنتجات بكمية 1 بشكل افتراضي (حتى لو كان المخزون غير متوفر)؟" // Updated confirmation message
                );
                if (confirmed) {
                    productsToProcessForInvoice = allSavedProducts.map(product => {
                        // Create a shallow copy to avoid modifying the original product object from allSavedProducts
                        // Set quantityUsed to 1 for all products for this invoice, regardless of original saved quantity or stock
                        return { ...product, quantityUsed: 1, quantity: (product.quantity || 0) }; // Keep original quantity for localStorage, but set quantityUsed to 1 for this invoice
                    });

                    // Filter out any products that now have quantityUsed = 0 after mapping (shouldn't happen with current logic, but good practice)
                    productsToProcessForInvoice = productsToProcessForInvoice.filter(p => p.quantityUsed > 0);

                    if (productsToProcessForInvoice.length === 0) {
                        showToast("لا توجد منتجات لتضمينها في الفاتورة بعد التحديث.", 'info');
                        return;
                    }
                } else {
                    showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                    return;
                }
            } else {
                // If products were already selected by the user, use them as is.
                // Ensure 'quantityUsed' is set correctly from 'quantity' for clarity in invoice data structure.
                productsToProcessForInvoice = selectedProductsForInvoice.map(product => ({
                    ...product,
                    quantityUsed: product.quantity // Use the already selected quantity
                }));
            }

            // Now, calculate totals based on productsToProcessForInvoice
            productsToProcessForInvoice.forEach((productData) => {
                const quantity = productData.quantityUsed; // Use quantityUsed for calculations
                const sellingPrice = parseFloat(productData.sellingPrice || 0);
                const purchasePrice = parseFloat(productData.purchasePrice || 0);
                const itemHT = sellingPrice * quantity;
                totalHTBeforeCommission += itemHT;

                const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0;
                const commissionPerUnit = profitPerUnitBeforeCommission * (parseFloat(invoiceCommissionPercentageInput.value) / 100);
                const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;

                totalProfit += actualProfitPerUnit * quantity;
                totalCommission += commissionPerUnit * quantity;
            });

            const finalTotalHT = totalHTBeforeCommission - totalCommission;
            const tvaRate = parseFloat(tvaInput.value) / 100;
            const tva = (finalTotalHT * tvaRate).toFixed(2);
            const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);

            // Save invoice owner details to local storage for persistence
            localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
            localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
            localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);

            // Create the invoice data object. This is NOT saved to local storage/Firebase yet.
            currentInvoiceBeingProcessed = { // Store in global variable
                id: Date.now(), // Unique ID for the invoice
                date: invoiceDateInput.value,
                isoDate: new Date().toISOString(), // For reliable sorting by date
                customerName: customerNameInput.value,
                ownerName: invoiceOwnerInput.value,
                ownerAddress: invoiceOwnerAddressInput.value,
                ownerPhone: invoiceOwnerPhoneInput.value,
                // Ensure products in invoiceDataToSave reflect the 'quantityUsed'
                products: productsToProcessForInvoice,
                totalHT: finalTotalHT.toFixed(2),
                totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                tva: tva,
                totalTTC: totalTTC,
                totalProfit: totalProfit.toFixed(2),
                totalCommission: totalCommission.toFixed(2),
                invoiceCommissionRate: parseFloat(invoiceCommissionPercentageInput.value)
            };

            await displayFullInvoice(currentInvoiceBeingProcessed, true); // Display the invoice, mark as new

            // No direct save to Firebase or local storage here. This happens when "Update Stock" is clicked.
            populateAllDatalists(); // Update datalists after invoice creation
        });

        // Event listener for the "Update Stock" button on the invoice display
        document.getElementById('savePdfButton').addEventListener('click', async function() {
            if (!isNewInvoice) {
                showToast("لا يمكن تحديث المخزون لفاتورة مؤرشفة. يجب أن تكون فاتورة جديدة.", 'info');
                return;
            }

            // Use the globally stored invoice data
            if (!currentInvoiceBeingProcessed) {
                showToast("خطأ: لا توجد فاتورة قيد المعالجة لتحديث المخزون.", 'error');
                return;
            }

            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let hasInsufficientStock = false;
            let productsToUpdate = [];

            // First, check for insufficient stock based on currentInvoiceBeingProcessed.products
            currentInvoiceBeingProcessed.products.forEach((invoiceProduct) => {
                const productData = savedProducts.find(p => (p.name || '').toLowerCase() === (invoiceProduct.name || '').toLowerCase()); // Find by name as ID might differ if product was imported

                if (productData) {
                    const currentStock = parseInt(productData.stockQuantity || 0);
                    const quantityUsedInInvoice = invoiceProduct.quantityUsed;

                    // IMPORTANT: Only check for insufficient stock if quantityUsedInInvoice > 0
                    if (quantityUsedInInvoice > 0 && currentStock < quantityUsedInInvoice) {
                        hasInsufficientStock = true;
                        showToast(`تنبيه: كمية غير كافية للمنتج "${invoiceProduct.name}". المخزون المتاح: ${currentStock}`, 'error');
                    }
                    // Only push to productsToUpdate if it was actually selected for the invoice (quantityUsed > 0)
                    if (quantityUsedInInvoice > 0) {
                        productsToUpdate.push({ productId: productData.id, quantityUsed: quantityUsedInInvoice });
                    }
                } else {
                    // Handle case where product in invoice doesn't exist locally. Maybe it was deleted locally after invoice creation?
                    // For now, if the product was intended to be sold (quantityUsed > 0), treat as a critical issue.
                    if (invoiceProduct.quantityUsed > 0) {
                        hasInsufficientStock = true;
                        showToast(`تنبيه: المنتج "${invoiceProduct.name}" في الفاتورة غير موجود محلياً. لا يمكن تحديث المخزون.`, 'error');
                    }
                }
            });

            if (hasInsufficientStock) {
                showToast("يرجى مراجعة المنتجات ذات المخزون غير الكافي قبل التحديث.", 'error');
                return;
            }

            const confirmed = await showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة وحفظها؟");

            if (confirmed) {
                // If confirmed and no insufficient stock, proceed with update
                productsToUpdate.forEach(({ productId, quantityUsed }) => {
                    const productDataIndex = savedProducts.findIndex(p => p.id === productId);
                    if (productDataIndex !== -1) {
                        savedProducts[productDataIndex].stockQuantity -= quantityUsed;
                        savedProducts[productDataIndex].stockQuantity = Math.max(0, savedProducts[productDataIndex].stockQuantity); // Ensure non-negative
                        // Important: Reset the 'quantity' property for the original product in local storage
                        // so it doesn't show as pre-selected for the next invoice.
                        savedProducts[productDataIndex].quantity = 0; 
                    }
                });

                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                
                // Now, save the invoice data to Firebase
                const firebasePath = `${appId}/alldata/${currentInvoiceBeingProcessed.ownerPhone}`;
                if (database) {
                    database.ref(firebasePath).push(currentInvoiceBeingProcessed)
                        .then(() => showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success'))
                        .catch(error => showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error'));
                } else {
                    showToast("لم يتم تهيئة قاعدة بيانات Firebase. لا يمكن حفظ الفاتورة.", 'error');
                }

                // Also save to local archive
                saveInvoiceToLocalStorage(currentInvoiceBeingProcessed);

                showToast('تم تحديث المخزون وحفظ الفاتورة بنجاح.', 'success');
                
                // Clear the processed invoice data
                currentInvoiceBeingProcessed = null;
                isNewInvoice = false; // Mark this invoice as "processed" for stock update

                // Redirect back to dashboard after stock update
                if (window.innerWidth <= 768) {
                    mobileNavButtons[0].click(); // mobileShowDashboardButton
                } else {
                    desktopNavButtons[0].click(); // desktopShowDashboardButton
                }
                populateAllDatalists(); // Update datalists after stock update and save
            } else {
                showToast("تم إلغاء تحديث المخزون.", 'info');
            }
        });

        document.getElementById('printButton').addEventListener('click', function() {
            // Temporarily adjust viewport meta for better print formatting
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            let originalViewportContent = '';
            if (viewportMeta) {
                originalViewportContent = viewportMeta.getAttribute('content');
                viewportMeta.setAttribute('content', 'width=1024'); // Set a fixed width for printing
            }

            // Hide the print/stock update buttons during print
            const invoicePrintGroup = document.querySelector('.invoice-actions-print-group');
            if (invoicePrintGroup) {
                invoicePrintGroup.style.display = 'none';
            }

            window.print(); // Trigger the browser's print dialog

            // Restore elements and viewport meta after a short delay (allowing print dialog to appear/close)
            setTimeout(() => {
                if (invoicePrintGroup) {
                    invoicePrintGroup.style.display = 'flex'; // Restore button visibility
                }
                if (viewportMeta && originalViewportContent) {
                    viewportMeta.setAttribute('content', originalViewportContent); // Restore original viewport
                }
            }, 500); // Give browser time to process print
        });

        // ====== عرض بيانات Firebase والإحصائيات ======

        /**
         * تعبئة datalist معين بالقيم الفريدة من مصفوفة بيانات.
         * @param {HTMLElement} datalistElement - عنصر الـ datalist لملئه.
         * @param {Array<object>} sourceArray - المصفوفة المصدرية (مثل savedProducts أو allFirebaseInvoicesData).
         * @param {string} propertyName - اسم الخاصية في كائنات المصفوفة التي نريد استخراج القيم منها.
         */
        function populateUniqueDatalist(datalistElement, sourceArray, propertyName) {
            const uniqueValues = new Set();
            sourceArray.forEach(item => {
                if (item && item[propertyName]) {
                    uniqueValues.add(item[propertyName].trim());
                }
            });
            // Also add values from nested products array if applicable (e.g., product names, supplier names within invoice products)
            if (propertyName === 'name' || propertyName === 'supplierName') {
                allFirebaseInvoicesData.forEach(invoice => {
                    if (invoice.products) {
                        invoice.products.forEach(product => {
                            if (propertyName === 'name' && product.name) {
                                uniqueValues.add(product.name.trim());
                            }
                            if (propertyName === 'supplierName' && product.supplierName) {
                                uniqueValues.add(product.supplierName.trim());
                            }
                        });
                    }
                });
            }

            datalistElement.innerHTML = ''; // Clear existing options
            Array.from(uniqueValues).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                datalistElement.appendChild(option);
            });
        }

        /**
         * تعبئة جميع قوائم البيانات (datalists) في التطبيق.
         */
        function populateAllDatalists() {
            // For product management form
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            populateUniqueDatalist(productNamesDatalist, savedProducts, 'name');
            populateUniqueDatalist(supplierNamesDatalist, savedProducts, 'supplierName');
            populateUniqueDatalist(supplierAddressesDatalist, savedProducts, 'supplierAddress');
            populateUniqueDatalist(supplierPhonesDatalist, savedProducts, 'supplierPhone');

            // For invoice creation form
            // Get combined data for customers/owners/suppliers from both local and Firebase
            const allInvoiceRelatedData = [...allLocalInvoices, ...allFirebaseInvoicesData];
            populateUniqueDatalist(customerNamesDatalist, allInvoiceRelatedData, 'customerName');
            populateUniqueDatalist(invoiceOwnersDatalist, allInvoiceRelatedData, 'ownerName');
            populateUniqueDatalist(invoiceOwnerAddressesDatalist, allInvoiceRelatedData, 'ownerAddress');
            populateUniqueDatalist(invoiceOwnerPhonesDatalist, allInvoiceRelatedData, 'ownerPhone');

            // For common search input
            populateUniqueDatalist(allSearchOptionsDatalist, savedProducts, 'name'); // Product names from local
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'customerName');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerName');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerPhone');
            populateUniqueDatalist(allSearchOptionsDatalist, allInvoiceRelatedData, 'supplierName');


            // For local invoice search
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'customerName');
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'ownerName');
            populateUniqueDatalist(localInvoiceSearchOptionsDatalist, allLocalInvoices, 'date');
            // Can also add product names from local invoices, which might be helpful
            allLocalInvoices.forEach(invoice => {
                if (invoice.products) {
                    invoice.products.forEach(p => {
                        if (p.name) {
                            const option = document.createElement('option');
                            option.value = p.name.trim();
                            localInvoiceSearchOptionsDatalist.appendChild(option);
                        }
                    });
                }
            });
        }

        /**
         * تعبئة القائمة المنسدلة لرقم الهاتف لتصفية بيانات Firebase.
         */
        function populateCommonDropdown() {
            if (!database) {
                showToast("قاعدة بيانات Firebase غير جاهزة لملء أرقام الهواتف.", 'info');
                return;
            }
            const alldataRef = database.ref(`${appId}/alldata`);
            alldataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                commonPhoneDropdown.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'عرض الكل';
                commonPhoneDropdown.appendChild(allOption);

                const phoneNumbers = new Set();
                if (data) {
                    for (const phoneKey in data) {
                        if (data.hasOwnProperty(phoneKey)) {
                            phoneNumbers.add(phoneKey);
                        }
                    }
                }
                Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    commonPhoneDropdown.appendChild(option);
                });
            }, (error) => {
                showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
            });
        }

        /**
         * جلب جميع البيانات من Firebase، معالجتها، ثم تطبيق المرشحات وعرضها.
         */
        async function fetchAndDisplayCombinedFirebaseData() {
            if (!database) {
                showToast("قاعدة بيانات Firebase غير جاهزة لجلب البيانات.", 'info');
                return;
            }

            const alldataRef = database.ref(`${appId}/alldata`);
            let snapshot;
            try {
                snapshot = await alldataRef.once('value');
            } catch (error) {
                showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                return;
            }

            const data = snapshot.val();
            allFirebaseProducts = []; // Reset global product list
            allFirebaseInvoicesData = []; // Reset global invoice list

            if (data) {
                for (const phoneKey in data) {
                    if (data.hasOwnProperty(phoneKey)) {
                        const phoneData = data[phoneKey];
                        for (const invoiceKey in phoneData) {
                            if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                const invoiceDetails = phoneData[invoiceKey];
                                allFirebaseInvoicesData.push({ id: invoiceKey, firebasePhoneKey: phoneKey, ...invoiceDetails });

                                // Flatten products for overall stats and search by product
                                invoiceDetails.products.forEach((product, index) => {
                                    allFirebaseProducts.push({
                                        id: `${invoiceKey}-${index}`, // Unique ID for each product instance in a specific invoice
                                        ...product,
                                        invoiceDate: invoiceDetails.date,
                                        customerName: invoiceDetails.customerName,
                                        ownerName: invoiceDetails.ownerName,
                                        ownerAddress: invoiceDetails.ownerAddress,
                                        ownerPhone: invoiceDetails.ownerPhone,
                                        totalHT: invoiceDetails.totalHT,
                                        totalTTC: invoiceDetails.totalTTC,
                                        totalProfit: invoiceDetails.totalProfit,
                                        totalCommission: invoiceDetails.totalCommission,
                                        firebaseInvoiceKey: invoiceKey // Reference back to the original invoice in Firebase
                                    });
                                });
                            }
                        }
                    }
                }
            }

            populateAllDatalists(); // Call populateAllDatalists here to update all suggestions
            applyCombinedFilters(); // Apply filters and display data
        }

        /**
         * تضيف أو تحدث منتجات متعددة من فاتورة Firebase في التخزين المحلي.
         * @param {Array<object>} firebaseProducts - مصفوفة المنتجات من فاتورة Firebase.
         */
        async function addOrUpdateProductsFromFirebaseInvoiceToLocal(firebaseProducts) {
            if (!firebaseProducts || firebaseProducts.length === 0) {
                showToast("لا توجد منتجات لإضافتها/تحديثها من هذه الفاتورة.", 'info');
                return;
            }

            const confirmed = await showConfirmModal(
                "إضافة/تحديث المنتجات المحلية",
                `هل أنت متأكد من أنك تريد إضافة أو تحديث ${firebaseProducts.length} منتجاً من هذه الفاتورة إلى المنتجات المحلية؟`
            );

            if (!confirmed) {
                showToast("تم إلغاء عملية إضافة/تحديث المنتجات.", 'info');
                return;
            }

            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let productsAdded = 0;
            let productsUpdated = 0;

            firebaseProducts.forEach(firebaseProduct => {
                // Find existing local product by name and supplier phone (or invoice owner phone)
                const existingLocalProductIndex = savedProducts.findIndex(localP =>
                    (localP.name || '').toLowerCase() === (firebaseProduct.name || '').toLowerCase() &&
                    (localP.supplierPhone === firebaseProduct.ownerPhone || localP.supplierPhone === firebaseProduct.supplierPhone) // Check both as supplierPhone might be invoice owner phone
                );

                if (existingLocalProductIndex !== -1) {
                    // Update existing product
                    const existingLocalProduct = savedProducts[existingLocalProductIndex];
                    existingLocalProduct.purchasePrice = parseFloat(firebaseProduct.purchasePrice || 0);
                    existingLocalProduct.sellingPrice = parseFloat(firebaseProduct.sellingPrice || 0);
                    existingLocalProduct.supplierName = firebaseProduct.supplierName || firebaseProduct.ownerName || 'N/A'; // Use invoice owner if supplier name not explicitly set
                    existingLocalProduct.supplierAddress = firebaseProduct.ownerAddress || 'N/A';
                    existingLocalProduct.supplierPhone = firebaseProduct.ownerPhone; // Ensure supplierPhone is consistent
                    existingLocalProduct.date = new Date().toLocaleDateString('ar-MA'); // Update last modified date
                    productsUpdated++;
                } else {
                    // Add new product
                    const newLocalProduct = {
                        id: Date.now() + Math.random(), // Unique ID for local storage
                        name: firebaseProduct.name,
                        purchasePrice: parseFloat(firebaseProduct.purchasePrice || 0),
                        sellingPrice: parseFloat(firebaseProduct.sellingPrice || 0),
                        supplierName: firebaseProduct.supplierName || firebaseProduct.ownerName || 'N/A',
                        supplierAddress: firebaseProduct.ownerAddress || 'N/A',
                        supplierPhone: firebaseProduct.ownerPhone,
                        stockQuantity: 0, // When adding from Firebase invoice, initial stock should be 0 unless specified otherwise
                        date: new Date().toLocaleDateString('ar-MA'),
                        quantity: 0, // Reset selected quantity for new local product
                        isLocal: true
                    };
                    savedProducts.push(newLocalProduct);
                    productsAdded++;
                }
            });

            savedProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
            displaySavedProducts(); // Re-render the saved products list
            showToast(`تم إضافة ${productsAdded} منتج(ات) وتحديث ${productsUpdated} منتج(ات) محلياً.`, 'success');
            populateAllDatalists(); // Update datalists after adding/updating products from Firebase
        }

        /**
         * تطبيق المرشحات على قائمة فواتير Firebase والإحصائيات بناءً على البحث والقائمة المنسدلة.
         */
        function applyCombinedFilters() {
            const searchTerm = commonSearchInput.value.toLowerCase();
            const selectedPhoneNumber = commonPhoneDropdown.value;

            let filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                const matchesSearchInput = searchTerm ?
                    ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm) || (p.supplierName || '').toLowerCase().includes(searchTerm))))
                    : true;

                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);

                return matchesSearchInput && matchesPhoneNumber;
            });

            firebaseProductListCountSpan.textContent = filteredInvoices.length;

            // Sort invoices by date (most recent first)
            filteredInvoices.sort((a, b) => {
                const dateA = new Date(a.isoDate || a.date);
                const dateB = new Date(b.isoDate || b.date);
                return dateB - dateA;
            });

            displayFirebaseInvoices(filteredInvoices);
            displayStatistics(filteredInvoices);
        }

        commonSearchInput.classList.add('search-input'); // Apply search-input class to #commonSearchInput
        commonSearchInput.addEventListener('input', applyCombinedFilters);

        clearCommonSearchInputButton.addEventListener('click', () => {
            commonSearchInput.value = '';
            applyCombinedFilters();
            showToast("تم مسح حقل البحث وتحديث القائمة.", 'info');
        });

        commonPhoneDropdown.addEventListener('change', applyCombinedFilters);

        /**
         * يعرض قائمة فواتير Firebase كبطاقات فاتورة مصغرة.
         * @param {Array<object>} invoices - مصفوفة من كائنات الفاتورة للعرض.
         */
        function displayFirebaseInvoices(invoices) {
            firebaseProductListContainer.innerHTML = '';
            if (invoices.length === 0) {
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد فواتير لعرضها.</p>';
                return;
            }

            invoices.forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.classList.add('mini-invoice-card');
                invoiceDiv.dataset.invoiceId = invoice.id;

                let productsListHtml = '';
                if (invoice.products && invoice.products.length > 0) {
                    productsListHtml = `
                        <div class="mini-product-list">
                            <div class="mini-product-item-header">
                                <div>المنتج</div>
                                <div>الكمية</div>
                                <div>الإجمالي (HT)</div>
                            </div>
                            ${invoice.products.map(product => `
                                <div class="mini-product-item-row">
                                    <div>${product.name || 'N/A'}</div>
                                    <div>${product.quantityUsed || 0}</div>
                                    <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    productsListHtml = '<p style="text-align: center; font-style: italic; color: var(--text-secondary-gray);">لا توجد منتجات في هذه الفاتورة.</p>';
                }

                invoiceDiv.innerHTML = `
                    <div class="invoice-mini-header">
                        <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                        <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                    </div>
                    ${productsListHtml}
                    <div class="invoice-mini-footer">
                        <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                        <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                    </div>
                    <div class="invoice-actions">
                        <button type="button" class="btn-base btn-secondary-light" data-firebase-invoice-id="${invoice.id}"><span class="icon"><i class="fas fa-file-import"></i></span>إضافة/تعديل المنتجات محلياً</button>
                    </div>
                `;
                
                invoiceDiv.querySelector('.btn-secondary-light').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent the main card click event if there was one
                    const firebaseInvoiceId = event.target.dataset.firebaseInvoiceId;
                    const selectedFirebaseInvoice = invoices.find(inv => inv.id === firebaseInvoiceId);
                    if (selectedFirebaseInvoice) {
                        addOrUpdateProductsFromFirebaseInvoiceToLocal(selectedFirebaseInvoice.products);
                    } else {
                        showToast("تعذر العثور على الفاتورة في بيانات Firebase.", 'error');
                    }
                });

                firebaseProductListContainer.appendChild(invoiceDiv);
            });
        }

        /**
         * يدمر مثيلات Chart.js الموجودة.
         */
        function destroyCharts() {
            if (topSellingProductsChartInstance) topSellingProductsChartInstance.destroy();
            if (topCustomersChartInstance) topCustomersChartInstance.destroy();
            if (topInvoiceOwnersChartInstance) topInvoiceOwnersChartInstance.destroy();
            if (topSuppliersChartInstance) topSuppliersChartInstance.destroy();
        }

        /**
         * يرسم الرسوم البيانية للإحصائيات باستخدام Chart.js.
         * @param {string} chartId - معرف عنصر canvas.
         * @param {string} chartTitle - عنوان الرسم البياني.
         * @param {string} labelPrefix - بادئة للتسميات (مثال: "كمية: ").
         * @param {string} valueSuffix - لاحقة للقيم (مثال: " DH").
         * @param {Array<object>} dataPoints - مصفوفة من كائنات {name, value}.
         * @param {'bar'|'pie'} chartType - نوع الرسم البياني المراد رسمه.
         * @param {Chart} chartInstance - مثيل Chart.js لتحديثه/إنشائه.
         * @param {function} onClickHandler - الوظيفة التي سيتم استدعاؤها عند النقر على عنصر الرسم البياني.
         * @returns {Chart} مثيل Chart.js الجديد.
         */
        function renderChart(chartId, chartTitle, labelPrefix, valueSuffix, dataPoints, chartType, chartInstance, onClickHandler) {
            const ctx = document.getElementById(chartId);
            if (!ctx) return null;

            if (chartInstance) {
                chartInstance.destroy(); // Destroy previous instance
            }

            const labels = dataPoints.map(item => item.name);
            const values = dataPoints.map(item => item.value);

            const backgroundColors = [
                'hsla(205, 78%, 42%, 0.8)', /* Accent blue */
                'hsla(135, 60%, 42%, 0.8)', /* Accent green */
                'hsla(39, 90%, 60%, 0.8)',  /* Accent orange */
                'hsla(350, 70%, 55%, 0.8)', /* Accent red */
                'hsla(210, 29%, 29%, 0.8)', /* Primary dark blue */
                'hsla(210, 5%, 40%, 0.8)',  /* Secondary gray */
                'hsla(210, 30%, 98%, 0.8)', /* Light background */
                'hsla(0, 0%, 100%, 0.8)',   /* White background */
                'hsla(210, 10%, 15%, 0.8)', /* Primary dark text */
                'hsla(210, 5%, 90%, 0.8)'   /* Light border */
            ];
            const borderColors = [
                'hsla(205, 78%, 42%, 1)',
                'hsla(135, 60%, 42%, 1)',
                'hsla(39, 90%, 60%, 1)',
                'hsla(350, 70%, 55%, 1)',
                'hsla(210, 29%, 29%, 1)',
                'hsla(210, 5%, 40%, 1)',
                'hsla(210, 30%, 98%, 1)',
                'hsla(0, 0%, 100%, 1)',
                'hsla(210, 10%, 15%, 1)',
                'hsla(210, 5%, 90%, 1)'
            ];

            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: values,
                        backgroundColor: chartType === 'pie' ? backgroundColors : backgroundColors[0],
                        borderColor: chartType === 'pie' ? borderColors : borderColors[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie',
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-gray'),
                                font: {
                                    family: 'Cairo',
                                }
                            }
                        },
                        title: {
                            display: chartType !== 'pie',
                            text: chartTitle,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--primary-blue-dark'),
                            font: {
                                size: 16,
                                family: 'Cairo',
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += labelPrefix + (context.parsed.y || context.parsed) + valueSuffix;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-gray'),
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-light')
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-gray'),
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-light')
                            }
                        }
                    } : {}
                }
            };
            const newChartInstance = new Chart(ctx, chartConfig);

            if (onClickHandler) {
                ctx.onclick = function(evt) {
                    const activePoints = newChartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                    if (activePoints.length > 0) {
                        const firstPoint = activePoints[0];
                        const label = newChartInstance.data.labels[firstPoint.index];
                        onClickHandler(label);
                    }
                };
            }

            return newChartInstance;
        }

        /**
         * عرض الإحصائيات ورسم الرسوم البيانية بناءً على بيانات الفواتير المصفاة.
         * @param {Array<object>} invoices - مصفوفة من كائنات الفاتورة للحساب.
         */
        function displayStatistics(invoices) {
            let totalSalesHT = 0;
            let totalTVA = 0;
            let totalSalesTTC = 0;
            let totalOverallProfit = 0;
            let totalOverallCommission = 0;
            let totalPurchaseCostAllProducts = 0;
            let totalSellingPriceAllProducts = 0;

            const productSales = {}; // { productName: { quantitySold, totalRevenue } }
            const customerActivity = {}; // { customerName: { invoiceCount, totalProfit, totalTTC } }
            const invoiceOwnerActivity = {}; // { ownerName: { invoiceCount, totalProfit, totalTTC } }
            const supplierActivity = {}; // { supplierName: { totalPurchaseCost, productsCount } }

            invoices.forEach(invoice => {
                totalSalesHT += parseFloat(invoice.totalHT || 0);
                totalTVA += parseFloat(invoice.tva || 0);
                totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                if (invoice.products) {
                    invoice.products.forEach(product => {
                        const productName = product.name || 'N/A';
                        const quantityUsed = parseInt(product.quantityUsed || 0);
                        const purchasePrice = parseFloat(product.purchasePrice || 0);
                        const sellingPrice = parseFloat(product.sellingPrice || 0);
                        const supplierName = product.supplierName || invoice.ownerName || 'N/A'; // Fallback to invoice owner name

                        totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                        totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                        if (!productSales[productName]) {
                            productSales[productName] = { quantitySold: 0, totalRevenue: 0 };
                        }
                        productSales[productName].quantitySold += quantityUsed;
                        productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                        if (!supplierActivity[supplierName]) {
                            supplierActivity[supplierName] = { totalPurchaseCost: 0, productsCount: 0 };
                        }
                        supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                        supplierActivity[supplierName].productsCount += quantityUsed;
                    });
                }

                const customer = invoice.customerName || 'N/A';
                const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                const owner = invoice.ownerName || 'N/A';

                if (!customerActivity[customer]) {
                    customerActivity[customer] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                customerActivity[customer].invoiceCount += 1;
                customerActivity[customer].totalProfit += invoiceProfit;
                customerActivity[customer].totalTTC += invoiceTTC;

                if (!invoiceOwnerActivity[owner]) {
                    invoiceOwnerActivity[owner] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                invoiceOwnerActivity[owner].invoiceCount += 1;
                invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
            });

            // Update simple stats display
            document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
            document.getElementById('totalSellingPrice').textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
            document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`;
            document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`;
            document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`;
            document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
            document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;

            // Prepare data for charts and lists
            const topSellingProductsData = Object.entries(productSales)
                .sort(([, a], [, b]) => b.quantitySold - a.quantitySold)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue }));

            const topCustomersData = Object.entries(customerActivity)
                .sort(([, a], [, b]) => b.totalTTC - a.totalTTC)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC }));

            const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity)
                .sort(([, a], [, b]) => b.totalProfit - a.totalProfit)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit }));
            
            const topSuppliersData = Object.entries(supplierActivity)
                .sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount }));


            // Render Charts
            topSellingProductsChartInstance = renderChart(
                'topSellingProductsChart', 'المنتجات الأكثر مبيعاً (الكمية)', 'الكمية: ', ' وحدة', topSellingProductsData, 'bar', topSellingProductsChartInstance,
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); } // Click handler to search by product name
            );
            topCustomersChartInstance = renderChart(
                'topCustomersChart', 'العملاء الأكثر نشاطاً (الإجمالي TTC)', 'المبلغ: ', ' DH', topCustomersData, 'bar', topCustomersChartInstance,
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); } // Click handler to search by customer name
            );
            topInvoiceOwnersChartInstance = renderChart(
                'topInvoiceOwnersChart', 'أصحاب الفواتير الأكثر نشاطاً (الربح)', 'الربح: ', ' DH', topInvoiceOwnersData, 'bar', topInvoiceOwnersChartInstance,
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); } // Click handler to search by owner name
            );
            topSuppliersChartInstance = renderChart(
                'topSuppliersChart', 'الموردون الأكثر نشاطاً (تكلفة الشراء)', 'التكلفة: ', ' DH', topSuppliersData, 'bar', topSuppliersChartInstance,
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); } // Click handler to search by supplier name
            );

            // Render simple lists below charts
            const renderSimpleList = (listId, data, primaryTextFn, secondaryTextFn) => {
                const listEl = document.getElementById(listId);
                if (!listEl) return;
                listEl.innerHTML = ''; // Clear previous items

                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span><strong>${primaryTextFn(item)}</strong></span>
                            <span>${secondaryTextFn(item)}</span>
                        `;
                        li.dataset.searchTerm = item.name; // Store search term on the list item
                        li.addEventListener('click', () => {
                            commonSearchInput.value = li.dataset.searchTerm;
                            applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                    // Add class for scrollability if more than 3 items
                    if (listEl.children.length > 3) {
                        listEl.classList.add('has-more-items');
                    } else {
                        listEl.classList.remove('has-more-items');
                    }
                } else {
                    listEl.innerHTML = '<li>لا توجد بيانات</li>';
                    listEl.classList.remove('has-more-items');
                }
            };

            renderSimpleList(
                'topSellingProductsList',
                topSellingProductsData,
                (item) => item.name,
                (item) => `الكمية: ${item.value} وحدة - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`
            );

            renderSimpleList(
                'topCustomersList',
                topCustomersData,
                (item) => item.name,
                (item) => `فواتير: ${item.value} - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`
            );

            renderSimpleList(
                'topInvoiceOwnersList',
                topInvoiceOwnersData,
                (item) => item.name,
                (item) => `فواتير: ${item.value} - الربح: ${item.secondaryValue.toFixed(2)} DH`
            );

            renderSimpleList(
                'topSuppliersList',
                topSuppliersData,
                (item) => item.name,
                (item) => `الشراء: ${item.value.toFixed(2)} DH - المنتجات: ${item.secondaryValue}`
            );
        }

        // ====== وظائف أرشيف الفواتير المحلية ======

        /**
         * حفظ فاتورة في التخزين المحلي.
         * @param {object} invoiceData - بيانات الفاتورة المراد حفظها.
         */
        function saveInvoiceToLocalStorage(invoiceData) {
            try {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices.push(invoiceData);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("تم حفظ الفاتورة محلياً.", 'success');
                displayLocalInvoices(); // Refresh the local archive display
                populateAllDatalists(); // Update datalists after saving local invoice
            } catch (e) {
                console.error("خطأ في حفظ الفاتورة إلى التخزين المحلي:", e);
                showToast("حدث خطأ أثناء حفظ الفاتورة محلياً.", 'error');
            }
        }

        /**
         * عرض الفواتير المحلية في قسم الأرشيف.
         * يتم عرض كل فاتورة كبطاقة "فاتورة مصغرة" مدمجة.
         */
        function displayLocalInvoices() {
            try {
                allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
            } catch (e) {
                console.error("خطأ في تحليل الفواتير المحلية من التخزين المحلي:", e);
                allLocalInvoices = []; // Reset corrupted data
                showToast("خطأ في قراءة أرشيف الفواتير المحلي. تم إعادة تعيينه.", 'error');
            }

            localInvoicesList.innerHTML = '';
            const searchTerm = searchLocalInvoiceInput.value.toLowerCase();

            const filteredInvoices = allLocalInvoices.filter(invoice => {
                const matchesSearch = searchTerm ?
                    ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.date || '').toLowerCase().includes(searchTerm) ||
                    (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm))))
                    : true;
                return matchesSearch;
            });

            if (filteredInvoices.length === 0) {
                localInvoicesList.innerHTML = '<p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>';
                return;
            }

            // Sort by date (most recent first)
            filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));

            filteredInvoices.forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.classList.add('mini-invoice-card');
                invoiceDiv.dataset.invoiceId = invoice.id;

                let productsListHtml = '';
                if (invoice.products && invoice.products.length > 0) {
                    productsListHtml = `
                        <div class="mini-product-list">
                            <div class="mini-product-item-header">
                                <div>المنتج</div>
                                <div>الكمية</div>
                                <div>الإجمالي (HT)</div>
                            </div>
                            ${invoice.products.map(product => `
                                <div class="mini-product-item-row">
                                    <div>${product.name || 'N/A'}</div>
                                    <div>${product.quantityUsed || 0}</div>
                                    <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    productsListHtml = '<p style="text-align: center; font-style: italic; color: var(--text-secondary-gray);">لا توجد منتجات في هذه الفاتورة.</p>';
                }

                invoiceDiv.innerHTML = `
                    <div class="invoice-mini-header">
                        <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                        <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                    </div>
                    ${productsListHtml}
                    <div class="invoice-mini-footer">
                        <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                        <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                    </div>
                    <div class="invoice-actions">
                        <button type="button" class="btn-base btn-danger" data-invoice-id="${invoice.id}"><span class="icon"><i class="fas fa-trash-alt"></i></span>حذف</button>
                    </div>
                `;
                localInvoicesList.appendChild(invoiceDiv);
            });
            populateAllDatalists(); // Ensure local invoice search datalist is updated
        }

        // تفويض الأحداث لنقرات قائمة الفواتير المحلية (عرض وحذف)
        localInvoicesList.addEventListener('click', async (event) => {
            const target = event.target;
            const invoiceItem = target.closest('.mini-invoice-card'); /* Use mini-invoice-card class */
            if (!invoiceItem) return;

            const invoiceId = parseInt(invoiceItem.dataset.invoiceId);
            const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);

            if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) { /* Changed from btn-delete */
                event.stopPropagation(); // Prevent the main card click if delete button is clicked
                deleteLocalInvoice(invoiceId);
            } else if (invoiceToView) {
                event.stopPropagation(); // Prevent duplicate handling if click is on card body
                await displayFullInvoice(invoiceToView, false); // Display archived invoice, not new
            } else {
                showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
            }
        });

        /**
         * حذف فاتورة من التخزين المحلي.
         * @param {number} invoiceId - معرف الفاتورة المراد حذفها.
         */
        async function deleteLocalInvoice(invoiceId) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟");
            if (confirmed) {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي.", 'success');
                displayLocalInvoices(); // Refresh the local archive display
                populateAllDatalists(); // Update datalists after deleting local invoice
            } else {
                showToast("تم إلغاء حذف الفاتورة.", 'info');
            }
        }

        searchLocalInvoiceInput.classList.add('search-input'); // Apply search-input class to #searchLocalInvoice
        searchLocalInvoiceInput.addEventListener('input', displayLocalInvoices);

        // استدعاءات التحميل الأولية
        window.addEventListener('load', () => {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' });
            invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
            document.getElementById('displayInvoiceDate').setAttribute('datetime', now.toISOString());

            // Load saved form values from localStorage
            invoiceOwnerInput.value = localStorage.getItem('invoiceOwner') || '';
            invoiceOwnerPhoneInput.value = localStorage.getItem('invoiceOwnerPhone') || '';
            invoiceOwnerAddressInput.value = localStorage.getItem('invoiceOwnerAddress') || '';
            supplierNameInput.value = localStorage.getItem('supplierName') || '';
            supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
            supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
            invoiceCommissionPercentageInput.value = localStorage.getItem('invoiceCommissionPercentage') || '0';
            tvaInput.value = localStorage.getItem('tva') || '0';

            displayLocalInvoices(); // Load and display local invoices
            displaySavedProducts(); // Load and display saved products
            
            // Set initial active navigation button and view
            if (window.innerWidth <= 768) {
                setActiveButton(mobileNavButtons[0], mobileNavButtons);
            } else {
                setActiveButton(desktopNavButtons[0], desktopNavButtons);
            }
            mainContainer.classList.remove('full-width'); // Ensure dashboard view is default width
            resetProductFormAndButtons(); // Reset product form on load
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top on load

            // Initial population of all datalists
            populateAllDatalists();
        });
    </script>
</body>
</html>
