<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون المتقدمة</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --windows-accent-blue: #0078D4;
            --windows-accent-blue-light: #4F9CE4;
            --windows-bg-light: #F3F3F3;
            --windows-bg-medium: #EBEBEB;
            --windows-card-bg: #FFFFFF;
            --windows-text-dark: #201F1E;
            --windows-text-light: #FFFFFF;
            --windows-border-light: #D1D1D1;
            --windows-success-green: #107C10;
            --windows-success-green-light: #E6F3E6;
            --windows-warning-orange: #FF8C00;
            --windows-warning-orange-light: #FFF8E6;
            --windows-error-red: #D13438;
            --windows-error-red-light: #FAE6E6;
            --windows-active-button: #00569B;

            --border-radius: 8px;
            --button-border-radius: 20px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
        }

        [hidden] {
            display: none !important;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            direction: ltr;
            background-color: var(--windows-bg-light);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--windows-text-dark);
            font-size: 16px;
        }

        body {
            padding: var(--spacing-md);
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--windows-accent-blue);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--windows-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--button-border-radius);
            text-align: center;
            background-color: var(--windows-accent-blue-light);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 2px 3px rgba(0,0,0,0.15);
            outline: none;
        }

        .main-controls .btn-panel:hover {
            background-color: #3B7FB9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--windows-text-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        .main-controls .btn-panel.active {
            background-color: var(--windows-active-button);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(0);
        }
        .main-controls .btn-panel.active:hover {
            background-color: var(--windows-active-button);
            transform: translateY(0);
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px;
            margin: 0 auto;
            max-height: calc(100vh - 40px); /* Adjust based on body padding */
            overflow-y: auto;
        }

        .product-container,
        .client-container,
        .invoice,
        .saved-products,
        .saved-products2,
        .statistics-container {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateY(10px);
            opacity: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .container > div:not([hidden]) {
            opacity: 1;
            transform: translateY(0);
        }

        .saved-products3,
        .saved-products4 {
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 280px);
            padding-right: 10px;
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            align-content: start;
        }

        .low-stock-section {
            flex-grow: 0;
            overflow-y: hidden;
            margin-top: 0;
            margin-bottom: var(--spacing-lg);
            padding-right: 0;
            grid-column: 1 / -1;
            background-color: var(--windows-bg-medium);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .low-stock-section h3 {
            color: var(--windows-error-red);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.3em;
            text-align: center;
            border-bottom: 1px dashed var(--windows-error-red);
            padding-bottom: var(--spacing-sm);
        }
        .product-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-sm);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        p {
            margin: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--windows-text-dark);
            font-size: 0.95em;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--windows-error-red);
        }

        .form-group input,
        .form-group textarea,
        #phoneDropdown,
        #statsPhoneDropdown,
        #statsSearchInput {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--windows-bg-medium);
            border-radius: 5px;
            border: 1px solid var(--windows-border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--windows-text-dark);
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        #phoneDropdown:focus,
        #statsPhoneDropdown:focus,
        #statsSearchInput:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--windows-error-red);
        }
        .form-group .validation-error-message {
            color: var(--windows-error-red);
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message {
            display: block;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn,
        .btn1,
        .btn2,
        .btn-delete,
        .btn-edit {
            display: block;
            flex: 1;
            padding: 0.75rem 0;
            color: var(--windows-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--button-border-radius);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 3px rgba(0,0,0,0.15);
            font-size: 0.95em;
            outline: none;
        }
        .btn:focus-visible, .btn1:focus-visible, .btn2:focus-visible, .btn-delete:focus-visible, .btn-edit:focus-visible {
            outline: 2px solid var(--windows-accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        .btn {
            background-color: var(--windows-accent-blue);
        }
        .btn:hover { background-color: #00569B; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn1, .btn2 {
            background-color: var(--windows-success-green);
        }
        .btn1:hover, .btn2:hover { background-color: #0C610C; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn-delete {
            background-color: var(--windows-error-red);
            margin-top: var(--spacing-sm);
        }
        .btn-delete:hover { background-color: #A02B2E; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn-edit {
            background-color: var(--windows-warning-orange);
            color: var(--windows-text-dark);
            margin-top: var(--spacing-sm);
        }
        .btn-edit:hover { background-color: #CC7000; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .invoice {
            margin-top: 0;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .invoice h2 {
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-lg);
            font-size: 1.8em;
        }

        .invoice-header,
        .invoice-footer {
            border: none;
            background-color: var(--windows-bg-medium);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .invoice-header1 {
            background-color: var(--windows-bg-medium);
            text-align: center;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
        }

        .invoice-header1 table {
            width: 100%;
            margin: 0 auto;
        }

        .invoice-header1 tfoot tr td {
            text-align: left;
            font-weight: bold;
            padding: 0.3rem 0;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            background-color: var(--windows-card-bg);
            font-size: 0.95em;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--windows-border-light);
            padding: 0.6rem;
            text-align: left;
        }

        .invoice-table th {
            background-color: var(--windows-accent-blue-light);
            color: var(--windows-text-light);
            font-weight: bold;
        }

        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: right;
            font-weight: bold;
            color: var(--windows-success-green);
            font-size: 1.1em;
        }

        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .invoice .divider {
            border-top: 1px dashed var(--windows-border-light);
            margin: var(--spacing-lg) 0;
        }

        .product,
        .product-item {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-md);
            border-radius: 15px;
            margin-bottom: 0;
            background-color: var(--windows-card-bg);
            position: relative;
            font-size: 0.95em;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }

        .product p, .product-item p {
            margin-bottom: 5px;
        }

        .product-details, .product-firebase-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
        }

        .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
        }
        .product-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            margin-top: 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
        }

        .quantity-controls button {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            background-color: var(--windows-accent-blue);
            color: var(--windows-text-light);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
        }

        .quantity-controls button:hover {
            background-color: #00569B;
        }
        .quantity-controls button:active {
            transform: scale(0.95);
        }
        .quantity-controls button:focus-visible {
            outline: 2px solid var(--windows-accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        .quantity-controls input {
            flex-grow: 1;
            height: 35px;
            margin: 0 var(--spacing-sm);
            font-size: 1.1em;
            text-align: center;
            border-radius: 5px;
            background-color: var(--windows-bg-medium);
            border: 1px solid var(--windows-border-light);
            color: var(--windows-text-dark);
            outline: none;
        }
        .quantity-controls input:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .product.status-insufficient {
            background-color: var(--windows-error-red-light) !important;
            border-color: var(--windows-error-red) !important;
            box-shadow: 0 2px 5px rgba(209, 52, 56, 0.2);
        }

        .product.status-min-zero {
            background-color: var(--windows-warning-orange-light) !important;
            border-color: var(--windows-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 140, 0, 0.2);
        }

        .product.status-min-positive {
            background-color: var(--windows-warning-orange-light) !important;
            border-color: var(--windows-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 140, 0, 0.2);
        }

        .product.status-selected-sufficient {
            background-color: var(--windows-success-green-light) !important;
            border-color: var(--windows-success-green) !important;
            box-shadow: 0 2px 5px rgba(16, 124, 16, 0.2);
        }

        .product.status-stock-positive, .product.status-default {
            background-color: var(--windows-card-bg) !important;
            border-color: var(--windows-border-light) !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .product-item.status-duplicate {
            background-color: var(--windows-bg-medium) !important;
            border-color: var(--windows-accent-blue-light) !important;
        }

        #searchProduct {
            padding: 0.6rem 1rem;
            border-radius: var(--button-border-radius);
            border: 1px solid var(--windows-border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--windows-card-bg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--windows-text-dark);
            outline: none;
        }
        #searchProduct:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        #phoneDropdown, #searchInput,
        #statsPhoneDropdown,
        #statsSearchInput {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--windows-bg-medium);
            border-radius: 5px;
            border: 1px solid var(--windows-border-light);
            margin-bottom: var(--spacing-sm);
            font-size: 1em;
            color: var(--windows-text-dark);
            outline: none;
        }

        #phoneDropdown:focus, #searchInput:focus,
        #statsPhoneDropdown:focus,
        #statsSearchInput:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        #phoneDropdown, #statsPhoneDropdown {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236A7B82%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
        }

        .statistics-container {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: var(--spacing-md);
        }

        .statistics-container h2 {
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-xl);
            font-size: 1.8em;
        }

        .statistics-container h3 {
            color: var(--windows-accent-blue);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.3em;
            border-bottom: 1px solid var(--windows-border-light);
            padding-bottom: var(--spacing-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background-color: var(--windows-bg-medium);
            border: 1px solid var(--windows-accent-blue-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.1em;
            color: var(--windows-accent-blue);
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-card p {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--windows-text-dark);
            margin: 0;
        }

        .stat-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            font-size: 0.9em;
        }

        .stat-card ul li {
            background-color: var(--windows-card-bg);
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            border: 1px solid var(--windows-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .stat-card ul li:last-child {
            margin-bottom: 0;
        }
        .stat-card ul li span:last-child {
            font-weight: bold;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            align-items: center;
        }

        .toast {
            background-color: var(--windows-card-bg);
            color: var(--windows-text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--windows-border-light);
        }

        .toast.success { border-left: 5px solid var(--windows-success-green); }
        .toast.error { border-left: 5px solid var(--windows-error-red); }
        .toast.info { border-left: 5px solid var(--windows-accent-blue); }

        .toast .icon {
            font-size: 1.5em;
            line-height: 1;
        }
        .toast.success .icon { color: var(--windows-success-green); }
        .toast.error .icon { color: var(--windows-error-red); }
        .toast.info .icon { color: var(--windows-accent-blue); }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #confirm-modal-dialog {
            background-color: var(--windows-card-bg);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #confirm-modal-overlay.active #confirm-modal-dialog {
            transform: scale(1);
        }

        #confirm-modal-dialog h3 {
            color: var(--windows-text-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.4em;
        }

        #confirm-modal-dialog p {
            color: var(--windows-text-dark);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #confirm-yes-btn {
            background-color: var(--windows-accent-blue);
            color: var(--windows-text-light);
        }
        #confirm-yes-btn:hover { background-color: #00569B; }

        #confirm-no-btn {
            background-color: var(--windows-border-light);
            color: var(--windows-text-dark);
        }
        #confirm-no-btn:hover { background-color: #B0B0B0; }


        @media (max-width: 1024px) {
            .container {
                max-width: 960px;
            }
            .saved-products3, .saved-products4, .product-list-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            .main-controls .btn-panel {
                font-size: 0.95em;
                padding: 0.7rem 0.9rem;
            }
            .section { /* Adjust to 2 columns on larger tablets */
                flex-basis: calc(50% - 10px);
                max-width: calc(50% - 10px);
            }
            h2 {
                height: 150px; /* Adjust button height for 2 columns */
            }
        }

        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }
            .main-controls .btn-panel {
                flex: 1 1 45%;
                max-width: none;
                font-size: 0.9em;
                padding: 0.6rem 0.8rem;
            }
            .invoice h2 {
                font-size: 1.5em;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.4rem;
                font-size: 0.85em;
            }
            .saved-products3, .saved-products4, .product-list-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: calc(100vh - 200px);
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .stat-card p {
                font-size: 1.3em;
            }
            .statistics-container h2 {
                font-size: 1.5em;
            }
            .toast {
                min-width: unset;
                max-width: 90%;
            }
            .section { /* Still 2 columns on most tablets */
                flex-basis: calc(50% - 10px);
                max-width: calc(50% - 10px);
            }
            h2 {
                height: 140px; /* Slightly smaller height on tablets */
            }
        }

        @media (max-width: 480px) {
            .main-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .main-controls .btn-panel {
                flex: 1 1 100%;
                max-width: none;
                font-size: 1em;
                padding: 0.75rem 1rem;
            }
            .button-container {
                flex-direction: column;
            }
            .btn, .btn1, .btn2, .btn-delete, .btn-edit {
                flex: 1 1 100%;
            }
            .quantity-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            .quantity-controls input {
                width: 60px;
                margin: 0 5px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .saved-products3, .saved-products4, .product-list-grid {
                grid-template-columns: 1fr;
            }
            .section { /* 1 column on small phones */
                flex-basis: 100%;
                max-width: 100%;
            }
            h2 {
                height: 120px;
                font-size: 1em;
            }
            h2 .icon {
                font-size: 2em;
            }
            h2 .text {
                font-size: 0.75em;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

</head>
<body>
    <div class="main-controls">
        <button type="button" class="btn-panel" id="showProductFormButton">إدارة المنتجات</button>
        <button type="button" class="btn-panel" id="showClientInvoiceFormButton">إنشاء فاتورة</button>
        <button type="button" class="btn-panel" id="showSavedProductsListButton">قائمة المنتجات</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton">بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showStatisticsButton">الإحصائيات</button>
    </div>

    <div class="container">
        
        <div class="product-container" id="productFormContainer" hidden>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName" class="required">Nom du produit</label>
                    <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
                    <span class="validation-error-message">اسم المنتج مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                    <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                    <span class="validation-error-message">سعر الشراء مطلوب (غير سالب).</span>
                </div>
                <div class="form-group">
                    <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                    <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                    <span class="validation-error-message">سعر البيع مطلوب (غير سالب).</span>
                </div>
                <div class="form-group">
                    <label for="supplierName" class="required">Nom du fournisseur</label>
                    <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
                    <span class="validation-error-message">اسم المورد مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                    <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
                    <span class="validation-error-message">عنوان المورد مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                    <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                    <span class="validation-error-message">رقم هاتف المورد مطلوب (10 أرقام).</span>
                </div>
                <div class="form-group">
                    <label for="productQuantity">Quantité initiale en stock</label>
                    <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                </div>
                <div class="button-container">
                    <button type="submit" class="btn" id="addProduct">إضافة منتج</button>
                    <button type="submit" class="btn" id="saveEditProduct">تعديل المنتج</button>
                </div>
            </form>
        </div>
        
        <div class="client-container" id="clientFormContainer" hidden>
            <form id="invoiceForm">
                <div class="form-group">
                    <label for="invoiceDate" class="required">Date de la facture</label>
                    <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                    <span class="validation-error-message">تاريخ الفاتورة مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="customerName" class="required">Nom du client</label>
                    <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
                    <span class="validation-error-message">اسم العميل مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                    <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on">
                    <span class="validation-error-message">اسم مالك الفاتورة مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la facture</label>
                    <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on">
                    <span class="validation-error-message">عنوان مالك الفاتورة مطلوب.</span>
                </div>
                <div class="form-group">
                    <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la facture</label>
                    <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                    <span class="validation-error-message">رقم هاتف مالك الفاتورة مطلوب (10 أرقام).</span>
                </div>
                <div class="form-group">
                    <label for="tva">TVA (%)</label>
                    <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                    <span class="validation-error-message">نسبة TVA مطلوبة (بين 0 و 100).</span>
                </div>
                <div class="form-group">
                    <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                    <input type="number" id="invoiceCommissionPercentage" placeholder="مثال: 10" value="0" min="0" max="100" step="0.01">
                    <span class="validation-error-message">نسبة العمولة للفاتورة (بين 0 و 100).</span>
                </div>
                <div class="button-container">
                    <button type="button" class="btn" id="createInvoiceButton">إنشاء الفاتورة وعرضها</button>
                </div>
            </form>
        </div>
        
        <div class="invoice" id="invoiceDisplay" hidden>
            <button type="button" class="btn" id="savePdfButton">تحديث المخزون (بعد الفاتورة)</button>
            <h2>DEVIS</h2>
            <div class="invoice-header">
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
                <p>Date de la facture: <span id="displayInvoiceDate"></span></p>
            </div>
            
            <table class="invoice-table" id="invoiceDetails">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Nom du produit</th>
                        <th>Prix Unitaire</th>
                        <th>Quantité</th>
                        <th>Montant HT</th>
                    </tr>
                </thead>
                <tbody id="displayDetails">
                    </tbody>
            </table>
            
            <div class="invoice-header1">
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </div>
            <button type="button" class="btn" id="printButton">طباعة الفاتورة</button>
        </div>
        
        <div class="saved-products" id="savedProductsDisplay" hidden>
            <!-- NEW: Local Product Statistics Section -->
            <div class="statistics-container local-stats-container">
                <h2>إحصائيات المخزون المحلي</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>إجمالي قيمة المخزون (شراء)</h3>
                        <p id="localTotalPurchaseCost">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي قيمة المخزون (بيع)</h3>
                        <p id="localTotalSellingPrice">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي الربح المحتمل من المخزون</h3>
                        <p id="localTotalPotentialProfit">0.00 DH</p>
                    </div>
                    <div class="stat-card">
                        <h3>عدد المنتجات الفريدة في المخزون</h3>
                        <p id="localUniqueProductsInStock">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي عدد الوحدات في المخزون</h3>
                        <p id="localTotalItemsInStock">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>منتجات أقل من الحد الأدنى للمخزون</h3>
                        <p id="localProductsBelowMinStock">0</p>
                    </div>
                </div>
                <p><small>هذه الإحصائيات تعكس المخزون الحالي في جهازك.</small></p>
            </div>
            <!-- END NEW: Local Product Statistics Section -->

            <div class="low-stock-section">
                <h3>تتبع المخزون: المنتجات على وشك النفاد</h3>
                <div class="product-list-grid" id="lowStockProductsList">
                    <p class="empty-list-message">لا توجد منتجات في المخزون المنخفض حالياً.</p>
                </div>
            </div>

            <div class="divider"></div>

            <div class="form-group">
                <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                <input type="text" id="searchProduct" placeholder="البحث عن منتج">
            </div>
            <div class="saved-products3 product-list-grid" id="savedProductsList"></div>
        </div>
        
        <div class="saved-products2" id="firebaseProductsDisplay" hidden>
            <div class="form-group">
                <label for="phoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                <select id="phoneDropdown" onchange="filterByPhoneNumber()">
                    </select>
                <label for="searchInput" class="sr-only">البحث عن منتج في Firebase</label>
                <input type="text" id="searchInput" placeholder="البحث عن منتج" onkeyup="filterProducts()">
            </div>
            <div class="saved-products4 product-list-grid" id="productListContainerdata"></div>
        </div>

        <div class="statistics-container" id="statisticsDisplay" hidden>
            <h2>إحصائيات المبيعات</h2>
            <div class="form-group">
                <label for="statsPhoneDropdown" class="sr-only">تصفية الإحصائيات حسب رقم الهاتف</label>
                <select id="statsPhoneDropdown" onchange="filterStatistics()">
                </select>
                <label for="statsSearchInput" class="sr-only">البحث في الإحصائيات</label>
                <input type="text" id="statsSearchInput" placeholder="البحث في الإحصائيات" onkeyup="filterStatistics()">
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>إجمالي سعر الشراء</h3>
                    <p id="totalPurchaseCost">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي سعر البيع</h3>
                    <p id="totalSellingPrice">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي العمولة</h3>
                    <p id="totalCommission">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الأرباح</h3>
                    <p id="totalProfit">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي المبيعات (HT)</h3>
                    <p id="totalSalesHT">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي TVA</h3>
                    <p id="totalTVA">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>إجمالي المبيعات (TTC)</h3>
                    <p id="totalSalesTTC">0.00 DH</p>
                </div>
                <div class="stat-card">
                    <h3>عدد الفواتير</h3>
                    <p id="invoiceCount">0</p>
                </div>
                <div class="stat-card">
                    <h3>المنتجات الأكثر مبيعاً</h3>
                    <ul id="topSellingProducts">
                        <li>لا توجد بيانات</li>
                    </ul>
                </div>
                <div class="stat-card">
                    <h3>العملاء الأكثر نشاطاً</h3>
                    <ul id="topCustomers">
                        <li>لا توجد بيانات</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <div id="toast-container"></div>

    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

</body>
    
<script>
// Firebase configuration (using provided placeholders)
const firebaseConfig = {
    // You should ensure __firebase_config is properly defined in your environment
    // For local testing without Canvas environment, you might need to manually
    // set your Firebase config here.
    // Example: apiKey: "YOUR_API_KEY", authDomain: "YOUR_PROJECT_ID.firebaseapp.com", ...
    databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
};

// Check if __firebase_config is defined (from Canvas environment)
if (typeof __firebase_config !== 'undefined') {
    Object.assign(firebaseConfig, JSON.parse(__firebase_config));
}

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ====== Global UI Elements ======
const productFormContainer = document.getElementById('productFormContainer');
const clientFormContainer = document.getElementById('clientFormContainer');
const invoiceDisplay = document.getElementById('invoiceDisplay');
const savedProductsDisplay = document.getElementById('savedProductsDisplay');
const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay');
const statisticsDisplay = document.getElementById('statisticsDisplay');

// ====== Main Navigation Buttons ======
const showProductFormButton = document.getElementById('showProductFormButton');
const showClientInvoiceFormButton = document.getElementById('showClientInvoiceFormButton');
const showSavedProductsListButton = document.getElementById('showSavedProductsListButton');
const showFirebaseDataButton = document.getElementById('showFirebaseDataButton');
const showStatisticsButton = document.getElementById('showStatisticsButton');

const navButtons = [
    showProductFormButton,
    showClientInvoiceFormButton,
    showSavedProductsListButton,
    showFirebaseDataButton,
    showStatisticsButton
];

// ====== Form Elements ======
const productForm = document.getElementById('productForm');
const productNameInput = document.getElementById('productName');
const purchasePriceInput = document.getElementById('purchasePrice');
const sellingPriceInput = document.getElementById('sellingPrice');
const supplierNameInput = document.getElementById('supplierName');
const supplierAddressInput = document.getElementById('supplierAddress');
const supplierPhoneInput = document.getElementById('supplierPhone');
const productQuantityInput = document.getElementById('productQuantity');


const invoiceForm = document.getElementById('invoiceForm');
const customerNameInput = document.getElementById('customerName');
const invoiceOwnerInput = document.getElementById('invoiceOwner');
const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
const invoiceDateInput = document.getElementById('invoiceDate');
const tvaInput = document.getElementById('tva');
const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage');

const addProductButton = document.getElementById('addProduct');
const saveEditProductButton = document.getElementById('saveEditProduct');
const savedProductsList = document.getElementById('savedProductsList');
const searchProductInput = document.getElementById('searchProduct');
const firebaseProductListContainer = document.getElementById('productListContainerdata');
const firebaseSearchInput = document.getElementById('searchInput');
const phoneDropdown = document.getElementById('phoneDropdown');

const statsPhoneDropdown = document.getElementById('statsPhoneDropdown');
const statsSearchInput = document.getElementById('statsSearchInput');
const lowStockProductsList = document.getElementById('lowStockProductsList');

// ====== NEW: Local Statistics Elements ======
const localTotalPurchaseCost = document.getElementById('localTotalPurchaseCost');
const localTotalSellingPrice = document.getElementById('localTotalSellingPrice');
const localTotalPotentialProfit = document.getElementById('localTotalPotentialProfit');
const localUniqueProductsInStock = document.getElementById('localUniqueProductsInStock');
const localTotalItemsInStock = document.getElementById('localTotalItemsInStock');
const localProductsBelowMinStock = document.getElementById('localProductsBelowMinStock');


// ====== Toast Notification Elements ======
const toastContainer = document.getElementById('toast-container');

// ====== Custom Confirmation Modal Elements ======
const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
const confirmModalTitle = document.getElementById('confirm-modal-title');
const confirmModalMessage = document.getElementById('confirm-modal-message');
const confirmYesBtn = document.getElementById('confirm-yes-btn');
const confirmNoBtn = document.getElementById('confirm-no-btn');
let confirmResolve;

let allFirebaseInvoicesData = [];
let allFirebaseProducts = [];


// ====== Initial Setup on Window Load ======
window.onload = function() {
    hideAllSections();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    saveEditProductButton.style.display = 'none';
    
    const now = new Date();
    const formattedDate = now.toLocaleDateString('fr-FR');
    const formattedTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    invoiceDateInput.value = `${formattedDate} ${formattedTime}`;

    const savedInvoiceOwner = localStorage.getItem('invoiceOwner');
    const savedInvoiceOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
    const savedInvoiceOwnerAddress = localStorage.getItem('invoiceOwnerAddress');
    const savedSupplierName = localStorage.getItem('supplierName');
    const savedSupplierAddress = localStorage.getItem('supplierAddress');
    const savedSupplierPhone = localStorage.getItem('supplierPhone');
    const savedInvoiceCommission = localStorage.getItem('invoiceCommissionPercentage');

    if (savedInvoiceOwner) invoiceOwnerInput.value = savedInvoiceOwner;
    if (savedInvoiceOwnerPhone) invoiceOwnerPhoneInput.value = savedInvoiceOwnerPhone;
    if (savedInvoiceOwnerAddress) invoiceOwnerAddressInput.value = savedInvoiceOwnerAddress;
    if (savedSupplierName) supplierNameInput.value = savedSupplierName;
    if (savedSupplierAddress) supplierAddressInput.value = savedSupplierAddress;
    if (savedSupplierPhone) supplierPhoneInput.value = savedSupplierPhone;
    if (savedInvoiceCommission) invoiceCommissionPercentageInput.value = savedInvoiceCommission;
};

// ====== UI Management Functions ======

function hideAllSections() {
    const allSections = document.querySelectorAll('.container > div');
    allSections.forEach(section => {
        section.hidden = true;
    });
}

function setActiveButton(activeBtn) {
    navButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
}

function resetValidationMessages(form) {
    const fields = form.querySelectorAll('input[required], textarea[required]');
    fields.forEach(field => {
        field.style.borderColor = '';
        const errorMessageSpan = field.nextElementSibling;
        if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
            errorMessageSpan.style.display = 'none';
        }
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.classList.add('toast', type);
    let iconHtml = '';
    if (type === 'success') {
        iconHtml = '<span class="icon">&#10004;</span>';
    } else if (type === 'error') {
        iconHtml = '<span class="icon">&#10006;</span>';
    } else if (type === 'info') {
        iconHtml = '<span class="icon">&#8505;</span>';
    }
    toast.innerHTML = `${iconHtml}<span>${message}</span>`;
    toastContainer.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 4000);
}

function showConfirmModal(title, message) {
    return new Promise(resolve => {
        confirmResolve = resolve;

        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmModalOverlay.hidden = false;
        confirmModalOverlay.classList.add('active');

        const handleYes = () => {
            confirmModalOverlay.classList.remove('active');
            confirmModalOverlay.hidden = true;
            confirmYesBtn.removeEventListener('click', handleYes);
            confirmNoBtn.removeEventListener('click', handleNo);
            resolve(true);
        };

        const handleNo = () => {
            confirmModalOverlay.classList.remove('active');
            confirmModalOverlay.hidden = true;
            confirmYesBtn.removeEventListener('click', handleYes);
            confirmNoBtn.removeEventListener('click', handleNo);
            resolve(false);
        };

        confirmYesBtn.addEventListener('click', handleYes);
        confirmNoBtn.addEventListener('click', handleNo);
    });
}


// ====== Section Display Functions ======

showProductFormButton.addEventListener('click', () => {
    hideAllSections();
    productFormContainer.hidden = false;
    setActiveButton(showProductFormButton);
    addProductButton.style.display = 'block';
    saveEditProductButton.style.display = 'none';
    productNameInput.value = '';
    purchasePriceInput.value = '';
    sellingPriceInput.value = '';
    supplierNameInput.value = localStorage.getItem('supplierName') || '';
    supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
    supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
    productQuantityInput.value = '0';
    resetValidationMessages(productForm);
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

showClientInvoiceFormButton.addEventListener('click', () => {
    hideAllSections();
    clientFormContainer.hidden = false;
    setActiveButton(showClientInvoiceFormButton);
    resetValidationMessages(invoiceForm);
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

showSavedProductsListButton.addEventListener('click', () => {
    hideAllSections();
    savedProductsDisplay.hidden = false;
    setActiveButton(showSavedProductsListButton);
    displayLowStockProducts();
    displaySavedProducts();
    calculateAndDisplayLocalStatistics(); // NEW: Call the local statistics function
    searchProductInput.value = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

showFirebaseDataButton.addEventListener('click', () => {
    hideAllSections();
    firebaseProductsDisplay.hidden = false;
    setActiveButton(showFirebaseDataButton);
    populateDropdown();
    fetchAndDisplayFirebaseData('all');
    firebaseSearchInput.value = '';
    phoneDropdown.selectedIndex = 0;
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

showStatisticsButton.addEventListener('click', () => {
    hideAllSections();
    statisticsDisplay.hidden = false;
    setActiveButton(showStatisticsButton);
    populateStatisticsFilterDropdown();
    fetchAndDisplayStatistics();
    statsSearchInput.value = '';
    statsPhoneDropdown.selectedIndex = 0;
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// ====== Form Validation Helper ======

function checkFields(form) {
    let allFieldsFilled = true;
    const fields = form.querySelectorAll('input[required], textarea[required]');
    fields.forEach(field => {
        const errorMessageSpan = field.nextElementSibling;
        const fieldValue = field.value.trim();

        if (!fieldValue) {
            allFieldsFilled = false;
            field.style.borderColor = 'var(--windows-error-red)';
            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                errorMessageSpan.style.display = 'block';
                errorMessageSpan.textContent = field.placeholder + ' مطلوب.';
            }
        }
        else if (field.type === 'number') {
            const numValue = parseFloat(fieldValue);
            if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                if (isNaN(numValue) || numValue < 0) {
                    allFieldsFilled = false;
                    field.style.borderColor = 'var(--windows-error-red)';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = 'القيمة يجب أن تكون رقماً موجباً.';
                        errorMessageSpan.style.display = 'block';
                    }
                }
            }
            else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                    allFieldsFilled = false;
                    field.style.borderColor = 'var(--windows-error-red)';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = 'النسبة يجب أن تكون بين 0 و 100.';
                        errorMessageSpan.style.display = 'block';
                    }
                }
            }
        } else if (field.type === 'tel' && field.pattern) {
            const regex = new RegExp(field.pattern);
            if (!regex.test(fieldValue)) {
                allFieldsFilled = false;
                field.style.borderColor = 'var(--windows-error-red)';
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.textContent = 'صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                    errorMessageSpan.style.display = 'block';
                }
            }
        }
        else {
            field.style.borderColor = '';
            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                errorMessageSpan.style.display = 'none';
            }
        }
    });
    return allFieldsFilled;
}


// ====== Product Management (Local Storage) ======

addProductButton.addEventListener('click', async (event) => {
    event.preventDefault();
    if (checkFields(productForm)) {
        const name = productNameInput.value.trim();
        const purchasePrice = parseFloat(purchasePriceInput.value);
        const sellingPrice = parseFloat(sellingPriceInput.value);
        const supplierName = supplierNameInput.value.trim();
        const supplierAddress = supplierAddressInput.value.trim();
        const supplierPhone = supplierPhoneInput.value.trim();
        const stockQuantity = parseInt(productQuantityInput.value);
        const id = Date.now();
        const date = new Date().toLocaleDateString('fr-FR');

        localStorage.setItem('supplierName', supplierName);
        localStorage.setItem('supplierAddress', supplierAddress);
        localStorage.setItem('supplierPhone', supplierPhone);

        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        const productExists = products.some(product =>
            product.name.toLowerCase() === name.toLowerCase() &&
            product.supplierPhone === supplierPhone
        );

        if (productExists) {
            showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
            return;
        }

        const confirmed = await showConfirmModal("تأكيد الإضافة", "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟");
        if (confirmed) {
            products.push({ id, name, purchasePrice, sellingPrice, commissionPercentage: 0, supplierName, supplierAddress, supplierPhone, stockQuantity, date, quantity: 0, minStockQuantity: 0 });
            products.sort((a, b) => a.name.localeCompare(b.name));
            localStorage.setItem('savedProducts', JSON.stringify(products));
            displaySavedProducts();
            displayLowStockProducts();
            calculateAndDisplayLocalStatistics(); // Update local statistics after adding product
            showToast("المنتج تم إضافته بنجاح.", 'success');
            showProductFormButton.click();
        } else {
            showToast("تم إلغاء إضافة المنتج.", 'info');
        }
    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

function editProduct(productId) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productToEdit = savedProducts.find(p => p.id == productId);

    if (productToEdit) {
        showProductFormButton.click();
        
        productNameInput.value = productToEdit.name;
        purchasePriceInput.value = productToEdit.purchasePrice;
        sellingPriceInput.value = productToEdit.sellingPrice;
        supplierNameInput.value = productToEdit.supplierName;
        supplierAddressInput.value = productToEdit.supplierAddress;
        supplierPhoneInput.value = productToEdit.supplierPhone;
        productQuantityInput.value = productToEdit.stockQuantity;
        
        addProductButton.style.display = 'none';
        saveEditProductButton.style.display = 'block';
        saveEditProductButton.dataset.editingId = productId;
        resetValidationMessages(productForm);
    } else {
        showToast("المنتج المراد تعديله غير موجود.", 'error');
    }
}

saveEditProductButton.addEventListener('click', async (event) => {
    event.preventDefault();
    if (checkFields(productForm)) {
        const idToEdit = event.target.dataset.editingId;
        if (!idToEdit) {
            showToast("لا يوجد منتج محدد للتعديل.", 'error');
            return;
        }

        const name = productNameInput.value.trim();
        const purchasePrice = parseFloat(purchasePriceInput.value);
        const sellingPrice = parseFloat(sellingPriceInput.value);
        const supplierName = supplierNameInput.value.trim();
        const supplierAddress = supplierAddressInput.value.trim();
        const supplierPhone = supplierPhoneInput.value.trim();
        const stockQuantity = parseInt(productQuantityInput.value);
        const date = new Date().toLocaleDateString('fr-FR');

        localStorage.setItem('supplierName', supplierName);
        localStorage.setItem('supplierAddress', supplierAddress);
        localStorage.setItem('supplierPhone', supplierPhone);

        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        const productIndex = products.findIndex(p => p.id == idToEdit);

        if (productIndex !== -1) {
            const duplicateCheck = products.some((p, idx) =>
                idx !== productIndex &&
                p.name.toLowerCase() === name.toLowerCase() &&
                p.supplierPhone === supplierPhone
            );

            if (duplicateCheck) {
                showToast("لا يمكن تعديل المنتج. يوجد منتج آخر بنفس الاسم ورقم هاتف المورد.", 'error');
                return;
            }

            const confirmed = await showConfirmModal("تأكيد التعديل", "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟");
            if (confirmed) {
                products[productIndex].name = name;
                products[productIndex].purchasePrice = purchasePrice;
                products[productIndex].sellingPrice = sellingPrice;
                products[productIndex].supplierName = supplierName;
                products[productIndex].supplierAddress = supplierAddress;
                products[productIndex].supplierPhone = supplierPhone;
                products[productIndex].stockQuantity = stockQuantity;
                products[productIndex].date = date;
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts();
                displayLowStockProducts();
                calculateAndDisplayLocalStatistics(); // Update local statistics after editing product
                showToast("Le product a été mis à jour avec succès.", 'success');
                showProductFormButton.click();
            } else {
                showToast("تم إلغاء تعديل المنتج.", 'info');
            }
        } else {
            showToast("المنتج المراد تعديله غير موجود.", 'error');
        }
    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

async function deleteProduct(id) {
    const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
    if (confirmed) {
        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        products = products.filter(product => product.id !== id);
        localStorage.setItem('savedProducts', JSON.stringify(products));
        displaySavedProducts();
        displayLowStockProducts();
        calculateAndDisplayLocalStatistics(); // Update local statistics after deleting product
        showToast("تم حذف المنتج بنجاح.", 'success');
    } else {
        showToast("تم إلغاء حذف المنتج.", 'info');
    }
}

searchProductInput.addEventListener('input', displaySavedProducts);

function resetAllProductQuantities() {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    savedProducts.forEach(product => {
        product.quantity = 0;
    });
    localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

function displaySavedProducts() {
    const searchTerm = searchProductInput.value.toLowerCase();
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    savedProductsList.innerHTML = '';

    const filteredProducts = savedProducts
        .filter(product => product.name.toLowerCase().includes(searchTerm))
        .sort((a, b) => {
            const stockQuantityA = a.stockQuantity || 0;
            const stockQuantityB = b.stockQuantity || 0;
            const minStockQuantityA = a.minStockQuantity || 0;
            const minStockQuantityB = b.minStockQuantity || 0;
            const quantityA = a.quantity || 0;
            const quantityB = b.quantity || 0;

            const statusA = getProductStatusPriority(quantityA, stockQuantityA, minStockQuantityA);
            const statusB = getProductStatusPriority(quantityB, stockQuantityB, minStockQuantityB);

            if (statusA !== statusB) {
                return statusA - statusB;
            }

            return stockQuantityB - stockQuantityA || a.name.localeCompare(b.name);
        });

    let index = filteredProducts.length;

    if (filteredProducts.length === 0) {
        savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
        return;
    }

    filteredProducts.forEach((product) => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';

        const quantityToDisplay = product.quantity || 0;
        const stockQuantityToDisplay = product.stockQuantity || 0;
        const minStockQuantityToDisplay = product.minStockQuantity || 0;

        updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay);

        productDiv.innerHTML = `
            <div class="product-details">
                <p><strong>الاسم:</strong> ${product.name}</p>
                <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                <p><strong>المورد:</strong> ${product.supplierName}</p>
                <p><strong>هاتف المورد:</strong> ${product.supplierPhone}</p>
            </div>

            <div class="product-actions">
                <button type="button" class="btn-delete" onclick="deleteProduct(${product.id})">حذف</button>
                <button type="button" class="btn-edit" data-product-id="${product.id}">تعديل</button>
            </div>

            <p><strong>الكمية في المخزون:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustStock(${product.id}, -1)">-</button>
                <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" onchange="updateStockFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustStock(${product.id}, 1)">+</button>
            </div>

            <p><strong>الحد الأدنى للمخزون:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustMinQuantity(${product.id}, -1)">-</button>
                <input type="number" class="min-product-quantity" data-id="${product.id}" value="${minStockQuantityToDisplay}" min="0" onchange="updateMinStockFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustMinQuantity(${product.id}, 1)">+</button>
            </div>

            <p><strong>الكمية المحددة للفاتورة:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustQuantity(${product.id}, -1)">-</button>
                <input type="number" class="product-quantity" data-id="${product.id}" value="${quantityToDisplay}" min="0" onchange="updateQuantityFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustQuantity(${product.id}, 1)">+</button>
            </div>
        `;

        productDiv.querySelector('.btn-edit').addEventListener('click', (event) => {
            event.stopPropagation();
            const productId = event.target.dataset.productId;
            editProduct(productId);
        });

        savedProductsList.appendChild(productDiv);
        index--;
    });
}

function displayLowStockProducts() {
    lowStockProductsList.innerHTML = '';
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

    const lowStockItems = savedProducts.filter(p => (p.stockQuantity || 0) < (p.minStockQuantity || 0) && p.stockQuantity > 0);
    const outOfStockItems = savedProducts.filter(p => (p.stockQuantity || 0) === 0);

    if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
        lowStockProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات في المخزون المنخفض أو نفدت حالياً.</p>';
    } else {
        const combinedLowStock = [...lowStockItems, ...outOfStockItems];
        combinedLowStock.sort((a, b) => a.name.localeCompare(b.name));

        combinedLowStock.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product');
            if ((product.stockQuantity || 0) < (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0) {
                 productDiv.classList.add('low');
            } else if ((product.stockQuantity || 0) === 0) {
                 productDiv.classList.add('status-insufficient');
            }

            productDiv.innerHTML = `
                <div class="product-details">
                    <p><strong>المنتج:</strong> ${product.name}</p>
                    <p><strong>المخزون الحالي:</strong> ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) === 0 ? '(نفد)' : '' }</p>
                    <p><strong>الحد الأدنى للمخزون:</strong> ${product.minStockQuantity || 0}</p>
                </div>
                <div class="product-actions">
                    <button type="button" class="btn1" onclick="showProductFormButton.click(); editProduct(${product.id});">تعديل</button>
                </div>
            `;
            lowStockProductsList.appendChild(productDiv);
        });
    }
}


function getProductStatusPriority(quantity, stock, minStock) {
    if (quantity > 0 && stock < quantity) return 1;
    if (stock < minStock && quantity === 0) return 2;
    if (stock < minStock) return 3;
    if (quantity > 0) return 4;
    if (stock > 0) return 5;
    return 6;
}

function updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay) {
    productDiv.classList.remove('status-insufficient', 'status-min-zero', 'status-min-positive', 'status-selected-sufficient', 'status-stock-positive', 'status-default');

    if (quantityToDisplay > 0 && stockQuantityToDisplay < quantityToDisplay) {
        productDiv.classList.add('status-insufficient');
    } else if (stockQuantityToDisplay < minStockQuantityToDisplay && quantityToDisplay === 0) {
        productDiv.classList.add('status-min-zero');
    } else if (stockQuantityToDisplay < minStockQuantityToDisplay) {
        productDiv.classList.add('status-min-positive');
    } else if (quantityToDisplay > 0) {
        productDiv.classList.add('status-selected-sufficient');
    } else if (stockQuantityToDisplay > 0) {
        productDiv.classList.add('status-stock-positive');
    } else {
        productDiv.classList.add('status-default');
    }
}

function adjustStock(id, amount) {
    const stockInput = document.getElementById(`stock-${id}`);
    let stockQuantity = parseInt(stockInput.value) || 0;
    stockQuantity += amount;
    if (stockQuantity < 0) stockQuantity = 0;
    stockInput.value = stockQuantity;

    updateStockInLocalStorage(id, stockQuantity);
}

function updateStockFromInput(id, value) {
    let stockQuantity = parseInt(value) || 0;
    if (stockQuantity < 0) stockQuantity = 0;
    updateStockInLocalStorage(id, stockQuantity);
}

function updateStockInLocalStorage(id, newStockQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].stockQuantity = newStockQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.getElementById(`stock-${id}`).closest('.product');
        const quantityToDisplay = savedProducts[productIndex].quantity || 0;
        const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
        updateProductDivClass(productDiv, quantityToDisplay, newStockQuantity, minStockQuantityToDisplay);
        displayLowStockProducts();
        calculateAndDisplayLocalStatistics(); // Update local statistics after stock change
    }
}

function adjustQuantity(id, amount) {
    const quantityInput = document.querySelector(`.product-quantity[data-id="${id}"]`);
    let quantity = parseInt(quantityInput.value) || 0;
    quantity += amount;
    if (quantity < 0) quantity = 0;
    quantityInput.value = quantity;

    updateInvoiceQuantityInLocalStorage(id, quantity);
}

function updateQuantityFromInput(id, value) {
    let quantity = parseInt(value) || 0;
    if (quantity < 0) quantity = 0;
    updateInvoiceQuantityInLocalStorage(id, quantity);
}

function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].quantity = newQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.querySelector(`.product-quantity[data-id="${id}"]`).closest('.product');
        const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
        const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
        updateProductDivClass(productDiv, newQuantity, stockQuantityToDisplay, minStockQuantityToDisplay);
    }
}

function adjustMinQuantity(id, amount) {
    const minQuantityInput = document.querySelector(`.min-product-quantity[data-id='${id}']`);
    let minQuantity = parseInt(minQuantityInput.value) || 0;
    minQuantity += amount;
    if (minQuantity < 0) minQuantity = 0;
    minQuantityInput.value = minQuantity;

    updateMinStockInLocalStorage(id, minQuantity);
}

function updateMinStockFromInput(id, value) {
    let minQuantity = parseInt(value) || 0;
    if (minQuantity < 0) minQuantity = 0;
    updateMinStockInLocalStorage(id, minQuantity);
}

function updateMinStockInLocalStorage(id, newMinQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].minStockQuantity = newMinQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.querySelector(`.min-product-quantity[data-id='${id}']`).closest('.product');
        const quantityToDisplay = savedProducts[productIndex].quantity || 0;
        const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
        updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, newMinQuantity);
        displayLowStockProducts();
        calculateAndDisplayLocalStatistics(); // Update local statistics after min stock change
    }
}


// ====== Invoice Generation and Display ======

document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
    e.preventDefault();

    if (checkFields(invoiceForm)) {
        let totalHTBeforeCommission = 0;
        let totalProfit = 0;
        let totalCommission = 0;
        let productNumber = 1;
        const detailsTbody = document.getElementById('displayDetails');
        detailsTbody.innerHTML = '';
        
        let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
        let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);

        if (selectedProductsForInvoice.length === 0) {
            const confirmed = await showConfirmModal("تحديد المنتجات", "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة كل المنتجات الموجودة بكمية 1؟");
            if (confirmed) {
                allSavedProducts.forEach(product => {
                    product.quantity = 1;
                });
                localStorage.setItem('savedProducts', JSON.stringify(allSavedProducts));
                selectedProductsForInvoice = allSavedProducts.filter(p => p.quantity === 1);
            } else {
                showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                return;
            }
        }

        if (selectedProductsForInvoice.length === 0) {
            showToast("لا توجد منتجات لتضمينها في الفاتورة.", 'info');
            return;
        }

        const invoiceCommissionRate = parseFloat(invoiceCommissionPercentageInput.value) || 0;
        localStorage.setItem('invoiceCommissionPercentage', invoiceCommissionRate);

        selectedProductsForInvoice.forEach((productData) => {
            const quantity = productData.quantity;
            const sellingPrice = parseFloat(productData.sellingPrice);
            const purchasePrice = parseFloat(productData.purchasePrice);

            const itemHT = sellingPrice * quantity;
            totalHTBeforeCommission += itemHT;

            const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0;
            const commissionPerUnit = profitPerUnitBeforeCommission * (invoiceCommissionRate / 100);

            const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;
            
            totalProfit += actualProfitPerUnit * quantity;
            totalCommission += commissionPerUnit * quantity;


            const productDetails = document.createElement('tr');
            productDetails.innerHTML = `
                <td>${productNumber++}</td>
                <td>${productData.name}</td>
                <td>${sellingPrice.toFixed(2)} DH</td>
                <td>${quantity}</td>
                <td>${itemHT.toFixed(2)} DH</td>
            `;
            detailsTbody.appendChild(productDetails);
        });

        const finalTotalHT = totalHTBeforeCommission - totalCommission;

        const tvaRate = parseFloat(tvaInput.value) / 100;
        const tva = (finalTotalHT * tvaRate).toFixed(2);
        const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);

        document.getElementById('displayCustomerName').textContent = customerNameInput.value;
        document.getElementById('displayInvoiceOwner').textContent = invoiceOwnerInput.value;
        document.getElementById('displayInvoiceDate').textContent = invoiceDateInput.value;
        document.getElementById('displayTotalAmountBeforeCommission').textContent = totalHTBeforeCommission.toFixed(2) + ' DH';
        document.getElementById('displayCommissionDeducted').textContent = totalCommission.toFixed(2) + ' DH';
        document.getElementById('displayTotalAmount').textContent = finalTotalHT.toFixed(2) + ' DH';
        document.getElementById('displayTVA').textContent = tva + ' DH';
        document.getElementById('displayTotalTTC').textContent = totalTTC + ' DH';

        document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceOwnerPhoneInput.value;
        document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceOwnerAddressInput.value;
        
        hideAllSections();
        invoiceDisplay.hidden = false;
        window.scrollTo({ top: 0, behavior: 'smooth' });

        localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
        localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
        localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);

        const viewportMeta = document.querySelector('meta[name="viewport"]');
        if (viewportMeta) {
            originalViewportContent = viewportMeta.getAttribute('content');
            viewportMeta.setAttribute('content', 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        } else {
            const newViewportMeta = document.createElement('meta');
            newViewportMeta.name = 'viewport';
            newViewportMeta.content = 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            document.head.appendChild(newViewportMeta);
        }
        
        const productsToSaveToFirebase = [];
        selectedProductsForInvoice.forEach((productData) => {
            const profitPerUnitBeforeCommissionFirebase = (parseFloat(productData.sellingPrice) - parseFloat(productData.purchasePrice)) || 0;
            const commissionPerUnitFirebase = profitPerUnitBeforeCommissionFirebase * (invoiceCommissionRate / 100);
            const actualProfitPerUnitFirebase = profitPerUnitBeforeCommissionFirebase - commissionPerUnitFirebase;

            productsToSaveToFirebase.push({
                ...productData,
                quantityUsed: productData.quantity,
                profitPerUnit: actualProfitPerUnitFirebase.toFixed(2),
                commissionPerUnit: commissionPerUnitFirebase.toFixed(2)
            });
        });

        if (productsToSaveToFirebase.length > 0) {
            const invoiceDataToSave = {
                date: invoiceDateInput.value,
                customerName: customerNameInput.value,
                ownerName: invoiceOwnerInput.value,
                ownerAddress: invoiceOwnerAddressInput.value,
                ownerPhone: invoiceOwnerPhoneInput.value,
                products: productsToSaveToFirebase,
                totalHT: finalTotalHT.toFixed(2),
                totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                tva: tva,
                totalTTC: totalTTC,
                totalProfit: totalProfit.toFixed(2),
                totalCommission: totalCommission.toFixed(2)
            };
            if (invoiceCommissionRate > 0) {
                invoiceDataToSave.invoiceCommissionRate = invoiceCommissionRate;
            }

            const alldataRef = database.ref(`alldata/${invoiceOwnerPhoneInput.value}`);
            alldataRef.push(invoiceDataToSave)
            .then(() => showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success'))
            .catch(error => showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error'));
        }

    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

let originalViewportContent = '';

document.getElementById('savePdfButton').addEventListener('click', async function() {
    const productsInInvoice = document.querySelectorAll('#invoiceDetails tbody tr');
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

    let hasInsufficientStock = false;
    let productsToUpdate = [];

    productsInInvoice.forEach((row) => {
        const productName = row.cells[1].textContent;
        const quantityUsed = parseInt(row.cells[3].textContent);

        const productData = savedProducts.find(p => p.name === productName);
        
        if (productData) {
            const currentStock = parseInt(productData.stockQuantity || 0);
            if (currentStock < quantityUsed) {
                hasInsufficientStock = true;
                showToast(`تنبيه: كمية غير كافية للمنتج "${productName}". المخزون المتاح: ${currentStock}`, 'error');
                return;
            }
            productsToUpdate.push({ productName, quantityUsed });
        }
    });

    if (hasInsufficientStock) {
        return;
    }

    const confirmed = await showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة؟");
    if (confirmed) {
        productsToUpdate.forEach(({ productName, quantityUsed }) => {
            const productDataIndex = savedProducts.findIndex(p => p.name === productName);
            if (productDataIndex !== -1) {
                savedProducts[productDataIndex].stockQuantity -= quantityUsed;
            }
        });

        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));

        showToast('تم تحديث المخزون بنجاح.', 'success');
        resetAllProductQuantities();
        showSavedProductsListButton.click();
    } else {
        showToast("تم إلغاء تحديث المخزون.", 'info');
    }
});

document.getElementById('printButton').addEventListener('click', function() {
    const viewportMeta = document.querySelector('meta[name="viewport"]');
    if (viewportMeta) {
        originalViewportContent = viewportMeta.getAttribute('content');
        viewportMeta.setAttribute('content', 'width=1024');
    }

    this.style.display = 'none';
    document.getElementById('savePdfButton').style.display = 'none';

    window.print();

    setTimeout(() => {
        document.getElementById('savePdfButton').style.display = 'block';
        this.style.display = 'block';
        if (viewportMeta && originalViewportContent) {
            viewportMeta.setAttribute('content', originalViewportContent);
        }
    }, 500);
});


// ====== Firebase Data Display and Filtering ======

function populateDropdown() {
    const alldataRef = database.ref('alldata');
    alldataRef.once('value', (snapshot) => {
        const data = snapshot.val();
        phoneDropdown.innerHTML = '';

        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'عرض الكل';
        phoneDropdown.appendChild(allOption);

        const phoneNumbers = new Set();
        if (data) {
            for (const phoneKey in data) {
                if (data.hasOwnProperty(phoneKey)) {
                    phoneNumbers.add(phoneKey);
                }
            }
        }

        const sortedPhoneNumbers = Array.from(phoneNumbers).sort();

        sortedPhoneNumbers.forEach(phoneNumber => {
            const option = document.createElement('option');
            option.value = phoneNumber;
            option.textContent = phoneNumber;
            phoneDropdown.appendChild(option);
        });
    }, (error) => {
        showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
    });
}

function fetchAndDisplayFirebaseData(selectedPhoneNumber = 'all') {
    const alldataRef = database.ref('alldata');
    alldataRef.once('value', (snapshot) => {
        const data = snapshot.val();
        firebaseProductListContainer.innerHTML = '';

        allFirebaseProducts = [];

        if (data) {
            for (const phoneKey in data) {
                if (data.hasOwnProperty(phoneKey)) {
                    if (selectedPhoneNumber === 'all' || phoneKey === selectedPhoneNumber) {
                        const phoneData = data[phoneKey];
                        for (const invoiceKey in phoneData) {
                            if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                const invoiceDetails = phoneData[invoiceKey];
                                invoiceDetails.products.forEach(product => {
                                    allFirebaseProducts.push({
                                        ...product,
                                        invoiceDate: invoiceDetails.date,
                                        customerName: invoiceDetails.customerName,
                                        ownerName: invoiceDetails.ownerName,
                                        ownerAddress: invoiceDetails.ownerAddress,
                                        ownerPhone: invoiceDetails.ownerPhone,
                                        totalHT: invoiceDetails.totalHT,
                                        totalTTC: invoiceDetails.totalTTC,
                                        totalProfit: invoiceDetails.totalProfit,
                                        totalCommission: invoiceDetails.totalCommission,
                                        firebaseInvoiceKey: invoiceKey
                                    });
                                });
                            }
                        }
                    }
                }
            }
        }

        const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
        allFirebaseProducts.forEach(product => {
            const isDuplicate = savedProducts.some(savedProduct =>
                product.name.toLowerCase() === savedProduct.name.toLowerCase() &&
                product.supplierPhone === savedProduct.supplierPhone
            );
            product.isDuplicate = isDuplicate;
        });

        allFirebaseProducts.sort((a, b) => {
            if (a.isDuplicate && !b.isDuplicate) return 1;
            if (!a.isDuplicate && b.isDuplicate) return -1;
            return b.id - a.id;
        });

        displayFirebaseProducts(allFirebaseProducts);
    }, (error) => {
        showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
    });
}

function displayFirebaseProducts(products) {
    firebaseProductListContainer.innerHTML = '';

    if (products.length === 0) {
        firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد منتجات لعرضها.</p>';
        return;
    }

    products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.classList.add('product-item');

        if (product.isDuplicate) {
            productDiv.classList.add('status-duplicate');
        }

        const profitPerUnit = parseFloat(product.profitPerUnit || 0);
        const commissionPerUnit = parseFloat(product.commissionPerUnit || 0);

        productDiv.innerHTML = `
            <div class="product-firebase-details">
                <p><strong>تاريخ الفاتورة:</strong> ${product.invoiceDate || 'N/A'}</p>
                <p><strong>العميل:</strong> ${product.customerName || 'N/A'}</p>
                <p><strong>اسم المنتج:</strong> ${product.name}</p>
                <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                <p><strong>الكمية المستخدمة:</strong> ${product.quantityUsed || 0}</p>
                <p><strong>الربح/الوحدة (للفاتورة):</strong> ${profitPerUnit.toFixed(2)} DH</p>
                <p><strong>العمولة/الوحدة (للفاتورة):</strong> ${commissionPerUnit.toFixed(2)} DH</p>
                <p><strong>المورد:</strong> ${product.supplierName}</p>
                <p><strong>هاتف المورد:</strong> ${product.ownerPhone}</p>
                <p><strong>مالك الفاتورة:</strong> ${product.ownerName || 'N/A'}</p>
                <p><strong>إجمالي الفاتورة (HT):</strong> ${parseFloat(product.totalHT || 0).toFixed(2)} DH</p>
                <p><strong>إجمالي الفاتورة (TTC):</strong> ${parseFloat(product.totalTTC || 0).toFixed(2)} DH</p>
            </div>
            <div class="product-actions">
                <button type="button" class="btn1" onclick="event.stopPropagation(); editProductFromFirebase(${product.id});">تعديل (محلي)</button>
            </div>
        `;

        productDiv.addEventListener('click', (event) => {
            showProductFormButton.click();
            productNameInput.value = product.name;
            purchasePriceInput.value = parseFloat(product.purchasePrice || 0);
            sellingPriceInput.value = parseFloat(product.sellingPrice || 0);
            supplierNameInput.value = product.supplierName;
            supplierAddressInput.value = product.supplierAddress;
            supplierPhoneInput.value = product.supplierPhone;
            productQuantityInput.value = product.stockQuantity || '0';
            addProductButton.style.display = 'block';
            saveEditProductButton.style.display = 'none';
            resetValidationMessages(productForm);
            showToast(`تم تحميل بيانات المنتج "${product.name}" إلى نموذج إدارة المنتجات.`, 'info');
        });

        firebaseProductListContainer.appendChild(productDiv);
    });
}

function editProductFromFirebase(productId) {
    const firebaseProduct = allFirebaseProducts.find(p => p.id == productId);

    if (firebaseProduct) {
        showProductFormButton.click();
        productNameInput.value = firebaseProduct.name;
        purchasePriceInput.value = parseFloat(firebaseProduct.purchasePrice || 0);
        sellingPriceInput.value = parseFloat(firebaseProduct.sellingPrice || 0);
        supplierNameInput.value = firebaseProduct.supplierName;
        supplierAddressInput.value = firebaseProduct.supplierAddress;
        supplierPhoneInput.value = firebaseProduct.supplierPhone;
        productQuantityInput.value = firebaseProduct.stockQuantity || '0';
        addProductButton.style.display = 'block';
        saveEditProductButton.style.display = 'none';
        resetValidationMessages(productForm);
        showToast(`تم تحميل بيانات المنتج "${firebaseProduct.name}" إلى نموذج إضافة المنتجات (لإعادة إدخاله أو تعديله محليًا).`, 'info');
    } else {
        showToast("المنتج المراد تعديله غير موجود في بيانات Firebase الحالية.", 'error');
    }
}


function filterProducts() {
    const searchInputTerm = firebaseSearchInput.value.toLowerCase();
    const selectedPhoneNumber = phoneDropdown.value;

    const filteredProducts = allFirebaseProducts.filter(product => {
        const matchesSearchInput = searchInputTerm ?
            (product.name && product.name.toLowerCase().includes(searchInputTerm)) ||
            (product.customerName && product.customerName.toLowerCase().includes(searchInputTerm)) ||
            (product.ownerName && product.ownerName.toLowerCase().includes(searchInputTerm)) ||
            (product.supplierName && product.supplierName.toLowerCase().includes(searchInputTerm))
            : true;
        const matchesPhoneNumber = (selectedPhoneNumber === 'all' || product.ownerPhone === selectedPhoneNumber);
        return matchesSearchInput && matchesPhoneNumber;
    });
    
    displayFirebaseProducts(filteredProducts);
}

phoneDropdown.addEventListener('change', () => {
    filterProducts();
});


// ====== Statistics and Tracking ======

function populateStatisticsFilterDropdown() {
    const alldataRef = database.ref('alldata');
    alldataRef.once('value', (snapshot) => {
        const data = snapshot.val();
        statsPhoneDropdown.innerHTML = '';

        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'عرض الكل';
        statsPhoneDropdown.appendChild(allOption);

        const phoneNumbers = new Set();
        if (data) {
            for (const phoneKey in data) {
                if (data.hasOwnProperty(phoneKey)) {
                    phoneNumbers.add(phoneKey);
                }
            }
        }

        const sortedPhoneNumbers = Array.from(phoneNumbers).sort();

        sortedPhoneNumbers.forEach(phoneNumber => {
            const option = document.createElement('option');
            option.value = phoneNumber;
            option.textContent = phoneNumber;
            statsPhoneDropdown.appendChild(option);
        });
    }, (error) => {
        showToast(`خطأ في جلب أرقام الهواتف للإحصائيات من Firebase: ${error.message}`, 'error');
    });
}

async function fetchAndDisplayStatistics() {
    const alldataRef = database.ref('alldata');
    let snapshot;
    try {
        snapshot = await alldataRef.once('value');
    } catch (error) {
        showToast(`خطأ في جلب بيانات الإحصائيات من Firebase: ${error.message}`, 'error');
        return;
    }
    const data = snapshot.val();

    allFirebaseInvoicesData = [];

    if (data) {
        for (const phoneKey in data) {
            if (data.hasOwnProperty(phoneKey)) {
                const phoneData = data[phoneKey];
                for (const invoiceKey in phoneData) {
                    if (phoneData.hasOwnProperty(invoiceKey)) {
                        const invoice = phoneData[invoiceKey];
                        allFirebaseInvoicesData.push({ id: invoiceKey, ...invoice });
                    }
                }
            }
        }
    }

    filterStatistics();
}

function filterStatistics() {
    const searchInputTerm = statsSearchInput.value.toLowerCase();
    const selectedPhoneNumber = statsPhoneDropdown.value;

    let filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
        const matchesSearchInput = searchInputTerm ?
            (invoice.customerName && invoice.customerName.toLowerCase().includes(searchInputTerm)) ||
            (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchInputTerm)) ||
            (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchInputTerm))) ||
            (invoice.ownerPhone && invoice.ownerPhone.includes(searchInputTerm))
            : true;
        const matchesPhoneNumber = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);
        return matchesSearchInput && matchesPhoneNumber;
    });

    let totalSalesHT = 0;
    let totalTVA = 0;
    let totalSalesTTC = 0;
    let totalOverallProfit = 0;
    let totalOverallCommission = 0;
    let totalPurchaseCost = 0;
    let totalSellingPrice = 0;
    let invoiceCount = filteredInvoices.length;
    
    const productSales = {};
    const customerActivity = {};

    filteredInvoices.forEach(invoice => {
        totalSalesHT += parseFloat(invoice.totalHT || 0);
        totalTVA += parseFloat(invoice.tva || 0);
        totalSalesTTC += parseFloat(invoice.totalTTC || 0);
        totalOverallProfit += parseFloat(invoice.totalProfit || 0);
        totalOverallCommission += parseFloat(invoice.totalCommission || 0);

        if (invoice.products) {
            invoice.products.forEach(product => {
                const productName = product.name;
                const quantityUsed = parseInt(product.quantityUsed || 0);
                const purchasePrice = parseFloat(product.purchasePrice || 0);
                const sellingPrice = parseFloat(product.sellingPrice || 0);
                
                totalPurchaseCost += purchasePrice * quantityUsed;
                totalSellingPrice += sellingPrice * quantityUsed;

                if (!productSales[productName]) {
                    productSales[productName] = { quantitySold: 0 };
                }
                productSales[productName].quantitySold += quantityUsed;
            });
        }

        const customer = invoice.customerName || 'N/A';
        const invoiceProfit = parseFloat(invoice.totalProfit || 0);
        
        if (!customerActivity[customer]) {
            customerActivity[customer] = { invoiceCount: 0, totalProfit: 0 };
        }
        customerActivity[customer].invoiceCount += 1;
        customerActivity[customer].totalProfit += invoiceProfit;
    });

    document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCost.toFixed(2)} DH`;
    document.getElementById('totalSellingPrice').textContent = `${totalSellingPrice.toFixed(2)} DH`;
    document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`;
    document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`;
    document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`;
    document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
    document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;
    document.getElementById('invoiceCount').textContent = invoiceCount;


    const topSellingProductsList = document.getElementById('topSellingProducts');
    topSellingProductsList.innerHTML = '';
    const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 5);
    if (sortedProducts.length > 0) {
        sortedProducts.forEach(([name, stats]) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><strong>${name}</strong>: ${stats.quantitySold} وحدات</span>
            `;
            topSellingProductsList.appendChild(li);
        });
    } else {
        topSellingProductsList.innerHTML = '<li>لا توجد بيانات</li>';
    }

    const topCustomersList = document.getElementById('topCustomers');
    topCustomersList.innerHTML = '';
    const sortedCustomers = Object.entries(customerActivity).sort(([, a], [, b]) => b.invoiceCount - a.invoiceCount).slice(0, 5);
    if (sortedCustomers.length > 0) {
        sortedCustomers.forEach(([name, stats]) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><strong>${name}</strong>: ${stats.invoiceCount} فواتير</span><br>
                <span>&nbsp;&nbsp;الربح: ${stats.totalProfit.toFixed(2)} DH</span>
            `;
            topCustomersList.appendChild(li);
        });
    } else {
        topCustomersList.innerHTML = '<li>لا توجد بيانات</li>';
    }
}

/**
 * Calculates and displays statistics for local products (current inventory).
 */
function calculateAndDisplayLocalStatistics() {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

    let totalPurchaseValue = 0;
    let totalSellingValue = 0;
    let totalPotentialGrossProfit = 0;
    let uniqueProductsInStockCount = 0;
    let totalItemsInStockCount = 0;
    let productsBelowMinStockCount = 0;

    savedProducts.forEach(product => {
        const stock = parseInt(product.stockQuantity || 0);
        const purchase = parseFloat(product.purchasePrice || 0);
        const selling = parseFloat(product.sellingPrice || 0);
        const minStock = parseInt(product.minStockQuantity || 0);

        if (stock > 0) {
            totalPurchaseValue += purchase * stock;
            totalSellingValue += selling * stock;
            totalPotentialGrossProfit += (selling - purchase) * stock;
            uniqueProductsInStockCount++;
            totalItemsInStockCount += stock;
        }

        if (stock < minStock) { // Products below min stock (includes out of stock if minStock > 0)
            productsBelowMinStockCount++;
        }
    });

    localTotalPurchaseCost.textContent = `${totalPurchaseValue.toFixed(2)} DH`;
    localTotalSellingPrice.textContent = `${totalSellingValue.toFixed(2)} DH`;
    localTotalPotentialProfit.textContent = `${totalPotentialGrossProfit.toFixed(2)} DH`;
    localUniqueProductsInStock.textContent = uniqueProductsInStockCount;
    localTotalItemsInStock.textContent = totalItemsInStockCount;
    localProductsBelowMinStock.textContent = productsBelowMinStockCount;
}

</script>
