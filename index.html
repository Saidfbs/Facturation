<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" > <title>إدارة المبيعات والمخزون - لوحة معلومات عصرية ومحدثة</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Professional Dashboard Color Palette (CSS Variables) - From Code 1 */
        :root {
            --dashboard-bg-primary: hsl(210, 10%, 97%); /* Very light off-white/gray */
            --dashboard-card-bg: hsl(0, 0%, 100%);     /* Pure white for cards */
            --dashboard-primary-blue: hsl(210, 29%, 29%); /* Deep professional blue */
            --dashboard-accent-blue: hsl(205, 78%, 42%); /* Vibrant accent blue */
            --dashboard-accent-green: hsl(120, 50%, 50%); /* Clear success green */
            --dashboard-accent-orange: hsl(45, 80%, 65%); /* Soft orange for distinction */
            --dashboard-accent-red: hsl(0, 70%, 55%);    /* Standard error red */
            --dashboard-text-dark: hsl(210, 10%, 15%);   /* Dark gray for primary text */
            --dashboard-text-secondary: hsl(210, 5%, 40%); /* Medium gray for secondary text */
            --dashboard-border-light: hsl(210, 5%, 90%); /* Light gray border */
            --dashboard-hover-bg: hsl(210, 30%, 96%); /* Light hover background */
            --dashboard-shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.08);
            --dashboard-shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.12);
            --dashboard-shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.18);
        }

        /* Base Styles - Unified */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: 'Cairo', sans-serif; /* Changed to Cairo */
            direction: rtl;
            background-color: var(--dashboard-bg-primary); /* Use dashboard-bg-primary */
            color: var(--dashboard-text-dark); /* Use dashboard-text-dark */
            font-size: 15px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 0; /* Removed body padding, let main container handle it */
            min-height: 100vh; /* Ensure body takes full viewport height */
        }

        /* Custom scrollbar for better aesthetics - Unified */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbars */
        }

        ::-webkit-scrollbar-track {
            background: var(--dashboard-bg-primary); /* Use dashboard-bg-primary */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dashboard-accent-blue); /* Use dashboard-accent-blue */
            border-radius: 10px;
            border: 2px solid var(--dashboard-bg-primary); /* Use dashboard-bg-primary */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dashboard-primary-blue); /* Use dashboard-primary-blue */
        }

        /* Hide number input arrows - Unified */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Container & Layout - Unified and Adjusted for wider use */
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2.5rem; /* Consistent spacing */
            width: 100%;
            /* Removed max-width to allow it to take full available width */
            margin: 0 auto; /* Center the content within the available space */
            padding: 1.5rem; /* SLIGHTLY REDUCED padding for more space */
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }

        .view-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            display: none; /* Hidden by default, shown by JS */
            width: 100%;
        }

        .view-section.active {
            display: block; /* Show the active section */
            opacity: 1;
            transform: translateY(0);
        }

        /* Headings & Typography - Unified */
        .page-title {
            font-size: 2.5rem;
            color: var(--dashboard-primary-blue);
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--dashboard-border-light);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .page-title i.main-icon {
            color: var(--dashboard-accent-blue);
            font-size: 1.2em;
        }

        .card-title {
            font-size: 1.6rem;
            color: var(--dashboard-primary-blue);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--dashboard-border-light);
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align to start for RTL */
            gap: 0.75rem;
            font-weight: 700;
        }

        .card-title .card-icon {
            font-size: 1.2em;
            color: var(--dashboard-accent-blue);
        }

        /* Cards - Unified */
        .card {
            background-color: var(--dashboard-card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--dashboard-shadow-medium);
            padding: 1.5rem;
            border: 1px solid var(--dashboard-border-light);
            transition: all 0.3s ease;
            width: 100%; /* Ensures it takes full width of its grid cell/parent */
        }

        .card:hover {
            box-shadow: var(--dashboard-shadow-strong);
            transform: translateY(-0.3rem);
        }

        /* Forms - Unified */
        .form-group {
            margin-bottom: 1rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dashboard-text-dark);
            font-size: 0.9rem;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--dashboard-accent-red);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%; /* Ensures inputs take full width of their form-group */
            padding: 0.75rem 1rem;
            border: 1px solid var(--dashboard-border-light);
            border-radius: 0.5rem;
            font-size: 1em;
            color: var(--dashboard-text-dark);
            background-color: var(--dashboard-bg-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--dashboard-accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.2);
            background-color: var(--dashboard-card-bg);
        }

        .form-group input.error,
        .form-group select.error {
            border-color: var(--dashboard-accent-red);
            box-shadow: 0 0 0 3px hsla(0, 70%, 55%, 0.2);
        }

        .form-group .validation-error-message {
            color: var(--dashboard-accent-red);
            font-size: 0.85em;
            margin-top: 0.25rem;
            display: none;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message,
        .form-group input.error + .validation-error-message,
        .form-group select.error + .validation-error-message {
            display: flex; 
        }

        /* Buttons - Unified */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
            box-shadow: var(--dashboard-shadow-subtle);
            white-space: nowrap;
        }

        .btn-icon {
            font-size: 1em;
        }

        .btn-primary, .btn-success {
            background-color: var(--dashboard-accent-blue);
            color: white;
        }

        .btn-primary:hover, .btn-success:hover {
            background-color: var(--dashboard-primary-blue);
            transform: translateY(-2px);
            box-shadow: var(--dashboard-shadow-medium);
        }

        .btn-primary:active, .btn-success:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-warning {
            background-color: var(--dashboard-accent-orange);
            color: white;
        }

        .btn-warning:hover {
            background-color: hsl(45, 90%, 55%);
            transform: translateY(-2px);
            box-shadow: var(--dashboard-shadow-medium);
        }

        .btn-warning:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background-color: var(--dashboard-accent-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: hsl(0, 80%, 45%);
            transform: translateY(-2px);
            box-shadow: var(--dashboard-shadow-medium);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--dashboard-border-light);
            color: var(--dashboard-text-dark);
        }

        .btn-secondary:hover {
            background-color: hsl(210, 5%, 80%);
            transform: translateY(-2px);
            box-shadow: var(--dashboard-shadow-medium);
        }

        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled, .btn.loading {
            opacity: 0.6; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.loading .btn-icon,
        .btn.loading span:not(.loader-inline) {
            display: none;
        }

        /* Search Input - Unified */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .search-input {
            padding: 0.75rem 1rem;
            padding-right: 2.5rem; /* Space for icon (from right in RTL) */
            border-radius: 9999px; /* Pill shape */
            border: 1px solid var(--dashboard-border-light);
            width: 100%; /* Ensures search input takes full available width */
            background-color: var(--dashboard-card-bg);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%234B5563\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><circle cx=\'11\' cy=\'11\' r=\'8\'></circle><line x1=\'21\' y1=\'21\' x2=\'16.65\' y2=\'16.65\'></line></svg>');
            background-repeat: no-repeat;
            background-position: left 0.75rem center; /* Position icon to the left for RTL */
            background-size: 1.25rem;
            color: var(--dashboard-text-dark);
            outline: none;
            transition: all 0.2s ease;
            text-align: right;
        }

        .search-input:focus {
            border-color: var(--dashboard-accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.2);
        }

        .clear-search-btn {
            position: absolute;
            left: 0.75rem; /* Position clear button to the left for RTL */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--dashboard-text-secondary);
            cursor: pointer;
            font-size: 1.1em;
            padding: 0.3rem;
            transition: color 0.2s ease;
        }

        .clear-search-btn:hover {
            color: var(--dashboard-accent-red);
        }

        /* Loaders - Unified */
        .loader {
            border: 4px solid var(--dashboard-border-light);
            border-top: 4px solid var(--dashboard-accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            display: none;
        }

        .loader.active {
            display: block;
        }

        .loader-inline {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
            margin-right: 0.3rem;
            vertical-align: middle;
        }

        .loader-inline.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Navigation (Top & Bottom) - Unified */
        .top-nav {
            background-color: var(--dashboard-card-bg);
            box-shadow: var(--dashboard-shadow-medium);
            padding: 1rem 2.5rem;
            margin-bottom: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }

        .top-nav > div {
            /* Removed max-width to allow it to take full available width */
            width: 100%; /* Ensures it takes full width of its parent */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .top-nav .nav-right-section { 
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .top-nav .nav-left-section { 
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap; 
            justify-content: flex-end; 
        }

        .app-brand {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dashboard-primary-blue);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .app-brand i {
            color: var(--dashboard-accent-blue);
            font-size: 1em;
        }

        .nav-links, .nav-data-management-links { 
            display: flex;
            gap: 0.75rem;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            color: var(--dashboard-text-secondary);
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s ease-in-out; 
            box-shadow: none; 
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background-color: var(--dashboard-hover-bg);
            color: var(--dashboard-text-dark);
            transform: translateY(-1px); 
        }

        .nav-btn.active {
            background-color: var(--dashboard-accent-blue);
            color: white;
            box-shadow: var(--dashboard-shadow-subtle); 
            transform: none;
        }

        .nav-btn:active {
            transform: translateY(1px); 
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); 
        }

        /* Dashboard Grid - Unified */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(20rem, 1fr)); /* Ensures flexible width columns */
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            width: 100%;
        }

        /* Product List Grid (savedProductsList) - Unified */
        .product-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr)); /* Ensures flexible width columns */
            gap: 1.5rem;
            margin-top: 1.5rem;
            width: 100%;
        }

        /* Product Card - Unified */
        .product-card {
            background-color: var(--dashboard-card-bg);
            border: 1px solid var(--dashboard-border-light);
            border-right: 0.5rem solid var(--dashboard-accent-blue);
            border-radius: 0.75rem;
            box-shadow: var(--dashboard-shadow-subtle);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: all 0.2s ease-out;
            text-align: right;
            position: relative;
            overflow: hidden;
            width: 100%; /* Explicitly ensure full width within its grid cell */
        }

        .product-card:hover {
            transform: translateY(-0.3rem);
            box-shadow: var(--dashboard-shadow-medium);
        }

        .product-card .product-details {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed var(--dashboard-border-light);
        }

        .product-card .product-details p {
            margin: 0 0 0.25rem 0; 
            font-size: 0.95em; 
            color: var(--dashboard-text-secondary);
        }

        .product-card .product-details p strong {
            color: var(--dashboard-text-dark);
            font-size: 1em; 
        }

        .product-card .product-details p:first-child {
            font-size: 1.1em; 
            font-weight: 700;
            color: var(--dashboard-primary-blue);
            margin-bottom: 0.75rem;
        }

        .product-card .supplier-info {
            margin-bottom: 0.75rem;
        }

        .product-card .supplier-info p {
            font-size: 0.85em;
            color: var(--dashboard-text-secondary);
            margin: 0 0 0.2rem 0;
        }

        .product-card .supplier-info p strong {
            color: var(--dashboard-text-dark);
        }

        .product-card .stock-section,
        .product-card .invoice-quantity-section {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.75rem;
            gap: 0.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--dashboard-border-light);
        }

        .product-card .stock-section p,
        .product-card .invoice-quantity-section p {
            font-weight: 600;
            color: var(--dashboard-text-dark);
            font-size: 0.9em;
            margin: 0;
        }

        .product-card .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0;
            margin-bottom: 0;
        }

        .product-card .quantity-controls input {
            flex-grow: 1;
            max-width: 100px;
            text-align: center;
            background-color: var(--dashboard-bg-primary);
            border: 1px solid var(--dashboard-border-light);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .product-card .stock-adjust-btn,
        .product-card .quantity-adjust-btn {
            background-color: var(--dashboard-accent-blue);
            color: white;
            border: none;
            border-radius: 0.5rem;
            width: 2.25rem;
            height: 2.25rem;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .product-card .stock-adjust-btn:hover,
        .product-card .quantity-adjust-btn:hover {
            background-color: var(--dashboard-primary-blue);
            transform: scale(1.05);
        }

        .product-card .stock-adjust-btn:active,
        .product-card .quantity-adjust-btn:active {
            transform: scale(0.95);
        }

        .product-card .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--dashboard-border-light);
        }

        .product-card .product-actions .btn {
            flex-grow: 1;
            min-width: 100px;
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Product Status Colors - Unified */
        .product-card.status-insufficient {
            background-color: hsl(0, 100%, 98%);
            border-color: var(--dashboard-accent-red);
            box-shadow: 0 6px 15px hsla(0, 70%, 55%, 0.1);
        }

        .product-card.status-insufficient .product-details p,
        .product-card.status-insufficient .product-details p strong {
            color: var(--dashboard-accent-red);
        }

        .product-card.status-insufficient .product-details p:first-child {
            color: var(--dashboard-accent-red); 
        }

        .product-card.status-insufficient .quantity-controls input {
            border-color: var(--dashboard-accent-red);
        }

        .product-card.status-insufficient .stock-section p {
            color: var(--dashboard-accent-red); 
        }

        .product-card.status-selected-sufficient {
            background-color: hsl(120, 100%, 98%);
            border-color: var(--dashboard-accent-green);
            box-shadow: 0 6px 15px hsla(120, 50%, 50%, 0.1);
        }

        .product-card.status-selected-sufficient .product-details p,
        .product-card.status-selected-sufficient .product-details p strong {
            color: var(--dashboard-text-dark);
        }

        .product-card.status-selected-sufficient .product-details p:first-child {
            color: var(--dashboard-accent-green); 
        }

        .product-card.status-stock-positive {
            background-color: var(--dashboard-card-bg); 
            border-color: var(--dashboard-border-light);
            box-shadow: var(--dashboard-shadow-subtle); 
        }

        /* Invoice Display - Unified and Adjusted for wider use */
        .invoice-display-section {
            max-width: 100%; /* Changed to 100% to fill the container */
            margin: 0 auto; /* Still center to maintain responsive behavior within the container */
            padding: 1.5rem; /* Match container padding */
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }

        .invoice-details-card .invoice-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px dashed var(--dashboard-border-light);
            text-align: right;
        }

        .invoice-details-card .invoice-header h2 {
            color: var(--dashboard-primary-blue);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        .invoice-details-card .invoice-header h2 i {
            color: var(--dashboard-accent-blue);
            margin-left: 0.5rem;
        }

        .invoice-details-card .invoice-header p {
            margin: 0.3rem 0;
            color: var(--dashboard-text-secondary);
        }

        .invoice-details-card .invoice-header p strong {
            color: var(--dashboard-text-dark);
        }

        .invoice-table {
            width: 100%; /* Ensures table takes full available width */
            border-collapse: collapse;
            margin-bottom: 2rem;
            font-size: 0.9em;
            text-align: right;
            border: 1px solid var(--dashboard-border-light);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--dashboard-border-light);
            padding: 0.75rem;
            white-space: nowrap;
            vertical-align: middle;
        }

        .invoice-table th {
            background-color: var(--dashboard-primary-blue);
            color: white;
            font-weight: 600;
        }

        .invoice-table tbody tr:nth-child(even) {
            background-color: var(--dashboard-bg-primary);
        }

        .invoice-summary-card {
            background-color: var(--dashboard-bg-primary); 
            border-color: var(--dashboard-border-light);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .invoice-summary-card .summary-table {
            width: 100%; /* Ensures summary table takes full available width */
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }

        .invoice-summary-card .summary-table td {
            padding: 0.6rem 1rem;
            text-align: right;
            color: var(--dashboard-text-dark);
            font-weight: 600;
            background-color: var(--dashboard-card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--dashboard-shadow-subtle);
        }

        .invoice-summary-card .summary-table .total-row td,
        .invoice-summary-card .summary-table .profit-row td {
            background-color: var(--dashboard-accent-green);
            color: white;
            font-size: 1.1em;
            box-shadow: var(--dashboard-shadow-medium);
        }

        /* Local Archive - Unified */
        .archive-list-card {
            min-height: 400px;
        }

        .invoice-cards-grid {
            grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr));
            gap: 1.5rem;
        }

        .mini-invoice-card {
            background-color: var(--dashboard-card-bg);
            border: 1px solid var(--dashboard-border-light);
            border-right: 0.5rem solid var(--dashboard-accent-blue);
            border-radius: 0.75rem;
            box-shadow: var(--dashboard-shadow-subtle);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: all 0.2s ease-out;
            text-align: right;
            cursor: pointer;
            width: 100%; /* Explicitly ensure full width within its grid cell */
        }

        .mini-invoice-card:hover {
            transform: translateY(-0.3rem);
            box-shadow: var(--dashboard-shadow-medium);
            border-right-color: var(--dashboard-primary-blue);
        }

        .mini-invoice-card .invoice-mini-header p {
            margin-bottom: 0.25rem;
            font-size: 0.9em;
            color: var(--dashboard-text-secondary);
        }

        .mini-invoice-card .invoice-mini-header p strong {
            color: var(--dashboard-text-dark);
            font-size: 1em;
        }

        .mini-product-list {
            background-color: var(--dashboard-bg-primary);
            border: 1px solid var(--dashboard-border-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            width: 100%; /* Ensures list takes full width */
        }

        .mini-product-item-header,
        .mini-product-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr;
            gap: 0.25rem;
            align-items: center;
            padding: 0.3rem 0.5rem;
            text-align: right;
        }

        .mini-product-item-header {
            background-color: var(--dashboard-primary-blue);
            color: white;
            font-weight: 600;
            border-radius: 0.3rem;
        }

        .mini-product-item-row {
            background-color: var(--dashboard-card-bg);
            border: 1px solid var(--dashboard-border-light);
            border-radius: 0.3rem;
            color: var(--dashboard-text-secondary);
        }

        .mini-product-item-row:nth-child(odd) {
            background-color: var(--dashboard-bg-primary);
        }

        .mini-product-item-row div:first-child {
            color: var(--dashboard-text-dark);
        }

        .mini-invoice-card .invoice-mini-footer {
            border-top: 1px dashed var(--dashboard-border-light);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            text-align: right;
        }

        .mini-invoice-card .invoice-mini-footer p strong {
            color: var(--dashboard-accent-green);
            font-size: 1em;
        }

        .mini-invoice-card .invoice-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.75rem;
            width: 100%; /* Ensures action buttons container takes full width */
        }

        .mini-invoice-card .invoice-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            height: auto;
        }

        /* Empty List Message - Unified */
        .empty-list-message {
            text-align: center;
            color: var(--dashboard-text-secondary);
            font-weight: normal;
            padding: 2.5rem;
            grid-column: 1 / -1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%; /* Ensures empty message takes full width */
        }

        .empty-list-message .empty-icon {
            font-size: 3.5rem;
            color: var(--dashboard-border-light);
            margin-bottom: 0.75rem;
        }

        /* Toast Messages - Unified */
        #toast-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            flex-direction: column-reverse;
            gap: 0.75rem;
            align-items: center;
            width: auto;
            max-width: 90vw;
            padding: 1rem;
            box-sizing: border-box;
        }

        .toast {
            background-color: var(--dashboard-card-bg);
            color: var(--dashboard-text-dark);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--dashboard-shadow-subtle);
            min-width: 15.625rem;
            max-width: 21.875rem;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-right: 4px solid;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            font-size: 1rem;
        }
        
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        .toast.success { border-color: var(--dashboard-accent-green); }
        .toast.error { border-color: var(--dashboard-accent-red); }
        .toast.info { border-color: var(--dashboard-accent-blue); }
        .toast.warning { border-color: var(--dashboard-accent-orange); }

        .toast .icon {
            font-size: 1.25rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast.success .icon { color: var(--dashboard-accent-green); }
        .toast.error .icon { color: var(--dashboard-accent-red); }
        .toast.info .icon { color: var(--dashboard-accent-blue); }
        .toast.warning .icon { color: var(--dashboard-accent-orange); }

        .toast span {
            flex-grow: 1;
            text-align: right;
        }

        /* Confirmation Modal - Unified */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-dialog {
            background-color: var(--dashboard-card-bg);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--dashboard-shadow-medium);
            min-width: 18.75rem;
            max-width: 31.25rem;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            direction: rtl;
        }

        .modal-overlay.active .modal-dialog {
            transform: scale(1);
        }

        .modal-title {
            color: var(--dashboard-primary-blue);
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .modal-message {
            color: var(--dashboard-text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 1.05rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Print Styles - Unified */
        @media print {
            body {
                font-family: 'Cairo', sans-serif;
                color: #000;
                background-color: #fff;
                font-size: 11pt;
                padding: 0 !important; 
            }
            .top-nav, #toast-container, .modal-overlay,
            .invoice-actions-print-group, .product-form-card, .invoice-creation-card,
            .saved-products-section .search-container,
            .nav-data-management-links { 
                display: none !important;
            }
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 1cm !important;
            }
            .view-section {
                display: block !important;
                opacity: 1 !important;
                transform: none !important;
                page-break-after: always; 
            }
            .invoice-display-section {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                background-color: #fff !important;
            }
            .invoice-details-card, .invoice-summary-card {
                background-color: transparent !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin-bottom: 0.5cm !important;
            }
            .invoice-header, .invoice-table, .invoice-summary-card .summary-table {
                border-color: #ccc !important;
            }
            .invoice-table th, .invoice-table td {
                border: 1px solid #ddd !important; 
                color: #000 !important;
                background-color: #fff !important;
                padding: 0.5rem !important;
            }
            .invoice-table th {
                background-color: #ededed !important; 
            }
            .invoice-table tbody tr:nth-child(even) {
                background-color: #f9f9f9 !important; 
            }
            .invoice-summary-card .summary-table td {
                background-color: transparent !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                color: #000 !important;
                padding: 0.3rem 0.5rem !important;
            }
            .invoice-summary-card .summary-table .total-row td,
            .invoice-summary-card .summary-table .profit-row td {
                background-color: #e0ffe0 !important;
                color: #000 !important;
            }
            .page-title, .card-title {
                color: #000 !important;
                border-bottom-color: #ccc !important;
                font-size: 14pt !important;
                text-align: center !important;
            }
            .card-icon {
                display: none;
            }
        }
    </style>

</head>

<body>

    <header class="top-nav">
        <div class="max-w-7xl mx-auto w-full flex justify-between items-center flex-wrap gap-4">
            <div class="nav-right-section">
                <div class="app-brand"><i class="fas fa-chart-line"></i> إدارة المبيعات والمخزون</div> 
            </div>
            <div class="nav-left-section">
                <div class="nav-links">
                    <button type="button" class="nav-btn active" id="showDashboardButton">
                        <i class="fas fa-home"></i> الرئيسية
                    </button>
                    <button type="button" class="nav-btn" id="showLocalArchiveButton">
                        <i class="fas fa-archive"></i> أرشيف الفواتير
                    </button>
                </div>
                <div class="nav-data-management-links">
                    <button type="button" class="nav-btn" id="exportDataBtn">
                        <i class="fas fa-download"></i> تصدير (JSON)
                    </button>
                    <input type="file" id="importDataInput" accept=".json" style="display: none;">
                    <button type="button" class="btn nav-btn" id="importDataBtn">
                        <i class="fas fa-upload"></i> استيراد (JSON)
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="toast-container"></div>

    <main class="container">
        <section id="mainDashboardView" class="view-section active">
            <h1 class="page-title"><i class="fas fa-tachometer-alt main-icon"></i> لوحة التحكم الرئيسية</h1> 
            
            <div class="dashboard-grid">
                <div class="card product-form-card" id="productFormContainer">
                    <h2 class="card-title" id="productFormTitle">
                        <i class="fas fa-box card-icon"></i> إدارة المنتجات
                    </h2>
                    <form id="productForm">
                        <div class="form-group">
                            <label for="productName" class="required">Nom du produit</label>
                            <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on"
                                list="productNames">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                            <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on"
                                min="0" step="0.01">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                            <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on"
                                min="0" step="0.01">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierName" class="required">Nom du fournisseur</label>
                            <input type="text" id="supplierName" required placeholder="Nom du fournisseur"
                                autocomplete="on" list="supplierNames">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                            <input type="text" id="supplierAddress" required
                                placeholder="Adresse du fournisseur" autocomplete="on"
                                list="supplierAddresses">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                            <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel"
                                pattern="[0-9]{10}" inputmode="numeric" list="supplierPhones">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="productQuantity">Quantité initiale en stock</label>
                            <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary" id="addProduct">
                                <i class="fas fa-plus-circle btn-icon"></i> إضافة منتج
                                <span class="loader-inline"></span>
                            </button>
                            <button type="submit" class="btn btn-warning" id="saveEditProduct" style="display: none;">
                                <i class="fas fa-edit btn-icon"></i> تعديل المنتج
                                <span class="loader-inline"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card invoice-creation-card" id="clientFormContainer">
                    <h2 class="card-title">
                        <i class="fas fa-file-invoice card-icon"></i> إنشاء الفواتير
                    </h2>
                    <form id="invoiceForm">
                        <div class="form-group">
                            <label for="invoiceDate" class="required">Date de la facture</label>
                            <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="customerName" class="required">Nom du client</label>
                            <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on"
                                list="customerNames">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                            <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture"
                                autocomplete="on" list="invoiceOwners">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la
                                facture</label>
                            <input type="text" id="invoiceOwnerAddress" required
                                placeholder="Adresse du propriétaire de la facture" autocomplete="on"
                                list="invoiceOwnerAddresses">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la
                                facture</label>
                            <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678"
                                autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric" list="invoiceOwnerPhones">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="tva">TVA (%)</label>
                            <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="invoiceCommissionAmount">Montant de la commission (DH)</label>
                            <input type="number" id="invoiceCommissionAmount" placeholder="مثال: 100" value="0" min="0"
                                step="0.01">
                            <span class="validation-error-message"></span>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-success" id="createInvoiceButton">
                                <i class="fas fa-check-circle btn-icon"></i> إنشاء الفاتورة وعرضها
                                <span class="loader-inline"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card saved-products-section" id="savedProductsDisplay">
                <h2 class="card-title">
                    <i class="fas fa-shopping-cart card-icon"></i> المنتجات المحفوظة (سلة الفاتورة)
                </h2>
                <div class="search-container">
                    <input type="text" id="searchProduct" class="search-input" placeholder="البحث عن منتج...">
                    <button class="clear-search-btn" id="clearSearchProductBtn" hidden>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="product-list-grid" id="savedProductsList">
                    <p class="empty-list-message" id="emptyProductsMessage">
                        <i class="fas fa-box-open empty-icon"></i>
                        لا توجد منتجات محفوظة لعرضها. أضف منتجك الأول من النموذج أعلاه.
                        <button type="button" class="btn btn-primary" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
                            <i class="fas fa-plus-circle btn-icon"></i> إضافة منتج جديد
                        </button>
                    </p>
                </div>
                <div class="loader" id="savedProductsLoader"></div>
            </div>
        </section>

        <article class="view-section invoice-display-section" id="invoiceDisplay" hidden>
            <h1 class="page-title"><i class="fas fa-receipt main-icon"></i> الفاتورة</h1>
            <div class="invoice-details-card card">
                <div class="invoice-header">
                    <h2 class="card-title"> <i class="fas fa-user card-icon"></i> تفاصيل الفاتورة
                    </h2>
                    <p><strong>العميل:</strong> <span id="displayCustomerName"></span></p>
                    <p><strong>التاريخ:</strong> <time datetime="" id="displayInvoiceDate"></time></p>
                    <p><strong>المالك:</strong> <span id="displayInvoiceOwner"></span></p>
                    <p><strong>عنوان المالك:</strong> <span id="displayInvoiceOwnerAddress"></span></p>
                    <p><strong>هاتف المالك:</strong> <span id="displayInvoiceOwnerPhone"></span></p>
                </div>
                <div class="table-responsive">
                    <table class="invoice-table" id="invoiceDetails">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>سعر الوحدة</th>
                                <th>الكمية</th>
                                <th>المجموع (HT)</th>
                            </tr>
                        </thead>
                        <tbody id="displayDetails"></tbody>
                    </table>
                </div>
                <div class="invoice-summary-card card">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line card-icon"></i> ملخص الفاتورة
                    </h2>
                    <table class="summary-table">
                        <tfoot>
                            <tr>
                                <td><strong>المجموع قبل العمولة (HT):</strong></td>
                                <td id="displayTotalAmountBeforeCommission"></td>
                            </tr>
                            <tr>
                                <td><strong>العمولة المخصومة:</strong></td>
                                <td id="displayCommissionDeducted"></td>
                            </tr>
                            <tr>
                                <td><strong>المبلغ الإجمالي (HT):</strong></td>
                                <td id="displayTotalAmount"></td>
                            </tr>
                            <tr>
                                <td><strong>الضريبة (TVA):</strong></td>
                                <td id="displayTVA"></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>المبلغ الإجمالي (TTC):</strong></td>
                                <td id="displayTotalTTC"></td>
                            </tr>
                            <tr class="profit-row">
                                <td><strong>الربح الصافي:</strong></td>
                                <td id="displayTotalProfit"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="button-group invoice-actions-print-group">
                    <button type="button" class="btn btn-primary" id="updateStockAndSaveToFirebaseButton">
                        <i class="fas fa-cloud-upload-alt btn-icon"></i> تحديث المخزون وحفظ الفاتورة
                        <span class="loader-inline"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="printButton">
                        <i class="fas fa-print btn-icon"></i> طباعة الفاتورة
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelInvoiceButton">
                        <i class="fas fa-times-circle btn-icon"></i> إلغاء الفاتورة
                    </button>
                </div>
            </div>
        </article>

        <section class="view-section local-archive-section" id="localArchiveView" hidden>
            <h1 class="page-title"><i class="fas fa-folder-open main-icon"></i> أرشيف الفواتير المحلية</h1>
            <div class="card archive-list-card">
                <h2 class="card-title">
                    <i class="fas fa-file-invoice card-icon"></i> الفواتير المحفوظة محلياً
                </h2>
                <div class="search-container">
                    <input type="text" id="searchLocalInvoice" class="search-input"
                        placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتج)..."
                        list="localInvoiceSearchOptions">
                    <button class="clear-search-btn" id="clearSearchLocalInvoiceBtn" hidden>
                        <i class="fas fa-times"></i>
                    </button>
                    <datalist id="localInvoiceSearchOptions"></datalist>
                </div>
                <div class="invoice-cards-grid" id="localInvoicesList">
                    <p class="empty-list-message" id="emptyInvoicesMessage">
                        <i class="fas fa-folder-open empty-icon"></i>
                        لا توجد فواتير محفوظة محلياً.
                    </p>
                </div>
                <div class="loader" id="localArchiveLoader"></div>
            </div>
        </section>

    </main>

    <div id="confirm-modal-overlay" class="modal-overlay" hidden>
        <div id="confirm-modal-dialog" class="modal-dialog">
            <h3 id="confirm-modal-title" class="modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message" class="modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons" class="modal-buttons">
                <button type="button" class="btn btn-success" id="confirm-yes-btn">نعم</button>
                <button type="button" class="btn btn-danger" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

    <datalist id="productNames"></datalist>
    <datalist id="supplierNames"></datalist>
    <datalist id="supplierAddresses"></datalist>
    <datalist id="supplierPhones"></datalist>
    <datalist id="customerNames"></datalist>
    <datalist id="invoiceOwners"></datalist>
    <datalist id="invoiceOwnerAddresses"></datalist>
    <datalist id="invoiceOwnerPhones"></datalist>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <script>
        // Tailwind CSS Configuration to extend colors with CSS variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dashboard-bg-primary': 'var(--dashboard-bg-primary)',
                        'dashboard-card-bg': 'var(--dashboard-card-bg)',
                        'dashboard-primary-blue': 'var(--dashboard-primary-blue)',
                        'dashboard-accent-blue': 'var(--dashboard-accent-blue)',
                        'dashboard-accent-green': 'var(--dashboard-accent-green)',
                        'dashboard-accent-orange': 'var(--dashboard-accent-orange)',
                        'dashboard-accent-red': 'var(--dashboard-accent-red)',
                        'dashboard-text-dark': 'var(--dashboard-text-dark)',
                        'dashboard-text-secondary': 'var(--dashboard-text-secondary)',
                        'dashboard-border-light': 'var(--dashboard-border-light)',
                        'dashboard-hover-bg': 'var(--dashboard-hover-bg)',
                    },
                },
            },
        };

        // ====== UI Elements References ======
        const UIElements = {
            // Main Layout & Navigation
            mainDashboardView: document.getElementById('mainDashboardView'),
            invoiceDisplay: document.getElementById('invoiceDisplay'),
            localArchiveView: document.getElementById('localArchiveView'),
            desktopNavButtons: [
                document.getElementById('showDashboardButton'),
                document.getElementById('showLocalArchiveButton')
            ],
            mainContainer: document.querySelector('main.container'),

            // Product Form
            productForm: document.getElementById('productForm'),
            productFormContainer: document.getElementById('productFormContainer'),
            productFormTitle: document.getElementById('productFormTitle'),
            productNameInput: document.getElementById('productName'),
            purchasePriceInput: document.getElementById('purchasePrice'),
            sellingPriceInput: document.getElementById('sellingPrice'),
            supplierNameInput: document.getElementById('supplierName'),
            supplierAddressInput: document.getElementById('supplierAddress'),
            supplierPhoneInput: document.getElementById('supplierPhone'),
            productQuantityInput: document.getElementById('productQuantity'),
            addProductButton: document.getElementById('addProduct'),
            saveEditProductButton: document.getElementById('saveEditProduct'),
            savedProductsList: document.getElementById('savedProductsList'),
            searchProductInput: document.getElementById('searchProduct'),
            clearSearchProductBtn: document.getElementById('clearSearchProductBtn'),
            savedProductsLoader: document.getElementById('savedProductsLoader'),
            emptyProductsMessage: document.getElementById('emptyProductsMessage'),

            // Invoice Form
            invoiceForm: document.getElementById('invoiceForm'),
            clientFormContainer: document.getElementById('clientFormContainer'),
            customerNameInput: document.getElementById('customerName'),
            invoiceOwnerInput: document.getElementById('invoiceOwner'),
            invoiceOwnerPhoneInput: document.getElementById('invoiceOwnerPhone'),
            invoiceOwnerAddressInput: document.getElementById('invoiceOwnerAddress'),
            invoiceDateInput: document.getElementById('invoiceDate'),
            tvaInput: document.getElementById('tva'),
            invoiceCommissionAmountInput: document.getElementById('invoiceCommissionAmount'),
            createInvoiceButton: document.getElementById('createInvoiceButton'),
            updateStockAndSaveToFirebaseButton: document.getElementById('updateStockAndSaveToFirebaseButton'),
            printButton: document.getElementById('printButton'),
            cancelInvoiceButton: document.getElementById('cancelInvoiceButton'),

            // Invoice Display Elements
            displayCustomerName: document.getElementById('displayCustomerName'),
            displayInvoiceOwner: document.getElementById('displayInvoiceOwner'),
            displayInvoiceDate: document.getElementById('displayInvoiceDate'),
            displayInvoiceOwnerAddress: document.getElementById('displayInvoiceOwnerAddress'),
            displayInvoiceOwnerPhone: document.getElementById('displayInvoiceOwnerPhone'),
            displayTotalAmountBeforeCommission: document.getElementById('displayTotalAmountBeforeCommission'),
            displayCommissionDeducted: document.getElementById('displayCommissionDeducted'),
            displayTotalAmount: document.getElementById('displayTotalAmount'),
            displayTVA: document.getElementById('displayTVA'),
            displayTotalTTC: document.getElementById('displayTotalTTC'),
            displayTotalProfit: document.getElementById('displayTotalProfit'),
            displayDetails: document.getElementById('displayDetails'),

            // Local Archive
            localInvoicesList: document.getElementById('localInvoicesList'),
            searchLocalInvoiceInput: document.getElementById('searchLocalInvoice'),
            clearSearchLocalInvoiceBtn: document.getElementById('clearSearchLocalInvoiceBtn'),
            localArchiveLoader: document.getElementById('localArchiveLoader'),
            emptyInvoicesMessage: document.getElementById('emptyInvoicesMessage'),

            // Data Management (Export/Import)
            exportDataBtn: document.getElementById('exportDataBtn'),
            importDataInput: document.getElementById('importDataInput'),
            importDataBtn: document.getElementById('importDataBtn'),

            // Datalists
            productNamesDatalist: document.getElementById('productNames'),
            supplierNamesDatalist: document.getElementById('supplierNames'),
            supplierAddressesDatalist: document.getElementById('supplierAddresses'),
            supplierPhonesDatalist: document.getElementById('supplierPhones'),
            customerNamesDatalist: document.getElementById('customerNames'),
            invoiceOwnersDatalist: document.getElementById('invoiceOwners'),
            invoiceOwnerAddressesDatalist: document.getElementById('invoiceOwnerAddresses'),
            invoiceOwnerPhonesDatalist: document.getElementById('invoiceOwnerPhones'),
            localInvoiceSearchOptionsDatalist: document.getElementById('localInvoiceSearchOptions'),

            // Modals & Toasts
            toastContainer: document.getElementById('toast-container'),
            confirmModalOverlay: document.getElementById('confirm-modal-overlay'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalMessage: document.getElementById('confirm-modal-message'),
            confirmYesBtn: document.getElementById('confirm-yes-btn'),
            confirmNoBtn: document.getElementById('confirm-no-btn'),
        };

        // Global Data Stores
        let allLocalInvoices = [];
        let currentInvoiceBeingProcessed = null;
        let isNewInvoice = false;
        let isTransitioning = false;

        // Firebase Configuration (Replace with your actual Firebase config)
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
            // Add other config properties if needed, e.g., projectId, apiKey, etc.
        };
        const appId = 'default-app-id'; // This should be dynamically provided in a real environment
        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            UI.showToast("فشل تهيئة Firebase. قد لا تعمل ميزات حفظ البيانات السحابية.", 'error');
        }

        // ====== Key Mapping for Firebase (Local Keys <-> French Keys) ======
        const KEY_MAPPING_TO_FIREBASE = {
            id: 'id',
            name: 'nom',
            purchasePrice: 'prixAchat',
            sellingPrice: 'prixVente',
            supplierName: 'nomFournisseur',
            supplierAddress: 'adresseFournisseur',
            supplierPhone: 'telephoneFournisseur',
            stockQuantity: 'quantiteStock',
            date: 'dateCreationProduit',
            quantity: 'quantiteSelectionnee',
            isLocal: 'estLocal',
            // Invoice Keys
            date: 'dateFacture',
            isoDate: 'dateIsoFacture',
            customerName: 'nomClient',
            ownerName: 'nomProprietaire',
            ownerAddress: 'adresseProprietaire',
            ownerPhone: 'telephoneProprietaire',
            products: 'produits',
            totalHT: 'totalHT',
            totalHTBeforeCommission: 'totalHTAvantCommission',
            tva: 'tva',
            totalTTC: 'totalTTC',
            totalProfit: 'profitTotal',
            totalCommission: 'commissionTotale',
            invoiceCommissionRate: 'tauxCommissionFacture',
            quantityUsed: 'quantiteUtilisee'
        };

        const KEY_MAPPING_FROM_FIREBASE = {};
        for (const localKey in KEY_MAPPING_TO_FIREBASE) {
            KEY_MAPPING_FROM_FIREBASE[KEY_MAPPING_TO_FIREBASE[localKey]] = localKey;
        }

        function mapToFirebaseKeys(obj) {
            const newObj = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    if (key === 'products' && Array.isArray(obj[key])) {
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key].map(p => {
                            const productMapped = {};
                            for (const productKey in p) {
                                if (p.hasOwnProperty(productKey)) {
                                    productMapped[KEY_MAPPING_TO_FIREBASE[productKey] || productKey] = p[productKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key];
                    }
                }
            }
            return newObj;
        }

        function mapFromFirebaseKeys(fbObj) {
            if (fbObj === null || typeof fbObj !== 'object') {
                return fbObj;
            }
            const newObj = {};
            for (const fbKey in fbObj) {
                if (fbObj.hasOwnProperty(fbKey)) {
                    const localKey = KEY_MAPPING_FROM_FIREBASE[fbKey];
                    if (fbKey === 'produits' && Array.isArray(fbObj[fbKey])) {
                        newObj[localKey || fbKey] = fbObj[fbKey].map(p => {
                            const productMapped = {};
                            for (const productFbKey in p) {
                                if (p.hasOwnProperty(productFbKey)) {
                                    productMapped[KEY_MAPPING_FROM_FIREBASE[productFbKey] || productFbKey] = p[productFbKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[localKey || fbKey] = fbObj[fbKey];
                    }
                }
            }
            return newObj;
        }

        // ====== UI Utility Functions ======
        const UI = {
            confirmResolve: null,
            hideAllSections: (instant = false) => {
                [UIElements.mainDashboardView, UIElements.invoiceDisplay, UIElements.localArchiveView].forEach(section => {
                    if (section.classList.contains('active') && !instant) {
                        section.classList.remove('active');
                        section.addEventListener('transitionend', function handler() {
                            section.removeEventListener('transitionend', handler);
                            section.hidden = true;
                        }, { once: true });
                    } else {
                        section.classList.remove('active');
                        section.hidden = true;
                    }
                });
            },
            showSection: (sectionToShow) => {
                if (isTransitioning) {
                    UI.showToast("الرجاء الانتظار حتى يكتمل التحول بين الأقسام.", 'info');
                    return Promise.reject('Transition already in progress');
                }
                isTransitioning = true;
                return new Promise(resolve => {
                    UI.hideAllSections(true);
                    sectionToShow.hidden = false;
                    requestAnimationFrame(() => {
                        sectionToShow.classList.add('active');
                        sectionToShow.addEventListener('transitionend', function handler() {
                            sectionToShow.removeEventListener('transitionend', handler);
                            isTransitioning = false;
                            resolve();
                        }, { once: true });
                    });
                });
            },
            setActiveButton: (activeBtn, buttonGroup) => {
                buttonGroup.forEach(btn => { btn.classList.remove('active'); });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            },
            resetValidationMessages: (form) => {
                form.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
                    field.classList.remove('error');
                    const errorMessageSpan = field.nextElementSibling;
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = '';
                        errorMessageSpan.style.display = 'none';
                    }
                });
            },
            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                let iconHtml = '';
                if (type === 'success') { iconHtml = '<i class="fas fa-check icon"></i>'; }
                else if (type === 'error') { iconHtml = '<i class="fas fa-times icon"></i>'; }
                else if (type === 'info') { iconHtml = '<i class="fas fa-info-circle icon"></i>'; }
                else if (type === 'warning') { iconHtml = '<i class="fas fa-exclamation-triangle icon"></i>'; }
                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            },
            showConfirmModal: (title, message) => {
                return new Promise(resolve => {
                    UI.confirmResolve = resolve;
                    UIElements.confirmModalTitle.textContent = title;
                    UIElements.confirmModalMessage.textContent = message;
                    UIElements.confirmModalOverlay.hidden = false;
                    UIElements.confirmModalOverlay.classList.add('active');
                    const handleConfirm = (result) => {
                        UIElements.confirmModalOverlay.classList.remove('active');
                        UIElements.confirmModalOverlay.hidden = true;
                        UIElements.confirmYesBtn.removeEventListener('click', handleYes);
                        UIElements.confirmNoBtn.removeEventListener('click', handleNo);
                        UI.confirmResolve(result);
                    };
                    const handleYes = () => handleConfirm(true);
                    const handleNo = () => handleConfirm(false);
                    UIElements.confirmYesBtn.addEventListener('click', handleYes, { once: true });
                    UIElements.confirmNoBtn.addEventListener('click', handleNo, { once: true });
                });
            },
            toggleButtonLoading: (button, isLoading) => {
                const loader = button.querySelector('.loader-inline');
                if (loader) {
                    if (isLoading) {
                        button.classList.add('loading');
                        loader.classList.add('active');
                        button.disabled = true;
                    } else {
                        button.classList.remove('loading');
                        loader.classList.remove('active');
                        button.disabled = false;
                    }
                }
            },
            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('active', isLoading);
                }
            },
            updateProductCardClass: (productDiv, quantitySelected, stockQuantity) => {
                productDiv.classList.remove('status-insufficient', 'status-selected-sufficient', 'status-stock-positive');
                if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                    productDiv.classList.add('status-insufficient');
                    productDiv.style.borderColor = 'var(--dashboard-accent-red)';
                } else if (quantitySelected > 0) {
                    productDiv.classList.add('status-selected-sufficient');
                    productDiv.style.borderColor = 'var(--dashboard-accent-green)';
                } else if (stockQuantity <= 0) {
                    productDiv.style.borderColor = 'var(--dashboard-border-light)';
                } else {
                    productDiv.classList.add('status-stock-positive');
                    productDiv.style.borderColor = 'var(--dashboard-border-light)';
                }
            },
            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            },
            populateAllDatalists: () => {
                const savedProducts = DataStore.getSavedProducts();
                UI.populateUniqueDatalist(UIElements.productNamesDatalist, savedProducts, 'name');
                UI.populateUniqueDatalist(UIElements.supplierNamesDatalist, savedProducts, 'supplierName');
                UI.populateUniqueDatalist(UIElements.supplierAddressesDatalist, savedProducts, 'supplierAddress');
                UI.populateUniqueDatalist(UIElements.supplierPhonesDatalist, savedProducts, 'supplierPhone');

                const allInvoiceRelatedData = [...allLocalInvoices];
                UI.populateUniqueDatalist(UIElements.customerNamesDatalist, allInvoiceRelatedData, 'customerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnersDatalist, allInvoiceRelatedData, 'ownerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerAddressesDatalist, allInvoiceRelatedData, 'ownerAddress');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerPhonesDatalist, allInvoiceRelatedData, 'ownerPhone');

                const localInvoiceSearchValues = new Set();
                allLocalInvoices.forEach(invoice => {
                    localInvoiceSearchValues.add(invoice.customerName || '');
                    localInvoiceSearchValues.add(invoice.ownerName || '');
                    localInvoiceSearchValues.add(invoice.date || '');
                    if (invoice.products) {
                        invoice.products.forEach(p => {
                            if (p.name) {
                                localInvoiceSearchValues.add(p.name.trim());
                            }
                        });
                    }
                });
                UIElements.localInvoiceSearchOptionsDatalist.innerHTML = '';
                Array.from(localInvoiceSearchValues).sort().forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        UIElements.localInvoiceSearchOptionsDatalist.appendChild(option);
                    }
                });
            }
        };

        // ====== Data Storage & Manipulation (Local Storage) ======
        const DataStore = {
            getSavedProducts: () => {
                const products = JSON.parse(localStorage.getItem('savedProducts') || '[]');
                console.log("Local Products Loaded:", products);
                return products;
            },
            setSavedProducts: (products) => {
                localStorage.setItem('savedProducts', JSON.stringify(products));
                console.log("Local Products Saved:", products);
            },
            saveProduct: async (productData, isEditing = false) => {
                let products = DataStore.getSavedProducts();
                if (isEditing) {
                    const index = products.findIndex(p => p.id === productData.id);
                    if (index !== -1) {
                        products[index] = productData;
                    }
                } else {
                    productData.id = Date.now() + Math.floor(Math.random() * 1000); 
                    products.push(productData);
                }
                products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                DataStore.setSavedProducts(products);
                UI.showToast(isEditing ? "تم تحديث المنتج وحفظه محلياً بنجاح. ستتم مزامنة البيانات عند تحديث الصفحة أو حفظ فاتورة." : "تم إضافة المنتج وحفظه محلياً بنجاح. ستتم مزامنة البيانات عند تحديث الصفحة أو حفظ فاتورة.", 'success');
            },
            deleteProduct: async (id) => {
                let products = DataStore.getSavedProducts();
                const productToDelete = products.find(product => product.id === id);
                if (productToDelete) {
                    products = products.filter(product => product.id !== id);
                    DataStore.setSavedProducts(products);
                    UI.showToast("تم حذف المنتج بنجاح من الذاكرة المحلية. ستتم مزامنة التغييرات عند تحديث الصفحة أو حفظ فاتورة.", 'success');
                }
            },
            updateProductStock: (id, newStockQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].stockQuantity = Math.max(0, newStockQuantity);
                    DataStore.setSavedProducts(products);
                    const productDiv = UIElements.savedProductsList.querySelector(`.product-card[data-id="${id}"]`);
                    if (productDiv) {
                        UI.updateProductCardClass(productDiv, products[index].quantity || 0, products[index].stockQuantity);
                    }
                }
            },
            updateProductInvoiceQuantity: (id, newQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].quantity = Math.max(0, newQuantity);
                    DataStore.setSavedProducts(products);
                    const productDiv = UIElements.savedProductsList.querySelector(`.product-card[data-id="${id}"]`);
                    if (productDiv) {
                        UI.updateProductCardClass(productDiv, products[index].quantity || 0, products[index].stockQuantity || 0);
                    }
                }
            },
            resetAllProductQuantities: () => {
                let products = DataStore.getSavedProducts();
                products.forEach(product => { product.quantity = 0; });
                DataStore.setSavedProducts(products);
            },
            saveInvoiceToLocal: (invoiceData) => {
                try {
                    let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                    localInvoices.push(invoiceData);
                    localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                    console.log("Invoice Saved Locally:", invoiceData);
                } catch (e) {
                    console.error("Error saving invoice to local storage:", e);
                    UI.showToast("حدث خطأ أثناء حفظ الفاتورة محلياً.", 'error');
                }
            },
            deleteLocalInvoice: (invoiceId) => {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                console.log("Invoice Deleted Locally:", invoiceId);
            },
            loadFormDefaults: () => {
                const now = new Date();
                const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' });
                UIElements.invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
                UIElements.invoiceDateInput.setAttribute('data-iso-date', now.toISOString()); // Store ISO date separately
                UIElements.invoiceOwnerInput.value = localStorage.getItem('invoiceOwner') || '';
                UIElements.invoiceOwnerPhoneInput.value = localStorage.getItem('invoiceOwnerPhone') || '';
                UIElements.invoiceOwnerAddressInput.value = localStorage.getItem('invoiceOwnerAddress') || '';
                UIElements.supplierNameInput.value = localStorage.getItem('supplierName') || '';
                UIElements.supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
                UIElements.supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
                UIElements.invoiceCommissionAmountInput.value = localStorage.getItem('invoiceCommissionAmount') || '0';
                UIElements.tvaInput.value = localStorage.getItem('tva') || '0';
            }
        };

        // ====== Firebase Synchronization Logic (PUSH ONLY) ======
        const FirebaseSync = {
            getFirebasePath: (ownerPhone, type) => {
                if (!ownerPhone) {
                    console.error(`Error: ownerPhone is missing for Firebase path for type: ${type}.`);
                    return null;
                }
                const sanitizedOwnerPhone = ownerPhone.replace(/[.#$[\]]/g, '_');
                const dataPath = (type === 'products') ? 'inventoryProducts' : 'invoices';
                return `${appId}/alldata/${sanitizedOwnerPhone}/${dataPath}`;
            },
            syncSingleProductToFirebase: async (productDataLocalKeys) => {
                if (!database) {
                    console.error("Firebase database not initialized. Product not synced.");
                    return;
                }
                const ownerPhone = localStorage.getItem('invoiceOwnerPhone');
                if (!ownerPhone || !Validation.checkPhoneFormat(ownerPhone)) {
                    console.warn(`Owner phone is invalid or empty for product sync. Product "${productDataLocalKeys.name}" not synced to cloud.`);
                    return;
                }
                const productDataFirebaseKeys = mapToFirebaseKeys(productDataLocalKeys);
                const firebaseProductPath = FirebaseSync.getFirebasePath(ownerPhone, 'products');
                if (!firebaseProductPath) return;
                try {
                    await database.ref(`${firebaseProductPath}/${productDataFirebaseKeys.id}`).set(productDataFirebaseKeys);
                    console.log(`Product "${productDataLocalKeys.name}" synced successfully to Firebase.`);
                }
                catch (error) {
                    console.error(`خطأ في مزامنة المنتج "${productDataLocalKeys.name}" مع Firebase: ${error.message}`, error);
                }
            },
            syncSingleInvoiceToFirebase: async (invoiceDataLocalKeys) => {
                if (!database) {
                    console.error("Firebase database not initialized. Invoice not synced.");
                    throw new Error("Firebase database not initialized.");
                }
                const firebaseInvoicePath = FirebaseSync.getFirebasePath(invoiceDataLocalKeys.ownerPhone, 'invoices');
                if (!firebaseInvoicePath) {
                    console.error("Firebase invoice path not available. Invoice not synced.");
                    throw new Error("Firebase invoice path not available.");
                }
                try {
                    await database.ref(`${firebaseInvoicePath}/${invoiceDataLocalKeys.id}`).set(mapToFirebaseKeys(invoiceDataLocalKeys));
                    console.log(`Invoice ${invoiceDataLocalKeys.id} synced successfully to Firebase.`);
                    return invoiceDataLocalKeys.id;
                } catch (error) {
                    console.error("Failed to save invoice to Firebase:", error);
                    UI.showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error');
                    throw error;
                }
            },
            syncAllLocalDataToFirebaseOnLoad: async () => {
                DataStore.loadFormDefaults();
                const ownerPhoneForSync = UIElements.invoiceOwnerPhoneInput.value.trim();
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    console.warn("Owner phone is invalid or empty on load. Skipping Firebase sync.");
                    UI.showToast("تنبيه: رقم هاتف مالك الفاتورة غير صحيح. لن تتم مزامنة البيانات مع Firebase حتى يتم تصحيحه.", 'warning');
                    Validation.showValidationError(UIElements.invoiceOwnerPhoneInput, "الرجاء إدخال رقم هاتف صحيح (10 أرقام) للمزامنة مع Firebase.");
                    return;
                }
                if (!database) {
                    console.error("Firebase database not initialized. Skipping Firebase sync.");
                    UI.showToast("Firebase غير جاهز. لم يتم مزامنة البيانات السحابية.", 'error');
                    return;
                }
                UI.showToast("جاري مزامنة البيانات المحلية مع Firebase...", 'info');
                const allLocalProducts = DataStore.getSavedProducts();
                console.log(`Syncing ${allLocalProducts.length} local products to Firebase...`);
                for (const product of allLocalProducts) {
                    await FirebaseSync.syncSingleProductToFirebase(product);
                }
                UI.showToast("تمت مزامنة المنتجات المحلية مع Firebase.", 'success');

                let localInvoicesToSync = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                let syncedAnyInvoice = false;
                let invoicesSyncedCount = 0;
                console.log(`Syncing all ${localInvoicesToSync.length} local invoices to Firebase...`);
                for (let i = 0; i < localInvoicesToSync.length; i++) {
                    let invoice = localInvoicesToSync[i];
                    try {
                        await FirebaseSync.syncSingleInvoiceToFirebase(invoice);
                        syncedAnyInvoice = true;
                        invoicesSyncedCount++;
                    } catch (syncError) {
                        console.error(`Failed to sync invoice ${invoice.id} with Firebase: ${syncError.message}`);
                        UI.showToast(`خطأ في مزامنة الفاتورة ${invoice.id} مع Firebase.`, 'error');
                    }
                }
                if (syncedAnyInvoice) {
                    UI.showToast(`تمت مزامنة ${invoicesSyncedCount} فاتورة محلية مع Firebase.`, 'success');
                } else {
                    UI.showToast("لا توجد فواتير جديدة لمزامنتها مع Firebase.", 'info');
                }
                console.log("Firebase sync on load completed.");
            }
        };

        // ====== Navigation & View Management ======
        const Navigation = {
            init: () => {
                UIElements.desktopNavButtons.forEach(button => {
                    button.addEventListener('click', Navigation.handleNavClick);
                });
                // Add event listeners for JSON buttons
                UIElements.exportDataBtn.addEventListener('click', DataManagement.exportData);
                UIElements.importDataBtn.addEventListener('click', () => UIElements.importDataInput.click());
                UIElements.importDataInput.addEventListener('change', DataManagement.importData);
            },
            handleNavClick: async (event) => {
                if (isTransitioning) {
                    UI.showToast("الرجاء الانتظار حتى يكتمل التحول بين الأقسام.", 'info');
                    return;
                }
                const button = event.target.closest('.nav-btn');
                if (!button) return;

                if (!button.id.includes('exportData') && !button.id.includes('importData')) {
                    UI.setActiveButton(button, UIElements.desktopNavButtons);
                }

                UIElements.searchProductInput.value = '';
                UIElements.clearSearchProductBtn.hidden = true;
                UIElements.searchLocalInvoiceInput.value = '';
                UIElements.clearSearchLocalInvoiceBtn.hidden = true;

                try {
                    if (button.id.includes('Dashboard')) {
                        await UI.showSection(UIElements.mainDashboardView);
                        SalesProducts.displaySavedProducts();
                    } else if (button.id.includes('LocalArchive')) {
                        await UI.showSection(UIElements.localArchiveView);
                        LocalArchive.displayLocalInvoices();
                    }
                    UI.populateAllDatalists();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (error) {
                    console.error("Navigation error:", error);
                    UI.showToast("حدث خطأ أثناء التنقل بين الأقسام.", 'error');
                    isTransitioning = false;
                }
            }
        };

        // ====== Product Management Logic ======
        const SalesProducts = {
            init: () => {
                UIElements.productForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const submitButton = e.submitter;
                    if (submitButton === UIElements.addProductButton) {
                        SalesProducts.handleProductFormSubmission(null);
                    } else if (submitButton === UIElements.saveEditProductButton) {
                        const idToEdit = submitButton.dataset.editingId;
                        SalesProducts.handleProductFormSubmission(parseInt(idToEdit));
                    }
                });
                UIElements.savedProductsList.addEventListener('click', SalesProducts.handleProductListClick);
                UIElements.savedProductsList.addEventListener('change', SalesProducts.handleProductListChange);
                UIElements.searchProductInput.addEventListener('input', () => {
                    SalesProducts.displaySavedProducts();
                    UIElements.clearSearchProductBtn.hidden = UIElements.searchProductInput.value === '';
                });
                UIElements.clearSearchProductBtn.addEventListener('click', () => {
                    UIElements.searchProductInput.value = '';
                    UIElements.clearSearchProductBtn.hidden = true;
                    SalesProducts.displaySavedProducts();
                });
            },
            handleProductFormSubmission: async (productId = null) => {
                const isEditing = productId !== null;
                const submitBtn = isEditing ? UIElements.saveEditProductButton : UIElements.addProductButton;
                UI.toggleButtonLoading(submitBtn, true);
                UI.resetValidationMessages(UIElements.productForm);
                if (!Validation.checkFormFields(UIElements.productForm)) {
                    window.scrollTo({ top: UIElements.productFormContainer.offsetTop, behavior: 'smooth' });
                    UI.showToast("يرجى ملء جميع حقول المنتج المطلوبة بشكل صحيح.", 'error');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }
                const productData = {
                    id: productId,
                    name: UIElements.productNameInput.value.trim(),
                    purchasePrice: parseFloat(UIElements.purchasePriceInput.value),
                    sellingPrice: parseFloat(UIElements.sellingPriceInput.value),
                    supplierName: UIElements.supplierNameInput.value.trim(),
                    supplierAddress: UIElements.supplierAddressInput.value.trim(),
                    supplierPhone: UIElements.supplierPhoneInput.value.trim(),
                    stockQuantity: parseInt(UIElements.productQuantityInput.value),
                    date: new Date().toLocaleDateString('ar-MA'),
                    quantity: 0,
                    isLocal: true
                };
                localStorage.setItem('supplierName', productData.supplierName);
                localStorage.setItem('supplierAddress', productData.supplierAddress);
                localStorage.setItem('supplierPhone', productData.supplierPhone);

                localStorage.setItem('invoiceOwner', UIElements.invoiceOwnerInput.value.trim());
                localStorage.setItem('invoiceOwnerAddress', UIElements.invoiceOwnerAddressInput.value.trim());
                localStorage.setItem('invoiceOwnerPhone', UIElements.invoiceOwnerPhoneInput.value.trim());

                const products = DataStore.getSavedProducts();
                const currentInvoiceOwnerPhone = UIElements.invoiceOwnerPhoneInput.value.trim();
                const duplicateCheck = products.some((p) =>
                    (isEditing ? p.id !== productId : true) &&
                    (p.name || '').toLowerCase() === productData.name.toLowerCase() &&
                    (p.ownerPhone || '').toLowerCase() === (currentInvoiceOwnerPhone || '').toLowerCase()
                );

                if (duplicateCheck) {
                    UI.showToast("المنتج موجود بالفعل بنفس الاسم وتحت نفس رقم هاتف مالك الفاتورة.", 'info');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }

                const confirmed = await UI.showConfirmModal(
                    isEditing ? "تأكيد التعديل" : "تأكيد الإضافة",
                    isEditing ? "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟ سيتم تحديثه محلياً. ستتم مزامنة البيانات عند تحديث الصفحة أو حفظ فاتورة." : "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟ سيتم حفظه محلياً. ستتم مزامنة البيانات عند تحديث الصفحة أو حفظ فاتورة."
                );

                if (!confirmed) {
                    UI.showToast(isEditing ? "تم إلغاء تعديل المنتج." : "تم إلغاء إضافة المنتج.", 'info');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }

                await DataStore.saveProduct(productData, isEditing);
                SalesProducts.displaySavedProducts();
                SalesProducts.resetProductFormAndButtons();
                UI.populateAllDatalists();
                UI.toggleButtonLoading(submitBtn, false);
            },
            resetProductFormAndButtons: () => {
                UIElements.productForm.reset();
                UIElements.productFormTitle.innerHTML = '<i class="fas fa-box card-icon"></i> إدارة المنتجات';
                UIElements.addProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.style.display = 'none';
                delete UIElements.saveEditProductButton.dataset.editingId;
                UI.resetValidationMessages(UIElements.productForm);
            },
            editProduct: async (productId) => {
                const productToEdit = DataStore.getSavedProducts().find(p => p.id === productId);
                if (!productToEdit) {
                    UI.showToast("المنتج المراد تعديله غير موجود.", 'error');
                    return;
                }
                if (UIElements.mainDashboardView.hidden) {
                    await UI.showSection(UIElements.mainDashboardView);
                    UI.setActiveButton(UIElements.desktopNavButtons[0], UIElements.desktopNavButtons);
                }

                SalesProducts.resetProductFormAndButtons();
                UIElements.productFormTitle.innerHTML = '<i class="fas fa-edit card-icon"></i> تعديل المنتج';
                UIElements.productNameInput.value = productToEdit.name || '';
                UIElements.purchasePriceInput.value = productToEdit.purchasePrice || 0;
                UIElements.sellingPriceInput.value = productToEdit.sellingPrice || 0;
                UIElements.supplierNameInput.value = productToEdit.supplierName || '';
                UIElements.supplierAddressInput.value = productToEdit.supplierAddress || '';
                UIElements.supplierPhoneInput.value = productToEdit.supplierPhone || '';
                UIElements.productQuantityInput.value = productToEdit.stockQuantity || 0;
                UIElements.addProductButton.style.display = 'none';
                UIElements.saveEditProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.dataset.editingId = productId;
                window.scrollTo({ top: UIElements.productFormContainer.offsetTop, behavior: 'smooth' });
                UI.populateAllDatalists();
            },
            deleteProduct: async (id) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟ سيتم حذفه محلياً. ستتم مزامنة التغييرات عند تحديث الصفحة أو حفظ فاتورة.", 'info');
                if (confirmed) {
                    await DataStore.deleteProduct(id);
                    SalesProducts.displaySavedProducts();
                    UI.showToast("تم حذف المنتج بنجاح من الذاكرة المحلية. ستتم مزامنة التغييرات عند تحديث الصفحة أو حفظ فاتورة.", 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast("تم إلغاء حذف المنتج.", 'info');
                }
            },
            getProductStatusPriority: (quantitySelected, stockQuantity) => {
                if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1;
                if (quantitySelected > 0) return 2;
                if (stockQuantity <= 0) return 3;
                return 4;
            },
            displaySavedProducts: () => {
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, true);
                const searchTerm = UIElements.searchProductInput.value.toLowerCase();
                const savedProducts = DataStore.getSavedProducts();
                UIElements.savedProductsList.innerHTML = '';

                const filteredProducts = savedProducts
                    .filter(product => (product.name || '').toLowerCase().includes(searchTerm) ||
                                         (product.supplierName || '').toLowerCase().includes(searchTerm))
                    .sort((a, b) => {
                        const statusA = SalesProducts.getProductStatusPriority(a.quantity || 0, a.stockQuantity || 0);
                        const statusB = SalesProducts.getProductStatusPriority(b.quantity || 0, b.stockQuantity || 0);
                        if (statusA !== statusB) return statusA - statusB;
                        if ((b.stockQuantity || 0) !== (a.stockQuantity || 0)) {
                            return (b.stockQuantity || 0) - (a.stockQuantity || 0);
                        }
                        return (a.name || '').localeCompare(b.name || '');
                    });

                if (filteredProducts.length === 0) {
                    UIElements.emptyProductsMessage.style.display = 'flex';
                    UIElements.savedProductsList.appendChild(UIElements.emptyProductsMessage);
                    UI.toggleGeneralLoader(UIElements.savedProductsLoader, false);
                    return;
                } else {
                    UIElements.emptyProductsMessage.style.display = 'none';
                }

                filteredProducts.forEach((product) => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-card';
                    productDiv.dataset.id = product.id;
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);
                    productDiv.innerHTML = `
                        <div class="product-details">
                            <p>${product.name || 'N/A'}</p>
                            <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                            <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        </div>
                        <div class="supplier-info">
                            <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                            <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                        </div>
                        <div class="stock-section">
                            <p>الكمية في المخزون:</p>
                            <div class="quantity-controls">
                                <button type="button" class="stock-adjust-btn" data-action="plus">+</button>
                                <input type="number" value="${product.stockQuantity || 0}" min="0" data-product-id="${product.id}" class="stock-input">
                                <button type="button" class="stock-adjust-btn" data-action="minus">-</button>
                            </div>
                        </div>
                        <div class="invoice-quantity-section">
                            <p>الكمية المحددة للفاتورة:</p>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-adjust-btn" data-action="plus">+</button>
                                <input type="number" class="product-quantity-input" data-id="${product.id}" value="${product.quantity || 0}" min="0">
                                <button type="button" class="quantity-adjust-btn" data-action="minus">-</button>
                            </div>
                        </div>
                        <div class="product-actions">
                            <button type="button" class="btn btn-danger" data-product-id="${product.id}">
                                <i class="fas fa-trash-alt btn-icon"></i> حذف
                            </button>
                            <button type="button" class="btn btn-warning" data-product-id="${product.id}">
                                <i class="fas fa-edit btn-icon"></i> تعديل
                            </button>
                        </div>
                    `;
                    UIElements.savedProductsList.appendChild(productDiv);
                });
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, false);
            },
            handleProductListClick: (event) => {
                const target = event.target;
                const productDiv = target.closest('.product-card');
                if (!productDiv) return;
                const productId = parseInt(productDiv.dataset.id);
                if (isNaN(productId)) return;

                if (target.classList.contains('btn-warning') || target.closest('.btn-warning')) {
                    SalesProducts.editProduct(productId);
                } else if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) {
                    SalesProducts.deleteProduct(productId);
                } else if (target.classList.contains('stock-adjust-btn')) {
                    const stockInput = productDiv.querySelector('.stock-input');
                    let currentVal = parseInt(stockInput.value) || 0;
                    currentVal += (target.dataset.action === 'plus' ? 1 : -1);
                    stockInput.value = Math.max(0, currentVal);
                    DataStore.updateProductStock(productId, parseInt(stockInput.value));
                    const product = DataStore.getSavedProducts().find(p => p.id === productId);
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);
                } else if (target.classList.contains('quantity-adjust-btn')) {
                    const quantityInput = productDiv.querySelector('.product-quantity-input');
                    let currentVal = parseInt(quantityInput.value) || 0;
                    currentVal += (target.dataset.action === 'plus' ? 1 : -1);
                    quantityInput.value = Math.max(0, currentVal);
                    DataStore.updateProductInvoiceQuantity(productId, parseInt(quantityInput.value));
                    const product = DataStore.getSavedProducts().find(p => p.id === productId);
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);
                }
            },
            handleProductListChange: (event) => {
                const target = event.target;
                const productDiv = target.closest('.product-card');
                if (!productDiv) return;
                const productId = parseInt(productDiv.dataset.id);
                if (isNaN(productId)) return;

                if (target.classList.contains('stock-input')) {
                    DataStore.updateProductStock(productId, parseInt(target.value || 0));
                    const product = DataStore.getSavedProducts().find(p => p.id === productId);
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);
                } else if (target.classList.contains('product-quantity-input')) {
                    DataStore.updateProductInvoiceQuantity(productId, parseInt(target.value || 0));
                    const product = DataStore.getSavedProducts().find(p => p.id === productId);
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);
                }
            }
        };

        // ====== Invoice Creation & Display Logic ======
        const InvoiceManager = {
            init: () => {
                UIElements.createInvoiceButton.addEventListener('click', InvoiceManager.createAndDisplayInvoice);
                UIElements.updateStockAndSaveToFirebaseButton.addEventListener('click', InvoiceManager.updateStockAndSaveInvoice);
                UIElements.printButton.addEventListener('click', InvoiceManager.printInvoice);
                UIElements.cancelInvoiceButton.addEventListener('click', InvoiceManager.cancelInvoiceProcess);

                UIElements.invoiceOwnerInput.addEventListener('change', () => localStorage.setItem('invoiceOwner', UIElements.invoiceOwnerInput.value));
                UIElements.invoiceOwnerPhoneInput.addEventListener('change', () => localStorage.setItem('invoiceOwnerPhone', UIElements.invoiceOwnerPhoneInput.value));
                UIElements.invoiceOwnerAddressInput.addEventListener('change', () => localStorage.setItem('invoiceOwnerAddress', UIElements.invoiceOwnerAddressInput.value));
                UIElements.tvaInput.addEventListener('change', () => localStorage.setItem('tva', UIElements.tvaInput.value));
                UIElements.invoiceCommissionAmountInput.addEventListener('change', () => localStorage.setItem('invoiceCommissionAmount', UIElements.invoiceCommissionAmountInput.value));
            },
            createAndDisplayInvoice: async () => {
                UI.toggleButtonLoading(UIElements.createInvoiceButton, true);
                UI.resetValidationMessages(UIElements.invoiceForm);
                if (!Validation.checkField(UIElements.invoiceOwnerPhoneInput)) {
                    window.scrollTo({ top: UIElements.clientFormContainer.offsetTop, behavior: 'smooth' });
                    UI.showToast("يرجى ملء حقل 'رقم هاتف صاحب الفاتورة' بشكل صحيح أولاً لإنشاء الفاتورة.", 'error');
                    UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                    return;
                }
                if (!Validation.checkFormFields(UIElements.invoiceForm)) {
                    UI.showToast("يرجى ملء جميع حقول الفاتورة المطلوبة بشكل صحيح.", 'error');
                    UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                    return;
                }
                let totalHTBeforeCommission = 0;
                let totalProfit = 0;
                const invoiceCommissionAmount = parseFloat(UIElements.invoiceCommissionAmountInput.value) || 0;
                let totalCommission = invoiceCommissionAmount;

                let allSavedProducts = DataStore.getSavedProducts();
                let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);
                let productsToProcessForInvoice = [];

                if (selectedProductsForInvoice.length === 0) {
                    const confirmed = await UI.showConfirmModal(
                        "تحديد المنتجات",
                        "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة جميع المنتجات بكمية 1 بشكل افتراضي (حتى لو كان المخزون غير متوفر)؟"
                    );
                    if (confirmed) {
                        productsToProcessForInvoice = allSavedProducts.map(product => ({ ...product, quantityUsed: 1 }));
                        productsToProcessForInvoice = productsToProcessForInvoice.filter(p => p.quantityUsed > 0);
                        if (productsToProcessForInvoice.length === 0) {
                            UI.showToast("لا توجد منتجات لتضمينها في الفاتورة بعد التحديث.", 'info');
                            UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                            return;
                        }
                    } else {
                        UI.showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                        UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                        return;
                    }
                } else {
                    productsToProcessForInvoice = selectedProductsForInvoice.map(product => ({ ...product, quantityUsed: product.quantity }));
                }

                let hasInsufficientStockWarning = false;
                productsToProcessForInvoice.forEach(invoiceProduct => {
                    const productMatch = allSavedProducts.find(p => p.id === invoiceProduct.id);
                    const quantityUsedInInvoice = parseInt(invoiceProduct.quantityUsed || 0);

                    if (productMatch && quantityUsedInInvoice > 0) {
                        const currentStock = parseInt(productMatch.stockQuantity || 0);
                        if (currentStock < quantityUsedInInvoice) {
                            hasInsufficientStockWarning = true;
                            UI.showToast(`تنبيه: كمية "${invoiceProduct.name}" (المطلوبة: ${quantityUsedInInvoice}, المتاحة: ${currentStock}) غير كافية.`, 'warning');
                        }
                        totalHTBeforeCommission += (invoiceProduct.sellingPrice || 0) * quantityUsedInInvoice;
                        totalProfit += ((invoiceProduct.sellingPrice || 0) - (invoiceProduct.purchasePrice || 0)) * quantityUsedInInvoice;
                    } else if (quantityUsedInInvoice > 0) {
                        hasInsufficientStockWarning = true;
                        UI.showToast(`تنبيه: المنتج "${invoiceProduct.name}" في الفاتورة غير موجود محلياً. لا يمكن تحديث المخزون له.`, 'error');
                    }
                });

                if (hasInsufficientStockWarning) {
                    const proceedAnyway = await UI.showConfirmModal(
                        "تنبيه المخزون غير الكافي",
                        "بعض المنتجات في الفاتورة لديها كمية غير كافية في المخزون. هل تريد الاستمرار في إنشاء الفاتورة على أي حال؟"
                    );
                    if (!proceedAnyway) {
                        UI.showToast("تم إلغاء إنشاء الفاتورة بسبب نقص المخزون.", 'info');
                        UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                        return;
                    }
                }

                const finalTotalHT = totalHTBeforeCommission - totalCommission;
                const tvaRate = parseFloat(UIElements.tvaInput.value) / 100;
                const tvaCalculated = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tvaCalculated)).toFixed(2);
                totalProfit -= totalCommission;

                currentInvoiceBeingProcessed = {
                    id: Date.now(),
                    date: UIElements.invoiceDateInput.value,
                    isoDate: UIElements.invoiceDateInput.dataset.isoDate,
                    customerName: UIElements.customerNameInput.value,
                    ownerName: UIElements.invoiceOwnerInput.value,
                    ownerAddress: UIElements.invoiceOwnerAddressInput.value,
                    ownerPhone: UIElements.invoiceOwnerPhoneInput.value,
                    products: productsToProcessForInvoice,
                    totalHT: parseFloat(finalTotalHT).toFixed(2),
                    totalHTBeforeCommission: parseFloat(totalHTBeforeCommission).toFixed(2),
                    tva: parseFloat(tvaCalculated).toFixed(2),
                    totalTTC: parseFloat(totalTTC).toFixed(2),
                    totalProfit: parseFloat(totalProfit).toFixed(2),
                    totalCommission: parseFloat(totalCommission).toFixed(2),
                    invoiceCommissionRate: parseFloat(UIElements.tvaInput.value),
                };
                console.log("Invoice data prepared:", currentInvoiceBeingProcessed); // For your review: log invoice object here
                await InvoiceManager.displayFullInvoice(currentInvoiceBeingProcessed, true);
                UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
            },
            displayFullInvoice: async (invoiceData, isNew = false) => {
                await UI.showSection(UIElements.invoiceDisplay);

                UIElements.displayCustomerName.textContent = invoiceData.customerName || 'N/A';
                UIElements.displayInvoiceOwner.textContent = invoiceData.ownerName || 'N/A';
                UIElements.displayInvoiceDate.textContent = invoiceData.date || 'N/A';
                UIElements.displayInvoiceOwnerAddress.textContent = invoiceData.ownerAddress || 'N/A';
                UIElements.displayInvoiceOwnerPhone.textContent = invoiceData.ownerPhone || 'N/A';

                UIElements.displayTotalAmountBeforeCommission.textContent = `${invoiceData.totalHTBeforeCommission} DH`;
                UIElements.displayCommissionDeducted.textContent = `${invoiceData.totalCommission} DH`;
                UIElements.displayTotalAmount.textContent = `${invoiceData.totalHT} DH`;
                UIElements.displayTVA.textContent = `${invoiceData.tva} DH`;
                UIElements.displayTotalTTC.textContent = `${invoiceData.totalTTC} DH`;
                UIElements.displayTotalProfit.textContent = `${invoiceData.totalProfit} DH`;

                UIElements.displayDetails.innerHTML = '';
                let productNumber = 1;
                if (invoiceData.products && invoiceData.products.length > 0) {
                    invoiceData.products.forEach(product => {
                        const row = document.createElement('tr');
                        const productTotalHT = (parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2);
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</td>
                            <td>${product.quantityUsed || 0}</td>
                            <td>${productTotalHT} DH</td>
                        `;
                        UIElements.displayDetails.appendChild(row);
                    });
                } else {
                    UIElements.displayDetails.innerHTML = `<tr><td colspan="5" style="text-align: center; font-style: italic; color: var(--dashboard-text-secondary);">لا توجد منتجات في هذه الفاتورة.</td></tr>`;
                }

                UIElements.updateStockAndSaveToFirebaseButton.style.display = isNew ? 'flex' : 'none';
                isNewInvoice = isNew;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            updateStockAndSaveInvoice: async function () {
                UI.toggleButtonLoading(this, true);

                if (!isNewInvoice || !currentInvoiceBeingProcessed) {
                    UI.showToast("خطأ: يجب أن تكون فاتورة جديدة لتحديث المخزون وحفظها.", 'info');
                    UI.toggleButtonLoading(this, false);
                    return;
                }

                let savedProducts = DataStore.getSavedProducts();
                let insufficientStockFound = false;
                let productsToDeduct = [];

                currentInvoiceBeingProcessed.products.forEach((invoiceProduct) => {
                    const productMatch = savedProducts.find(p => p.id === invoiceProduct.id);
                    const quantityUsedInInvoice = parseInt(invoiceProduct.quantityUsed || 0);

                    if (productMatch && quantityUsedInInvoice > 0) {
                        const currentStock = parseInt(productMatch.stockQuantity || 0);
                        if (currentStock < quantityUsedInInvoice) {
                            insufficientStockFound = true;
                            UI.showToast(`تنبيه: كمية "${invoiceProduct.name}" (المطلوبة: ${quantityUsedInInvoice}, المتاحة: ${currentStock}) غير كافية.`, 'error');
                        }
                        productsToDeduct.push({
                            productId: productMatch.id,
                            quantityUsed: quantityUsedInInvoice
                        });
                    } else if (quantityUsedInInvoice > 0) {
                        insufficientStockFound = true;
                        UI.showToast(`تنبيه: المنتج "${invoiceProduct.name}" في الفاتورة غير موجود محلياً. لا يمكن تحديث المخزون له.`, 'error');
                    }
                });

                if (insufficientStockFound) {
                    UI.showToast("يرجى مراجعة المنتجات ذات المخزون غير الكافي قبل التحديث.", 'error');
                    UI.toggleButtonLoading(this, false);
                    return;
                }

                const confirmed = await UI.showConfirmModal("تأكيد تحديث المخزون والحفظ", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة وحفظها محلياً؟ ستتم مزامنة التغييرات مع Firebase عند تحديث الصفحة أو حفظ فاتورة أخرى.");

                if (!confirmed) {
                    UI.showToast("تم إلغاء تحديث المخزون والحفظ.", 'info');
                    UI.toggleButtonLoading(this, false);
                    return;
                }

                try {
                    productsToDeduct.forEach(({ productId, quantityUsed }) => {
                        const productIndex = savedProducts.findIndex(p => p.id === productId);
                        if (productIndex !== -1) {
                            savedProducts[productIndex].stockQuantity -= quantityUsed;
                            savedProducts[productIndex].stockQuantity = Math.max(0, savedProducts[productIndex].stockQuantity);
                            savedProducts[productIndex].quantity = 0; // Reset quantity selected for invoice
                        }
                    });
                    DataStore.setSavedProducts(savedProducts);
                    SalesProducts.displaySavedProducts();

                    DataStore.saveInvoiceToLocal(currentInvoiceBeingProcessed);
                    UI.showToast("تم تحديث المخزون وحفظ الفاتورة محلياً بنجاح. ستتم مزامنة التغييرات مع Firebase عند تحديث الصفحة أو حفظ فاتورة أخرى.", 'success');

                    await FirebaseSync.syncSingleInvoiceToFirebase(currentInvoiceBeingProcessed);
                    UI.showToast("تمت مزامنة الفاتورة مع Firebase.", 'success');

                    currentInvoiceBeingProcessed = null;
                    isNewInvoice = false;
                    Navigation.handleNavClick({ target: UIElements.desktopNavButtons[0] }); // Go back to dashboard
                    UI.populateAllDatalists(); // Update datalists with new data
                    LocalArchive.displayLocalInvoices(); // Refresh local archive display
                } catch (error) {
                    console.error("Failed to update stock and save invoice:", error);
                    UI.showToast(`حدث خطأ حرج: ${error.message}. لم يتم حفظ الفاتورة بالكامل.`, 'error');
                } finally {
                    UI.toggleButtonLoading(this, false);
                }
            },
            printInvoice: function () {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                let originalViewportContent = '';
                if (viewportMeta) {
                    originalViewportContent = viewportMeta.getAttribute('content');
                    viewportMeta.setAttribute('content', 'width=900'); // Set a fixed width for printing
                }

                const elementsToHide = document.querySelectorAll('.top-nav, #toast-container, .modal-overlay, .invoice-actions-print-group, .nav-data-management-links');
                elementsToHide.forEach(el => el.style.display = 'none');
                window.print();
                setTimeout(() => {
                    elementsToHide.forEach(el => el.style.display = '');
                    if (viewportMeta && originalViewportContent) {
                        viewportMeta.setAttribute('content', originalViewportContent); // Restore original viewport
                    }
                }, 500); // Give some time for print dialog to appear/close
            },
            cancelInvoiceProcess: async () => {
                const confirmed = await UI.showConfirmModal("إلغاء الفاتورة", "هل أنت متأكد من إلغاء هذه الفاتورة؟ سيتم تجاهل أي تغييرات لم تُحفظ.");
                if (confirmed) {
                    currentInvoiceBeingProcessed = null;
                    isNewInvoice = false;
                    DataStore.resetAllProductQuantities();
                    SalesProducts.displaySavedProducts();
                    UI.showToast("تم إلغاء عملية إنشاء الفاتورة.", 'info');
                    Navigation.handleNavClick({ target: UIElements.desktopNavButtons[0] });
                }
            }
        };

        // ====== Local Archive Logic ======
        const LocalArchive = {
            init: () => {
                UIElements.localInvoicesList.addEventListener('click', LocalArchive.handleLocalInvoiceClick);
                UIElements.searchLocalInvoiceInput.addEventListener('input', () => {
                    LocalArchive.displayLocalInvoices();
                    UIElements.clearSearchLocalInvoiceBtn.hidden = UIElements.searchLocalInvoiceInput.value === '';
                });
                UIElements.clearSearchLocalInvoiceBtn.addEventListener('click', () => {
                    UIElements.searchLocalInvoiceInput.value = '';
                    UIElements.clearSearchLocalInvoiceBtn.hidden = true;
                    LocalArchive.displayLocalInvoices();
                });
            },
            displayLocalInvoices: () => {
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, true);
                try {
                    allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                    console.log("Local Invoices Loaded for display:", allLocalInvoices);
                } catch (e) {
                    console.error("Error parsing local invoices from local storage:", e);
                    allLocalInvoices = [];
                    UI.showToast("خطأ في قراءة أرشيف الفواتير المحلي. تم إعادة تعيينه.", 'error');
                }
                UIElements.localInvoicesList.innerHTML = '';
                const searchTerm = UIElements.searchLocalInvoiceInput.value.toLowerCase();
                const filteredInvoices = allLocalInvoices.filter(invoice => {
                    const customerMatch = (invoice.customerName || '').toLowerCase().includes(searchTerm);
                    const ownerMatch = (invoice.ownerName || '').toLowerCase().includes(searchTerm);
                    const dateMatch = (invoice.date || '').toLowerCase().includes(searchTerm);
                    const productMatch = (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm)));
                    return customerMatch || ownerMatch || dateMatch || productMatch;
                });

                if (filteredInvoices.length === 0) {
                    UIElements.emptyInvoicesMessage.style.display = 'flex';
                    UIElements.localInvoicesList.appendChild(UIElements.emptyInvoicesMessage);
                    UI.toggleGeneralLoader(UIElements.localArchiveLoader, false);
                    return;
                } else {
                    UIElements.emptyInvoicesMessage.style.display = 'none';
                }

                filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                filteredInvoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('mini-invoice-card');
                    invoiceDiv.dataset.invoiceId = invoice.id;
                    let productsListHtml = '<p class="empty-list-message" style="margin: 0; padding: 5px 0; color: var(--dashboard-text-secondary);">لا توجد منتجات.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="mini-product-list">
                                <div class="mini-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية</div>
                                    <div>الإجمالي (HT)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="mini-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.quantityUsed || 0}</div>
                                        <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    invoiceDiv.innerHTML = `
                        <div class="invoice-mini-header">
                            <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="invoice-mini-footer">
                            <p><strong>الإجمالي (TTC):</strong> <span class="text-dashboard-accent-green font-bold">${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</span></p>
                            <p><strong>الربح:</strong> <span class="text-dashboard-accent-green font-bold">${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</span></p>
                        </div>
                        <div class="invoice-actions">
                            <button type="button" class="btn btn-danger" data-invoice-id="${invoice.id}">
                                <i class="fas fa-trash-alt btn-icon"></i> حذف
                            </button>
                        </div>
                    `;
                    UIElements.localInvoicesList.appendChild(invoiceDiv);
                });
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, false);
            },
            handleLocalInvoiceClick: async (event) => {
                const target = event.target;
                const invoiceItem = target.closest('.mini-invoice-card');
                if (!invoiceItem) return;
                const invoiceId = parseInt(invoiceItem.dataset.invoiceId);
                const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);

                if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) {
                    event.stopPropagation();
                    LocalArchive.deleteLocalInvoiceConfirmation(invoiceId);
                } else if (invoiceToView) {
                    event.stopPropagation();
                    await InvoiceManager.displayFullInvoice(invoiceToView, false);
                } else {
                    UI.showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
                }
            },
            deleteLocalInvoiceConfirmation: async (invoiceId) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟ هذا الإجراء لا يمكن التراجع عنه.");
                if (confirmed) {
                    DataStore.deleteLocalInvoice(invoiceId);
                    LocalArchive.displayLocalInvoices();
                    UI.showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي. ستتم مزامنة التغييرات عند تحديث الصفحة أو حفظ فاتورة جديدة.", 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast("تم إلغاء حذف الفاتورة.", 'info');
                }
            }
        };

        // ====== Data Management (Export/Import) Logic ======
        const DataManagement = {
            exportData: () => {
                const allProducts = DataStore.getSavedProducts();
                const allInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                const ownerPhone = localStorage.getItem('invoiceOwnerPhone');
                const exportDate = new Date().toISOString();
                const dataToExport = {
                    metadata: {
                        exportedAt: exportDate,
                        appId: appId,
                        ownerPhone: ownerPhone || 'N/A',
                        description: "بيانات إدارة المبيعات والمخزون - نسخة احتياطية محلية"
                    },
                    products: allProducts,
                    invoices: allInvoices
                };
                const dataStr = JSON.stringify(dataToExport, null, 4);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_backup_${ownerPhone || 'unknown'}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.showToast("تم تصدير البيانات بنجاح إلى ملف JSON.", 'success');
            },
            importData: async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    UI.showToast("لم يتم تحديد أي ملف.", 'info');
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.products || !importedData.invoices) {
                            UI.showToast("ملف JSON غير صالح. يرجى التأكد من أنه يحتوي على بيانات المنتجات والفواتير.", 'error');
                            return;
                        }
                        
                        const importedOwnerPhone = importedData.metadata && importedData.metadata.ownerPhone ? importedData.metadata.ownerPhone : 'N/A';
                        const currentOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
                        let confirmationMessage = `هل أنت متأكد من استيراد هذه البيانات؟ سيؤدي ذلك إلى استبدال البيانات المحلية الحالية.`;
                        if (importedOwnerPhone !== 'N/A' && importedOwnerPhone !== currentOwnerPhone) {
                            confirmationMessage += ` هذه البيانات خاصة بالمالك "${importedOwnerPhone}" ورقم المالك الحالي هو "${currentOwnerPhone}". هل تريد الاستمرار؟`;
                        } else if (importedOwnerPhone !== 'N/A') {
                            confirmationMessage += ` هذه البيانات خاصة بالمالك "${importedOwnerPhone}".`;
                        }

                        const confirmed = await UI.showConfirmModal(
                            "تأكيد استيراد البيانات",
                            confirmationMessage
                        );
                        if (!confirmed) {
                            UI.showToast("تم إلغاء عملية الاستيراد.", 'info');
                            UIElements.importDataInput.value = ''; 
                            return;
                        }
                        localStorage.setItem('savedProducts', JSON.stringify(importedData.products));
                        localStorage.setItem('localInvoices', JSON.stringify(importedData.invoices));
                        
                        if (importedData.metadata && importedData.metadata.ownerPhone) {
                            localStorage.setItem('invoiceOwnerPhone', importedData.metadata.ownerPhone);
                        } else if (importedData.invoices && importedData.invoices.length > 0) {
                             localStorage.setItem('invoiceOwnerPhone', importedData.invoices[0].ownerPhone || '');
                             localStorage.setItem('invoiceOwner', importedData.invoices[0].ownerName || '');
                             localStorage.setItem('invoiceOwnerAddress', importedData.invoices[0].ownerAddress || '');
                        }
                        SalesProducts.displaySavedProducts();
                        LocalArchive.displayLocalInvoices();
                        UI.populateAllDatalists();
                        DataStore.loadFormDefaults();
                        UI.showToast("تم استيراد البيانات بنجاح. سيتم الآن مزامنتها مع Firebase.", 'success');
                        await FirebaseSync.syncAllLocalDataToFirebaseOnLoad(); 
                        UIElements.importDataInput.value = ''; 
                    } catch (parseError) {
                        console.error("Error parsing JSON file:", parseError);
                        UI.showToast("خطأ في قراءة ملف JSON. تأكد من أنه ملف JSON صالح.", 'error');
                        UIElements.importDataInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
        };

        // ====== Form Validation Logic ======
        const Validation = {
            checkPhoneFormat: (phone) => {
                const regex = new RegExp("^[0-9]{10}$");
                return regex.test(phone);
            },
            
            showValidationError: (field, message) => {
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.innerHTML = `<i class="fas fa-exclamation-triangle icon"></i> ${message}`;
                    errorMessageSpan.style.display = 'flex';
                }
                field.classList.add('error');
            },
            checkField: (field) => {
                let isValid = true;
                const fieldValue = field.value.trim();
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.textContent = '';
                    errorMessageSpan.style.display = 'none';
                }
                field.classList.remove('error');
                if (field.hasAttribute('required') && !fieldValue) {
                    isValid = false;
                    Validation.showValidationError(field, `${field.placeholder || field.labels[0].textContent.replace(':', '').trim()} مطلوب.`);
                } else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (isNaN(numValue) || numValue < parseFloat(field.min || 0)) {
                        isValid = false;
                        Validation.showValidationError(field, `القيمة يجب أن تكون رقماً صالحاً وموجباً.`);
                    } else if (field.id === 'tva' && (numValue < 0 || numValue > 100)) {
                        isValid = false;
                        Validation.showValidationError(field, `النسبة يجب أن تكون بين 0 و 100.`);
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    if (!Validation.checkPhoneFormat(fieldValue)) {
                        isValid = false;
                        Validation.showValidationError(field, `صيغة رقم الهاتف غير صحيحة (10 أرقام).`);
                    }
                }
                return isValid;
            },
            checkFormFields: (form) => {
                let allFieldsValid = true;
                form.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
                    // Specific handling for invoiceOwnerPhone when in productForm, as it's not strictly required there
                    if (form.id === 'productForm' && field.id === 'invoiceOwnerPhone') {
                        // We still validate its format if present, but don't fail the form if empty
                        Validation.checkField(field); // Just check, don't set allFieldsValid to false
                        return; 
                    }
                    if (!Validation.checkField(field)) {
                        allFieldsValid = false;
                    }
                });
                return allFieldsValid;
            }
        };

        // ====== Initialization on Window Load ======
        window.addEventListener('load', async () => {
            DataStore.loadFormDefaults();
            SalesProducts.resetProductFormAndButtons();
            UI.setActiveButton(UIElements.desktopNavButtons[0], UIElements.desktopNavButtons);
            UIElements.mainDashboardView.hidden = false;
            requestAnimationFrame(() => {
                UIElements.mainDashboardView.classList.add('active');
            });

            Navigation.init();
            SalesProducts.init();
            InvoiceManager.init();
            LocalArchive.init();

            SalesProducts.displaySavedProducts();
            LocalArchive.displayLocalInvoices();
            UI.populateAllDatalists();
            
            await FirebaseSync.syncAllLocalDataToFirebaseOnLoad();

            const hasData = DataStore.getSavedProducts().length > 0 || JSON.parse(localStorage.getItem('localInvoices') || '[]').length > 0;
            if (hasData) {
                UI.showToast(
                    "تنبيه: يتم حفظ بياناتك محلياً في متصفحك. مسح بيانات المتصفح سيؤدي إلى فقدانها. استخدم خاصية 'تصدير البيانات (JSON)' لعمل نسخة احتياطية.",
                    'warning'
                );
            }
        });
    </script>
</body>
</html>