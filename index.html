<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Créer une facture</title>
    
    <style>
    
:root {
    --background-color: #dcdcdc; /* Very light grey for the background */
    --border-color: #000000; /* Light grey for borders */
    --container-bg-color: #4CAF5030; /* White for containers */
    --button-bg-color: #4CAF50; /* Green for primary buttons */
    --button-bg1-color: #ff9800; /* Orange for secondary buttons */
    --button-bg2-color: #ff9800; /* Blue for tertiary buttons */
    --button-delete-bg-color: #f44336; /* Red for delete buttons */
    --invoice-bg-color: #ffffff; /* Light blue for invoice background */
    --invoice-table-header-bg-color: #ffffff; /* Light blue for table headers */
    --invoice-header-footer-bg-color: #ffffff; /* Medium blue for headers and footers */
    --text-color: #000000; /* Dark grey for text */
    --border-radius: 8px; /* Slightly rounded corners for elements */
}
    
    
body {
font-family: Arial, sans-serif;
direction: ltr;
background-color: var(--background-color);
}

.container{}

.product-container,
.client-container,
.product,
.product-item {
border: 2px solid var(--text-color);
padding: 15px;
border-radius: var(--border-radius);
margin-bottom: 15px;
background-color: var(--container-bg-color);
position: relative;
}

.button-container {
display: flex;
gap: 10px;
}

p {
margin: 0;
padding: 0;
}

.form-group {
margin-bottom: 15px;
}

.form-group label {
display: block;
margin-bottom: 5px;
}

.form-group input,
.form-group textarea {
width: 100%;
padding: 8px;
box-sizing: border-box;
background-color: var(--background-color);
border-radius: var(--border-radius);
border: 2px solid var(--text-color);
margin-bottom: 5px;
}
  
#phoneDropdown {
width: 100%;
padding: 8px;
box-sizing: border-box;
background-color: var(--button-bg-color);
border-radius: var(--border-radius);
border: 2px solid var(--text-color);
margin-bottom: 5px;
}

.form-group textarea {
resize: vertical;
}

.btn,
.btn1,
.btn2,
.btn-delete,
.btn-edit {
display: block;
width: 100%;
padding: 8.75px 0;
color: var(--text-color);
border: 2px solid var(--text-color);
cursor: pointer;
border-radius: var(--border-radius);
text-align: center;
margin-bottom: 5px;
}

.btn {
background-color: var(--button-bg-color);
}

.btn1 {
background-color: var(--button-bg1-color);
}

.btn2 {
background-color: var(--button-bg2-color);
}

.btn-delete {
background-color: var(--button-delete-bg-color);
margin-top: 10px;
}

.btn-edit {
background-color: var(--button-bg1-color);
margin-top: 10px;
}

.invoice {
margin-top: 20px;
padding: 20px;
border-radius: 10px;
background-color: var(--invoice-bg-color);
}

.invoice h2,
.invoice-header,
.invoice-header1,
.invoice-footer {
border: 1px solid var(--border-color);
background-color: var(--invoice-header-footer-bg-color);
margin-bottom: 10px;
padding: 10px;
}

.invoice-header1 {
background-color: var(--invoice-table-header-bg-color);
text-align: center;
}

.invoice-header1 table {
margin: 0 auto;
}

.invoice-header1 tfoot tr td {
text-align: left;
font-weight: bold;
}

.invoice-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 10px;
background-color: var(--invoice-header-footer-bg-color);
}

.invoice-table th,
.invoice-table td {
border: 1px solid var(--border-color);
padding: 8px;
text-align: left;
}

#displayTotalAmount,
#displayTVA,
#displayTotalTTC {
text-align: center;
}

.saved-products3,
.saved-products4 {
}

.quantity-controls {
display: flex;
align-items: center;
margin-top: 10px;
}

.quantity-controls button,
.quantity-controls input {
border-radius: var(--border-radius);
border: 2px solid var(--text-color);
}

.quantity-controls button {
width: 50%;
height: 37px;
background-color: var(--button-bg-color);
padding: 5px 10px;
cursor: pointer;
}

.quantity-controls input {
width: 100%;
height: 32px;
text-align: center;
background-color: var(--background-color);
margin: 0 10px;
border-radius: var(--border-radius);
}

.invoice p {
margin: 5px 0;
}

.invoice .divider {
border-top: 1px solid var(--border-color);
margin: 15px 0;
}

.product-item:last-child {
border-bottom: none;
}
    

.handwritten-title {
    font-family: 'Arial', sans-serif; /* استخدم خطاً واضحاً مثل Arial */
    font-size: 35px; /* حجم الخط أكبر لجعله أكثر وضوحًا */
    font-weight: bold; /* اجعل الخط غليظاً */
    text-align: center; /* جعل العنوان في المنتصف */
    background: linear-gradient(90deg, 
        green 0%, 
        green 25%, 
        yellow 40%,
        yellow 50%,
        orange 75%, 
        orange 100%); /* تدرج يبدأ بالأخضر، ثم الأصفر في الوسط */
    -webkit-background-clip: text;
    color: transparent; /* اجعل النص شفافاً لعرض التدرج */
    margin-bottom: 10px; /* مسافة بين العنوان والنموذج */
margin-top: 10px; /* مسافة بين العنوان والنموذج */
letter-spacing: 1px; /* تحسين التباعد بين الحروف */
}
 
.social-icon {
    position: fixed;
    right: 10px; /* وضع الأيقونات على الجهة اليمنى */
    width: 50px; /* حجم الأيقونات */
    height: 50px; /* حجم الأيقونات */
    z-index: 1000;
    border-radius: 15%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, opacity 0.3s ease; /* تحديث الانتقال ليشمل الشفافية */
    background-size: 70%; /* حجم الخلفية المعدل */
    background-repeat: no-repeat;
    background-position: center;
    opacity: 1; /* تعيين الشفافية الافتراضية */
}

.social-icon.hidden {
    opacity: 0; /* تعيين الشفافية عند التمرير */
    pointer-events: none; /* تعطيل التفاعل مع الأيقونات عند إخفائها */
}

/* أيقونة العودة إلى الأعلى */
.scroll-to-top-icon {
    top: calc(50% - 130px); /* وضع الأيقونة في منتصف الشاشة تقريبًا */
background-color: var(--button-bg1-color);

    background-image: url('https://cdn4.iconfinder.com/data/icons/pictype-free-vector-icons/16/home-1024.png');
}

/* أيقونة فيسبوك */
.facebook-icon {
    top: calc(50% - 65px); /* وضع الأيقونة أسفل الأيقونة السابقة */
background-color: #3b5998;
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg');
}

/* أيقونة واتساب */
.whatsapp-icon {
    top: calc(50%); /* وضع الأيقونة أسفل الأيقونة السابقة */
background-color: #25D366;
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg');
}

/* أيقونة التمرير إلى الأسفل */
.scroll-down-icon {
    top: calc(50% + 65px); /* وضع الأيقونة أسفل الأيقونة السابقة */
background-color: var(--button-bg1-color);

    background-image: url('https://cdn0.iconfinder.com/data/icons/right-direction-1/64/arrow-solid-down-1024.png');
}
 
</style>

<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

</head>
<body>
<div class="container">

  <a href="https://wa.me/212690292010?text= مرحبا، أريد الاستفسار عن الموقع الإلكتروني الخاص بإنشاء الفواتير  https://saidfbs.github.io/Facturation/index.html " class="social-icon whatsapp-icon" target="_blank"></a>
    <a href="https://www.facebook.com/automaticien.mr" class="social-icon facebook-icon" target="_blank"></a>
    
<a href="#" class="social-icon scroll-to-top-icon"></a>
<a href="#" class="social-icon scroll-down-icon"></a>
    
<h1 class="handwritten-title">IRRIG SOLAR</h1>
  
<div class="product-container"> 
<form id="productForm">
<div class="form-group">
<label>Nom du produit</label>
<input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
</div>
<div class="form-group">
<label>Prix du produit</label>
<input type="number" id="productPrice" required placeholder="Prix du produit" autocomplete="on">
</div>
<div class="form-group">
<label>Nom du fournisseur</label>
<input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
</div>
<div class="form-group">
<label>Adresse du fournisseur</label>
<input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
</div>
<div class="form-group">
<label>Téléphone du fournisseur</label>
<input type="text" id="supplierPhone" required placeholder="Téléphone du fournisseur" autocomplete="on">
</div>
<div class="form-group">
<label>Quantité</label>
<input type="number" id="productQuantity" required placeholder="Quantité" value="0">
</div>
<div class="button-container">
<button type="submit" class="btn" id="addProduct">Ajouter produit</button>
<button type="submit" class="btn" id="saveEditProduct">Modifier</button>
<button type="button" class="btn1" id="toggleButton">Créer facture</button>
</div>
</form>
</div>

<!-- Client Form -->
<div class="client-container" hidden>
<form id="invoiceForm">
<div class="form-group">
<label>Date de la facture</label>
<input type="text" id="invoiceDate" required placeholder="Date de la facture">
</div>
<div class="form-group">
<label>Nom du client</label>
<input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
</div>
<div class="form-group">
<label>Nom du Propriétaire de la facture</label>
<input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on">
</div>
<div class="form-group">
<label>Adresse du propriétaire de la facture</label>
<input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on">
</div>
<div class="form-group">
<label>Téléphone du propriétaire de la facture</label>
<input type="text" id="invoiceOwnerPhone" required placeholder="Téléphone du propriétaire de la facture" autocomplete="on">
</div>
<div class="form-group">
<label>TVA</label>
<input type="number" id="tva" required placeholder="TVA" value="0">
</div>
<div class="button-container">
<button type="button" class="btn1" id="toggleButton3">Ajouter produit</button>
<button type="submit" class="btn" id="createInvoiceButton">Créer facture</button>
</div>
</form>
</div>

<!-- Invoice Display -->
<div class="invoice" id="invoiceDisplay" hidden>
<button type="button" class="btn" id="savePdfButton">Gestion de stok</button>
<h1>IRRIG SOLAR</h1>
  <h2>DEVIS</h2>
<div class="invoice-header">
<p>Nom du client: <span id="displayCustomerName"></span></p>
<p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
<p>Date de la facture: <span id="displayInvoiceDate"></span></p>
</div>

<table class="invoice-table" id="invoiceDetails">
<thead>
<tr>
<th>N°</th>
<th>Nom du produit</th>
<th>Prix</th>
<th>Quantité</th>
<th>Montant</th>
</tr>
</thead>
<tbody id="displayDetails">
<!-- Product details will be inserted here -->
</tbody>
</table>

<div class="invoice-header1">
<table>
<tfoot>
<tr>
<td colspan="3"><strong>Montant total HT:</strong></td>
<td id="displayTotalAmount"></td>
</tr>
<tr>
<td colspan="3"><strong>TVA:</strong></td>
<td id="displayTVA"></td>
</tr>
<tr>
<td colspan="3"><strong>Montant total TTC:</strong></td>
<td id="displayTotalTTC"></td>
</tr>
</tfoot>
</table>
</div>

<div class="invoice-footer">
<p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
<p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
</div>
<button type="button" class="btn" id="printButton">Imprimer la facture</button>
</div>

<!-- Saved Products Display -->
<div class="saved-products" id="savedProductsDisplay">
<div class="form-group">
<button type="button" class="btn2" id="toggleButton1">All data</button>
<input type="text" id="searchProduct" placeholder="Rechercher un produit">
</div>
<div class="saved-products3" id="savedProductsList"></div>
</div>

<!-- Filtered Products Display -->
<div class="saved-products2">
<div class="form-group">
<select hidden id="phoneDropdown" onchange="filterByPhoneNumber()">
<!-- الخيارات ستضاف هنا تلقائيًا عبر الكود البرمجي -->
</select>
<input type="text" id="searchInput" placeholder="Rechercher un produit" onkeyup="filterProducts()" hidden>
</div>
<div class="saved-products4" hidden id="productListContainerdata"></div>
</div>

</div>
</body>

<script>
// تكوين Firebase
const firebaseConfig = {
databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",

};
// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
// الحصول على مرجع لقاعدة البيانات
const database = firebase.database();
// الحصول على عناصر HTML
const productForm = document.getElementById('productForm');
const invoiceForm = document.getElementById('invoiceForm');
const invoiceDisplay = document.getElementById('invoiceDisplay');
const customerName = document.getElementById('customerName');
const invoiceOwner = document.getElementById('invoiceOwner');
const invoiceOwnerPhone = document.getElementById('invoiceOwnerPhone');
const invoiceOwnerAddress = document.getElementById('invoiceOwnerAddress');
const invoiceDate = document.getElementById('invoiceDate');
const addProductButton = document.getElementById('addProduct');
const savedProductsDisplay = document.getElementById('savedProductsDisplay');
const savedProductsList = document.getElementById('savedProductsList');
const productContainer = document.querySelector('.product-container');
const clientContainer = document.querySelector('.client-container');
const toggleButton = document.getElementById('toggleButton');
const toggleButton1 = document.getElementById('toggleButton1');
const searchProduct = document.getElementById('searchProduct');
// تعيين التاريخ والوقت الحاليين عند تحميل الصفحة
window.onload = function() {

toggleButton1.style.display = 'none';

window.scrollTo({ top: 0, behavior: 'smooth' });

document.getElementById('saveEditProduct').style.display = 'none';

const now = new Date();
const formattedDate = now.toLocaleDateString('fr-FR');
const formattedTime = now.toLocaleTimeString('fr-FR');
invoiceDate.value = `${formattedDate} ${formattedTime}`;
// تحميل البيانات المحفوظة من Local Storage
const savedInvoiceOwner = localStorage.getItem('invoiceOwner');
const savedInvoiceOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
const savedInvoiceOwnerAddress = localStorage.getItem('invoiceOwnerAddress');
const savedSupplierName = localStorage.getItem('supplierName');
const savedSupplierAddress = localStorage.getItem('supplierAddress');
const savedSupplierPhone = localStorage.getItem('supplierPhone');

console.log('Loaded values:');
console.log('savedInvoiceOwner:', savedInvoiceOwner);
console.log('savedInvoiceOwnerPhone:', savedInvoiceOwnerPhone);
console.log('savedInvoiceOwnerAddress:', savedInvoiceOwnerAddress);
console.log('savedSupplierName:', savedSupplierName);
console.log('savedSupplierAddress:', savedSupplierAddress);
console.log('savedSupplierPhone:', savedSupplierPhone);


if (savedInvoiceOwner) {
invoiceOwner.value = savedInvoiceOwner;
}

if (savedInvoiceOwnerPhone) {
invoiceOwnerPhone.value = savedInvoiceOwnerPhone;
}

if (savedInvoiceOwnerAddress) {
invoiceOwnerAddress.value = savedInvoiceOwnerAddress;
}

if (savedSupplierName) {
document.getElementById('supplierName').value = savedSupplierName;
}

if (savedSupplierAddress) {
document.getElementById('supplierAddress').value = savedSupplierAddress;
}

if (savedSupplierPhone) {
document.getElementById('supplierPhone').value = savedSupplierPhone;
}
};
// التحقق من ملء جميع الحقول المطلوبة

// مستمع للأحداث للزر الخاص بالصعود
document.querySelector('.scroll-to-top-icon').addEventListener('click', function(e) {
    e.preventDefault();
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
  
  setTimeout(function() {
        location.reload();
    }, 1000); // 1000 ميلي ثانية = 1 ثانية

});

// مستمع للأحداث للزر الخاص بالهبوط
document.querySelector('.scroll-down-icon').addEventListener('click', function(e) {
    e.preventDefault();
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
    });
});


// تحديد جميع الأيقونات
const socialIcons = document.querySelectorAll('.social-icon');

// تعريف متغير لتتبع التمرير
let isScrolling;

// تتبع تمرير الصفحة
window.addEventListener('scroll', () => {
    // إخفاء الأيقونات عند التمرير
    socialIcons.forEach(icon => icon.classList.add('hidden'));

    // تصفير مؤقت التوقف عن التمرير
    clearTimeout(isScrolling);

    // تحديد مؤقت لانتظار توقف التمرير
    isScrolling = setTimeout(() => {
        // إظهار الأيقونات عند توقف التمرير
        socialIcons.forEach(icon => icon.classList.remove('hidden'));
    }, 250); // 250ms بعد توقف التمرير
});


function checkFields(form) {
let allFieldsFilled = true;
const fields = form.querySelectorAll('input[required]');
fields.forEach(field => {
if (!field.value.trim()) {
allFieldsFilled = false;
field.style.border = '2px solid red';
} else {
field.style.border = '';
}
});
return allFieldsFilled;
}
// إضافة منتج جديد
addProductButton.addEventListener('click', saveProduct);

function saveProduct() {
if (checkFields(productForm)) {
const name = document.getElementById('productName').value;
const price = document.getElementById('productPrice').value;
const supplierName = document.getElementById('supplierName').value;
const supplierAddress = document.getElementById('supplierAddress').value;
const supplierPhone = document.getElementById('supplierPhone').value;
const stockQuantity = document.getElementById('productQuantity').value; // احصل على كمية المخزون
const id = Date.now();
const date = new Date().toLocaleDateString(); // إنشاء التاريخ الحالي بصيغة محلية

// حفظ بيانات المورد في Local Storage
localStorage.setItem('supplierName', supplierName);
localStorage.setItem('supplierAddress', supplierAddress);
localStorage.setItem('supplierPhone', supplierPhone);

let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
const productExists = products.some(product =>
product.name === name &&
product.price === price &&
product.supplierPhone === supplierPhone
);

// تعيين الخيار الأول في القائمة المنسدلة كخيار افتراضي


if (productExists) {
document.getElementById('searchInput').value = '';

alert("Le produit existe déjà dans la liste.");
return;
}

if (confirm("Êtes-vous sûr de vouloir ajouter ce produit ?")) {
products.push({ id, name, price, supplierName, supplierAddress, supplierPhone, stockQuantity, date }); // إضافة التاريخ إلى البيانات المخزنة
products.sort((a, b) => a.name.localeCompare(b.name));
localStorage.setItem('savedProducts', JSON.stringify(products));
displaySavedProducts();

// إدخال اسم المنتج في حقل البحث بعد الحفظ


} else {
// لم يتم تأكيد الإضافة
productContainer.style.display = 'block';
window.scrollTo({ top: 0, behavior: 'smooth' });





}
} else {
alert("Veuillez remplir tous les champs requis.");
}


}


function updateStock() {
const products = document.querySelectorAll('.product');
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

let canUpdate = true;

// التحقق من توفر الكميات لجميع المنتجات
products.forEach((product) => {
const quantityInput = product.querySelector('.product-quantity');
const quantity = parseInt(quantityInput.value); // تحويل القيمة إلى رقم صحيح

if (quantity > 0) {
const productData = savedProducts.find(p => p.name === product.querySelector('p').textContent.replace('Nom du produit: ', ''));
if (productData && !product.classList.contains('auto-quantity')) {
if (productData.stockQuantity < quantity) { // التحقق من توفر الكمية في المخزون
canUpdate = false; // تعيين canUpdate إلى false إذا لم تتوفر الكمية

// إظهار رسالة تأكيد مع إشارة واضحة



location.reload();

}
}
}
});




// إذا كانت جميع الكميات متوفرة، تحديث المخزون
if (canUpdate) {
products.forEach((product) => {
const quantityInput = product.querySelector('.product-quantity');
const quantity = parseInt(quantityInput.value); // تحويل القيمة إلى رقم صحيح

if (quantity > 0) {
const productData = savedProducts.find(p => p.name === product.querySelector('p').textContent.replace('Nom du produit: ', ''));
if (productData && !product.classList.contains('auto-quantity')) {
productData.stockQuantity -= quantity; // خصم الكمية من المخزون
}
}
});

localStorage.setItem('savedProducts', JSON.stringify(savedProducts)); // تحديث المخزون في Local Storage

// عرض رسالة نجاح عند تحديث المخزون
alert('تم تحديث المخزون بنجاح.');
resetAllProductQuantities();
location.reload();
}
}


// حذف منتج
function deleteProduct(id) {
if (confirm("Êtes-vous sûr de vouloir supprimer ce produit ?")) {
let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
products = products.filter(product => product.id !== id);
localStorage.setItem('savedProducts', JSON.stringify(products));
displaySavedProducts();
}
}
// البحث عن المنتجات وعرضها
searchProduct.addEventListener('input', displaySavedProducts);



function resetAllProductQuantities() {
// قراءة المنتجات المحفوظة من localStorage
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
// تصفير كمية جميع المنتجات
savedProducts.forEach(product => {
product.quantity = 0;
});
// حفظ المصفوفة المعدلة في localStorage
localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

function displaySavedProducts() {
const searchTerm = searchProduct.value.toLowerCase();
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
savedProductsList.innerHTML = '';

const filteredProducts = savedProducts
.filter(product => product.name.toLowerCase().includes(searchTerm))  // تصفية المنتجات بناءً على مصطلح البحث
.sort((a, b) => {
// تعيين القيم الافتراضية إذا لم تكن الخصائص متوفرة
const stockQuantityA = a.stockQuantity || 0;
const stockQuantityB = b.stockQuantity || 0;
const minStockQuantityA = a.minStockQuantity || 0;
const minStockQuantityB = b.minStockQuantity || 0;
const quantityA = a.quantity || 0;
const quantityB = b.quantity || 0;

// حساب الفرق بين الكمية المحددة وكمية المخزون لكل منتج
const specifiedQuantityDiffA = quantityA - stockQuantityA;
const specifiedQuantityDiffB = quantityB - stockQuantityB;

const minStockDiffA = minStockQuantityA - stockQuantityA;
const minStockDiffB = minStockQuantityB - stockQuantityB;

if (specifiedQuantityDiffA > 0 && specifiedQuantityDiffB <= 0) {
return -1; // A يأتي أولاً
}
if (specifiedQuantityDiffA <= 0 && specifiedQuantityDiffB > 0) {
return 1; // B يأتي أولاً
}

if (minStockDiffA > 0 && minStockDiffB <= 0 && a.quantity > 0) {
return -1; // العنصر A يأتي أولاً
}
if (minStockDiffA <= 0 && minStockDiffB > 0 && b.quantity > 0) {
return 1; // العنصر B يأتي أولاً
}

// إذا كانت الفروق متساوية، قم بالترتيب حسب الكمية المحددة بترتيب تنازلي
if (quantityA > quantityB) {
return -1; // A يأتي أولاً
}
if (quantityA < quantityB) {
return 1; // B يأتي أولاً
}

if (minStockDiffA > 0 && minStockDiffB <= 0) {
return -1; // العنصر A يأتي أولاً
}
if (minStockDiffA <= 0 && minStockDiffB > 0) {
return 1; // العنصر B يأتي أولاً
}

// إذا كانت الكميات المحددة متساوية أيضًا، قم بالترتيب حسب كمية المخزون
return stockQuantityB - stockQuantityA;
});

let index = filteredProducts.length;

filteredProducts.forEach((product) => {
const productDiv = document.createElement('div');
productDiv.className = 'product';

const quantityToDisplay = product.quantity || 0;
const stockQuantityToDisplay = product.stockQuantity || 0;
const minStockQuantityToDisplay = product.minStockQuantity || 0;

// تغيير لون خلفية العنصر بناءً على حالة الكمية المحددة وأولوية التلوين
updateProductBackgroundColor(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay);

// تعيين المحتوى الداخلي للعنصر
productDiv.innerHTML = `
<p>Nom du produit: ${product.name}</p>
<p>Prix: ${product.price} DH</p>
<p>Nom du fournisseur: ${product.supplierName}</p>
<p>Adresse du fournisseur: ${product.supplierAddress}</p>
<p>Téléphone du fournisseur: ${product.supplierPhone}</p>

<button class="btn-delete" onclick="deleteProduct(${product.id})">${index} Supprimer</button>
<button class="btn-edit" onclick="editProduct(${product.id})">Modifier</button>

<p><strong>Quantité en stock:</strong></p>
<div class="quantity-controls">
<button onclick="adjustStock(${product.id}, -1)">-</button>
<input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0">
<button onclick="adjustStock(${product.id}, 1)">+</button>
</div>

<p><strong>Stock minimum:</strong></p>
<div class="quantity-controls">
<button onclick="adjustMinQuantity(${product.id}, -1)">-</button>
<input type="number" class="min-product-quantity" data-id="${product.id}" value="${minStockQuantityToDisplay}" min="0">
<button onclick="adjustMinQuantity(${product.id}, 1)">+</button>
</div>

<p><strong>La quantité spécifiée:</strong></p>
<div class="quantity-controls">
<button onclick="adjustQuantity(${product.id}, -1)">-</button>
<input type="number" class="product-quantity" data-id="${product.id}" value="${quantityToDisplay}" min="0">
<button onclick="adjustQuantity(${product.id}, 1)">+</button>
</div>
`;



productDiv.addEventListener('click', (event) => {
// تنفيذ الحدث فقط إذا كان العنصر الذي تم النقر عليه هو زر التعديل
if (event.target.classList.contains('btn-edit')) {
// مسح الخلفيات لجميع العناصر
const allProductDivs = document.querySelectorAll('.product-item');
allProductDivs.forEach(div => div.style.backgroundColor = '');

window.scrollTo({ top: 0, behavior: 'smooth' });

// تحديث الحقول النصية في النموذج
document.getElementById('productName').value = product.name;
document.getElementById('productPrice').value = product.price;
document.getElementById('supplierName').value = product.supplierName;
document.getElementById('supplierAddress').value = product.supplierAddress;
document.getElementById('supplierPhone').value = product.supplierPhone;

clientContainer.style.display = 'none';
productContainer.style.display = 'block';

document.getElementById('addProduct').style.display = 'none';
document.getElementById('saveEditProduct').style.display = 'block';
}
});

savedProductsList.appendChild(productDiv); // إضافة العنصر إلى الحاوية
index--;
});
}



function updateProductBackgroundColor(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay) {
if (quantityToDisplay > 0 && stockQuantityToDisplay < quantityToDisplay) {
productDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.7)'; // أحمر شفاف إذا كانت الكمية المحددة أكبر من كمية المخزون
} else if (stockQuantityToDisplay < minStockQuantityToDisplay && quantityToDisplay == 0) {
productDiv.style.backgroundColor = 'rgba(255, 255, 0, 0.7)'; // أصفر شفاف إذا كان المخزون أقل من الحد الأدنى والكمية المحددة تساوي 0
} else if (stockQuantityToDisplay < minStockQuantityToDisplay) {
productDiv.style.backgroundColor = 'rgba(255, 165, 0, 0.7)'; // برتقالي شفاف إذا كان المخزون أقل من الحد الأدنى
} else if (quantityToDisplay > 0) {
productDiv.style.backgroundColor = 'rgba(0, 128, 0, 0.7)'; // أخضر شفاف إذا كانت الكمية المختارة أكبر من 0
} else if (stockQuantityToDisplay > 0) {
productDiv.style.backgroundColor = 'rgba(0, 0, 255, 0.7)'; // أزرق شفاف إذا كانت كمية المخزون أكبر من 0
} else {
productDiv.style.backgroundColor = ''; // اللون الافتراضي إذا لم تكن أي من الشروط الأخرى مطبقة
}
}



document.getElementById('saveEditProduct').addEventListener('click', function(event) {
if (checkFields(productForm)) {
const name = document.getElementById('productName').value;
const price = document.getElementById('productPrice').value;
const supplierName = document.getElementById('supplierName').value;
const supplierAddress = document.getElementById('supplierAddress').value;
const supplierPhone = document.getElementById('supplierPhone').value;
const stockQuantity = document.getElementById('productQuantity').value;
const id = Date.now();
const date = new Date().toLocaleDateString();

// حفظ بيانات المورد في Local Storage
localStorage.setItem('supplierName', supplierName);
localStorage.setItem('supplierAddress', supplierAddress);
localStorage.setItem('supplierPhone', supplierPhone);

let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
const existingProductIndex = products.findIndex(product =>
product.name === name &&
product.supplierPhone === supplierPhone
);

if (existingProductIndex !== -1) {
// المنتج موجود بالفعل، تحديث المعلومات
if (confirm("Le produit existe déjà. Voulez-vous mettre à jour les informations ?")) {
products[existingProductIndex].price = price;
products[existingProductIndex].supplierName = supplierName;
products[existingProductIndex].supplierAddress = supplierAddress;
products[existingProductIndex].stockQuantity = stockQuantity;
products[existingProductIndex].date = date; // تحديث التاريخ
localStorage.setItem('savedProducts', JSON.stringify(products));
displaySavedProducts();
alert("Le produit a été mis à jour avec succès.");
}
} else {
// المنتج غير موجود، إضافته
if (confirm("Êtes-vous sûr de vouloir ajouter ce produit ?")) {
products.push({ id, name, price, supplierName, supplierAddress, supplierPhone, stockQuantity, date });
products.sort((a, b) => a.name.localeCompare(b.name));
localStorage.setItem('savedProducts', JSON.stringify(products));
document.getElementById('saveEditProduct').style.display = 'none';
displaySavedProducts();

alert("Le produit a été ajouté avec succès.");
}
}
} else {
alert("Veuillez remplir tous les champs requis.");
}

});







function adjustStock(id, amount) {
const stockInput = document.getElementById(`stock-${id}`);
let stockQuantity = parseInt(stockInput.value) || 0;
stockQuantity += amount;
if (stockQuantity < 0) stockQuantity = 0;
stockInput.value = stockQuantity;

// حفظ الكمية في Local Storage
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
const productIndex = savedProducts.findIndex(product => product.id === id);
if (productIndex !== -1) {
savedProducts[productIndex].stockQuantity = stockQuantity;
localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

}

function adjustQuantity(id, amount) {
const quantityInput = document.querySelector(`.product-quantity[data-id="${id}"]`);
let quantity = parseInt(quantityInput.value) || 0;
quantity += amount;
if (quantity < 0) quantity = 0;
quantityInput.value = quantity;

// حفظ الكمية المختارة في Local Storage
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
const productIndex = savedProducts.findIndex(product => product.id === id);
if (productIndex !== -1) {
savedProducts[productIndex].quantity = quantity;
localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

}


function adjustMinQuantity(id, amount) {
const minQuantityInput = document.querySelector(`.min-product-quantity[data-id='${id}']`);
let minQuantity = parseInt(minQuantityInput.value) || 0;
minQuantity += amount;
if (minQuantity < 0) minQuantity = 0;
minQuantityInput.value = minQuantity;

// حفظ القيمة الدنيا في Local Storage
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
const productIndex = savedProducts.findIndex(product => product.id === id);
if (productIndex !== -1) {
savedProducts[productIndex].minStockQuantity = minQuantity;
localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

}


// تعديل قيمة المخزون مباشرة عند التغيير في الحقل


// إنشاء فاتورة
document.getElementById('createInvoiceButton').addEventListener('click', function () {
    // إخفاء أيقونات التواصل الاجتماعي
    const socialIcons = document.querySelectorAll('.social-icon');
    socialIcons.forEach(icon => {
        icon.style.display = 'none';
    });

    // إخفاء العنوان
    document.querySelector('.handwritten-title').style.display = 'none';

    // التحقق من الحقول وتحديث واجهة المستخدم
    if (checkFields(invoiceForm)) {
        const savedProductsDisplay = document.getElementById('savedProductsDisplay');
        if (savedProductsDisplay.style.display === 'none' || savedProductsDisplay.style.display === '') {
            invoiceDisplay.hidden = true;
            savedProductsDisplay.style.display = 'block';
            this.textContent = 'Créer une facture';
        } else {
            const productHidden = productContainer.hidden;
            clientContainer.hidden = productHidden;
            invoiceDisplay.hidden = false;
            savedProductsDisplay.style.display = 'none';
            toggleButton.style.display = 'none';
            toggleButton1.style.display = 'none';
            clientContainer.style.display = 'none';
            productContainer.style.display = 'none';
            this.textContent = 'Vos Produits';
        }
    } else {
        alert("Veuillez remplir tous les champs requis.");
    }
});

invoiceForm.addEventListener('submit', function (e) {
e.preventDefault();

let total = 0;
let productNumber = 1;
const detailsTbody = document.getElementById('displayDetails');
detailsTbody.innerHTML = '';
const products = document.querySelectorAll('.product');

let anyProductSelected = false;

products.forEach((product) => {
const quantityInput = product.querySelector('.product-quantity');
const quantity = parseInt(quantityInput.value); // تحويل القيمة إلى رقم صحيح

if (quantity > 0) {
anyProductSelected = true;
}
});

if (!anyProductSelected) {
products.forEach((product) => {
const quantityInput = product.querySelector('.product-quantity');
quantityInput.value = 1;
});
}

products.forEach((product) => {
const quantityInput = product.querySelector('.product-quantity');
const quantity = parseInt(quantityInput.value); // تحويل القيمة إلى رقم صحيح

if (quantity > 0) {
const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
const productData = savedProducts.find(p => p.name === product.querySelector('p').textContent.replace('Nom du produit: ', ''));
if (productData) {
const price = parseFloat(productData.price);
const amount = price * quantity;
total += amount;

const productDetails = document.createElement('tr');
productDetails.innerHTML = `
<td>${productNumber++}</td> <!-- Add product number -->
<td>${productData.name}</td>
<td>${price.toFixed(2)} DH</td>
<td>${quantity}</td>
<td>${amount.toFixed(2)} DH</td>
`;
detailsTbody.appendChild(productDetails);
}
}
});



const tvaRate = parseFloat(document.getElementById('tva').value) / 100;
const tva = (total * tvaRate).toFixed(2);
const totalTTC = (total + parseFloat(tva)).toFixed(2);

document.getElementById('displayCustomerName').textContent = customerName.value;
document.getElementById('displayInvoiceOwner').textContent = invoiceOwner.value;
document.getElementById('displayInvoiceDate').textContent = invoiceDate.value;
document.getElementById('displayTotalAmount').textContent = total.toFixed(2) + ' DH';
document.getElementById('displayTVA').textContent = tva + ' DH';
document.getElementById('displayTotalTTC').textContent = totalTTC + ' DH';
document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceOwnerPhone.value;
document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceOwnerAddress.value;
invoiceDisplay.hidden = false;

localStorage.setItem('invoiceOwner', invoiceOwner.value);
localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhone.value);
localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddress.value);

const viewportMeta = document.querySelector('meta[name="viewport"]');
if (viewportMeta) {
viewportMeta.setAttribute('content', 'width=1024');
} else {
const newViewportMeta = document.createElement('meta');
newViewportMeta.name = 'viewport';
newViewportMeta.content = 'width=1024';
document.head.appendChild(newViewportMeta);
}



const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
const invoiceData = { products: savedProducts };

const alldataRef = database.ref(`alldata/${invoiceOwnerPhone.value}`);

alldataRef.once('value')
.then((snapshot) => {
const invoiceAllData = [];
snapshot.forEach((productSnapshot) => {
const productData = productSnapshot.val();
if (productData.products) {
invoiceAllData.push(...productData.products);
}
});

const newProducts = invoiceData.products.filter(product =>
!invoiceAllData.some(existingProduct =>
existingProduct.name === product.name &&
existingProduct.price === product.price &&
existingProduct.supplierPhone === product.supplierPhone
)
);

if (newProducts.length > 0) {
alldataRef.push({ products: newProducts }, (error) => {
if (error) {
console.error("Erreur lors de l'ajout du produit à la liste 'alldata':", error);
} else {
console.log("Produits ajoutés avec succès à la liste 'alldata' dans Firebase");
}
});
} else {
console.log("Aucun produit nouveau à ajouter dans Firebase");
}
})
.catch((error) => {
console.error("Erreur lors de la vérification des données:", error);
});




});


let allProducts = [];

// وظيفة لجلب الأرقام من قاعدة البيانات وتحديث القائمة المنسدلة
function populateDropdown() {
const alldataRef = database.ref('alldata');
alldataRef.once('value', (snapshot) => {
const data = snapshot.val();
const dropdown = document.getElementById('phoneDropdown');
dropdown.innerHTML = ''; // مسح المحتوى الحالي للقائمة المنسدلة

// إضافة خيار "عرض الكل"
const allOption = document.createElement('option');
allOption.value = 'all';
allOption.textContent = 'Afficher tout';
dropdown.appendChild(allOption);

// جمع الأرقام وإضافتها إلى القائمة المنسدلة
const phoneNumbers = new Set();
for (const phoneKey in data) {
if (data.hasOwnProperty(phoneKey)) {
phoneNumbers.add(phoneKey);
}
}

phoneNumbers.forEach(phoneNumber => {
const option = document.createElement('option');
option.value = phoneNumber;
option.textContent = phoneNumber;
dropdown.appendChild(option);
});
});
}




function fetchAndDisplayData(selectedPhoneNumber = 'all') {

const alldataRef = database.ref('alldata');
alldataRef.once('value', (snapshot) => {
const data = snapshot.val();
const productListContainer = document.getElementById('productListContainerdata');
productListContainer.innerHTML = '';

allProducts = []; // إعادة تعيين allProducts

for (const phoneKey in data) {
if (data.hasOwnProperty(phoneKey)) {
if (selectedPhoneNumber === 'all' || phoneKey === selectedPhoneNumber) {
const phoneData = data[phoneKey];
for (const productKey in phoneData) {
if (phoneData.hasOwnProperty(productKey)) {
const productData = phoneData[productKey];
const products = productData.products || [];
allProducts.push(...products);
}
}
}
}
}

const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

// فصل المنتجات إلى مكررة وغير مكررة
const nonDuplicateProducts = [];
const duplicateProducts = [];

allProducts.forEach(product => {
const isDuplicate = savedProducts.some(savedProduct =>
savedProduct.name === product.name &&
savedProduct.price === product.price &&
savedProduct.phone === product.phone
);
if (isDuplicate) {
product.isDuplicate = true;
duplicateProducts.push(product);
} else {
product.isDuplicate = false;
nonDuplicateProducts.push(product);
}
});

// ترتيب المنتجات غير المكررة بناءً على الـ id (الأحدث أولاً)
nonDuplicateProducts.sort((a, b) => b.id - a.id);

// ترتيب المنتجات المكررة بناءً على الـ id (الأحدث أولاً)
duplicateProducts.sort((a, b) => b.id - a.id);

// دمج المنتجات غير المكررة مع المكررة (غير المكررة في الأعلى)
const sortedProducts = [...nonDuplicateProducts, ...duplicateProducts];

// عرض المنتجات
displayProducts(sortedProducts);

});
}




function displayProducts(products) {
const productListContainer = document.getElementById('productListContainerdata');
productListContainer.innerHTML = '';

let index = products.length;

products.forEach(product => {
const productDiv = document.createElement('div');
productDiv.classList.add('product-item');

// تغيير اللون إذا كان المنتج مكررًا
if (product.isDuplicate) {
productDiv.style.backgroundColor = '#c0c0f9'; // لون مغاير للمنتجات المكررة
}

productDiv.innerHTML = `
<p>Date: ${product.date}</p>
<p>Nom du produit: ${product.name}</p>
<p>Prix: ${product.price} DH</p>
<p>Nom du fournisseur: ${product.supplierName}</p>
<p>Adresse du fournisseur: ${product.supplierAddress}</p>
<p>Téléphone du fournisseur: ${product.supplierPhone}</p>
<p>Index du Produit: ${index}</p>
`;

productDiv.addEventListener('click', () => {
const allProductDivs = document.querySelectorAll('.product-item');
allProductDivs.forEach(div => div.style.backgroundColor = '');

document.getElementById('productName').value = product.name;
document.getElementById('productPrice').value = product.price;
document.getElementById('supplierName').value = product.supplierName;
document.getElementById('supplierAddress').value = product.supplierAddress;
document.getElementById('supplierPhone').value = product.supplierPhone;


saveProduct();
filterByPhoneNumber();
fetchAndDisplayData();
});

productListContainer.appendChild(productDiv);
index--;
});
}

// وظيفة لتصفية المنتجات بناءً على البحث والنص المدخل والرقم المحدد
function filterProducts() {

const searchInput = document.getElementById('searchInput').value.toLowerCase();
const phoneDropdown = document.getElementById('phoneDropdown');
const selectedPhoneNumber = phoneDropdown.value;

// إضافة مستمع للحدث change
phoneDropdown.addEventListener('change', function() {
// تحديد حقل البحث

const searchInputElement = document.getElementById('searchInput');
// تعيين القيمة إلى فارغة

searchInputElement.value = "";

});

if (searchInput) {
// تصفية المنتجات بناءً على النص
const filteredProducts = allProducts.filter(product =>
product.name.toLowerCase().includes(searchInput)
);
displayProducts(filteredProducts);
} else {
// عرض جميع المنتجات بناءً على الرقم المحدد
fetchAndDisplayData(selectedPhoneNumber);
}
}
// وظيفة لتصفية البيانات بناءً على الرقم الهاتفي المحدد
function filterByPhoneNumber() {
filterProducts(); // تحديث البيانات بناءً على الرقم الهاتفي المحدد
}

// عند تحميل الصفحة، قم بتعبئة القائمة المنسدلة وعرض البيانات
document.addEventListener('DOMContentLoaded', () => {
populateDropdown();
fetchAndDisplayData('all'); // عرض الكل عند تحميل الصفحة
});
// قم بتحميل البيانات عند بدء التشغيل

// قم بتحميل البيانات عند بدء التشغيل

savedProductsDisplay.style.display = 'block';
displaySavedProducts();
// تبديل النماذج بين إضافة منتج وإنشاء فاتورة
toggleButton.addEventListener('click', toggleForms);
toggleButton1.addEventListener('click', toggleForms1);

toggleButton3.addEventListener('click', toggleForms3);

function toggleForms() {
window.scrollTo({ top: 0, behavior: 'smooth' });
clientContainer.style.display = 'block';
productContainer.style.display = 'none';
savedProductsDisplay.style.display = 'block';
productListContainerdata.style.display = 'none';
searchInput.style.display = 'none';
document.getElementById('phoneDropdown').style.display = 'none';

document.getElementById('productName').value = '';
document.getElementById('productPrice').value = '';
}

function toggleForms1() {
fetchAndDisplayData();
searchInput.style.display = 'block';
clientContainer.style.display = 'none';
productContainer.style.display = 'block';
savedProductsDisplay.style.display = 'none';
productListContainerdata.style.display = 'block';
document.getElementById('phoneDropdown').style.display = 'block';
document.getElementById('phoneDropdown').selectedIndex = 0;
}


function toggleForms3() {
window.scrollTo({ top: 0, behavior: 'smooth' });
clientContainer.style.display = 'none';
productContainer.style.display = 'block';
savedProductsDisplay.style.display = 'block';
productListContainerdata.style.display = 'none';
searchInput.style.display = 'none';
document.getElementById('phoneDropdown').style.display = 'none';

}

// حفظ الفاتورة كملف PDF
document.getElementById('savePdfButton').addEventListener('click', function() {
// استدعاء دالة updateStock()
updateStock();

});
// طباعة الفاتورة
document.getElementById('printButton').addEventListener('click', function() {


this.style.display = 'none';
savePdfButton.style.display = 'none';
window.print();


setTimeout(() => {
savePdfButton.style.display = 'inline-block';
printButton.style.display = 'inline-block';
}, 5000); // تأخير 3 ثواني

});

</script>

</body>
</html>








