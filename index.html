<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" >
    <title>إدارة المبيعات والمخزون - تصميم عصري ونظيف</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --modern-bg-primary: #f8fafc;
            --modern-card-bg: #ffffff;
            --modern-primary-accent: #4f46e5;
            --modern-secondary-accent: #e0e7ff;
            --modern-text-dark: #1f2937;
            --modern-text-secondary: #6b7280;
            --modern-border-light: #e5e7eb;
            --modern-success: #22c55e;
            --modern-warning: #f59e0b;
            --modern-error: #ef4444;
            --modern-alert: #f59e0b;
            --modern-primary-accent-rgb: 79, 70, 229;
            --modern-success-rgb: 34, 197, 94;
            --modern-error-rgb: 239, 68, 68;
            --modern-bg-light-red: #fee2e2;
            --modern-bg-light-green: #dcfce7;
            --modern-bg-light-orange: #fffbe0;
            --modern-bg-light-blue: #e0e7ff;
        }

        html, body {
            height: 100%;
            min-height: 100vh;
        }

        body {
            font-family: 'Inter', 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
            background-color: var(--modern-bg-primary);
            color: var(--modern-text-dark);
            line-height: 1.6;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .app-container {
            max-width: 1300px;
            width: 90%;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--modern-card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            flex-grow: 1;
            position: relative;
        }

        .app-header {
            background-color: var(--modern-primary-accent);
            padding: 1.25rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: white;
            border-bottom-left-radius: 1.25rem;
            border-bottom-right-radius: 1.25rem;
            width: 100%;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header-brand {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        .header-brand .fas {
            font-size: 1.75rem;
            color: white;
        }

        .header-nav-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            justify-content: center;
            width: 100%;
            margin-top: 1rem;
        }

        @media (min-width: 768px) {
            .app-header>div {
                flex-direction: row;
                gap: 2rem;
            }

            .header-nav-group {
                margin-top: 0;
                width: auto;
            }
        }

        .modern-button {
            background-color: var(--modern-secondary-accent);
            border: 1px solid var(--modern-border-light);
            color: var(--modern-text-dark);
            font-weight: 500;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            justify-content: center;
            flex-grow: 1;
            max-width: 200px;
        }

        .modern-button:hover {
            background-color: var(--modern-border-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .modern-button:active {
            background-color: var(--modern-secondary-accent);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }

        .modern-button.active {
            background-color: var(--modern-primary-accent);
            border-color: var(--modern-primary-accent);
            color: white;
            box-shadow: 0 4px 10px rgba(var(--modern-primary-accent-rgb), 0.3);
        }

        .btn-primary-action {
            background-color: var(--modern-primary-accent);
            border-color: var(--modern-primary-accent);
            color: white;
            box-shadow: 0 6px 15px rgba(var(--modern-primary-accent-rgb), 0.3);
        }

        .btn-primary-action:hover {
            background-color: #4338ca;
            border-color: #4338ca;
        }

        .btn-success-action {
            background-color: var(--modern-success);
            border-color: var(--modern-success);
            color: white;
            box-shadow: 0 6px 15px rgba(var(--modern-success-rgb), 0.3);
        }

        .btn-success-action:hover {
            background-color: #16a34a;
            border-color: #16a34a;
        }

        .btn-warning-action {
            background-color: var(--modern-warning);
            border-color: var(--modern-warning);
            color: white;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning-action:hover {
            background-color: #d97706;
            border-color: #d97706;
        }

        .btn-danger-action {
            background-color: var(--modern-error);
            border-color: var(--modern-error);
            color: white;
            box-shadow: 0 6px 15px rgba(var(--modern-error-rgb), 0.3);
        }

        .btn-danger-action:hover {
            background-color: #dc2626;
            border-color: #dc2626;
        }

        .btn-secondary-action {
            background-color: #6b7280;
            border-color: #6b7280;
            color: white;
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary-action:hover {
            background-color: #4b5563;
            border-color: #4b5563;
        }

        .btn-icon {
            font-size: 1.1rem;
        }

        .section-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            border-bottom: 2px solid var(--modern-border-light);
            padding-bottom: 1rem;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .section-title {
                justify-content: flex-start;
            }
        }

        .section-title .fas {
            font-size: 1.8rem;
            color: var(--modern-primary-accent);
        }

        .card-panel {
            background-color: var(--modern-card-bg);
            padding: 1.8rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            border: 1px solid var(--modern-border-light);
        }

        .kpi-card {
            border-right: 4px solid var(--modern-primary-accent);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-panel-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--modern-text-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            border-bottom: 1px solid var(--modern-border-light);
            padding-bottom: 1rem;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .card-panel-title {
                justify-content: flex-start;
            }
        }

        .card-panel-title .fas {
            font-size: 1.4rem;
            color: var(--modern-primary-accent);
        }

        .kpi-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background-color: var(--modern-card-bg);
            border: 1px solid var(--modern-border-light);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .kpi-card-title {
            font-size: 1rem;
            color: var(--modern-text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            color: var(--modern-text-dark);
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.6rem;
        }

        .form-label.required::after {
            content: '*';
            color: var(--modern-error);
            margin-right: 0.25rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            border: 1px solid var(--modern-border-light);
            border-radius: 0.5rem;
            padding: 0.8rem 1.2rem;
            width: 100%;
            font-size: 1rem;
            color: var(--modern-text-dark);
            background-color: var(--modern-card-bg);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--modern-primary-accent);
            box-shadow: 0 0 0 3px rgba(var(--modern-primary-accent-rgb), 0.2);
        }

        .form-input.error,
        .form-textarea.error {
            border-color: var(--modern-error);
        }

        .validation-message {
            color: var(--modern-error);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
            align-items: center;
            gap: 0.25rem;
        }

        .validation-message .fas {
            font-size: 0.9rem;
        }

        .action-buttons-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            margin-top: 2rem;
            justify-content: center;
            width: 100%;
        }

        .action-buttons-group .modern-button {
            flex-grow: 1;
            max-width: 300px;
        }

        .btn-base {
            padding: 0.9rem 1.8rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            justify-content: center;
            border: none;
            font-size: 1rem;
            color: white;
        }

        .loader-inline {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 1.2rem;
            height: 1.2rem;
            animation: spin 1s linear infinite;
            display: none;
            margin-right: 0.6rem;
        }

        .loader-inline.active {
            display: inline-block;
        }

        .btn-base.loading {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .full-loader {
            border: 5px solid var(--modern-border-light);
            border-top: 5px solid var(--modern-primary-accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
            display: none;
        }

        .full-loader.active {
            display: block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 350px;
            align-items: center;
            pointer-events: none;
        }

        .toast-message {
            padding: 1rem 1.2rem;
            border-radius: 0.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 1rem;
            color: white;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
        }

        .toast-message.active {
            opacity: 1;
            transform: scale(1);
        }

        .toast-message.success {
            background-color: var(--modern-success);
        }

        .toast-message.error {
            background-color: var(--modern-error);
        }

        .toast-message.info {
            background-color: var(--modern-primary-accent);
        }

        .toast-message.warning {
            background-color: var(--modern-warning);
        }

        .toast-message .fas {
            font-size: 1.2rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modern-card-bg);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: translateY(-30px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--modern-primary-accent);
            margin-bottom: 1.2rem;
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--modern-text-secondary);
            margin-bottom: 2rem;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1.2rem;
        }

        .view-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            padding: 1.5rem;
            box-sizing: border-box;
            display: none;
            width: 100%;
        }

        .view-section.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        .dashboard-layout-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.8rem;
        }

        .product-cards-grid,
        .archive-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.8rem;
        }

        .product-card-item,
        .mini-invoice-card {
            background-color: var(--modern-card-bg);
            border: 1px solid var(--modern-border-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .product-card-item:hover,
        .mini-invoice-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .product-card-item.status-insufficient {
            background-color: var(--modern-bg-light-red);
            border-color: var(--modern-error);
        }

        .product-card-item.status-selected-sufficient {
            background-color: var(--modern-bg-light-green);
            border-color: var(--modern-success);
        }

        .product-card-item.status-low-stock {
            background-color: var(--modern-bg-light-orange);
            border-color: var(--modern-alert);
        }

        .product-card-item.status-stock-positive {
            background-color: var(--modern-bg-light-blue);
            border-color: var(--modern-primary-accent);
        }

        .mini-invoice-card.status-received-full {
            background-color: var(--modern-bg-light-green);
            border-color: var(--modern-success);
        }

        .mini-invoice-card.status-received-partial {
            background-color: var(--modern-bg-light-orange);
            border-color: var(--modern-warning);
        }

        .mini-invoice-card.status-pending {
            background-color: var(--modern-bg-light-blue);
            border-color: var(--modern-primary-accent);
        }

        .product-info p,
        .supplier-info p {
            margin: 0.3rem 0;
            color: var(--modern-text-secondary);
            font-size: 0.98rem;
        }

        .product-info p:first-child {
            font-weight: 700;
            color: var(--modern-text-dark);
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .product-info p strong {
            font-weight: 600;
            color: var(--modern-primary-accent);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 0.6rem;
        }

        .quantity-controls input[type="number"] {
            width: 80px;
            text-align: center;
            padding: 0.6rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: var(--modern-card-bg);
        }

        .qty-adjust-btn {
            background-color: var(--modern-secondary-accent);
            border: 1px solid var(--modern-border-light);
            color: var(--modern-text-dark);
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            padding: 0.6rem;
            flex-grow: 1;
        }

        .qty-adjust-btn:hover {
            background-color: var(--modern-border-light);
        }

        .product-actions-footer,
        .mini-invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 1.5rem;
            justify-content: center;
            width: 100%;
        }

        .product-actions-footer .btn-base,
        .mini-invoice-actions .btn-base {
            padding: 0.6rem 1.2rem;
            font-size: 0.95rem;
            flex-grow: 1;
            max-width: 150px;
        }

        .empty-state-message {
            text-align: center;
            color: var(--modern-text-secondary);
            font-style: italic;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.2rem;
            width: 100%;
        }

        .empty-state-message .fas {
            font-size: 3.5rem;
            color: var(--modern-border-light);
        }

        .search-bar-container {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.8rem;
            position: relative;
        }

        .search-input {
            flex-grow: 1;
            background-color: var(--modern-card-bg);
            padding-right: 2.5rem;
        }

        .clear-search-button {
            background-color: var(--modern-border-light);
            color: var(--modern-text-secondary);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: absolute;
            right: 10px;
            transform: translateY(-50%);
            border: none;
            top: 50%;
        }

        .clear-search-button:hover {
            background-color: #D1D5DB;
        }

        .invoice-details-panel {
            margin-bottom: 2.5rem;
        }

        .invoice-summary-info p {
            margin-bottom: 0.6rem;
            font-size: 1.05rem;
            color: var(--modern-text-dark);
        }

        .invoice-summary-info p strong {
            color: var(--modern-primary-accent);
        }

        .responsive-table-wrapper {
            overflow-x: auto;
            margin-top: 1.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--modern-border-light);
            box-shadow: inset -5px 0 6px -6px rgba(0, 0, 0, 0.1), inset 5px 0 6px -6px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .responsive-table-wrapper {
                box-shadow: none;
            }
        }

        .invoice-table,
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
            min-width: 600px;
        }

        .invoice-table th,
        .summary-table th,
        .invoice-table td,
        .summary-table td {
            padding: 0.9rem 1.2rem;
            border: 1px solid var(--modern-border-light);
            color: var(--modern-text-dark);
        }

        .invoice-table thead th,
        .summary-table thead th {
            background-color: var(--modern-secondary-accent);
            font-weight: 600;
            color: var(--modern-primary-accent);
        }

        .invoice-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .summary-table tfoot tr td {
            font-weight: 500;
        }

        .summary-table .total-row td {
            background-color: var(--modern-secondary-accent);
            font-weight: 700;
            color: var(--modern-primary-accent);
            font-size: 1.15rem;
        }

        .summary-table .profit-row {
            display: table-row;
        }

        .mini-invoice-header p {
            margin: 0.25rem 0;
            font-size: 0.95rem;
            color: var(--modern-text-dark);
        }

        .mini-invoice-header p strong {
            color: var(--modern-primary-accent);
        }

        .mini-product-list {
            border-top: 1px dashed var(--modern-border-light);
            padding-top: 0.8rem;
            margin-top: 0.8rem;
        }

        .mini-product-item-header,
        .mini-product-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr;
            gap: 0.6rem;
            font-size: 0.9rem;
            padding: 0.3rem 0;
        }

        .mini-po-product-item-header,
        .mini-po-product-item-row {
            grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr; /* Changed for PO to show more columns */
        }

        .mini-product-item-header {
            font-weight: 600;
            color: var(--modern-text-dark);
            border-bottom: 1px solid var(--modern-border-light);
            margin-bottom: 0.6rem;
            padding-bottom: 0.6rem;
        }

        .mini-product-item-row {
            color: var(--modern-text-secondary);
        }

        .mini-invoice-footer {
            border-top: 1px dashed var(--modern-border-light);
            padding-top: 0.8rem;
            margin-top: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            font-size: 1rem;
        }

        .mini-invoice-footer p strong {
            color: var(--modern-text-dark);
        }

        .custom-scrollbar {
            max-height: 300px;
            overflow-y: auto;
            padding-bottom: 10px;
            padding-left: 10px;
            padding-right: 0;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--modern-bg-primary);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--modern-border-light);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--modern-secondary-accent);
        }

        /* --- Print Specific Styles (Improvements) --- */
        @media print {
            body * {
                visibility: hidden;
            }

            #printInvoiceTemplate, #printInvoiceTemplate *,
            #printPoTemplate, #printPoTemplate * {
                visibility: visible;
                background-color: white !important;
                color: black !important;
                box-shadow: none !important;
                border: none !important;
            }

            #printInvoiceTemplate, #printPoTemplate {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 0;
                margin: 0;
                box-sizing: border-box;
                overflow: visible;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                font-size: 12px; /* Base font size for print */
                line-height: 1.5;
                color: #333;
            }

            .app-header, main.app-container, #toast-container,
            .modal-overlay, datalist, script, .action-buttons-group {
                display: none !important;
            }

            @page {
                size: A4;
                margin: 15mm;
            }

            #printInvoiceTemplate > div:first-child,
            #printPoTemplate > div:first-child {
                padding: 15mm;
            }

            /* Centered Header for Invoice and PO */
            #printInvoiceTemplate .document-header,
            #printPoTemplate .document-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #eee;
                padding-bottom: 15px;
            }

            #printInvoiceTemplate .document-header h1,
            #printPoTemplate .document-header h1 {
                font-size: 36px !important;
                font-weight: bold;
                color: #4f46e5 !important;
                margin: 0 0 10px 0;
                text-align: center !important; /* Ensure center alignment */
            }

            #printInvoiceTemplate .document-header .info-grid,
            #printPoTemplate .document-header .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Two columns for owner/customer or owner/supplier */
                gap: 15px;
                margin-top: 20px;
                text-align: right; /* Default text align right for RTL */
            }
            
            #printInvoiceTemplate .document-header .info-block,
            #printPoTemplate .document-header .info-block {
                padding: 10px;
                border: 1px solid #eee;
                border-radius: 8px;
                background-color: #f9f9f9 !important;
            }

            #printInvoiceTemplate .document-header .info-block h3,
            #printPoTemplate .document-header .info-block h3 {
                font-size: 16px !important;
                color: #4f46e5 !important;
                margin-top: 0;
                margin-bottom: 10px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
                text-align: right;
            }

            #printInvoiceTemplate .document-header .info-block p,
            #printPoTemplate .document-header .info-block p {
                margin: 5px 0;
                font-size: 12px;
                color: #333 !important;
            }
            #printInvoiceTemplate .document-header .info-block strong,
            #printPoTemplate .document-header .info-block strong {
                color: #1f2937 !important;
            }

            /* Main Content Tables */
            #printInvoiceTemplate .details-section,
            #printPoTemplate .details-section {
                margin-top: 30px;
            }

            #printInvoiceTemplate .details-section h3,
            #printPoTemplate .details-section h3 {
                font-size: 18px !important;
                color: #4f46e5 !important;
                margin-top: 25px;
                margin-bottom: 10px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
            }

            #printInvoiceTemplate table,
            #printPoTemplate table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }

            #printInvoiceTemplate th, #printInvoiceTemplate td,
            #printPoTemplate th, #printPoTemplate td {
                border: 1px solid #ddd;
                padding: 8px 12px;
                text-align: right;
                font-size: 11px;
                color: black !important;
            }

            #printInvoiceTemplate thead th,
            #printPoTemplate thead th {
                background-color: #f2f2f2 !important;
                font-weight: bold;
                color: #4f46e5 !important;
            }
            #printInvoiceTemplate tbody tr:nth-child(even) {
                background-color: #f9f9f9 !important;
            }

            /* Combined Summary for Invoice */
            #printInvoiceTemplate .combined-summary-table {
                margin-top: 20px; /* Space from products table */
                width: 100%; /* Take full width of content area */
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden; /* Ensures border-radius applies */
                background-color: #f9f9f9 !important; /* Light background for summary */
            }

            #printInvoiceTemplate .combined-summary-table td {
                border: none; /* Remove internal borders */
                padding: 8px 12px;
                font-size: 12px;
                color: #333 !important;
            }

            #printInvoiceTemplate .combined-summary-table .summary-title-row td {
                font-weight: bold;
                color: #4f46e5 !important;
                background-color: #e0e7ff !important;
                font-size: 14px !important;
                padding-bottom: 10px !important;
                border-bottom: 1px solid #ddd !important; /* Separator for title */
            }

            #printInvoiceTemplate .combined-summary-table .total-row-print td {
                background-color: #e0e7ff !important;
                font-weight: bold !important;
                color: #4f46e5 !important;
                font-size: 14px !important;
                padding: 8px 12px !important;
            }

            /* Profit row and PO total hidden */
            #printInvoiceTemplate .profit-row-print,
            #printPoTemplate .po-summary-table { /* Full PO summary table hidden */
                display: none !important;
            }

            /* PO specific column hiding */
            #printPoTemplate table thead th.po-purchase-price-col,
            #printPoTemplate table thead th.po-total-col,
            #printPoTemplate table tbody td.po-purchase-price-col,
            #printPoTemplate table tbody td.po-total-col {
                display: none !important;
            }

            /* Footer Section */
            #printInvoiceTemplate .print-footer-container,
            #printPoTemplate .print-footer-container {
                clear: both;
                margin-top: 50px;
                border-top: 1px dashed #ccc;
                padding-top: 20px;
                text-align: center;
            }
            #printInvoiceTemplate .print-footer-container p,
            #printPoTemplate .print-footer-container p {
                font-size: 11px;
                color: #555 !important;
                margin-bottom: 5px;
            }

            /* Signature Section */
            #printInvoiceTemplate .signature-section,
            #printPoTemplate .signature-section {
                margin-top: 60px;
                display: flex;
                justify-content: space-around;
                font-size: 12px;
                text-align: center;
            }
            #printInvoiceTemplate .signature-box,
            #printPoTemplate .signature-box {
                border-top: 1px solid #000;
                padding-top: 5px;
                width: 40%;
                color: #333;
            }
        }
    </style>
</head>
<body class="bg-background-light text-text-dark">
    <header class="app-header">
        <div class="max-w-7xl mx-auto w-full flex flex-col md:flex-row justify-between items-center flex-wrap gap-5 px-6">
            <div class="flex-shrink-0">
                <div class="header-brand"><i class="fas fa-store"></i> نظام المخزون والمبيعات </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 md:gap-6 items-center w-full">
                <div class="header-nav-group">
                    <button type="button" class="modern-button active" id="showDashboardButton">
                        <i class="fas fa-home"></i> الرئيسية
                    </button>
                    <button type="button" class="modern-button" id="showPurchaseOrderSectionButton">
                        <i class="fas fa-file-invoice-dollar"></i> أوامر الشراء
                    </button>
                    <button type="button" class="modern-button" id="showLocalArchiveButton">
                        <i class="fas fa-archive"></i> أرشيف الفواتير
                    </button>
                </div>
            </div>
        </div>
    </header>
    <div id="toast-container"></div>
    <main class="app-container">
        <section id="mainDashboardView" class="view-section active">
            <h1 class="section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم الرئيسية</h1>
            <div class="dashboard-layout-grid">
                <div class="card-panel" id="productFormContainer">
                    <h2 class="card-panel-title" id="productFormTitle">
                        <i class="fas fa-box"></i> إدارة المنتجات
                    </h2>
                    <form id="productForm">
                        <div class="form-group">
                            <label for="productName" class="form-label required">اسم المنتج:</label>
                            <input type="text" id="productName" required placeholder="أدخل اسم المنتج" autocomplete="on"
                                class="form-input" list="productNames">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice" class="form-label required">سعر الشراء (درهم):</label>
                            <input type="number" id="purchasePrice" required placeholder="أدخل سعر الشراء" autocomplete="on"
                                class="form-input" min="0" step="0.01">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="sellingPrice" class="form-label required">سعر البيع (درهم):</label>
                            <input type="number" id="sellingPrice" required placeholder="أدخل سعر البيع" autocomplete="on"
                                class="form-input" min="0" step="0.01">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="unitOfMeasure" class="form-label">وحدة القياس:</label>
                            <input type="text" id="unitOfMeasure" placeholder="مثال: قطعة، كيلوغرام" class="form-input" list="unitsOfMeasure">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierName" class="form-label required">اسم المورد:</label>
                            <input type="text" id="supplierName" required placeholder="أدخل اسم المورد"
                                autocomplete="on" class="form-input" list="supplierNames">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierAddress" class="form-label required">عنوان المورد:</label>
                            <input type="text" id="supplierAddress" required
                                placeholder="أدخل عنوان المورد" autocomplete="on"
                                class="form-input" list="supplierAddresses">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierPhone" class="form-label required">هاتف المورد:</label>
                            <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel"
                                pattern="^0[0-9]{9}$" inputmode="numeric" class="form-input" list="supplierPhones">
                            <span class="validation-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="productQuantity" class="form-label">الكمية الأولية في المخزون:</label>
                            <input type="number" id="productQuantity" placeholder="الكمية" value="0" min="0" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="minStockQuantity" class="form-label">الحد الأدنى للمخزون (للتنبيه):</label>
                            <input type="number" id="minStockQuantity" placeholder="الحد الأدنى للمخزون" value="0" min="0" class="form-input">
                            <span class="validation-message"></span>
                        </div>
                        <div class="action-buttons-group">
                            <button type="submit" class="modern-button btn-primary-action" id="addProduct">
                                <i class="fas fa-plus-circle btn-icon"></i> إضافة منتج
                                <span class="loader-inline"></span>
                            </button>
                            <button type="submit" class="modern-button btn-warning-action" id="saveEditProduct" style="display: none;">
                                <i class="fas fa-edit btn-icon"></i> تعديل المنتج
                                <span class="loader-inline"></span>
                            </button>
                            <button type="button" class="modern-button btn-secondary-action" id="cancelEditProduct" style="display: none;">
                                <i class="fas fa-times-circle btn-icon"></i> إلغاء التعديل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="dataManagementButtons" class="flex flex-col md:flex-row gap-4 md:gap-6 items-center justify-center mt-8 p-4 bg-modern-card-bg rounded-xl shadow-md border border-modern-border-light">
                <button type="button" class="modern-button" id="exportDataBtn">
                    <i class="fas fa-download"></i> تصدير (JSON)
                </button>
                <input type="file" id="importDataInput" accept=".json" class="hidden">
                <button type="button" class="modern-button" id="importDataBtn">
                    <i class="fas fa-upload"></i> استيراد (JSON)
                </button>
            </div>
            <div class="card-panel mt-8" id="savedProductsDisplay">
                <h2 class="card-panel-title">
                    <i class="fas fa-shopping-cart"></i> المنتجات المحفوظة (المخزون)
                </h2>
                <p class="text-modern-text-dark text-lg mb-4 text-center" id="selectedProductCountContainer">المنتجات المحفوظة: <strong id="selectedProductCount">0</strong></p>
                <div class="search-bar-container">
                    <input type="text" id="searchProduct" class="form-input search-input" placeholder="البحث عن منتج...">
                    <button class="clear-search-button" id="clearSearchProductBtn" hidden>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="product-cards-grid" id="savedProductsList">
                    <p class="empty-state-message" id="emptyProductsMessage">
                        <i class="fas fa-box-open"></i>
                        لا توجد منتجات محفوظة لعرضها. أضف منتجك الأول من النموذج أعلاه.
                        <button type="button" class="modern-button btn-primary-action mt-6" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
                            <i class="fas fa-plus-circle btn-icon"></i> إضافة منتج جديد
                        </button>
                    </p>
                </div>
                <div class="full-loader" id="savedProductsLoader"></div>
            </div>
        </section>
        <article id="invoiceDisplay" class="view-section invoice-display-section" hidden>
            <h1 class="section-title"><i class="fas fa-receipt"></i> الفاتورة</h1>
            <div class="invoice-details-panel card-panel">
                <div class="invoice-summary-info">
                    <h2 class="card-panel-title"> <i class="fas fa-user"></i> تفاصيل الفاتورة </h2>
                    <p><strong>رقم الفاتورة:</strong> <span id="displayInvoiceNumber"></span></p>
                    <p><strong>العميل:</strong> <span id="displayCustomerName"></span></p>
                    <p><strong>التاريخ:</strong> <time datetime="" id="displayInvoiceDate"></time></p>
                    <p><strong>اسم الشركة:</strong> <span id="displayCompanyName"></span></p>
                    <p><strong>المالك:</strong> <span id="displayInvoiceOwner"></span></p>
                    <p><strong>عنوان المالك:</strong> <span id="displayInvoiceOwnerAddress"></span></p>
                    <p><strong>هاتف المالك:</strong> <span id="displayInvoiceOwnerPhone"></span></p>
                </div>
                <div class="responsive-table-wrapper">
                    <table class="invoice-table" id="invoiceDetails">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>سعر الوحدة</th>
                                <th>الكمية</th>
                                <th>المجموع (قبل الضريبة)</th>
                            </tr>
                        </thead>
                        <tbody id="displayDetails"></tbody>
                    </table>
                </div>
                <div class="invoice-summary-panel card-panel mt-6">
                    <h2 class="card-panel-title">
                        <i class="fas fa-chart-line"></i> ملخص الفاتورة
                    </h2>
                    <table class="summary-table">
                        <tfoot>
                            <tr>
                                <td><strong>المجموع قبل العمولة (قبل الضريبة):</strong></td>
                                <td id="displayTotalAmountBeforeCommission"></td>
                            </tr>
                            <tr>
                                <td><strong>العمولة المخصومة:</strong></td>
                                <td id="displayCommissionDeducted"></td>
                            </tr>
                            <tr>
                                <td><strong>المبلغ الإجمالي (قبل الضريبة):</strong></td>
                                <td id="displayTotalAmount"></td>
                            </tr>
                            <tr>
                                <td><strong>الضريبة (TVA):</strong></td>
                                <td id="displayTVA"></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>المبلغ الإجمالي (شامل الضريبة):</strong></td>
                                <td id="displayTotalTTC"></td>
                            </tr>
                            <tr class="profit-row">
                                <td><strong>الربح الصافي:</strong></td>
                                <td id="displayTotalProfit"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="action-buttons-group invoice-actions-footer">
                    <button type="button" class="modern-button btn-primary-action" id="updateStockAndSaveInvoiceButton">
                        <i class="fas fa-cloud-upload-alt btn-icon"></i> تحديث المخزون وحفظ الفاتورة
                        <span class="loader-inline"></span>
                    </button>
                    <button type="button" class="modern-button btn-secondary-action" id="printButton">
                        <i class="fas fa-print btn-icon"></i> طباعة الفاتورة
                    </button>
                    <button type="button" class="modern-button btn-danger-action" id="cancelInvoiceButton">
                        <i class="fas fa-times-circle btn-icon"></i> إلغاء الفاتورة
                    </button>
                </div>
            </div>
        </article>
        <section id="purchaseOrderSection" class="view-section" hidden>
            <h1 class="section-title"><i class="fas fa-file-invoice-dollar"></i> أوامر الشراء</h1>
            <div id="poFormContainerWrapper" class="card-panel">
                <h2 class="card-panel-title">
                    <i class="fas fa-plus-circle"></i> إنشاء أمر شراء جديد
                </h2>
                <form id="purchaseOrderForm">
                    <div class="form-group">
                        <label for="purchaseOrderDate" class="form-label required">تاريخ الأمر:</label>
                        <input type="text" id="purchaseOrderDate" required placeholder="تاريخ أمر الشراء" readonly class="form-input">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poCompanyName" class="form-label">اسم الشركة الطالبة:</label>
                        <input type="text" id="poCompanyName" placeholder="أدخل اسم الشركة (اختياري)" autocomplete="on"
                            class="form-input" list="companyNames">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poOwnerName" class="form-label required">اسم مالك الأمر:</label>
                        <input type="text" id="poOwnerName" required placeholder="أدخل اسم مالك الأمر" autocomplete="on"
                            class="form-input" list="invoiceOwners">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poOwnerPhone" class="form-label required">هاتف مالك الأمر:</label>
                        <input type="tel" id="poOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="tel"
                            pattern="^0[0-9]{9}$" inputmode="numeric" class="form-input" list="invoiceOwnerPhones">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poCompanyAddress" class="form-label">عنوان الشركة الطالبة:</label>
                        <input type="text" id="poCompanyAddress" placeholder="أدخل عنوان الشركة (اختياري)" autocomplete="on"
                            class="form-input" list="invoiceOwnerAddresses">
                        <span class="validation-message"></span>
                    </div>
                    <hr class="my-6 border-modern-border-light"> <h3 class="card-panel-title" style="border-bottom: none; padding-bottom: 0;">
                        <i class="fas fa-truck"></i> تفاصيل المورد
                    </h3>
                    <div class="form-group">
                        <label for="poSupplierName" class="form-label required">اسم المورد:</label>
                        <input type="text" id="poSupplierName" required placeholder="أدخل اسم المورد" autocomplete="on"
                            class="form-input" list="supplierNames">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poSupplierPhone" class="form-label required">هاتف المورد:</label>
                        <input type="tel" id="poSupplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel"
                            pattern="^0[0-9]{9}$" inputmode="numeric" class="form-input" list="supplierPhones">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="poSupplierAddress" class="form-label">عنوان المورد:</label>
                        <input type="text" id="poSupplierAddress" placeholder="أدخل عنوان المورد (اختياري)" autocomplete="on"
                            class="form-input" list="supplierAddresses">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="purchaseOrderDeliveryDate" class="form-label">تاريخ التسليم المتوقع:</label>
                        <input type="date" id="purchaseOrderDeliveryDate" class="form-input">
                        <span class="validation-message"></span>
                    </div>
                    <div class="action-buttons-group">
                        <button type="submit" class="modern-button btn-primary-action" id="createPurchaseOrder">
                            <i class="fas fa-plus-circle btn-icon"></i> إنشاء أمر شراء
                            <span class="loader-inline"></span>
                        </button>
                    </div>
                </form>
            </div>
            <div id="purchaseOrderDisplay" class="card-panel mt-8" style="display:none;">
                <h2 class="card-panel-title">
                    <i class="fas fa-receipt"></i> تفاصيل أمر الشراء
                </h2>
                <div class="invoice-summary-info">
                    <p><strong>رقم الأمر:</strong> <span id="displayPoId"></span></p>
                    <p><strong>تاريخ الأمر:</strong> <span id="displayPoDate"></span></p>
                    <p><strong>اسم الشركة الطالبة:</strong> <span id="displayPoCompanyName"></span></p>
                    <p><strong>صاحب الأمر:</strong> <span id="displayPoOwnerName"></span></p>
                    <p><strong>رقم صاحب الأمر:</strong> <span id="displayPoOwnerPhone"></span></p>
                    <p><strong>تاريخ التسليم المتوقع:</strong> <span id="displayPoDeliveryDate"></span></p>
                    <p><strong>عنوان الشركة الطالبة:</strong> <span id="displayPoCompanyAddress"></span></p>
                </div>
                <div class="responsive-table-wrapper">
                    <table class="invoice-table" id="poDetailsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th class="po-product-name-col">المنتج</th>
                                <th class="po-purchase-price-col">سعر الشراء</th>
                                <th class="po-ordered-qty-col">الكمية المطلوبة</th>
                                <th class="po-received-qty-col">الكمية المستلمة</th>
                                <th class="po-total-col">المجموع</th>
                            </tr>
                        </thead>
                        <tbody id="displayPoProducts">
                        </tbody>
                    </table>
                </div>
                <div class="invoice-summary-panel card-panel mt-6">
                    <h2 class="card-panel-title">
                        <i class="fas fa-chart-line"></i> ملخص أمر الشراء
                    </h2>
                    <table class="summary-table">
                        <tfoot>
                            <tr>
                                <td><strong>المبلغ الإجمالي لأمر الشراء:</strong></td>
                                <td id="displayPoTotalAmount"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="action-buttons-group">
                    <button type="button" class="modern-button btn-success-action" id="receivePoFromDetailsBtn">
                        <i class="fas fa-box-open btn-icon"></i> استلام المخزون
                    </button>
                    <button type="button" class="modern-button btn-secondary-action" id="printPoBtn">
                        <i class="fas fa-print btn-icon"></i> طباعة أمر الشراء
                    </button>
                    <button type="button" class="modern-button btn-danger-action" id="cancelPoBtn">
                        <i class="fas fa-times-circle btn-icon"></i> إلغاء الأمر
                    </button>
                </div>
            </div>
            <div id="localPurchaseOrdersArchive" class="card-panel mt-8">
                <h2 class="section-title">
                    <i class="fas fa-folder-open"></i> أرشيف أوامر الشراء المحلية
                </h2>
                <div class="search-bar-container">
                    <input type="text" id="searchLocalPo" class="form-input search-input"
                        placeholder="البحث في أوامر الشراء المحلية (المورد، التاريخ، المنتج)...">
                    <button class="clear-search-button" id="clearSearchLocalPoBtn" hidden>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="archive-cards-grid" id="localPoList">
                    <p class="empty-state-message" id="emptyPoMessage">
                        <i class="fas fa-file-invoice"></i>
                        لا توجد أوامر شراء محفوظة محلياً.
                    </p>
                </div>
                <div class="full-loader" id="localPoLoader"></div>
            </div>
        </section>
        <section id="localArchiveView" class="view-section local-archive-section" hidden>
            
            
            <h1 class="section-title"><i class="fas fa-folder-open"></i> أرشيف الفواتير المحلية</h1>
            
            <section id="local-sales-stats" class="card-panel mt-8 mb-8">
                <h2 class="card-panel-title">
                    <i class="fas fa-chart-bar"></i> إحصائيات المبيعات المحلية
                </h2>
                <div class="kpi-card-grid">
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-shopping-basket ml-2"></i>إجمالي ثمن الشراء (للمباع)</h3>
                        <p id="localTotalPurchaseCost" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-hand-holding-usd ml-2"></i>إجمالي الأرباح</h3>
                        <p id="localTotalProfit" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-money-check-alt ml-2"></i>إجمالي ثمن البيع (للمباع)</h3>
                        <p id="localTotalSellingPrice" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-percent ml-2"></i>إجمالي العمولة</h3>
                        <p id="localTotalCommission" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-handshake ml-2"></i>إجمالي المبيعات (HT) بعد العمولة</h3>
                        <p id="localTotalSalesHTAfterCommission" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-calculator ml-2"></i>إجمالي الضريبة (TVA)</h3>
                        <p id="localTotalTVA" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-money-bill-wave ml-2"></i>إجمالي المبيعات (TTC)</h3>
                        <p id="localTotalSalesTTC" class="kpi-value">0.00 DH</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-receipt ml-2"></i>عدد الفواتير</h3>
                        <p id="localInvoiceCount" class="kpi-value">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-card-title"><i class="fas fa-box-open ml-2"></i>إجمالي المنتجات المباعة</h3>
                        <p id="localTotalProductsSold" class="kpi-value">0</p>
                    </div>
                </div>
            </section>
            
            <div class="card-panel" id="clientFormContainer">
                <h2 class="card-panel-title">
                    <i class="fas fa-file-invoice"></i> إنشاء فاتورة جديدة
                </h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="form-label required">تاريخ الفاتورة:</label>
                        <input type="text" id="invoiceDate" required placeholder="تاريخ الفاتورة" readonly class="form-input">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="form-label required">اسم العميل:</label>
                        <input type="text" id="customerName" required placeholder="أدخل اسم العميل" autocomplete="on"
                            class="form-input" list="customerNames">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="companyName" class="form-label">اسم الشركة:</label>
                        <input type="text" id="companyName" placeholder="أدخل اسم الشركة (اختياري)" autocomplete="on"
                            class="form-input" list="companyNames">
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="form-label required">اسم مالك الفاتورة:</label>
                        <input type="text" id="invoiceOwner" required placeholder="أدخل اسم مالك الفاتورة"
                            autocomplete="on" class="form-input" list="invoiceOwners">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="form-label required">عنوان مالك الفاتورة:</label>
                        <input type="text" id="invoiceOwnerAddress" required
                            placeholder="أدخل عنوان مالك الفاتورة" autocomplete="on"
                            class="form-input" list="invoiceOwnerAddresses">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="form-label required">هاتف مالك الفاتورة:</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678"
                            autocomplete="tel" pattern="^0[0-9]{9}$" inputmode="numeric" class="form-input" list="invoiceOwnerPhones">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="tva" class="form-label">الضريبة المضافة (TVA %):</label>
                        <input type="number" id="tva" required placeholder="أدخل نسبة الضريبة" value="0" min="0" max="100" class="form-input">
                        <span class="validation-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionAmount" class="form-label">مبلغ العمولة (درهم):</label>
                        <input type="number" id="invoiceCommissionAmount" placeholder="مثال: 100" value="0" min="0"
                            step="0.01" class="form-input">
                        <span class="validation-message"></span>
                    </div>
                    <div class="action-buttons-group">
                        <button type="button" class="modern-button btn-success-action" id="createInvoiceButton">
                            <i class="fas fa-check-circle btn-icon"></i> إنشاء الفاتورة وعرضها
                            <span class="loader-inline"></span>
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="card-panel archive-list-panel">
                <h2 class="card-panel-title">
                    <i class="fas fa-file-invoice"></i> الفواتير المحفوظة محلياً
                </h2>
                <div class="search-bar-container">
                    <input type="text" id="searchLocalInvoice" class="form-input search-input"
                        placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتج)..."
                        list="localInvoiceSearchOptions">
                    <button class="clear-search-button" id="clearSearchLocalInvoiceBtn" hidden>
                        <i class="fas fa-times"></i>
                    </button>
                    <datalist id="localInvoiceSearchOptions"></datalist>
                </div>
                <div class="archive-cards-grid" id="localInvoicesList">
                    <p class="empty-state-message" id="emptyInvoicesMessage">
                        <i class="fas fa-folder-open"></i>
                        لا توجد فواتير محفوظة محلياً.
                    </p>
                </div>
                <div class="full-loader" id="localArchiveLoader"></div>
            </div>
        </section>
    </main>
    <div id="confirm-modal-overlay" class="modal-overlay" hidden>
        <div id="confirm-modal-content" class="modal-content">
            <h3 id="confirm-modal-title" class="modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message" class="modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons" class="modal-actions">
                <button type="button" class="modern-button btn-success-action" id="confirm-yes-btn">نعم</button>
                <button type="button" class="modern-button btn-danger-action" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>
    <div id="receipt-modal-overlay" class="modal-overlay" hidden>
        <div id="receipt-modal-content" class="modal-content">
            <h3 id="receipt-modal-title" class="modal-title"><i class="fas fa-truck-loading"></i> استلام مخزون لأمر الشراء</h3>
            <div class="invoice-summary-info text-right mb-4">
                <p><strong>رقم أمر الشراء:</strong> <span id="receiptPoNumber"></span></p>
                <p><strong>المورد:</strong> <span id="receiptPoSupplierName"></span></p>
                <p><strong>تاريخ الطلب:</strong> <span id="receiptPoDate"></span></p>
                <p><strong>تاريخ التسليم المتوقع:</strong> <span id="receiptPoDeliveryDate"></span></p>
            </div>
            <div class="responsive-table-wrapper mb-4 custom-scrollbar" style="max-height: 400px;">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية المطلوبة</th>
                            <th>الكمية المستلمة</th>
                            <th>سعر الشراء</th>
                        </tr>
                    </thead>
                    <tbody id="receiptProductsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button type="button" class="modern-button btn-success-action" id="confirmReceiveGoodsBtn">
                    <i class="fas fa-check-circle btn-icon"></i> تأكيد الاستلام وتحديث المخزون
                    <span class="loader-inline"></span>
                </button>
                <button type="button" class="modern-button btn-danger-action" id="cancelReceiveGoodsBtn">
                    <i class="fas fa-times-circle btn-icon"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    <datalist id="productNames"></datalist>
    <datalist id="unitsOfMeasure"></datalist>
    <datalist id="supplierNames"></datalist>
    <datalist id="supplierAddresses"></datalist>
    <datalist id="supplierPhones"></datalist>
    <datalist id="customerNames"></datalist>
    <datalist id="companyNames"></datalist>
    <datalist id="invoiceOwners"></datalist>
    <datalist id="invoiceOwnerAddresses"></datalist>
    <datalist id="invoiceOwnerPhones"></datalist>
    
    <div id="printInvoiceTemplate" style="display: none; direction: rtl; font-family: 'Cairo', sans-serif; font-size: 12px; line-height: 1.5; color: #333;">
        <div style="padding: 20mm;">
            <div class="document-header">
                <h1 style="font-size: 36px; margin: 0; color: #4f46e5; text-align: center;">فـاتـورة</h1>
                <div class="info-grid">
                    <div class="info-block" style="text-align: right;">
                        <h3 style="font-size: 16px; color: #4f46e5; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">تفاصيل البائع</h3>
                        <p><strong>رقم الفاتورة:</strong> <span id="printInvoiceNumber" style="color: #1f2937; font-size: 14px;"></span></p>                       
                        <p><strong>اسم الشركة:</strong> <span id="printCompanyName">اسم شركتك هنا</span></p>
                        <p><strong>المالك:</strong> <span id="printInvoiceOwner"></span></p>
                       
                        <p><strong>الهاتف:</strong> <span id="printInvoiceOwnerPhone"></span></p>
                         <p><strong>العنوان:</strong> <span id="printInvoiceOwnerAddress"></span></p>
                        </div>
                    <div class="info-block" style="text-align: right;">
                        <h3 style="font-size: 16px; color: #4f46e5; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">تفاصيل العميل</h3>
                        
                        <p><strong>التاريخ:</strong> <span id="printInvoiceDate" style="color: #1f2937;"></span></p>
                        <p><strong>اسم العميل:</strong> <span id="printCustomerName"></span></p>
                        </div>
                </div>
            </div>

            <div class="details-section">
                <h3 style="font-size: 18px; color: #4f46e5; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">تفاصيل المنتجات والملخص</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">#</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">المنتج</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">سعر الوحدة</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">الكمية</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">المجموع (قبل الضريبة)</th>
                        </tr>
                    </thead>
                    <tbody id="printInvoiceDetailsBody">
                    </tbody>
                    <tfoot class="combined-summary-table" style="background-color: #f9f9f9 !important;">
                        <tr class="summary-title-row" style="background-color: #e0e7ff !important;">
                            <td colspan="5" style="text-align: center; font-weight: bold; color: #4f46e5 !important; font-size: 14px; padding: 10px; border-bottom: 1px solid #ddd !important;">ملخص الفاتورة</td>
                        </tr>
                        <tr>
                            <td colspan="4" style="text-align: left; padding: 5px 12px; border: none;"><strong>المجموع قبل العمولة (قبل الضريبة):</strong></td>
                            <td style="text-align: left; padding: 5px 12px; border: none;" id="printTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="4" style="text-align: left; padding: 5px 12px; border: none;"><strong>العمولة المخصومة:</strong></td>
                            <td style="text-align: left; padding: 5px 12px; border: none;" id="printCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="4" style="text-align: left; padding: 5px 12px; border: none;"><strong>المبلغ الإجمالي (قبل الضريبة):</strong></td>
                            <td style="text-align: left; padding: 5px 12px; border: none;" id="printTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="4" style="text-align: left; padding: 5px 12px; border: none;"><strong>الضريبة (TVA):</strong></td>
                            <td style="text-align: left; padding: 5px 12px; border: none;" id="printTVA"></td>
                        </tr>
                        <tr class="total-row-print">
                            <td colspan="4" style="text-align: left; padding: 8px 12px;"><strong>المبلغ الإجمالي (شامل الضريبة):</strong></td>
                            <td style="text-align: left; padding: 8px 12px; font-size: 16px; color: #4f46e5; font-weight: bold;" id="printTotalTTC"></td>
                        </tr>
                        <tr class="profit-row-print" style="display: none;">
                            <td colspan="4" style="border: none; padding: 8px 12px;"><strong>الربح الصافي:</strong></td>
                            <td style="border: none; padding: 8px 12px; text-align: left; font-size: 16px; font-weight: bold;" id="printTotalProfit"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="print-footer-container">
                <p style="font-size: 14px; margin-bottom: 15px; color: #555;">ملاحظات: جميع الأسعار بالدرهم المغربي. شكراً لتعاملك معنا.</p>
                <div class="signature-section">
                    <div class="signature-box">
                        <p>توقيع العميل</p>
                    </div>
                    <div class="signature-box">
                        <p>توقيع المالك</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printPoTemplate" style="display: none; direction: rtl; font-family: 'Cairo', sans-serif; font-size: 12px; line-height: 1.5; color: #333;">
        <div style="padding: 20mm;">
            <div class="document-header">
                <h1 style="font-size: 36px; margin: 0; color: #4f46e5; text-align: center;">أمـر شـراء</h1>
                <div class="info-grid">
                    <div class="info-block" style="text-align: right;">
                        <h3 style="font-size: 16px; color: #4f46e5; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">تفاصيل صاحب الطلب</h3>
                        <p><strong>رقم الأمر:</strong> <span id="printPoNumber" style="color: #1f2937; font-size: 14px;"></span></p>
                        
                        <p><strong>اسم الشركة:</strong> <span id="printPoCompanyName">اسم شركتك هنا</span></p>
                        <p><strong>مالك الأمر:</strong> <span id="printPoOwnerName"></span></p>
                        
                        <p><strong>الهاتف:</strong> <span id="printPoOwnerPhone"></span></p>
                      
                      <p><strong>العنوان:</strong> <span id="printPoCompanyAddress"></span></p>
                      
                        </div>
                    <div class="info-block" style="text-align: right;">
                        <h3 style="font-size: 16px; color: #4f46e5; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">تفاصيل المورد</h3>
                        
                        <p><strong>تاريخ الأمر:</strong> <span id="printPoDate" style="color: #1f2937;"></span></p>
                        <p><strong>تاريخ التسليم المتوقع:</strong> <span id="printPoDeliveryDate" style="color: #1f2937;"></span></p>
                        <p><strong>اسم المورد:</strong> <span id="printPoSupplierName"></span></p>
                        <p><strong>هاتف المورد:</strong> <span id="printPoSupplierPhone"></span></p>
                        <p><strong>عنوان المورد:</strong> <span id="printPoSupplierAddress"></span></p>
                    </div>
                </div>
            </div>

            <div class="details-section">
                <h3 style="font-size: 18px; color: #4f46e5; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">المنتجات المطلوبة</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">#</th>
                            <th class="po-product-name-col" style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">المنتج</th>
                            <th class="po-purchase-price-col" style="display: none;">سعر الشراء</th>
                            <th class="po-ordered-qty-col" style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">الكمية المطلوبة</th>
                            <th class="po-received-qty-col" style="border: 1px solid #ddd; padding: 10px; text-align: right; background-color: #f2f2f2; color: #4f46e5;">الكمية المستلمة</th>
                            <th class="po-total-col" style="display: none;">المجموع</th>
                        </tr>
                    </thead>
                    <tbody id="printPoDetailsBody">
                    </tbody>
                    </table>
            </div>

            <div class="print-footer-container">
                <p style="font-size: 14px; margin-bottom: 15px; color: #555;">ملاحظات: هذه الوثيقة تمثل أمر شراء وليست فاتورة بيع. يرجى تأكيد الاستلام.</p>
                <div class="signature-section">
                    <div class="signature-box">
                        <p>توقيع المورد</p>
                    </div>
                    <div class="signature-box">
                        <p>توقيع المالك</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsIDXPiSPozOABVEbQprWI3qT2I8g7XF9m9x+qFm1yQ1jGk/sXGk+v0Kx7+B7X3A2K5E+w+5N+8/w+5N+8/w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'modern-bg-primary': 'var(--modern-bg-primary)',
                        'modern-card-bg': 'var(--modern-card-bg)',
                        'modern-primary-accent': 'var(--modern-primary-accent)',
                        'modern-secondary-accent': 'var(--modern-secondary-accent)',
                        'modern-text-dark': 'var(--modern-text-dark)',
                        'modern-text-secondary': 'var(--modern-text-secondary)',
                        'modern-border-light': 'var(--modern-border-light)',
                        'modern-success': 'var(--modern-success)',
                        'modern-warning': 'var(--modern-warning)',
                        'modern-error': 'var(--modern-error)',
                        'modern-alert': 'var(--modern-alert)',
                        'modern-primary-accent-rgb': '79, 70, 229',
                        'modern-success-rgb': '34, 197, 94',
                        'modern-error-rgb': '239, 68, 68',
                        'modern-bg-light-red': '#fee2e2',
                        'modern-bg-light-green': '#dcfce7',
                        'modern-bg-light-orange': '#fffbe0',
                        'modern-bg-light-blue': '#e0e7ff',
                    },
                },
            },
        };
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        const UIElements = {
            mainDashboardView: document.getElementById('mainDashboardView'),
            invoiceDisplay: document.getElementById('invoiceDisplay'),
            localArchiveView: document.getElementById('localArchiveView'),
            purchaseOrderSection: document.getElementById('purchaseOrderSection'),
            desktopNavButtons: [
                document.getElementById('showDashboardButton'),
                document.getElementById('showPurchaseOrderSectionButton'),
                document.getElementById('showLocalArchiveButton')
            ],
            appContainer: document.querySelector('main.app-container'),
            productForm: document.getElementById('productForm'),
            productFormContainer: document.getElementById('productFormContainer'),
            productFormTitle: document.getElementById('productFormTitle'),
            productNameInput: document.getElementById('productName'),
            purchasePriceInput: document.getElementById('purchasePrice'),
            sellingPriceInput: document.getElementById('sellingPrice'),
            minStockQuantityInput: document.getElementById('minStockQuantity'),
            unitOfMeasureInput: document.getElementById('unitOfMeasure'),
            supplierNameInput: document.getElementById('supplierName'),
            supplierAddressInput: document.getElementById('supplierAddress'),
            supplierPhoneInput: document.getElementById('supplierPhone'),
            productQuantityInput: document.getElementById('productQuantity'),
            addProductButton: document.getElementById('addProduct'),
            saveEditProductButton: document.getElementById('saveEditProduct'),
            cancelEditProductButton: document.getElementById('cancelEditProduct'),
            savedProductsList: document.getElementById('savedProductsList'),
            searchProductInput: document.getElementById('searchProduct'),
            clearSearchProductBtn: document.getElementById('clearSearchProductBtn'),
            savedProductsLoader: document.getElementById('savedProductsLoader'),
            emptyProductsMessage: document.getElementById('emptyProductsMessage'),
            selectedProductCountSpan: document.getElementById('selectedProductCount'),
            invoiceForm: document.getElementById('invoiceForm'),
            clientFormContainer: document.getElementById('clientFormContainer'),
            customerNameInput: document.getElementById('customerName'),
            companyNameInput: document.getElementById('companyName'),
            invoiceOwnerInput: document.getElementById('invoiceOwner'),
            invoiceOwnerPhoneInput: document.getElementById('invoiceOwnerPhone'),
            invoiceOwnerAddressInput: document.getElementById('invoiceOwnerAddress'),
            invoiceDateInput: document.getElementById('invoiceDate'),
            tvaInput: document.getElementById('tva'),
            invoiceCommissionAmountInput: document.getElementById('invoiceCommissionAmount'),
            createInvoiceButton: document.getElementById('createInvoiceButton'),
            updateStockAndSaveInvoiceButton: document.getElementById('updateStockAndSaveInvoiceButton'), 
            printButton: document.getElementById('printButton'),
            cancelInvoiceButton: document.getElementById('cancelInvoiceButton'),
            displayInvoiceNumber: document.getElementById('displayInvoiceNumber'),
            displayCustomerName: document.getElementById('displayCustomerName'),
            displayCompanyName: document.getElementById('displayCompanyName'),
            displayInvoiceOwner: document.getElementById('displayInvoiceOwner'),
            displayInvoiceDate: document.getElementById('displayInvoiceDate'),
            displayInvoiceOwnerAddress: document.getElementById('displayInvoiceOwnerAddress'),
            displayInvoiceOwnerPhone: document.getElementById('displayInvoiceOwnerPhone'),
            displayTotalAmountBeforeCommission: document.getElementById('displayTotalAmountBeforeCommission'),
            displayCommissionDeducted: document.getElementById('displayCommissionDeducted'),
            displayTotalAmount: document.getElementById('displayTotalAmount'),
            displayTVA: document.getElementById('displayTVA'),
            displayTotalTTC: document.getElementById('displayTotalTTC'),
            displayDetails: document.getElementById('displayDetails'),
            displayTotalProfit: document.getElementById('displayTotalProfit'),
            localInvoicesList: document.getElementById('localInvoicesList'),
            searchLocalInvoiceInput: document.getElementById('searchLocalInvoice'),
            clearSearchLocalInvoiceBtn: document.getElementById('clearSearchLocalInvoiceBtn'),
            localArchiveLoader: document.getElementById('localArchiveLoader'),
            emptyInvoicesMessage: document.getElementById('emptyInvoicesMessage'),
            exportDataBtn: document.getElementById('exportDataBtn'),
            importDataInput: document.getElementById('importDataInput'),
            importDataBtn: document.getElementById('importDataBtn'),
            productNamesDatalist: document.getElementById('productNames'),
            unitsOfMeasureDatalist: document.getElementById('unitsOfMeasure'),
            supplierNamesDatalist: document.getElementById('supplierNames'),
            supplierAddressesDatalist: document.getElementById('supplierAddresses'),
            supplierPhonesDatalist: document.getElementById('supplierPhones'),
            customerNamesDatalist: document.getElementById('customerNames'),
            companyNamesDatalist: document.getElementById('companyNames'),
            invoiceOwnersDatalist: document.getElementById('invoiceOwners'),
            invoiceOwnerAddressesDatalist: document.getElementById('invoiceOwnerAddresses'),
            invoiceOwnerPhonesDatalist: document.getElementById('invoiceOwnerPhones'),
            localInvoiceSearchOptionsDatalist: document.getElementById('localInvoiceSearchOptions'),
            toastContainer: document.getElementById('toast-container'),
            confirmModalOverlay: document.getElementById('confirm-modal-overlay'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalMessage: document.getElementById('confirm-modal-message'),
            confirmYesBtn: document.getElementById('confirm-yes-btn'),
            confirmNoBtn: document.getElementById('confirm-no-btn'),
            localTotalSalesTTC: document.getElementById('localTotalSalesTTC'),
            localTotalProfit: document.getElementById('localTotalProfit'),
            localInvoiceCount: document.getElementById('localInvoiceCount'),
            localTotalProductsSold: document.getElementById('localTotalProductsSold'),
            localTotalPurchaseCost: document.getElementById('localTotalPurchaseCost'),
            localTotalSellingPrice: document.getElementById('localTotalSellingPrice'),
            localTotalCommission: document.getElementById('localTotalCommission'),
            localTotalSalesHTAfterCommission: document.getElementById('localTotalSalesHTAfterCommission'),
            localTotalTVA: document.getElementById('localTotalTVA'),
            poFormContainerWrapper: document.getElementById('poFormContainerWrapper'),
            purchaseOrderForm: document.getElementById('purchaseOrderForm'),
            purchaseOrderDateInput: document.getElementById('purchaseOrderDate'),
            poCompanyNameInput: document.getElementById('poCompanyName'),
            poOwnerNameInput: document.getElementById('poOwnerName'),
            poOwnerPhoneInput: document.getElementById('poOwnerPhone'),
            poCompanyAddressInput: document.getElementById('poCompanyAddress'),
            poSupplierNameInput: document.getElementById('poSupplierName'), // New
            poSupplierPhoneInput: document.getElementById('poSupplierPhone'), // New
            poSupplierAddressInput: document.getElementById('poSupplierAddress'), // New
            purchaseOrderDeliveryDateInput: document.getElementById('purchaseOrderDeliveryDate'),
            createPurchaseOrderButton: document.getElementById('createPurchaseOrder'),
            purchaseOrderDisplay: document.getElementById('purchaseOrderDisplay'),
            displayPoId: document.getElementById('displayPoId'),
            displayPoDate: document.getElementById('displayPoDate'),
            displayPoCompanyName: document.getElementById('displayPoCompanyName'),
            displayPoOwnerName: document.getElementById('displayPoOwnerName'),
            displayPoOwnerPhone: document.getElementById('displayPoOwnerPhone'),
            displayPoDeliveryDate: document.getElementById('displayPoDeliveryDate'),
            displayPoCompanyAddress: document.getElementById('displayPoCompanyAddress'),
            poDetailsTable: document.getElementById('poDetailsTable'),
            displayPoProducts: document.getElementById('displayPoProducts'),
            displayPoTotalAmount: document.getElementById('displayPoTotalAmount'),
            printPoBtn: document.getElementById('printPoBtn'),
            cancelPoBtn: document.getElementById('cancelPoBtn'),
            localPurchaseOrdersArchive: document.getElementById('localPurchaseOrdersArchive'),
            searchLocalPo: document.getElementById('searchLocalPo'),
            clearSearchLocalPoBtn: document.getElementById('clearSearchLocalPoBtn'),
            localPoList: document.getElementById('localPoList'),
            emptyPoMessage: document.getElementById('emptyPoMessage'),
            localPoLoader: document.getElementById('localPoLoader'),
            
            receiptModalOverlay: document.getElementById('receipt-modal-overlay'),
            receiptModalTitle: document.getElementById('receipt-modal-title'),
            receiptPoNumber: document.getElementById('receiptPoNumber'),
            receiptPoSupplierName: document.getElementById('receiptPoSupplierName'),
            receiptPoDate: document.getElementById('receiptPoDate'),
            receiptPoDeliveryDate: document.getElementById('receiptPoDeliveryDate'),
            receiptProductsTableBody: document.getElementById('receiptProductsTableBody'),
            confirmReceiveGoodsBtn: document.getElementById('confirmReceiveGoodsBtn'),
            cancelReceiveGoodsBtn: document.getElementById('cancelReceiveGoodsBtn'),
            receivePoFromDetailsBtn: document.getElementById('receivePoFromDetailsBtn'),
            // عناصر الطباعة
            printInvoiceTemplate: document.getElementById('printInvoiceTemplate'),
            printPoTemplate: document.getElementById('printPoTemplate'),
            printCompanyName: document.getElementById('printCompanyName'),
            printInvoiceOwner: document.getElementById('printInvoiceOwner'),
            printInvoiceOwnerAddress: document.getElementById('printInvoiceOwnerAddress'),
            printInvoiceOwnerPhone: document.getElementById('printInvoiceOwnerPhone'),
            printInvoiceNumber: document.getElementById('printInvoiceNumber'),
            printCustomerName: document.getElementById('printCustomerName'),
            printCustomerCompany: document.getElementById('printCustomerCompany'),
            printInvoiceDate: document.getElementById('printInvoiceDate'),
            printInvoiceDetailsBody: document.getElementById('printInvoiceDetailsBody'),
            printTotalAmountBeforeCommission: document.getElementById('printTotalAmountBeforeCommission'),
            printCommissionDeducted: document.getElementById('printCommissionDeducted'),
            printTotalAmount: document.getElementById('printTotalAmount'),
            printTVA: document.getElementById('printTVA'),
            printTotalTTC: document.getElementById('printTotalTTC'),
            printTotalProfit: document.getElementById('printTotalProfit'),
            printPoCompanyName: document.getElementById('printPoCompanyName'),
            printPoOwnerName: document.getElementById('printPoOwnerName'),
            printPoCompanyAddress: document.getElementById('printPoCompanyAddress'),
            printPoOwnerPhone: document.getElementById('printPoOwnerPhone'),
            printPoNumber: document.getElementById('printPoNumber'),
            printPoDate: document.getElementById('printPoDate'),
            printPoDeliveryDate: document.getElementById('printPoDeliveryDate'),
            printPoDetailsBody: document.getElementById('printPoDetailsBody'),
            printPoTotalAmount: document.getElementById('printPoTotalAmount'),
            printPoSupplierName: document.getElementById('printPoSupplierName'),
            printPoSupplierPhone: document.getElementById('printPoSupplierPhone'),
            printPoSupplierAddress: document.getElementById('printPoSupplierAddress'),
        };
        const AppMessages = {
            firebaseNotInitialized: "قاعدة بيانات Firebase غير مهيأة. قد لا تعمل ميزات حفظ البيانات السحابية.",
            firebaseSyncSkipped: "قاعدة بيانات Firebase غير مهيأة. تخطي المزامنة.",
            invalidPhoneForSync: "رقم هاتف المالك غير صالح للمزامنة. تخطي المزامنة.",
            syncingProducts: "جاري مزامنة المنتجات المحلية...",
            productsSyncedSuccess: (count) => `تمت مزامنة ${count} منتج بنجاح.`,
            syncingInvoices: "جاري مزامنة الفواتير المحلية...",
            invoicesSyncedSuccess: (count) => `تمت مزامنة ${count} فاتورة بنجاح.`,
            syncingPOs: "جاري مزامنة أوامر الشراء المحلية...",
            posSyncedSuccess: (count) => `تمت مزامنة ${count} أمر شراء بنجاح.`,
            ownerPhoneInvalidOrEmpty: "رقم هاتف مالك الفاتورة غير صالح أو فارغ. لن تتم مزامنة البيانات مع Firebase.",
            transitionInProgress: "الرجاء الانتظار حتى يكتمل التحول بين الأقسام.",
            exportedSuccess: "تم تصدير البيانات بنجاح إلى ملف JSON.",
            noFileSelected: "لم يتم تحديد أي ملف.",
            invalidJsonFile: "ملف JSON غير صالح. يرجى التأكد من أنه يحتوي على بيانات المنتجات والفواتير.",
            importConfirm: (importedPhone, currentPhone) => {
                let msg = "هل أنت متأكد من استيراد هذه البيانات؟ سيؤدي ذلك إلى استبدال البيانات المحلية الحالية.";
                if (importedPhone !== 'N/A' && importedPhone !== currentPhone) {
                    msg += ` <br>هذه البيانات خاصة بالمالك "${importedPhone}" ورقم المالك الحالي هو "${currentPhone}". هل تريد الاستمرار؟`;
                } else if (importedPhone !== 'N/A') {
                    msg += ` <br>هذه البيانات خاصة بالمالك "${importedPhone}".`;
                }
                return msg;
            },
            importCanceled: "تم إلغاء عملية الاستيراد.",
            importSuccess: "تم استيراد البيانات بنجاح.",
            jsonParseError: "خطأ في قراءة ملف JSON. تأكد من أنه ملف JSON صالح.",
            productUpdateSuccess: "تم تحديث المنتج وحفظه محلياً بنجاح.",
            productAddSuccess: "تم إضافة المنتج وحفظه محلياً بنجاح.",
            productEditCanceled: "تم إلغاء تعديل المنتج.",
            productAddCanceled: "تم إلغاء إضافة المنتج.",
            productNotFound: "المنتج المراد تعديله غير موجود.",
            productDeleteSuccess: "تم حذف المنتج بنجاح.",
            productDeleteConfirm: "هل أنت متأكد من أنك تريد حذف المنتج هذا؟ هذا الإجراء لا يمكن التراجع عنه.",
            productDeleteCanceled: "تم إلغاء حذف المنتج.",
            duplicateProduct: "المنتج موجود بالفعل بنفس الاسم وتحت نفس رقم هاتف المورد.",
            formValidationFailed: "يرجى ملء جميع الحقول المطلوبة بشكل صحيح.",
            invoiceOwnerPhoneRequired: "يرجى ملء حقل 'هاتف مالك الفاتورة' بشكل صحيح قبل حفظ الفاتورة.",
            noProductsForInvoice: "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة جميع المنتجات بكمية 1 بشكل افتراضي؟",
            noProductsAfterDefault: "لا توجد منتجات لتضمينها في الفاتورة بعد التحديث.",
            invoiceCreationCanceledNoProducts: "لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.",
            insufficientStockWarning: (productName, required, available) => `تنبيه: كمية "${productName}" (المطلوبة: ${required}, المتاحة: ${available}) غير كافية.`,
            productNotInLocalStock: (productName) => `تنبيه: المنتج "${productName}" في الفاتورة غير موجود محلياً. لا يمكن تحديث المخزون له.`,
            insufficientStockProceedConfirm: "بعض المنتجات في الفاتورة لديها كمية غير كافية في المخزون. هل تريد الاستمرار في إنشاء الفاتورة على أي حال؟",
            invoiceCanceledInsufficientStock: "تم إلغاء إنشاء الفاتورة بسبب نقص المخزون.",
            criticalError: (message) => `حدث خطأ حرج: ${message}. لم يتم حفظ الفاتورة بالكامل أو تحديث المخزون.`,
            invoiceUpdateSaveSuccess: "تم تحديث المخزون وحفظ الفاتورة محلياً بنجاح.",
            invoiceNotNewError: "خطأ: يجب أن تكون فاتورة جديدة لتحديث المخزون وحفظها.",
            invoiceCancelConfirm: "هل أنت متأكد من إلغاء هذه الفاتورة؟ سيتم تجاهل أي تغييرات لم تُحفظ.",
            invoiceCancelSuccess: "تم إلغاء عملية إنشاء الفاتورة.",
            invoiceNotFound: "الفاتورة غير موجودة في الأرشيف المحلي.",
            poFormValidationFailed: "يرجى ملء جميع حقول أمر الشراء المطلوبة بشكل صحيح.",
            poOwnerPhoneInvalid: "خطأ: رقم هاتف صاحب الأمر غير صحيح. لا يمكن المتابعة.",
            noProductsForPO: "لم يتم تحديد أي منتجات لأمر الشراء. هل تريد إضافة جميع المنتجات بكمية 1 بشكل افتراضي؟",
            poCreateConfirm: "هل أنت متأكد من إنشاء هذا الأمر؟ سيتم حفظه محلياً وعرضه.",
            poCreateCanceled: "تم إلغاء إنشاء أمر الشراء.",
            poReadyForView: "تم إعداد أمر الشراء للعرض.",
            poSaveSuccess: "تم حفظ أمر الشراء محلياً بنجاح.",
            poSaveError: (message) => `حدث خطأ أثناء حفظ أمر الشراء: ${message}`,
            poNotFound: "أمر الشراء غير موجود في الأرشيف المحلي.",
            poDeleteConfirm: "هل أنت متأكد من أنك تريد حذف أمر الشراء هذا من الأرشيف المحلي؟ هذا الإجراء لا يمكن التراجع عنه.",
            poDeleteCanceled: "تم إلغاء حذف أمر الشراء.",
            poDeleteSuccess: "تم حذف أمر الشراء بنجاح من الأرشيف المحلي.",
            dailyBackupWarning: "تنبيه: استخدم خاصية 'تصدير البيانات (JSON)' لعمل نسخة احتياطية بشكل دوري.",
            poAlreadyFullyReceived: "تم استلام جميع المنتجات لأمر الشراء هذا بالكامل.",
            poReceiveCanceled: "تم إلغاء عملية استلام المخزون.",
            poReceiveSuccess: "تم استلام المنتجات وتحديث المخزون بنجاح.",
            receiptUpdateError: (message) => `حدث خطأ أثناء تحديث المخزون للاستلام: ${message}`,
            noPoToProcess: "لا يوجد أمر شراء قيد المعالجة للاستلام.",
            invalidReceivedQuantity: "يرجى إدخال كميات مستلمة صحيحة (أرقام موجبة أو صفر) ولا تتجاوز الكمية المطلوبة.",
            stockMovementReceipt: 'استلام بضاعة (أمر شراء)',
            stockMovementManual: 'إضافة يدوية',
            invoicePrintSuccess: "تم إرسال الفاتورة إلى الطابعة.",
            poPrintSuccess: "تم إرسال أمر الشراء إلى الطابعة.",
            stockUpdateConfirm: "هل أنت متأكد من تحديث المخزون وحفظ الفاتورة؟ هذا الإجراء سيؤثر على كميات المنتجات المتوفرة.",
            stockUpdateCanceled: "تم إلغاء تحديث المخزون وحفظ الفاتورة."
        };
        let currentInvoiceBeingProcessed = null;
        let isNewInvoice = false; // Flag to indicate if the displayed invoice is new and needs saving
        let currentPurchaseOrderBeingProcessed = null;
        let isTransitioning = false;
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseApp;
        let database;
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            database = firebase.database();
        } catch (e) {
            UI.showToast(AppMessages.firebaseNotInitialized, 'error');
        }
        const KEY_MAPPING_TO_FIREBASE = {
            id: 'id',
            name: 'nom',
            purchasePrice: 'prixAchat',
            sellingPrice: 'prixVente',
            minStockQuantity: 'quantiteMinimaleStock',
            unitOfMeasure: 'uniteMesure',
            supplierName: 'nomFournisseur',
            supplierAddress: 'adresseFournisseur',
            supplierPhone: 'telephoneFournisseur',
            stockQuantity: 'quantiteStock',
            date: 'dateCreationProduit',
            quantity: 'quantiteSelectionnee',
            purchaseOrderQuantity: 'quantiteCommandeFournisseur',
            isLocal: 'estLocal',
            invoiceId: 'id',
            invoiceNumber: 'numeroFacture',
            invoiceDate: 'dateFacture',
            isoDate: 'dateIsoFacture',
            customerName: 'nomClient',
            companyName: 'nomSociete',
            ownerName: 'nomProprietaire',
            ownerAddress: 'adresseProprietaire',
            ownerPhone: 'telephoneProprietaire',
            products: 'produits',
            totalHT: 'totalHT',
            totalHTBeforeCommission: 'totalHTAvantCommission',
            tva: 'tva',
            totalTTC: 'totalTTC',
            totalProfit: 'profitTotal',
            totalCommission: 'commissionTotale',
            invoiceCommissionRate: 'tauxCommissionFacture',
            quantityUsed: 'quantiteUtilisee',
            purchaseOrderDate: 'dateBonCommande',
            poCompanyName: 'nomSocieteBonCommande',
            poOwnerName: 'nomProprietaireBonCommande',
            poOwnerPhone: 'telephoneProprietaireBonCommande',
            poCompanyAddress: 'adresseSocieteBonCommande',
            poSupplierName: 'nomFournisseurBonCommande', // New Firebase Key
            poSupplierPhone: 'telephoneFournisseurBonCommande', // New Firebase Key
            poSupplierAddress: 'adresseFournisseurBonCommande', // New Firebase Key
            purchaseOrderDeliveryDate: 'dateLivraisonEstimee',
            orderedQuantity: 'quantiteCommandee',
            receivedQuantity: 'quantiteRecue',
            poId: 'id',
            poNumber: 'numeroBonCommande',
            orderedProducts: 'produitsCommandes',
            totalPoAmount: 'montantTotalBonCommande',
            status: 'statut',
        };
        const KEY_MAPPING_FROM_FIREBASE = {};
        for (const localKey in KEY_MAPPING_TO_FIREBASE) {
            KEY_MAPPING_FROM_FIREBASE[KEY_MAPPING_TO_FIREBASE[localKey]] = localKey;
        }
        function mapToFirebaseKeys(obj) {
            const newObj = {};
            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    if ((key === 'products' || key === 'orderedProducts') && Array.isArray(obj[key])) {
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key].map(p => {
                            const productMapped = {};
                            for (const productKey in p) {
                                if (Object.prototype.hasOwnProperty.call(p, productKey)) {
                                    productMapped[KEY_MAPPING_TO_FIREBASE[productKey] || productKey] = p[productKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[KEY_MAPPING_TO_FIREBASE[key] || key] = obj[key];
                    }
                }
            }
            return newObj;
        }
        function mapFromFirebaseKeys(fbObj) {
            if (fbObj === null || typeof fbObj !== 'object') {
                return fbObj;
            }
            const newObj = {};
            for (const fbKey in fbObj) {
                if (Object.prototype.hasOwnProperty.call(fbObj, fbKey)) {
                    const localKey = KEY_MAPPING_FROM_FIREBASE[fbKey];
                    if ((fbKey === 'produits' || fbKey === 'produitsCommandes') && Array.isArray(fbObj[fbKey])) {
                        newObj[localKey || fbKey] = fbObj[fbKey].map(p => {
                            const productMapped = {};
                            for (const productFbKey in p) {
                                if (Object.prototype.hasOwnProperty.call(p, productFbKey)) {
                                    productMapped[KEY_MAPPING_FROM_FIREBASE[productFbKey] || productFbKey] = p[productFbKey];
                                }
                            }
                            return productMapped;
                        });
                    } else {
                        newObj[localKey || fbKey] = fbObj[fbKey];
                    }
                }
            }
            return newObj;
        }
        const UI = {
            confirmResolve: null,
            hideAllSections: (instant = false) => {
                const sections = [UIElements.mainDashboardView, UIElements.invoiceDisplay, UIElements.localArchiveView, UIElements.purchaseOrderSection];
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (!instant) {
                        const transitionEndHandler = () => {
                            section.removeEventListener('transitionend', transitionEndHandler);
                            section.hidden = true;
                        };
                        section.addEventListener('transitionend', transitionEndHandler, { once: true });
                        setTimeout(() => {
                            if (!section.hidden) section.hidden = true;
                        }, 600);
                    } else {
                        section.hidden = true;
                    }
                });
            },
            showSection: (sectionToShow) => {
                if (isTransitioning) {
                    UI.showToast(AppMessages.transitionInProgress, 'info');
                    return Promise.reject('Transition already in progress');
                }
                isTransitioning = true;
                return new Promise(resolve => {
                    const currentlyActiveSection = document.querySelector('.view-section.active');
                    let hidePromise;
                    if (currentlyActiveSection && currentlyActiveSection !== sectionToShow) {
                        hidePromise = new Promise(hideResolve => {
                            currentlyActiveSection.classList.remove('active');
                            const transitionTimeout = setTimeout(() => {
                                currentlyActiveSection.hidden = true;
                                hideResolve();
                            }, 500);
                            currentlyActiveSection.addEventListener('transitionend', function handler() {
                                clearTimeout(transitionTimeout);
                                currentlyActiveSection.removeEventListener('transitionend', handler);
                                currentlyActiveSection.hidden = true;
                                hideResolve();
                            }, { once: true });
                        });
                    } else {
                        hidePromise = Promise.resolve();
                    }
                    hidePromise.then(() => {
                        [UIElements.mainDashboardView, UIElements.invoiceDisplay, UIElements.localArchiveView, UIElements.purchaseOrderSection].forEach(section => {
                            section.hidden = true;
                        });
                        sectionToShow.hidden = false;
                        requestAnimationFrame(() => {
                            sectionToShow.classList.add('active');
                            const transitionTimeout = setTimeout(() => {
                                isTransitioning = false;
                                resolve();
                            }, 500);
                            sectionToShow.addEventListener('transitionend', function handler() {
                                clearTimeout(transitionTimeout);
                                sectionToShow.removeEventListener('transitionend', handler);
                                isTransitioning = false;
                                resolve();
                            }, { once: true });
                        });
                    });
                });
            },
            setActiveButton: (activeBtn, buttonGroup) => {
                buttonGroup.forEach(btn => { btn.classList.remove('active'); });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            },
            resetValidationMessages: (form) => {
                form.querySelectorAll('.form-input.error, .form-textarea.error').forEach(field => {
                    field.classList.remove('error');
                    const parentQuantityControls = field.closest('.quantity-controls');
                    let actualErrorMessageSpan = field.nextElementSibling;
                    if (parentQuantityControls) {
                        const formGroup = parentQuantityControls.closest('.form-group');
                        if (formGroup) {
                            actualErrorMessageSpan = formGroup.querySelector('.validation-message');
                        }
                    } else if (field.tagName === 'INPUT' && field.type === 'number' && field.closest('#receiptProductsTableBody')) {
                        actualErrorMessageSpan = null;
                    }
                    if (actualErrorMessageSpan && actualErrorMessageSpan.classList.contains('validation-message')) {
                        actualErrorMessageSpan.textContent = '';
                        actualErrorMessageSpan.style.display = 'none';
                    }
                });
            },
            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast-message', type);
                let iconHtml = '';
                if (type === 'success') { iconHtml = '<i class="fas fa-check"></i>'; }
                else if (type === 'error') { iconHtml = '<i class="fas fa-times"></i>'; }
                else if (type === 'info') { iconHtml = '<i class="fas fa-info-circle"></i>'; }
                else if (type === 'warning') { iconHtml = '<i class="fas fa-exclamation-triangle"></i>'; }
                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                toast.hidden = false;
                requestAnimationFrame(() => {
                    toast.classList.add('active');
                });
                setTimeout(() => {
                    toast.classList.remove('active');
                    const transitionEndHandler = () => {
                        toast.removeEventListener('transitionend', transitionEndHandler);
                        toast.remove();
                    };
                    toast.addEventListener('transitionend', transitionEndHandler, { once: true });
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 600);
                }, 3000);
            },
            showConfirmModal: (title, message) => {
                return new Promise(resolve => {
                    UI.confirmResolve = resolve;
                    UIElements.confirmModalTitle.textContent = title;
                    UIElements.confirmModalMessage.innerHTML = message;
                    UIElements.confirmModalOverlay.hidden = false;
                    UIElements.confirmModalOverlay.classList.add('active');
                    const handleConfirm = (result) => {
                        UIElements.confirmModalOverlay.classList.remove('active');
                        setTimeout(() => {
                            UIElements.confirmModalOverlay.hidden = true;
                        }, 300);
                        UIElements.confirmYesBtn.removeEventListener('click', handleYes);
                        UIElements.confirmNoBtn.removeEventListener('click', handleNo);
                        UI.confirmResolve(result);
                    };
                    const handleYes = () => handleConfirm(true);
                    const handleNo = () => handleConfirm(false);
                    UIElements.confirmYesBtn.addEventListener('click', handleYes, { once: true });
                    UIElements.confirmNoBtn.addEventListener('click', handleNo, { once: true });
                });
            },
            toggleButtonLoading: (button, isLoading) => {
                const loader = button.querySelector('.loader-inline');
                if (loader) {
                    if (isLoading) {
                        button.classList.add('loading');
                        loader.classList.add('active');
                        button.disabled = true;
                    } else {
                        button.classList.remove('loading');
                        loader.classList.remove('active');
                        button.disabled = false;
                    }
                }
            },
            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('active', isLoading);
                }
            },
            updateProductCardClass: (productDiv, quantitySelected, stockQuantity, minStockQuantity) => {
                productDiv.classList.remove('status-insufficient', 'status-selected-sufficient', 'status-stock-positive', 'status-low-stock');
                productDiv.style.backgroundColor = 'var(--modern-card-bg)';
                productDiv.style.borderColor = 'var(--modern-border-light)';
                let newClass = '';
                let newBgColor = 'var(--modern-card-bg)';
                let newBorderColor = 'var(--modern-border-light)';
                if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                    newClass = 'status-insufficient';
                    newBgColor = 'var(--modern-bg-light-red)';
                    newBorderColor = 'var(--modern-error)';
                } else if (quantitySelected > 0) {
                    newClass = 'status-selected-sufficient';
                    newBgColor = 'var(--modern-bg-light-green)';
                    newBorderColor = 'var(--modern-success)';
                } else if (stockQuantity <= minStockQuantity && stockQuantity > 0) {
                    newClass = 'status-low-stock';
                    newBgColor = 'var(--modern-bg-light-orange)';
                    newBorderColor = 'var(--modern-alert)';
                } else if (stockQuantity <= 0) {
                    newClass = 'status-low-stock';
                    newBgColor = 'var(--modern-bg-light-red)';
                    newBorderColor = 'var(--modern-error)';
                } else {
                    newClass = 'status-stock-positive';
                    newBgColor = 'var(--modern-bg-light-blue)';
                    newBorderColor = 'var(--modern-primary-accent)';
                }
                productDiv.classList.add(newClass);
                productDiv.style.backgroundColor = newBgColor;
                productDiv.style.borderColor = newBorderColor;
            },
            updatePoCardClass: (poDiv, status) => {
                poDiv.classList.remove('status-pending', 'status-received-partial', 'status-received-full');
                if (status === 'Received (Full)') {
                    poDiv.classList.add('status-received-full');
                } else if (status === 'Received (Partial)') {
                    poDiv.classList.add('status-received-partial');
                } else {
                    poDiv.classList.add('status-pending');
                }
            },
            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            },
            populateAllDatalists: () => {
                const savedProducts = DataStore.getSavedProducts();
                UI.populateUniqueDatalist(UIElements.productNamesDatalist, savedProducts, 'name');
                UI.populateUniqueDatalist(UIElements.unitsOfMeasureDatalist, savedProducts, 'unitOfMeasure');
                UI.populateUniqueDatalist(UIElements.supplierNamesDatalist, savedProducts, 'supplierName');
                UI.populateUniqueDatalist(UIElements.supplierAddressesDatalist, savedProducts, 'supplierAddress');
                UI.populateUniqueDatalist(UIElements.supplierPhonesDatalist, savedProducts, 'supplierPhone');
                const allInvoiceRelatedData = DataStore.invoicesInCache;
                const allPurchaseOrderRelatedData = DataStore.purchaseOrdersInCache;
                UI.populateUniqueDatalist(UIElements.customerNamesDatalist, allInvoiceRelatedData, 'customerName');
                UI.populateUniqueDatalist(UIElements.companyNamesDatalist, allInvoiceRelatedData, 'companyName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnersDatalist, allInvoiceRelatedData, 'ownerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerAddressesDatalist, allInvoiceRelatedData, 'ownerAddress');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerPhonesDatalist, allInvoiceRelatedData, 'ownerPhone');
                UI.populateUniqueDatalist(UIElements.companyNamesDatalist, allPurchaseOrderRelatedData, 'poCompanyName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnersDatalist, allPurchaseOrderRelatedData, 'poOwnerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerPhonesDatalist, allPurchaseOrderRelatedData, 'poOwnerPhone');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerAddressesDatalist, allPurchaseOrderRelatedData, 'poCompanyAddress');
                // Also populate supplier datalists from PO data, if needed
                UI.populateUniqueDatalist(UIElements.supplierNamesDatalist, allPurchaseOrderRelatedData, 'poSupplierName');
                UI.populateUniqueDatalist(UIElements.supplierAddressesDatalist, allPurchaseOrderRelatedData, 'poSupplierAddress');
                UI.populateUniqueDatalist(UIElements.supplierPhonesDatalist, allPurchaseOrderRelatedData, 'poSupplierPhone');

                const localInvoiceSearchValues = new Set();
                allInvoiceRelatedData.forEach(invoice => {
                    localInvoiceSearchValues.add(invoice.customerName || '');
                    localInvoiceSearchValues.add(invoice.companyName || '');
                    localInvoiceSearchValues.add(invoice.ownerName || '');
                    localInvoiceSearchValues.add(invoice.date || '');
                    localInvoiceSearchValues.add(invoice.invoiceNumber || '');
                    if (invoice.products) {
                        invoice.products.forEach(p => {
                            if (p.name) {
                                localInvoiceSearchValues.add(p.name.trim());
                            }
                        });
                    }
                });
                UIElements.localInvoiceSearchOptionsDatalist.innerHTML = '';
                Array.from(localInvoiceSearchValues).sort().forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        UIElements.localInvoiceSearchOptionsDatalist.appendChild(option);
                    }
                });
            },
            updateProductCountInCart: () => {
                const allSavedProducts = DataStore.getSavedProducts();
                UIElements.selectedProductCountSpan.textContent = allSavedProducts.length;
            }
        };
        const DataStore = {
            productsInCache: [],
            invoicesInCache: [],
            purchaseOrdersInCache: [],
            stockMovementHistory: [],
            init: () => {
                DataStore.productsInCache = JSON.parse(localStorage.getItem('savedProducts') || '[]');
                DataStore.invoicesInCache = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                DataStore.purchaseOrdersInCache = JSON.parse(localStorage.getItem('localPurchaseOrders') || '[]');
                DataStore.stockMovementHistory = JSON.parse(localStorage.getItem('stockMovementHistory') || '[]');
            },
            getSavedProducts: () => DataStore.productsInCache,
            setSavedProducts: (products) => {
                DataStore.productsInCache = products;
                localStorage.setItem('savedProducts', JSON.stringify(products));
            },
            getInvoices: () => DataStore.invoicesInCache,
            setInvoices: (invoices) => {
                DataStore.invoicesInCache = invoices;
                localStorage.setItem('localInvoices', JSON.stringify(invoices));
            },
            getPurchaseOrders: () => DataStore.purchaseOrdersInCache,
            setPurchaseOrders: (pos) => {
                DataStore.purchaseOrdersInCache = pos;
                localStorage.setItem('localPurchaseOrders', JSON.stringify(pos));
            },
            getStockMovementHistory: () => DataStore.stockMovementHistory,
            addStockMovement: (movement) => {
                DataStore.stockMovementHistory.push(movement);
                localStorage.setItem('stockMovementHistory', JSON.stringify(DataStore.stockMovementHistory));
            },
            saveProduct: async (productData, isEditing = false) => {
                let products = DataStore.getSavedProducts();
                if (isEditing) {
                    const index = products.findIndex(p => p.id === productData.id);
                    if (index !== -1) {
                        products[index] = productData;
                    }
                } else {
                    productData.id = Date.now() + Math.floor(Math.random() * 1000);
                    products.push(productData);
                }
                products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                DataStore.setSavedProducts(products);
                UI.showToast(isEditing ? AppMessages.productUpdateSuccess : AppMessages.productAddSuccess, 'success');
            },
            deleteProduct: async (id) => {
                let products = DataStore.getSavedProducts();
                const productToDelete = products.find(product => product.id === id);
                if (productToDelete) {
                    products = products.filter(product => product.id !== id);
                    DataStore.setSavedProducts(products);
                    UI.showToast(AppMessages.productDeleteSuccess, 'success');
                }
            },
            updateProductStock: (id, newStockQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    const oldStock = products[index].stockQuantity || 0;
                    const change = newStockQuantity - oldStock;
                    products[index].stockQuantity = Math.max(0, newStockQuantity);
                    DataStore.setSavedProducts(products);
                    if (change !== 0) {
                        DataStore.addStockMovement({
                            productId: products[index].id,
                            productName: products[index].name,
                            type: change > 0 ? AppMessages.stockMovementManual : 'خصم يدوي',
                            quantityChange: change,
                            newStockQuantity: products[index].stockQuantity,
                            date: new Date().toISOString(),
                        });
                    }
                    SalesProducts.updateProductCardUI(products[index]);
                }
            },
            updateProductMinStock: (id, newMinStockQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].minStockQuantity = Math.max(0, newMinStockQuantity);
                    DataStore.setSavedProducts(products);
                    SalesProducts.updateProductCardUI(products[index]);
                }
            },
            updateProductInvoiceQuantity: (id, newQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].quantity = Math.max(0, newQuantity);
                    DataStore.setSavedProducts(products);
                    SalesProducts.updateProductCardUI(products[index]);
                }
            },
            updateProductPurchaseOrderQuantity: (id, newQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].purchaseOrderQuantity = Math.max(0, newQuantity);
                    DataStore.setSavedProducts(products);
                }
            },
            resetAllProductQuantities: () => {
                let products = DataStore.getSavedProducts();
                products.forEach(product => {
                    product.quantity = 0;
                    product.purchaseOrderQuantity = 0;
                });
                DataStore.setSavedProducts(products);
            },
            saveInvoiceToLocal: (invoiceData) => {
                try {
                    let localInvoices = DataStore.getInvoices();
                    localInvoices.push(invoiceData);
                    DataStore.setInvoices(localInvoices);
                } catch (e) {
                    UI.showToast(AppMessages.invoiceSaveError, 'error');
                }
            },
            deleteLocalInvoice: (invoiceId) => {
                let localInvoices = DataStore.getInvoices();
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                DataStore.setInvoices(localInvoices);
            },
            savePurchaseOrderToLocal: (purchaseOrderData, isEditing = false) => {
                try {
                    let localPurchaseOrders = DataStore.getPurchaseOrders();
                    if (isEditing) {
                        const index = localPurchaseOrders.findIndex(po => po.id === purchaseOrderData.id);
                        if (index !== -1) {
                            if (!purchaseOrderData.status) {
                                purchaseOrderData.status = localPurchaseOrders[index].status;
                            }
                            localPurchaseOrders[index] = purchaseOrderData;
                        }
                    } else {
                        purchaseOrderData.status = 'Pending';
                        localPurchaseOrders.push(purchaseOrderData);
                    }
                    DataStore.setPurchaseOrders(localPurchaseOrders);
                } catch (e) {
                    UI.showToast(AppMessages.poSaveError(e.message), 'error');
                }
            },
            deleteLocalPurchaseOrder: (poId) => {
                let localPurchaseOrders = DataStore.getPurchaseOrders();
                localPurchaseOrders = localPurchaseOrders.filter(po => po.id !== poId);
                DataStore.setPurchaseOrders(localPurchaseOrders);
            },
            loadFormDefaults: () => {
                const now = new Date();
                const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit', hour12: false });
                UIElements.invoiceDateInput.value = `${formattedDate} - ${formattedTime}`;
                UIElements.invoiceDateInput.setAttribute('data-iso-date', now.toISOString());
                UIElements.purchaseOrderDateInput.value = `${formattedDate} - ${formattedTime}`;
                UIElements.purchaseOrderDateInput.setAttribute('data-iso-date', now.toISOString());
                UIElements.invoiceOwnerInput.value = localStorage.getItem('invoiceOwner') || '';
                UIElements.invoiceOwnerPhoneInput.value = localStorage.getItem('invoiceOwnerPhone') || '';
                UIElements.invoiceOwnerAddressInput.value = localStorage.getItem('invoiceOwnerAddress') || '';
                UIElements.companyNameInput.value = localStorage.getItem('companyName') || '';
                UIElements.tvaInput.value = localStorage.getItem('tva') || '0';
                UIElements.invoiceCommissionAmountInput.value = localStorage.getItem('invoiceCommissionAmount') || '0';
                UIElements.supplierNameInput.value = localStorage.getItem('supplierName') || '';
                UIElements.supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
                UIElements.supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
                UIElements.poCompanyNameInput.value = localStorage.getItem('poCompanyName') || '';
                UIElements.poOwnerNameInput.value = localStorage.getItem('poOwnerName') || '';
                UIElements.poOwnerPhoneInput.value = localStorage.getItem('poOwnerPhone') || '';
                UIElements.poCompanyAddressInput.value = localStorage.getItem('poCompanyAddress') || '';
                UIElements.poSupplierNameInput.value = localStorage.getItem('poSupplierName') || ''; // New
                UIElements.poSupplierPhoneInput.value = localStorage.getItem('poSupplierPhone') || ''; // New
                UIElements.poSupplierAddressInput.value = localStorage.getItem('poSupplierAddress') || ''; // New
            },
            calculateAndDisplayLocalInvoiceStats: () => {
                let totalSalesTTC = 0;
                let totalProfit = 0;
                let totalProductsSold = 0;
                let totalPurchaseCost = 0;
                let totalSellingPrice = 0;
                let totalCommission = 0;
                let totalSalesHTAfterCommission = 0;
                let totalTVA = 0;
                const localInvoices = DataStore.getInvoices();
                localInvoices.forEach(invoice => {
                    totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                    totalProfit += parseFloat(invoice.totalProfit || 0);
                    totalCommission += parseFloat(invoice.totalCommission || 0);
                    totalSalesHTAfterCommission += parseFloat(invoice.totalHT || 0);
                    totalTVA += parseFloat(invoice.tva || 0);
                    if (invoice.products && Array.isArray(invoice.products)) {
                        invoice.products.forEach(product => {
                            totalProductsSold += parseInt(product.quantityUsed || 0);
                            const quantity = parseInt(product.quantityUsed || 0);
                            const purchasePrice = parseFloat(product.purchasePrice || 0);
                            const sellingPrice = parseFloat(product.sellingPrice || 0);
                            totalPurchaseCost += (purchasePrice * quantity);
                            totalSellingPrice += (sellingPrice * quantity);
                        });
                    }
                });
                UIElements.localTotalSalesTTC.textContent = `${totalSalesTTC.toFixed(2)} DH`;
                UIElements.localTotalProfit.textContent = `${totalProfit.toFixed(2)} DH`;
                UIElements.localInvoiceCount.textContent = localInvoices.length;
                UIElements.localTotalProductsSold.textContent = totalProductsSold;
                UIElements.localTotalPurchaseCost.textContent = `${totalPurchaseCost.toFixed(2)} DH`;
                UIElements.localTotalSellingPrice.textContent = `${totalSellingPrice.toFixed(2)} DH`;
                UIElements.localTotalCommission.textContent = `${totalCommission.toFixed(2)} DH`;
                UIElements.localTotalSalesHTAfterCommission.textContent = `${totalSalesHTAfterCommission.toFixed(2)} DH`;
                UIElements.localTotalTVA.textContent = `${totalTVA.toFixed(2)} DH`;
            },
        };
        const FirebaseSync = {
            getFirebasePath: (phoneIdentifier, type) => {
                if (!phoneIdentifier) {
                    return null;
                }
                const sanitizedPhone = phoneIdentifier.replace(/[.#$[\]]/g, '_');
                let dataPath;
                if (type === 'products') {
                    dataPath = 'inventoryProducts';
                } else if (type === 'invoices') {
                    dataPath = 'invoices';
                } else if (type === 'purchaseOrders') {
                    dataPath = 'purchaseOrders';
                } else {
                    return null;
                }
                return `${appId}/alldata/${sanitizedPhone}/${dataPath}`;
            },
            syncAllProductsToFirebase: async (ownerPhoneForSync) => {
                if (!database) {
                    UI.showToast(AppMessages.firebaseSyncSkipped, 'error');
                    return 0;
                }
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    UI.showToast(AppMessages.invalidPhoneForSync, 'warning');
                    return 0;
                }
                const allLocalProducts = DataStore.getSavedProducts();
                let productsSyncedCount = 0;
                const firebaseProductPath = FirebaseSync.getFirebasePath(ownerPhoneForSync, 'products');
                if (!firebaseProductPath) return 0;
                for (const product of allLocalProducts) {
                    try {
                        const productDataFirebaseKeys = mapToFirebaseKeys(product);
                        await database.ref(`${firebaseProductPath}/${productDataFirebaseKeys.id}`).set(productDataFirebaseKeys);
                        productsSyncedCount++;
                    } catch (error) {
                        UI.showToast(`فشل مزامنة المنتج ${product.name}: ${error.message}`, 'error');
                    }
                }
                return productsSyncedCount;
            },
            syncAllLocalInvoicesToFirebase: async (ownerPhoneForSync) => {
                if (!database) {
                    UI.showToast(AppMessages.firebaseSyncSkipped, 'error');
                    return 0;
                }
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    UI.showToast(AppMessages.invalidPhoneForSync, 'warning');
                    return 0;
                }
                const allInvoicesToSync = DataStore.getInvoices();
                let invoicesSyncedCount = 0;
                const firebaseInvoiceBaseRef = database.ref(FirebaseSync.getFirebasePath(ownerPhoneForSync, 'invoices'));
                if (!firebaseInvoiceBaseRef) return 0;
                for (const invoice of allInvoicesToSync) {
                    if (invoice.ownerPhone === ownerPhoneForSync) {
                        try {
                            const invoiceDataFirebaseKeys = mapToFirebaseKeys(invoice);
                            await firebaseInvoiceBaseRef.child(invoiceDataFirebaseKeys.id).set(invoiceDataFirebaseKeys);
                            invoicesSyncedCount++;
                        } catch (error) {
                            UI.showToast(`فشل مزامنة الفاتورة ${invoice.invoiceNumber}: ${error.message}`, 'error');
                        }
                    }
                }
                return invoicesSyncedCount;
            },
            syncAllLocalPurchaseOrdersToFirebase: async (ownerPhoneForSync) => {
                if (!database) {
                    UI.showToast(AppMessages.firebaseSyncSkipped, 'error');
                    return 0;
                }
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    UI.showToast(AppMessages.invalidPhoneForSync, 'warning');
                    return 0;
                }
                const allPurchaseOrdersToSync = DataStore.getPurchaseOrders();
                let poSyncedCount = 0;
                const firebasePoBaseRef = database.ref(FirebaseSync.getFirebasePath(ownerPhoneForSync, 'purchaseOrders'));
                if (!firebasePoBaseRef) return 0;
                for (const po of allPurchaseOrdersToSync) {
                    if (po.poOwnerPhone === ownerPhoneForSync) {
                        try {
                            const poDataFirebaseKeys = mapToFirebaseKeys(po);
                            await firebasePoBaseRef.child(poDataFirebaseKeys.id).set(poDataFirebaseKeys);
                            poSyncedCount++;
                        } catch (error) {
                            UI.showToast(`فشل مزامنة أمر الشراء ${po.poNumber}: ${error.message}`, 'error');
                        }
                    }
                }
                return poSyncedCount;
            },
            syncAllLocalDataToFirebaseOnLoad: async () => {
                DataStore.loadFormDefaults();
                const ownerPhoneForSync = UIElements.invoiceOwnerPhoneInput.value.trim();
                if (!navigator.onLine) {
                    return;
                }
                if (!database) {
                    return;
                }
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    UI.showToast(AppMessages.ownerPhoneInvalidOrEmpty, "warning");
                    return;
                }
                UI.showToast(AppMessages.syncingProducts, 'info');
                const productsSyncedCount = await FirebaseSync.syncAllProductsToFirebase(ownerPhoneForSync);
                if (productsSyncedCount > 0) {
                    UI.showToast(AppMessages.productsSyncedSuccess(productsSyncedCount), 'success');
                }
                UI.showToast(AppMessages.syncingInvoices, 'info');
                const invoicesSyncedCount = await FirebaseSync.syncAllLocalInvoicesToFirebase(ownerPhoneForSync);
                if (invoicesSyncedCount > 0) {
                    UI.showToast(AppMessages.invoicesSyncedSuccess(invoicesSyncedCount), 'success');
                }
                UI.showToast(AppMessages.syncingPOs, 'info');
                const poSyncedCount = await FirebaseSync.syncAllLocalPurchaseOrdersToFirebase(ownerPhoneForSync);
                if (poSyncedCount > 0) {
                    UI.showToast(AppMessages.posSyncedSuccess(poSyncedCount), 'success');
                }
            }
        };
        const DataManagement = {
            exportData: () => {
                const allProducts = DataStore.getSavedProducts();
                const allInvoices = DataStore.getInvoices();
                const allPurchaseOrders = DataStore.getPurchaseOrders();
                const stockMovementHistory = DataStore.getStockMovementHistory();
                
                const ownerPhone = localStorage.getItem('invoiceOwnerPhone');
                const ownerName = localStorage.getItem('invoiceOwner');
                const ownerAddress = localStorage.getItem('invoiceOwnerAddress');
                const companyName = localStorage.getItem('companyName');
                const tva = localStorage.getItem('tva');
                const invoiceCommissionAmount = localStorage.getItem('invoiceCommissionAmount');
                const exportDate = new Date().toISOString();
                const dataToExport = {
                    metadata: {
                        exportedAt: exportDate,
                        appId: appId,
                        ownerPhone: ownerPhone || 'N/A',
                        ownerName: ownerName || '',
                        ownerAddress: ownerAddress || '',
                        companyName: companyName || '',
                        tva: tva || '0',
                        invoiceCommissionAmount: invoiceCommissionAmount || '0',
                        description: "بيانات إدارة المبيعات والمخزون - نسخة احتياطية محلية"
                    },
                    products: allProducts,
                    invoices: allInvoices,
                    purchaseOrders: allPurchaseOrders,
                    stockMovementHistory: stockMovementHistory
                };
                const dataStr = JSON.stringify(dataToExport, null, 4);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_backup_${ownerPhone || 'unknown'}_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.showToast(AppMessages.exportedSuccess, 'success');
            },
            importData: async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    UI.showToast(AppMessages.noFileSelected, 'info');
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.products || !importedData.invoices) {
                            UI.showToast(AppMessages.invalidJsonFile, 'error');
                            return;
                        }
                        const importedOwnerPhone = importedData.metadata && importedData.metadata.ownerPhone ? importedData.metadata.ownerPhone : 'N/A';
                        const currentOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
                        const confirmed = await UI.showConfirmModal(
                            "تأكيد استيراد البيانات",
                            AppMessages.importConfirm(importedOwnerPhone, currentOwnerPhone)
                        );
                        if (!confirmed) {
                            UI.showToast(AppMessages.importCanceled, 'info');
                            UIElements.importDataInput.value = '';
                            return;
                        }
                        localStorage.setItem('savedProducts', JSON.stringify(importedData.products));
                        localStorage.setItem('localInvoices', JSON.stringify(importedData.invoices));
                        localStorage.setItem('localPurchaseOrders', JSON.stringify(importedData.purchaseOrders || []));
                        localStorage.setItem('stockMovementHistory', JSON.stringify(importedData.stockMovementHistory || []));
                        if (importedData.metadata) {
                            localStorage.setItem('invoiceOwnerPhone', importedData.metadata.ownerPhone || '');
                            localStorage.setItem('invoiceOwner', importedData.metadata.ownerName || '');
                            localStorage.setItem('invoiceOwnerAddress', importedData.metadata.ownerAddress || '');
                            localStorage.setItem('companyName', importedData.metadata.companyName || '');
                            localStorage.setItem('tva', importedData.metadata.tva || '0');
                            localStorage.setItem('invoiceCommissionAmount', importedData.metadata.invoiceCommissionAmount || '0');
                        } else if (importedData.invoices && importedData.invoices.length > 0) {
                            localStorage.setItem('invoiceOwnerPhone', importedData.invoices[0].ownerPhone || '');
                            localStorage.setItem('invoiceOwner', importedData.invoices[0].ownerName || '');
                            localStorage.setItem('invoiceOwnerAddress', importedData.invoices[0].ownerAddress || '');
                            localStorage.setItem('companyName', importedData.invoices[0].companyName || '');
                            localStorage.setItem('tva', importedData.invoices[0].tva || '0');
                            localStorage.setItem('invoiceCommissionAmount', '0');
                        }
                        if (importedData.products && importedData.products.length > 0) {
                            localStorage.setItem('supplierName', importedData.products[0].supplierName || '');
                            localStorage.setItem('supplierAddress', importedData.products[0].supplierAddress || '');
                            localStorage.setItem('supplierPhone', importedData.products[0].supplierPhone || '');
                        } else if (importedData.purchaseOrders && importedData.purchaseOrders.length > 0) {
                            localStorage.setItem('supplierName', importedData.purchaseOrders[0].orderedProducts[0]?.supplierName || '');
                            localStorage.setItem('supplierPhone', importedData.purchaseOrders[0].orderedProducts[0]?.supplierPhone || '');
                            localStorage.setItem('supplierAddress', importedData.purchaseOrders[0].poCompanyAddress || '');
                        }
                        DataStore.init();
                        SalesProducts.displaySavedProducts();
                        LocalArchive.displayLocalInvoices();
                        PurchaseOrderManager.displayLocalPurchaseOrders();
                        UI.populateAllDatalists();
                        DataStore.loadFormDefaults();
                        DataStore.calculateAndDisplayLocalInvoiceStats();
                        UI.showToast(AppMessages.importSuccess, 'success');
                        UIElements.importDataInput.value = '';
                    } catch (parseError) {
                        UI.showToast(AppMessages.jsonParseError, 'error');
                        UIElements.importDataInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
        };
        const Navigation = {
            init: () => {
                UIElements.desktopNavButtons.forEach(button => {
                    button.addEventListener('click', Navigation.handleNavClick);
                });
                UIElements.exportDataBtn.addEventListener('click', DataManagement.exportData);
                UIElements.importDataBtn.addEventListener('click', () => UIElements.importDataInput.click());
                UIElements.importDataInput.addEventListener('change', DataManagement.importData);
            },
            handleNavClick: async (event) => {
                if (isTransitioning) {
                    UI.showToast(AppMessages.transitionInProgress, 'info');
                    return;
                }
                const button = event.target.closest('.modern-button');
                if (!button) return;
                UI.setActiveButton(button, UIElements.desktopNavButtons);
                UIElements.searchProductInput.value = '';
                UIElements.clearSearchProductBtn.hidden = true;
                UIElements.searchLocalInvoiceInput.value = '';
                UIElements.clearSearchLocalInvoiceBtn.hidden = true;
                UIElements.searchLocalPo.value = '';
                UIElements.clearSearchLocalPoBtn.hidden = true;
                try {
                    if (button.id.includes('Dashboard')) {
                        await UI.showSection(UIElements.mainDashboardView);
                        SalesProducts.displaySavedProducts();
                    } else if (button.id.includes('LocalArchive')) {
                        await UI.showSection(UIElements.localArchiveView);
                        LocalArchive.displayLocalInvoices();
                        DataStore.calculateAndDisplayLocalInvoiceStats();
                    } else if (button.id.includes('PurchaseOrderSection')) {
                        await UI.showSection(UIElements.purchaseOrderSection);
                        PurchaseOrderManager.displayLocalPurchaseOrders();
                        PurchaseOrderManager.loadPurchaseOrderFormDefaults();
                    }
                    UI.populateAllDatalists();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (error) {
                    UI.showToast("حدث خطأ أثناء التنقل بين الأقسام.", 'error');
                    isTransitioning = false;
                }
            }
        };
        const SalesProducts = {
            init: () => {
                UIElements.productForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const submitButton = e.submitter;
                    if (submitButton === UIElements.addProductButton) {
                        SalesProducts.handleProductFormSubmission(null);
                    } else if (submitButton === UIElements.saveEditProductButton) {
                        const idToEdit = submitButton.dataset.editingId;
                        SalesProducts.handleProductFormSubmission(parseInt(idToEdit));
                    }
                });
                UIElements.cancelEditProductButton.addEventListener('click', () => {
                    SalesProducts.resetProductFormAndButtons();
                    UI.showToast(AppMessages.productEditCanceled, 'info');
                    SalesProducts.displaySavedProducts();
                });
                UIElements.savedProductsList.addEventListener('click', SalesProducts.handleProductListClick);
                UIElements.savedProductsList.addEventListener('change', SalesProducts.handleProductListChange);
                UIElements.searchProductInput.addEventListener('input', debounce(() => {
                    SalesProducts.displaySavedProducts();
                    UIElements.clearSearchProductBtn.hidden = UIElements.searchProductInput.value === '';
                }, 300));
                UIElements.clearSearchProductBtn.addEventListener('click', () => {
                    UIElements.searchProductInput.value = '';
                    UIElements.clearSearchProductBtn.hidden = true;
                    SalesProducts.displaySavedProducts();
                });
            },
            handleProductFormSubmission: async (productId = null) => {
                const isEditing = productId !== null;
                const submitBtn = isEditing ? UIElements.saveEditProductButton : UIElements.addProductButton;
                UI.toggleButtonLoading(submitBtn, true);
                UI.resetValidationMessages(UIElements.productForm);
                if (!Validation.checkFormFields(UIElements.productForm)) {
                    UI.showToast(AppMessages.formValidationFailed, 'error');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }
                const productData = {
                    id: productId,
                    name: UIElements.productNameInput.value.trim(),
                    purchasePrice: parseFloat(UIElements.purchasePriceInput.value),
                    sellingPrice: parseFloat(UIElements.sellingPriceInput.value),
                    minStockQuantity: parseInt(UIElements.minStockQuantityInput.value || 0),
                    unitOfMeasure: UIElements.unitOfMeasureInput.value.trim() || 'قطعة',
                    supplierName: UIElements.supplierNameInput.value.trim(),
                    supplierAddress: UIElements.supplierAddressInput.value.trim(),
                    supplierPhone: UIElements.supplierPhoneInput.value.trim(),
                    stockQuantity: parseInt(UIElements.productQuantityInput.value),
                    date: new Date().toLocaleDateString('ar-MA', { year: 'numeric', month: 'long', day: 'numeric' }),
                    quantity: 0,
                    purchaseOrderQuantity: 0,
                    isLocal: true
                };
                localStorage.setItem('supplierName', productData.supplierName);
                localStorage.setItem('supplierAddress', productData.supplierAddress);
                localStorage.setItem('supplierPhone', productData.supplierPhone);
                const products = DataStore.getSavedProducts();
                const duplicateCheck = products.some((p) =>
                    (isEditing ? p.id !== productId : true) &&
                    (p.name || '').toLowerCase() === productData.name.toLowerCase() &&
                    (p.supplierPhone || '').toLowerCase() === (productData.supplierPhone || '').toLowerCase()
                );
                if (duplicateCheck) {
                    UI.showToast(AppMessages.duplicateProduct, 'info');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }
                const confirmed = await UI.showConfirmModal(
                    isEditing ? "تأكيد التعديل" : "تأكيد الإضافة",
                    isEditing ? AppMessages.productEditConfirm : AppMessages.productAddConfirm
                );
                if (!confirmed) {
                    UI.showToast(isEditing ? AppMessages.productEditCanceled : AppMessages.productAddCanceled, 'info');
                    UI.toggleButtonLoading(submitBtn, false);
                    return;
                }
                await DataStore.saveProduct(productData, isEditing);
                SalesProducts.displaySavedProducts();
                SalesProducts.resetProductFormAndButtons();
                UI.populateAllDatalists();
                UI.toggleButtonLoading(submitBtn, false);
            },
            resetProductFormAndButtons: () => {
                UIElements.productForm.reset();
                UIElements.productFormTitle.innerHTML = '<i class="fas fa-box"></i> إدارة المنتجات';
                UIElements.addProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.style.display = 'none';
                UIElements.cancelEditProductButton.style.display = 'none';
                delete UIElements.saveEditProductButton.dataset.editingId;
                UI.resetValidationMessages(UIElements.productForm);
                UIElements.supplierNameInput.value = localStorage.getItem('supplierName') || '';
                UIElements.supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
                UIElements.supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
                UIElements.unitOfMeasureInput.value = '';
            },
            editProduct: async (productId) => {
                const productToEdit = DataStore.getSavedProducts().find(p => p.id === productId);
                if (!productToEdit) {
                    UI.showToast(AppMessages.productNotFound, 'error');
                    return;
                }
                if (UIElements.mainDashboardView.hidden) {
                    await UI.showSection(UIElements.mainDashboardView);
                    UI.setActiveButton(UIElements.desktopNavButtons[0], UIElements.desktopNavButtons);
                }
                SalesProducts.resetProductFormAndButtons();
                UIElements.productFormTitle.innerHTML = '<i class="fas fa-edit"></i> تعديل المنتج';
                UIElements.productNameInput.value = productToEdit.name || '';
                UIElements.purchasePriceInput.value = productToEdit.purchasePrice || 0;
                UIElements.sellingPriceInput.value = productToEdit.sellingPrice || 0;
                UIElements.minStockQuantityInput.value = productToEdit.minStockQuantity || 0;
                UIElements.unitOfMeasureInput.value = productToEdit.unitOfMeasure || '';
                UIElements.supplierNameInput.value = productToEdit.supplierName || '';
                UIElements.supplierAddressInput.value = productToEdit.supplierAddress || '';
                UIElements.supplierPhoneInput.value = productToEdit.supplierPhone || '';
                UIElements.productQuantityInput.value = productToEdit.stockQuantity || 0;
                UIElements.addProductButton.style.display = 'none';
                UIElements.saveEditProductButton.style.display = 'flex';
                UIElements.cancelEditProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.dataset.editingId = productId;
                window.scrollTo({ top: UIElements.productFormContainer.offsetTop, behavior: 'smooth' });
                UI.populateAllDatalists();
            },
            deleteProduct: async (id) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", AppMessages.productDeleteConfirm);
                if (confirmed) {
                    await DataStore.deleteProduct(id);
                    SalesProducts.displaySavedProducts();
                    UI.populateAllDatalists();
                    UI.updateProductCountInCart();
                } else {
                    UI.showToast(AppMessages.productDeleteCanceled, 'info');
                }
            },
            getProductStatusPriority: (quantitySelected, stockQuantity, minStockQuantity) => {
                if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1;
                if (stockQuantity <= 0) return 2;
                if (quantitySelected > 0) return 3;
                if (stockQuantity <= minStockQuantity) return 4;
                return 5;
            },
            createProductCard: (product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-card-item';
                productDiv.dataset.id = product.id;
                UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0, product.minStockQuantity || 0);
                const productInfoDiv = document.createElement('div');
                productInfoDiv.className = 'product-info';
                productInfoDiv.innerHTML = `
                    <p>${product.name || 'N/A'}</p>
                    <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} درهم</p>
                    <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} درهم</p>
                    ${product.unitOfMeasure ? `<p><strong>وحدة القياس:</strong> ${product.unitOfMeasure}</p>` : ''}
                `;
                productDiv.appendChild(productInfoDiv);
                const supplierInfoDiv = document.createElement('div');
                supplierInfoDiv.className = 'supplier-info';
                supplierInfoDiv.innerHTML = `
                    <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                    <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                `;
                productDiv.appendChild(supplierInfoDiv);
                const stockSectionDiv = document.createElement('div');
                stockSectionDiv.className = 'stock-section';
                stockSectionDiv.innerHTML = `
                    <p>الكمية في المخزون: ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) <= (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0 ? '<span style="color: var(--modern-alert); font-weight: bold;">(منخفض!)</span>' : (product.stockQuantity || 0) <= 0 ? '<span style="color: var(--modern-error); font-weight: bold;">(نفد المخزون)</span>' : ''}</p>
                    <div class="quantity-controls">
                        <button type="button" class="qty-adjust-btn" data-action="plus" data-target-input="stock-input" aria-label="زيادة كمية المخزون">+</button>
                        <input type="number" value="${product.stockQuantity || 0}" min="0" data-product-id="${product.id}" class="form-input stock-input">
                        <button type="button" class="qty-adjust-btn" data-action="minus" data-target-input="stock-input" aria-label="نقص كمية المخزون">-</button>
                    </div>
                `;
                productDiv.appendChild(stockSectionDiv);
                const minStockSectionDiv = document.createElement('div');
                minStockSectionDiv.className = 'min-stock-section';
                minStockSectionDiv.innerHTML = `
                    <p>الحد الأدنى للمخزون: ${product.minStockQuantity || 0}</p>
                    <div class="quantity-controls">
                        <button type="button" class="qty-adjust-btn" data-action="plus" data-target-input="min-stock-input" aria-label="زيادة الحد الأدنى للمخزون">+</button>
                        <input type="number" value="${product.minStockQuantity || 0}" min="0" data-product-id="${product.id}" class="form-input min-stock-input">
                        <button type="button" class="qty-adjust-btn" data-action="minus" data-target-input="min-stock-input" aria-label="نقص الحد الأدنى للمخزون">-</button>
                    </div>
                `;
                productDiv.appendChild(minStockSectionDiv);
                const invoiceQuantitySectionDiv = document.createElement('div');
                invoiceQuantitySectionDiv.className = 'invoice-quantity-section';
                invoiceQuantitySectionDiv.innerHTML = `
                    <p>الكمية المحددة للفاتورة:</p>
                    <div class="quantity-controls">
                        <button type="button" class="qty-adjust-btn" data-action="plus" data-target-input="invoice-quantity-input" aria-label="زيادة كمية الفاتورة">+</button>
                        <input type="number" class="form-input invoice-quantity-input" data-id="${product.id}" value="${product.quantity || 0}" min="0">
                        <button type="button" class="qty-adjust-btn" data-action="minus" data-target-input="invoice-quantity-input" aria-label="نقص كمية الفاتورة">-</button>
                    </div>
                `;
                productDiv.appendChild(invoiceQuantitySectionDiv);
                const poQuantitySectionDiv = document.createElement('div');
                poQuantitySectionDiv.className = 'po-quantity-section';
                poQuantitySectionDiv.innerHTML = `
                    <p>الكمية المطلوبة لأمر الشراء:</p>
                    <div class="quantity-controls">
                        <button type="button" class="qty-adjust-btn" data-action="plus" data-target-input="po-quantity-input" aria-label="زيادة كمية أمر الشراء">+</button>
                        <input type="number" class="form-input po-quantity-input" data-id="${product.id}" value="${product.purchaseOrderQuantity || 0}" min="0">
                        <button type="button" class="qty-adjust-btn" data-action="minus" data-target-input="po-quantity-input" aria-label="نقص كمية أمر الشراء">-</button>
                    </div>
                `;
                productDiv.appendChild(poQuantitySectionDiv);
                const actionsFooterDiv = document.createElement('div');
                actionsFooterDiv.className = 'product-actions-footer';
                actionsFooterDiv.innerHTML = `
                    <button type="button" class="modern-button btn-danger-action" data-product-id="${product.id}" aria-label="حذف المنتج">
                        <i class="fas fa-trash-alt btn-icon"></i> حذف
                    </button>
                    <button type="button" class="modern-button btn-warning-action" data-product-id="${product.id}" aria-label="تعديل المنتج">
                        <i class="fas fa-edit btn-icon"></i> تعديل
                    </button>
                `;
                productDiv.appendChild(actionsFooterDiv);
                return productDiv;
            },
            updateProductCardUI: (product) => {
                const productDiv = UIElements.savedProductsList.querySelector(`.product-card-item[data-id="${product.id}"]`);
                if (!productDiv) {
                    SalesProducts.displaySavedProducts();
                    return;
                }
                const stockSpan = productDiv.querySelector('.stock-section p');
                if (stockSpan) {
                    stockSpan.innerHTML = `الكمية في المخزون: ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) <= (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0 ? '<span style="color: var(--modern-alert); font-weight: bold;">(منخفض!)</span>' : (product.stockQuantity || 0) <= 0 ? '<span style="color: var(--modern-error); font-weight: bold;">(نفد المخزون)</span>' : ''}`;
                }
                const minStockInput = productDiv.querySelector('.min-stock-input');
                if (minStockInput) {
                    minStockInput.value = product.minStockQuantity || 0;
                }
                const invoiceQuantityInput = productDiv.querySelector('.invoice-quantity-input');
                if (invoiceQuantityInput) {
                    invoiceQuantityInput.value = product.quantity || 0;
                }
                const poQuantityInput = productDiv.querySelector('.po-quantity-input');
                if (poQuantityInput) {
                    poQuantityInput.value = product.purchaseOrderQuantity || 0;
                }
                const productInfoName = productDiv.querySelector('.product-info p:first-child');
                if (productInfoName) productInfoName.textContent = product.name || 'N/A';
                
                const purchasePriceP = productDiv.querySelector('.product-info p:nth-child(2)');
                if (purchasePriceP) purchasePriceP.innerHTML = `<strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} درهم`;
                const sellingPriceP = productDiv.querySelector('.product-info p:nth-child(3)');
                if (sellingPriceP) sellingPriceP.innerHTML = `<strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} درهم`;
                let unitOfMeasureP = productInfoDiv.querySelector('p:nth-child(4)');
                if (product.unitOfMeasure) {
                    if (!unitOfMeasureP) {
                        unitOfMeasureP = document.createElement('p');
                        productInfoDiv.insertBefore(unitOfMeasureP, productInfoDiv.children[3]);
                    }
                    unitOfMeasureP.innerHTML = `<strong>وحدة القياس:</strong> ${product.unitOfMeasure}`;
                } else if (unitOfMeasureP && unitOfMeasureP.textContent.includes('وحدة القياس')) {
                    unitOfMeasureP.remove();
                }
                UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0, product.minStockQuantity || 0);
            },
            displaySavedProducts: () => {
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, true);
                const searchTerm = UIElements.searchProductInput.value.toLowerCase();
                const savedProducts = DataStore.getSavedProducts();
                UIElements.savedProductsList.innerHTML = '';
                const filteredProducts = savedProducts
                    .filter(product => (product.name || '').toLowerCase().includes(searchTerm) ||
                                        (product.supplierName || '').toLowerCase().includes(searchTerm))
                    .sort((a, b) => {
                        const statusA = SalesProducts.getProductStatusPriority(a.quantity || 0, a.stockQuantity || 0, a.minStockQuantity || 0);
                        const statusB = SalesProducts.getProductStatusPriority(b.quantity || 0, b.stockQuantity || 0, b.minStockQuantity || 0);
                        if (statusA !== statusB) return statusA - statusB;
                        if ((b.stockQuantity || 0) !== (a.stockQuantity || 0)) {
                            return (b.stockQuantity || 0) - (a.stockQuantity || 0);
                        }
                        return (a.name || '').localeCompare(b.name || '');
                    });
                if (filteredProducts.length === 0) {
                    UIElements.emptyProductsMessage.style.display = 'flex';
                    UIElements.savedProductsList.appendChild(UIElements.emptyProductsMessage);
                } else {
                    UIElements.emptyProductsMessage.style.display = 'none';
                    filteredProducts.forEach((product) => {
                        UIElements.savedProductsList.appendChild(SalesProducts.createProductCard(product));
                    });
                }
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, false);
                UI.updateProductCountInCart();
            },
            handleProductListClick: (event) => {
                const target = event.target;
                const productDiv = target.closest('.product-card-item');
                if (!productDiv) return;
                const productId = parseInt(productDiv.dataset.id);
                if (isNaN(productId)) return;
                if (target.classList.contains('btn-warning-action') || target.closest('.btn-warning-action')) {
                    SalesProducts.editProduct(productId);
                } else if (target.classList.contains('btn-danger-action') || target.closest('.btn-danger-action')) {
                    SalesProducts.deleteProduct(productId);
                } else if (target.classList.contains('qty-adjust-btn')) {
                    const targetInputClass = target.dataset.targetInput;
                    const inputElement = productDiv.querySelector(`.${targetInputClass}`);
                    if (!inputElement) return;
                    let currentVal = parseInt(inputElement.value) || 0;
                    currentVal += (target.dataset.action === 'plus' ? 1 : -1);
                    inputElement.value = Math.max(0, currentVal);
                    const changeEvent = new Event('change', { bubbles: true });
                    inputElement.dispatchEvent(changeEvent);
                }
            },
            handleProductListChange: (event) => {
                const target = event.target;
                if (target.classList.contains('stock-input') || target.classList.contains('min-stock-input') || target.classList.contains('invoice-quantity-input') || target.classList.contains('po-quantity-input')) {
                    const productDiv = target.closest('.product-card-item');
                    if (!productDiv) return;
                    const productId = parseInt(productDiv.dataset.id);
                    if (isNaN(productId)) return;
                    const newValue = parseInt(target.value || 0);
                    if (target.classList.contains('stock-input')) {
                        DataStore.updateProductStock(productId, newValue);
                    } else if (target.classList.contains('min-stock-input')) {
                        DataStore.updateProductMinStock(productId, newValue);
                    } else if (target.classList.contains('invoice-quantity-input')) {
                        DataStore.updateProductInvoiceQuantity(productId, newValue);
                    } else if (target.classList.contains('po-quantity-input')) {
                        DataStore.updateProductPurchaseOrderQuantity(productId, newValue);
                    }
                }
            }
        };
        const InvoiceManager = {
            init: () => {
                UIElements.createInvoiceButton.addEventListener('click', InvoiceManager.previewInvoice); // Changed to previewInvoice
                UIElements.updateStockAndSaveInvoiceButton.addEventListener('click', InvoiceManager.updateStockAndSaveInvoice); // Added listener for new button
                UIElements.printButton.addEventListener('click', InvoiceManager.printInvoice);
                UIElements.cancelInvoiceButton.addEventListener('click', InvoiceManager.cancelInvoiceProcess);
                UIElements.customerNameInput.addEventListener('change', () => localStorage.setItem('customerName', UIElements.customerNameInput.value));
                UIElements.companyNameInput.addEventListener('change', () => localStorage.setItem('companyName', UIElements.companyNameInput.value));
                UIElements.invoiceOwnerInput.addEventListener('change', () => localStorage.setItem('invoiceOwner', UIElements.invoiceOwnerInput.value));
                UIElements.invoiceOwnerPhoneInput.addEventListener('change', () => localStorage.setItem('invoiceOwnerPhone', UIElements.invoiceOwnerPhoneInput.value));
                UIElements.invoiceOwnerAddressInput.addEventListener('change', () => localStorage.setItem('invoiceOwnerAddress', UIElements.invoiceOwnerAddressInput.value));
                UIElements.tvaInput.addEventListener('change', () => localStorage.setItem('tva', UIElements.tvaInput.value));
                UIElements.invoiceCommissionAmountInput.addEventListener('change', () => localStorage.setItem('invoiceCommissionAmount', UIElements.invoiceCommissionAmountInput.value));
            },
            generateInvoiceNumber: () => {
                const lastInvoiceNumber = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');
                const newInvoiceNumber = lastInvoiceNumber + 1;
                localStorage.setItem('lastInvoiceNumber', newInvoiceNumber);
                return `INV-${String(newInvoiceNumber).padStart(5, '0')}`;
            },
            // Renamed from createAndSaveInvoice to previewInvoice
            previewInvoice: async () => { 
                UI.toggleButtonLoading(UIElements.createInvoiceButton, true);
                UI.resetValidationMessages(UIElements.invoiceForm);
                if (!Validation.checkFormFields(UIElements.invoiceForm)) {
                    UI.showToast(AppMessages.formValidationFailed, 'error');
                    UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                    return;
                }
                const ownerPhoneForInvoice = UIElements.invoiceOwnerPhoneInput.value.trim();
                if (!ownerPhoneForInvoice || !Validation.checkPhoneFormat(ownerPhoneForInvoice)) {
                    UI.showToast(AppMessages.invoiceOwnerPhoneRequired, 'error');
                    UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                    return;
                }
                let allSavedProducts = DataStore.getSavedProducts();
                let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);
                let productsToProcessForInvoice = [];
                if (selectedProductsForInvoice.length === 0) {
                    const confirmed = await UI.showConfirmModal(
                        "تحديد المنتجات",
                        AppMessages.noProductsForInvoice
                    );
                    if (confirmed) {
                        productsToProcessForInvoice = allSavedProducts.map(product => ({ ...product, quantityUsed: 1 }));
                        productsToProcessForInvoice = productsToProcessForInvoice.filter(p => p.quantityUsed > 0);
                        if (productsToProcessForInvoice.length === 0) {
                            UI.showToast(AppMessages.noProductsAfterDefault, 'info');
                            UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                            return;
                        }
                    } else {
                        UI.showToast(AppMessages.invoiceCreationCanceledNoProducts, 'info');
                        UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                        return;
                    }
                } else {
                    productsToProcessForInvoice = selectedProductsForInvoice.map(product => ({ ...product, quantityUsed: product.quantity }));
                }
                let hasInsufficientStockWarning = false;
                for (const invoiceProduct of productsToProcessForInvoice) {
                    const productMatch = allSavedProducts.find(p => p.id === invoiceProduct.id);
                    const quantityUsedInInvoice = parseInt(invoiceProduct.quantityUsed || 0);
                    if (productMatch) {
                        const currentStock = parseInt(productMatch.stockQuantity || 0);
                        if (currentStock < quantityUsedInInvoice) {
                            hasInsufficientStockWarning = true;
                            UI.showToast(AppMessages.insufficientStockWarning(invoiceProduct.name, quantityUsedInInvoice, currentStock), 'warning');
                        }
                    } else if (quantityUsedInInvoice > 0) {
                        hasInsufficientStockWarning = true;
                        UI.showToast(AppMessages.productNotInLocalStock(invoiceProduct.name), 'error');
                    }
                }
                if (hasInsufficientStockWarning) {
                    const confirmed = await UI.showConfirmModal(
                        "تنبيه المخزون غير الكافي",
                        AppMessages.insufficientStockProceedConfirm
                    );
                    if (!confirmed) {
                        UI.showToast(AppMessages.invoiceCanceledInsufficientStock, 'info');
                        UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                        return;
                    }
                }
                let totalHTBeforeCommission = 0;
                let totalProfitCalculated = 0;
                const invoiceCommissionAmount = parseFloat(UIElements.invoiceCommissionAmountInput.value) || 0;
                let totalCommission = invoiceCommissionAmount;
                productsToProcessForInvoice.forEach(invoiceProduct => {
                    totalHTBeforeCommission += (invoiceProduct.sellingPrice || 0) * (invoiceProduct.quantityUsed || 0);
                    totalProfitCalculated += ((invoiceProduct.sellingPrice || 0) - (invoiceProduct.purchasePrice || 0)) * (invoiceProduct.quantityUsed || 0);
                });
                const finalTotalHT = totalHTBeforeCommission - totalCommission;
                const tvaRate = parseFloat(UIElements.tvaInput.value) / 100;
                const tvaCalculated = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tvaCalculated)).toFixed(2);
                totalProfitCalculated -= totalCommission;
                currentInvoiceBeingProcessed = {
                    id: Date.now(), // Will be actual ID if saved
                    invoiceNumber: InvoiceManager.generateInvoiceNumber(), // Generate here for preview
                    date: UIElements.invoiceDateInput.value,
                    isoDate: UIElements.invoiceDateInput.dataset.isoDate,
                    customerName: UIElements.customerNameInput.value,
                    companyName: UIElements.companyNameInput.value.trim(),
                    ownerName: UIElements.invoiceOwnerInput.value,
                    ownerAddress: UIElements.invoiceOwnerAddressInput.value,
                    ownerPhone: UIElements.invoiceOwnerPhoneInput.value,
                    products: productsToProcessForInvoice,
                    totalHT: parseFloat(finalTotalHT).toFixed(2),
                    totalHTBeforeCommission: parseFloat(totalHTBeforeCommission).toFixed(2),
                    tva: parseFloat(tvaCalculated).toFixed(2),
                    totalTTC: parseFloat(totalTTC).toFixed(2),
                    totalProfit: parseFloat(totalProfitCalculated).toFixed(2),
                    totalCommission: parseFloat(totalCommission).toFixed(2),
                    invoiceCommissionRate: parseFloat(UIElements.tvaInput.value),
                };
                isNewInvoice = true; // Mark as a new invoice being processed
                await UI.showSection(UIElements.invoiceDisplay);
                InvoiceManager.displayFullInvoice(currentInvoiceBeingProcessed, isNewInvoice); // Pass isNewInvoice flag
                UI.populateAllDatalists();
                UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
            },
            // New function for actual stock update and save
            updateStockAndSaveInvoice: async function () {
                UI.toggleButtonLoading(this, true);
                if (!currentInvoiceBeingProcessed || !isNewInvoice) {
                    UI.showToast(AppMessages.invoiceNotNewError, 'info');
                    UI.toggleButtonLoading(this, false);
                    return;
                }
                
                const ownerPhone = UIElements.invoiceOwnerPhoneInput.value.trim();
                if (!ownerPhone || !Validation.checkPhoneFormat(ownerPhone)) {
                    UI.showToast(AppMessages.invoiceOwnerPhoneRequired, 'error');
                    UI.toggleButtonLoading(this, false);
                    return;
                }
                const confirmed = await UI.showConfirmModal("تأكيد تحديث المخزون والحفظ", AppMessages.stockUpdateConfirm);
                if (!confirmed) {
                    UI.showToast(AppMessages.stockUpdateCanceled, 'info');
                    UI.toggleButtonLoading(this, false);
                    return;
                }
                try {
                    let allSavedProducts = DataStore.getSavedProducts();
                    let productsToDeduct = [];
                    let insufficientStockFound = false; // Re-check actual stock just before saving
                    for (const invoiceProduct of currentInvoiceBeingProcessed.products) {
                        const productMatch = allSavedProducts.find(p => p.id === invoiceProduct.id);
                        const quantityUsedInInvoice = parseInt(invoiceProduct.quantityUsed || 0);
                        if (productMatch) {
                            const currentStock = parseInt(productMatch.stockQuantity || 0);
                            if (currentStock < quantityUsedInInvoice) {
                                insufficientStockFound = true;
                                UI.showToast(AppMessages.insufficientStockWarning(invoiceProduct.name, quantityUsedInInvoice, currentStock), 'error');
                            }
                            productsToDeduct.push({
                                productId: productMatch.id,
                                quantityUsed: quantityUsedInInvoice
                            });
                        } else if (quantityUsedInInvoice > 0) {
                            insufficientStockFound = true;
                            UI.showToast(AppMessages.productNotInLocalStock(invoiceProduct.name), 'error');
                        }
                    }
                    if (insufficientStockFound) {
                        UI.showToast("يرجى مراجعة المنتجات ذات المخزون غير الكافي أو غير الموجودة قبل التحديث النهائي.", 'error');
                        UI.toggleButtonLoading(this, false);
                        return;
                    }
                    productsToDeduct.forEach(({ productId, quantityUsed }) => {
                        const productIndex = allSavedProducts.findIndex(p => p.id === productId);
                        if (productIndex !== -1) {
                            allSavedProducts[productIndex].stockQuantity = (allSavedProducts[productIndex].stockQuantity || 0) - quantityUsed;
                            allSavedProducts[productIndex].stockQuantity = Math.max(0, allSavedProducts[productIndex].stockQuantity);
                            allSavedProducts[productIndex].quantity = 0;
                            DataStore.addStockMovement({
                                productId: allSavedProducts[productIndex].id,
                                productName: allSavedProducts[productIndex].name,
                                type: 'بيع',
                                quantityChange: -quantityUsed,
                                newStockQuantity: allSavedProducts[productIndex].stockQuantity,
                                date: new Date().toISOString(),
                                relatedInvoiceId: currentInvoiceBeingProcessed.id,
                            });
                        }
                    });
                    DataStore.setSavedProducts(allSavedProducts);
                    SalesProducts.displaySavedProducts(); // Refresh main product list
                    // Ensure the invoice is saved with its final ID. If it was a preview, give it a final ID
                    if (currentInvoiceBeingProcessed.id === null || currentInvoiceBeingProcessed.invoiceNumber === null) {
                        currentInvoiceBeingProcessed.id = Date.now();
                        currentInvoiceBeingProcessed.invoiceNumber = InvoiceManager.generateInvoiceNumber();
                    }
                    DataStore.saveInvoiceToLocal(currentInvoiceBeingProcessed);
                    DataStore.calculateAndDisplayLocalInvoiceStats();
                    UI.showToast(AppMessages.invoiceUpdateSaveSuccess, 'success');
                    currentInvoiceBeingProcessed = null;
                    isNewInvoice = false;
                    
                    await UI.showSection(UIElements.localArchiveView);
                    LocalArchive.displayLocalInvoices();
                    UI.populateAllDatalists();
                } catch (error) {
                    UI.showToast(AppMessages.criticalError(error.message), 'error');
                } finally {
                    UI.toggleButtonLoading(this, false);
                }
            },
            printInvoice: function () {
                if (!currentInvoiceBeingProcessed) {
                    UI.showToast("لا توجد فاتورة لعرضها للطباعة.", 'info');
                    return;
                }
                // Update owner/company details
                UIElements.printCompanyName.textContent = currentInvoiceBeingProcessed.companyName || 'اسم شركتك هنا';
                UIElements.printInvoiceOwner.textContent = currentInvoiceBeingProcessed.ownerName || 'N/A';
                UIElements.printInvoiceOwnerAddress.textContent = currentInvoiceBeingProcessed.ownerAddress || 'N/A';
                UIElements.printInvoiceOwnerPhone.textContent = currentInvoiceBeingProcessed.ownerPhone || 'N/A';
                
                // Update invoice/customer details
                UIElements.printInvoiceNumber.textContent = currentInvoiceBeingProcessed.invoiceNumber || 'N/A';
                UIElements.printInvoiceDate.textContent = currentInvoiceBeingProcessed.date || 'N/A';
                UIElements.printCustomerName.textContent = currentInvoiceBeingProcessed.customerName || 'N/A';
                // Removed: UIElements.printCustomerCompany.textContent = currentInvoiceBeingProcessed.companyName || 'N/A'; 

                UIElements.printInvoiceDetailsBody.innerHTML = '';
                let productNumber = 1;
                if (currentInvoiceBeingProcessed.products && currentInvoiceBeingProcessed.products.length > 0) {
                    currentInvoiceBeingProcessed.products.forEach(product => {
                        const row = document.createElement('tr');
                        const productTotalHT = (parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2);
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} درهم</td>
                            <td>${product.quantityUsed || 0}</td>
                            <td>${productTotalHT} درهم</td>
                        `;
                        UIElements.printInvoiceDetailsBody.appendChild(row);
                    });
                } else {
                    const noProductsRow = document.createElement('tr');
                    noProductsRow.innerHTML = `<td colspan="5" class="text-center italic text-modern-text-secondary">لا توجد منتجات في هذه الفاتورة.</td>`;
                    UIElements.printInvoiceDetailsBody.appendChild(noProductsRow);
                }
                
                // Update summary details (now in the table footer)
                UIElements.printTotalAmountBeforeCommission.textContent = `${parseFloat(currentInvoiceBeingProcessed.totalHTBeforeCommission || 0).toFixed(2)} درهم`;
                UIElements.printCommissionDeducted.textContent = `${parseFloat(currentInvoiceBeingProcessed.totalCommission || 0).toFixed(2)} درهم`;
                UIElements.printTotalAmount.textContent = `${parseFloat(currentInvoiceBeingProcessed.totalHT || 0).toFixed(2)} درهم`;
                UIElements.printTVA.textContent = `${parseFloat(currentInvoiceBeingProcessed.tva || 0).toFixed(2)} درهم`;
                UIElements.printTotalTTC.textContent = `${parseFloat(currentInvoiceBeingProcessed.totalTTC || 0).toFixed(2)} درهم`;
                // UIElements.printTotalProfit.textContent = `${parseFloat(currentInvoiceBeingProcessed.totalProfit || 0).toFixed(2)} درهم`; // Profit row is now hidden via CSS

                UIElements.printInvoiceTemplate.style.display = 'block';
                document.body.classList.add('printing-active');
                window.print();
                setTimeout(() => {
                    UIElements.printInvoiceTemplate.style.display = 'none';
                    document.body.classList.remove('printing-active');
                    UI.showToast(AppMessages.invoicePrintSuccess, 'success');
                }, 500);
            },
            // isNew parameter to control visibility of updateStockAndSaveInvoiceButton
            displayFullInvoice: async (invoiceData, isNew = false) => { 
                await UI.showSection(UIElements.invoiceDisplay);
                UIElements.displayInvoiceNumber.textContent = invoiceData.invoiceNumber || 'N/A';
                UIElements.displayCustomerName.textContent = invoiceData.customerName || 'N/A';
                UIElements.displayCompanyName.textContent = invoiceData.companyName || 'N/A';
                UIElements.displayInvoiceOwner.textContent = invoiceData.ownerName || 'N/A';
                UIElements.displayInvoiceDate.textContent = invoiceData.date || 'N/A';
                UIElements.displayInvoiceDate.setAttribute('datetime', invoiceData.isoDate || '');
                UIElements.displayInvoiceOwnerAddress.textContent = invoiceData.ownerAddress || 'N/A';
                UIElements.displayInvoiceOwnerPhone.textContent = invoiceData.ownerPhone || 'N/A';
                UIElements.displayTotalAmountBeforeCommission.textContent = `${parseFloat(invoiceData.totalHTBeforeCommission || 0).toFixed(2)} درهم`;
                UIElements.displayCommissionDeducted.textContent = `${parseFloat(invoiceData.totalCommission || 0).toFixed(2)} درهم`;
                UIElements.displayTotalAmount.textContent = `${parseFloat(invoiceData.totalHT || 0).toFixed(2)} درهم`;
                UIElements.displayTVA.textContent = `${parseFloat(invoiceData.tva || 0).toFixed(2)} درهم`;
                UIElements.displayTotalTTC.textContent = `${parseFloat(invoiceData.totalTTC || 0).toFixed(2)} درهم`;
                UIElements.displayTotalProfit.textContent = `${parseFloat(invoiceData.totalProfit || 0).toFixed(2)} درهم`;
                UIElements.displayDetails.innerHTML = '';
                let productNumber = 1;
                if (invoiceData.products && invoiceData.products.length > 0) {
                    invoiceData.products.forEach(product => {
                        const row = document.createElement('tr');
                        const productTotalHT = (parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2);
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} درهم</td>
                            <td>${product.quantityUsed || 0}</td>
                            <td>${productTotalHT} درهم</td>
                        `;
                        UIElements.displayDetails.appendChild(row);
                    });
                } else {
                    const noProductsRow = document.createElement('tr');
                    noProductsRow.innerHTML = `<td colspan="5" class="text-center italic text-modern-text-secondary">لا توجد منتجات في هذه الفاتورة.</td>`;
                    UIElements.displayDetails.appendChild(noProductsRow);
                }
                // Show "Update Stock and Save" button only if it's a new invoice being previewed
                UIElements.updateStockAndSaveInvoiceButton.style.display = isNew ? 'flex' : 'none'; 
                currentInvoiceBeingProcessed = invoiceData; // Set the invoice data for saving
                isNewInvoice = isNew; // Update the global flag
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            cancelInvoiceProcess: async () => {
                const confirmed = await UI.showConfirmModal("إلغاء الفاتورة", AppMessages.invoiceCancelConfirm);
                if (confirmed) {
                    currentInvoiceBeingProcessed = null;
                    isNewInvoice = false; // Reset the flag
                    DataStore.resetAllProductQuantities();
                    SalesProducts.displaySavedProducts();
                    UI.showToast(AppMessages.invoiceCancelSuccess, 'info');
                    Navigation.handleNavClick({ target: UIElements.desktopNavButtons[2] });
                }
            }
        };
        const LocalArchive = {
            init: () => {
                UIElements.localInvoicesList.addEventListener('click', LocalArchive.handleLocalInvoiceClick);
                UIElements.searchLocalInvoiceInput.addEventListener('input', debounce(() => {
                    LocalArchive.displayLocalInvoices();
                    UIElements.clearSearchLocalInvoiceBtn.hidden = UIElements.searchLocalInvoiceInput.value === '';
                }, 300));
                UIElements.clearSearchLocalInvoiceBtn.addEventListener('click', () => {
                    UIElements.searchLocalInvoiceInput.value = '';
                    UIElements.clearSearchLocalInvoiceBtn.hidden = true;
                    LocalArchive.displayLocalInvoices();
                });
            },
            displayLocalInvoices: () => {
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, true);
                try {
                    DataStore.invoicesInCache = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                } catch (e) {
                    DataStore.invoicesInCache = [];
                    UI.showToast("خطأ في قراءة أرشيف الفواتير المحلي. تم إعادة تعيينه.", 'error');
                }
                UIElements.localInvoicesList.innerHTML = '';
                const searchTerm = UIElements.searchLocalInvoiceInput.value.toLowerCase();
                const filteredInvoices = DataStore.getInvoices().filter(invoice => {
                    const customerMatch = (invoice.customerName || '').toLowerCase().includes(searchTerm);
                    const companyMatch = (invoice.companyName || '').toLowerCase().includes(searchTerm);
                    const ownerMatch = (invoice.ownerName || '').toLowerCase().includes(searchTerm);
                    const dateMatch = (invoice.date || '').toLowerCase().includes(searchTerm);
                    const invoiceNumMatch = (invoice.invoiceNumber || '').toLowerCase().includes(searchTerm);
                    const productMatch = (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm)));
                    return customerMatch || companyMatch || ownerMatch || dateMatch || productMatch || invoiceNumMatch;
                });
                if (filteredInvoices.length === 0) {
                    UIElements.emptyInvoicesMessage.style.display = 'flex';
                    UIElements.localInvoicesList.appendChild(UIElements.emptyInvoicesMessage);
                } else {
                    UIElements.emptyInvoicesMessage.style.display = 'none';
                    filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                    filteredInvoices.forEach(invoice => {
                        const invoiceDiv = document.createElement('div');
                        invoiceDiv.classList.add('mini-invoice-card');
                        invoiceDiv.dataset.invoiceId = invoice.id;
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'mini-invoice-header';
                        headerDiv.innerHTML = `
                            <p><strong>رقم الفاتورة:</strong> ${invoice.invoiceNumber || 'N/A'}</p>
                            <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            ${invoice.companyName ? `<p><strong>الشركة:</strong> ${invoice.companyName}</p>` : ''}
                            <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                        `;
                        invoiceDiv.appendChild(headerDiv);
                        const productsListDiv = document.createElement('div');
                        productsListDiv.className = 'mini-product-list custom-scrollbar';
                        if (invoice.products && invoice.products.length > 0) {
                            productsListDiv.innerHTML = `
                                <div class="mini-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية</div>
                                    <div>الإجمالي (قبل الضريبة)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="mini-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.quantityUsed || 0}</div>
                                        <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} درهم</div>
                                    </div>
                                `).join('')}
                                `;
                        } else {
                            productsListDiv.innerHTML = '<p class="empty-state-message" style="margin: 0; padding: 5px 0; color: var(--modern-text-secondary);">لا توجد منتجات.</p>';
                        }
                        invoiceDiv.appendChild(productsListDiv);
                        const footerDiv = document.createElement('div');
                        footerDiv.className = 'mini-invoice-footer';
                        footerDiv.innerHTML = `
                            <p><strong>الإجمالي (شامل الضريبة):</strong> <span class="text-modern-success font-bold">${parseFloat(invoice.totalTTC || 0).toFixed(2)} درهم</span></p>
                            <p><strong>الربح:</strong> <span class="text-modern-success font-bold">${parseFloat(invoice.totalProfit || 0).toFixed(2)} درهم</span></p>
                        `;
                        invoiceDiv.appendChild(footerDiv);
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'mini-invoice-actions';
                        actionsDiv.innerHTML = `
                            <button type="button" class="modern-button btn-danger-action" data-invoice-id="${invoice.id}" aria-label="حذف الفاتورة">
                                <i class="fas fa-trash-alt btn-icon"></i> حذف
                            </button>
                            <button type="button" class="modern-button btn-primary-action" data-invoice-id="${invoice.id}" aria-label="عرض الفاتورة">
                                <i class="fas fa-eye btn-icon"></i> عرض
                            </button>
                        `;
                        invoiceDiv.appendChild(actionsDiv);
                        UIElements.localInvoicesList.appendChild(invoiceDiv);
                    });
                }
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, false);
            },
            handleLocalInvoiceClick: async (event) => {
                const target = event.target;
                const invoiceItem = target.closest('.mini-invoice-card');
                if (!invoiceItem) return;
                const invoiceId = parseInt(invoiceItem.dataset.invoiceId);
                const invoiceToView = DataStore.getInvoices().find(inv => inv.id === invoiceId);
                if (target.classList.contains('btn-danger-action') || target.closest('.btn-danger-action')) {
                    event.stopPropagation();
                    LocalArchive.deleteLocalInvoiceConfirmation(invoiceId);
                } else if (target.classList.contains('btn-primary-action') || target.closest('.btn-primary-action')) {
                    event.stopPropagation();
                    if (invoiceToView) {
                        await InvoiceManager.displayFullInvoice(invoiceToView, false); // Pass false for existing invoices
                    } else {
                        UI.showToast(AppMessages.invoiceNotFound, 'error');
                    }
                } else if (invoiceToView) {
                    event.stopPropagation();
                    await InvoiceManager.displayFullInvoice(invoiceToView, false); // Pass false for existing invoices
                } else {
                    UI.showToast(AppMessages.invoiceNotFound, 'error');
                }
            },
            deleteLocalInvoiceConfirmation: async (invoiceId) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", AppMessages.productDeleteConfirm);
                if (confirmed) {
                    DataStore.deleteLocalInvoice(invoiceId);
                    LocalArchive.displayLocalInvoices();
                    DataStore.calculateAndDisplayLocalInvoiceStats();
                    UI.showToast(AppMessages.productDeleteSuccess, 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast(AppMessages.productDeleteCanceled, 'info');
                }
            }
        };
        const PurchaseOrderManager = {
            init: () => {
                UIElements.purchaseOrderForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    PurchaseOrderManager.createAndSavePurchaseOrder();
                });
                UIElements.printPoBtn.addEventListener('click', PurchaseOrderManager.printPurchaseOrder);
                UIElements.cancelPoBtn.addEventListener('click', PurchaseOrderManager.cancelPurchaseOrderProcess);
                // Save new PO-related localStorage items
                UIElements.poCompanyNameInput.addEventListener('change', () => localStorage.setItem('poCompanyName', UIElements.poCompanyNameInput.value));
                UIElements.poOwnerNameInput.addEventListener('change', () => localStorage.setItem('poOwnerName', UIElements.poOwnerNameInput.value));
                UIElements.poOwnerPhoneInput.addEventListener('change', () => localStorage.setItem('poOwnerPhone', UIElements.poOwnerPhoneInput.value));
                UIElements.poCompanyAddressInput.addEventListener('change', () => localStorage.setItem('poCompanyAddress', UIElements.poCompanyAddressInput.value));
                UIElements.poSupplierNameInput.addEventListener('change', () => localStorage.setItem('poSupplierName', UIElements.poSupplierNameInput.value)); // New
                UIElements.poSupplierPhoneInput.addEventListener('change', () => localStorage.setItem('poSupplierPhone', UIElements.poSupplierPhoneInput.value)); // New
                UIElements.poSupplierAddressInput.addEventListener('change', () => localStorage.setItem('poSupplierAddress', UIElements.poSupplierAddressInput.value)); // New

                PurchaseOrderManager.loadPurchaseOrderFormDefaults();
                UIElements.localPoList.addEventListener('click', PurchaseOrderManager.handleLocalPoClick);
                UIElements.searchLocalPo.addEventListener('input', debounce(() => {
                    PurchaseOrderManager.displayLocalPurchaseOrders();
                    UIElements.clearSearchLocalPoBtn.hidden = UIElements.searchLocalPo.value === '';
                }, 300));
                UIElements.clearSearchLocalPoBtn.addEventListener('click', () => {
                    UIElements.searchLocalPo.value = '';
                    UIElements.clearSearchLocalPoBtn.hidden = true;
                    PurchaseOrderManager.displayLocalPurchaseOrders();
                });
                UIElements.confirmReceiveGoodsBtn.addEventListener('click', PurchaseOrderManager.handleReceiveGoods);
                UIElements.cancelReceiveGoodsBtn.addEventListener('click', PurchaseOrderManager.hideReceiveGoodsModal);
                UIElements.receivePoFromDetailsBtn.addEventListener('click', () => {
                    if (currentPurchaseOrderBeingProcessed) {
                        PurchaseOrderManager.showReceiveGoodsModal(currentPurchaseOrderBeingProcessed);
                    } else {
                        UI.showToast(AppMessages.noPoToProcess, 'info');
                    }
                });
            },
            generatePONumber: () => {
                const lastPONumber = parseInt(localStorage.getItem('lastPONumber') || '0');
                const newPONumber = lastPONumber + 1;
                localStorage.setItem('lastPONumber', newPONumber);
                return `PO-${String(newPONumber).padStart(5, '0')}`;
            },
            loadPurchaseOrderFormDefaults: () => {
                UIElements.poCompanyNameInput.value = localStorage.getItem('poCompanyName') || '';
                UIElements.poOwnerNameInput.value = localStorage.getItem('poOwnerName') || '';
                UIElements.poOwnerPhoneInput.value = localStorage.getItem('poOwnerPhone') || '';
                UIElements.poCompanyAddressInput.value = localStorage.getItem('poCompanyAddress') || '';
                UIElements.poSupplierNameInput.value = localStorage.getItem('poSupplierName') || ''; // New
                UIElements.poSupplierPhoneInput.value = localStorage.getItem('poSupplierPhone') || ''; // New
                UIElements.poSupplierAddressInput.value = localStorage.getItem('poSupplierAddress') || ''; // New
                UIElements.purchaseOrderDisplay.style.display = 'none';
                UIElements.poFormContainerWrapper.style.display = 'block';
                UIElements.localPurchaseOrdersArchive.style.display = 'block';
                PurchaseOrderManager.resetPurchaseOrderFormDefaults();
            },
            resetPurchaseOrderFormDefaults: () => {
                UIElements.purchaseOrderForm.reset();
                const now = new Date();
                const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit', hour12: false });
                UIElements.purchaseOrderDateInput.value = `${formattedDate} - ${formattedTime}`;
                UIElements.purchaseOrderDateInput.setAttribute('data-iso-date', now.toISOString());
                UIElements.poFormContainerWrapper.querySelector('.card-panel-title').innerHTML = '<i class="fas fa-plus-circle"></i> إنشاء أمر شراء جديد';
                UI.resetValidationMessages(UIElements.purchaseOrderForm);
                // Retain last entered values for new PO
                UIElements.poCompanyNameInput.value = localStorage.getItem('poCompanyName') || '';
                UIElements.poOwnerNameInput.value = localStorage.getItem('poOwnerName') || '';
                UIElements.poOwnerPhoneInput.value = localStorage.getItem('poOwnerPhone') || '';
                UIElements.poCompanyAddressInput.value = localStorage.getItem('poCompanyAddress') || '';
                UIElements.poSupplierNameInput.value = localStorage.getItem('poSupplierName') || ''; // New
                UIElements.poSupplierPhoneInput.value = localStorage.getItem('poSupplierPhone') || ''; // New
                UIElements.poSupplierAddressInput.value = localStorage.getItem('poSupplierAddress') || ''; // New
            },
            createAndSavePurchaseOrder: async () => {
                UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, true);
                UI.resetValidationMessages(UIElements.purchaseOrderForm);
                if (!Validation.checkFormFields(UIElements.purchaseOrderForm)) {
                    UI.showToast(AppMessages.formValidationFailed, 'error');
                    UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                    return;
                }
                const ownerPhoneForSync = UIElements.poOwnerPhoneInput.value.trim();
                if (!ownerPhoneForSync || !Validation.checkPhoneFormat(ownerPhoneForSync)) {
                    UI.showToast(AppMessages.poOwnerPhoneInvalid, 'error');
                    UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                    return;
                }

                // New validation for supplier fields
                const poSupplierName = UIElements.poSupplierNameInput.value.trim();
                const poSupplierPhone = UIElements.poSupplierPhoneInput.value.trim();
                const poSupplierAddress = UIElements.poSupplierAddressInput.value.trim();

                if (!poSupplierName || !poSupplierPhone || !Validation.checkPhoneFormat(poSupplierPhone)) {
                     UI.showToast("يرجى ملء جميع حقول المورد (الاسم، الهاتف، العنوان) بشكل صحيح.", 'error');
                     UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                     return;
                }

                let allSavedProducts = DataStore.getSavedProducts();
                let productsToOrder = allSavedProducts.filter(p => (p.purchaseOrderQuantity || 0) > 0);
                if (productsToOrder.length === 0) {
                    const confirmed = await UI.showConfirmModal(
                        "تحديد المنتجات",
                        AppMessages.noProductsForPO
                    );
                    if (confirmed) {
                        productsToOrder = allSavedProducts.map(product => ({ ...product, purchaseOrderQuantity: 1 }));
                        productsToOrder = productsToOrder.filter(p => p.purchaseOrderQuantity > 0);
                        if (productsToOrder.length === 0) {
                            UI.showToast(AppMessages.noProductsAfterDefault, 'info');
                            UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                            return;
                        }
                    } else {
                        UI.showToast(AppMessages.poCreateCanceled, 'info');
                        UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                        return;
                    }
                }
                let totalPoAmount = 0;
                productsToOrder.forEach(product => {
                    totalPoAmount += (parseFloat(product.purchasePrice || 0) * (product.purchaseOrderQuantity || 0));
                });
                const poData = {
                    id: Date.now(),
                    poNumber: PurchaseOrderManager.generatePONumber(),
                    date: UIElements.purchaseOrderDateInput.value,
                    isoDate: UIElements.purchaseOrderDateInput.dataset.isoDate,
                    poCompanyName: UIElements.poCompanyNameInput.value.trim(),
                    poOwnerName: UIElements.poOwnerNameInput.value.trim(),
                    poOwnerPhone: UIElements.poOwnerPhoneInput.value.trim(),
                    poCompanyAddress: UIElements.poCompanyAddressInput.value.trim(),
                    poSupplierName: poSupplierName, // New field
                    poSupplierPhone: poSupplierPhone, // New field
                    poSupplierAddress: poSupplierAddress, // New field
                    purchaseOrderDeliveryDate: UIElements.purchaseOrderDeliveryDateInput.value,
                    orderedProducts: productsToOrder.map(p => ({
                        id: p.id,
                        name: p.name,
                        purchasePrice: p.purchasePrice,
                        sellingPrice: p.sellingPrice,
                        unitOfMeasure: p.unitOfMeasure,
                        supplierName: p.supplierName,
                        supplierPhone: p.supplierPhone,
                        orderedQuantity: p.purchaseOrderQuantity,
                        minStockQuantity: p.minStockQuantity,
                        stockQuantity: p.stockQuantity,
                        receivedQuantity: p.receivedQuantity || 0
                    })),
                    totalPoAmount: parseFloat(totalPoAmount).toFixed(2),
                    ownerPhone: ownerPhoneForSync,
                    status: 'Pending'
                };
                // Save new PO-related localStorage items
                localStorage.setItem('poCompanyName', poData.poCompanyName);
                localStorage.setItem('poOwnerName', poData.poOwnerName);
                localStorage.setItem('poOwnerPhone', poData.poOwnerPhone);
                localStorage.setItem('poCompanyAddress', poData.poCompanyAddress);
                localStorage.setItem('poSupplierName', poData.poSupplierName); // New
                localStorage.setItem('poSupplierPhone', poData.poSupplierPhone); // New
                localStorage.setItem('poSupplierAddress', poData.poSupplierAddress); // New
                
                try {
                    DataStore.savePurchaseOrderToLocal(poData);
                    UI.showToast(AppMessages.poSaveSuccess, 'success');
                } catch (error) {
                    UI.showToast(AppMessages.poSaveError(error.message), 'error');
                    UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
                    return;
                }
                DataStore.resetAllProductQuantities();
                SalesProducts.displaySavedProducts();
                currentPurchaseOrderBeingProcessed = poData;
                
                PurchaseOrderManager.resetPurchaseOrderFormDefaults();
                await UI.showSection(UIElements.purchaseOrderSection);
                UIElements.purchaseOrderDisplay.style.display = 'block';
                UIElements.poFormContainerWrapper.style.display = 'none';
                UIElements.localPurchaseOrdersArchive.style.display = 'none';
                PurchaseOrderManager.displayFullPurchaseOrder(poData);
                PurchaseOrderManager.displayLocalPurchaseOrders();
                UI.populateAllDatalists();
                UI.toggleButtonLoading(UIElements.createPurchaseOrderButton, false);
            },
            displayFullPurchaseOrder: async (poData) => {
                UIElements.poFormContainerWrapper.style.display = 'none';
                UIElements.localPurchaseOrdersArchive.style.display = 'none';
                UIElements.purchaseOrderDisplay.style.display = 'block';
                UIElements.displayPoId.textContent = poData.poNumber || poData.id;
                UIElements.displayPoDate.textContent = poData.date || 'N/A';
                UIElements.displayPoCompanyName.textContent = poData.poCompanyName || 'N/A';
                UIElements.displayPoOwnerName.textContent = poData.poOwnerName || 'N/A';
                UIElements.displayPoOwnerPhone.textContent = poData.poOwnerPhone || 'N/A';
                UIElements.displayPoDeliveryDate.textContent = poData.deliveryDate || 'N/A';
                UIElements.displayPoCompanyAddress.textContent = poData.poCompanyAddress || 'N/A';
                UIElements.displayPoTotalAmount.textContent = `${parseFloat(poData.totalPoAmount || 0).toFixed(2)} DH`;
                UIElements.displayPoProducts.innerHTML = '';
                let productNumber = 1;
                if (poData.orderedProducts && poData.orderedProducts.length > 0) {
                    poData.orderedProducts.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td class="po-product-name-col">${product.name || 'N/A'}</td>
                            <td class="po-purchase-price-col">${parseFloat(product.purchasePrice || 0).toFixed(2)} درهم</td>
                            <td class="po-ordered-qty-col">${product.orderedQuantity || 0}</td>
                            <td class="po-received-qty-col">${product.receivedQuantity || 0}</td>
                            <td class="po-total-col">${(parseFloat(product.purchasePrice || 0) * (product.orderedQuantity || 0)).toFixed(2)} درهم</td>
                        `;
                        UIElements.displayPoProducts.appendChild(row);
                    });
                } else {
                    const noProductsRow = document.createElement('tr');
                    noProductsRow.innerHTML = `<td colspan="6" class="text-center italic text-modern-text-secondary">لا توجد منتجات في أمر الشراء هذا.</td>`;
                    UIElements.displayPoProducts.appendChild(noProductsRow);
                }
                currentPurchaseOrderBeingProcessed = poData;
                if (poData.status === 'Received (Full)') {
                    UIElements.receivePoFromDetailsBtn.style.display = 'none';
                } else {
                    UIElements.receivePoFromDetailsBtn.style.display = 'flex';
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            printPurchaseOrder: function () {
                if (!currentPurchaseOrderBeingProcessed) {
                    UI.showToast("لا يوجد أمر شراء لعرضه للطباعة.", 'info');
                    return;
                }
                // Update owner/company details
                UIElements.printPoCompanyName.textContent = currentPurchaseOrderBeingProcessed.poCompanyName || 'اسم شركتك هنا';
                UIElements.printPoOwnerName.textContent = currentPurchaseOrderBeingProcessed.poOwnerName || 'N/A';
                UIElements.printPoCompanyAddress.textContent = currentPurchaseOrderBeingProcessed.poCompanyAddress || 'N/A';
                UIElements.printPoOwnerPhone.textContent = currentPurchaseOrderBeingProcessed.poOwnerPhone || 'N/A';
                
                // Update PO/supplier details
                UIElements.printPoNumber.textContent = currentPurchaseOrderBeingProcessed.poNumber || 'N/A';
                UIElements.printPoDate.textContent = currentPurchaseOrderBeingProcessed.date || 'N/A';
                UIElements.printPoDeliveryDate.textContent = currentPurchaseOrderBeingProcessed.deliveryDate || 'غير محدد';
                UIElements.printPoSupplierName.textContent = currentPurchaseOrderBeingProcessed.poSupplierName || 'N/A'; 
                UIElements.printPoSupplierPhone.textContent = currentPurchaseOrderBeingProcessed.poSupplierPhone || 'N/A'; 
                UIElements.printPoSupplierAddress.textContent = currentPurchaseOrderBeingProcessed.poSupplierAddress || 'N/A'; 

                UIElements.printPoDetailsBody.innerHTML = '';
                let productNumber = 1;
                if (currentPurchaseOrderBeingProcessed.orderedProducts && currentPurchaseOrderBeingProcessed.orderedProducts.length > 0) {
                    currentPurchaseOrderBeingProcessed.orderedProducts.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td class="po-product-name-col">${product.name || 'N/A'}</td>
                            <td class="po-purchase-price-col" style="display: none;">${parseFloat(product.purchasePrice || 0).toFixed(2)} درهم</td>
                            <td class="po-ordered-qty-col">${product.orderedQuantity || 0}</td>
                            <td class="po-received-qty-col">${product.receivedQuantity || 0}</td>
                            <td class="po-total-col" style="display: none;">${(parseFloat(product.purchasePrice || 0) * (product.orderedQuantity || 0)).toFixed(2)} درهم</td>
                        `;
                        UIElements.printPoDetailsBody.appendChild(row);
                    });
                } else {
                    const noProductsRow = document.createElement('tr');
                    noProductsRow.innerHTML = `<td colspan="6" style="text-align: center; font-style: italic; color: #666;">لا توجد منتجات في أمر الشراء هذا.</td>`;
                    UIElements.printPoDetailsBody.appendChild(noProductsRow);
                }
                // UIElements.printPoTotalAmount.textContent = `${parseFloat(currentPurchaseOrderBeingProcessed.totalPoAmount || 0).toFixed(2)} درهم`; // Total amount is hidden via CSS

                UIElements.printPoTemplate.style.display = 'block';
                document.body.classList.add('printing-active');
                window.print();
                setTimeout(() => {
                    UIElements.printPoTemplate.style.display = 'none';
                    document.body.classList.remove('printing-active');
                    UI.showToast(AppMessages.poPrintSuccess, 'success');
                }, 500);
            },
            cancelPurchaseOrderProcess: async () => {
                const confirmed = await UI.showConfirmModal("إلغاء أمر الشراء", AppMessages.poCancelConfirm);
                if (confirmed) {
                    currentPurchaseOrderBeingProcessed = null;
                    DataStore.resetAllProductQuantities();
                    SalesProducts.displaySavedProducts();
                    UI.showToast(AppMessages.poCancelSuccess, 'info');
                    PurchaseOrderManager.resetPurchaseOrderFormDefaults();
                    await UI.showSection(UIElements.purchaseOrderSection);
                    UIElements.purchaseOrderDisplay.style.display = 'none';
                    UIElements.poFormContainerWrapper.style.display = 'block';
                    UIElements.localPurchaseOrdersArchive.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            },
            displayLocalPurchaseOrders: () => {
                UI.toggleGeneralLoader(UIElements.localPoLoader, true);
                try {
                    DataStore.purchaseOrdersInCache = JSON.parse(localStorage.getItem('localPurchaseOrders') || '[]');
                } catch (e) {
                    DataStore.purchaseOrdersInCache = [];
                    UI.showToast("خطأ في قراءة أرشيف أوامر الشراء المحلي. تم إعادة تعيينه.", 'error');
                }
                UIElements.localPoList.innerHTML = '';
                const searchTerm = UIElements.searchLocalPo.value.toLowerCase();
                const filteredPOs = DataStore.getPurchaseOrders().filter(po => {
                    const companyMatch = (po.poCompanyName || '').toLowerCase().includes(searchTerm);
                    const ownerNameMatch = (po.poOwnerName || '').toLowerCase().includes(searchTerm);
                    const ownerPhoneMatch = (po.poOwnerPhone || '').toLowerCase().includes(searchTerm);
                    const supplierNameMatch = (po.poSupplierName || '').toLowerCase().includes(searchTerm); // New filter
                    const dateMatch = (po.date || '').toLowerCase().includes(searchTerm);
                    const poNumMatch = (po.poNumber || '').toLowerCase().includes(searchTerm);
                    const productMatch = (po.orderedProducts && po.orderedProducts.some(p => (p.name || '').toLowerCase().includes(searchTerm)));
                    return companyMatch || ownerNameMatch || ownerPhoneMatch || supplierNameMatch || dateMatch || productMatch || poNumMatch; // Added new filter
                });
                if (filteredPOs.length === 0) {
                    UIElements.emptyPoMessage.style.display = 'flex';
                    UIElements.localPoList.appendChild(UIElements.emptyPoMessage);
                } else {
                    UIElements.emptyPoMessage.style.display = 'none';
                    filteredPOs.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));
                    filteredPOs.forEach(po => {
                        const poDiv = document.createElement('div');
                        poDiv.classList.add('mini-invoice-card');
                        poDiv.dataset.poId = po.id;
                        UI.updatePoCardClass(poDiv, po.status);
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'mini-invoice-header';
                        headerDiv.innerHTML = `
                            <p><strong>رقم الأمر:</strong> ${po.poNumber || 'N/A'}</p>
                            <p><strong>الشركة الطالبة:</strong> ${po.poCompanyName || 'N/A'}</p>
                            <p><strong>صاحب الأمر:</strong> ${po.poOwnerName || 'N/A'}</p>
                            <p><strong>المورد:</strong> ${po.poSupplierName || 'N/A'}</p> <p><strong>التاريخ:</strong> ${po.date || 'N/A'}</p>
                            <p><strong>الحالة:</strong> ${po.status || 'N/A'}</p>
                        `;
                        poDiv.appendChild(headerDiv);
                        const productsListDiv = document.createElement('div');
                        productsListDiv.className = 'mini-product-list custom-scrollbar';
                        if (po.orderedProducts && po.orderedProducts.length > 0) {
                            productsListDiv.innerHTML = `
                                <div class="mini-product-item-header mini-po-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية المطلوبة</div>
                                    <div>الكمية المستلمة</div>
                                    <div>الإجمالي</div>
                                </div>
                                ${po.orderedProducts.map(product => `
                                    <div class="mini-product-item-row mini-po-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.orderedQuantity || 0}</div>
                                        <div>${product.receivedQuantity || 0}</div>
                                        <div>${(parseFloat(product.purchasePrice || 0) * (product.orderedQuantity || 0)).toFixed(2)} درهم</div>
                                    </div>
                                `).join('')}
                                `;
                        } else {
                            productsListDiv.innerHTML = '<p class="empty-state-message" style="margin: 0; padding: 5px 0; color: var(--modern-text-secondary);">لا توجد منتجات.</p>';
                        }
                        poDiv.appendChild(productsListDiv);
                        const footerDiv = document.createElement('div');
                        footerDiv.className = 'mini-invoice-footer';
                        footerDiv.innerHTML = `
                            <p><strong>الإجمالي الكلي:</strong> <span class="text-modern-primary-accent font-bold">${parseFloat(po.totalPoAmount || 0).toFixed(2)} درهم</span></p>
                        `;
                        poDiv.appendChild(footerDiv);
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'mini-invoice-actions';
                        actionsDiv.innerHTML = `
                            <button type="button" class="modern-button btn-danger-action" data-po-id="${po.id}" aria-label="حذف أمر الشراء">
                                <i class="fas fa-trash-alt btn-icon"></i> حذف
                            </button>
                            <button type="button" class="modern-button btn-primary-action" data-po-id="${po.id}" aria-label="عرض أمر الشراء">
                                <i class="fas fa-eye btn-icon"></i> عرض
                            </button>
                        `;
                        poDiv.appendChild(actionsDiv);
                        UIElements.localPoList.appendChild(poDiv);
                    });
                }
                UI.toggleGeneralLoader(UIElements.localPoLoader, false);
            },
            handleLocalPoClick: async (event) => {
                const target = event.target;
                const poItem = target.closest('.mini-invoice-card');
                if (!poItem) return;
                const poId = parseInt(poItem.dataset.poId);
                const poToView = DataStore.getPurchaseOrders().find(po => po.id === poId);
                if (target.classList.contains('btn-danger-action') || target.closest('.btn-danger-action')) {
                    event.stopPropagation();
                    PurchaseOrderManager.deleteLocalPurchaseOrderConfirmation(poId);
                } else if (target.classList.contains('btn-primary-action') || target.closest('.btn-primary-action')) {
                    event.stopPropagation();
                    if (poToView) {
                        await PurchaseOrderManager.displayFullPurchaseOrder(poToView);
                    } else {
                        UI.showToast(AppMessages.poNotFound, 'error');
                    }
                } else if (poToView) {
                    event.stopPropagation();
                    await PurchaseOrderManager.displayFullPurchaseOrder(poToView);
                } else {
                    UI.showToast(AppMessages.poNotFound, 'error');
                }
            },
            deleteLocalPurchaseOrderConfirmation: async (poId) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", AppMessages.poDeleteConfirm);
                if (confirmed) {
                    DataStore.deleteLocalPurchaseOrder(poId);
                    PurchaseOrderManager.displayLocalPurchaseOrders();
                    UI.showToast(AppMessages.poDeleteSuccess, 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast(AppMessages.poDeleteCanceled, 'info');
                }
            },
            showReceiveGoodsModal: (poData) => {
                currentPurchaseOrderBeingProcessed = poData;
                UIElements.receiptPoNumber.textContent = poData.poNumber;
                UIElements.receiptPoSupplierName.textContent = poData.poSupplierName || poData.poCompanyName || poData.poOwnerName; // Use new supplier name
                UIElements.receiptPoDate.textContent = poData.date;
                UIElements.receiptPoDeliveryDate.textContent = poData.deliveryDate || 'غير محدد';
                UIElements.receiptProductsTableBody.innerHTML = '';
                UI.resetValidationMessages(UIElements.receiptModalOverlay.querySelector('.modal-content') || UIElements.receiptModalOverlay);
                let hasOutstandingItems = false;
                poData.orderedProducts.forEach(product => {
                    const receivedQty = product.receivedQuantity || 0;
                    const remainingQtyToOrder = (product.orderedQuantity || 0) - receivedQty;
                    if (remainingQtyToOrder > 0) {
                        hasOutstandingItems = true;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.name || 'N/A'}</td>
                            <td>${product.orderedQuantity || 0}</td>
                            <td>
                                <input type="number" class="form-input received-qty-input"
                                    data-product-id="${product.id}"
                                    value="${remainingQtyToOrder}"
                                    min="0"
                                    max="${remainingQtyToOrder}"
                                    data-ordered-quantity="${product.orderedQuantity}"
                                    data-already-received="${receivedQty}">
                            </td>
                            <td>${parseFloat(product.purchasePrice || 0).toFixed(2)} درهم</td>
                        `;
                        UIElements.receiptProductsTableBody.appendChild(row);
                    }
                });
                if (!hasOutstandingItems) {
                    const poIndex = DataStore.purchaseOrdersInCache.findIndex(po => po.id === poData.id);
                    if (poIndex !== -1 && DataStore.purchaseOrdersInCache[poIndex].status !== 'Received (Full)') {
                        DataStore.purchaseOrdersInCache[poIndex].status = 'Received (Full)';
                        DataStore.setPurchaseOrders(DataStore.purchaseOrdersInCache);
                        UI.showToast(AppMessages.poAlreadyFullyReceived + " تم تحديث حالة الأمر.", 'info');
                        PurchaseOrderManager.displayLocalPurchaseOrders();
                        UI.populateAllDatalists();
                    } else {
                        UI.showToast(AppMessages.poAlreadyFullyReceived, 'info');
                    }
                    PurchaseOrderManager.hideReceiveGoodsModal();
                    return;
                }
                UIElements.receiptModalOverlay.hidden = false;
                UIElements.receiptModalOverlay.classList.add('active');
            },
            handleReceiveGoods: async () => {
                UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, true);
                if (!currentPurchaseOrderBeingProcessed) {
                    UI.showToast(AppMessages.noPoToProcess, 'error');
                    UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, false);
                    return;
                }
                const receivedProductsData = [];
                let validationMessages = [];
                let totalReceivedNewQuantity = 0;
                
                const poId = currentPurchaseOrderBeingProcessed.id;
                const poIndex = DataStore.purchaseOrdersInCache.findIndex(po => po.id === poId);
                if (poIndex === -1) {
                    UI.showToast(AppMessages.poNotFound, 'error');
                    UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, false);
                    return;
                }
                const updatedPo = { ...DataStore.purchaseOrdersInCache[poIndex] };
                const inputElements = UIElements.receiptProductsTableBody.querySelectorAll('.received-qty-input');
                inputElements.forEach(input => {
                    const productId = parseInt(input.dataset.productId);
                    const receivedQtyInput = parseInt(input.value);
                    const orderedQty = parseInt(input.dataset.orderedQuantity);
                    const alreadyReceived = parseInt(input.dataset.alreadyReceived);
                    const remainingQty = orderedQty - alreadyReceived;
                    const productInPo = updatedPo.orderedProducts.find(p => p.id === productId);
                    input.classList.remove('error');
                    if (isNaN(receivedQtyInput) || receivedQtyInput < 0) {
                        validationMessages.push(`الكمية المستلمة للمنتج "${productInPo?.name || 'غير معروف'}" غير صالحة (يجب أن تكون رقماً موجباً أو صفر).`);
                        input.classList.add('error');
                    } else if (receivedQtyInput > remainingQty) {
                        validationMessages.push(`الكمية المستلمة للمنتج "${productInPo?.name || 'غير معروف'}" (${receivedQtyInput}) تتجاوز الكمية المتبقية المطلوبة (${remainingQty}).`);
                        input.classList.add('error');
                    }
                    if (receivedQtyInput > 0) {
                        totalReceivedNewQuantity += receivedQtyInput;
                        receivedProductsData.push({
                            productId: productId,
                            productName: productInPo.name,
                            quantityReceived: receivedQtyInput,
                            purchasePrice: productInPo.purchasePrice,
                            sellingPrice: productInPo.sellingPrice,
                            unitOfMeasure: productInPo.unitOfMeasure,
                            supplierName: productInPo.supplierName,
                            supplierPhone: productInPo.supplierPhone,
                            minStockQuantity: productInPo.minStockQuantity,
                            stockQuantity: productInPo.stockQuantity,
                        });
                    }
                });
                if (validationMessages.length > 0) {
                    UI.showToast(validationMessages.join('<br>'), 'error');
                    UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, false);
                    return;
                }
                if (totalReceivedNewQuantity === 0) {
                    UI.showToast("لم يتم إدخال أي كميات للاستلام.", 'info');
                    UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, false);
                    return;
                }
                
                try {
                    let productsInMainStore = DataStore.getSavedProducts();
                    
                    receivedProductsData.forEach(receivedItem => {
                        const productIndex = productsInMainStore.findIndex(p => p.id === receivedItem.productId);
                        if (productIndex !== -1) {
                            productsInMainStore[productIndex].stockQuantity = (productsInMainStore[productIndex].stockQuantity || 0) + receivedItem.quantityReceived;
                            DataStore.addStockMovement({
                                productId: productsInMainStore[productIndex].id,
                                productName: productsInMainStore[productIndex].name,
                                type: AppMessages.stockMovementReceipt,
                                quantityChange: receivedItem.quantityReceived,
                                newStockQuantity: productsInMainStore[productIndex].stockQuantity,
                                date: new Date().toISOString(),
                                relatedPoId: updatedPo.id,
                                relatedPoNumber: updatedPo.poNumber,
                            });
                        } else {
                            const newProduct = {
                                id: receivedItem.productId,
                                name: receivedItem.productName,
                                purchasePrice: receivedItem.purchasePrice,
                                sellingPrice: receivedItem.sellingPrice,
                                minStockQuantity: receivedItem.minStockQuantity || 0,
                                unitOfMeasure: receivedItem.unitOfMeasure || 'قطعة',
                                supplierName: currentPurchaseOrderBeingProcessed.poSupplierName || currentPurchaseOrderBeingProcessed.poCompanyName || currentPurchaseOrderBeingProcessed.poOwnerName, // Use new supplier name
                                supplierAddress: currentPurchaseOrderBeingProcessed.poSupplierAddress || currentPurchaseOrderBeingProcessed.poCompanyAddress, // Use new supplier address
                                supplierPhone: currentPurchaseOrderBeingProcessed.poSupplierPhone || currentPurchaseOrderBeingProcessed.poOwnerPhone, // Use new supplier phone
                                stockQuantity: receivedItem.quantityReceived,
                                date: new Date().toLocaleDateString('ar-MA', { year: 'numeric', month: 'long', day: 'numeric' }),
                                quantity: 0,
                                purchaseOrderQuantity: 0,
                                isLocal: true
                            };
                            productsInMainStore.push(newProduct);
                            DataStore.addStockMovement({
                                productId: newProduct.id,
                                productName: newProduct.name,
                                type: AppMessages.stockMovementReceipt + ' (منتج جديد)',
                                quantityChange: receivedItem.quantityReceived,
                                newStockQuantity: newProduct.stockQuantity,
                                date: new Date().toISOString(),
                                relatedPoId: updatedPo.id,
                                relatedPoNumber: updatedPo.poNumber,
                            });
                        }
                    });
                    
                    updatedPo.orderedProducts.forEach(productInPo => {
                        const receivedItem = receivedProductsData.find(item => item.productId === productInPo.id);
                        if (receivedItem) {
                            productInPo.receivedQuantity = (productInPo.receivedQuantity || 0) + receivedItem.quantityReceived;
                        }
                    });
                    let totalOrderedForPO = 0;
                    let totalReceivedForPO = 0;
                    updatedPo.orderedProducts.forEach(prod => {
                        totalOrderedForPO += prod.orderedQuantity;
                        totalReceivedForPO += (prod.receivedQuantity || 0);
                    });
                    if (totalReceivedForPO >= totalOrderedForPO) {
                        updatedPo.status = 'Received (Full)';
                    } else if (totalReceivedForPO > 0) {
                        updatedPo.status = 'Received (Partial)';
                    } else {
                        updatedPo.status = 'Pending';
                    }
                    DataStore.setSavedProducts(productsInMainStore);
                    DataStore.savePurchaseOrderToLocal(updatedPo, true);
                    UI.showToast(AppMessages.poReceiveSuccess, 'success');
                    
                    PurchaseOrderManager.hideReceiveGoodsModal();
                    SalesProducts.displaySavedProducts();
                    PurchaseOrderManager.displayLocalPurchaseOrders();
                    PurchaseOrderManager.displayFullPurchaseOrder(updatedPo);
                    UI.populateAllDatalists();
                } catch (error) {
                    UI.showToast(AppMessages.receiptUpdateError(error.message), 'error');
                } finally {
                    UI.toggleButtonLoading(UIElements.confirmReceiveGoodsBtn, false);
                }
            },
            hideReceiveGoodsModal: () => {
                UIElements.receiptModalOverlay.classList.remove('active');
                setTimeout(() => {
                    UIElements.receiptModalOverlay.hidden = true;
                    const poData = currentPurchaseOrderBeingProcessed;
                    if (poData) {
                        const inputElements = UIElements.receiptProductsTableBody.querySelectorAll('.received-qty-input');
                        inputElements.forEach(input => {
                            const productId = parseInt(input.dataset.productId);
                            const productInPo = poData.orderedProducts.find(p => p.id === productId);
                            if (productInPo) {
                                const remainingQtyToOrder = (productInPo.orderedQuantity || 0) - (productInPo.receivedQuantity || 0);
                                input.value = Math.max(0, remainingQtyToOrder);
                            }
                            input.classList.remove('error');
                        });
                    }
                    currentPurchaseOrderBeingProcessed = null;
                }, 300);
            },
        };
        const Validation = {
            checkPhoneFormat: (phone) => {
                const regex = /^0[5-8][0-9]{8}$/;
                return regex.test(phone);
            },
            showValidationError: (field, message) => {
                const formGroup = field.closest('.form-group');
                let actualErrorMessageSpan = formGroup ? formGroup.querySelector('.validation-message') : null;
                
                if (!actualErrorMessageSpan && field.classList.contains('received-qty-input')) {
                    field.classList.add('error');
                    return;
                }
                if (actualErrorMessageSpan && actualErrorMessageSpan.classList.contains('validation-message')) {
                    actualErrorMessageSpan.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                    actualErrorMessageSpan.style.display = 'flex';
                }
                field.classList.add('error');
            },
            checkField: (field) => {
                let isValid = true;
                const fieldValue = field.value.trim();
                const formGroup = field.closest('.form-group');
                let actualErrorMessageSpan = formGroup ? formGroup.querySelector('.validation-message') : null;
                
                if (actualErrorMessageSpan && actualErrorMessageSpan.classList.contains('validation-message')) {
                    actualErrorMessageSpan.textContent = '';
                    actualErrorMessageSpan.style.display = 'none';
                }
                field.classList.remove('error');
                if (field.hasAttribute('required') && !fieldValue) {
                    isValid = false;
                    Validation.showValidationError(field, `${field.placeholder || (field.labels.length > 0 ? field.labels[0].textContent.replace(':', '').trim() : 'هذا الحقل')} مطلوب.`);
                } else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (isNaN(numValue) || numValue < parseFloat(field.min || 0)) {
                        isValid = false;
                        Validation.showValidationError(field, `القيمة يجب أن تكون رقماً صالحاً وموجباً.`);
                    } else if (field.id === 'tva' && (numValue < 0 || numValue > 100)) {
                        isValid = false;
                        Validation.showValidationError(field, `النسبة يجب أن تكون بين 0 و 100.`);
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    if (!Validation.checkPhoneFormat(fieldValue)) {
                        isValid = false;
                        Validation.showValidationError(field, `صيغة رقم الهاتف غير صحيحة (يجب أن تبدأ بـ 05، 06، 07 أو 08 وتتكون من 10 أرقام).`);
                    }
                } else if (field.type === 'date') {
                    if (field.hasAttribute('required') && !fieldValue) {
                        isValid = false;
                        Validation.showValidationError(field, `${field.placeholder || (field.labels.length > 0 ? field.labels[0].textContent.replace(':', '').trim() : 'هذا الحقل')} مطلوب.`);
                    } else if (fieldValue) {
                        const dateObj = new Date(fieldValue);
                        if (isNaN(dateObj.getTime())) {
                            isValid = false;
                            Validation.showValidationError(field, `صيغة التاريخ غير صحيحة.`);
                        }
                    }
                }
                return isValid;
            },
            checkFormFields: (form) => {
                let allFieldsValid = true;
                const fieldsToCheck = form.querySelectorAll('[required], input[type="number"], input[type="tel"], input[type="date"]');
                fieldsToCheck.forEach(field => {
                    if (!Validation.checkField(field)) {
                        allFieldsValid = false;
                    }
                });
                return allFieldsValid;
            }
        };
        window.addEventListener('load', async () => {
            DataStore.init();
            DataStore.loadFormDefaults();
            SalesProducts.resetProductFormAndButtons();
            PurchaseOrderManager.resetPurchaseOrderFormDefaults();
            UI.setActiveButton(UIElements.desktopNavButtons[0], UIElements.desktopNavButtons);
            UIElements.mainDashboardView.hidden = false;
            requestAnimationFrame(() => {
                UIElements.mainDashboardView.classList.add('active');
            });
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit', hour12: false });
            UIElements.invoiceDateInput.value = `${formattedDate} - ${formattedTime}`;
            UIElements.invoiceDateInput.setAttribute('data-iso-date', now.toISOString());
            UIElements.purchaseOrderDateInput.value = `${formattedDate} - ${formattedTime}`;
            UIElements.purchaseOrderDateInput.setAttribute('data-iso-date', now.toISOString());
            Navigation.init();
            SalesProducts.init();
            InvoiceManager.init();
            LocalArchive.init();
            PurchaseOrderManager.init();
            
            SalesProducts.displaySavedProducts();
            LocalArchive.displayLocalInvoices();
            PurchaseOrderManager.displayLocalPurchaseOrders();
            UI.populateAllDatalists();
            DataStore.calculateAndDisplayLocalInvoiceStats();
            await FirebaseSync.syncAllLocalDataToFirebaseOnLoad();
            const hasData = DataStore.getSavedProducts().length > 0 || DataStore.getInvoices().length > 0 || DataStore.getPurchaseOrders().length > 0;
            if (hasData) {
                UI.showToast(
                    AppMessages.dailyBackupWarning,
                    'warning'
                );
            }
        });
    </script>
</body>
</html>