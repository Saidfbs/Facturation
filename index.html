<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون - لوحة معلومات عصرية ومحدثة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWTK4bQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Ethereal Harmony Color Palette */
        :root {
            --primary-bg-light: hsla(220, 10%, 97%, 1);
            --card-bg-white: hsla(0, 0%, 100%, 1);
            --primary-blue-dark: hsla(210, 29%, 29%, 1);
            --accent-blue: hsla(205, 78%, 42%, 1);
            --accent-green: hsla(120, 50%, 50%, 1);
            --accent-orange: hsla(45, 80%, 65%, 1);
            --accent-red: hsla(0, 70%, 55%, 1);
            --text-primary-dark: hsla(210, 10%, 15%, 1);
            --text-secondary-gray: hsla(210, 5%, 40%, 1);
            --text-light: hsla(0, 0%, 100%, 1);
            --border-light: hsla(210, 5%, 90%, 1);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-small: 6px;
            --border-radius-medium: 10px;
            --border-radius-large: 14px;
            --border-radius-pill: 999px;
            --shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.12);
            --shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.18);
        }

        [hidden] {
            display: none !important;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: var(--primary-bg-light);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--text-primary-dark);
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            padding: var(--spacing-md);
            padding-bottom: calc(var(--spacing-md) + 60px);
        }

        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
            display: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--text-secondary-gray);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-large);
            text-align: center;
            background-color: transparent;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-decoration: none;
        }

        .main-controls .btn-panel .icon {
            font-size: 1.2em;
            line-height: 1;
        }

        .main-controls .btn-panel:hover {
            background-color: var(--primary-bg-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
            color: var(--text-primary-dark);
        }

        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px hsla(205, 78%, 42%, 0.3);
        }

        .main-controls .btn-panel.active {
            background-color: var(--accent-blue);
            color: var(--text-light);
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px);
            border: 2px solid var(--accent-blue);
        }

        .main-controls .btn-panel.active:hover {
            background-color: var(--accent-blue);
            transform: translateY(-4px);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-bg-white);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--spacing-sm) 0;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .bottom-nav .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary-gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xs);
            gap: var(--spacing-xs);
            font-size: 0.85em;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease;
            border-radius: var(--border-radius-medium);
            flex: 1;
            max-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .bottom-nav .nav-button .icon {
            font-size: 1.8em;
            line-height: 1;
        }

        .bottom-nav .nav-button:hover {
            background-color: var(--primary-bg-light);
            transform: translateY(-3px);
            color: var(--text-primary-dark);
        }

        .bottom-nav .nav-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(0, 0, 0, 0.05) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .bottom-nav .nav-button:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        .bottom-nav .nav-button.active {
            color: var(--accent-blue);
            background-color: var(--primary-bg-light);
            transform: translateY(-6px);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05), 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav .nav-button.active .icon {
            transform: scale(1.25);
            transition: transform 0.3s ease;
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px;
            margin: 0 auto;
            transition: max-width 0.3s ease, padding 0.3s ease;
        }

        .container.full-width {
            max-width: 100%;
            margin: 0;
            padding: 0;
            height: 100%;
            box-sizing: border-box;
        }

        .container.full-width > section,
        .container.full-width > article {
            padding-left: var(--spacing-md);
            padding-right: var(--spacing-md);
            box-sizing: border-box;
            flex-grow: 1;
        }

        .card-container {
            border: 1px solid var(--border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .local-archive-container {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            padding: var(--spacing-md);
            flex-grow: 1;
            box-sizing: border-box;
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .firebase-stats-combined-container {
            background-color: transparent;
            box-shadow: none;
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            flex-grow: 1;
        }

        .fade-in-section {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-in-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .dashboard-view {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: flex-start;
            width: 100%;
        }

        .main-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xl);
            font-size: 2.4em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .section-title {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .section-title .icon {
            font-size: 1.3em;
            line-height: 1;
            color: var(--accent-blue);
        }

        .list-subtitle {
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
            text-align: center;
            width: 100%;
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2em;
            color: var(--text-secondary-gray);
            border-bottom: none;
            padding-bottom: 0;
        }

        .dashboard-view > .product-form-section,
        .dashboard-view > .invoice-creation-section {
            flex: 1 1 48%;
            min-width: 350px;
        }

        .dashboard-view > .saved-products-section {
            flex: 1 1 100%;
            margin-top: var(--spacing-md);
        }

        .firebase-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            width: 100%;
            flex-grow: 1;
        }

        .product-list-grid {
            display: grid;
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            padding: var(--spacing-md);
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow-y: visible;
            max-height: none;
            padding-right: 0;
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
        }

        .product-list-grid.saved-products-grid {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .product-list-grid.invoice-cards-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            justify-items: stretch;
        }

        .scrollable-list-in-card {
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            background-color: var(--primary-bg-light);
            margin-top: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            gap: var(--spacing-xs);
            justify-content: flex-start;
            align-items: stretch;
            padding: var(--spacing-md);
            list-style: none;
            margin-right: 0;
            margin-left: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) var(--primary-bg-light);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-height: 150px;
            overflow-y: hidden;
            flex-shrink: 0;
        }

        .scrollable-list-in-card.has-more-items {
            max-height: 204px;
            overflow-y: auto;
        }

        .scrollable-list-in-card::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-track {
            background: var(--primary-bg-light);
            border-radius: 10px;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
            border: 2px solid var(--primary-bg-light);
            transition: background-color 0.3s ease;
        }

        .scrollable-list-in-card::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue-dark);
        }

        .scrollable-list-in-card li {
            background-color: var(--card-bg-white);
            padding: 8px 12px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease, border-color 0.3s ease;
        }

        .scrollable-list-in-card li:hover {
            background-color: hsla(210, 30%, 96%, 1);
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .scrollable-list-in-card li:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        .scrollable-list-in-card li span {
            display: block;
            text-align: right;
            white-space: normal;
            word-break: break-word;
        }

        .scrollable-list-in-card li span:first-child {
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xs);
            font-size: 1.1em;
        }

        .scrollable-list-in-card li span:last-child {
            font-weight: normal;
            font-size: 0.95em;
            color: var(--text-secondary-gray);
            flex-shrink: 0;
        }

        #dynamicStatsListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            flex: 1 1 auto;
        }

        #dynamicStatsListContainer > div {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: var(--spacing-md);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: center;
        }

        p {
            margin: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--text-primary-dark);
            font-size: 0.95em;
            transition: color 0.3s ease;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--accent-red);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--text-primary-dark);
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.3);
            transform: scale(1.005);
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown),
        .form-group input.error,
        .form-group select.error {
            border-color: var(--accent-red);
        }

        .form-group .validation-error-message {
            color: var(--accent-red);
            font-size: 0.85em;
            padding-right: var(--spacing-xs);
            margin-top: 5px;
            display: none;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message,
        .form-group input.error + .validation-error-message,
        .form-group select.error + .validation-error-message {
            display: flex;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn-base {
            display: flex;
            flex: 1;
            height: 50px;
            padding: 1rem 0;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            box-shadow: var(--shadow-medium);
            font-size: 0.95em;
            outline: none;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            background-color: var(--accent-blue);
            background-image: linear-gradient(135deg, var(--accent-blue), hsla(205, 78%, 35%, 1));
        }

        .btn-base:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 3px;
            box-shadow: 0 0 0 5px hsla(205, 78%, 42%, 0.4);
        }

        .btn-primary {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
        }

        .btn-primary:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), hsla(210, 29%, 22%, 1));
        }

        .btn-success {
            background-color: var(--accent-green);
            background-image: linear-gradient(135deg, var(--accent-green), hsla(135, 60%, 35%, 1));
        }

        .btn-success:hover {
            background-image: linear-gradient(135deg, hsla(135, 60%, 35%, 1), var(--accent-green));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-success:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(135, 60%, 35%, 1), hsla(135, 60%, 35%, 1));
        }

        .btn-danger {
            background-color: var(--accent-red);
            background-image: linear-gradient(135deg, var(--accent-red), hsla(350, 70%, 45%, 1));
            margin-top: var(--spacing-sm);
        }

        .btn-danger:hover {
            background-image: linear-gradient(135deg, hsla(350, 70%, 45%, 1), var(--accent-red));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(350, 70%, 45%, 1), hsla(350, 70%, 45%, 1));
        }

        .btn-warning {
            background-color: var(--accent-orange);
            background-image: linear-gradient(135deg, var(--accent-orange), hsla(39, 90%, 50%, 1));
            color: var(--text-primary-dark);
            margin-top: var(--spacing-sm);
        }

        .btn-warning:hover {
            background-image: linear-gradient(135deg, hsla(39, 90%, 50%, 1), var(--accent-orange));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-warning:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, hsla(39, 90%, 50%, 1), hsla(39, 90%, 50%, 1));
        }

        .btn-secondary-light {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
            color: var(--text-light);
        }

        .btn-secondary-light:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-secondary-light:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        .invoice-header-section {
            border: none;
            background-color: var(--primary-bg-light);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }

        .invoice-header-section h2 {
            width: 100%;
            text-align: center;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            color: var(--primary-blue-dark);
        }

        .invoice-header-section p {
            width: 100%;
            text-align: right;
            font-size: 1em;
            color: var(--text-primary-dark);
        }

        .invoice-summary-section {
            background-color: var(--primary-bg-light);
            text-align: center;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            margin-bottom: var(--spacing-md);
            transition: background-color 0.3s ease;
        }

        .invoice-summary-section table {
            width: 100%;
            margin: 0 auto;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        .invoice-summary-section tfoot tr td {
            text-align: right;
            font-weight: bold;
            padding: 0.5rem 1rem;
            color: var(--text-primary-dark);
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            box-shadow: var(--shadow-subtle);
        }

        .invoice-summary-section tfoot tr:last-child td {
            background-color: var(--accent-blue);
            color: var(--text-light);
            font-size: 1.1em;
            box-shadow: var(--shadow-medium);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            border: 1px solid var(--border-light);
            background-color: var(--card-bg-white);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg-white);
            font-size: 0.95em;
            border: none;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--border-light);
            padding: 0.6rem;
            text-align: right;
            white-space: nowrap;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .invoice-table th {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: left;
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.1em;
        }

        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
            color: var(--text-primary-dark);
        }

        .invoice .divider {
            border-top: 1px dashed var(--border-light);
            margin: var(--spacing-lg) 0;
            transition: border-color 0.3s ease;
        }

        .product-card {
            border: 1px solid var(--border-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            text-align: right;
            font-size: 0.95em;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            border-radius: var(--border-radius-medium) 0 0 var(--border-radius-medium);
            transition: background-color 0.3s ease;
        }

        .mini-invoice-card {
            border: 1px solid var(--border-light);
            border-right: 5px solid var(--accent-blue);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--card-bg-white);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            text-align: right;
            font-size: 0.85em;
            line-height: 1.4;
            cursor: pointer;
            position: relative;
            box-sizing: border-box;
        }

        .mini-invoice-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
            border-right-color: var(--accent-green);
        }

        .mini-invoice-card .invoice-mini-header p,
        .mini-invoice-card .invoice-mini-footer p {
            margin: 2px 0;
            color: var(--text-primary-dark);
        }

        .mini-invoice-card .invoice-mini-header p strong {
            color: var(--primary-blue-dark);
            font-size: 1.1em;
        }

        .mini-product-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.8em;
            width: 100%;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
            padding: var(--spacing-xs);
            box-sizing: border-box;
            background-color: var(--primary-bg-light);
        }

        .mini-product-item-header,
        .mini-product-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr;
            gap: var(--spacing-xs);
            align-items: center;
            padding: 4px 6px;
            text-align: right;
        }

        .mini-product-item-header {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row {
            background-color: var(--card-bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-small);
        }

        .mini-product-item-row:nth-child(even) {
            background-color: var(--primary-bg-light);
        }

        .mini-product-item-row div {
            white-space: normal;
            word-break: break-word;
            text-align: right;
            color: var(--text-secondary-gray);
        }

        .mini-product-item-row div:first-child {
            color: var(--text-primary-dark);
        }

        .mini-invoice-card .invoice-mini-footer {
            border-top: 1px dashed var(--border-light);
            padding-top: var(--spacing-sm);
            text-align: right;
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-mini-footer p strong {
            color: var(--accent-green);
            font-size: 1.1em;
        }

        .mini-invoice-card .invoice-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light {
            flex: 0 0 auto;
            width: fit-content;
            padding: 0.5rem 1rem;
            height: auto;
            font-size: 0.8em;
            margin-top: 0;
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), hsla(210, 29%, 22%, 1));
        }

        .mini-invoice-card .invoice-actions .btn-secondary-light:hover {
            background-image: linear-gradient(135deg, hsla(210, 29%, 22%, 1), var(--primary-blue-dark));
        }

        .product-card.is-local {
            background-color: var(--card-bg-white) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }

        .product-card.is-local::before {
            background-color: var(--accent-blue);
        }

        .product-card.is-local p {
            color: var(--text-secondary-gray);
        }

        .product-card.is-local p strong {
            color: var(--text-primary-dark);
        }

        .product-card.is-local-match {
            background-color: var(--accent-green) !important;
            border-color: var(--accent-green) !important;
            color: var(--text-light) !important;
            box-shadow: 0 4px 10px hsla(135, 60%, 42%, 0.4);
        }

        .product-card.is-local-match::before {
            background-color: var(--accent-green);
        }

        .product-card.is-local-match p {
            color: var(--text-light) !important;
        }

        .product-card.is-local-match p strong {
            color: var(--text-light) !important;
        }

        .product-card.is-local-match .product-actions button {
            background-color: var(--card-bg-white);
            color: var(--primary-blue-dark);
        }

        .product-card.is-local-match .product-actions button:hover {
            background-color: var(--primary-bg-light);
        }

        .product-card .product-details,
        .mini-invoice-card .invoice-summary-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
            width: 100%;
        }

        .product-card .product-details p,
        .mini-invoice-card .invoice-summary-details p {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: var(--text-secondary-gray);
        }

        .product-card .product-details p:first-child strong {
            font-size: 1.2em;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xs);
        }

        .product-card .product-actions,
        .mini-invoice-card .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }

        .product-card .product-actions button,
        .mini-invoice-card .invoice-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            height: 45px;
            padding: 0.8rem 0;
            font-size: 0.9em;
        }

        .quantity-controls {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
            border-radius: var(--border-radius-medium);
            overflow: hidden;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-subtle);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .quantity-controls button {
            width: auto;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background-color: var(--accent-blue);
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.3s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
            box-shadow: none;
        }

        .quantity-controls button:first-child {
            border-top-right-radius: var(--border-radius-small);
            border-bottom-right-radius: var(--border-radius-small);
        }

        .quantity-controls button:last-child {
            border-top-left-radius: var(--border-radius-small);
            border-bottom-left-radius: var(--border-radius-small);
        }

        .quantity-controls button:hover {
            background-color: hsla(205, 78%, 35%, 1);
        }

        .quantity-controls button:active {
            transform: scale(0.95);
        }

        .quantity-controls button:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px hsla(205, 78%, 42%, 0.4);
            z-index: 1;
        }

        .quantity-controls input {
            width: 100%;
            max-width: none;
            height: 45px;
            margin: 0;
            font-size: 1.1em;
            text-align: center;
            border-radius: 0;
            background-color: var(--primary-bg-light);
            border: none;
            border-left: 1px solid var(--border-light);
            border-right: 1px solid var(--border-light);
            color: var(--text-primary-dark);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .quantity-controls input:focus {
            border-color: var(--accent-blue);
            box-shadow: inset 0 0 0 2px hsla(205, 78%, 42%, 0.3);
        }

        .product-card.status-insufficient {
            background-color: var(--accent-red) !important;
            color: var(--text-light);
            border-color: var(--accent-red) !important;
            box-shadow: 0 2px 8px hsla(350, 70%, 55%, 0.3);
        }

        .product-card.status-insufficient::before {
            background-color: var(--accent-red);
        }

        .product-card.status-insufficient p {
            color: var(--text-light);
        }

        .product-card.status-insufficient p strong {
            color: var(--text-light);
        }

        .product-card.status-selected-sufficient {
            background-color: hsla(205, 78%, 95%, 1) !important;
            border-color: var(--accent-blue) !important;
            box-shadow: 0 2px 8px hsla(205, 78%, 42%, 0.3);
            color: var(--text-primary-dark);
        }

        .product-card.status-selected-sufficient::before {
            background-color: var(--accent-blue);
        }

        .product-card.status-selected-sufficient p {
            color: var(--text-secondary-gray);
        }

        .product-card.status-selected-sufficient p strong {
            color: var(--text-primary-dark);
        }

        .product-card.status-stock-positive,
        .product-card.status-default {
            background-color: var(--card-bg-white) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }

        .product-card.status-stock-positive::before,
        .product-card.status-default::before {
            background-color: var(--accent-green);
        }

        .search-input {
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--card-bg-white);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            padding-left: 45px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%237f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 18px;
        }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(205, 78%, 42%, 0.3);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .search-input-wrapper input {
            margin-bottom: 0;
        }

        .clear-search-btn {
            background-color: var(--accent-red);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-subtle);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 45px;
        }

        .clear-search-btn:hover {
            background-color: hsla(350, 70%, 45%, 1);
            transform: translateY(-1px);
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--primary-bg-light);
            border-radius: var(--border-radius-medium);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .firebase-product-list-wrapper > .filter-controls {
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }

        .filter-controls .form-group {
            flex: 1 1 48%;
            min-width: 250px;
            margin-bottom: 0;
        }

        .filter-controls .form-group label {
            display: none;
        }

        .filter-controls select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg-white);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-light);
            font-size: 1em;
            color: var(--text-primary-dark);
            outline: none;
            text-align: right;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%237f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 12px;
            padding-left: 30px;
            padding-right: 0.8rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .filter-controls select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px hsla(205, 78%, 42%, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card-list {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: stretch;
            width: 100%;
        }

        .stat-card {
            background: var(--card-bg-white);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 auto;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-medium);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            width: 80px;
            height: 80px;
            background-color: var(--accent-blue);
            border-radius: var(--border-radius-pill);
            opacity: 0.1;
            transform: scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
        }

        .stat-card:hover::before {
            transform: scale(1);
        }

        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin: 0;
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums;
        }

        #toast-container {
            position: fixed;
            bottom: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            pointer-events: none;
            align-items: center;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            padding: var(--spacing-md);
        }

        .toast {
            background-color: var(--card-bg-white);
            color: var(--text-primary-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
            direction: rtl;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .toast.success {
            border-right: 5px solid var(--accent-green);
            border-left: none;
        }

        .toast.error {
            border-right: 5px solid var(--accent-red);
            border-left: none;
        }

        .toast.info {
            border-right: 5px solid var(--accent-blue);
            border-left: none;
        }

        .toast .icon {
            font-size: 1.5em;
            line-height: 1;
        }

        .toast.success .icon {
            color: var(--accent-green);
        }

        .toast.error .icon {
            color: var(--accent-red);
        }

        .toast.info .icon {
            color: var(--accent-blue);
        }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #confirm-modal-dialog {
            background-color: var(--card-bg-white);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-medium);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            direction: rtl;
        }

        #confirm-modal-overlay.active #confirm-modal-dialog {
            transform: scale(1);
        }

        #confirm-modal-dialog h3 {
            color: var(--text-primary-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
        }

        #confirm-modal-dialog p {
            color: var(--text-secondary-gray);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-pill);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #confirm-yes-btn {
            background-color: var(--accent-blue);
            color: var(--text-light);
        }

        #confirm-yes-btn:hover {
            background-color: hsla(205, 78%, 35%, 1);
        }

        #confirm-no-btn {
            background-color: var(--border-light);
            color: var(--text-primary-dark);
        }

        #confirm-no-btn:hover {
            background-color: hsla(210, 10%, 75%, 1);
        }

        .loader {
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-base .loader-inline {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0;
            vertical-align: middle;
            margin-left: 5px;
        }

        .btn-base .loader-inline.active {
            display: inline-block;
        }

        .btn-base.loading {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-base.loading .icon,
        .btn-base.loading span:not(.loader-inline) {
            display: none;
        }

        @media (min-width: 769px) {
            body {
                font-size: 16px;
                padding-bottom: var(--spacing-md);
            }
            .main-controls {
                display: flex;
            }
            .bottom-nav {
                display: none;
            }
            .invoice-details-grid {
                grid-template-columns: 1fr 1fr;
            }
            .invoice-header-section p {
                width: auto;
                text-align: right;
            }
        }

        @media (max-width: 1024px) {
            .container {
                max-width: 960px;
            }
            .main-controls .btn-panel {
                font-size: 0.9em;
                padding: 0.6rem 0.8rem;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
            .stat-card h3 {
                font-size: 1em;
            }
            .stat-card p {
                font-size: 1.4em;
            }
            #dynamicStatsListContainer {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 15px;
                padding: var(--spacing-sm);
                padding-bottom: calc(var(--spacing-sm) + 60px);
            }
            .main-controls {
                display: none;
            }
            .bottom-nav {
                display: flex;
            }
            .container {
                max-width: 100%;
            }
            .dashboard-view > .product-form-section,
            .dashboard-view > .invoice-creation-section {
                min-width: unset;
                flex: 1 1 100%;
            }
            .invoice h1 {
                font-size: 1.8em;
            }
            .invoice h2 {
                font-size: 1.4em;
            }
            .invoice-table th,
            .invoice-table td {
                padding: 0.5rem;
                font-size: 0.8em;
            }
            .product-list-grid.saved-products-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: none;
                overflow-y: visible;
            }
            .product-list-grid.invoice-cards-grid {
                grid-template-columns: 1fr;
                max-height: none;
                overflow-y: visible;
            }
            .stat-card p {
                font-size: 1.3em;
            }
            .statistics-section .section-title {
                font-size: 1.5em;
            }
            .toast {
                min-width: unset;
                max-width: 90%;
            }
            .toast .icon {
                font-size: 1.2em;
            }
            .dashboard-view > section {
                flex: 1 1 100%;
            }
            .filter-controls .form-group {
                min-width: unset;
                flex: 1 1 100%;
            }
            .quantity-controls input {
                width: 60px;
                margin: 0 5px;
            }
            .stat-card-list {
                flex-direction: column;
            }
            .stat-card-list > div {
                flex: 1 1 100%;
            }
            #dynamicStatsListContainer {
                grid-template-columns: 1fr;
            }
            .invoice-header-section {
                align-items: flex-start;
                text-align: right;
            }
            .invoice-header-section h2 {
                text-align: right;
            }
            .invoice-header-section p {
                text-align: right;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
                padding: var(--spacing-sm);
                padding-bottom: calc(var(--spacing-sm) + 60px);
            }
            .button-container {
                flex-direction: column;
            }
            .btn-base {
                flex: 1 1 100%;
            }
            .product-list-grid.invoice-cards-grid {
                grid-template-columns: 1fr;
                max-height: none;
                overflow-y: visible;
            }
            .main-title,
            .firebase-stats-combined-container .main-title {
                font-size: 1.8em;
            }
            .section-title,
            .firebase-stats-combined-container .section-title {
                font-size: 1.5em;
            }
            .stat-card h3 {
                font-size: 0.9em;
            }
            .stat-card p {
                font-size: 1.2em;
            }
            .toast {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            .toast .icon {
                font-size: 1.2em;
            }
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
                color: #000;
                font-size: 12pt;
            }
            .main-controls,
            .bottom-nav,
            .theme-switch-wrapper,
            .invoice-actions-print-group {
                display: none !important;
            }
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 1cm !important;
            }
            .invoice {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background-color: #fff !important;
            }
            .invoice-table {
                border: 1px solid #000 !important;
            }
            .invoice-table th,
            .invoice-table td {
                border: 1px solid #000 !important;
                color: #000 !important;
                background-color: #fff !important;
            }
            .invoice-table th {
                background-color: #f2f2f2 !important;
            }
            #displayTotalAmountBeforeCommission,
            #displayCommissionDeducted,
            #displayTotalAmount,
            #displayTVA,
            #displayTotalTTC {
                color: #000 !important;
            }
            .main-title,
            .section-title,
            .list-subtitle {
                color: #000 !important;
                border-bottom-color: #ccc !important;
            }
            .icon {
                display: none;
            }
            .invoice-header-section,
            .invoice-summary-section,
            .invoice-footer {
                background-color: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
                margin-bottom: 0.5cm !important;
            }
            .invoice-summary-section table {
                border-spacing: 0;
            }
            .invoice-summary-section tfoot tr td {
                background-color: transparent !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                color: #000 !important;
                padding: 0.3rem 0.5rem !important;
            }
            .invoice-header-section p {
                margin: 0;
            }
            .invoice-header-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px 20px;
                align-items: start;
                text-align: right;
            }
            .invoice-header-section h2 {
                grid-column: 1 / -1;
                text-align: center;
            }
            .invoice-header-section p:nth-of-type(1),
            .invoice-header-section p:nth-of-type(2),
            .invoice-header-section p:nth-of-type(3) {
                text-align: right;
            }
            .invoice-table th,
            .invoice-table td,
            .invoice-header-section p,
            .invoice-summary-section tfoot tr td,
            .invoice-footer p {
                font-size: 10pt !important;
            }
            .invoice .main-title {
                font-size: 16pt !important;
            }
            .invoice .section-title {
                font-size: 14pt !important;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
</head>
<body>
    <header class="main-controls" id="desktopNav">
        <button type="button" class="btn-panel" id="showDashboardButton"><span class="icon"><i
                        class="fas fa-home"></i></span>الرئيسية (الإدارة)</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton"><span class="icon"><i
                        class="fas fa-chart-bar"></i></span>بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showLocalArchiveButton"><span class="icon"><i
                        class="fas fa-archive"></i></span>أرشيف الفواتير</button>
    </header>

    <main class="container">
        <section id="mainDashboardView" class="dashboard-view fade-in-section">
            <h1 class="main-title">لوحة التحكم الرئيسية</h1>
            <section class="product-form-section card-container" id="productFormContainer">
                <h2 class="section-title" id="productFormTitle"><span class="icon"><i
                                class="fas fa-box"></i></span>إدارة المنتجات</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on"
                            list="productNames">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on"
                            min="0" step="0.01">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on"
                            min="0" step="0.01">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur"
                            autocomplete="on" list="supplierNames">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur"
                            autocomplete="on" list="supplierAddresses">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel"
                            pattern="[0-9]{10}" inputmode="numeric" list="supplierPhones">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantité initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn-base btn-primary" id="addProduct">
                            <span class="icon"><i class="fas fa-plus-circle"></i></span>إضافة منتج
                            <span class="loader-inline"></span>
                        </button>
                        <button type="submit" class="btn-base btn-warning" id="saveEditProduct" style="display: none;">
                            <span class="icon"><i class="fas fa-edit"></i></span>تعديل المنتج
                            <span class="loader-inline"></span>
                        </button>
                    </div>
                </form>
            </section>
            <section class="invoice-creation-section card-container" id="clientFormContainer">
                <h2 class="section-title"><span class="icon"><i class="fas fa-file-invoice"></i></span>إنشاء الفواتير
                </h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on"
                            list="customerNames">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture"
                            autocomplete="on" list="invoiceOwners">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la
                            facture</label>
                        <input type="text" id="invoiceOwnerAddress" required
                            placeholder="Adresse du propriétaire de la facture" autocomplete="on"
                            list="invoiceOwnerAddresses">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la
                            facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678"
                            autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric" list="invoiceOwnerPhones">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionAmount">Montant de la commission (DH)</label>
                        <input type="number" id="invoiceCommissionAmount" placeholder="مثال: 100" value="0" min="0"
                            step="0.01">
                        <span class="validation-error-message"></span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn-base btn-success" id="createInvoiceButton">
                            <span class="icon"><i class="fas fa-check-circle"></i></span>إنشاء الفاتورة وعرضها
                            <span class="loader-inline"></span>
                        </button>
                        <button type="button" class="btn-base btn-primary" id="updateFirebaseInvoiceButton" style="display:none;">
                            <span class="icon"><i class="fas fa-save"></i></span>تحديث فاتورة Firebase
                            <span class="loader-inline"></span>
                        </button>
                    </div>
                </form>
            </section>
            <section class="saved-products-section card-container" id="savedProductsDisplay">
                <div class="divider"></div>
                <h2 class="section-title"><span class="icon"><i class="fas fa-shopping-cart"></i></span>المنتجات
                    المحفوظة (سلة الفاتورة)</h2>
                <div class="form-group">
                    <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                    <input type="text" id="searchProduct" class="search-input" placeholder="البحث عن منتج">
                </div>
                <div class="product-list-grid saved-products-grid" id="savedProductsList"></div>
                <div class="loader" id="savedProductsLoader"></div>
            </section>
        </section>

        <article class="invoice card-container fade-in-section" id="invoiceDisplay" hidden>
            <h1 class="main-title">DEVIS</h1>
            <section class="invoice-header-section">
                <h2 class="section-title"><span class="icon"><i class="fas fa-user"></i></span>تفاصيل الفاتورة</h2>
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Date de la facture: <time datetime="" id="displayInvoiceDate"></time></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
            </section>
            <div class="table-responsive">
                <table class="invoice-table" id="invoiceDetails">
                    <thead>
                        <tr>
                            <th>N°</th>
                            <th>Nom du produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantité</th>
                            <th>Montant HT</th>
                        </tr>
                    </thead>
                    <tbody id="displayDetails"></tbody>
                </table>
            </div>
            <div class="invoice-summary-section">
                <h2 class="section-title"><span class="icon"><i class="fas fa-chart-line"></i></span>ملخص الفاتورة
                </h2>
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <footer class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </footer>
            <div class="button-container invoice-actions-print-group">
                <button type="button" class="btn-base btn-primary" id="savePdfButton">
                    <span class="icon"><i class="fas fa-boxes"></i></span>تحديث المخزون (بعد الفاتورة)
                    <span class="loader-inline"></span>
                </button>
                <button type="button" class="btn-base btn-success" id="printButton">
                    <span class="icon"><i class="fas fa-print"></i></span>طباعة الفاتورة
                </button>
                <button type="button" class="btn-base btn-warning" id="editFirebaseInvoiceButton" style="display:none;">
                    <span class="icon"><i class="fas fa-edit"></i></span>تعديل الفاتورة
                </button>
            </div>
        </article>

        <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay" hidden>
            <h1 class="main-title">بيانات Firebase والإحصائيات</h1>
            <div class="firebase-content-wrapper">
                <section class="statistics-section card-container">
                    <h2 class="section-title"><span class="icon"><i class="fas fa-chart-pie"></i></span>إحصائيات
                        المبيعات التفصيلية</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي سعر الشراء</h3>
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي سعر البيع</h3>
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي العمولة</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي الأرباح</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card-list">
                            <div id="dynamicStatsListContainer">
                                <div>
                                    <h3 class="list-subtitle">المنتجات الأكثر مبيعاً</h3>
                                    <ul id="topSellingProductsList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">العملاء الأكثر نشاطاً</h3>
                                    <ul id="topCustomersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">أصحاب الفواتير الأكثر نشاطاً</h3>
                                    <ul id="topInvoiceOwnersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="list-subtitle">الموردون الأكثر نشاطاً</h3>
                                    <ul id="topSuppliersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-input-wrapper">
                        <button type="button" class="clear-search-btn" id="clearCommonSearchInput"><span
                                class="icon"><i class="fas fa-times-circle"></i></span>مسح</button>
                        <input type="text" id="commonSearchInput" class="search-input"
                            placeholder="البحث برقم الهاتف، الاسم، أو المنتج" list="allSearchOptions">
                        <datalist id="allSearchOptions"></datalist>
                    </div>
                </section>
                <section class="firebase-product-list-wrapper card-container">
                    <h2 class="section-title"><span class="icon"><i class="fas fa-cloud"></i></span>قائمة فواتير
                        Firebase (<span id="firebaseProductListCount">0</span>)</h2>
                    <div class="filter-controls">
                        <div class="form-group">
                            <label for="commonPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                            <select id="commonPhoneDropdown"></select>
                        </div>
                    </div>
                    <div class="product-list-grid invoice-cards-grid" id="productListContainerdata"></div>
                    <div class="loader" id="firebaseLoader"></div>
                </section>
            </div>
        </section>

        <section class="local-archive-container fade-in-section" id="localArchiveView" hidden>
            <h1 class="main-title">أرشيف الفواتير المحلية</h1>
            <section class="card-container">
                <h2 class="section-title" style="margin-top: var(--spacing-lg);"><span class="icon"><i
                                class="fas fa-file-invoice"></i></span>الفواتير المحفوظة محلياً</h2>
                <div class="form-group">
                    <label for="searchLocalInvoice" class="sr-only">البحث في الفواتير المحلية</label>
                    <input type="text" id="searchLocalInvoice" class="search-input"
                        placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتج)"
                        list="localInvoiceSearchOptions">
                    <datalist id="localInvoiceSearchOptions"></datalist>
                </div>
                <div class="product-list-grid invoice-cards-grid" id="localInvoicesList">
                    <p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>
                </div>
                <div class="loader" id="localArchiveLoader"></div>
            </section>
        </section>
    </main>

    <nav class="bottom-nav" id="mobileNav">
        <button type="button" class="nav-button" id="mobileShowDashboardButton">
            <span class="icon"><i class="fas fa-home"></i></span>
            <span>الرئيسية</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowFirebaseDataButton">
            <span class="icon"><i class="fas fa-chart-bar"></i></span>
            <span>البيانات</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowLocalArchiveButton">
            <span class="icon"><i class="fas fa-archive"></i></span>
            <span>الأرشيف</span>
        </button>
    </nav>

    <div id="toast-container"></div>
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

    <datalist id="productNames"></datalist>
    <datalist id="supplierNames"></datalist>
    <datalist id="supplierAddresses"></datalist>
    <datalist id="supplierPhones"></datalist>
    <datalist id="customerNames"></datalist>
    <datalist id="invoiceOwners"></datalist>
    <datalist id="invoiceOwnerAddresses"></datalist>
    <datalist id="invoiceOwnerPhones"></datalist>
    <datalist id="localInvoiceSearchOptions"></datalist>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };

        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            UI.showToast("فشل تهيئة Firebase. قد لا تعمل الميزات المتعلقة بالبيانات السحابية.", 'error');
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global Data Stores
        let allFirebaseInvoicesData = [];
        let allFirebaseProducts = [];
        let allLocalInvoices = [];
        let currentInvoiceBeingProcessed = null;
        let currentFirebaseInvoiceKey = null;
        let isNewInvoice = false;

        // ====== UI Elements References ======
        const UIElements = {
            // Main Layout & Navigation
            mainDashboardView: document.getElementById('mainDashboardView'),
            invoiceDisplay: document.getElementById('invoiceDisplay'),
            firebaseProductsDisplay: document.getElementById('firebaseProductsDisplay'),
            localArchiveView: document.getElementById('localArchiveView'),
            desktopNavButtons: [
                document.getElementById('showDashboardButton'),
                document.getElementById('showFirebaseDataButton'),
                document.getElementById('showLocalArchiveButton')
            ],
            mobileNavButtons: [
                document.getElementById('mobileShowDashboardButton'),
                document.getElementById('mobileShowFirebaseDataButton'),
                document.getElementById('mobileShowLocalArchiveButton')
            ],
            mainContainer: document.querySelector('main.container'),

            // Product Form
            productForm: document.getElementById('productForm'),
            productFormContainer: document.getElementById('productFormContainer'),
            productFormTitle: document.getElementById('productFormTitle'),
            productNameInput: document.getElementById('productName'),
            purchasePriceInput: document.getElementById('purchasePrice'),
            sellingPriceInput: document.getElementById('sellingPrice'),
            supplierNameInput: document.getElementById('supplierName'),
            supplierAddressInput: document.getElementById('supplierAddress'),
            supplierPhoneInput: document.getElementById('supplierPhone'),
            productQuantityInput: document.getElementById('productQuantity'),
            addProductButton: document.getElementById('addProduct'),
            saveEditProductButton: document.getElementById('saveEditProduct'),
            savedProductsList: document.getElementById('savedProductsList'),
            searchProductInput: document.getElementById('searchProduct'),
            savedProductsLoader: document.getElementById('savedProductsLoader'),

            // Invoice Form
            invoiceForm: document.getElementById('invoiceForm'),
            clientFormContainer: document.getElementById('clientFormContainer'),
            customerNameInput: document.getElementById('customerName'),
            invoiceOwnerInput: document.getElementById('invoiceOwner'),
            invoiceOwnerPhoneInput: document.getElementById('invoiceOwnerPhone'),
            invoiceOwnerAddressInput: document.getElementById('invoiceOwnerAddress'),
            invoiceDateInput: document.getElementById('invoiceDate'),
            tvaInput: document.getElementById('tva'),
            invoiceCommissionAmountInput: document.getElementById('invoiceCommissionAmount'),
            createInvoiceButton: document.getElementById('createInvoiceButton'),
            updateFirebaseInvoiceButton: document.getElementById('updateFirebaseInvoiceButton'),
            editFirebaseInvoiceButton: document.getElementById('editFirebaseInvoiceButton'),
            savePdfButton: document.getElementById('savePdfButton'),
            printButton: document.getElementById('printButton'),

            // Invoice Display Elements
            displayCustomerName: document.getElementById('displayCustomerName'),
            displayInvoiceOwner: document.getElementById('displayInvoiceOwner'),
            displayInvoiceDate: document.getElementById('displayInvoiceDate'),
            displayTotalAmountBeforeCommission: document.getElementById('displayTotalAmountBeforeCommission'),
            displayCommissionDeducted: document.getElementById('displayCommissionDeducted'),
            displayTotalAmount: document.getElementById('displayTotalAmount'),
            displayTVA: document.getElementById('displayTVA'),
            displayTotalTTC: document.getElementById('displayTotalTTC'),
            displayDetails: document.getElementById('displayDetails'),
            displayInvoiceOwnerPhoneFooter: document.getElementById('displayInvoiceOwnerPhoneFooter'),
            displayInvoiceOwnerAddressFooter: document.getElementById('displayInvoiceOwnerAddressFooter'),

            // Firebase Data & Stats
            commonPhoneDropdown: document.getElementById('commonPhoneDropdown'),
            commonSearchInput: document.getElementById('commonSearchInput'),
            clearCommonSearchInputButton: document.getElementById('clearCommonSearchInput'),
            allSearchOptionsDatalist: document.getElementById('allSearchOptions'),
            firebaseProductListCountSpan: document.getElementById('firebaseProductListCount'),
            firebaseProductListContainer: document.getElementById('productListContainerdata'),
            firebaseLoader: document.getElementById('firebaseLoader'),
            totalPurchaseCost: document.getElementById('totalPurchaseCost'),
            totalSellingPrice: document.getElementById('totalSellingPrice'),
            totalCommission: document.getElementById('totalCommission'),
            totalProfit: document.getElementById('totalProfit'),
            totalSalesHT: document.getElementById('totalSalesHT'),
            totalTVA: document.getElementById('totalTVA'),
            totalSalesTTC: document.getElementById('totalSalesTTC'),
            dynamicStatsListContainer: document.getElementById('dynamicStatsListContainer'),
            topSellingProductsList: document.getElementById('topSellingProductsList'),
            topCustomersList: document.getElementById('topCustomersList'),
            topInvoiceOwnersList: document.getElementById('topInvoiceOwnersList'),
            topSuppliersList: document.getElementById('topSuppliersList'),

            // Local Archive
            localInvoicesList: document.getElementById('localInvoicesList'),
            searchLocalInvoiceInput: document.getElementById('searchLocalInvoice'),
            localArchiveLoader: document.getElementById('localArchiveLoader'),

            // Datalists
            productNamesDatalist: document.getElementById('productNames'),
            supplierNamesDatalist: document.getElementById('supplierNames'),
            supplierAddressesDatalist: document.getElementById('supplierAddresses'),
            supplierPhonesDatalist: document.getElementById('supplierPhones'),
            customerNamesDatalist: document.getElementById('customerNames'),
            invoiceOwnersDatalist: document.getElementById('invoiceOwners'),
            invoiceOwnerAddressesDatalist: document.getElementById('invoiceOwnerAddresses'),
            invoiceOwnerPhonesDatalist: document.getElementById('invoiceOwnerPhones'),
            localInvoiceSearchOptionsDatalist: document.getElementById('localInvoiceSearchOptions'),

            // Modals & Toasts
            toastContainer: document.getElementById('toast-container'),
            confirmModalOverlay: document.getElementById('confirm-modal-overlay'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalMessage: document.getElementById('confirm-modal-message'),
            confirmYesBtn: document.getElementById('confirm-yes-btn'),
            confirmNoBtn: document.getElementById('confirm-no-btn'),
        };

        let confirmResolve; // To handle modal promise resolution

        // ====== UI Utility Functions ======
        const UI = {
            hideAllSections: (instant = false) => {
                [UIElements.mainDashboardView, UIElements.invoiceDisplay, UIElements.firebaseProductsDisplay, UIElements.localArchiveView].forEach(section => {
                    if (section.classList.contains('visible')) {
                        section.classList.remove('visible');
                        if (instant) {
                            section.hidden = true;
                        } else {
                            setTimeout(() => { section.hidden = true; }, 500);
                        }
                    } else if (instant) {
                        section.hidden = true;
                    }
                });
            },

            showSection: (sectionToShow) => {
                return new Promise(resolve => {
                    UI.hideAllSections();
                    sectionToShow.hidden = false;
                    setTimeout(() => {
                        sectionToShow.classList.add('visible');
                        resolve();
                    }, 10);
                });
            },

            setActiveButton: (activeBtn, buttonGroup) => {
                buttonGroup.forEach(btn => { btn.classList.remove('active'); });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            },

            resetValidationMessages: (form) => {
                form.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
                    field.classList.remove('error');
                    const errorMessageSpan = field.nextElementSibling;
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = '';
                        errorMessageSpan.style.display = 'none';
                    }
                });
            },

            showToast: (message, type) => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                let iconHtml = '';
                if (type === 'success') { iconHtml = '<span class="icon"><i class="fas fa-check"></i></span>'; }
                else if (type === 'error') { iconHtml = '<span class="icon"><i class="fas fa-times"></i></span>'; }
                else if (type === 'info') { iconHtml = '<span class="icon"><i class="fas fa-info-circle"></i></span>'; }
                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                UIElements.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            },

            showConfirmModal: (title, message) => {
                return new Promise(resolve => {
                    confirmResolve = resolve;
                    UIElements.confirmModalTitle.textContent = title;
                    UIElements.confirmModalMessage.textContent = message;
                    UIElements.confirmModalOverlay.hidden = false;
                    UIElements.confirmModalOverlay.classList.add('active');
                    const handleConfirm = (result) => {
                        UIElements.confirmModalOverlay.classList.remove('active');
                        UIElements.confirmModalOverlay.hidden = true;
                        UIElements.confirmYesBtn.removeEventListener('click', handleYes);
                        UIElements.confirmNoBtn.removeEventListener('click', handleNo);
                        resolve(result);
                    };
                    const handleYes = () => handleConfirm(true);
                    const handleNo = () => handleConfirm(false);
                    UIElements.confirmYesBtn.addEventListener('click', handleYes);
                    UIElements.confirmNoBtn.addEventListener('click', handleNo);
                });
            },

            toggleButtonLoading: (button, isLoading) => {
                const loader = button.querySelector('.loader-inline');
                if (loader) {
                    if (isLoading) {
                        button.classList.add('loading');
                        loader.classList.add('active');
                        button.disabled = true;
                    } else {
                        button.classList.remove('loading');
                        loader.classList.remove('active');
                        button.disabled = false;
                    }
                }
            },

            toggleGeneralLoader: (loaderElement, isLoading) => {
                if (loaderElement) {
                    loaderElement.classList.toggle('active', isLoading);
                }
            },

            updateProductCardClass: (productDiv, quantitySelected, stockQuantity) => {
                const existingClasses = Array.from(productDiv.classList).filter(cls =>
                    cls === 'is-local' || cls === 'is-local-match'
                );
                productDiv.className = 'product-card';
                existingClasses.forEach(cls => productDiv.classList.add(cls));

                if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                    productDiv.classList.add('status-insufficient');
                } else if (quantitySelected > 0) {
                    productDiv.classList.add('status-selected-sufficient');
                } else if (stockQuantity > 0) {
                    productDiv.classList.add('status-stock-positive');
                } else {
                    productDiv.classList.add('status-default');
                }
            },

            populateUniqueDatalist: (datalistElement, sourceArray, propertyName) => {
                const uniqueValues = new Set();
                sourceArray.forEach(item => {
                    if (item && item[propertyName]) {
                        uniqueValues.add(item[propertyName].trim());
                    }
                });

                if (propertyName === 'name' || propertyName === 'supplierName') {
                    allFirebaseInvoicesData.forEach(invoice => {
                        if (invoice.products) {
                            invoice.products.forEach(product => {
                                if (propertyName === 'name' && product.name) {
                                    uniqueValues.add(product.name.trim());
                                }
                                if (propertyName === 'supplierName' && product.supplierName) {
                                    uniqueValues.add(product.supplierName.trim());
                                }
                            });
                        }
                    });
                }
                datalistElement.innerHTML = '';
                Array.from(uniqueValues).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    datalistElement.appendChild(option);
                });
            },

            populateAllDatalists: () => {
                const savedProducts = DataStore.getSavedProducts();
                UI.populateUniqueDatalist(UIElements.productNamesDatalist, savedProducts, 'name');
                UI.populateUniqueDatalist(UIElements.supplierNamesDatalist, savedProducts, 'supplierName');
                UI.populateUniqueDatalist(UIElements.supplierAddressesDatalist, savedProducts, 'supplierAddress');
                UI.populateUniqueDatalist(UIElements.supplierPhonesDatalist, savedProducts, 'supplierPhone');

                const allInvoiceRelatedData = [...allLocalInvoices, ...allFirebaseInvoicesData];
                UI.populateUniqueDatalist(UIElements.customerNamesDatalist, allInvoiceRelatedData, 'customerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnersDatalist, allInvoiceRelatedData, 'ownerName');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerAddressesDatalist, allInvoiceRelatedData, 'ownerAddress');
                UI.populateUniqueDatalist(UIElements.invoiceOwnerPhonesDatalist, allInvoiceRelatedData, 'ownerPhone');

                UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allFirebaseProducts, 'name');
                UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allInvoiceRelatedData, 'customerName');
                UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerName');
                UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allInvoiceRelatedData, 'ownerPhone');
                UI.populateUniqueDatalist(UIElements.allSearchOptionsDatalist, allInvoiceRelatedData, 'supplierName');

                UI.populateUniqueDatalist(UIElements.localInvoiceSearchOptionsDatalist, allLocalInvoices, 'customerName');
                UI.populateUniqueDatalist(UIElements.localInvoiceSearchOptionsDatalist, allLocalInvoices, 'ownerName');
                UI.populateUniqueDatalist(UIElements.localInvoiceSearchOptionsDatalist, allLocalInvoices, 'date');
                allLocalInvoices.forEach(invoice => {
                    if (invoice.products) {
                        invoice.products.forEach(p => {
                            if (p.name) {
                                const option = document.createElement('option');
                                option.value = p.name.trim();
                                UIElements.localInvoiceSearchOptionsDatalist.appendChild(option);
                            }
                        });
                    }
                });
            }
        };

        // ====== Data Storage & Manipulation ======
        const DataStore = {
            getSavedProducts: () => {
                return JSON.parse(localStorage.getItem('savedProducts') || '[]');
            },

            setSavedProducts: (products) => {
                localStorage.setItem('savedProducts', JSON.stringify(products));
            },

            saveProduct: async (productData, isEditing = false) => {
                let products = DataStore.getSavedProducts();
                if (isEditing) {
                    const index = products.findIndex(p => p.id === productData.id);
                    if (index !== -1) {
                        products[index] = productData;
                    }
                } else {
                    products.push(productData);
                }
                products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                DataStore.setSavedProducts(products);
            },

            deleteProduct: (id) => {
                let products = DataStore.getSavedProducts();
                products = products.filter(product => product.id !== id);
                DataStore.setSavedProducts(products);
            },

            updateProductStock: (id, newStockQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].stockQuantity = Math.max(0, newStockQuantity);
                    DataStore.setSavedProducts(products);
                    const productDiv = UIElements.savedProductsList.querySelector(`.product-card[data-id="${id}"]`);
                    if (productDiv) {
                        UI.updateProductCardClass(productDiv, products[index].quantity || 0, products[index].stockQuantity);
                    }
                }
            },

            updateProductInvoiceQuantity: (id, newQuantity) => {
                let products = DataStore.getSavedProducts();
                const index = products.findIndex(product => product.id === id);
                if (index !== -1) {
                    products[index].quantity = Math.max(0, newQuantity);
                    DataStore.setSavedProducts(products);
                    const productDiv = UIElements.savedProductsList.querySelector(`.product-card[data-id="${id}"]`);
                    if (productDiv) {
                        UI.updateProductCardClass(productDiv, products[index].quantity, products[index].stockQuantity || 0);
                    }
                }
            },

            resetAllProductQuantities: () => {
                let products = DataStore.getSavedProducts();
                products.forEach(product => { product.quantity = 0; });
                DataStore.setSavedProducts(products);
            },

            saveInvoiceToLocal: (invoiceData) => {
                try {
                    let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                    localInvoices.push(invoiceData);
                    localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                    UI.showToast("تم حفظ الفاتورة محلياً.", 'success');
                } catch (e) {
                    console.error("Error saving invoice to local storage:", e);
                    UI.showToast("حدث خطأ أثناء حفظ الفاتورة محلياً.", 'error');
                }
            },

            deleteLocalInvoice: (invoiceId) => {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
            },

            loadFormDefaults: () => {
                const now = new Date();
                const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' });
                UIElements.invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
                UIElements.displayInvoiceDate.setAttribute('datetime', now.toISOString());

                UIElements.invoiceOwnerInput.value = localStorage.getItem('invoiceOwner') || '';
                UIElements.invoiceOwnerPhoneInput.value = localStorage.getItem('invoiceOwnerPhone') || '';
                UIElements.invoiceOwnerAddressInput.value = localStorage.getItem('invoiceOwnerAddress') || '';
                UIElements.supplierNameInput.value = localStorage.getItem('supplierName') || '';
                UIElements.supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
                UIElements.supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
                UIElements.invoiceCommissionAmountInput.value = localStorage.getItem('invoiceCommissionAmount') || '0';
                UIElements.tvaInput.value = localStorage.getItem('tva') || '0';
            }
        };

        // ====== Navigation & View Management ======
        const Navigation = {
            init: () => {
                UIElements.desktopNavButtons.forEach(button => {
                    button.addEventListener('click', Navigation.handleDesktopNavClick);
                });
                UIElements.mobileNavButtons.forEach(button => {
                    button.addEventListener('click', Navigation.handleMobileNavClick);
                });
            },

            handleDesktopNavClick: async (event) => {
                const buttonId = event.target.id;
                UI.setActiveButton(event.target, UIElements.desktopNavButtons);
                Navigation.handleNavAction(buttonId);
            },

            handleMobileNavClick: async (event) => {
                const buttonId = event.target.id;
                UI.setActiveButton(event.target, UIElements.mobileNavButtons);
                Navigation.handleNavAction(buttonId);
            },

            handleNavAction: async (buttonId) => {
                UIElements.commonSearchInput.value = '';
                UIElements.searchProductInput.value = '';
                UIElements.searchLocalInvoiceInput.value = '';
                UIElements.mainContainer.classList.remove('full-width');

                if (buttonId.includes('Dashboard')) {
                    await UI.showSection(UIElements.mainDashboardView);
                    SalesProducts.displaySavedProducts();
                } else if (buttonId.includes('FirebaseData')) {
                    await UI.showSection(UIElements.firebaseProductsDisplay);
                    UIElements.mainContainer.classList.add('full-width');
                    FirebaseData.populateCommonDropdown();
                    await FirebaseData.fetchAndDisplayCombinedFirebaseData();
                } else if (buttonId.includes('LocalArchive')) {
                    await UI.showSection(UIElements.localArchiveView);
                    UIElements.mainContainer.classList.add('full-width');
                    LocalArchive.displayLocalInvoices();
                }
                UI.populateAllDatalists();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // ====== Product Management Logic ======
        const SalesProducts = {
            init: () => {
                UIElements.addProductButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    SalesProducts.handleProductFormSubmission(null);
                });
                UIElements.saveEditProductButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    const idToEdit = e.target.dataset.editingId;
                    SalesProducts.handleProductFormSubmission(parseInt(idToEdit));
                });
                UIElements.savedProductsList.addEventListener('click', SalesProducts.handleProductListClick);
                UIElements.savedProductsList.addEventListener('change', SalesProducts.handleProductListChange);
                UIElements.searchProductInput.addEventListener('input', SalesProducts.displaySavedProducts);
                UIElements.searchProductInput.classList.add('search-input');
            },

            handleProductFormSubmission: async (productId = null) => {
                UI.toggleButtonLoading(UIElements.addProductButton, true);
                UI.toggleButtonLoading(UIElements.saveEditProductButton, true);

                if (!Validation.checkFormFields(UIElements.productForm)) {
                    UI.showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                    UI.toggleButtonLoading(UIElements.addProductButton, false);
                    UI.toggleButtonLoading(UIElements.saveEditProductButton, false);
                    return;
                }

                const productData = {
                    id: productId || Date.now(),
                    name: UIElements.productNameInput.value.trim(),
                    purchasePrice: parseFloat(UIElements.purchasePriceInput.value),
                    sellingPrice: parseFloat(UIElements.sellingPriceInput.value),
                    supplierName: UIElements.supplierNameInput.value.trim(),
                    supplierAddress: UIElements.supplierAddressInput.value.trim(),
                    supplierPhone: UIElements.supplierPhoneInput.value.trim(),
                    stockQuantity: parseInt(UIElements.productQuantityInput.value),
                    date: new Date().toLocaleDateString('ar-MA'),
                    quantity: 0,
                    isLocal: true
                };

                localStorage.setItem('supplierName', productData.supplierName);
                localStorage.setItem('supplierAddress', productData.supplierAddress);
                localStorage.setItem('supplierPhone', productData.supplierPhone);

                const products = DataStore.getSavedProducts();
                const isEditing = productId !== null;
                const duplicateCheck = products.some((p, idx) =>
                    (isEditing ? p.id !== productId : true) &&
                    (p.name || '').toLowerCase() === productData.name.toLowerCase() &&
                    p.supplierPhone === productData.supplierPhone
                );

                if (duplicateCheck) {
                    UI.showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
                    UI.toggleButtonLoading(UIElements.addProductButton, false);
                    UI.toggleButtonLoading(UIElements.saveEditProductButton, false);
                    return;
                }

                const confirmed = await UI.showConfirmModal(
                    isEditing ? "تأكيد التعديل" : "تأكيد الإضافة",
                    isEditing ? "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟" : "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟"
                );

                if (!confirmed) {
                    UI.showToast(isEditing ? "تم إلغاء تعديل المنتج." : "تم إلغاء إضافة المنتج.", 'info');
                    UI.toggleButtonLoading(UIElements.addProductButton, false);
                    UI.toggleButtonLoading(UIElements.saveEditProductButton, false);
                    return;
                }

                await DataStore.saveProduct(productData, isEditing);
                UI.showToast(isEditing ? "تم تحديث المنتج بنجاح." : "المنتج تم إضافته بنجاح.", 'success');
                SalesProducts.displaySavedProducts();
                SalesProducts.resetProductFormAndButtons();
                UI.populateAllDatalists();
                UI.toggleButtonLoading(UIElements.addProductButton, false);
                UI.toggleButtonLoading(UIElements.saveEditProductButton, false);
            },

            resetProductFormAndButtons: () => {
                UIElements.productForm.reset();
                UIElements.productFormTitle.innerHTML = '<span class="icon"><i class="fas fa-box"></i></span>إدارة المنتجات';
                UIElements.addProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.style.display = 'none';
                delete UIElements.saveEditProductButton.dataset.editingId;
                UI.resetValidationMessages(UIElements.productForm);
            },

            editProduct: async (productId) => {
                const productToEdit = DataStore.getSavedProducts().find(p => p.id === productId);
                if (!productToEdit) {
                    UI.showToast("المنتج المراد تعديله غير موجود.", 'error');
                    return;
                }

                if (UIElements.mainDashboardView.hidden) {
                    await UI.showSection(UIElements.mainDashboardView);
                    UI.setActiveButton(window.innerWidth <= 768 ? UIElements.mobileNavButtons[0] : UIElements.desktopNavButtons[0],
                        window.innerWidth <= 768 ? UIElements.mobileNavButtons : UIElements.desktopNavButtons);
                }
                UIElements.mainContainer.classList.remove('full-width');

                SalesProducts.resetProductFormAndButtons();
                UIElements.productFormTitle.innerHTML = '<span class="icon"><i class="fas fa-edit"></i></span>تعديل المنتج';
                UIElements.productNameInput.value = productToEdit.name || '';
                UIElements.purchasePriceInput.value = productToEdit.purchasePrice || 0;
                UIElements.sellingPriceInput.value = productToEdit.sellingPrice || 0;
                UIElements.supplierNameInput.value = productToEdit.supplierName || '';
                UIElements.supplierAddressInput.value = productToEdit.supplierAddress || '';
                UIElements.supplierPhoneInput.value = productToEdit.supplierPhone || '';
                UIElements.productQuantityInput.value = productToEdit.stockQuantity || 0;

                UIElements.addProductButton.style.display = 'none';
                UIElements.saveEditProductButton.style.display = 'flex';
                UIElements.saveEditProductButton.dataset.editingId = productId;

                window.scrollTo({ top: UIElements.productFormContainer.offsetTop, behavior: 'smooth' });
                UI.populateAllDatalists();
            },

            deleteProduct: async (id) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
                if (confirmed) {
                    DataStore.deleteProduct(id);
                    SalesProducts.displaySavedProducts();
                    UI.showToast("تم حذف المنتج بنجاح.", 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast("تم إلغاء حذف المنتج.", 'info');
                }
            },

            getProductStatusPriority: (quantitySelected, stockQuantity) => {
                if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1;
                if (quantitySelected > 0) return 4;
                if (stockQuantity > 0) return 5;
                return 6;
            },

            displaySavedProducts: () => {
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, true);
                const searchTerm = UIElements.searchProductInput.value.toLowerCase();
                const savedProducts = DataStore.getSavedProducts();
                UIElements.savedProductsList.innerHTML = '';

                const filteredProducts = savedProducts
                    .filter(product => (product.name || '').toLowerCase().includes(searchTerm))
                    .sort((a, b) => {
                        const statusA = SalesProducts.getProductStatusPriority(a.quantity || 0, a.stockQuantity || 0);
                        const statusB = SalesProducts.getProductStatusPriority(b.quantity || 0, b.stockQuantity || 0);
                        if (statusA !== statusB) return statusA - statusB;
                        if (a.isLocal && !b.isLocal) return -1;
                        if (!a.isLocal && b.isLocal) return 1;
                        return (b.stockQuantity || 0) - (a.stockQuantity || 0) || (a.name || '').localeCompare(b.name || '');
                    });

                if (filteredProducts.length === 0) {
                    UIElements.savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
                    UI.toggleGeneralLoader(UIElements.savedProductsLoader, false);
                    return;
                }

                filteredProducts.forEach((product) => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-card';
                    productDiv.dataset.id = product.id;
                    if (product.isLocal) productDiv.classList.add('is-local');
                    UI.updateProductCardClass(productDiv, product.quantity || 0, product.stockQuantity || 0);

                    productDiv.innerHTML = `
                        <div class="product-details">
                            <p><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                            <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                            <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                            <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                            <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                        </div>
                        <p><strong>الكمية في المخزون:</strong></p>
                        <div class="quantity-controls">
                            <button type="button" class="stock-adjust-btn" data-action="plus">+</button>
                            <input type="number" id="stock-${product.id}" value="${product.stockQuantity || 0}" min="0" data-product-id="${product.id}" class="stock-input">
                            <button type="button" class="stock-adjust-btn" data-action="minus">-</button>
                        </div>
                        <p><strong>الكمية المحددة للفاتورة:</strong></p>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-adjust-btn" data-action="plus">+</button>
                            <input type="number" class="product-quantity-input" data-id="${product.id}" value="${product.quantity || 0}" min="0">
                            <button type="button" class="quantity-adjust-btn" data-action="minus">-</button>
                        </div>
                        <div class="product-actions">
                            <button type="button" class="btn-base btn-danger" data-product-id="${product.id}"><span class="icon"><i class="fas fa-trash-alt"></i></span>حذف</button>
                            <button type="button" class="btn-base btn-warning" data-product-id="${product.id}"><span class="icon"><i class="fas fa-edit"></i></span>تعديل</button>
                        </div>
                    `;
                    UIElements.savedProductsList.appendChild(productDiv);
                });
                UI.toggleGeneralLoader(UIElements.savedProductsLoader, false);
            },

            handleProductListClick: (event) => {
                const target = event.target;
                const productDiv = target.closest('.product-card');
                if (!productDiv) return;
                const productId = parseInt(productDiv.dataset.id);
                if (isNaN(productId)) return;

                if (target.classList.contains('btn-warning') || target.closest('.btn-warning')) {
                    SalesProducts.editProduct(productId);
                } else if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) {
                    SalesProducts.deleteProduct(productId);
                } else if (target.classList.contains('stock-adjust-btn')) {
                    const stockInput = productDiv.querySelector('.stock-input');
                    let currentVal = parseInt(stockInput.value) || 0;
                    currentVal += (target.dataset.action === 'plus' ? 1 : -1);
                    stockInput.value = Math.max(0, currentVal);
                    DataStore.updateProductStock(productId, currentVal);
                } else if (target.classList.contains('quantity-adjust-btn')) {
                    const quantityInput = productDiv.querySelector('.product-quantity-input');
                    let currentVal = parseInt(quantityInput.value) || 0;
                    currentVal += (target.dataset.action === 'plus' ? 1 : -1);
                    quantityInput.value = Math.max(0, currentVal);
                    DataStore.updateProductInvoiceQuantity(productId, currentVal);
                }
            },

            handleProductListChange: (event) => {
                const target = event.target;
                const productDiv = target.closest('.product-card');
                if (!productDiv) return;
                const productId = parseInt(productDiv.dataset.id);
                if (isNaN(productId)) return;

                if (target.classList.contains('stock-input')) {
                    DataStore.updateProductStock(productId, parseInt(target.value));
                } else if (target.classList.contains('product-quantity-input')) {
                    DataStore.updateProductInvoiceQuantity(productId, parseInt(target.value));
                }
            }
        };

        // ====== Invoice Creation & Display Logic ======
        const InvoiceManager = {
            init: () => {
                UIElements.createInvoiceButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    InvoiceManager.createAndDisplayInvoice();
                });
                UIElements.savePdfButton.addEventListener('click', InvoiceManager.updateStockAndSaveInvoice);
                UIElements.printButton.addEventListener('click', InvoiceManager.printInvoice);
                UIElements.editFirebaseInvoiceButton.addEventListener('click', InvoiceManager.loadFirebaseInvoiceForEdit);
                UIElements.updateFirebaseInvoiceButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    InvoiceManager.updateFirebaseInvoice();
                });
            },

            createAndDisplayInvoice: async () => {
                UI.toggleButtonLoading(UIElements.createInvoiceButton, true);
                UIElements.updateFirebaseInvoiceButton.style.display = 'none';
                localStorage.setItem('tva', UIElements.tvaInput.value);

                if (!Validation.checkFormFields(UIElements.invoiceForm)) {
                    UI.showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                    UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                    return;
                }

                let totalHTBeforeCommission = 0;
                let totalProfit = 0;
                let totalCommission = 0;

                let allSavedProducts = DataStore.getSavedProducts();
                let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);
                let productsToProcessForInvoice = [];

                if (selectedProductsForInvoice.length === 0) {
                    const confirmed = await UI.showConfirmModal(
                        "تحديد المنتجات",
                        "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة جميع المنتجات بكمية 1 بشكل افتراضي (حتى لو كان المخزون غير متوفر)؟"
                    );
                    if (confirmed) {
                        productsToProcessForInvoice = allSavedProducts.map(product => ({ ...product, quantityUsed: 1 }));
                        productsToProcessForInvoice = productsToProcessForInvoice.filter(p => p.quantityUsed > 0);
                        if (productsToProcessForInvoice.length === 0) {
                            UI.showToast("لا توجد منتجات لتضمينها في الفاتورة بعد التحديث.", 'info');
                            UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                            return;
                        }
                    } else {
                        UI.showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                        UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
                        return;
                    }
                } else {
                    productsToProcessForInvoice = selectedProductsForInvoice.map(product => ({ ...product, quantityUsed: product.quantity }));
                }

                productsToProcessForInvoice.forEach((productData) => {
                    const quantity = productData.quantityUsed;
                    const sellingPrice = parseFloat(productData.sellingPrice || 0);
                    const purchasePrice = parseFloat(productData.purchasePrice || 0);
                    totalHTBeforeCommission += sellingPrice * quantity;
                    totalProfit += (sellingPrice - purchasePrice) * quantity;
                });

                const invoiceCommissionAmount = parseFloat(UIElements.invoiceCommissionAmountInput.value) || 0;
                totalCommission = invoiceCommissionAmount;
                const finalTotalHT = totalHTBeforeCommission - totalCommission;
                const tvaRate = parseFloat(UIElements.tvaInput.value) / 100;
                const tva = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);
                totalProfit -= totalCommission;

                localStorage.setItem('invoiceOwner', UIElements.invoiceOwnerInput.value);
                localStorage.setItem('invoiceOwnerPhone', UIElements.invoiceOwnerPhoneInput.value);
                localStorage.setItem('invoiceOwnerAddress', UIElements.invoiceOwnerAddressInput.value);
                localStorage.setItem('invoiceCommissionAmount', invoiceCommissionAmount);

                currentInvoiceBeingProcessed = {
                    id: Date.now(),
                    date: UIElements.invoiceDateInput.value,
                    isoDate: new Date().toISOString(),
                    customerName: UIElements.customerNameInput.value,
                    ownerName: UIElements.invoiceOwnerInput.value,
                    ownerAddress: UIElements.invoiceOwnerAddressInput.value,
                    ownerPhone: UIElements.invoiceOwnerPhoneInput.value,
                    products: productsToProcessForInvoice,
                    totalHT: finalTotalHT.toFixed(2),
                    totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                    tva: tva,
                    totalTTC: totalTTC,
                    totalProfit: totalProfit.toFixed(2),
                    totalCommission: totalCommission.toFixed(2),
                    invoiceCommissionRate: 0
                };

                await InvoiceManager.displayFullInvoice(currentInvoiceBeingProcessed, true, false);
                UI.toggleButtonLoading(UIElements.createInvoiceButton, false);
            },

            displayFullInvoice: async (invoiceData, isNew = false, isFirebaseInvoice = false) => {
                await UI.showSection(UIElements.invoiceDisplay);
                UIElements.mainContainer.classList.add('full-width');

                UIElements.displayCustomerName.textContent = invoiceData.customerName || 'N/A';
                UIElements.displayInvoiceOwner.textContent = invoiceData.ownerName || 'N/A';
                UIElements.displayInvoiceDate.textContent = invoiceData.date || 'N/A';
                UIElements.displayTotalAmountBeforeCommission.textContent = `${parseFloat(invoiceData.totalHTBeforeCommission || 0).toFixed(2)} DH`;
                UIElements.displayCommissionDeducted.textContent = `${parseFloat(invoiceData.totalCommission || 0).toFixed(2)} DH`;
                UIElements.displayTotalAmount.textContent = `${parseFloat(invoiceData.totalHT || 0).toFixed(2)} DH`;
                UIElements.displayTVA.textContent = `${parseFloat(invoiceData.tva || 0).toFixed(2)} DH`;
                UIElements.displayTotalTTC.textContent = `${parseFloat(invoiceData.totalTTC || 0).toFixed(2)} DH`;
                UIElements.displayInvoiceOwnerPhoneFooter.textContent = invoiceData.ownerPhone || 'N/A';
                UIElements.displayInvoiceOwnerAddressFooter.textContent = invoiceData.ownerAddress || 'N/A';

                UIElements.displayDetails.innerHTML = '';
                let productNumber = 1;
                if (invoiceData.products && invoiceData.products.length > 0) {
                    invoiceData.products.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${productNumber++}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</td>
                            <td>${product.quantityUsed || 0}</td>
                            <td>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</td>
                        `;
                        UIElements.displayDetails.appendChild(row);
                    });
                } else {
                    UIElements.displayDetails.innerHTML = `<td colspan="5" style="text-align: center; font-style: italic;">لا توجد منتجات في هذه الفاتورة.</td>`;
                }

                UIElements.savePdfButton.style.display = isNew ? 'flex' : 'none';
                UIElements.editFirebaseInvoiceButton.style.display = isFirebaseInvoice ? 'flex' : 'none';

                currentFirebaseInvoiceKey = isFirebaseInvoice ? `${invoiceData.firebasePhoneKey}/${invoiceData.id}` : null;
                isNewInvoice = isNew;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            updateStockAndSaveInvoice: async function () {
                UI.toggleButtonLoading(this, true);

                if (!isNewInvoice) {
                    UI.showToast("لا يمكن تحديث المخزون لفاتورة مؤرشفة. يجب أن تكون فاتورة جديدة.", 'info');
                    UI.toggleButtonLoading(this, false);
                    return;
                }
                if (!currentInvoiceBeingProcessed) {
                    UI.showToast("خطأ: لا توجد فاتورة قيد المعالجة لتحديث المخزون.", 'error');
                    UI.toggleButtonLoading(this, false);
                    return;
                }

                let savedProducts = DataStore.getSavedProducts();
                let hasInsufficientStock = false;
                let productsToDeduct = [];

                currentInvoiceBeingProcessed.products.forEach((invoiceProduct) => {
                    const productMatch = savedProducts.find(p =>
                        (p.name || '').toLowerCase() === (invoiceProduct.name || '').toLowerCase() &&
                        ((p.supplierPhone || '').toLowerCase() === (invoiceProduct.supplierPhone || '').toLowerCase() ||
                            (p.supplierPhone || '').toLowerCase() === (invoiceProduct.ownerPhone || '').toLowerCase())
                    );

                    const quantityUsedInInvoice = parseInt(invoiceProduct.quantityUsed || 0);

                    if (productMatch && quantityUsedInInvoice > 0) {
                        const currentStock = parseInt(productMatch.stockQuantity || 0);
                        if (currentStock < quantityUsedInInvoice) {
                            hasInsufficientStock = true;
                            UI.showToast(`تنبيه: كمية غير كافية للمنتج "${invoiceProduct.name}". المخزون المتاح: ${currentStock}`, 'error');
                        }
                        productsToDeduct.push({ productId: productMatch.id, quantityUsed: quantityUsedInInvoice });
                    } else if (quantityUsedInInvoice > 0) {
                        hasInsufficientStock = true;
                        UI.showToast(`تنبيه: المنتج "${invoiceProduct.name}" (المورد: ${invoiceProduct.supplierName || invoiceProduct.ownerName || 'N/A'}) في الفاتورة غير موجود محلياً. لا يمكن تحديث المخزون.`, 'error');
                    }
                });

                if (hasInsufficientStock) {
                    UI.showToast("يرجى مراجعة المنتجات ذات المخزون غير الكافي قبل التحديث.", 'error');
                    UI.toggleButtonLoading(this, false);
                    return;
                }

                const confirmed = await UI.showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة وحفظها؟");

                if (confirmed) {
                    productsToDeduct.forEach(({ productId, quantityUsed }) => {
                        const productIndex = savedProducts.findIndex(p => p.id === productId);
                        if (productIndex !== -1) {
                            savedProducts[productIndex].stockQuantity -= quantityUsed;
                            savedProducts[productIndex].stockQuantity = Math.max(0, savedProducts[productIndex].stockQuantity);
                            savedProducts[productIndex].quantity = 0;
                        }
                    });
                    DataStore.setSavedProducts(savedProducts);

                    if (database) {
                        try {
                            const firebasePath = `${appId}/alldata/${currentInvoiceBeingProcessed.ownerPhone}`;
                            await database.ref(firebasePath).push(currentInvoiceBeingProcessed);
                            UI.showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success');
                        } catch (error) {
                            UI.showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error');
                            console.error("Failed to save invoice to Firebase:", error);
                        }
                    } else {
                        UI.showToast("لم يتم تهيئة قاعدة بيانات Firebase. لا يمكن حفظ الفاتورة.", 'error');
                    }

                    DataStore.saveInvoiceToLocal(currentInvoiceBeingProcessed);
                    currentInvoiceBeingProcessed = null;
                    isNewInvoice = false;

                    Navigation.handleNavAction(window.innerWidth <= 768 ? 'mobileShowDashboardButton' : 'showDashboardButton');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast("تم إلغاء تحديث المخزون.", 'info');
                }
                UI.toggleButtonLoading(this, false);
            },

            printInvoice: function () {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                let originalViewportContent = '';
                if (viewportMeta) {
                    originalViewportContent = viewportMeta.getAttribute('content');
                    viewportMeta.setAttribute('content', 'width=1024');
                }

                const invoicePrintGroup = document.querySelector('.invoice-actions-print-group');
                if (invoicePrintGroup) {
                    invoicePrintGroup.style.display = 'none';
                }

                window.print();

                setTimeout(() => {
                    if (invoicePrintGroup) {
                        invoicePrintGroup.style.display = 'flex';
                    }
                    if (viewportMeta && originalViewportContent) {
                        viewportMeta.setAttribute('content', originalViewportContent);
                    }
                }, 500);
            },

            loadFirebaseInvoiceForEdit: function (invoiceData = currentInvoiceBeingProcessed) {
                if (!invoiceData) return UI.showToast("لا توجد فاتورة Firebase محددة للتعديل.", 'error');

                Navigation.handleNavAction(window.innerWidth <= 768 ? 'mobileShowDashboardButton' : 'showDashboardButton');
                window.scrollTo({ top: UIElements.clientFormContainer.offsetTop, behavior: 'smooth' });

                currentFirebaseInvoiceKey = `${invoiceData.firebasePhoneKey}/${invoiceData.id}`;

                UIElements.invoiceDateInput.value = invoiceData.date || '';
                UIElements.customerNameInput.value = invoiceData.customerName || '';
                UIElements.invoiceOwnerInput.value = invoiceData.ownerName || '';
                UIElements.invoiceOwnerAddressInput.value = invoiceData.ownerAddress || '';
                UIElements.invoiceOwnerPhoneInput.value = invoiceData.ownerPhone || '';
                UIElements.tvaInput.value = parseFloat(invoiceData.tva) || 0;
                UIElements.invoiceCommissionAmountInput.value = parseFloat(invoiceData.totalCommission) || 0;

                let savedProducts = DataStore.getSavedProducts();
                savedProducts.forEach(p => p.quantity = 0);

                if (invoiceData.products && invoiceData.products.length > 0) {
                    invoiceData.products.forEach(fbProduct => {
                        const productIndex = savedProducts.findIndex(localP =>
                            (localP.name || '').toLowerCase() === (fbProduct.name || '').toLowerCase() &&
                            ((localP.supplierPhone || '').toLowerCase() === (fbProduct.supplierPhone || '').toLowerCase() ||
                                (localP.supplierPhone || '').toLowerCase() === (fbProduct.ownerPhone || '').toLowerCase())
                        );
                        if (productIndex !== -1) {
                            savedProducts[productIndex].quantity = fbProduct.quantityUsed || 0;
                        } else {
                            savedProducts.push({
                                id: Date.now() + Math.random(),
                                name: fbProduct.name,
                                purchasePrice: parseFloat(fbProduct.purchasePrice || 0),
                                sellingPrice: parseFloat(fbProduct.sellingPrice || 0),
                                supplierName: fbProduct.supplierName || invoiceData.ownerName || 'N/A',
                                supplierAddress: fbProduct.ownerAddress || 'N/A',
                                supplierPhone: fbProduct.ownerPhone,
                                stockQuantity: 0,
                                date: new Date().toLocaleDateString('ar-MA'),
                                quantity: fbProduct.quantityUsed || 0,
                                isLocal: false,
                                isLocalMatch: false
                            });
                        }
                    });
                }
                DataStore.setSavedProducts(savedProducts);
                SalesProducts.displaySavedProducts();

                UIElements.createInvoiceButton.style.display = 'none';
                UIElements.updateFirebaseInvoiceButton.style.display = 'flex';
                UIElements.editFirebaseInvoiceButton.style.display = 'none';
            },

            updateFirebaseInvoice: async function () {
                UI.toggleButtonLoading(UIElements.updateFirebaseInvoiceButton, true);

                if (!currentFirebaseInvoiceKey) {
                    UI.showToast("خطأ: لا يوجد معرف فاتورة Firebase للتحديث.", 'error');
                    UI.toggleButtonLoading(UIElements.updateFirebaseInvoiceButton, false);
                    return;
                }
                if (!Validation.checkFormFields(UIElements.invoiceForm)) {
                    UI.showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                    UI.toggleButtonLoading(UIElements.updateFirebaseInvoiceButton, false);
                    return;
                }

                let totalHTBeforeCommission = 0;
                let totalProfit = 0;
                let totalCommission = 0;

                let productsToUpdateInInvoice = DataStore.getSavedProducts().filter(p => (p.quantity || 0) > 0).map(product => ({
                    id: product.id,
                    name: product.name,
                    purchasePrice: product.purchasePrice,
                    sellingPrice: product.sellingPrice,
                    supplierName: product.supplierName,
                    supplierAddress: product.supplierAddress,
                    supplierPhone: product.supplierPhone,
                    quantityUsed: product.quantity
                }));

                if (productsToUpdateInInvoice.length === 0) {
                    UI.showToast("لا توجد منتجات لتضمينها في الفاتورة المحدثة.", 'info');
                    UI.toggleButtonLoading(UIElements.updateFirebaseInvoiceButton, false);
                    return;
                }

                productsToUpdateInInvoice.forEach((productData) => {
                    const quantity = productData.quantityUsed;
                    const sellingPrice = parseFloat(productData.sellingPrice || 0);
                    const purchasePrice = parseFloat(productData.purchasePrice || 0);
                    totalHTBeforeCommission += sellingPrice * quantity;
                    totalProfit += (sellingPrice - purchasePrice) * quantity;
                });

                totalCommission = parseFloat(UIElements.invoiceCommissionAmountInput.value) || 0;
                const finalTotalHT = totalHTBeforeCommission - totalCommission;
                const tvaRate = parseFloat(UIElements.tvaInput.value) / 100;
                const tva = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);
                totalProfit -= totalCommission;

                const updatedInvoiceData = {
                    date: UIElements.invoiceDateInput.value,
                    isoDate: new Date().toISOString(),
                    customerName: UIElements.customerNameInput.value,
                    ownerName: UIElements.invoiceOwnerInput.value,
                    ownerAddress: UIElements.invoiceOwnerAddressInput.value,
                    ownerPhone: UIElements.invoiceOwnerPhoneInput.value,
                    products: productsToUpdateInInvoice,
                    totalHT: finalTotalHT.toFixed(2),
                    totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                    tva: tva,
                    totalTTC: totalTTC,
                    totalProfit: totalProfit.toFixed(2),
                    totalCommission: totalCommission.toFixed(2),
                    invoiceCommissionRate: 0
                };

                const confirmed = await UI.showConfirmModal("تأكيد التحديث", "هل أنت متأكد من تحديث هذه الفاتورة في Firebase؟");
                if (confirmed) {
                    if (database) {
                        try {
                            await database.ref(`${appId}/alldata/${currentFirebaseInvoiceKey}`).set(updatedInvoiceData);
                            UI.showToast("تم تحديث الفاتورة في Firebase بنجاح.", 'success');
                            DataStore.resetAllProductQuantities();
                            SalesProducts.displaySavedProducts();
                            UI.populateAllDatalists();
                            Navigation.handleNavAction(window.innerWidth <= 768 ? 'mobileShowFirebaseDataButton' : 'showFirebaseDataButton');
                        } catch (error) {
                            UI.showToast(`خطأ في تحديث الفاتورة في Firebase: ${error.message}`, 'error');
                            console.error("Failed to update Firebase invoice:", error);
                        }
                    } else {
                        UI.showToast("قاعدة بيانات Firebase غير مهيأة. لا يمكن تحديث الفاتورة.", 'error');
                    }
                } else {
                    UI.showToast("تم إلغاء تحديث الفاتورة.", 'info');
                }
                UI.toggleButtonLoading(UIElements.updateFirebaseInvoiceButton, false);
            }
        };

        // ====== Firebase Data & Statistics Logic ======
        const FirebaseData = {
            init: () => {
                UIElements.commonSearchInput.addEventListener('input', FirebaseData.applyCombinedFilters);
                UIElements.clearCommonSearchInputButton.addEventListener('click', FirebaseData.clearAndFilter);
                UIElements.commonPhoneDropdown.addEventListener('change', FirebaseData.applyCombinedFilters);
                UIElements.commonSearchInput.classList.add('search-input');
            },

            populateCommonDropdown: () => {
                if (!database) return UI.showToast("قاعدة بيانات Firebase غير جاهزة لملء أرقام الهواتف.", 'info');

                const alldataRef = database.ref(`${appId}/alldata`);
                alldataRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    UIElements.commonPhoneDropdown.innerHTML = '<option value="all">عرض الكل</option>';
                    const phoneNumbers = new Set();
                    if (data) {
                        for (const phoneKey in data) {
                            if (data.hasOwnProperty(phoneKey)) {
                                phoneNumbers.add(phoneKey);
                            }
                        }
                    }
                    Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                        const option = document.createElement('option');
                        option.value = phoneNumber;
                        option.textContent = phoneNumber;
                        UIElements.commonPhoneDropdown.appendChild(option);
                    });
                }, (error) => {
                    UI.showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
                    console.error("Failed to fetch phone numbers from Firebase:", error);
                });
            },

            fetchAndDisplayCombinedFirebaseData: async () => {
                UI.toggleGeneralLoader(UIElements.firebaseLoader, true);
                if (!database) {
                    UI.showToast("قاعدة بيانات Firebase غير جاهزة لجلب البيانات.", 'info');
                    UI.toggleGeneralLoader(UIElements.firebaseLoader, false);
                    return;
                }

                const alldataRef = database.ref(`${appId}/alldata`);
                try {
                    const snapshot = await alldataRef.once('value');
                    const data = snapshot.val();
                    allFirebaseProducts = [];
                    allFirebaseInvoicesData = [];

                    if (data) {
                        for (const phoneKey in data) {
                            if (data.hasOwnProperty(phoneKey)) {
                                const phoneData = data[phoneKey];
                                for (const invoiceKey in phoneData) {
                                    if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                        const invoiceDetails = phoneData[invoiceKey];
                                        allFirebaseInvoicesData.push({ id: invoiceKey, firebasePhoneKey: phoneKey, ...invoiceDetails });
                                        invoiceDetails.products.forEach((product, index) => {
                                            allFirebaseProducts.push({
                                                id: `${invoiceKey}-${index}`,
                                                ...product,
                                                invoiceDate: invoiceDetails.date,
                                                customerName: invoiceDetails.customerName,
                                                ownerName: invoiceDetails.ownerName,
                                                ownerAddress: invoiceDetails.ownerAddress,
                                                ownerPhone: invoiceDetails.ownerPhone,
                                                totalHT: invoiceDetails.totalHT,
                                                totalTTC: invoiceDetails.totalTTC,
                                                totalProfit: invoiceDetails.totalProfit,
                                                totalCommission: invoiceDetails.totalCommission,
                                                firebaseInvoiceKey: invoiceKey
                                            });
                                        });
                                    }
                                }
                            }
                        }
                    }
                    UI.populateAllDatalists();
                    FirebaseData.applyCombinedFilters();
                } catch (error) {
                    UI.showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                    console.error("Failed to fetch Firebase data:", error);
                } finally {
                    UI.toggleGeneralLoader(UIElements.firebaseLoader, false);
                }
            },

            applyCombinedFilters: () => {
                const searchTerm = UIElements.commonSearchInput.value.toLowerCase();
                const selectedPhoneNumber = UIElements.commonPhoneDropdown.value;

                const filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                    const matchesSearch = searchTerm ?
                        ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                            (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm) || (p.supplierName || '').toLowerCase().includes(searchTerm))))
                        : true;
                    const matchesPhone = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);
                    return matchesSearch && matchesPhone;
                });

                UIElements.firebaseProductListCountSpan.textContent = filteredInvoices.length;
                filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));

                FirebaseData.displayFirebaseInvoices(filteredInvoices);
                FirebaseData.displayStatistics(filteredInvoices);
            },

            clearAndFilter: () => {
                UIElements.commonSearchInput.value = '';
                FirebaseData.applyCombinedFilters();
                UI.showToast("تم مسح حقل البحث وتحديث القائمة.", 'info');
            },

            displayFirebaseInvoices: (invoices) => {
                UIElements.firebaseProductListContainer.innerHTML = '';
                if (invoices.length === 0) {
                    UIElements.firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد فواتير لعرضها.</p>';
                    return;
                }

                invoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('mini-invoice-card');
                    invoiceDiv.dataset.invoiceId = invoice.id;
                    invoiceDiv.dataset.firebasePhoneKey = invoice.firebasePhoneKey;

                    let productsListHtml = '<p style="text-align: center; font-style: italic; color: var(--text-secondary-gray);">لا توجد منتجات في هذه الفاتورة.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="mini-product-list">
                                <div class="mini-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية</div>
                                    <div>الإجمالي (HT)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="mini-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.quantityUsed || 0}</div>
                                        <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    invoiceDiv.innerHTML = `
                        <div class="invoice-mini-header">
                            <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="invoice-mini-footer">
                            <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                            <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                        </div>
                    `;

                    invoiceDiv.addEventListener('click', async (event) => {
                        const firebaseInvoiceId = invoiceDiv.dataset.invoiceId;
                        const firebasePhoneKey = invoiceDiv.dataset.firebasePhoneKey;
                        const selectedFirebaseInvoice = allFirebaseInvoicesData.find(inv =>
                            inv.id === firebaseInvoiceId && inv.firebasePhoneKey === firebasePhoneKey
                        );
                        if (selectedFirebaseInvoice) {
                            await InvoiceManager.displayFullInvoice(selectedFirebaseInvoice, false, true);
                        } else {
                            UI.showToast("تعذر العثور على الفاتورة في بيانات Firebase.", 'error');
                        }
                    });
                    UIElements.firebaseProductListContainer.appendChild(invoiceDiv);
                });
            },

            displayStatistics: (invoices) => {
                let totalSalesHT = 0;
                let totalTVA = 0;
                let totalSalesTTC = 0;
                let totalOverallProfit = 0;
                let totalOverallCommission = 0;
                let totalPurchaseCostAllProducts = 0;
                let totalSellingPriceAllProducts = 0;

                const productSales = {};
                const customerActivity = {};
                const invoiceOwnerActivity = {};
                const supplierActivity = {};

                invoices.forEach(invoice => {
                    totalSalesHT += parseFloat(invoice.totalHT || 0);
                    totalTVA += parseFloat(invoice.tva || 0);
                    totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                    totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                    totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                    if (invoice.products) {
                        invoice.products.forEach(product => {
                            const productName = product.name || 'N/A';
                            const quantityUsed = parseInt(product.quantityUsed || 0);
                            const purchasePrice = parseFloat(product.purchasePrice || 0);
                            const sellingPrice = parseFloat(product.sellingPrice || 0);
                            const supplierName = product.supplierName || invoice.ownerName || 'N/A';

                            totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                            totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                            productSales[productName] = (productSales[productName] || { quantitySold: 0, totalRevenue: 0 });
                            productSales[productName].quantitySold += quantityUsed;
                            productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                            supplierActivity[supplierName] = (supplierActivity[supplierName] || { totalPurchaseCost: 0, productsCount: 0 });
                            supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                            supplierActivity[supplierName].productsCount += quantityUsed;
                        });
                    }

                    const customer = invoice.customerName || 'N/A';
                    const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                    const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                    const owner = invoice.ownerName || 'N/A';

                    customerActivity[customer] = (customerActivity[customer] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    customerActivity[customer].invoiceCount += 1;
                    customerActivity[customer].totalProfit += invoiceProfit;
                    customerActivity[customer].totalTTC += invoiceTTC;

                    invoiceOwnerActivity[owner] = (invoiceOwnerActivity[owner] || { invoiceCount: 0, totalProfit: 0, totalTTC: 0 });
                    invoiceOwnerActivity[owner].invoiceCount += 1;
                    invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                    invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
                });

                UIElements.totalPurchaseCost.textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
                UIElements.totalSellingPrice.textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
                UIElements.totalCommission.textContent = `${totalOverallCommission.toFixed(2)} DH`;
                UIElements.totalProfit.textContent = `${totalOverallProfit.toFixed(2)} DH`;
                UIElements.totalSalesHT.textContent = `${totalSalesHT.toFixed(2)} DH`;
                UIElements.totalTVA.textContent = `${totalTVA.toFixed(2)} DH`;
                UIElements.totalSalesTTC.textContent = `${totalSalesTTC.toFixed(2)} DH`;

                const topSellingProductsData = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 10).map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue }));
                const topCustomersData = Object.entries(customerActivity).sort(([, a], [, b]) => b.totalTTC - a.totalTTC).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC }));
                const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity).sort(([, a], [, b]) => b.totalProfit - a.totalProfit).slice(0, 10).map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit }));
                const topSuppliersData = Object.entries(supplierActivity).sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost).slice(0, 10).map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount }));

                FirebaseData.renderSimpleList(UIElements.topSellingProductsList, topSellingProductsData, (item) => item.name, (item) => `الكمية: ${item.value} وحدة - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topCustomersList, topCustomersData, (item) => item.name, (item) => `فواتير: ${item.value} - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topInvoiceOwnersList, topInvoiceOwnersData, (item) => item.name, (item) => `فواتير: ${item.value} - الربح: ${item.secondaryValue.toFixed(2)} DH`);
                FirebaseData.renderSimpleList(UIElements.topSuppliersList, topSuppliersData, (item) => item.name, (item) => `الشراء: ${item.value.toFixed(2)} DH - المنتجات: ${item.secondaryValue}`);
            },

            renderSimpleList: (listEl, data, primaryTextFn, secondaryTextFn) => {
                listEl.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span><strong>${primaryTextFn(item)}</strong></span><span>${secondaryTextFn(item)}</span>`;
                        li.dataset.searchTerm = item.name;
                        li.addEventListener('click', () => {
                            UIElements.commonSearchInput.value = li.dataset.searchTerm;
                            FirebaseData.applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                    listEl.classList.toggle('has-more-items', listEl.children.length > 3);
                } else {
                    listEl.innerHTML = '<li>لا توجد بيانات</li>';
                    listEl.classList.remove('has-more-items');
                }
            }
        };

        // ====== Local Archive Logic ======
        const LocalArchive = {
            init: () => {
                UIElements.localInvoicesList.addEventListener('click', LocalArchive.handleLocalInvoiceClick);
                UIElements.searchLocalInvoiceInput.addEventListener('input', LocalArchive.displayLocalInvoices);
                UIElements.searchLocalInvoiceInput.classList.add('search-input');
            },

            displayLocalInvoices: () => {
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, true);
                try {
                    allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                } catch (e) {
                    console.error("Error parsing local invoices from local storage:", e);
                    allLocalInvoices = [];
                    UI.showToast("خطأ في قراءة أرشيف الفواتير المحلي. تم إعادة تعيينه.", 'error');
                }

                UIElements.localInvoicesList.innerHTML = '';
                const searchTerm = UIElements.searchLocalInvoiceInput.value.toLowerCase();

                const filteredInvoices = allLocalInvoices.filter(invoice => {
                    const matchesSearch = searchTerm ?
                        ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                            (invoice.date || '').toLowerCase().includes(searchTerm) ||
                            (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm))))
                        : true;
                    return matchesSearch;
                });

                if (filteredInvoices.length === 0) {
                    UIElements.localInvoicesList.innerHTML = '<p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>';
                    UI.toggleGeneralLoader(UIElements.localArchiveLoader, false);
                    return;
                }

                filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));

                filteredInvoices.forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.classList.add('mini-invoice-card');
                    invoiceDiv.dataset.invoiceId = invoice.id;

                    let productsListHtml = '<p style="text-align: center; font-style: italic; color: var(--text-secondary-gray);">لا توجد منتجات في هذه الفاتورة.</p>';
                    if (invoice.products && invoice.products.length > 0) {
                        productsListHtml = `
                            <div class="mini-product-list">
                                <div class="mini-product-item-header">
                                    <div>المنتج</div>
                                    <div>الكمية</div>
                                    <div>الإجمالي (HT)</div>
                                </div>
                                ${invoice.products.map(product => `
                                    <div class="mini-product-item-row">
                                        <div>${product.name || 'N/A'}</div>
                                        <div>${product.quantityUsed || 0}</div>
                                        <div>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    invoiceDiv.innerHTML = `
                        <div class="invoice-mini-header">
                            <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                            <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                            <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                        </div>
                        ${productsListHtml}
                        <div class="invoice-mini-footer">
                            <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                            <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                        </div>
                        <div class="invoice-actions">
                            <button type="button" class="btn-base btn-danger" data-invoice-id="${invoice.id}"><span class="icon"><i class="fas fa-trash-alt"></i></span>حذف</button>
                        </div>
                    `;
                    UIElements.localInvoicesList.appendChild(invoiceDiv);
                });
                UI.populateAllDatalists();
                UI.toggleGeneralLoader(UIElements.localArchiveLoader, false);
            },

            handleLocalInvoiceClick: async (event) => {
                const target = event.target;
                const invoiceItem = target.closest('.mini-invoice-card');
                if (!invoiceItem) return;

                const invoiceId = parseInt(invoiceItem.dataset.invoiceId);
                const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);

                if (target.classList.contains('btn-danger') || target.closest('.btn-danger')) {
                    event.stopPropagation();
                    LocalArchive.deleteLocalInvoice(invoiceId);
                } else if (invoiceToView) {
                    event.stopPropagation();
                    await InvoiceManager.displayFullInvoice(invoiceToView, false, false);
                } else {
                    UI.showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
                }
            },

            deleteLocalInvoice: async (invoiceId) => {
                const confirmed = await UI.showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟");
                if (confirmed) {
                    DataStore.deleteLocalInvoice(invoiceId);
                    LocalArchive.displayLocalInvoices();
                    UI.showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي.", 'success');
                    UI.populateAllDatalists();
                } else {
                    UI.showToast("تم إلغاء حذف الفاتورة.", 'info');
                }
            }
        };

        // ====== Form Validation Logic ======
        const Validation = {
            checkFormFields: (form) => {
                let allFieldsValid = true;
                UI.resetValidationMessages(form);

                form.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
                    const fieldValue = field.value.trim();
                    const errorMessageSpan = field.nextElementSibling;
                    
                    if (!fieldValue) {
                        allFieldsValid = false;
                        field.classList.add('error');
                        if (errorMessageSpan) {
                            errorMessageSpan.innerHTML = `<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> ${field.placeholder || field.labels[0].textContent.replace(':', '')} مطلوب.`;
                            errorMessageSpan.style.display = 'flex';
                        }
                    } else if (field.type === 'number') {
                        const numValue = parseFloat(fieldValue);
                        if (['purchasePrice', 'sellingPrice', 'productQuantity', 'invoiceCommissionAmount'].includes(field.id)) {
                            if (isNaN(numValue) || numValue < 0) {
                                allFieldsValid = false;
                                field.classList.add('error');
                                if (errorMessageSpan) {
                                    errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> القيمة يجب أن تكون رقماً موجباً.';
                                    errorMessageSpan.style.display = 'flex';
                                }
                            }
                        } else if (field.id === 'tva') {
                            if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                                allFieldsValid = false;
                                field.classList.add('error');
                                if (errorMessageSpan) {
                                    errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> النسبة يجب أن تكون بين 0 و 100.';
                                    errorMessageSpan.style.display = 'flex';
                                }
                            }
                        }
                    } else if (field.type === 'tel' && field.pattern) {
                        const regex = new RegExp(field.pattern);
                        if (!regex.test(fieldValue)) {
                            allFieldsValid = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span> صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    }
                });
                return allFieldsValid;
            }
        };


        // ====== Initialization on Window Load ======
        window.addEventListener('load', () => {
            DataStore.loadFormDefaults();
            SalesProducts.displaySavedProducts();
            LocalArchive.displayLocalInvoices();

            if (window.innerWidth <= 768) {
                UI.setActiveButton(UIElements.mobileNavButtons[0], UIElements.mobileNavButtons);
            } else {
                UI.setActiveButton(UIElements.desktopNavButtons[0], UIElements.desktopNavButtons);
            }
            UIElements.mainContainer.classList.remove('full-width');
            SalesProducts.resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            UI.populateAllDatalists();

            // Initialize all modules
            Navigation.init();
            SalesProducts.init();
            InvoiceManager.init();
            FirebaseData.init();
            LocalArchive.init();
        });
    </script>
</body>
</html>
