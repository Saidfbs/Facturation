<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون المتقدمة</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Modern Windows (Fluent Design) inspired color palette */
        :root {
            --windows-accent-blue: #0078D4; /* Primary accent blue */
            --windows-accent-blue-light: #4F9CE4; /* Lighter accent blue */
            --windows-bg-light: #F3F3F3; /* Light background for body */
            --windows-bg-medium: #EBEBEB; /* Slightly darker background, e.g., for header/footer in forms */
            --windows-card-bg: #FFFFFF; /* Card/Container background */
            --windows-text-dark: #201F1E; /* Dark text for main content */
            --windows-text-light: #FFFFFF; /* Light text for dark backgrounds */
            --windows-border-light: #D1D1D1; /* Light border color */
            --windows-success-green: #107C10; /* Success/Action green */
            --windows-success-green-light: #E6F3E6; /* Light green for success status */
            --windows-warning-orange: #FF8C00; /* Warning orange */
            --windows-warning-orange-light: #FFF8E6; /* Light orange for warning status */
            --windows-error-red: #D13438; /* Error red */
            --windows-error-red-light: #FAE6E6; /* Light red for error status */
            --windows-active-button: #00569B; /* Darker blue for active nav button */

            --border-radius: 8px;
            --button-border-radius: 20px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
            --box-shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --box-shadow-medium: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Added this rule to ensure hidden attribute works reliably */
        [hidden] {
            display: none !important;
        }

        /* Base styles and reset */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            direction: ltr;
            background-color: var(--windows-bg-light);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--windows-text-dark);
            font-size: 16px;
        }

        body {
            padding: var(--spacing-md);
        }

        /* Main controls for navigation */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--windows-accent-blue);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            flex-shrink: 0;
        }

        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--windows-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--button-border-radius);
            text-align: center;
            background-color: var(--windows-accent-blue-light);
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            box-shadow: var(--box-shadow-light);
            outline: none;
        }

        .main-controls .btn-panel:hover {
            background-color: #3B7FB9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: var(--box-shadow-light);
        }
        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--windows-text-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        /* Active button state */
        .main-controls .btn-panel.active {
            background-color: var(--windows-active-button); /* Darker blue for active */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); /* Inset shadow for active */
            transform: translateY(0); /* No lift for active */
        }
        .main-controls .btn-panel.active:hover {
            background-color: var(--windows-active-button); /* Maintain active color on hover */
            transform: translateY(0);
        }


        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px; /* Designed for desktop, max width for content */
            margin: 0 auto; /* Center the container on large screens */
        }

        /* Common container styles - like cards */
        .product-container,
        .client-container,
        .invoice,
        .saved-products,
        .firebase-stats-combined-container, /* NEW: Combined container class */
        .local-archive-container {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg);
            box-shadow: var(--box-shadow-light);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateY(10px);
            opacity: 0;
            width: 100%; /* Take full width of parent container */
            box-sizing: border-box; /* Include padding/border in width */
        }

        /* Show state for sections */
        .container > div:not([hidden]) {
            opacity: 1;
            transform: translateY(0);
        }

        /* Dashboard View Specific Styles */
        .dashboard-view {
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap on smaller screens */
            gap: var(--spacing-md); /* Spacing between cards */
            align-items: flex-start; /* Align items to the top */
            width: 100%; /* Take full width of container */
        }

        .dashboard-view h2 {
            width: 100%; /* Make title span full width */
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-xl);
            font-size: 2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--windows-accent-blue-light);
        }

        /* Adjust individual container widths within the dashboard view */
        /* On larger screens, distribute space */
        .dashboard-view > .product-container,
        .dashboard-view > .client-container {
            flex: 1 1 48%; /* Each takes roughly half width, allows for a bit of gap */
            min-width: 300px; /* Minimum width before wrapping */
        }
        .dashboard-view > .saved-products {
            flex: 1 1 100%; /* Takes full width */
            margin-top: var(--spacing-md); /* Add margin from the forms above */
        }
        /* Ensure that when dashboard-view is visible, its children are also visible */
        .dashboard-view:not([hidden]) > div {
            opacity: 1;
            transform: translateY(0);
        }

        /* Firebase/Stats Combined Container Layout */
        .firebase-stats-combined-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: var(--spacing-md); /* Space between product list and stats */
            padding: var(--spacing-lg); /* Add padding to the combined container */
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg); /* Match overall card background */
            box-shadow: var(--box-shadow-light); /* Apply consistent shadow */
            margin-bottom: var(--spacing-md);
            flex-direction: column; /* Start with column layout for stacking */
        }
        .firebase-stats-combined-container h2 {
            width: 100%; /* Make title span full width */
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-xl);
            font-size: 2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--windows-accent-blue-light);
        }
        /* Flex wrapper for the two main content areas (stats and product list) */
        .firebase-content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            width: 100%; /* Take full width of parent */
        }
        .firebase-content-wrapper > .statistics-section { /* Stats section */
            flex: 1 1 30%; /* Takes about 30% width on large screens */
            min-width: 280px; /* Minimum width before wrapping */
            background-color: var(--windows-bg-medium); /* Lighter background for stats section itself */
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
            max-height: calc(100vh - 400px); /* Adjust to leave space for filters/header */
            overflow-y: auto; /* Enable scrolling for stats if content is too long */
        }
        .firebase-content-wrapper > .firebase-product-list-wrapper { /* Wrapper for product list & search/dropdown */
            flex: 1 1 65%; /* Takes about 65% width on large screens */
            min-width: 300px; /* Minimum width before wrapping */
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            background-color: var(--windows-bg-light); /* Slightly lighter background for list wrapper */
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
            max-height: calc(100vh - 400px); /* Match stats section height */
            overflow-y: auto; /* Enable scrolling for product list */
        }
        /* Adjust for smaller screens (stacking) */
        @media (max-width: 768px) {
            .firebase-stats-combined-container {
                padding: var(--spacing-md); /* Adjust padding */
            }
            .firebase-content-wrapper {
                flex-direction: column; /* Stack vertically */
            }
            .firebase-content-wrapper > .statistics-section,
            .firebase-content-wrapper > .firebase-product-list-wrapper {
                flex: 1 1 100%; /* Take full width */
                max-height: none; /* Remove max height constraint */
                overflow-y: visible; /* Remove scrolling */
                padding: var(--spacing-md); /* Consistent padding */
            }
        }


        /* Scrollable areas (general styles) */
        .saved-products3, /* For local products list in dashboard */
        .local-invoices-list { /* For local invoices list */
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 350px); /* Adjusted for combined forms in dashboard */
            padding-right: 10px; /* More padding for scrollbar on desktop */
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid; /* Use grid for elegant product display */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Desktop grid layout */
            gap: var(--spacing-md);
            align-content: start; /* Align content to start in grid */
        }


        /* Low stock container styling within product list */
        .low-stock-section {
            flex-grow: 0;
            overflow-y: hidden;
            margin-top: 0;
            margin-bottom: var(--spacing-lg); 
            padding-right: 0; 
            grid-column: 1 / -1; /* Make it span full width in the grid */
            background-color: var(--windows-bg-medium); 
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        .low-stock-section h3 {
            color: var(--windows-error-red);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.3em;
            text-align: center;
            border-bottom: 1px dashed var(--windows-error-red);
            padding-bottom: var(--spacing-sm);
        }
        .product-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-sm);
        }


        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        p {
            margin: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--windows-text-dark);
            font-size: 0.95em;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--windows-error-red);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--windows-bg-medium);
            border-radius: 5px;
            border: 1px solid var(--windows-border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--windows-text-dark);
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--windows-error-red);
        }
        .form-group .validation-error-message {
            color: var(--windows-error-red);
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message {
            display: block;
        }


        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* General button styles */
        .btn,
        .btn1,
        .btn2,
        .btn-delete,
        .btn-edit {
            display: block;
            flex: 1;
            padding: 0.75rem 0;
            color: var(--windows-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--button-border-radius);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: var(--box-shadow-light);
            font-size: 0.95em;
            outline: none;
        }
        .btn:focus-visible, .btn1:focus-visible, .btn2:focus-visible, .btn-delete:focus-visible, .btn-edit:focus-visible {
            outline: 2px solid var(--windows-accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        .btn {
            background-color: var(--windows-accent-blue);
        }
        .btn:hover { background-color: #00569B; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn1, .btn2 {
            background-color: var(--windows-success-green);
        }
        .btn1:hover, .btn2:hover { background-color: #0C610C; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn-delete {
            background-color: var(--windows-error-red);
            margin-top: var(--spacing-sm);
        }
        .btn-delete:hover { background-color: #A02B2E; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .btn-edit {
            background-color: var(--windows-warning-orange);
            color: var(--windows-text-dark);
            margin-top: var(--spacing-sm);
        }
        .btn-edit:hover { background-color: #CC7000; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* Invoice specific styles */
        .invoice {
            margin-top: 0;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            background-color: var(--windows-card-bg);
            box-shadow: var(--box-shadow-medium);
        }

        .invoice h2 {
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-lg);
            font-size: 1.8em;
        }

        .invoice-header,
        .invoice-footer {
            border: none;
            background-color: var(--windows-bg-medium);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .invoice-header1 {
            background-color: var(--windows-bg-medium);
            text-align: center;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
        }

        .invoice-header1 table {
            width: 100%;
            margin: 0 auto;
        }

        .invoice-header1 tfoot tr td {
            text-align: left;
            font-weight: bold;
            padding: 0.3rem 0;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            background-color: var(--windows-card-bg);
            font-size: 0.95em;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--windows-border-light);
            padding: 0.6rem;
            text-align: left;
        }

        .invoice-table th {
            background-color: var(--windows-accent-blue-light);
            color: var(--windows-text-light);
            font-weight: bold;
        }

        #displayTotalAmountBeforeCommission, 
        #displayCommissionDeducted, 
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC { 
            text-align: right;
            font-weight: bold;
            color: var(--windows-success-green);
            font-size: 1.1em;
        }

        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .invoice .divider {
            border-top: 1px dashed var(--windows-border-light);
            margin: var(--spacing-lg) 0;
        }

        /* Product list items - refined for desktop */
        .product,
        .product-item {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-md);
            border-radius: 15px;
            margin-bottom: 0; /* Managed by grid gap */
            background-color: var(--windows-card-bg);
            position: relative;
            font-size: 0.95em;
            line-height: 1.5;
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease-in-out;
            display: flex; /* Use flexbox for internal layout */
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }
        .product:hover, .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }


        .product p, .product-item p {
            margin-bottom: 5px;
        }

        .product-details, .product-firebase-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
        }

        .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%; /* Ensure buttons span full width */
            margin-top: var(--spacing-sm);
        }
        .product-actions button {
            flex: 1 1 48%; /* Allow two buttons per row */
            min-width: 120px; /* Ensure they don't get too small */
            margin-top: 0; /* Override default button margin-top */
        }


        .quantity-controls {
            display: flex;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
        }

        .quantity-controls button {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            background-color: var(--windows-accent-blue);
            color: var(--windows-text-light);
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.1s ease;
            outline: none;
            flex-shrink: 0; /* Prevent buttons from shrinking */
            margin-top: 0; /* Override product-actions button margin-top */
        }

        .quantity-controls button:hover {
            background-color: #00569B;
        }
        .quantity-controls button:active {
            transform: scale(0.95);
        }
        .quantity-controls button:focus-visible {
            outline: 2px solid var(--windows-accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
        }

        .quantity-controls input {
            flex-grow: 1;
            height: 35px;
            margin: 0 var(--spacing-sm);
            font-size: 1.1em;
            text-align: center;
            border-radius: 5px;
            background-color: var(--windows-bg-medium);
            border: 1px solid var(--windows-border-light);
            color: var(--windows-text-dark);
            outline: none;
        }
        .quantity-controls input:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        /* Specific background colors for product status (using CSS variables) */
        .product.status-insufficient {
            background-color: var(--windows-error-red-light) !important;
            border-color: var(--windows-error-red) !important;
            box-shadow: 0 2px 5px rgba(209, 52, 56, 0.2);
        }

        .product.status-min-zero {
            background-color: var(--windows-warning-orange-light) !important;
            border-color: var(--windows-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 140, 0, 0.2);
        }

        .product.status-min-positive {
            background-color: var(--windows-warning-orange-light) !important;
            border-color: var(--windows-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 140, 0, 0.2);
        }

        .product.status-selected-sufficient {
            background-color: var(--windows-success-green-light) !important;
            border-color: var(--windows-success-green) !important;
            box-shadow: 0 2px 5px rgba(16, 124, 16, 0.2);
        }

        .product.status-stock-positive, .product.status-default {
            background-color: var(--windows-card-bg) !important;
            border-color: var(--windows-border-light) !important;
            box-shadow: var(--box-shadow-light);
        }


        /* Firebase product item specific styles */
        .product-item.status-duplicate {
            background-color: var(--windows-bg-medium) !important;
            border-color: var(--windows-accent-blue-light) !important;
        }

        /* Local Invoice item specific styles */
        .local-invoice-item {
            border: 1px solid var(--windows-border-light);
            padding: var(--spacing-md);
            border-radius: 15px;
            background-color: var(--windows-card-bg);
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .local-invoice-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .local-invoice-item p {
            margin-bottom: 5px;
        }
        .local-invoice-item .invoice-summary-details {
            flex-grow: 1;
            margin-bottom: var(--spacing-sm);
        }
        .local-invoice-item .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
        }
        .local-invoice-item .invoice-actions button {
            flex: 1 1 48%;
            min-width: 120px;
        }

        /* Search input for saved products list */
        #searchProduct,
        #searchLocalInvoice {
            padding: 0.6rem 1rem;
            border-radius: var(--button-border-radius);
            border: 1px solid var(--windows-border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--windows-card-bg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--windows-text-dark);
            outline: none;
        }
        #searchProduct:focus,
        #searchLocalInvoice:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        /* Adjustments for dropdown and search in Firebase section */
        /* Combined filter controls for Firebase products and statistics */
        .combined-firebase-filter-controls { /* Renamed for clarity */
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%; /* Take full width within its parent */
            padding: var(--spacing-sm); /* Add padding around filters */
            background-color: var(--windows-bg-light); /* Give it a distinct background */
            border-radius: var(--border-radius);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        .combined-firebase-filter-controls .form-group {
            flex: 1 1 48%; /* Adjust for side-by-side on larger screens */
            min-width: 200px; /* Prevent shrinking too much */
            margin-bottom: 0; /* Remove default margin-bottom to avoid double spacing */
        }
        .combined-firebase-filter-controls .form-group label {
            display: none; /* Hide labels for filter controls to save space */
        }
        .combined-firebase-filter-controls select, 
        .combined-firebase-filter-controls input[type="text"] { /* Target specific inputs */
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--windows-card-bg); /* Use card background for filter inputs */
            border-radius: 5px;
            border: 1px solid var(--windows-border-light);
            font-size: 1em;
            color: var(--windows-text-dark);
            outline: none;
        }

        .combined-firebase-filter-controls select:focus, 
        .combined-firebase-filter-controls input[type="text"]:focus {
            border-color: var(--windows-accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .combined-firebase-filter-controls select { 
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236A7B82%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
        }

        /* --- Statistics Section Styles (Adjusted for embedding) --- */
        .statistics-section h2 { /* Removed margin-bottom and made smaller */
            text-align: center;
            color: var(--windows-accent-blue);
            margin-bottom: var(--spacing-md);
            font-size: 1.5em; /* Smaller title */
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--windows-accent-blue-light);
            margin-top: 0; /* Reset top margin to align correctly */
        }

        .statistics-section h3 {
            color: var(--windows-accent-blue);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.2em;
            border-bottom: 1px solid var(--windows-border-light);
            padding-bottom: var(--spacing-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Smaller grid items */
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background-color: var(--windows-card-bg); /* Use card background for stat cards */
            border: 1px solid var(--windows-accent-blue-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--box-shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1em; /* Smaller font for stat titles */
            color: var(--windows-accent-blue);
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-card p {
            font-size: 1.4em; /* Slightly smaller for compactness */
            font-weight: bold;
            color: var(--windows-text-dark);
            margin: 0;
        }

        .stat-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            font-size: 0.85em;
        }

        .stat-card ul li {
            background-color: var(--windows-bg-light); /* Lighter background for list items */
            padding: 4px 8px;
            border-radius: 5px;
            margin-bottom: 4px;
            border: 1px solid var(--windows-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .stat-card ul li:last-child {
            margin-bottom: 0;
        }
        .stat-card ul li span:last-child {
            font-weight: bold;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Adjust for element's own size */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            align-items: center; 
            width: auto; /* Allow toast to size based on content */
            max-width: 90vw; /* Prevent overflow on very small screens */
            box-sizing: border-box; /* Include padding/border in width calculation */
            padding: var(--spacing-md); /* Add some padding around the container */
        }

        .toast {
            background-color: var(--windows-card-bg);
            color: var(--windows-text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--windows-border-light);
        }

        .toast.success { border-left: 5px solid var(--windows-success-green); }
        .toast.error { border-left: 5px solid var(--windows-error-red); }
        .toast.info { border-left: 5px solid var(--windows-accent-blue); }

        .toast .icon {
            font-size: 1.5em;
            line-height: 1;
        }
        .toast.success .icon { color: var(--windows-success-green); }
        .toast.error .icon { color: var(--windows-error-red); }
        .toast.info .icon { color: var(--windows-accent-blue); }


        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Custom Confirmation Modal */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #confirm-modal-dialog {
            background-color: var(--windows-card-bg);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #confirm-modal-overlay.active #confirm-modal-dialog {
            transform: scale(1);
        }

        #confirm-modal-dialog h3 {
            color: var(--windows-text-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.4em;
        }

        #confirm-modal-dialog p {
            color: var(--windows-text-dark);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #confirm-yes-btn {
            background-color: var(--windows-accent-blue);
            color: var(--windows-text-light);
        }
        #confirm-yes-btn:hover { background-color: #00569B; }

        #confirm-no-btn {
            background-color: var(--windows-border-light);
            color: var(--windows-text-dark);
        }
        #confirm-no-btn:hover { background-color: #B0B0B0; }


        /* Media Queries for Responsiveness - adjusted for desktop first */
        @media (max-width: 1024px) { /* Adjust for smaller desktops/large tablets */
            .container {
                max-width: 960px;
            }
            .saved-products3, .product-list-grid, .local-invoices-list {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            .main-controls .btn-panel {
                font-size: 0.95em;
                padding: 0.7rem 0.9rem;
            }
            /* Firebase/Stats Combined Layout on smaller desktops */
            .firebase-content-wrapper > .statistics-section {
                flex: 1 1 35%; /* Slightly more width for stats */
            }
            .firebase-content-wrapper > .firebase-product-list-wrapper {
                flex: 1 1 60%; /* Slightly less width for product list */
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjust stats grid items */
            }
        }

        @media (max-width: 768px) { /* Tablet size */
            body {
                padding: var(--spacing-sm);
            }
            .main-controls .btn-panel {
                flex: 1 1 45%;
                max-width: none;
                font-size: 0.9em; /* Slightly smaller font for more buttons */
                padding: 0.6rem 0.8rem;
            }
            .invoice h2 {
                font-size: 1.5em;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.4rem;
                font-size: 0.85em;
            }
            .saved-products3, .product-list-grid, .local-invoices-list {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: calc(100vh - 200px); /* Adjusted for independent visibility */
            }
            
            .stat-card p {
                font-size: 1.3em;
            }
            .statistics-section h2 {
                font-size: 1.5em;
            }
            .toast {
                min-width: unset;
                max-width: 90%;
            }

            /* Stack dashboard items on smaller screens */
            .dashboard-view > .product-container,
            .dashboard-view > .client-container,
            .dashboard-view > .saved-products {
                flex: 1 1 100%; /* Take full width */
            }
            /* Stack firebase content wrapper items */
            .firebase-content-wrapper {
                flex-direction: column;
            }
            .firebase-content-wrapper > .statistics-section,
            .firebase-content-wrapper > .firebase-product-list-wrapper {
                flex: 1 1 100%; /* Take full width */
            }
        }

        @media (max-width: 480px) { /* Mobile size */
            .main-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .main-controls .btn-panel {
                flex: 1 1 100%;
                max-width: none;
                font-size: 1em; /* Restore font size for full width buttons */
                padding: 0.75rem 1rem;
            }
            .button-container {
                flex-direction: column;
            }
            .btn, .btn1, .btn2, .btn-delete, .btn-edit {
                flex: 1 1 100%;
            }
            .quantity-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            .quantity-controls input {
                width: 60px;
                margin: 0 5px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .saved-products3, .product-list-grid, .local-invoices-list {
                grid-template-columns: 1fr; /* Single column on mobile */
            }
        }

        /* Accessible hidden content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

</head>
<body>
    <div class="main-controls">
        <button type="button" class="btn-panel" id="showDashboardButton">الرئيسية (الإدارة)</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton">بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showLocalInvoiceArchiveButton">أرشيف الفواتير المحلية</button>
    </div>

    <div class="container">
        
        <!-- Dashboard View -->
        <div id="mainDashboardView" class="dashboard-view">
            <h2>لوحة التحكم الرئيسية</h2>
            <div class="product-container" id="productFormContainer">
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
                        <span class="validation-error-message">اسم المنتج مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">سعر الشراء مطلوب (غير سالب).</span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">سعر البيع مطلوب (غير سالب).</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
                        <span class="validation-error-message">اسم المورد مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
                        <span class="validation-error-message">عنوان المورد مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                        <span class="validation-error-message">رقم هاتف المورد مطلوب (10 أرقام).</span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantité initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn" id="addProduct">إضافة منتج</button>
                        <button type="submit" class="btn" id="saveEditProduct">تعديل المنتج</button>
                    </div>
                </form>
            </div>
            
            <div class="client-container" id="clientFormContainer">
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message">تاريخ الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
                        <span class="validation-error-message">اسم العميل مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">اسم مالك الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la facture</label>
                        <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">عنوان مالك الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                        <span class="validation-error-message">رقم هاتف مالك الفاتورة مطلوب (10 أرقام).</span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message">نسبة TVA مطلوبة (بين 0 و 100).</span>
                    </div>
                    <div class="form-group"> <!-- NEW: Invoice-level commission rate -->
                        <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                        <input type="number" id="invoiceCommissionPercentage" placeholder="مثال: 10" value="0" min="0" max="100" step="0.01">
                        <span class="validation-error-message">نسبة العمولة للفاتورة (بين 0 و 100).</span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn" id="createInvoiceButton">إنشاء الفاتورة وعرضها</button>
                    </div>
                </form>
            </div>
            
            <div class="saved-products" id="savedProductsDisplay">
                <!-- NEW: Low stock products moved here, above search -->
                <div class="low-stock-section"> 
                    <h3>تتبع المخزون: المنتجات على وشك النفاد</h3>
                    <div class="product-list-grid" id="lowStockProductsList"> 
                        <p class="empty-list-message">لا توجد منتجات في المخزون المنخفض حالياً.</p>
                    </div>
                </div>

                <div class="divider"></div> <!-- Divider to separate low stock from main products -->

                <div class="form-group">
                    <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                    <input type="text" id="searchProduct" placeholder="البحث عن منتج">
                </div>
                <div class="saved-products3 product-list-grid" id="savedProductsList"></div>
            </div>
        </div>
        
        <!-- Other sections remain hidden by default -->
        <div class="invoice" id="invoiceDisplay" hidden>
            <button type="button" class="btn" id="savePdfButton">تحديث المخزون (بعد الفاتورة)</button>
            <h2>DEVIS</h2>
            <div class="invoice-header">
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
                <p>Date de la facture: <span id="displayInvoiceDate"></span></p>
            </div>
            
            <table class="invoice-table" id="invoiceDetails">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Nom du produit</th>
                        <th>Prix Unitaire</th>
                        <th>Quantité</th>
                        <th>Montant HT</th>
                    </tr>
                </thead>
                <tbody id="displayDetails">
                    </tbody>
            </table>
            
            <div class="invoice-header1">
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td> 
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td> 
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </div>
            <div class="button-container">
                <button type="button" class="btn" id="printButton">طباعة الفاتورة</button>
                <button type="button" class="btn" id="backToLocalArchiveButton" hidden>العودة إلى الأرشيف</button>
            </div>
        </div>
        
        <!-- Combined Firebase Data and Statistics Section -->
        <div class="firebase-stats-combined-container" id="firebaseProductsDisplay" hidden>
            <h2>بيانات Firebase والإحصائيات</h2>
            
            <div class="combined-firebase-filter-controls"> <!-- NEW: Combined filter controls -->
                <div class="form-group">
                    <label for="commonPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                    <select id="commonPhoneDropdown">
                        </select>
                </div>
                <div class="form-group">
                    <label for="commonSearchInput" class="sr-only">البحث في بيانات Firebase</label>
                    <input type="text" id="commonSearchInput" placeholder="البحث برقم الهاتف، الاسم، أو المنتج">
                </div>
            </div>

            <div class="firebase-content-wrapper"> <!-- NEW: Wrapper for layout -->
                <!-- Statistics section, now embedded and appears first -->
                <div class="statistics-section">
                    <h2>إحصائيات المبيعات التفصيلية</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي سعر الشراء</h3> 
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي سعر البيع</h3> 
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي العمولة</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي الأرباح</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>عدد الفواتير</h3>
                            <p id="invoiceCount">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>المنتجات الأكثر مبيعاً</h3>
                            <ul id="topSellingProducts">
                                <li>لا توجد بيانات</li>
                            </ul>
                        </div>
                        <div class="stat-card">
                            <h3>العملاء الأكثر نشاطاً</h3>
                            <ul id="topCustomers">
                                <li>لا توجد بيانات</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="firebase-product-list-wrapper">
                    <div class="saved-products4 product-list-grid" id="productListContainerdata"></div>
                </div>
            </div>
        </div>

        <!-- Local Invoice Archive Section -->
        <div class="local-archive-container" id="localInvoiceArchive" hidden>
            <h2>أرشيف الفواتير المحلية</h2>
            <div class="form-group">
                <label for="searchLocalInvoice" class="sr-only">البحث في الفواتير المحلية</label>
                <input type="text" id="searchLocalInvoice" placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتجات)">
            </div>
            <div class="local-invoices-list product-list-grid" id="localInvoicesList">
                <p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>
            </div>
        </div>

    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container"></div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

</body>
    
<script>
// Firebase configuration
const firebaseConfig = {
    databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ====== Global UI Elements ======
const mainDashboardView = document.getElementById('mainDashboardView');
const productFormContainer = document.getElementById('productFormContainer');
const clientFormContainer = document.getElementById('clientFormContainer');
const invoiceDisplay = document.getElementById('invoiceDisplay');
const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay'); // Now combines Firebase data & Stats
const localInvoiceArchive = document.getElementById('localInvoiceArchive');

// ====== Main Navigation Buttons ======
const showDashboardButton = document.getElementById('showDashboardButton');
const showFirebaseDataButton = document.getElementById('showFirebaseDataButton');
const showLocalInvoiceArchiveButton = document.getElementById('showLocalInvoiceArchiveButton');

// Array of all navigation buttons for easy active state management
const navButtons = [
    showDashboardButton,
    showFirebaseDataButton,
    showLocalInvoiceArchiveButton
];

// ====== Form Elements ======
const productForm = document.getElementById('productForm');
const productNameInput = document.getElementById('productName');
const purchasePriceInput = document.getElementById('purchasePrice'); 
const sellingPriceInput = document.getElementById('sellingPrice');    
const supplierNameInput = document.getElementById('supplierName');
const supplierAddressInput = document.getElementById('supplierAddress');
const supplierPhoneInput = document.getElementById('supplierPhone');
const productQuantityInput = document.getElementById('productQuantity');


const invoiceForm = document.getElementById('invoiceForm');
const customerNameInput = document.getElementById('customerName');
const invoiceOwnerInput = document.getElementById('invoiceOwner');
const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
const invoiceDateInput = document.getElementById('invoiceDate');
const tvaInput = document.getElementById('tva');
const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage'); 

const addProductButton = document.getElementById('addProduct');
const saveEditProductButton = document.getElementById('saveEditProduct');
const savedProductsList = document.getElementById('savedProductsList');
const searchProductInput = document.getElementById('searchProduct');

// Combined Firebase/Stats Filter Elements
const commonPhoneDropdown = document.getElementById('commonPhoneDropdown'); // NEW common dropdown
const commonSearchInput = document.getElementById('commonSearchInput');   // NEW common search input

const firebaseProductListContainer = document.getElementById('productListContainerdata'); // Firebase products list container


const lowStockProductsList = document.getElementById('lowStockProductsList'); 

// Local Invoice Archive elements
const localInvoicesList = document.getElementById('localInvoicesList');
const searchLocalInvoiceInput = document.getElementById('searchLocalInvoice');
const backToLocalArchiveButton = document.getElementById('backToLocalArchiveButton');

// ====== Toast Notification Elements ======
const toastContainer = document.getElementById('toast-container');

// ====== Custom Confirmation Modal Elements ======
const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
const confirmModalTitle = document.getElementById('confirm-modal-title');
const confirmModalMessage = document.getElementById('confirm-modal-message');
const confirmYesBtn = document.getElementById('confirm-yes-btn');
const confirmNoBtn = document.getElementById('confirm-no-btn');
let confirmResolve; 

// Global array to hold all fetched Firebase invoices for statistics filtering
let allFirebaseInvoicesData = []; 

// Global array to hold all fetched Firebase products for Firebase data view filtering
let allFirebaseProducts = [];

// Global array to hold all local invoices for local archive view
let allLocalInvoices = [];


// ====== Initial Setup on Window Load ======
window.onload = function() {
    // Initially hide all sections except the main dashboard view
    hideAllSections();
    mainDashboardView.hidden = false;
    setActiveButton(showDashboardButton); // Set dashboard button as active initially

    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    saveEditProductButton.style.display = 'none'; 
    
    const now = new Date();
    const formattedDate = now.toLocaleDateString('fr-FR');
    const formattedTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    invoiceDateInput.value = `${formattedDate} ${formattedTime}`;

    // Load saved data from Local Storage for persistent fields
    const savedInvoiceOwner = localStorage.getItem('invoiceOwner');
    const savedInvoiceOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
    const savedInvoiceOwnerAddress = localStorage.getItem('invoiceOwnerAddress');
    const savedSupplierName = localStorage.getItem('supplierName');
    const savedSupplierAddress = localStorage.getItem('supplierAddress');
    const savedSupplierPhone = localStorage.getItem('supplierPhone');
    const savedInvoiceCommission = localStorage.getItem('invoiceCommissionPercentage'); 

    if (savedInvoiceOwner) invoiceOwnerInput.value = savedInvoiceOwner;
    if (savedInvoiceOwnerPhone) invoiceOwnerPhoneInput.value = savedInvoiceOwnerPhone;
    if (savedInvoiceOwnerAddress) invoiceOwnerAddressInput.value = savedInvoiceOwnerAddress;
    if (savedSupplierName) supplierNameInput.value = savedSupplierName;
    if (savedSupplierAddress) supplierAddressInput.value = savedSupplierAddress;
    if (savedSupplierPhone) supplierPhoneInput.value = savedSupplierPhone;
    if (savedInvoiceCommission) invoiceCommissionPercentageInput.value = savedInvoiceCommission; 

    // Initialize display for dashboard elements
    displayLowStockProducts(); 
    displaySavedProducts(); 
};

// ====== UI Management Functions ======

/**
 * Hides all main content sections.
 */
function hideAllSections() {
    // Hide all main section containers
    const sectionsToHide = [mainDashboardView, invoiceDisplay, firebaseProductsDisplay, localInvoiceArchive]; 
    sectionsToHide.forEach(section => {
        section.hidden = true;
    });
}

/**
 * Sets the active state for the navigation buttons.
 * @param {HTMLElement} activeBtn - The button that should be marked as active.
 */
function setActiveButton(activeBtn) {
    navButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
}

/**
 * Resets validation messages for a given form.
 * @param {HTMLFormElement} form - The form element to reset validation for.
 */
function resetValidationMessages(form) {
    const fields = form.querySelectorAll('input[required], textarea[required]');
    fields.forEach(field => {
        field.style.borderColor = ''; // Reset border
        const errorMessageSpan = field.nextElementSibling;
        if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
            errorMessageSpan.style.display = 'none'; // Hide error message
        }
    });
}

/**
 * Shows a toast notification.
 * @param {string} message - The message to display.
 * @param {'success'|'error'|'info'} type - The type of toast (e.g., 'success', 'error', 'info').
 */
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.classList.add('toast', type);
    let iconHtml = '';
    // Using simple unicode characters for icons as external libraries are not allowed by policy
    if (type === 'success') {
        iconHtml = '<span class="icon">&#10004;</span>'; // Checkmark icon
    } else if (type === 'error') {
        iconHtml = '<span class="icon">&#10006;</span>'; // Cross icon
    } else if (type === 'info') {
        iconHtml = '<span class="icon">&#8505;</span>'; // Info icon
    }
    toast.innerHTML = `${iconHtml}<span>${message}</span>`;
    toastContainer.appendChild(toast);

    // Remove the toast after animation (4 seconds)
    setTimeout(() => {
        toast.remove();
    }, 4000); 
}

/**
 * Shows a custom confirmation modal.
 * @param {string} title - The title of the confirmation.
 * @param {string} message - The message to display in the modal.
 * @returns {Promise<boolean>} A promise that resolves to true if 'Yes' is clicked, false if 'No'.
 */
function showConfirmModal(title, message) {
    return new Promise(resolve => {
        confirmResolve = resolve; 

        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmModalOverlay.hidden = false; 
        confirmModalOverlay.classList.add('active'); 

        const handleYes = () => {
            confirmModalOverlay.classList.remove('active');
            confirmModalOverlay.hidden = true;
            confirmYesBtn.removeEventListener('click', handleYes);
            confirmNoBtn.removeEventListener('click', handleNo);
            resolve(true);
        };

        const handleNo = () => {
            confirmModalOverlay.classList.remove('active');
            confirmModalOverlay.hidden = true;
            confirmYesBtn.removeEventListener('click', handleYes);
            confirmNoBtn.removeEventListener('click', handleNo);
            resolve(false);
        };

        confirmYesBtn.addEventListener('click', handleYes);
        confirmNoBtn.addEventListener('click', handleNo);
    });
}


// ====== Section Display Functions ======

// Dashboard Button Event Listener
showDashboardButton.addEventListener('click', () => {
    hideAllSections();
    mainDashboardView.hidden = false;
    setActiveButton(showDashboardButton); 
    displayLowStockProducts(); 
    displaySavedProducts(); 
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Firebase Data (now combined with Statistics) Button Event Listener
showFirebaseDataButton.addEventListener('click', () => {
    hideAllSections();
    firebaseProductsDisplay.hidden = false;
    setActiveButton(showFirebaseDataButton); 
    
    // Clear filter inputs when entering the combined view
    commonSearchInput.value = '';
    // Fetch and populate common dropdown with all available phone numbers
    populateCommonDropdown(); 
    // Fetch all Firebase data (products and invoices) and then display them based on current filters
    fetchAndDisplayCombinedFirebaseData(); 
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

showLocalInvoiceArchiveButton.addEventListener('click', () => {
    hideAllSections();
    localInvoiceArchive.hidden = false;
    setActiveButton(showLocalInvoiceArchiveButton);
    displayLocalInvoices(); 
    searchLocalInvoiceInput.value = ''; 
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// ====== Form Validation Helper ======

/**
 * Checks if all required fields in a form are filled.
 * Displays error messages and highlights empty fields.
 * @param {HTMLFormElement} form - The form element to check.
 * @returns {boolean} True if all required fields are filled, false otherwise.
 */
function checkFields(form) {
    let allFieldsFilled = true;
    const fields = form.querySelectorAll('input[required], textarea[required]');
    fields.forEach(field => {
        const errorMessageSpan = field.nextElementSibling;
        const fieldValue = field.value.trim();

        if (!fieldValue) {
            allFieldsFilled = false;
            field.style.borderColor = 'var(--windows-error-red)';
            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                errorMessageSpan.style.display = 'block';
                errorMessageSpan.textContent = field.placeholder + ' مطلوب.'; 
            }
        } 
        else if (field.type === 'number') {
            const numValue = parseFloat(fieldValue);
            if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                if (isNaN(numValue) || numValue < 0) { 
                    allFieldsFilled = false;
                    field.style.borderColor = 'var(--windows-error-red)';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = 'القيمة يجب أن تكون رقماً موجباً.';
                        errorMessageSpan.style.display = 'block';
                    }
                }
            } 
            else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                    allFieldsFilled = false;
                    field.style.borderColor = 'var(--windows-error-red)';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.textContent = 'النسبة يجب أن تكون بين 0 و 100.';
                        errorMessageSpan.style.display = 'block';
                    }
                }
            }
        } else if (field.type === 'tel' && field.pattern) { 
            const regex = new RegExp(field.pattern);
            if (!regex.test(fieldValue)) {
                allFieldsFilled = false;
                field.style.borderColor = 'var(--windows-error-red)';
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.textContent = 'صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                    errorMessageSpan.style.display = 'block';
                }
            }
        }
        else {
            field.style.borderColor = '';
            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                errorMessageSpan.style.display = 'none';
            }
        }
    });
    return allFieldsFilled;
}


// ====== Product Management (Local Storage) ======

/**
 * Saves a new product to Local Storage.
 */
addProductButton.addEventListener('click', async (event) => {
    event.preventDefault(); 
    if (checkFields(productForm)) {
        const name = productNameInput.value.trim();
        const purchasePrice = parseFloat(purchasePriceInput.value); 
        const sellingPrice = parseFloat(sellingPriceInput.value);    
        const supplierName = supplierNameInput.value.trim();
        const supplierAddress = supplierAddressInput.value.trim();
        const supplierPhone = supplierPhoneInput.value.trim();
        const stockQuantity = parseInt(productQuantityInput.value);
        const id = Date.now(); 
        const date = new Date().toLocaleDateString('fr-FR');

        localStorage.setItem('supplierName', supplierName);
        localStorage.setItem('supplierAddress', supplierAddress);
        localStorage.setItem('supplierPhone', supplierPhone);

        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        const productExists = products.some(product =>
            product.name.toLowerCase() === name.toLowerCase() &&
            product.supplierPhone === supplierPhone 
        );

        if (productExists) {
            showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
            return;
        }

        const confirmed = await showConfirmModal("تأكيد الإضافة", "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟");
        if (confirmed) {
            products.push({ id, name, purchasePrice, sellingPrice, commissionPercentage: 0, supplierName, supplierAddress, supplierPhone, stockQuantity, date, quantity: 0, minStockQuantity: 0 });
            products.sort((a, b) => a.name.localeCompare(b.name));
            localStorage.setItem('savedProducts', JSON.stringify(products));
            displaySavedProducts(); 
            displayLowStockProducts(); 
            showToast("المنتج تم إضافته بنجاح.", 'success');
        } else {
            showToast("تم إلغاء إضافة المنتج.", 'info');
        }
    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

/**
 * Handles editing an existing product. Populates the form with product data.
 * @param {number} productId - The ID of the product to edit.
 */
function editProduct(productId) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productToEdit = savedProducts.find(p => p.id == productId);

    if (productToEdit) {
        showDashboardButton.click(); // Ensure dashboard is visible
        
        productNameInput.value = productToEdit.name;
        purchasePriceInput.value = productToEdit.purchasePrice; 
        sellingPriceInput.value = productToEdit.sellingPrice;    
        supplierNameInput.value = productToEdit.supplierName;
        supplierAddressInput.value = productToEdit.supplierAddress;
        supplierPhoneInput.value = productToEdit.supplierPhone;
        productQuantityInput.value = productToEdit.stockQuantity;
        
        addProductButton.style.display = 'none'; 
        saveEditProductButton.style.display = 'block'; 
        saveEditProductButton.dataset.editingId = productId; 
        resetValidationMessages(productForm); 
    } else {
        showToast("المنتج المراد تعديله غير موجود.", 'error');
    }
}

/**
 * Saves edited product data to Local Storage.
 */
saveEditProductButton.addEventListener('click', async (event) => {
    event.preventDefault(); 
    if (checkFields(productForm)) {
        const idToEdit = event.target.dataset.editingId;
        if (!idToEdit) {
            showToast("لا يوجد منتج محدد للتعديل.", 'error');
            return;
        }

        const name = productNameInput.value.trim();
        const purchasePrice = parseFloat(purchasePriceInput.value); 
        const sellingPrice = parseFloat(sellingPriceInput.value);    
        const supplierName = supplierNameInput.value.trim();
        const supplierAddress = supplierAddressInput.value.trim();
        const supplierPhone = supplierPhoneInput.value.trim();
        const stockQuantity = parseInt(productQuantityInput.value); 
        const date = new Date().toLocaleDateString('fr-FR');

        localStorage.setItem('supplierName', supplierName);
        localStorage.setItem('supplierAddress', supplierAddress);
        localStorage.setItem('supplierPhone', supplierPhone);

        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        const productIndex = products.findIndex(p => p.id == idToEdit);

        if (productIndex !== -1) {
            const duplicateCheck = products.some((p, idx) => 
                idx !== productIndex && 
                p.name.toLowerCase() === name.toLowerCase() && 
                p.supplierPhone === supplierPhone 
            );

            if (duplicateCheck) {
                showToast("لا يمكن تعديل المنتج. يوجد منتج آخر بنفس الاسم ورقم هاتف المورد.", 'error');
                return;
            }

            const confirmed = await showConfirmModal("تأكيد التعديل", "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟");
            if (confirmed) {
                products[productIndex].name = name;
                products[productIndex].purchasePrice = purchasePrice; 
                products[productIndex].sellingPrice = sellingPrice;    
                products[productIndex].supplierName = supplierName;
                products[productIndex].supplierAddress = supplierAddress;
                products[productIndex].supplierPhone = supplierPhone;
                products[productIndex].stockQuantity = stockQuantity;
                products[productIndex].date = date;
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts();
                displayLowStockProducts(); 
                showToast("Le product a été mis à jour avec succès.", 'success');
            } else {
                showToast("تم إلغاء تعديل المنتج.", 'info');
            }
        } else {
            showToast("المنتج المراد تعديله غير موجود.", 'error');
        }
    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

/**
 * Deletes a product from Local Storage.
 * @param {number} id - The ID of the product to delete.
*/
async function deleteProduct(id) {
    const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
    if (confirmed) {
        let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
        products = products.filter(product => product.id !== id);
        localStorage.setItem('savedProducts', JSON.stringify(products));
        displaySavedProducts(); 
        displayLowStockProducts(); 
        showToast("تم حذف المنتج بنجاح.", 'success');
    } else {
        showToast("تم إلغاء حذف المنتج.", 'info');
    }
}

searchProductInput.addEventListener('input', displaySavedProducts);

/**
 * Resets the quantity selected for invoice for all products in Local Storage to 0.
 */
function resetAllProductQuantities() {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    savedProducts.forEach(product => {
        product.quantity = 0;
    });
    localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
}

/**
 * Displays products from Local Storage, filtered by search term and sorted by status.
 */
function displaySavedProducts() {
    const searchTerm = searchProductInput.value.toLowerCase();
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    savedProductsList.innerHTML = ''; 

    const filteredProducts = savedProducts
        .filter(product => product.name.toLowerCase().includes(searchTerm))
        .sort((a, b) => {
            const stockQuantityA = a.stockQuantity || 0;
            const stockQuantityB = b.stockQuantity || 0;
            const minStockQuantityA = a.minStockQuantity || 0;
            const minStockQuantityB = b.minStockQuantity || 0;
            const quantityA = a.quantity || 0;
            const quantityB = b.quantity || 0;

            const statusA = getProductStatusPriority(quantityA, stockQuantityA, minStockQuantityA);
            const statusB = getProductStatusPriority(quantityB, stockQuantityB, minStockQuantityB);

            if (statusA !== statusB) {
                return statusA - statusB;
            }

            return stockQuantityB - stockQuantityA || a.name.localeCompare(b.name);
        });

    let index = filteredProducts.length;

    if (filteredProducts.length === 0) {
        savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
        return;
    }

    filteredProducts.forEach((product) => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';

        const quantityToDisplay = product.quantity || 0;
        const stockQuantityToDisplay = product.stockQuantity || 0;
        const minStockQuantityToDisplay = product.minStockQuantity || 0;

        updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay);

        productDiv.innerHTML = `
            <div class="product-details">
                <p><strong>الاسم:</strong> ${product.name}</p>
                <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                <p><strong>المورد:</strong> ${product.supplierName}</p>
                <p><strong>هاتف المورد:</strong> ${product.supplierPhone}</p>
            </div>

            <div class="product-actions">
                <button type="button" class="btn-delete" onclick="deleteProduct(${product.id})">حذف</button>
                <button type="button" class="btn-edit" data-product-id="${product.id}">تعديل</button>
            </div>

            <p><strong>الكمية في المخزون:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustStock(${product.id}, -1)">-</button>
                <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" onchange="updateStockFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustStock(${product.id}, 1)">+</button>
            </div>

            <p><strong>الحد الأدنى للمخزون:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustMinQuantity(${product.id}, -1)">-</button>
                <input type="number" class="min-product-quantity" data-id="${product.id}" value="${minStockQuantityToDisplay}" min="0" onchange="updateMinStockFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustMinQuantity(${product.id}, 1)">+</button>
            </div>

            <p><strong>الكمية المحددة للفاتورة:</strong></p>
            <div class="quantity-controls">
                <button type="button" onclick="adjustQuantity(${product.id}, -1)">-</button>
                <input type="number" class="product-quantity" data-id="${product.id}" value="${quantityToDisplay}" min="0" onchange="updateQuantityFromInput(${product.id}, this.value)">
                <button type="button" onclick="adjustQuantity(${product.id}, 1)">+</button>
            </div>
        `;

        productDiv.querySelector('.btn-edit').addEventListener('click', (event) => {
            event.stopPropagation(); 
            const productId = event.target.dataset.productId;
            editProduct(productId);
        });

        savedProductsList.appendChild(productDiv);
        index--;
    });
}

/**
 * Displays low stock products in the dedicated section within the Product List tab.
 */
function displayLowStockProducts() {
    lowStockProductsList.innerHTML = ''; // Clear previous content
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

    const lowStockItems = savedProducts.filter(p => (p.stockQuantity || 0) < (p.minStockQuantity || 0) && (p.stockQuantity || 0) > 0);
    const outOfStockItems = savedProducts.filter(p => (p.stockQuantity || 0) === 0);

    if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
        lowStockProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات في المخزون المنخفض أو نفدت حالياً.</p>';
    } else {
        const combinedLowStock = [...lowStockItems, ...outOfStockItems];
        combinedLowStock.sort((a, b) => a.name.localeCompare(b.name));

        combinedLowStock.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product'); 
            if ((product.stockQuantity || 0) < (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0) {
                   productDiv.classList.add('low');
            } else if ((product.stockQuantity || 0) === 0) {
                   productDiv.classList.add('status-insufficient'); 
            }

            productDiv.innerHTML = `
                <div class="product-details">
                    <p><strong>المنتج:</strong> ${product.name}</p>
                    <p><strong>المخزون الحالي:</strong> ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) === 0 ? '(نفد)' : '' }</p>
                    <p><strong>الحد الأدنى للمخزون:</strong> ${product.minStockQuantity || 0}</p>
                </div>
                <div class="product-actions">
                    <button type="button" class="btn1" onclick="showDashboardButton.click(); editProduct(${product.id});">تعديل</button>
                </div>
            `;
            lowStockProductsList.appendChild(productDiv);
        });
    }
}


/**
 * Determines the priority of a product's display status for sorting.
 * Lower number means higher priority (appears earlier in the list).
 */
function getProductStatusPriority(quantity, stock, minStock) {
    if (quantity > 0 && stock < quantity) return 1; 
    if (stock < minStock && quantity === 0) return 2; 
    if (stock < minStock) return 3; 
    if (quantity > 0) return 4; 
    if (stock > 0) return 5; 
    return 6; 
}

/**
 * Updates the CSS classes of a product div based on its stock and selected quantity status.
 * @param {HTMLElement} productDiv - The product div element.
 * @param {number} quantityToDisplay - The quantity selected for invoice.
 * @param {number} stockQuantityToDisplay - The current stock quantity.
 * @param {number} minStockQuantityToDisplay - The minimum stock quantity.
 */
function updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay) {
    productDiv.classList.remove('status-insufficient', 'status-min-zero', 'status-min-positive', 'status-selected-sufficient', 'status-stock-positive', 'status-default');

    if (quantityToDisplay > 0 && stockQuantityToDisplay < quantityToDisplay) {
        productDiv.classList.add('status-insufficient');
    } else if (stockQuantityToDisplay < minStockQuantityToDisplay && quantityToDisplay === 0) {
        productDiv.classList.add('status-min-zero');
    } else if (stockQuantityToDisplay < minStockQuantityToDisplay) {
        productDiv.classList.add('status-min-positive');
    } else if (quantityToDisplay > 0) {
        productDiv.classList.add('status-selected-sufficient');
    } else if (stockQuantityToDisplay > 0) {
        productDiv.classList.add('status-stock-positive');
    } else {
        productDiv.classList.add('status-default');
    }
}

/**
 * Adjusts the stock quantity of a product.
 * @param {number} id - Product ID.
 * @param {number} amount - Amount to add/subtract.
 */
function adjustStock(id, amount) {
    const stockInput = document.getElementById(`stock-${id}`);
    let stockQuantity = parseInt(stockInput.value) || 0;
    stockQuantity += amount;
    if (stockQuantity < 0) stockQuantity = 0; 
    stockInput.value = stockQuantity;

    updateStockInLocalStorage(id, stockQuantity);
}

/**
 * Updates the stock quantity of a product based on input field value.
 * @param {number} id - Product ID.
 * @param {string} value - New stock quantity value from input.
 */
function updateStockFromInput(id, value) {
    let stockQuantity = parseInt(value) || 0;
    if (stockQuantity < 0) stockQuantity = 0; 
    updateStockInLocalStorage(id, stockQuantity);
}

/**
 * Helper function to update stock in Local Storage and refresh UI.
 * @param {number} id - Product ID.
 * @param {number} newStockQuantity - The new stock quantity.
 */
function updateStockInLocalStorage(id, newStockQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].stockQuantity = newStockQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.getElementById(`stock-${id}`).closest('.product');
        const quantityToDisplay = savedProducts[productIndex].quantity || 0;
        const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
        updateProductDivClass(productDiv, quantityToDisplay, newStockQuantity, minStockQuantityToDisplay);
        displayLowStockProducts(); 
    }
}

/**
 * Adjusts the quantity selected for invoice.
 * @param {number} id - Product ID.
 * @param {number} amount - Amount to add/subtract.
 */
function adjustQuantity(id, amount) {
    const quantityInput = document.querySelector(`.product-quantity[data-id="${id}"]`);
    let quantity = parseInt(quantityInput.value) || 0;
    quantity += amount;
    if (quantity < 0) quantity = 0; 
    quantityInput.value = quantity;

    updateInvoiceQuantityInLocalStorage(id, quantity);
}

/**
 * Updates the quantity selected for invoice based on input field value.
 * @param {number} id - Product ID.
 * @param {string} value - New quantity value from input.
 */
function updateQuantityFromInput(id, value) {
    let quantity = parseInt(value) || 0;
    if (quantity < 0) quantity = 0; 
    updateInvoiceQuantityInLocalStorage(id, quantity);
}

/**
 * Helper function to update invoice quantity in Local Storage and refresh UI.
 * @param {number} id - Product ID.
 * @param {number} newQuantity - The new quantity selected for invoice.
 */
function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].quantity = newQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.querySelector(`.product-quantity[data-id="${id}"]`).closest('.product');
        const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
        const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
        updateProductDivClass(productDiv, newQuantity, stockQuantityToDisplay, minStockQuantityToDisplay);
    }
}

/**
 * Adjusts the minimum stock quantity for a product.
 * @param {number} id - Product ID.
 * @param {number} amount - Amount to add/subtract.
 */
function adjustMinQuantity(id, amount) {
    const minQuantityInput = document.querySelector(`.min-product-quantity[data-id='${id}']`);
    let minQuantity = parseInt(minQuantityInput.value) || 0;
    minQuantity += amount;
    if (minQuantity < 0) minQuantity = 0; 
    minQuantityInput.value = minQuantity;

    updateMinStockInLocalStorage(id, minQuantity);
}

/**
 * Updates the minimum stock quantity of a product based on input field value.
 * @param {number} id - Product ID.
 * @param {string} value - New min stock quantity value from input.
 */
function updateMinStockFromInput(id, value) {
    let minQuantity = parseInt(value) || 0;
    if (minQuantity < 0) minQuantity = 0; 
    updateMinStockInLocalStorage(id, minQuantity);
}

/**
 * Helper function to update min stock in Local Storage and refresh UI.
 * @param {number} id - Product ID.
 * @param {number} newMinQuantity - The new minimum stock quantity.
 */
function updateMinStockInLocalStorage(id, newMinQuantity) {
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    const productIndex = savedProducts.findIndex(product => product.id === id);
    if (productIndex !== -1) {
        savedProducts[productIndex].minStockQuantity = newMinQuantity;
        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        const productDiv = document.querySelector(`.min-product-quantity[data-id='${id}']`).closest('.product');
        const quantityToDisplay = savedProducts[productIndex].quantity || 0;
        const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
        updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, newMinQuantity);
        displayLowStockProducts(); 
    }
}


/* --- Invoice Generation and Display --- */

/**
 * Creates and displays an invoice based on selected products and client data.
 * Also saves invoice data to Firebase.
 */
document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
    e.preventDefault();

    if (checkFields(invoiceForm)) {
        let totalHTBeforeCommission = 0; 
        let totalProfit = 0; 
        let totalCommission = 0; 
        let productNumber = 1;
        const detailsTbody = document.getElementById('displayDetails');
        detailsTbody.innerHTML = '';
        
        let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
        let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);

        if (selectedProductsForInvoice.length === 0) {
            const confirmed = await showConfirmModal("تحديد المنتجات", "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة كل المنتجات الموجودة بكمية 1؟");
            if (confirmed) {
                allSavedProducts.forEach(product => {
                    product.quantity = 1; 
                });
                localStorage.setItem('savedProducts', JSON.stringify(allSavedProducts));
                selectedProductsForInvoice = allSavedProducts.filter(p => p.quantity === 1);
            } else {
                showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                return;
            }
        }

        if (selectedProductsForInvoice.length === 0) { 
            showToast("لا توجد منتجات لتضمينها في الفاتورة.", 'info');
            return;
        }

        const invoiceCommissionRate = parseFloat(invoiceCommissionPercentageInput.value) || 0;
        localStorage.setItem('invoiceCommissionPercentage', invoiceCommissionRate); 

        selectedProductsForInvoice.forEach((productData) => {
            const quantity = productData.quantity;
            const sellingPrice = parseFloat(productData.sellingPrice); 
            const purchasePrice = parseFloat(productData.purchasePrice); 

            const itemHT = sellingPrice * quantity; 
            totalHTBeforeCommission += itemHT; 

            const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0; 
            const commissionPerUnit = profitPerUnitBeforeCommission * (invoiceCommissionRate / 100); 

            const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;
            
            totalProfit += actualProfitPerUnit * quantity; 
            totalCommission += commissionPerUnit * quantity; 


            const productDetails = document.createElement('tr');
            productDetails.innerHTML = `
                <td>${productNumber++}</td>
                <td>${productData.name}</td>
                <td>${sellingPrice.toFixed(2)} DH</td>
                <td>${quantity}</td>
                <td>${itemHT.toFixed(2)} DH</td>
            `;
            detailsTbody.appendChild(productDetails);
        });

        const finalTotalHT = totalHTBeforeCommission - totalCommission;

        const tvaRate = parseFloat(tvaInput.value) / 100;
        const tva = (finalTotalHT * tvaRate).toFixed(2);
        const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);

        document.getElementById('displayCustomerName').textContent = customerNameInput.value;
        document.getElementById('displayInvoiceOwner').textContent = invoiceOwnerInput.value;
        document.getElementById('displayInvoiceDate').textContent = invoiceDateInput.value;
        document.getElementById('displayTotalAmountBeforeCommission').textContent = totalHTBeforeCommission.toFixed(2) + ' DH'; 
        document.getElementById('displayCommissionDeducted').textContent = totalCommission.toFixed(2) + ' DH'; 
        document.getElementById('displayTotalAmount').textContent = finalTotalHT.toFixed(2) + ' DH'; 
        document.getElementById('displayTVA').textContent = tva + ' DH';
        document.getElementById('displayTotalTTC').textContent = totalTTC + ' DH';

        document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceOwnerPhoneInput.value;
        document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceOwnerAddressInput.value;
        
        hideAllSections();
        invoiceDisplay.hidden = false;
        // Hide the "Back to Archive" button when generating a new invoice
        backToLocalArchiveButton.hidden = true; 
        window.scrollTo({ top: 0, behavior: 'smooth' });

        localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
        localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
        localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);

        const viewportMeta = document.querySelector('meta[name="viewport"]');
        if (viewportMeta) {
            originalViewportContent = viewportMeta.getAttribute('content'); 
            viewportMeta.setAttribute('content', 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        } else {
            const newViewportMeta = document.createElement('meta');
            newViewportMeta.name = 'viewport';
            newViewportMeta.content = 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            document.head.appendChild(newViewportMeta);
        }
        
        const productsToSaveToFirebase = [];
        selectedProductsForInvoice.forEach((productData) => {
            const profitPerUnitBeforeCommissionFirebase = (parseFloat(productData.sellingPrice) - parseFloat(productData.purchasePrice)) || 0;
            const commissionPerUnitFirebase = profitPerUnitBeforeCommissionFirebase * (invoiceCommissionRate / 100); 
            const actualProfitPerUnitFirebase = profitPerUnitBeforeCommissionFirebase - commissionPerUnitFirebase;

            productsToSaveToFirebase.push({ 
                ...productData, 
                quantityUsed: productData.quantity, 
                profitPerUnit: actualProfitPerUnitFirebase.toFixed(2), 
                commissionPerUnit: commissionPerUnitFirebase.toFixed(2) 
            });
        });

        const invoiceDataToSave = {
            id: Date.now(), // Unique ID for local storage invoice
            date: invoiceDateInput.value,
            customerName: customerNameInput.value,
            ownerName: invoiceOwnerInput.value,
            ownerAddress: invoiceOwnerAddressInput.value,
            ownerPhone: invoiceOwnerPhoneInput.value,
            products: productsToSaveToFirebase,
            totalHT: finalTotalHT.toFixed(2), 
            totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2), 
            tva: tva,
            totalTTC: totalTTC,
            totalProfit: totalProfit.toFixed(2), 
            totalCommission: totalCommission.toFixed(2) 
        };
        if (invoiceCommissionRate > 0) { 
            invoiceDataToSave.invoiceCommissionRate = invoiceCommissionRate; 
        }

        // Save to Firebase
        if (productsToSaveToFirebase.length > 0) {
            const alldataRef = database.ref(`alldata/${invoiceOwnerPhoneInput.value}`);
            alldataRef.push(invoiceDataToSave)
            .then(() => showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success'))
            .catch(error => showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error'));
        }

        // Save to Local Storage
        saveInvoiceToLocalStorage(invoiceDataToSave);

    } else {
        showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
    }
});

/**
 * Updates product stock in Local Storage based on the generated invoice.
 */
document.getElementById('savePdfButton').addEventListener('click', async function() {
    const productsInInvoice = document.querySelectorAll('#invoiceDetails tbody tr');
    const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

    let hasInsufficientStock = false;
    let productsToUpdate = [];

    productsInInvoice.forEach((row) => {
        const productName = row.cells[1].textContent;
        const quantityUsed = parseInt(row.cells[3].textContent);

        const productData = savedProducts.find(p => p.name === productName);
        
        if (productData) {
            const currentStock = parseInt(productData.stockQuantity || 0);
            if (currentStock < quantityUsed) {
                hasInsufficientStock = true;
                showToast(`تنبيه: كمية غير كافية للمنتج "${productName}". المخزون المتاح: ${currentStock}`, 'error');
                return; 
            }
            productsToUpdate.push({ productName, quantityUsed });
        }
    });

    if (hasInsufficientStock) {
        return; 
    }

    const confirmed = await showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة؟");
    if (confirmed) {
        productsToUpdate.forEach(({ productName, quantityUsed }) => {
            const productDataIndex = savedProducts.findIndex(p => p.name === productName);
            if (productDataIndex !== -1) {
                savedProducts[productDataIndex].stockQuantity -= quantityUsed;
            }
        });

        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));

        showToast('تم تحديث المخزون بنجاح.', 'success');
        resetAllProductQuantities(); 
        showDashboardButton.click(); // Redirect to dashboard after stock update
    } else {
        showToast("تم إلغاء تحديث المخزون.", 'info');
    }
});

let originalViewportContent = ''; 

/**
 * Prints the invoice.
*/
document.getElementById('printButton').addEventListener('click', function() {
    const viewportMeta = document.querySelector('meta[name="viewport"]');
    if (viewportMeta) {
        originalViewportContent = viewportMeta.getAttribute('content');
        viewportMeta.setAttribute('content', 'width=1024'); 
    }

    this.style.display = 'none';
    document.getElementById('savePdfButton').style.display = 'none';
    backToLocalArchiveButton.hidden = true; // Ensure this is hidden when printing

    window.print();

    setTimeout(() => {
        document.getElementById('savePdfButton').style.display = 'block';
        this.style.display = 'block';
        // Only show backToLocalArchiveButton if it was previously set to show (i.e. came from archive)
        if (invoiceDisplay.dataset.cameFromLocalArchive === 'true') {
            backToLocalArchiveButton.hidden = false;
        }
        if (viewportMeta && originalViewportContent) {
            viewportMeta.setAttribute('content', originalViewportContent);
        }
    }, 500);
});

// Event listener for Back to Archive button
backToLocalArchiveButton.addEventListener('click', () => {
    showLocalInvoiceArchiveButton.click(); // Simulate click on archive button to go back
});

/* --- Firebase Data Display and Statistics (Combined) --- */

/**
 * Populates the common phone number dropdown from Firebase data.
 */
function populateCommonDropdown() {
    const alldataRef = database.ref('alldata');
    alldataRef.once('value', (snapshot) => {
        const data = snapshot.val();
        commonPhoneDropdown.innerHTML = '';

        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'عرض الكل';
        commonPhoneDropdown.appendChild(allOption);

        const phoneNumbers = new Set();
        if (data) {
            for (const phoneKey in data) {
                if (data.hasOwnProperty(phoneKey)) {
                    phoneNumbers.add(phoneKey);
                }
            }
        }

        const sortedPhoneNumbers = Array.from(phoneNumbers).sort();

        sortedPhoneNumbers.forEach(phoneNumber => {
            const option = document.createElement('option');
            option.value = phoneNumber;
            option.textContent = phoneNumber;
            commonPhoneDropdown.appendChild(option);
        });
    }, (error) => {
        showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
    });
}

/**
 * Fetches all Firebase data (products and invoices) and then applies filters to display them.
 */
async function fetchAndDisplayCombinedFirebaseData() {
    const alldataRef = database.ref('alldata');
    let snapshot;
    try {
        snapshot = await alldataRef.once('value');
    } catch (error) {
        showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
        return;
    }
    const data = snapshot.val();

    allFirebaseProducts = []; 
    allFirebaseInvoicesData = [];

    if (data) {
        for (const phoneKey in data) {
            if (data.hasOwnProperty(phoneKey)) {
                const phoneData = data[phoneKey];
                for (const invoiceKey in phoneData) {
                    if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                        const invoiceDetails = phoneData[invoiceKey];
                        allFirebaseInvoicesData.push({ id: invoiceKey, ...invoiceDetails }); // Store full invoice for stats

                        invoiceDetails.products.forEach(product => {
                            allFirebaseProducts.push({ 
                                ...product, 
                                invoiceDate: invoiceDetails.date,
                                customerName: invoiceDetails.customerName,
                                ownerName: invoiceDetails.ownerName, 
                                ownerAddress: invoiceDetails.ownerAddress, 
                                ownerPhone: invoiceDetails.ownerPhone,
                                totalHT: invoiceDetails.totalHT, 
                                totalTTC: invoiceDetails.totalTTC, 
                                totalProfit: invoiceDetails.totalProfit, 
                                totalCommission: invoiceDetails.totalCommission, 
                                firebaseInvoiceKey: invoiceKey 
                            });
                        });
                    }
                }
            }
        }
    }

    // Apply filters and display both products and statistics
    applyCombinedFilters();
}

/**
 * Applies filters (from common dropdown and search input) to both Firebase products and statistics, then renders them.
 */
function applyCombinedFilters() {
    const searchTerm = commonSearchInput.value.toLowerCase();
    const selectedPhoneNumber = commonPhoneDropdown.value;

    // Filter Products
    const filteredProducts = allFirebaseProducts.filter(product => {
        const matchesSearchInput = searchTerm ? 
            (product.name && product.name.toLowerCase().includes(searchTerm)) || 
            (product.customerName && product.customerName.toLowerCase().includes(searchTerm)) || 
            (product.ownerName && product.ownerName.toLowerCase().includes(searchTerm)) ||
            (product.supplierName && product.supplierName.toLowerCase().includes(searchTerm)) ||
            (product.ownerPhone && product.ownerPhone.includes(searchTerm))
            : true;
        const matchesPhoneNumber = (selectedPhoneNumber === 'all' || product.ownerPhone === selectedPhoneNumber);
        return matchesSearchInput && matchesPhoneNumber;
    });

    const savedLocalProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
    filteredProducts.forEach(product => {
        const isDuplicate = savedLocalProducts.some(savedProduct =>
            product.name.toLowerCase() === savedProduct.name.toLowerCase() &&
            product.supplierPhone === savedProduct.supplierPhone
        );
        product.isDuplicate = isDuplicate;
    });

    filteredProducts.sort((a, b) => {
        if (a.isDuplicate && !b.isDuplicate) return 1;
        if (!a.isDuplicate && b.isDuplicate) return -1;
        return b.id - a.id; 
    });

    displayFirebaseProducts(filteredProducts);

    // Filter Statistics
    let filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
        const matchesSearchInput = searchTerm ? 
            (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
            (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
            (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm))) ||
            (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) 
            : true;
        const matchesPhoneNumber = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);
        return matchesSearchInput && matchesPhoneNumber;
    });
    displayStatistics(filteredInvoices);
}


/**
 * Displays a list of products from Firebase.
 * @param {Array<Object>} products - Array of product objects to display.
 */
function displayFirebaseProducts(products) {
    firebaseProductListContainer.innerHTML = '';

    if (products.length === 0) {
        firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد منتجات لعرضها.</p>';
        return;
    }

    products.forEach(product => { 
        const productDiv = document.createElement('div');
        productDiv.classList.add('product-item');

        if (product.isDuplicate) {
            productDiv.classList.add('status-duplicate');
        }

        const profitPerUnit = parseFloat(product.profitPerUnit || 0);
        const commissionPerUnit = parseFloat(product.commissionPerUnit || 0);

        productDiv.innerHTML = `
            <div class="product-firebase-details">
                <p><strong>تاريخ الفاتورة:</strong> ${product.invoiceDate || 'N/A'}</p>
                <p><strong>العميل:</strong> ${product.customerName || 'N/A'}</p>
                <p><strong>اسم المنتج:</strong> ${product.name}</p>
                <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                <p><strong>الكمية المستخدمة:</strong> ${product.quantityUsed || 0}</p>
                <p><strong>الربح/الوحدة (للفاتورة):</strong> ${profitPerUnit.toFixed(2)} DH</p>
                <p><strong>العمولة/الوحدة (للفاتورة):</strong> ${commissionPerUnit.toFixed(2)} DH</p>
                <p><strong>المورد:</strong> ${product.supplierName}</p>
                <p><strong>هاتف المورد:</strong> ${product.ownerPhone}</p>
                <p><strong>مالك الفاتورة:</strong> ${product.ownerName || 'N/A'}</p>
                <p><strong>إجمالي الفاتورة (HT):</strong> ${parseFloat(product.totalHT || 0).toFixed(2)} DH</p>
                <p><strong>إجمالي الفاتورة (TTC):</strong> ${parseFloat(product.totalTTC || 0).toFixed(2)} DH</p>
            </div>
            <div class="product-actions">
                <button type="button" class="btn1" onclick="event.stopPropagation(); editProductFromFirebase(${product.id});">تعديل (محلي)</button>
            </div>
        `;

        productDiv.addEventListener('click', (event) => {
            showDashboardButton.click(); // Redirect to dashboard
            productNameInput.value = product.name;
            purchasePriceInput.value = parseFloat(product.purchasePrice || 0);
            sellingPriceInput.value = parseFloat(product.sellingPrice || 0);
            supplierNameInput.value = product.supplierName;
            supplierAddressInput.value = product.supplierAddress;
            supplierPhoneInput.value = product.supplierPhone;
            productQuantityInput.value = product.stockQuantity || '0'; 
            addProductButton.style.display = 'block'; 
            saveEditProductButton.style.display = 'none'; 
            resetValidationMessages(productForm); 
            showToast(`تم تحميل بيانات المنتج "${product.name}" إلى نموذج إدارة المنتجات.`, 'info');
        });

        firebaseProductListContainer.appendChild(productDiv);
    });
}

/**
 * Function for populating product form from Firebase data (simplified behavior).
 * It will just pre-fill the product management form. The user can then save as new or manually edit existing.
 */
function editProductFromFirebase(productId) {
    const firebaseProduct = allFirebaseProducts.find(p => p.id == productId); 

    if (firebaseProduct) {
        showDashboardButton.click(); // Redirect to dashboard
        productNameInput.value = firebaseProduct.name;
        purchasePriceInput.value = parseFloat(firebaseProduct.purchasePrice || 0);
        sellingPriceInput.value = parseFloat(firebaseProduct.sellingPrice || 0);
        supplierNameInput.value = firebaseProduct.supplierName;
        supplierAddressInput.value = firebaseProduct.supplierAddress;
        supplierPhoneInput.value = firebaseProduct.supplierPhone;
        productQuantityInput.value = firebaseProduct.stockQuantity || '0'; 
        addProductButton.style.display = 'block'; 
        saveEditProductButton.style.display = 'none';
        resetValidationMessages(productForm); 
        showToast(`تم تحميل بيانات المنتج "${firebaseProduct.name}" إلى نموذج إضافة المنتجات (لإعادة إدخاله أو تعديله محليًا).`, 'info');
    } else {
        showToast("المنتج المراد تعديله غير موجود في بيانات Firebase الحالية.", 'error');
    }
}

// Event listeners for combined filter controls
commonPhoneDropdown.addEventListener('change', applyCombinedFilters);
commonSearchInput.addEventListener('input', applyCombinedFilters);


/* --- Statistics and Tracking --- */

/**
 * Displays statistics based on filtered invoices.
 * @param {Array<Object>} invoices - Array of filtered invoice objects.
 */
function displayStatistics(invoices) {
    let totalSalesHT = 0;
    let totalTVA = 0;
    let totalSalesTTC = 0;
    let totalOverallProfit = 0; 
    let totalOverallCommission = 0; 
    let totalPurchaseCost = 0; 
    let totalSellingPrice = 0; 
    let invoiceCount = invoices.length;
    
    const productSales = {}; // { productName: { quantitySold: X } } - Simplified
    const customerActivity = {}; // { customerName: { invoiceCount: X, totalProfit: Y } } - Simplified

    invoices.forEach(invoice => {
        totalSalesHT += parseFloat(invoice.totalHT || 0); 
        totalTVA += parseFloat(invoice.tva || 0);
        totalSalesTTC += parseFloat(invoice.totalTTC || 0);
        totalOverallProfit += parseFloat(invoice.totalProfit || 0); 
        totalOverallCommission += parseFloat(invoice.totalCommission || 0); 

        if (invoice.products) {
            invoice.products.forEach(product => {
                const productName = product.name;
                const quantityUsed = parseInt(product.quantityUsed || 0);
                const purchasePrice = parseFloat(product.purchasePrice || 0); 
                const sellingPrice = parseFloat(product.sellingPrice || 0);
                
                totalPurchaseCost += purchasePrice * quantityUsed; 
                totalSellingPrice += sellingPrice * quantityUsed; 

                if (!productSales[productName]) {
                    productSales[productName] = { quantitySold: 0 }; 
                }
                productSales[productName].quantitySold += quantityUsed;
            });
        }

        const customer = invoice.customerName || 'N/A';
        const invoiceProfit = parseFloat(invoice.totalProfit || 0); 
        
        if (!customerActivity[customer]) {
            customerActivity[customer] = { invoiceCount: 0, totalProfit: 0 }; 
        }
        customerActivity[customer].invoiceCount += 1;
        customerActivity[customer].totalProfit += invoiceProfit;
    });

    document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCost.toFixed(2)} DH`; 
    document.getElementById('totalSellingPrice').textContent = `${totalSellingPrice.toFixed(2)} DH`; 
    document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`; 
    document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`; 
    document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`; 
    document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
    document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;
    document.getElementById('invoiceCount').textContent = invoiceCount;


    const topSellingProductsList = document.getElementById('topSellingProducts');
    topSellingProductsList.innerHTML = '';
    const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 5); 
    if (sortedProducts.length > 0) {
        sortedProducts.forEach(([name, stats]) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><strong>${name}</strong>: ${stats.quantitySold} وحدات</span>
            `; 
            topSellingProductsList.appendChild(li);
        });
    } else {
        topSellingProductsList.innerHTML = '<li>لا توجد بيانات</li>';
    }

    const topCustomersList = document.getElementById('topCustomers');
    topCustomersList.innerHTML = '';
    const sortedCustomers = Object.entries(customerActivity).sort(([, a], [, b]) => b.invoiceCount - a.invoiceCount).slice(0, 5); 
    if (sortedCustomers.length > 0) {
        sortedCustomers.forEach(([name, stats]) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><strong>${name}</strong>: ${stats.invoiceCount} فواتير</span><br>
                <span>&nbsp;&nbsp;الربح: ${stats.totalProfit.toFixed(2)} DH</span>
            `; 
            topCustomersList.appendChild(li);
        });
    } else {
        topCustomersList.innerHTML = '<li>لا توجد بيانات</li>';
    }
}


/* --- Local Invoice Archive Functions --- */

/**
 * Saves an invoice to Local Storage.
 * @param {object} invoiceData - The invoice object to save.
 */
function saveInvoiceToLocalStorage(invoiceData) {
    let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
    localInvoices.push(invoiceData);
    localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
    showToast("تم حفظ الفاتورة محلياً.", 'success');
}

/**
 * Displays local invoices from Local Storage.
 */
function displayLocalInvoices() {
    allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
    localInvoicesList.innerHTML = '';

    const searchTerm = searchLocalInvoiceInput.value.toLowerCase();

    const filteredInvoices = allLocalInvoices.filter(invoice => {
        const matchesSearch = searchTerm ?
            (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
            (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
            (invoice.date && invoice.date.toLowerCase().includes(searchTerm)) ||
            (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm)))
            : true;
        return matchesSearch;
    });

    if (filteredInvoices.length === 0) {
        localInvoicesList.innerHTML = '<p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>';
        return;
    }

    // Sort by date (newest first)
    filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredInvoices.forEach(invoice => {
        const invoiceDiv = document.createElement('div');
        invoiceDiv.classList.add('local-invoice-item');
        
        invoiceDiv.innerHTML = `
            <div class="invoice-summary-details">
                <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                <p><strong>تاريخ الفاتورة:</strong> ${invoice.date || 'N/A'}</p>
                <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
            </div>
            <div class="invoice-actions">
                <button type="button" class="btn1" onclick="viewLocalInvoiceDetails(${invoice.id})">عرض التفاصيل</button>
                <button type="button" class="btn-delete" onclick="deleteLocalInvoice(${invoice.id})">حذف</button>
            </div>
        `;
        localInvoicesList.appendChild(invoiceDiv);
    });
}

/**
 * Views the details of a specific local invoice.
 * @param {number} invoiceId - The ID of the invoice to view.
 */
function viewLocalInvoiceDetails(invoiceId) {
    const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);

    if (invoiceToView) {
        // Populate the invoice display section
        document.getElementById('displayCustomerName').textContent = invoiceToView.customerName;
        document.getElementById('displayInvoiceOwner').textContent = invoiceToView.ownerName;
        document.getElementById('displayInvoiceDate').textContent = invoiceToView.date;
        document.getElementById('displayTotalAmountBeforeCommission').textContent = parseFloat(invoiceToView.totalHTBeforeCommission || 0).toFixed(2) + ' DH';
        document.getElementById('displayCommissionDeducted').textContent = parseFloat(invoiceToView.totalCommission || 0).toFixed(2) + ' DH';
        document.getElementById('displayTotalAmount').textContent = parseFloat(invoiceToView.totalHT || 0).toFixed(2) + ' DH';
        document.getElementById('displayTVA').textContent = parseFloat(invoiceToView.tva || 0).toFixed(2) + ' DH';
        document.getElementById('displayTotalTTC').textContent = parseFloat(invoiceToView.totalTTC || 0).toFixed(2) + ' DH';

        document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceToView.ownerPhone;
        document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceToView.ownerAddress;

        const detailsTbody = document.getElementById('displayDetails');
        detailsTbody.innerHTML = '';
        let productNumber = 1;
        invoiceToView.products.forEach(productData => {
            const productDetails = document.createElement('tr');
            productDetails.innerHTML = `
                <td>${productNumber++}</td>
                <td>${productData.name}</td>
                <td>${parseFloat(productData.sellingPrice).toFixed(2)} DH</td>
                <td>${productData.quantityUsed}</td>
                <td>${(parseFloat(productData.sellingPrice) * productData.quantityUsed).toFixed(2)} DH</td>
            `;
            detailsTbody.appendChild(productDetails);
        });

        hideAllSections();
        invoiceDisplay.hidden = false;
        // Show the "Back to Archive" button
        backToLocalArchiveButton.hidden = false;
        // Mark that this invoice view came from the local archive
        invoiceDisplay.dataset.cameFromLocalArchive = 'true'; 

        // Hide "Update Stock" button as this is an archive view
        document.getElementById('savePdfButton').style.display = 'none';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
    }
}

/**
 * Deletes a local invoice from Local Storage.
 * @param {number} invoiceId - The ID of the invoice to delete.
 */
async function deleteLocalInvoice(invoiceId) {
    const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟");
    if (confirmed) {
        let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
        localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
        localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
        showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي.", 'success');
        displayLocalInvoices(); // Refresh the list
    } else {
        showToast("تم إلغاء حذف الفاتورة.", 'info');
    }
}

// Event listener for local invoice search
searchLocalInvoiceInput.addEventListener('input', displayLocalInvoices);
</script>
</html>
