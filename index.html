<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÖÿÆÿ≤ŸàŸÜ - ŸÑŸàÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπÿµÿ±Ÿäÿ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Minimalist Business Dashboard inspired color palette */
        :root {
            --primary-color: #3f51b5; /* A deep, professional blue */
            --primary-light: #7986cb; /* Lighter shade for accents */
            --accent-color: #4CAF50; /* A clean green for success/highlight */
            --background-main: #f8f9fa; /* Very light grey for overall background */
            --background-card: #ffffff; /* Pure white for cards */
            --text-dark: #212529; /* Dark grey for main text */
            --text-light: #ffffff; /* White for text on dark backgrounds */
            --border-light: #e0e0e0; /* Light grey for borders */
            --error-color: #dc3545; /* Standard red for errors */
            --warning-color: #ffc107; /* Standard orange for warnings */
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            --border-radius-sm: 6px; /* Slightly less rounded inputs */
            --border-radius-md: 10px; /* Standard card corners */
            --border-radius-lg: 14px; /* More rounded buttons */
            --border-radius-pill: 999px; /* Pill shape */
            
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-medium: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-strong: 0 8px 15px rgba(0,0,0,0.15);
        }

        /* Ensure hidden attribute works reliably */
        [hidden] {
            display: none !important;
        }

        /* Base styles and reset */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            direction: rtl; /* Set direction to Right-To-Left for Arabic */
            background-color: var(--background-main); 
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--text-dark);
            font-size: 16px;
        }
        body {
            padding: var(--spacing-md); 
            padding-bottom: calc(var(--spacing-md) + 60px); /* Space for bottom nav on mobile */
        }

        /* Main controls for navigation (desktop top bar, mobile hidden) */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--primary-color); 
            border-radius: var(--border-radius-md); 
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
            display: none; /* Default hidden, shown on desktop */
        }
        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-lg); /* More rounded buttons */
            text-align: center;
            background-color: var(--primary-light); 
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            box-shadow: var(--shadow-subtle);
            outline: none;
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        .main-controls .btn-panel .icon {
            font-size: 1.2em;
            line-height: 1;
        }
        .main-controls .btn-panel:hover {
            background-color: var(--primary-color); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }
        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--text-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(63, 81, 181, 0.4);
        }
        /* Active button state */
        .main-controls .btn-panel.active {
            background-color: var(--primary-color); 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); 
            transform: translateY(0); 
        }
        .main-controls .btn-panel.active:hover {
            background-color: var(--primary-color); 
            transform: translateY(0);
        }

        /* Bottom Navigation Bar (mobile fixed) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--spacing-sm) 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; /* Default hidden, shown on mobile */
        }
        .bottom-nav .nav-button {
            background: none;
            border: none;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xs);
            gap: var(--spacing-xs);
            font-size: 0.85em;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease;
            border-radius: var(--border-radius-md);
            flex: 1; 
            max-width: 120px; 
        }
        .bottom-nav .nav-button .icon {
            font-size: 1.8em;
            line-height: 1;
        }
        .bottom-nav .nav-button:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        .bottom-nav .nav-button.active {
            color: var(--accent-color); /* Accent color for active mobile nav */
            background-color: var(--primary-light);
            transform: translateY(-2px); 
        }
        .bottom-nav .nav-button.active .icon {
            transform: scale(1.1);
        }

        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px; 
            margin: 0 auto;
            transition: max-width 0.3s ease, padding 0.3s ease; 
        }
        /* Specific max-width for the full-width Firebase view */
        .container.full-width {
            max-width: 100%; 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            box-sizing: border-box;
        }
        /* Ensure direct children of full-width container expand and have padding */
        .container.full-width > section {
            padding-left: var(--spacing-md); 
            padding-right: var(--spacing-md);
            box-sizing: border-box;
            flex-grow: 1; 
        }

        /* Unified Container Styles - for all major content sections */
        .product-container,
        .client-container,
        .invoice,
        .saved-products,
        .local-archive-container-embedded,
        .low-stock-section-standalone,
        .statistics-section,
        .firebase-product-list-wrapper {
            border: 1px solid var(--border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card); 
            box-shadow: var(--shadow-subtle);
            margin-bottom: 0; 
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
        }
        /* Specific style for the main Firebase stats container to be transparent */
        .firebase-stats-combined-container {
            background-color: transparent; 
            box-shadow: none; 
            border: none; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-md); 
        }

        /* Class to apply for animation when hiding/showing. */
        .fade-in-section {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .fade-in-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Dashboard View Specific Styles */
        .dashboard-view {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: flex-start;
            width: 100%;
        }

        /* Unified Headings */
        .dashboard-view h1,
        .firebase-stats-combined-container h1,
        .invoice h1 {
            width: 100%;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xl);
            font-size: 2.2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-light);
        }
        .dashboard-view h2,
        .firebase-stats-combined-container h2,
        .local-archive-container-embedded h2,
        .low-stock-section-standalone h2,
        .client-container h2,
        .product-container h2,
        .invoice h2 {
            width: 100%;
            text-align: center;
            color: var(--primary-color);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.8em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-light);
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        .dashboard-view h2 .icon,
        .firebase-stats-combined-container h2 .icon,
        .local-archive-container-embedded h2 .icon,
        .low-stock-section-standalone h2 .icon,
        .client-container h2 .icon,
        .product-container h2 .icon,
        .invoice h2 .icon {
            font-size: 1.2em;
            line-height: 1;
        }
        /* Sub-headings for lists/sections within main containers */
        .dashboard-view h3,
        .statistics-section h3,
        .low-stock-section-standalone h3,
        .firebase-product-list-wrapper h3,
        #dynamicStatsListContainer > div h3 {
            color: var(--primary-color);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.5em; 
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light); 
            text-align: center;
            width: 100%; 
        }

        /* Specific override for stat-card h3 - small, no border, dark text */
        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.1em;
            color: var(--text-dark);
            border-bottom: none;
            padding-bottom: 0;
        }
        /* Specific override for low stock warning sub-heading if needed */
        .low-stock-section-standalone h3 {
            color: var(--error-color); 
            border-bottom: 1px dashed var(--error-color);
        }

        /* Adjust individual container widths within the dashboard view */
        .dashboard-view > .product-container,
        .dashboard-view > .client-container {
            flex: 1 1 48%;
            min-width: 350px; 
        }
        /* Wrapper for Local Invoice Archive and Low Stock for side-by-side display */
        .dashboard-archive-stock-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            width: 100%; 
            margin-top: var(--spacing-md);
            align-items: stretch; 
        }
        /* Make children of the wrapper take roughly half width */
        .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
        .dashboard-archive-stock-wrapper > .low-stock-section-standalone {
            flex: 1 1 48%; 
            min-width: 300px; 
            display: flex; 
            flex-direction: column; 
        }
        /* Saved Products list below the forms */
        .dashboard-view > .saved-products {
            flex: 1 1 100%; 
            margin-top: var(--spacing-md);
        }

        /* Firebase/Stats Combined Container Layout - this is the wrapper of statistics and product list */
        .firebase-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md); 
            width: 100%;
            flex-grow: 1; 
        }
        /* Style for Firebase product list filters (now inside firebase-product-list-wrapper) */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            margin-bottom: var(--spacing-md);
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }

        /* Unified Scrollable List Containers */
        .saved-products3,
        .local-invoices-list,
        .low-stock-section-standalone .product-list-grid,
        .scrollable-list-in-card {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: var(--spacing-sm); /* Padding for scrollbar */
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid;
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card); 
            padding: var(--spacing-md);
            box-sizing: border-box;
        }
        /* Specific styles for #productListContainerdata (Firebase Products List) to show all items */
        #productListContainerdata {
            max-height: none; 
            overflow-y: visible; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        }

        /* Specific max-height for dashboard lists if needed, but generally let content flow */
        .saved-products3 {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
        .local-invoices-list {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            max-height: 350px; 
        }
        .low-stock-section-standalone .product-list-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            max-height: 350px; 
        }
        /* Specific styling for UL elements inside dynamic stat cards */
        .scrollable-list-in-card {
            grid-template-columns: 1fr; 
            max-height: 150px; 
            padding-left: var(--spacing-xs); 
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-sm);
            background-color: var(--background-main); /* A slightly different background for stat lists UL */
            margin-top: var(--spacing-sm);
            display: flex; 
            flex-direction: column;
        }

        /* Styling for the container of the filter dropdown within stat-card-list */
        .stat-card-filter-wrapper {
            background-color: var(--background-card); 
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            flex: 1 1 100%; 
            display: flex;
            flex-direction: column;
            margin-bottom: var(--spacing-md); 
        }
        /* Make #dynamicStatsListContainer a grid for its *own* children (the individual stat list cards) */
        #dynamicStatsListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: var(--spacing-md);
            flex: 1 1 auto; 
        }
        /* Styling for the individual dynamic list cards (e.g., top products, top customers) */
        #dynamicStatsListContainer > div {
            background-color: var(--background-card); 
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: center;
        }
        p {
            margin: 0;
            padding: 0;
        }
        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--text-dark);
            font-size: 0.95em;
        }
        .form-group label.required::after {
            content: ' *';
            color: var(--error-color);
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--background-card); 
            border-radius: var(--border-radius-sm); 
            border: 1px solid var(--border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--text-dark);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3), var(--shadow-subtle); 
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown),
        .form-group input.error, .form-group select.error {
            border-color: var(--error-color);
        }
        .form-group .validation-error-message {
            color: var(--error-color);
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message,
        .form-group input.error + .validation-error-message, .form-group select.error + .validation-error-message {
            display: flex;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* General button styles */
        .btn, .btn1, .btn2, .btn-delete, .btn-edit, .btn-add-to-local {
            display: flex;
            flex: 1;
            height: 50px;
            padding: 1rem 0;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-subtle);
            font-size: 0.95em;
            outline: none;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        .btn:focus-visible, .btn1:focus-visible, .btn2:focus-visible, .btn-delete:focus-visible, .btn-edit:focus-visible, .btn-add-to-local:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(63, 81, 181, 0.4);
        }
        .btn {
            background-color: var(--primary-color);
        }
        .btn:hover { background-color: #303f9f; transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .btn:active { transform: translateY(0); box-shadow: var(--shadow-subtle); }

        .btn1, .btn2 {
            background-color: var(--accent-color);
        }
        .btn1:hover, .btn2:hover { background-color: #388e3c; transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .btn1:active, .btn2:active { transform: translateY(0); box-shadow: var(--shadow-subtle); }

        .btn-delete {
            background-color: var(--error-color);
            margin-top: var(--spacing-sm);
        }
        .btn-delete:hover { background-color: #c0392b; transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .btn-delete:active { transform: translateY(0); box-shadow: var(--shadow-subtle); }

        .btn-edit {
            background-color: var(--warning-color);
            color: var(--text-dark);
            margin-top: var(--spacing-sm);
        }
        .btn-edit:hover { background-color: #f39c12; transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .btn-edit:active { transform: translateY(0); box-shadow: var(--shadow-subtle); }

        .btn-add-to-local {
            background-color: var(--primary-color);
            color: var(--text-light);
        }
        .btn-add-to-local:hover {
            background-color: #303f9f;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        .btn-add-to-local:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        /* Invoice specific styles */
        .invoice-header,
        .invoice-footer {
            border: none;
            background-color: var(--background-main);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
        }
        .invoice-header1 {
            background-color: var(--background-main);
            text-align: center;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
        }
        .invoice-header1 table {
            width: 100%;
            margin: 0 auto;
        }
        .invoice-header1 tfoot tr td {
            text-align: right;
            font-weight: bold;
            padding: 0.3rem 0;
        }
        /* Responsive table wrapper */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-light);
            background-color: var(--background-main);
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--background-main);
            font-size: 0.95em;
            border: none;
        }
        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--border-light);
            padding: 0.6rem;
            text-align: right;
            white-space: nowrap;
        }
        .invoice-table th {
            background-color: var(--primary-color);
            color: var(--text-light);
            font-weight: bold;
        }
        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: left;
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1em;
        }
        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
        }
        .invoice .divider {
            border-top: 1px dashed var(--border-light);
            margin: var(--spacing-lg) 0;
        }

        /* Unified Product/Item Cards - applies to products in saved lists, low stock, and firebase lists */
        .product, .local-invoice-item {
            border: 1px solid var(--border-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md); 
            background-color: var(--background-card); 
            box-shadow: var(--shadow-subtle);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            text-align: right;
            font-size: 0.95em;
            line-height: 1.5;
            position: relative; 
        }
        .product:hover, .local-invoice-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Status indicators for product cards */
        .product::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            border-top-right-radius: var(--border-radius-md);
            border-bottom-right-radius: var(--border-radius-md);
        }
        /* Specific styling for local/matched products */
        .product.is-local {
            background-color: var(--background-card) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }
        .product.is-local::before {
            background-color: var(--primary-light);
        }
        .product.is-local p {
            color: var(--text-dark);
        }
        .product.is-local .btn-add-to-local {
            background-color: var(--primary-color);
            color: var(--text-light);
        }
        .product.is-local .btn-add-to-local:hover {
            background-color: #303f9f;
        }
        .product.is-local-match {
            background-color: var(--accent-color) !important; 
            border-color: var(--accent-color) !important;
            color: var(--text-light) !important;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        .product.is-local-match::before {
            background-color: var(--accent-color);
        }
        .product.is-local-match p {
            color: var(--text-light) !important;
        }
        .product.is-local-match .product-actions button {
            background-color: var(--background-card);
            color: var(--primary-color);
        }
        .product.is-local-match .product-actions button:hover {
            background-color: var(--background-main);
        }

        /* Product details and actions within cards */
        .product .product-details, .local-invoice-item .invoice-summary-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
            width: 100%;
        }
        .product .product-details p, .local-invoice-item .invoice-summary-details p {
            margin-bottom: 5px;
        }
        .product .product-details p:first-child strong {
            font-size: 1.1em;
            color: var(--primary-color);
        }
        .product .product-actions, .local-invoice-item .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }
        .product .product-actions button, .local-invoice-item .invoice-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            height: 45px; 
            padding: 0.8rem 0;
            font-size: 0.9em;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
            justify-content: center;
        }
        .quantity-controls button {
            width: 45px;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.1s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
            box-shadow: var(--shadow-subtle);
        }
        .quantity-controls button:hover { background-color: #303f9f; box-shadow: var(--shadow-medium); }
        .quantity-controls button:active { transform: scale(0.95); box-shadow: var(--shadow-subtle); }
        .quantity-controls button:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(63, 81, 181, 0.4);
        }
        .quantity-controls input {
            width: 80px;
            max-width: 120px;
            height: 45px;
            margin: 0 var(--spacing-sm);
            font-size: 1.1em;
            text-align: center;
            border-radius: var(--border-radius-pill); 
            background-color: var(--background-main);
            border: 1px solid var(--border-light);
            color: var(--text-dark);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .quantity-controls input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }

        /* Product status colors */
        .product.status-insufficient {
            background-color: var(--error-color) !important;
            color: var(--text-light);
            border-color: var(--error-color) !important;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
        }
        .product.status-insufficient::before {
            background-color: var(--error-color);
        }
        .product.status-insufficient p { color: var(--text-light); }
        .product.status-min-zero, .product.status-min-positive {
            background-color: var(--warning-color) !important;
            color: var(--text-dark);
            border-color: var(--warning-color) !important;
            box-shadow: 0 2px 5px rgba(255, 193, 7, 0.2);
        }
        .product.status-min-zero::before, .product.status-min-positive::before {
            background-color: var(--warning-color);
        }
        .product.status-min-zero p, .product.status-min-positive p { color: var(--text-dark); }
        .product.status-selected-sufficient {
            background-color: var(--background-main) !important;
            border-color: var(--primary-light) !important;
            box-shadow: 0 2px 5px rgba(63, 81, 181, 0.2);
        }
        .product.status-selected-sufficient::before {
            background-color: var(--primary-light);
        }
        .product.status-stock-positive, .product.status-default {
            background-color: var(--background-card) !important;
            border-color: var(--border-light) !important;
            box-shadow: var(--shadow-subtle);
        }
        .product.status-stock-positive::before, .product.status-default::before {
            background-color: transparent; /* No specific color for default/positive stock */
        }

        /* Search inputs */
        #searchProduct, #searchLocalInvoice, #commonSearchInput {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius-lg); 
            border: 1px solid var(--border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--background-card);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--text-dark);
            outline: none;
            text-align: right;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            padding-left: 30px; 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239e9e9e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 18px;
        }
        #searchProduct:focus, #searchLocalInvoice:focus, #commonSearchInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }

        /* Filter controls in Firebase section */
        .combined-firebase-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--background-main);
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        /* Override for filters within Firebase product list wrapper to be transparent */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }
        .combined-firebase-filter-controls .form-group {
            flex: 1 1 48%;
            min-width: 250px;
            margin-bottom: 0;
        }
        .combined-firebase-filter-controls .form-group label {
            display: none;
        }
        /* Select element styling (for dropdowns) */
        .combined-firebase-filter-controls select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--background-card);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-light);
            font-size: 1em;
            color: var(--text-dark);
            outline: none;
            text-align: right;
            appearance: none; /* Remove default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23212529%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 12px;
            padding-left: 30px; 
            padding-right: 0.8rem;
        }
        .combined-firebase-filter-controls select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }

        /* Statistics Section Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        /* Specific style for list-containing stat cards to span full grid width */
        .stat-card-list {
            grid-column: 1 / -1; 
            display: flex; 
            flex-wrap: wrap;
            gap: var(--spacing-md); 
            align-items: stretch; 
            width: 100%;
        }
        /* Individual stat cards */
        .stat-card {
            background-color: var(--background-card);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 auto; 
        }
        .stat-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-dark);
            margin: 0;
        }
        /* Styling for list items within scrollable cards (e.g., top selling products list) */
        .scrollable-list-in-card li {
            background-color: var(--background-main); /* Slightly darker background for list items */
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 6px;
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .scrollable-list-in-card li:hover { background-color: #e8ebf0; } /* Subtle hover */
        .scrollable-list-in-card li:last-child { margin-bottom: 0; }
        .scrollable-list-in-card li span:first-child {
            white-space: normal;
            word-break: break-word;
            flex-grow: 1;
            margin-left: var(--spacing-xs);
            margin-right: 0;
        }
        .scrollable-list-in-card li span:last-child {
            font-weight: bold;
            flex-shrink: 0;
        }
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: var(--spacing-lg); /* Appear from bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; /* Stack from bottom up */
            gap: 10px;
            pointer-events: none;
            align-items: center;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            padding: var(--spacing-md);
        }
        .toast {
            background-color: var(--background-card);
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(20px); /* Start from below */
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
            direction: rtl;
        }
        .toast.success { border-right: 5px solid var(--accent-color); border-left: none;}
        .toast.error { border-right: 5px solid var(--error-color); border-left: none;}
        .toast.info { border-right: 5px solid var(--primary-color); border-left: none;}
        .toast .icon { font-size: 1.5em; line-height: 1; }
        .toast.success .icon { color: var(--accent-color); }
        .toast.error .icon { color: var(--error-color); }
        .toast.info .icon { color: var(--primary-color); }
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        /* Custom Confirmation Modal */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #confirm-modal-dialog {
            background-color: var(--background-card);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            direction: rtl;
        }
        #confirm-modal-overlay.active #confirm-modal-dialog { transform: scale(1); }
        #confirm-modal-dialog h3 {
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
        }
        #confirm-modal-dialog p {
            color: var(--text-dark);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }
        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }
        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-pill);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #confirm-yes-btn { background-color: var(--primary-color); color: var(--text-light); }
        #confirm-yes-btn:hover { background-color: #303f9f; }
        #confirm-no-btn { background-color: var(--border-light); color: var(--text-dark); }
        #confirm-no-btn:hover { background-color: #bdbdbd; }

        /* Media Queries for Responsiveness */
        @media (min-width: 769px) {
            .main-controls {
                display: flex; /* Show top nav on desktop */
            }
            .bottom-nav {
                display: none; /* Hide bottom nav on desktop */
            }
            body {
                padding-bottom: var(--spacing-md); /* Remove extra padding if bottom nav not shown */
            }
        }
        @media (max-width: 1024px) {
            .container { max-width: 960px; }
            .main-controls .btn-panel { font-size: 0.9em; padding: 0.6rem 0.8rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); }
            .stat-card h3 { font-size: 1em; }
            .stat-card p { font-size: 1.4em; }
            /* This is for UL list within dynamic stat cards, not the card itself */
            .scrollable-list-in-card { max-height: 100px; } /* Smaller max-height for tablets */
            .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
            .dashboard-archive-stock-wrapper > .low-stock-section-standalone { flex: 1 1 45%; }
            .local-invoices-list, .low-stock-section-standalone .product-list-grid {
                 max-height: 300px; /* Adjust fixed heights for tablets */
            }
            /* Adjust dynamic stats list container for smaller desktop/tablet */
            #dynamicStatsListContainer {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Allow smaller min width for 2 columns */
            }
        }
        @media (max-width: 768px) {
            body { padding: var(--spacing-sm); padding-bottom: calc(var(--spacing-sm) + 60px); } /* Adjust for mobile bottom nav */
            .main-controls { display: none; } /* Hide top nav on mobile */
            .bottom-nav { display: flex; } /* Show bottom nav on mobile */
            .container { max-width: 100%; }
            .dashboard-view > .product-container, .dashboard-view > .client-container { min-width: unset; flex: 1 1 100%; }
            .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
            .dashboard-archive-stock-wrapper > .low-stock-section-standalone { flex: 1 1 100%; }
            .invoice h1 { font-size: 1.8em; }
            .invoice h2 { font-size: 1.4em; }
            .invoice-table th, .invoice-table td { padding: 0.5rem; font-size: 0.8em; }
            .saved-products3, .local-invoices-list, #productListContainerdata {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: none; /* Removed max height for mobile to show all */
                overflow-y: visible; /* Ensure no internal scroll on mobile */
            }
            .stat-card p { font-size: 1.3em; }
            .statistics-section h2 { font-size: 1.5em; }
            .toast { min-width: unset; max-width: 90%; }
            .dashboard-view > section { flex: 1 1 100%; }
            .combined-firebase-filter-controls .form-group { min-width: unset; flex: 1 1 100%; }
            .scrollable-list-in-card { max-height: 150px; }
            .low-stock-section-standalone .product-list-grid { max-height: 250px; }
            .quantity-controls input { width: 60px; margin: 0 5px; }
            .stat-card-list { flex-direction: column; } /* Forces filter and dynamic list container to stack */
            .stat-card-list > div { flex: 1 1 100%; } /* Makes filter wrapper and dynamicStatsListContainer take full width */
            #dynamicStatsListContainer {
                grid-template-columns: 1fr; /* Single column on very small screens */
            }
        }
        @media (max-width: 480px) {
            body { padding: var(--spacing-sm); padding-bottom: calc(var(--spacing-sm) + 60px); }
            .button-container { flex-direction: column; }
            .btn, .btn1, .btn2, .btn-delete, .btn-edit, .btn-add-to-local { flex: 1 1 100%; }
            .quantity-controls { flex-wrap: wrap; justify-content: center; }
            .quantity-controls input { width: 60px; margin: 0 5px; }
            .stats-grid { grid-template-columns: 1fr; }
            .saved-products3, .product-list-grid, .local-invoices-list, #productListContainerdata {
                grid-template-columns: 1fr;
                max-height: none; /* Ensure no max-height even on smallest mobile */
                overflow-y: visible; /* No internal scroll */
            }
            .dashboard-view h1, .firebase-stats-combined-container h1 { font-size: 1.8em; }
            .dashboard-view h2, .firebase-stats-combined-container h2 { font-size: 1.5em; }
            .dashboard-view h3, .statistics-section h3, .low-stock-section-standalone h3 { font-size: 1.3em; }
            .invoice h1 { font-size: 1.6em; }
            .invoice h2 { font-size: 1.3em; }
            .stat-card h3 { font-size: 0.9em; }
            .stat-card p { font-size: 1.2em; }
            .scrollable-list-in-card { font-size: 0.8em; padding: 4px 6px; max-height: 150px; }
            .low-stock-section-standalone .product-list-grid { max-height: 200px; }
            .toast { padding: 10px 15px; font-size: 0.9em; }
            .toast .icon { font-size: 1.2em; }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <!-- JsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
</head>
<body>
    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿπŸÑŸàŸä (ŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ± ÿßŸÑŸÑŸàÿ≠Ÿä ŸàÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ± ÿßŸÑŸÖŸÉÿ™ÿ®Ÿä) -->
    <header class="main-controls" id="desktopNav">
        <button type="button" class="btn-panel" id="showDashboardButton"><span class="icon">üè†</span>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (ÿßŸÑÿ•ÿØÿßÿ±ÿ©)</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton"><span class="icon">üìä</span>ÿ®ŸäÿßŸÜÿßÿ™ Firebase</button>
    </header>

    <main class="container">
        <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ÿå ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±ÿå ÿ£ÿ±ÿ¥ŸäŸÅÿå ŸÖÿÆÿ≤ŸàŸÜ ŸÖŸÜÿÆŸÅÿ∂ -->
        <section id="mainDashboardView" class="dashboard-view fade-in-section">
            <h1>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</h1>

            <!-- ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
            <section class="product-container" id="productFormContainer">
                <h2><span class="icon">üì¶</span>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ° ŸÖÿ∑ŸÑŸàÿ® (ÿ∫Ÿäÿ± ÿ≥ÿßŸÑÿ®).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ ŸÖÿ∑ŸÑŸàÿ® (ÿ∫Ÿäÿ± ÿ≥ÿßŸÑÿ®).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàÿ±ÿØ ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">T√©l√©phone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="ŸÖÿ´ÿßŸÑ: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ ŸÖÿ∑ŸÑŸàÿ® (10 ÿ£ÿ±ŸÇÿßŸÖ).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantit√© initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantit√©" value="0" min="0">
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn" id="addProduct"><span class="icon">‚ûï</span>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</button>
                        <button type="submit" class="btn" id="saveEditProduct" style="display: none;"><span class="icon">‚úèÔ∏è</span>ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</button>
                    </div>
                </form>
            </section>

            <!-- ŸÇÿ≥ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± -->
            <section class="client-container" id="clientFormContainer">
                <h2><span class="icon">üìù</span>ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propri√©taire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propri√©taire de la facture" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿßÿ≥ŸÖ ŸÖÿßŸÑŸÉ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propri√©taire de la facture</label>
                        <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propri√©taire de la facture" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿπŸÜŸàÿßŸÜ ŸÖÿßŸÑŸÉ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">T√©l√©phone du propri√©taire de la facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="ŸÖÿ´ÿßŸÑ: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸÖÿßŸÑŸÉ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ® (10 ÿ£ÿ±ŸÇÿßŸÖ).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ŸÜÿ≥ÿ®ÿ© TVA ŸÖÿ∑ŸÑŸàÿ®ÿ© (ÿ®ŸäŸÜ 0 Ÿà 100).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                        <input type="number" id="invoiceCommissionPercentage" placeholder="ŸÖÿ´ÿßŸÑ: 10" value="0" min="0" max="100" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">‚ö†Ô∏è</span>ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπŸÖŸàŸÑÿ© ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ÿ®ŸäŸÜ 0 Ÿà 100).
                        </span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn" id="createInvoiceButton"><span class="icon">‚úÖ</span>ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© Ÿàÿπÿ±ÿ∂Ÿáÿß</button>
                    </div>
                </form>
            </section>

            <!-- ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸàŸÇÿ≥ŸÖ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ (ÿ£ŸÅŸÇŸäŸãÿß) -->
            <div class="dashboard-archive-stock-wrapper">
                <section class="local-archive-container-embedded" id="localInvoiceArchive">
                    <h2><span class="icon">üóÑÔ∏è</span>ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</h2>
                    <div class="form-group">
                        <label for="searchLocalInvoice" class="sr-only">ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</label>
                        <input type="text" id="searchLocalInvoice" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑŸäÿ©">
                    </div>
                    <div class="local-invoices-list product-list-grid" id="localInvoicesList">
                        <p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿ≠ŸÑŸäÿßŸã.</p>
                    </div>
                </section>

                <section class="low-stock-section-standalone" id="lowStockProductsContainer">
                    <h2><span class="icon">üìâ</span>ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</h2>
                    <div class="form-group">
                        <label for="searchProduct" class="sr-only">ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨</label>
                        <input type="text" id="searchProduct" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨">
                    </div>
                    <div class="product-list-grid" id="lowStockProductsList">
                        <p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ ÿ£Ÿà ŸÜŸÅÿØÿ™ ÿ≠ÿßŸÑŸäÿßŸã.</p>
                    </div>
                </section>
            </div>

            <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© -->
            <section class="saved-products" id="savedProductsDisplay">
                <div class="divider"></div>
                <h2><span class="icon">üõí</span>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©</h2>
                <div class="saved-products3 product-list-grid" id="savedProductsList"></div>
            </section>
        </section>

        <!-- ÿπÿ±ÿ∂ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ŸÖÿÆŸÅŸä ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäŸãÿß) -->
        <article class="invoice fade-in-section" id="invoiceDisplay" hidden>
            <button type="button" class="btn" id="savePdfButton"><span class="icon">üì¶</span>ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ (ÿ®ÿπÿØ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©)</button>
            <h1>DEVIS</h1>

            <section class="invoice-header">
                <h2><span class="icon">üë§</span>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿπŸÖŸäŸÑ</h2>
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Propri√©taire de la facture: <span id="displayInvoiceOwner"></span></p>
                <p>Date de la facture: <time datetime="" id="displayInvoiceDate"></time></p>
            </section>

            <div class="table-responsive">
                <table class="invoice-table" id="invoiceDetails">
                    <thead>
                        <tr>
                            <th>N¬∞</th>
                            <th>Nom du produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantit√©</th>
                            <th>Montant HT</th>
                        </tr>
                    </thead>
                    <tbody id="displayDetails">
                    </tbody>
                </table>
            </div>

            <div class="invoice-header1">
                <h2><span class="icon">üìä</span>ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h2>
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ŸÇÿ®ŸÑ ÿßŸÑÿπŸÖŸàŸÑÿ© (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>ÿßŸÑÿπŸÖŸàŸÑÿ© ÿßŸÑŸÖÿÆÿµŸàŸÖÿ©:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <footer class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>T√©l√©phone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </footer>

            <div class="button-container">
                <button type="button" class="btn" id="printButton"><span class="icon">üñ®Ô∏è</span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</button>
            </div>
        </article>

        <!-- ÿ®ŸäÿßŸÜÿßÿ™ Firebase ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ (ŸÖÿÆŸÅŸä ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäŸãÿß) -->
        <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay" hidden>
            <h1>ÿ®ŸäÿßŸÜÿßÿ™ Firebase ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</h1>
            <div class="firebase-content-wrapper">
                <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
                <section class="statistics-section">
                    <h2><span class="icon">üìà</span>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</h3>
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</h3>
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπŸÖŸàŸÑÿ©</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ±ÿ®ÿßÿ≠</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card-list">
                            <!-- New filter dropdown for most active/selling -->
                            <div class="stat-card-filter-wrapper">
                                <div class="form-group" style="width: 100%; margin-bottom: 0;">
                                    <label for="commonFilterSelect" class="sr-only">ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</label>
                                    <select id="commonFilterSelect" style="text-align: right;">
                                        <option value="none">ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ (ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™)</option>
                                        <option value="topSellingProducts">ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÖÿ®ŸäÿπÿßŸã</option>
                                        <option value="topCustomers">ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</option>
                                        <option         value="topSuppliers">ÿßŸÑŸÖŸàÿ±ÿØŸàŸÜ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</option>
                                        <option value="topInvoiceOwners">ÿ£ÿµÿ≠ÿßÿ® ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</option>
                                    </select>
                                </div>
                                <!-- Total price for most selling products will appear here -->
                                <p id="mostSellingTotalPrice" class="text-xl font-bold text-green-700 mt-4 hidden">
                                    ŸÖÿ¨ŸÖŸàÿπ ÿ≥ÿπÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÖÿ®ŸäÿπÿßŸã: <span id="mostSellingTotalPriceValue">0.00 DH</span>
                                </p>
                            </div>
                            <div id="dynamicStatsListContainer">
                                <!-- Dynamic content for top lists will be rendered here -->
                                <!-- These divs are now the grid items -->
                                <div>
                                    <h3>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÖÿ®ŸäÿπÿßŸã</h3>
                                    <ul id="topSellingProductsList" class="scrollable-list-in-card">
                                        <li>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</h3>
                                    <ul id="topCustomersList" class="scrollable-list-in-card">
                                        <li>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>ÿ£ÿµÿ≠ÿßÿ® ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</h3>
                                    <ul id="topInvoiceOwnersList" class="scrollable-list-in-card">
                                        <li>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>ÿßŸÑŸÖŸàÿ±ÿØŸàŸÜ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</h3>
                                    <ul id="topSuppliersList" class="scrollable-list-in-card">
                                        <li>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ŸÇÿ≥ŸÖ ŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ Firebase -->
                <section class="firebase-product-list-wrapper">
                    <h2><span class="icon">‚òÅÔ∏è</span>ŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ Firebase (<span id="firebaseProductListCount">0</span>)</h2>
                    <div class="combined-firebase-filter-controls">
                        <div class="form-group">
                            <label for="commonPhoneDropdown" class="sr-only">ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                            <select id="commonPhoneDropdown">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commonSearchInput" class="sr-only">ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ Firebase</label>
                            <input type="text" id="commonSearchInput" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅÿå ÿßŸÑÿßÿ≥ŸÖÿå ÿ£Ÿà ÿßŸÑŸÖŸÜÿ™ÿ¨">
                        </div>
                    </div>
                    <div class="saved-products3 product-list-grid" id="productListContainerdata"></div>
                </section>
            </div>
        </section>
    </main>

    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿ≥ŸÅŸÑŸä (ŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ) -->
    <nav class="bottom-nav" id="mobileNav">
        <button type="button" class="nav-button" id="mobileShowDashboardButton">
            <span class="icon">üè†</span>
            <span>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowFirebaseDataButton">
            <span class="icon">üìä</span>
            <span>ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
        </button>
        <button type="button" class="nav-button" id="mobileCreateInvoiceButton">
            <span class="icon">üìù</span>
            <span>ŸÅÿßÿ™Ÿàÿ±ÿ©</span>
        </button>
    </nav>

    <!-- ÿ≠ÿßŸàŸäÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ -->
    <div id="toast-container"></div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© -->
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°</h3>
            <p id="confirm-modal-message">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">ŸÜÿπŸÖ</button>
                <button type="button" id="confirm-no-btn">ŸÑÿß</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (uses the one provided by the user)
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        // Initialize Firebase App
        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            // Show a persistent error message or disable Firebase-dependent features
            showToast("ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© Firebase. ŸÇÿØ ŸÑÿß ÿ™ÿπŸÖŸÑ ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿπŸÑŸÇÿ© ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©.", 'error');
        }

        // __app_id is a global variable provided by the Canvas environment.
        // It's used as part of the database path to isolate data for this specific app instance.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ====== Global UI Elements ======
        const mainDashboardView = document.getElementById('mainDashboardView');
        const productFormContainer = document.getElementById('productFormContainer');
        const clientFormContainer = document.getElementById('clientFormContainer');
        const invoiceDisplay = document.getElementById('invoiceDisplay');
        const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay');
        const lowStockProductsContainer = document.getElementById('lowStockProductsContainer');
        
        const desktopShowDashboardButton = document.getElementById('showDashboardButton');
        const desktopShowFirebaseDataButton = document.getElementById('showFirebaseDataButton');
        const desktopNavButtons = [desktopShowDashboardButton, desktopShowFirebaseDataButton];

        const mobileShowDashboardButton = document.getElementById('mobileShowDashboardButton');
        const mobileShowFirebaseDataButton = document.getElementById('mobileShowFirebaseDataButton');
        const mobileCreateInvoiceButton = document.getElementById('mobileCreateInvoiceButton');
        const mobileNavButtons = [mobileShowDashboardButton, mobileShowFirebaseDataButton, mobileCreateInvoiceButton];

        const productForm = document.getElementById('productForm');
        const productNameInput = document.getElementById('productName');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const supplierNameInput = document.getElementById('supplierName');
        const supplierAddressInput = document.getElementById('supplierAddress');
        const supplierPhoneInput = document.getElementById('supplierPhone');
        const productQuantityInput = document.getElementById('productQuantity');
        
        const invoiceForm = document.getElementById('invoiceForm');
        const customerNameInput = document.getElementById('customerName');
        const invoiceOwnerInput = document.getElementById('invoiceOwner');
        const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
        const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const tvaInput = document.getElementById('tva');
        const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage');
        
        const addProductButton = document.getElementById('addProduct');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        const savedProductsList = document.getElementById('savedProductsList');
        const searchProductInput = document.getElementById('searchProduct');
        
        const commonPhoneDropdown = document.getElementById('commonPhoneDropdown');
        const commonSearchInput = document.getElementById('commonSearchInput');
        const firebaseProductListCountSpan = document.getElementById('firebaseProductListCount');
        const firebaseProductListContainer = document.getElementById('productListContainerdata');
        const lowStockProductsList = document.getElementById('lowStockProductsList');
        const localInvoicesList = document.getElementById('localInvoicesList');
        const searchLocalInvoiceInput = document.getElementById('searchLocalInvoice');
        
        const commonFilterSelect = document.getElementById('commonFilterSelect');
        const mostSellingTotalPriceDisplay = document.getElementById('mostSellingTotalPrice');
        const mostSellingTotalPriceValue = document.getElementById('mostSellingTotalPriceValue');
        const dynamicStatsListContainer = document.getElementById('dynamicStatsListContainer');

        const toastContainer = document.getElementById('toast-container');
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmResolve;

        let allFirebaseInvoicesData = [];
        let allFirebaseProducts = [];
        let allLocalInvoices = [];
        const mainContainer = document.querySelector('main.container');
        let currentEditingProductId = null; // Used for product editing state

        // ====== Initial Setup on Window Load ======
        window.addEventListener('load', () => {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' });
            invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
            document.getElementById('displayInvoiceDate').setAttribute('datetime', now.toISOString());

            // Load saved form values from localStorage
            const savedInvoiceOwner = localStorage.getItem('invoiceOwner');
            const savedInvoiceOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
            const savedInvoiceOwnerAddress = localStorage.getItem('invoiceOwnerAddress');
            const savedSupplierName = localStorage.getItem('supplierName');
            const savedSupplierAddress = localStorage.getItem('supplierAddress');
            const savedSupplierPhone = localStorage.getItem('supplierPhone');
            const savedInvoiceCommission = localStorage.getItem('invoiceCommissionPercentage');
            const savedTVA = localStorage.getItem('tva');

            if (savedInvoiceOwner) invoiceOwnerInput.value = savedInvoiceOwner;
            if (savedInvoiceOwnerPhone) invoiceOwnerPhoneInput.value = savedInvoiceOwnerPhone;
            if (savedInvoiceOwnerAddress) invoiceOwnerAddressInput.value = savedInvoiceOwnerAddress;
            if (savedSupplierName) supplierNameInput.value = savedSupplierName;
            if (savedSupplierAddress) supplierAddressInput.value = savedSupplierAddress;
            if (savedSupplierPhone) supplierPhoneInput.value = savedSupplierPhone;
            if (savedInvoiceCommission) invoiceCommissionPercentageInput.value = savedInvoiceCommission;
            if (savedTVA) tvaInput.value = savedTVA;

            displayLocalInvoices();
            displayLowStockProducts();
            displaySavedProducts();

            // Set initial view to Dashboard and activate corresponding button
            // Check screen size to activate correct button type
            if (window.innerWidth <= 768) {
                setActiveButton(mobileShowDashboardButton, mobileNavButtons);
            } else {
                setActiveButton(desktopShowDashboardButton, desktopNavButtons);
            }
            mainContainer.classList.remove('full-width');
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ====== UI Management Functions ======
        function hideAllSections() {
            const sectionsToHide = [mainDashboardView, invoiceDisplay, firebaseProductsDisplay];
            sectionsToHide.forEach(section => {
                if (section.classList.contains('visible')) {
                    section.classList.remove('visible');
                    setTimeout(() => { section.hidden = true; }, 500); // Wait for transition
                }
            });
        }
        function showSection(sectionToShow) {
            return new Promise(resolve => {
                hideAllSections();
                sectionToShow.hidden = false;
                // Timeout to allow display: block to apply before transition
                setTimeout(() => {
                    sectionToShow.classList.add('visible');
                    resolve();
                }, 10);
            });
        }
        function setActiveButton(activeBtn, buttonGroup) {
            buttonGroup.forEach(btn => { btn.classList.remove('active'); });
            activeBtn.classList.add('active');
        }
        function resetValidationMessages(form) {
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');
            fields.forEach(field => {
                field.classList.remove('error'); // Clear previous error state
                field.style.borderColor = ''; // Reset border color
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.style.display = 'none';
                    errorMessageSpan.textContent = ''; // Clear message
                }
            });
        }
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let iconHtml = '';
            if (type === 'success') { iconHtml = '<span class="icon">‚úî</span>'; }
            else if (type === 'error') { iconHtml = '<span class="icon">‚úñ</span>'; }
            else if (type === 'info') { iconHtml = '<span class="icon">‚Ñπ</span>'; }
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }
        function showConfirmModal(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalOverlay.hidden = false;
                confirmModalOverlay.classList.add('active');
                const handleYes = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };
                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        // ====== Section Display Event Listeners ======
        desktopShowDashboardButton.addEventListener('click', async () => {
            await showSection(mainDashboardView);
            setActiveButton(desktopShowDashboardButton, desktopNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displayLowStockProducts();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        desktopShowFirebaseDataButton.addEventListener('click', async () => {
            await showSection(firebaseProductsDisplay);
            setActiveButton(desktopShowFirebaseDataButton, desktopNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = '';
            commonFilterSelect.value = 'none'; // Reset general filter
            mostSellingTotalPriceDisplay.classList.add('hidden'); // Hide total price initially
            if (database) {
                populateCommonDropdown(); // Populates dropdown with unique phone numbers from Firebase
                fetchAndDisplayCombinedFirebaseData(); // Fetches all Firebase data and applies filters
            } else {
                showToast("ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£ÿ©. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Mobile Nav Buttons
        mobileShowDashboardButton.addEventListener('click', async () => {
            await showSection(mainDashboardView);
            setActiveButton(mobileShowDashboardButton, mobileNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displayLowStockProducts();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        mobileShowFirebaseDataButton.addEventListener('click', async () => {
            await showSection(firebaseProductsDisplay);
            setActiveButton(mobileShowFirebaseDataButton, mobileNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = '';
            commonFilterSelect.value = 'none'; // Reset general filter
            mostSellingTotalPriceDisplay.classList.add('hidden'); // Hide total price initially
            if (database) {
                populateCommonDropdown();
                fetchAndDisplayCombinedFirebaseData();
            } else {
                showToast("ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£ÿ©. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        mobileCreateInvoiceButton.addEventListener('click', async () => {
            await showSection(mainDashboardView); // Go to dashboard
            setActiveButton(mobileCreateInvoiceButton, mobileNavButtons); // Activate this button to indicate invoice focus
            mainContainer.classList.remove('full-width');
            window.scrollTo({ top: clientFormContainer.offsetTop, behavior: 'smooth' }); // Scroll to invoice form
            resetAllProductQuantities(); // Clear any previously selected quantities
            displaySavedProducts(); // Refresh products list
            showToast("Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑŸÉŸÖŸäÿßÿ™ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©.", 'info');
        });

        // ====== Form Validation Helper ======
        function checkFields(form) {
            let allFieldsFilled = true;
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');
            fields.forEach(field => {
                const errorMessageSpan = field.nextElementSibling;
                const fieldValue = field.value.trim();
                field.classList.remove('error'); // Clear previous error state
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.style.display = 'none';
                    errorMessageSpan.textContent = ''; // Clear previous message
                }
                if (!fieldValue) {
                    allFieldsFilled = false;
                    field.classList.add('error');
                    if (errorMessageSpan) {
                        errorMessageSpan.textContent = `‚ö†Ô∏è ${field.placeholder || field.labels[0].textContent} ŸÖÿ∑ŸÑŸàÿ®.`;
                        errorMessageSpan.style.display = 'flex';
                    }
                } else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                        if (isNaN(numValue) || numValue < 0) {
                            allFieldsFilled = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.textContent = '‚ö†Ô∏è ÿßŸÑŸÇŸäŸÖÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ±ŸÇŸÖÿßŸã ŸÖŸàÿ¨ÿ®ÿßŸã.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    } else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                        if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                            allFieldsFilled = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.textContent = '‚ö†Ô∏è ÿßŸÑŸÜÿ≥ÿ®ÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸäŸÜ 0 Ÿà 100.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    const regex = new RegExp(field.pattern);
                    if (!regex.test(fieldValue)) {
                        allFieldsFilled = false;
                        field.classList.add('error');
                        if (errorMessageSpan) {
                            errorMessageSpan.textContent = '‚ö†Ô∏è ÿµŸäÿ∫ÿ© ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ© (10 ÿ£ÿ±ŸÇÿßŸÖ).';
                            errorMessageSpan.style.display = 'flex';
                        }
                    }
                }
            });
            return allFieldsFilled;
        }

        // ====== Product Management (Local Storage) ======
        async function handleProductFormSubmission(productId = null) {
            if (!checkFields(productForm)) {
                showToast("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠.", 'error');
                return;
            }
            const name = productNameInput.value.trim();
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const sellingPrice = parseFloat(sellingPriceInput.value);
            const supplierName = supplierNameInput.value.trim();
            const supplierAddress = supplierAddressInput.value.trim();
            const supplierPhone = supplierPhoneInput.value.trim();
            const stockQuantity = parseInt(productQuantityInput.value);
            const date = new Date().toLocaleDateString('ar-MA');

            // Save supplier info to localStorage (as it's often re-used)
            localStorage.setItem('supplierName', supplierName);
            localStorage.setItem('supplierAddress', supplierAddress);
            localStorage.setItem('supplierPhone', supplierPhone);

            let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
            let isEditing = productId !== null;
            let productIndex = -1;
            if (isEditing) {
                productIndex = products.findIndex(p => p.id == productId);
                if (productIndex === -1) {
                    showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ÿπÿØŸäŸÑŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.", 'error');
                    resetProductFormAndButtons();
                    return;
                }
            }

            // Check for duplicate product (same name AND supplier phone)
            const duplicateCheck = products.some((p, idx) =>
                (isEditing ? idx !== productIndex : true) &&
                p.name.toLowerCase() === name.toLowerCase() &&
                p.supplierPhone === supplierPhone
            );
            if (duplicateCheck) {
                showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿßÿ≥ŸÖ Ÿàÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ.", 'info');
                return;
            }

            let confirmTitle = isEditing ? "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ" : "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©";
            let confirmMessage = isEditing ? "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü" : "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü";
            const confirmed = await showConfirmModal(confirmTitle, confirmMessage);

            if (!confirmed) {
                showToast(isEditing ? "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨." : "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨.", 'info');
                return;
            }

            if (isEditing) {
                products[productIndex].name = name;
                products[productIndex].purchasePrice = purchasePrice;
                products[productIndex].sellingPrice = sellingPrice;
                products[productIndex].supplierName = supplierName;
                products[productIndex].supplierAddress = supplierAddress;
                products[productIndex].supplierPhone = supplierPhone;
                products[productIndex].stockQuantity = stockQuantity;
                products[productIndex].date = date; // Update date on edit
                showToast("ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠.", 'success');
            } else {
                const newProduct = {
                    id: Date.now(), // Unique ID
                    name,
                    purchasePrice,
                    sellingPrice,
                    commissionPercentage: 0, // Default to 0 for products, invoice sets overall
                    supplierName,
                    supplierAddress,
                    supplierPhone,
                    stockQuantity,
                    date,
                    quantity: 0, // Quantity selected for current invoice
                    minStockQuantity: 0, // Minimum stock for alerts
                    isLocal: true // Flag to indicate it's a locally added product
                };
                products.push(newProduct);
                showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠.", 'success');
            }

            products.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
            localStorage.setItem('savedProducts', JSON.stringify(products));

            displaySavedProducts();
            displayLowStockProducts();
            resetProductFormAndButtons();
        }

        addProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            handleProductFormSubmission(null);
        });
        saveEditProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const idToEdit = event.target.dataset.editingId;
            handleProductFormSubmission(idToEdit);
        });

        function resetProductFormAndButtons() {
            productForm.reset();
            addProductButton.style.display = 'block';
            saveEditProductButton.style.display = 'none';
            delete saveEditProductButton.dataset.editingId;
            resetValidationMessages(productForm);
        }

        async function editProduct(productId) {
            await showSection(mainDashboardView); // Ensure dashboard is visible
            // Activate corresponding button based on screen size
            if (window.innerWidth <= 768) {
                setActiveButton(mobileShowDashboardButton, mobileNavButtons);
            } else {
                setActiveButton(desktopShowDashboardButton, desktopNavButtons);
            }
            mainContainer.classList.remove('full-width');

            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productToEdit = savedProducts.find(p => p.id == productId);

            if (productToEdit) {
                productNameInput.value = productToEdit.name;
                purchasePriceInput.value = productToEdit.purchasePrice;
                sellingPriceInput.value = productToEdit.sellingPrice;
                supplierNameInput.value = productToEdit.supplierName;
                supplierAddressInput.value = productToEdit.supplierAddress;
                supplierPhoneInput.value = productToEdit.supplierPhone;
                productQuantityInput.value = productToEdit.stockQuantity;
                
                addProductButton.style.display = 'none';
                saveEditProductButton.style.display = 'block';
                saveEditProductButton.dataset.editingId = productId;
                resetValidationMessages(productForm);
                // Scroll to the product form container after populating
                window.scrollTo({ top: productFormContainer.offsetTop, behavior: 'smooth' });
            } else {
                showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ÿπÿØŸäŸÑŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.", 'error');
            }
        }

        async function deleteProduct(id) {
            const confirmed = await showConfirmModal("ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ", "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü");
            if (confirmed) {
                let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
                products = products.filter(product => product.id !== id);
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts();
                displayLowStockProducts();
                showToast("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠.", 'success');
            } else {
                showToast("ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨.", 'info');
            }
        }
        searchProductInput.addEventListener('input', displaySavedProducts);

        function resetAllProductQuantities() {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            savedProducts.forEach(product => { product.quantity = 0; });
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        }

        function displaySavedProducts() {
            const searchTerm = searchProductInput.value.toLowerCase();
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            savedProductsList.innerHTML = '';

            const filteredProducts = savedProducts
                .filter(product => product.name.toLowerCase().includes(searchTerm))
                .sort((a, b) => {
                    const stockQuantityA = a.stockQuantity || 0;
                    const stockQuantityB = b.stockQuantity || 0;
                    const minStockQuantityA = a.minStockQuantity || 0;
                    const minStockQuantityB = b.minStockQuantity || 0;
                    const quantityA = a.quantity || 0;
                    const quantityB = b.quantity || 0;
                    // Priority: Insufficient > Out of Stock > Low Stock > Selected for Invoice > Positive Stock > Default
                    const statusA = getProductStatusPriority(quantityA, stockQuantityA, minStockQuantityA);
                    const statusB = getProductStatusPriority(quantityB, stockQuantityB, minStockQuantityB);

                    if (statusA !== statusB) { return statusA - statusB; }
                    if (a.isLocal && !b.isLocal) return -1; // Local products first (if priority is same)
                    if (!a.isLocal && b.isLocal) return 1;
                    return stockQuantityB - stockQuantityA || a.name.localeCompare(b.name); // Then by stock, then alphabetically
                });

            if (filteredProducts.length === 0) {
                savedProductsList.innerHTML = '<p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿπÿ±ÿ∂Ÿáÿß.</p>';
                return;
            }

            filteredProducts.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                if (product.isLocal) { productDiv.classList.add('is-local'); }
                const quantityToDisplay = product.quantity || 0;
                const stockQuantityToDisplay = product.stockQuantity || 0;
                const minStockQuantityToDisplay = product.minStockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay);

                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${product.name}</p>
                        <p><strong>ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p><strong>ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p><strong>ÿßŸÑŸÖŸàÿ±ÿØ:</strong> ${product.supplierName}</p>
                        <p><strong>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ:</strong> ${product.supplierPhone}</p>
                    </div>
                    <p><strong>ÿßŸÑŸÉŸÖŸäÿ© ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustStock(${product.id}, 1)">+</button>
                        <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" onchange="updateStockFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustStock(${product.id}, -1)">-</button>
                    </div>
                    <p><strong>ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustMinQuantity(${product.id}, 1)">+</button>
                        <input type="number" class="min-product-quantity" data-id="${product.id}" value="${minStockQuantityToDisplay}" min="0" onchange="updateMinStockFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustMinQuantity(${product.id}, -1)">-</button>
                    </div>
                    <p><strong>ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustQuantity(${product.id}, 1)">+</button>
                        <input type="number" class="product-quantity" data-id="${product.id}" value="${quantityToDisplay}" min="0" onchange="updateQuantityFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustQuantity(${product.id}, -1)">-</button>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn-delete" onclick="deleteProduct(${product.id})"><span class="icon">üóëÔ∏è</span>ÿ≠ÿ∞ŸÅ</button>
                        <button type="button" class="btn-edit" data-product-id="${product.id}"><span class="icon">‚úèÔ∏è</span>ÿ™ÿπÿØŸäŸÑ</button>
                    </div>
                `;
                productDiv.querySelector('.btn-edit').addEventListener('click', (event) => {
                    event.stopPropagation();
                    const productId = event.target.dataset.productId;
                    editProduct(productId);
                });
                savedProductsList.appendChild(productDiv);
            });
        }

        function displayLowStockProducts() {
            lowStockProductsList.innerHTML = '';
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

            // Filter for low stock (stock < minStock AND stock > 0) or out of stock (stock === 0)
            const lowStockItems = savedProducts.filter(p => (p.stockQuantity || 0) < (p.minStockQuantity || 0) && (p.stockQuantity || 0) > 0);
            const outOfStockItems = savedProducts.filter(p => (p.stockQuantity || 0) === 0);

            if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
                lowStockProductsList.innerHTML = '<p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ ÿ£Ÿà ŸÜŸÅÿØÿ™ ÿ≠ÿßŸÑŸäÿßŸã.</p>';
                return;
            }

            // Combine and sort out of stock first, then low stock, then alphabetically
            const combinedLowStock = [...outOfStockItems, ...lowStockItems];
            combinedLowStock.sort((a, b) => {
                const statusA = (a.stockQuantity || 0) === 0 ? 0 : 1; // 0 for out of stock, 1 for low stock
                const statusB = (b.stockQuantity || 0) === 0 ? 0 : 1;

                if (statusA !== statusB) return statusA - statusB;
                return a.name.localeCompare(b.name);
            });

            combinedLowStock.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product');
                if ((product.stockQuantity || 0) < (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0) {
                    productDiv.classList.add('status-min-positive'); // Low stock (positive quantity)
                } else if ((product.stockQuantity || 0) === 0) {
                    productDiv.classList.add('status-insufficient'); // Out of stock (zero quantity)
                }
                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>ÿßŸÑŸÖŸÜÿ™ÿ¨:</strong> ${product.name}</p>
                        <p><strong>ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑÿ≠ÿßŸÑŸä:</strong> ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) === 0 ? '<span class="icon">‚ùå</span>(ŸÜŸÅÿØ)' : '' }</p>
                        <p><strong>ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ:</strong> ${product.minStockQuantity || 0}</p>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn1" data-product-id="${product.id}"><span class="icon">‚úèÔ∏è</span>ÿ™ÿπÿØŸäŸÑ</button>
                    </div>
                `;
                productDiv.querySelector('.btn1').addEventListener('click', (event) => {
                    event.stopPropagation();
                    const productId = event.target.dataset.productId;
                    editProduct(productId);
                });
                lowStockProductsList.appendChild(productDiv);
            });
        }

        // Helper function to determine product card status priority for sorting and styling
        function getProductStatusPriority(quantitySelected, stockQuantity, minStockQuantity) {
            // Lower number means higher priority (appears first)
            if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1; // Selected but insufficient stock
            if (stockQuantity === 0) return 2; // Out of stock
            if (stockQuantity > 0 && stockQuantity < minStockQuantity) return 3; // Low stock (below min)
            if (quantitySelected > 0) return 4; // Selected for invoice (sufficient stock)
            if (stockQuantity > 0) return 5; // Positive stock
            return 6; // Default / no specific status
        }
        // Update CSS classes for product card based on stock/quantity status
        function updateProductDivClass(productDiv, quantitySelected, stockQuantity, minStockQuantity) {
            // Preserve isLocal and isLocalMatch classes
            const isLocalClass = productDiv.classList.contains('is-local') ? 'is-local' : '';
            const isLocalMatchClass = productDiv.classList.contains('is-local-match') ? 'is-local-match' : '';

            // Reset all status classes
            productDiv.className = 'product';
            if (isLocalClass) { productDiv.classList.add(isLocalClass); }
            if (isLocalMatchClass) { productDiv.classList.add(isLocalMatchClass); }

            // Apply new status classes based on logic
            if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                productDiv.classList.add('status-insufficient');
            } else if (stockQuantity < minStockQuantity && stockQuantity === 0) {
                productDiv.classList.add('status-min-zero');
            } else if (stockQuantity < minStockQuantity) {
                productDiv.classList.add('status-min-positive');
            } else if (quantitySelected > 0) {
                productDiv.classList.add('status-selected-sufficient');
            } else if (stockQuantity > 0) {
                productDiv.classList.add('status-stock-positive');
            } else {
                productDiv.classList.add('status-default');
            }
        }

        function adjustStock(id, amount) {
            const stockInput = document.getElementById(`stock-${id}`);
            let stockQuantity = parseInt(stockInput.value) || 0;
            stockQuantity += amount;
            if (stockQuantity < 0) stockQuantity = 0;
            stockInput.value = stockQuantity;
            updateStockInLocalStorage(id, stockQuantity);
        }
        function updateStockFromInput(id, value) {
            let stockQuantity = parseInt(value) || 0;
            if (stockQuantity < 0) stockQuantity = 0;
            updateStockInLocalStorage(id, stockQuantity);
        }
        function updateStockInLocalStorage(id, newStockQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].stockQuantity = newStockQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.getElementById(`stock-${id}`).closest('.product');
                const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, newStockQuantity, minStockQuantityToDisplay);
                displayLowStockProducts(); // Re-render low stock list
            }
        }

        function adjustQuantity(id, amount) {
            const quantityInput = document.querySelector(`.product-quantity[data-id="${id}"]`);
            let quantity = parseInt(quantityInput.value) || 0;
            quantity += amount;
            if (quantity < 0) quantity = 0;
            quantityInput.value = quantity;
            updateInvoiceQuantityInLocalStorage(id, quantity);
        }
        function updateQuantityFromInput(id, value) {
            let quantity = parseInt(value) || 0;
            if (quantity < 0) quantity = 0;
            updateInvoiceQuantityInLocalStorage(id, quantity);
        }
        function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].quantity = newQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product-quantity[data-id="${id}"]`).closest('.product');
                const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
                updateProductDivClass(productDiv, newQuantity, stockQuantityToDisplay, minStockQuantityToDisplay);
            }
        }

        function adjustMinQuantity(id, amount) {
            const minQuantityInput = document.querySelector(`.min-product-quantity[data-id='${id}']`);
            let minQuantity = parseInt(minQuantityInput.value) || 0;
            minQuantity += amount;
            if (minQuantity < 0) minQuantity = 0;
            minQuantityInput.value = minQuantity;
            updateMinStockInLocalStorage(id, minQuantity);
        }
        function updateMinStockFromInput(id, value) {
            let minQuantity = parseInt(value) || 0;
            if (minQuantity < 0) minQuantity = 0;
            updateMinStockInLocalStorage(id, minQuantity);
        }
        function updateMinStockInLocalStorage(id, newMinQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].minStockQuantity = newMinQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.min-product-quantity[data-id='${id}']`).closest('.product');
                const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, newMinQuantity);
                displayLowStockProducts(); // Re-render low stock list
            }
        }

        /* --- Invoice Generation and Display --- */
        document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
            e.preventDefault();
            // Save TVA to localStorage as well
            localStorage.setItem('tva', tvaInput.value);
            if (checkFields(invoiceForm)) {
                let totalHTBeforeCommission = 0;
                let totalProfit = 0;
                let totalCommission = 0;
                let productNumber = 1;
                const detailsTbody = document.getElementById('displayDetails');
                detailsTbody.innerHTML = ''; // Clear previous invoice details

                let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
                let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);

                if (selectedProductsForInvoice.length === 0) {
                    const confirmed = await showConfirmModal(
                        "ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
                        "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ£Ÿä ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ÿ®ŸÉŸÖŸäÿ© 1 (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÖÿ™ŸàŸÅÿ±ÿßŸã)ÿü"
                    );
                    if (confirmed) {
                        allSavedProducts.forEach(product => {
                            if (product.stockQuantity > 0 && (product.quantity || 0) === 0) {
                                product.quantity = 1; // Set quantity to 1 if not already selected and stock available
                            }
                        });
                        localStorage.setItem('savedProducts', JSON.stringify(allSavedProducts)); // Update localStorage
                        selectedProductsForInvoice = allSavedProducts.filter(p => p.quantity > 0); // Re-filter

                        if (selectedProductsForInvoice.length === 0) {
                            showToast("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿ™ÿ∂ŸÖŸäŸÜŸáÿß ŸÅŸä ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´.", 'info');
                            return;
                        }
                    } else {
                        showToast("ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿÆÿ™ÿßÿ±ÿ©.", 'info');
                        return;
                    }
                }

                const invoiceCommissionRate = parseFloat(invoiceCommissionPercentageInput.value) || 0;
                localStorage.setItem('invoiceCommissionPercentage', invoiceCommissionRate);

                selectedProductsForInvoice.forEach((productData) => {
                    const quantity = productData.quantity;
                    const sellingPrice = parseFloat(productData.sellingPrice);
                    const purchasePrice = parseFloat(productData.purchasePrice);
                    const itemHT = sellingPrice * quantity;
                    totalHTBeforeCommission += itemHT;

                    const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0;
                    const commissionPerUnit = profitPerUnitBeforeCommission * (invoiceCommissionRate / 100);
                    const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;

                    totalProfit += actualProfitPerUnit * quantity;
                    totalCommission += commissionPerUnit * quantity;

                    const productDetails = document.createElement('tr');
                    productDetails.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${productData.name}</td>
                        <td>${sellingPrice.toFixed(2)} DH</td>
                        <td>${quantity}</td>
                        <td>${itemHT.toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetails);
                });

                const finalTotalHT = totalHTBeforeCommission - totalCommission;
                const tvaRate = parseFloat(tvaInput.value) / 100;
                const tva = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);

                document.getElementById('displayCustomerName').textContent = customerNameInput.value;
                document.getElementById('displayInvoiceOwner').textContent = invoiceOwnerInput.value;
                document.getElementById('displayInvoiceDate').textContent = invoiceDateInput.value;
                document.getElementById('displayTotalAmountBeforeCommission').textContent = totalHTBeforeCommission.toFixed(2) + ' DH';
                document.getElementById('displayCommissionDeducted').textContent = totalCommission.toFixed(2) + ' DH';
                document.getElementById('displayTotalAmount').textContent = finalTotalHT.toFixed(2) + ' DH';
                document.getElementById('displayTVA').textContent = tva + ' DH';
                document.getElementById('displayTotalTTC').textContent = totalTTC + ' DH';
                document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceOwnerPhoneInput.value;
                document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceOwnerAddressInput.value;

                await showSection(invoiceDisplay);
                mainContainer.classList.remove('full-width');
                document.getElementById('savePdfButton').style.display = 'block'; // Show stock update button
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Save frequently used invoice details to localStorage
                localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
                localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
                localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);

                // Prepare invoice data for Firebase and local archive
                const productsToSaveToFirebase = [];
                selectedProductsForInvoice.forEach((productData) => {
                    const profitPerUnitBeforeCommissionFirebase = (parseFloat(productData.sellingPrice) - parseFloat(productData.purchasePrice)) || 0;
                    const commissionPerUnitFirebase = profitPerUnitBeforeCommissionFirebase * (invoiceCommissionRate / 100);
                    const actualProfitPerUnitFirebase = profitPerUnitBeforeCommissionFirebase - commissionPerUnitFirebase;

                    productsToSaveToFirebase.push({
                        ...productData,
                        quantityUsed: productData.quantity, // Renamed for clarity in Firebase
                        profitPerUnit: actualProfitPerUnitFirebase.toFixed(2),
                        commissionPerUnit: commissionPerUnitFirebase.toFixed(2)
                    });
                });

                const invoiceDataToSave = {
                    id: Date.now(),
                    date: invoiceDateInput.value,
                    isoDate: new Date().toISOString(), // For consistent sorting
                    customerName: customerNameInput.value,
                    ownerName: invoiceOwnerInput.value,
                    ownerAddress: invoiceOwnerAddressInput.value,
                    ownerPhone: invoiceOwnerPhoneInput.value,
                    products: productsToSaveToFirebase,
                    totalHT: finalTotalHT.toFixed(2),
                    totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                    tva: tva,
                    totalTTC: totalTTC,
                    totalProfit: totalProfit.toFixed(2),
                    totalCommission: totalCommission.toFixed(2)
                };
                if (invoiceCommissionRate > 0) {
                    invoiceDataToSave.invoiceCommissionRate = invoiceCommissionRate;
                }

                // Save to Firebase Realtime Database using the specified path
                // The appId is used as the first level node for namespacing your app's data.
                // Firebase path: /{appId}/alldata/{ownerPhone}/{invoiceId}
                const firebasePath = `${appId}/alldata/${invoiceDataToSave.ownerPhone}`;
                if (database) {
                    const alldataRef = database.ref(firebasePath);
                    alldataRef.push(invoiceDataToSave)
                        .then(() => showToast("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä Firebase ÿ®ŸÜÿ¨ÿßÿ≠.", 'success'))
                        .catch(error => showToast(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ•ŸÑŸâ Firebase: ${error.message}`, 'error'));
                } else {
                    showToast("ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©.", 'error');
                }
                saveInvoiceToLocalStorage(invoiceDataToSave); // Save to local archive

            } else {
                showToast("Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠.", 'error');
            }
        });

        // Event listener for updating stock after invoice confirmation
        document.getElementById('savePdfButton').addEventListener('click', async function() {
            const productsInInvoiceRows = document.querySelectorAll('#invoiceDetails tbody tr');
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            let hasInsufficientStock = false;
            let productsToUpdate = [];

            // First, check for insufficient stock
            productsInInvoiceRows.forEach((row) => {
                const productName = row.cells[1].textContent;
                const quantityUsed = parseInt(row.cells[3].textContent);
                const productData = savedProducts.find(p => p.name === productName);

                if (productData) {
                    const currentStock = parseInt(productData.stockQuantity || 0);
                    if (currentStock < quantityUsed) {
                        hasInsufficientStock = true;
                        showToast(`ÿ™ŸÜÿ®ŸäŸá: ŸÉŸÖŸäÿ© ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨ "${productName}". ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠: ${currentStock}`, 'error');
                        // Do not return here, allow other warnings to show
                    }
                    productsToUpdate.push({ productName, quantityUsed }); // Add to list for update if all checks pass
                }
            });

            if (hasInsufficientStock) {
                showToast("Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ∫Ÿäÿ± ÿßŸÑŸÉÿßŸÅŸä ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´.", 'error');
                return; // Stop the process if any product has insufficient stock
            }

            const confirmed = await showConfirmModal("ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ", "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©ÿü");
            if (confirmed) {
                productsToUpdate.forEach(({ productName, quantityUsed }) => {
                    const productDataIndex = savedProducts.findIndex(p => p.name === productName);
                    if (productDataIndex !== -1) {
                        savedProducts[productDataIndex].stockQuantity -= quantityUsed;
                        // Ensure stock doesn't go below zero
                        if (savedProducts[productDataIndex].stockQuantity < 0) {
                            savedProducts[productDataIndex].stockQuantity = 0;
                        }
                    }
                });
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                showToast('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ®ŸÜÿ¨ÿßÿ≠.', 'success');
                resetAllProductQuantities(); // Reset quantities selected for invoice

                // Go back to dashboard view after update
                if (window.innerWidth <= 768) {
                    mobileShowDashboardButton.click();
                } else {
                    desktopShowDashboardButton.click();
                }
            } else {
                showToast("ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ.", 'info');
            }
        });

        // Print button functionality
        let originalViewportContent = ''; // To store original viewport meta content
        document.getElementById('printButton').addEventListener('click', function() {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                originalViewportContent = viewportMeta.getAttribute('content');
                // Temporarily set viewport for better print layout (e.g., desktop-like width)
                viewportMeta.setAttribute('content', 'width=1024');
            }
            // Hide buttons before printing
            this.style.display = 'none';
            document.getElementById('savePdfButton').style.display = 'none';
            // Trigger browser print dialog
            window.print();
            // Restore buttons and original viewport after a short delay
            setTimeout(() => {
                document.getElementById('savePdfButton').style.display = 'block';
                this.style.display = 'block';
                if (viewportMeta && originalViewportContent) {
                    viewportMeta.setAttribute('content', originalViewportContent);
                }
            }, 500); // Small delay to ensure print dialog closes
        });

        /* --- Firebase Data Display and Statistics (Combined) --- */
        function populateCommonDropdown() {
            if (!database) {
                showToast("ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ© ŸÑŸÖŸÑÿ° ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ.", 'info');
                return;
            }
            // Reference to the main data node under the app ID
            const alldataRef = database.ref(`${appId}/alldata`);
            alldataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                commonPhoneDropdown.innerHTML = ''; // Clear existing options
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ';
                commonPhoneDropdown.appendChild(allOption);
                const phoneNumbers = new Set();
                if (data) {
                    for (const phoneKey in data) {
                        if (data.hasOwnProperty(phoneKey)) {
                            phoneNumbers.add(phoneKey); // Each top-level key is a phone number
                        }
                    }
                }
                const sortedPhoneNumbers = Array.from(phoneNumbers).sort(); // Sort phone numbers
                sortedPhoneNumbers.forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    commonPhoneDropdown.appendChild(option);
                });
            }, (error) => {
                showToast(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ ŸÖŸÜ Firebase: ${error.message}`, 'error');
            });
        }
        async function fetchAndDisplayCombinedFirebaseData() {
            if (!database) {
                showToast("ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ© ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.", 'info');
                return;
            }
            const alldataRef = database.ref(`${appId}/alldata`); // Corrected path
            let snapshot;
            try {
                snapshot = await alldataRef.once('value');
            } catch (error) {
                showToast(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ Firebase: ${error.message}`, 'error');
                return;
            }

            const data = snapshot.val();
            allFirebaseProducts = [];
            allFirebaseInvoicesData = [];

            if (data) {
                // Iterate through each phone number (top-level key)
                for (const phoneKey in data) {
                    if (data.hasOwnProperty(phoneKey)) {
                        const phoneData = data[phoneKey]; // This contains multiple invoices for one phone number
                        // Iterate through each invoice under this phone number
                        for (const invoiceKey in phoneData) {
                            if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                const invoiceDetails = phoneData[invoiceKey];
                                allFirebaseInvoicesData.push({ id: invoiceKey, firebasePhoneKey: phoneKey, ...invoiceDetails }); // Store full invoice for stats
                                // Extract individual products from the invoice
                                invoiceDetails.products.forEach((product, index) => {
                                    allFirebaseProducts.push({
                                        id: `${invoiceKey}-${index}`, // Unique ID for displaying in grid (invoiceKey + product index)
                                        ...product,
                                        invoiceDate: invoiceDetails.date,
                                        customerName: invoiceDetails.customerName,
                                        ownerName: invoiceDetails.ownerName, // Original owner for the invoice
                                        ownerAddress: invoiceDetails.ownerAddress,
                                        ownerPhone: invoiceDetails.ownerPhone,
                                        totalHT: invoiceDetails.totalHT,
                                        totalTTC: invoiceDetails.totalTTC,
                                        totalProfit: invoiceDetails.totalProfit,
                                        totalCommission: invoiceDetails.totalCommission,
                                        firebaseInvoiceKey: invoiceKey // Keep reference to parent invoice key
                                    });
                                });
                            }
                        }
                    }
                }
            }
            applyCombinedFilters(); // Apply filters once all data is loaded
        }
        function findLocalProductMatch(firebaseProduct) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            return savedProducts.find(localProduct =>
                localProduct.name.toLowerCase() === firebaseProduct.name.toLowerCase() &&
                (localProduct.supplierPhone === firebaseProduct.ownerPhone || localProduct.supplierPhone === firebaseProduct.supplierPhone)
            );
        }
        function applyCombinedFilters() {
            const searchTerm = commonSearchInput.value.toLowerCase();
            const selectedPhoneNumber = commonPhoneDropdown.value;
            const selectedStatsFilter = commonFilterSelect.value;

            // Filter products for the Firebase Product List section
            const filteredProducts = allFirebaseProducts.filter(product => {
                const matchesSearchInput = searchTerm ?
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.customerName && product.customerName.toLowerCase().includes(searchTerm)) ||
                    (product.ownerName && product.ownerName.toLowerCase().includes(searchTerm)) ||
                    (product.supplierName && product.supplierName.toLowerCase().includes(searchTerm)) ||
                    (product.ownerPhone && product.ownerPhone.includes(searchTerm))
                    : true;
                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || product.ownerPhone === selectedPhoneNumber);
                return matchesSearchInput && matchesPhoneNumber;
            });
            firebaseProductListCountSpan.textContent = filteredProducts.length;
            // Sort by date (newest first)
            filteredProducts.sort((a, b) => {
                const dateA = new Date(a.isoDate || a.invoiceDate); // Use isoDate if available, fallback to invoiceDate
                const dateB = new Date(b.isoDate || b.invoiceDate);
                return dateB - dateA; // Descending order (newest first)
            });
            displayFirebaseProducts(filteredProducts);

            // Filter invoices for statistics section
            let filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                const matchesSearchInput = searchTerm ?
                    (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm))) ||
                    (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm))
                    : true;
                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);
                return matchesSearchInput && matchesPhoneNumber;
            });
            displayStatistics(filteredInvoices, selectedStatsFilter);
        }
        function displayFirebaseProducts(products) {
            firebaseProductListContainer.innerHTML = '';
            if (products.length === 0) {
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿπÿ±ÿ∂Ÿáÿß.</p>';
                return;
            }
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product');
                const matchingLocalProduct = findLocalProductMatch(product);
                if (matchingLocalProduct) { productDiv.classList.add('is-local-match'); }
                const purchasePrice = parseFloat(product.purchasePrice || 0);
                const sellingPrice = parseFloat(product.sellingPrice || 0);
                const quantityUsed = parseInt(product.quantityUsed || 0);
                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${product.name}</p>
                        <p><strong>ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°:</strong> ${purchasePrice.toFixed(2)} DH</p>
                        <p><strong>ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ:</strong> ${sellingPrice.toFixed(2)} DH</p>
                        <p><strong>ÿßŸÑŸÖŸàÿ±ÿØ:</strong> ${product.supplierName || product.ownerName || 'N/A'}</p>
                        <p><strong>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ:</strong> ${product.ownerPhone}</p>
                        <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</strong> ${product.invoiceDate || 'N/A'}</p>
                        <p><strong>ÿßŸÑÿπŸÖŸäŸÑ:</strong> ${product.customerName || 'N/A'}</p>
                        <p><strong>ŸÖÿßŸÑŸÉ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</strong> ${product.ownerName || 'N/A'}</p>
                    </div>
                    <p><strong>ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ®ÿßÿπÿ© (ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©):</strong></p>
                    <div class="quantity-controls">
                        <input type="number" value="${quantityUsed}" min="0" readonly>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn-edit btn-add-to-local" data-firebase-product-id="${product.id}"><span class="icon">üìù</span>ÿ™ÿπÿØŸäŸÑ (ŸÖÿ≠ŸÑŸä)</button>
                    </div>
                `;
                productDiv.querySelector('.btn-add-to-local').addEventListener('click', (event) => {
                    event.stopPropagation();
                    const firebaseProductId = event.target.dataset.firebaseProductId;
                    addOrEditProductFromFirebase(firebaseProductId);
                });
                firebaseProductListContainer.appendChild(productDiv);
            });
        }
        async function addOrEditProductFromFirebase(firebaseProductId) {
            const firebaseProduct = allFirebaseProducts.find(p => p.id == firebaseProductId);
            if (firebaseProduct) {
                const existingLocalProduct = findLocalProductMatch(firebaseProduct);
                if (existingLocalProduct) {
                    showToast(`ÿßŸÑŸÖŸÜÿ™ÿ¨ "${firebaseProduct.name}" ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÖÿ≠ŸÑŸäÿßŸã. Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá ŸÑŸÑÿ™ÿπÿØŸäŸÑ.`, 'info');
                    await editProduct(existingLocalProduct.id); // Go to dashboard and pre-fill form
                } else {
                    const confirmed = await showConfirmModal(
                        "ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ŸÑŸä",
                        `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© "${firebaseProduct.name}" ŸÉŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ŸÑŸä ÿ¨ÿØŸäÿØÿü`
                    );
                    if (confirmed) {
                        let savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
                        const newLocalProductId = Date.now();
                        const newLocalProduct = {
                            id: newLocalProductId,
                            name: firebaseProduct.name,
                            purchasePrice: parseFloat(firebaseProduct.purchasePrice || 0),
                            sellingPrice: parseFloat(firebaseProduct.sellingPrice || 0),
                            supplierName: firebaseProduct.supplierName || firebaseProduct.ownerName || 'N/A', // Use ownerName if supplierName is missing
                            supplierAddress: firebaseProduct.ownerAddress || 'N/A',
                            supplierPhone: firebaseProduct.ownerPhone, // Use ownerPhone as supplier phone for firebase imported
                            stockQuantity: 0, // Default to 0 for new local product from Firebase
                            date: new Date().toLocaleDateString('ar-MA'),
                            quantity: 0,
                            minStockQuantity: 0,
                            isLocal: true
                        };
                        savedProducts.push(newLocalProduct);
                        savedProducts.sort((a, b) => a.name.localeCompare(b.name));
                        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                        showToast(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© "${newLocalProduct.name}" ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠.`, 'success');
                        await editProduct(newLocalProductId); // Go to dashboard and pre-fill form
                        displaySavedProducts(); // Refresh saved products list
                        displayLowStockProducts(); // Refresh low stock list
                    } else {
                        showToast(`ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© "${firebaseProduct.name}" ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©.`, 'info');
                    }
                }
            } else {
                showToast("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ÿπÿØŸäŸÑŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿßŸÑÿ≠ÿßŸÑŸäÿ©.", 'error');
            }
        }
        commonPhoneDropdown.addEventListener('change', applyCombinedFilters);
        commonSearchInput.addEventListener('input', applyCombinedFilters);
        commonFilterSelect.addEventListener('change', applyCombinedFilters);

        /* --- Statistics and Tracking --- */
        function displayStatistics(invoices, filterType) {
            let totalSalesHT = 0;
            let totalTVA = 0;
            let totalSalesTTC = 0;
            let totalOverallProfit = 0;
            let totalOverallCommission = 0;
            let totalPurchaseCostAllProducts = 0;
            let totalSellingPriceAllProducts = 0;

            const productSales = {}; // { productName: { quantitySold: X, totalRevenue: Y } }
            const customerActivity = {}; // { customerName: { invoiceCount: X, totalProfit: Y, totalTTC: Z } }
            const invoiceOwnerActivity = {}; // { ownerName: { invoiceCount: X, totalProfit: Y, totalTTC: Z } }
            const supplierActivity = {}; // { supplierName: { totalPurchaseCost: X, productsCount: Y } }

            invoices.forEach(invoice => {
                totalSalesHT += parseFloat(invoice.totalHT || 0);
                totalTVA += parseFloat(invoice.tva || 0);
                totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                if (invoice.products) {
                    invoice.products.forEach(product => {
                        const productName = product.name;
                        const quantityUsed = parseInt(product.quantityUsed || 0);
                        const purchasePrice = parseFloat(product.purchasePrice || 0);
                        const sellingPrice = parseFloat(product.sellingPrice || 0);
                        const supplierName = product.supplierName || invoice.ownerName || 'N/A'; // Use invoice owner as supplier if product supplier missing

                        totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                        totalSellingPriceAllProducts += sellingPrice * quantityUsed;

                        if (!productSales[productName]) {
                            productSales[productName] = { quantitySold: 0, totalRevenue: 0 };
                        }
                        productSales[productName].quantitySold += quantityUsed;
                        productSales[productName].totalRevenue += sellingPrice * quantityUsed;

                        if (!supplierActivity[supplierName]) {
                            supplierActivity[supplierName] = { totalPurchaseCost: 0, productsCount: 0 };
                        }
                        supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                        supplierActivity[supplierName].productsCount += quantityUsed;
                    });
                }
                const customer = invoice.customerName || 'N/A';
                const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                const owner = invoice.ownerName || 'N/A';

                if (!customerActivity[customer]) {
                    customerActivity[customer] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                customerActivity[customer].invoiceCount += 1;
                customerActivity[customer].totalProfit += invoiceProfit;
                customerActivity[customer].totalTTC += invoiceTTC;

                if (!invoiceOwnerActivity[owner]) {
                    invoiceOwnerActivity[owner] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                invoiceOwnerActivity[owner].invoiceCount += 1;
                invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
            });

            // Update main stat cards
            document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
            document.getElementById('totalSellingPrice').textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
            document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`;
            document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`;
            document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`;
            document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
            document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;

            // Handle dynamic lists based on filterType
            dynamicStatsListContainer.innerHTML = '';
            mostSellingTotalPriceDisplay.classList.add('hidden'); // Hide total price initially

            const renderList = (listId, data, prop, unit, altProp, altUnit, isPurchase = false) => {
                const listWrapper = document.createElement('div'); // This div will be a grid item
                let title;
                if (listId === 'topSellingProductsList') title = 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÖÿ®ŸäÿπÿßŸã';
                else if (listId === 'topCustomersList') title = 'ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã';
                else if (listId === 'topInvoiceOwnersList') title = 'ÿ£ÿµÿ≠ÿßÿ® ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã';
                else if (listId === 'topSuppliersList') title = 'ÿßŸÑŸÖŸàÿ±ÿØŸàŸÜ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã';

                listWrapper.innerHTML = `<h3>${title}</h3><ul id="${listId}" class="scrollable-list-in-card"></ul>`;
                dynamicStatsListContainer.appendChild(listWrapper);

                const listEl = document.getElementById(listId);
                if (data.length > 0) {
                    data.forEach(([name, stats]) => {
                        const li = document.createElement('li');
                        const value1 = isPurchase ? stats[prop].toFixed(2) : stats[prop];
                        const value2 = isPurchase ? stats[altProp] : stats[altProp].toFixed(2);

                        li.innerHTML = `
                            <span><strong>${name}</strong></span>
                            <span>${isPurchase ? `ÿ¥ÿ±ÿßÿ°: ${value1} ${unit} (${value2} ${altUnit})` : `${value1} ${unit} - ${value2} ${altUnit}`}</span>
                        `;
                        li.dataset.searchTerm = name;
                        li.addEventListener('click', () => {
                            commonSearchInput.value = li.dataset.searchTerm;
                            applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                } else {
                    listEl.innerHTML = '<li>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</li>';
                }
            };

            if (filterType === 'none') {
                // Display all lists in a 2x2 grid (or stacked on mobile)
                renderList('topSellingProductsList', Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 5), 'quantitySold', 'Ÿàÿ≠ÿØÿßÿ™', 'totalRevenue', 'DH');
                renderList('topCustomersList', Object.entries(customerActivity).sort(([, a], [, b]) => b.totalTTC - a.totalTTC).slice(0, 5), 'invoiceCount', 'ŸÅŸàÿßÿ™Ÿäÿ±', 'totalTTC', 'DH');
                renderList('topInvoiceOwnersList', Object.entries(invoiceOwnerActivity).sort(([, a], [, b]) => b.totalProfit - a.totalProfit).slice(0, 5), 'invoiceCount', 'ŸÅŸàÿßÿ™Ÿäÿ±', 'totalProfit', 'DH ÿ±ÿ®ÿ≠');
                renderList('topSuppliersList', Object.entries(supplierActivity).sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost).slice(0, 5), 'totalPurchaseCost', 'DH', 'productsCount', 'ŸÖŸÜÿ™ÿ¨', true);
            } else {
                // Display only the selected list
                const config = listsConfig[filterType];
                if (config) {
                    const listDiv = document.createElement('div');
                    listDiv.classList.add('stats-grid-item');
                    listDiv.style.flex = '1 1 100%'; // Make it take full width when alone
                    listDiv.innerHTML = `<h3>${config.title}</h3><ul class="scrollable-list-in-card"></ul>`;
                    dynamicStatsListContainer.appendChild(listDiv);
                    renderList(listDiv.querySelector('ul').id, config.data, config.prop1, config.unit1, config.prop2, config.unit2, config.isPurchase);

                    // Show total price for most selling products only if selected
                    if (filterType === 'topSellingProducts') {
                        let currentMostSellingTotalPrice = 0;
                        config.data.forEach(item => {
                            currentMostSellingTotalPrice += item[1].totalRevenue;
                        });
                        mostSellingTotalPriceValue.textContent = currentMostSellingTotalPrice.toFixed(2) + ' DH';
                        mostSellingTotalPriceDisplay.classList.remove('hidden');
                    }
                }
            }
        }

        /* --- Local Invoice Archive Functions --- */
        function saveInvoiceToLocalStorage(invoiceData) {
            let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
            localInvoices.push(invoiceData);
            localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
            showToast("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ≠ŸÑŸäÿßŸã.", 'success');
            displayLocalInvoices();
        }
        function displayLocalInvoices() {
            allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
            localInvoicesList.innerHTML = '';
            const searchTerm = searchLocalInvoiceInput.value.toLowerCase();

            const filteredInvoices = allLocalInvoices.filter(invoice => {
                const matchesSearch = searchTerm ?
                    (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.date && invoice.date.toLowerCase().includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm)))
                    : true;
                return matchesSearch;
            });

            if (filteredInvoices.length === 0) {
                localInvoicesList.innerHTML = '<p class="empty-list-message">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿ≠ŸÑŸäÿßŸã.</p>';
                return;
            }

            filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date)); // Sort by date (newest first)

            filteredInvoices.forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.classList.add('local-invoice-item');
                invoiceDiv.innerHTML = `
                    <div class="invoice-summary-details">
                        <p><strong>ÿßŸÑÿπŸÖŸäŸÑ:</strong> ${invoice.customerName || 'N/A'}</p>
                        <p><strong>ŸÖÿßŸÑŸÉ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</strong> ${invoice.ownerName || 'N/A'}</p>
                        <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</strong> ${invoice.date || 'N/A'}</p>
                        <p><strong>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                        <p><strong>ÿßŸÑÿ±ÿ®ÿ≠:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                    </div>
                    <div class="invoice-actions">
                        <button type="button" class="btn1" onclick="viewLocalInvoiceDetails(${invoice.id})"><span class="icon">üîç</span>ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</button>
                        <button type="button" class="btn-delete" onclick="deleteLocalInvoice(${invoice.id})"><span class="icon">üóëÔ∏è</span>ÿ≠ÿ∞ŸÅ</button>
                    </div>
                `;
                localInvoicesList.appendChild(invoiceDiv);
            });
        }
        async function viewLocalInvoiceDetails(invoiceId) {
            const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);
            if (invoiceToView) {
                await showSection(invoiceDisplay);
                mainContainer.classList.remove('full-width');
                document.getElementById('savePdfButton').style.display = 'none'; // Hide stock update button when viewing archived

                // Populate invoice details
                document.getElementById('displayCustomerName').textContent = invoiceToView.customerName;
                document.getElementById('displayInvoiceOwner').textContent = invoiceToView.ownerName;
                document.getElementById('displayInvoiceDate').textContent = invoiceToView.date;
                document.getElementById('displayInvoiceDate').setAttribute('datetime', invoiceToView.isoDate || invoiceToView.date);
                document.getElementById('displayTotalAmountBeforeCommission').textContent = parseFloat(invoiceToView.totalHTBeforeCommission || 0).toFixed(2) + ' DH';
                document.getElementById('displayCommissionDeducted').textContent = parseFloat(invoiceToView.totalCommission || 0).toFixed(2) + ' DH';
                document.getElementById('displayTotalAmount').textContent = parseFloat(invoiceToView.totalHT || 0).toFixed(2) + ' DH';
                document.getElementById('displayTVA').textContent = parseFloat(invoiceToView.tva || 0).toFixed(2) + ' DH';
                document.getElementById('displayTotalTTC').textContent = parseFloat(invoiceToView.totalTTC || 0).toFixed(2) + ' DH';
                document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceToView.ownerPhone;
                document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceToView.ownerAddress;

                const detailsTbody = document.getElementById('displayDetails');
                detailsTbody.innerHTML = ''; // Clear previous details
                let productNumber = 1;
                invoiceToView.products.forEach(productData => {
                    const productDetails = document.createElement('tr');
                    productDetails.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${productData.name}</td>
                        <td>${parseFloat(productData.sellingPrice).toFixed(2)} DH</td>
                        <td>${productData.quantityUsed}</td>
                        <td>${(parseFloat(productData.sellingPrice) * productData.quantityUsed).toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetails);
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showToast("ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä.", 'error');
            }
        }
        async function deleteLocalInvoice(invoiceId) {
            const confirmed = await showConfirmModal("ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ", "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÖÿ≠ŸÑŸäÿü");
            if (confirmed) {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä.", 'success');
                displayLocalInvoices();
            } else {
                showToast("ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©.", 'info');
            }
        }
        searchLocalInvoiceInput.addEventListener('input', displayLocalInvoices);

        // Ensure functions are globally accessible if used directly in HTML onclick attributes
        window.adjustStock = adjustStock;
        window.updateStockFromInput = updateStockFromInput;
        window.adjustQuantity = adjustQuantity;
        window.updateQuantityFromInput = updateQuantityFromInput;
        window.adjustMinQuantity = adjustMinQuantity;
        window.updateMinStockFromInput = updateMinStockFromInput;
        window.deleteProduct = deleteProduct;
        window.viewLocalInvoiceDetails = viewLocalInvoiceDetails;
        window.deleteLocalInvoice = deleteLocalInvoice;
    </script>
</body>
</html>
