<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون - واتساب ستايل</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Using Cairo font for Arabic, similar to WhatsApp's clean feel -->

    <style>
        /* WhatsApp inspired color palette */
        :root {
            --whatsapp-green-dark: #075E54; /* Dark header/accent green */
            --whatsapp-green-light: #128C7E; /* Primary action green */
            --whatsapp-bubble-received: #DCF8C6; /* Light green for received messages/cards */
            --whatsapp-bubble-sent: #EBF7EB; /* Lighter green for sent messages/form background */
            --whatsapp-bg-main: #ECE5DD; /* Main chat background color */
            --whatsapp-text-dark: #1F2C34; /* Dark text color */
            --whatsapp-text-light: #FFFFFF; /* Light text for dark backgrounds */
            --whatsapp-border-light: #B4B4B4; /* Light border color */
            --whatsapp-success-green: #25D366; /* Success actions/icons */
            --whatsapp-error-red: #D82E3E; /* Error red */
            --whatsapp-warning-orange: #FFC107; /* Warning orange */
            --whatsapp-active-button: #054C43; /* Darker green for active nav button */

            --border-radius-sm: 8px; /* Small border radius for inputs */
            --border-radius-md: 12px; /* Medium border radius for cards */
            --border-radius-lg: 20px; /* Large border radius for primary buttons/bubbles */
            --border-radius-pill: 999px; /* Pill shape for some buttons */
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
            --box-shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --box-shadow-medium: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Added this rule to ensure hidden attribute works reliably */
        [hidden] {
            display: none !important;
        }

        /* Base styles and reset */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            /* Changed font to Cairo for a more Arabic/WhatsApp feel */
            font-family: 'Cairo', sans-serif;
            direction: rtl; /* Set direction to Right-To-Left for Arabic */
            background-color: var(--whatsapp-bg-main); /* WhatsApp chat background */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--whatsapp-text-dark);
            font-size: 16px;
        }

        body {
            padding: var(--spacing-md); /* Default padding for larger screens */
        }

        /* Main controls for navigation (top bar) */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--whatsapp-green-dark); /* Dark green top bar */
            border-radius: var(--border-radius-md); /* Slightly rounded corners for the bar */
            box-shadow: var(--box-shadow-medium);
            flex-shrink: 0;
        }

        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--whatsapp-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill); /* Pill-shaped buttons */
            text-align: center;
            background-color: var(--whatsapp-green-light); /* Lighter green for active buttons */
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            box-shadow: var(--box-shadow-light);
            outline: none;
        }

        .main-controls .btn-panel:hover {
            background-color: #0E7166; /* Slightly darker on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: var(--box-shadow-light);
        }
        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--whatsapp-text-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(7, 94, 84, 0.4);
        }

        /* Active button state */
        .main-controls .btn-panel.active {
            background-color: var(--whatsapp-active-button); /* Even darker green for active */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); /* Inset shadow for active */
            transform: translateY(0); /* No lift for active */
        }
        .main-controls .btn-panel.active:hover {
            background-color: var(--whatsapp-active-button); /* Maintain active color on hover */
            transform: translateY(0);
        }


        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px; /* Default max width for dashboard view */
            margin: 0 auto;
            transition: max-width 0.3s ease, padding 0.3s ease; /* Smooth transition for width change */
        }
        /* Specific max-width for the full-width Firebase view */
        .container.full-width {
            max-width: 100%; /* Take full available width of its parent */
            margin: 0; /* Remove auto margins to stretch fully */
            padding: 0; /* Remove padding from container, sections will add it back */
            height: 100%; /* Make container take full height */
            box-sizing: border-box;
        }
        /* Ensure direct children of full-width container expand and have padding */
        .container.full-width > section {
             padding-left: var(--spacing-md); /* Add back the body padding on the sections */
             padding-right: var(--spacing-md);
             box-sizing: border-box;
             flex-grow: 1; /* Allow sections to grow vertically if needed */
        }


        /* Common container styles - like chat bubbles/cards */
        .product-container,
        .client-container,
        .invoice,
        .saved-products,
        .firebase-stats-combined-container,
        .local-archive-container-embedded,
        .low-stock-section-standalone { /* Added new class */
            border: 1px solid var(--whatsapp-border-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md); /* More rounded cards */
            background-color: var(--whatsapp-bubble-sent); /* Lighter background for form/section cards */
            box-shadow: var(--box-shadow-light);
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
            /* Removed initial opacity/transform from here for immediate display. */
            /* Animation for show/hide now handled by .fade-in-section classes. */
        }

        /* Class to apply for animation when hiding/showing. */
        .fade-in-section { /* New class to manage animations */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .fade-in-section.visible { /* When this class is added, it transitions to visible */
            opacity: 1;
            transform: translateY(0);
        }

        /* Dashboard View Specific Styles */
        .dashboard-view {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: flex-start;
            width: 100%;
        }

        .dashboard-view h1 {
            width: 100%;
            text-align: center;
            color: var(--whatsapp-green-dark); /* Dark green for main titles */
            margin-bottom: var(--spacing-xl);
            font-size: 2.2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-green-light); /* Green border bottom */
        }

        .dashboard-view h2 {
            width: 100%;
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.8em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-green-light);
        }

        .dashboard-view h3 {
            width: 100%;
            text-align: center;
            color: var(--whatsapp-green-light); /* Lighter green for sub-sub titles */
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.5em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-bubble-received); /* Very light green border */
        }


        /* Adjust individual container widths within the dashboard view */
        .dashboard-view > .product-container,
        .dashboard-view > .client-container {
            flex: 1 1 48%; /* Allows two columns on wider screens */
            min-width: 350px; /* Minimum width for readability */
        }

        /* NEW: Wrapper for Local Invoice Archive and Low Stock for side-by-side display */
        .dashboard-archive-stock-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            width: 100%; /* Take full width of parent */
            margin-top: var(--spacing-md);
        }
        /* Make children of the wrapper take roughly half width */
        .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
        .dashboard-archive-stock-wrapper > .low-stock-section-standalone {
            flex: 1 1 48%; /* Each takes roughly half width, allowing gap */
            min-width: 300px; /* Ensure they don't get too small before stacking */
        }

        /* Saved Products list below the forms */
        .dashboard-view > .saved-products {
            flex: 1 1 100%; /* Take full width below forms and combined section */
            margin-top: var(--spacing-md);
        }

        /* Firebase/Stats Combined Container Layout */
        .firebase-stats-combined-container {
            display: flex;
            flex-direction: column; /* Stack children vertically */
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            background-color: var(--whatsapp-bubble-sent);
            box-shadow: var(--box-shadow-light);
            margin-bottom: 0; /* Managed by parent gap */
            height: 100%; /* Take full height of its parent (.container.full-width) */
            box-sizing: border-box;
        }
        .firebase-stats-combined-container h1 {
            width: 100%;
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-bottom: var(--spacing-xl);
            font-size: 2.2em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-green-light);
        }
        .firebase-stats-combined-container h2 {
            width: 100%;
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-bottom: var(--spacing-md);
            font-size: 1.8em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-green-light);
            margin-top: 0;
        }

        .firebase-content-wrapper {
            display: flex;
            flex-direction: column; /* Stacks children vertically */
            gap: var(--spacing-md);
            width: 100%;
            flex-grow: 1; /* Allow content wrapper to take available height */
        }

        .firebase-content-wrapper > .statistics-section {
            min-width: unset;
            max-height: none;
            overflow-y: visible; /* Content can scroll if larger than available space */
            background-color: var(--whatsapp-bubble-received); /* Lighter background for stats section itself */
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0; /* Don't shrink to accommodate Firebase list */
        }
        .firebase-content-wrapper > .firebase-product-list-wrapper {
            min-width: unset;
            max-height: none;
            overflow-y: visible; /* Content can scroll */
            background-color: var(--whatsapp-bubble-sent); /* Slightly lighter background for list wrapper */
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            flex-grow: 1; /* Allow the product list to take remaining height */
            display: flex; /* Make it a flex container for its own filters and list */
            flex-direction: column;
        }
        /* Style for Firebase product list filters (now inside firebase-product-list-wrapper) */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            margin-bottom: var(--spacing-md); /* Space below filters */
            background-color: transparent; /* Make it transparent to blend with parent */
            box-shadow: none; /* No extra shadow */
            padding-top: 0; /* Align with parent's internal padding */
            padding-left: 0;
            padding-right: 0;
            border-radius: 0; /* No border radius here */
        }


        /* Scrollable areas (general styles) */
        .saved-products3 {
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 350px); /* Adjusted for combined forms in dashboard */
            padding-right: 10px;
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Adjusted to ensure columns */
            gap: var(--spacing-md);
            align-content: start;
        }

        /* For Local Invoices Archive List - explicitly scrollable, showing max 2 items */
        .local-invoices-list {
            flex-grow: 1; /* Allows it to fill available height in flex parent */
            overflow-y: auto; /* Enable vertical scrolling */
            max-height: 280px; /* Explicitly limit to roughly 2 items, assuming ~140px height per item */
            padding-right: var(--spacing-sm); /* More padding for scrollbar */
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid; /* Keep grid layout for items within the scrollable area */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Encourage 2-3 columns */
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--whatsapp-border-light); /* Added border for visual containment */
            border-radius: var(--border-radius-md);
            background-color: var(--whatsapp-bubble-received); /* Match card background */
            padding: var(--spacing-md); /* Add padding inside the scrollable area */
            box-sizing: border-box; /* Include padding in width/height */
        }

        /* For Firebase Product List Container - takes full height, allows overall page scroll */
        #productListContainerdata {
            flex-grow: 1; /* Allow it to fill remaining vertical space in its parent */
            overflow-y: visible; /* Content can push parent scrollbar if it exceeds viewport */
            max-height: none; /* Removed fixed max-height, letting content define height */
            padding-right: var(--spacing-sm); /* Keep scrollbar padding in case of overall page scroll */
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjust for multi-column display */
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--whatsapp-border-light);
            border-radius: var(--border-radius-md);
            background-color: var(--whatsapp-bubble-received);
            padding: var(--spacing-md);
            box-sizing: border-box;
        }


        /* Low stock container styling within product list */
        .low-stock-section-standalone { /* New class for standalone section */
            flex-grow: 1; /* Allows it to fill available height in flex parent */
            overflow-y: auto; /* Enable vertical scrolling */
            margin-top: 0; /* Margin managed by parent .dashboard-archive-stock-wrapper */
            margin-bottom: 0;
            padding-right: 0;
        }
        /* Specific styling for the product list grid *inside* the low stock section */
        .low-stock-section-standalone .product-list-grid { /* Updated class selector */
            max-height: none; /* Removed fixed max-height, let flex-grow manage */
            flex-grow: 1; /* Allow it to fill available height */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: var(--spacing-xs); /* To make scrollbar visible */
            border: 1px solid var(--whatsapp-border-light);
            border-radius: var(--border-radius-md);
            background-color: var(--whatsapp-text-light); /* Use card background for the scrollable list container */
            padding: var(--spacing-md); /* Add padding inside the scrollable area */
            box-sizing: border-box;
            display: grid; /* Keep grid layout */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Keep grid columns */
            gap: var(--spacing-sm); /* Keep grid gap */
        }

        .low-stock-section-standalone h3 { /* Updated class selector */
            color: var(--whatsapp-error-red);
            margin-top: 0;
            margin-bottom: var(--spacing-sm); /* Adjusted margin as the list now has its own padding/border */
            font-size: 1.4em;
            text-align: center;
            border-bottom: 1px dashed var(--whatsapp-error-red);
            padding-bottom: var(--spacing-sm);
        }


        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: center;
        }

        p {
            margin: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--whatsapp-text-dark);
            font-size: 0.95em;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--whatsapp-error-red);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--whatsapp-text-light); /* White background for inputs */
            border-radius: var(--border-radius-sm); /* Small rounded corners for inputs */
            border: 1px solid var(--whatsapp-border-light);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--whatsapp-text-dark);
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--whatsapp-green-light); /* Green accent on focus */
            box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.3);
        }

        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--whatsapp-error-red);
        }
        .form-group .validation-error-message {
            color: var(--whatsapp-error-red);
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message {
            display: block;
        }


        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* General button styles */
        .btn,
        .btn1,
        .btn2,
        .btn-delete,
        .btn-edit,
        .btn-add-to-local { /* Added new class for Firebase product buttons */
            display: block;
            flex: 1;
            height: 50px; /* Increased height from 45px */
            padding: 1rem 0; /* Adjusted padding to match new height */
            color: var(--whatsapp-text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill); /* Pill-shaped buttons */
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: var(--box-shadow-light);
            font-size: 0.95em;
            outline: none;
        }
        .btn:focus-visible, .btn1:focus-visible, .btn2:focus-visible, .btn-delete:focus-visible, .btn-edit:focus-visible, .btn-add-to-local:focus-visible {
            outline: 2px solid var(--whatsapp-green-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(18, 140, 126, 0.4);
        }

        .btn {
            background-color: var(--whatsapp-green-light);
        }
        .btn:hover { background-color: #0E7166; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(0); box-shadow: var(--box-shadow-light); }


        .btn1, .btn2 {
            background-color: var(--whatsapp-success-green); /* Brighter green for success/positive actions */
        }
        .btn1:hover, .btn2:hover { background-color: #1DA851; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn1:active, .btn2:active { transform: translateY(0); box-shadow: var(--box-shadow-light); }


        .btn-delete {
            background-color: var(--whatsapp-error-red);
            margin-top: var(--spacing-sm);
        }
        .btn-delete:hover { background-color: #A32531; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-delete:active { transform: translateY(0); box-shadow: var(--box-shadow-light); }


        .btn-edit {
            background-color: var(--whatsapp-warning-orange);
            color: var(--whatsapp-text-dark); /* Dark text for orange button */
            margin-top: var(--spacing-sm);
        }
        .btn-edit:hover { background-color: #D69F00; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-edit:active { transform: translateY(0); box-shadow: var(--box-shadow-light); }

        /* New style for the "Add to Local Products" button on Firebase product cards */
        .btn-add-to-local {
            background-color: var(--whatsapp-green-light);
            color: var(--whatsapp-text-light);
        }
        .btn-add-to-local:hover {
            background-color: #0E7166;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-add-to-local:active {
            transform: translateY(0);
            box-shadow: var(--box-shadow-light);
        }


        /* Invoice specific styles */
        .invoice {
            margin-top: 0;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            background-color: var(--whatsapp-bubble-sent);
            box-shadow: var(--box-shadow-medium);
        }

        .invoice h1 {
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-bottom: var(--spacing-lg);
            font-size: 2em;
        }
        .invoice h2 {
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--whatsapp-green-light);
        }

        .invoice-header,
        .invoice-footer {
            border: none;
            background-color: var(--whatsapp-bubble-received); /* Lighter background for header/footer in invoice */
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
        }

        .invoice-header1 {
            background-color: var(--whatsapp-bubble-received);
            text-align: center;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
        }

        .invoice-header1 table {
            width: 100%;
            margin: 0 auto;
        }

        .invoice-header1 tfoot tr td {
            text-align: right; /* Adjusted for RTL */
            font-weight: bold;
            padding: 0.3rem 0;
        }

        /* New wrapper for responsive table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--whatsapp-border-light);
            background-color: var(--whatsapp-bubble-received); /* Match table background */
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--whatsapp-bubble-received);
            font-size: 0.95em;
            border: none;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--whatsapp-border-light);
            padding: 0.6rem;
            text-align: right; /* Adjusted for RTL */
            white-space: nowrap;
        }

        .invoice-table th {
            background-color: var(--whatsapp-green-light);
            color: var(--whatsapp-text-light);
            font-weight: bold;
        }

        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: left; /* Adjusted for RTL */
            font-weight: bold;
            color: var(--whatsapp-success-green);
            font-size: 1.1em;
        }

        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .invoice .divider {
            border-top: 1px dashed var(--whatsapp-border-light);
            margin: var(--spacing-lg) 0;
        }

        /* Product list items - resembling chat bubbles/contact cards */
        /* Common base style for product cards */
        .product { /* This class is now used for both local and Firebase products */
            border: 1px solid var(--whatsapp-border-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg); /* More rounded, like a chat bubble */
            margin-bottom: 0; /* Managed by grid gap */
            background-color: var(--whatsapp-text-light); /* White background for list items */
            position: relative;
            font-size: 0.95em;
            line-height: 1.5;
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end; /* Align content to the right for RTL */
            text-align: right; /* Text alignment for RTL */
        }
        .product:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        /* NEW: Styling for products marked as 'local' within the local products list */
        .product.is-local {
            background-color: var(--whatsapp-bubble-received) !important; /* Light green bubble color */
            border-color: var(--whatsapp-green-light) !important; /* WhatsApp green border */
            box-shadow: 0 2px 5px rgba(18, 140, 126, 0.2);
        }
        .product.is-local p {
             color: var(--whatsapp-text-dark); /* Ensure text is readable */
        }
        /* Specific styling for the 'Add to Local' button in Firebase products, to differentiate it */
        .product.is-local .btn-add-to-local {
            background-color: var(--whatsapp-text-dark); /* Dark button */
            color: var(--whatsapp-text-light); /* White text */
        }
        .product.is-local .btn-add-to-local:hover {
            background-color: #333;
        }


        /* NEW: Styling for Firebase products that match a local product */
        .product.is-local-match {
            background-color: var(--whatsapp-success-green) !important; /* A distinct color for Firebase products matching local ones */
            border-color: var(--whatsapp-success-green) !important;
            color: var(--whatsapp-text-light) !important; /* Ensure text is readable on darker background */
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4);
        }
        .product.is-local-match p {
            color: var(--whatsapp-text-light) !important;
        }
        /* Ensure buttons within .is-local-match products are also readable */
        .product.is-local-match .product-actions button {
            background-color: var(--whatsapp-text-light); /* White buttons */
            color: var(--whatsapp-green-dark); /* Dark text on white buttons */
        }
        .product.is-local-match .product-actions button:hover {
            background-color: #f0f0f0;
        }


        /* Specific styling for product details within the common .product card */
        .product .product-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
            width: 100%;
        }

        .product .product-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }
        .product .product-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            height: 50px; /* Increased height */
            padding: 1rem 0; /* Adjusted padding */
        }


        .quantity-controls {
            display: flex;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
            justify-content: center; /* Center quantity controls */
        }

        .quantity-controls button {
            width: 45px; /* Increased size from 38px */
            height: 45px; /* Increased size from 38px */
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em; /* Adjusted font size for larger button */
            background-color: var(--whatsapp-green-light);
            color: var(--whatsapp-text-light);
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.1s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
        }

        .quantity-controls button:hover {
            background-color: #0E7166;
        }
        .quantity-controls button:active {
            transform: scale(0.95);
        }
        .quantity-controls button:focus-visible {
            outline: 2px solid var(--whatsapp-green-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(18, 140, 126, 0.4);
        }

        .quantity-controls input {
            width: 80px;
            max-width: 120px;
            height: 45px; /* Matched button height */
            margin: 0 var(--spacing-sm);
            font-size: 1.1em;
            text-align: center;
            border-radius: var(--border-radius-sm);
            background-color: var(--whatsapp-bubble-sent); /* Light background for quantity input */
            border: 1px solid var(--whatsapp-border-light);
            color: var(--whatsapp-text-dark);
            outline: none;
        }
        .quantity-controls input:focus {
            border-color: var(--whatsapp-green-light);
            box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.3);
        }

        /* Specific background colors for product status (using CSS variables) */
        .product.status-insufficient {
            background-color: var(--whatsapp-error-red) !important; /* Strong red for insufficient */
            color: var(--whatsapp-text-light);
            border-color: var(--whatsapp-error-red) !important;
            box-shadow: 0 2px 5px rgba(216, 46, 62, 0.2);
        }
        .product.status-insufficient p {
            color: var(--whatsapp-text-light);
        }
        .product.status-min-zero {
            background-color: var(--whatsapp-warning-orange) !important; /* Orange for min zero */
            color: var(--whatsapp-text-dark);
            border-color: var(--whatsapp-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 193, 7, 0.2);
        }
        .product.status-min-zero p {
            color: var(--whatsapp-text-dark);
        }

        .product.status-min-positive {
            background-color: var(--whatsapp-warning-orange) !important; /* Orange for min positive */
            color: var(--whatsapp-text-dark);
            border-color: var(--whatsapp-warning-orange) !important;
            box-shadow: 0 2px 5px rgba(255, 193, 7, 0.2);
        }
        .product.status-min-positive p {
            color: var(--whatsapp-text-dark);
        }

        .product.status-selected-sufficient {
            background-color: var(--whatsapp-bubble-received) !important; /* Light green for selected sufficient */
            border-color: var(--whatsapp-green-light) !important;
            box-shadow: 0 2px 5px rgba(37, 211, 102, 0.2);
        }

        .product.status-stock-positive, .product.status-default {
            background-color: var(--whatsapp-text-light) !important; /* White for default/positive stock */
            border-color: var(--whatsapp-border-light) !important;
            box-shadow: var(--box-shadow-light);
        }


        /* Firebase product items will now use the .product class directly for visual consistency */
        /* Removed .product-item specific styling as it is replaced by .product */

        /* Local Invoice item specific styles */
        .local-invoice-item {
            border: 1px solid var(--whatsapp-border-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg); /* Rounded for archive items */
            background-color: var(--whatsapp-bubble-received); /* Received bubble for archive items */
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end; /* Align to right for RTL */
            text-align: right;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .local-invoice-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .local-invoice-item p {
            margin-bottom: 5px;
        }
        .local-invoice-item .invoice-summary-details {
            flex-grow: 1;
            margin-bottom: var(--spacing-sm);
        }
        .local-invoice-item .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }
        .local-invoice-item .invoice-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            height: 50px; /* Increased height */
        }

        /* Search input for saved products list and local invoice */
        #searchProduct,
        #searchLocalInvoice {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius-pill); /* Pill-shaped search input */
            border: 1px solid var(--whatsapp-border-light);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--whatsapp-text-light); /* White background */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--whatsapp-text-dark);
            outline: none;
            text-align: right; /* Align text to right for RTL */
        }
        #searchProduct:focus,
        #searchLocalInvoice:focus {
            border-color: var(--whatsapp-green-light);
            box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.3);
        }

        /* Adjustments for dropdown and search in Firebase section */
        /* Combined filter controls for Firebase products and statistics */
        .combined-firebase-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md); /* space below the filters */
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--whatsapp-bubble-sent); /* Sent bubble color */
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        /* When filters are inside the product list wrapper, adjust its background/shadow */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            background-color: transparent; /* Make it transparent to blend with parent */
            box-shadow: none; /* No extra shadow */
            padding-top: 0; /* Align with parent's internal padding */
            padding-left: 0;
            padding-right: 0;
            border-radius: 0; /* No border radius here */
        }
        .combined-firebase-filter-controls .form-group {
            flex: 1 1 48%;
            min-width: 250px;
            margin-bottom: 0;
        }
        .combined-firebase-filter-controls .form-group label {
            display: none;
        }
        .combined-firebase-filter-controls select,
        .combined-firebase-filter-controls input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.8rem;
            box-sizing: border-box;
            background-color: var(--whatsapp-text-light);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--whatsapp-border-light);
            font-size: 1em;
            color: var(--whatsapp-text-dark);
            outline: none;
            text-align: right; /* Align text to right for RTL */
        }

        .combined-firebase-filter-controls select:focus,
        .combined-firebase-filter-controls input[type="text"]:focus {
            border-color: var(--whatsapp-green-light);
            box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.3);
        }

        .combined-firebase-filter-controls select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%231F2C34%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E'); /* Darker arrow for readability */
            background-repeat: no-repeat;
            background-position: left 10px center; /* Position arrow to the left for RTL */
            background-size: 12px;
            padding-left: 30px; /* Adjust padding for arrow */
            padding-right: 0.8rem; /* Keep some right padding */
        }

        /* --- Statistics Section Styles --- */
        .statistics-section h2 {
            text-align: center;
            color: var(--whatsapp-green-dark);
            margin-bottom: var(--spacing-md);
            font-size: 1.8em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--whatsapp-green-light);
            margin-top: 0;
        }

        .statistics-section h3 {
            color: var(--whatsapp-green-light);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.5em;
            border-bottom: 1px solid var(--whatsapp-border-light);
            padding-bottom: var(--spacing-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        /* Specific style for list-containing stat cards to span full grid width */
        /* Changed to display lists side-by-side using flexbox */
        .stat-card-list {
            grid-column: 1 / -1; /* Make it span all columns */
            display: flex; /* Use flexbox for its children */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: var(--spacing-md); /* Gap between the two lists */
            align-items: flex-start; /* Align items to the start of the cross axis */
            width: 100%; /* Ensure it takes full width within the grid */
        }

        .stat-card {
            background-color: var(--whatsapp-text-light); /* White background for stat cards */
            border: 1px solid var(--whatsapp-bubble-received); /* Light green border */
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--box-shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        /* Specific style for the two list containers within stat-card-list */
        .stat-card-list > div { /* Target the direct div children (Top Selling and Top Customers) */
            flex: 1 1 48%; /* Each takes roughly half width, allowing for gap */
            min-width: 250px; /* Ensure they don't shrink too much */
            background-color: var(--whatsapp-text-light); /* White background for these specific "cards" */
            border: 1px solid var(--whatsapp-bubble-received);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--box-shadow-light);
            box-sizing: border-box; /* Include padding in width calculation */
        }


        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.1em;
            color: var(--whatsapp-green-dark);
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--whatsapp-text-dark);
            margin: 0;
        }

        /* Styling for scrollable lists within stat cards */
        .scrollable-list-in-card {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: right; /* Align text to right for RTL */
            font-size: 0.9em;
            width: 100%;
            max-height: 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-left: var(--spacing-xs); /* Padding for scrollbar on left in RTL */
            border: 1px solid var(--whatsapp-border-light);
            border-radius: var(--border-radius-sm);
            background-color: var(--whatsapp-bubble-sent); /* A slightly different background */
            box-sizing: border-box;
        }
        .scrollable-list-in-card li {
            background-color: var(--whatsapp-bubble-sent); /* Base for list items */
            padding: 6px 10px;
            border-radius: 5px;
            margin-bottom: 6px;
            border: 1px solid var(--whatsapp-border-light);
            display: flex;
            justify-content: space-between; /* Space out items */
            align-items: center;
            flex-wrap: wrap;
            background-color: var(--whatsapp-text-light); /* Use white background for list items */
        }
        .scrollable-list-in-card li:last-child {
            margin-bottom: 0;
        }
        .scrollable-list-in-card li span:first-child {
            white-space: normal;
            word-break: break-word;
            flex-grow: 1;
            margin-left: var(--spacing-xs); /* Space between name and quantity for RTL */
            margin-right: 0;
        }
        .scrollable-list-in-card li span:last-child {
            font-weight: bold;
            flex-shrink: 0;
        }


        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            align-items: center;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            padding: var(--spacing-md);
        }

        .toast {
            background-color: var(--whatsapp-text-light); /* White background for toast */
            color: var(--whatsapp-text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--whatsapp-border-light);
            direction: rtl; /* Ensure toast text is RTL */
        }

        .toast.success { border-right: 5px solid var(--whatsapp-success-green); border-left: none;} /* Right border for RTL */
        .toast.error { border-right: 5px solid var(--whatsapp-error-red); border-left: none;}
        .toast.info { border-right: 5px solid var(--whatsapp-green-light); border-left: none;}

        .toast .icon {
            font-size: 1.5em;
            line-height: 1;
        }
        .toast.success .icon { color: var(--whatsapp-success-green); }
        .toast.error .icon { color: var(--whatsapp-error-red); }
        .toast.info .icon { color: var(--whatsapp-green-light); }


        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Custom Confirmation Modal */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            right: 0; /* Changed from left 0 to right 0 for RTL consistency */
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #confirm-modal-dialog {
            background-color: var(--whatsapp-text-light); /* White background */
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            direction: rtl; /* Ensure modal text is RTL */
        }

        #confirm-modal-overlay.active #confirm-modal-dialog {
            transform: scale(1);
        }

        #confirm-modal-dialog h3 {
            color: var(--whatsapp-text-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
        }

        #confirm-modal-dialog p {
            color: var(--whatsapp-text-dark);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }

        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-pill); /* Pill-shaped buttons */
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #confirm-yes-btn {
            background-color: var(--whatsapp-green-light);
            color: var(--whatsapp-text-light);
        }
        #confirm-yes-btn:hover { background-color: #0E7166; }

        #confirm-no-btn {
            background-color: var(--whatsapp-border-light);
            color: var(--whatsapp-text-dark);
        }
        #confirm-no-btn:hover { background-color: #A0A0A0; }


        /* Media Queries for Responsiveness - adjusted for desktop first */
        @media (max-width: 1024px) {
            .container {
                max-width: 960px;
            }
            .container.full-width {
                max-width: 100%; /* Take full available width */
            }
            .saved-products3 {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            .main-controls .btn-panel {
                font-size: 0.9em;
                padding: 0.6rem 0.8rem;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
            .stat-card h3 { font-size: 1em; }
            .stat-card p { font-size: 1.4em; }
            .scrollable-list-in-card {
                max-height: 100px;
            }
            /* low-stock and local-invoices will take full available height due to flex-grow:1 */
            .low-stock-section-standalone .product-list-grid,
            .local-invoices-list {
                max-height: 280px; /* Specific limit for two items */
            }
            #productListContainerdata {
                max-height: none; /* Let flex-grow handle it */
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            .quantity-controls input {
                width: 70px;
            }
            .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
            .dashboard-archive-stock-wrapper > .low-stock-section-standalone {
                flex: 1 1 45%; /* Slightly more flexible for smaller desktops */
            }
        }

        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }
            .container {
                max-width: 100%; /* Full width on smaller screens */
            }
            .main-controls .btn-panel {
                flex: 1 1 48%;
                max-width: none;
                font-size: 0.9em;
                padding: 0.6rem 0.8rem;
            }
            .dashboard-view > .product-container,
            .dashboard-view > .client-container {
                min-width: unset;
                flex: 1 1 100%;
            }
            /* Stack archive and low stock on tablets */
            .dashboard-archive-stock-wrapper > .local-archive-container-embedded,
            .dashboard-archive-stock-wrapper > .low-stock-section-standalone {
                flex: 1 1 100%;
            }
            .invoice h1 {
                font-size: 1.8em;
            }
            .invoice h2 {
                font-size: 1.4em;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.5rem;
                font-size: 0.8em;
            }
            .saved-products3, .local-invoices-list, #productListContainerdata {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: calc(100vh - 200px);
            }

            .stat-card p {
                font-size: 1.3em;
            }
            .statistics-section h2 {
                font-size: 1.5em;
            }
            .toast {
                min-width: unset;
                max-width: 90%;
            }

            .dashboard-view > section {
                flex: 1 1 100%;
            }
            .combined-firebase-filter-controls .form-group {
                min-width: unset;
                flex: 1 1 100%;
            }
            .scrollable-list-in-card {
                max-height: 150px;
            }
            .low-stock-section-standalone .product-list-grid { /* Updated class */
                max-height: 250px;
            }
            .quantity-controls input {
                width: 60px;
                margin: 0 5px;
            }
            /* Stack top selling and top customers on smaller screens */
            .stat-card-list {
                flex-direction: column;
            }
            .stat-card-list > div {
                flex: 1 1 100%; /* Take full width when stacked */
            }
        }

        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
            }
            .main-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .main-controls .btn-panel {
                flex: 1 1 100%;
                max-width: none;
                font-size: 1em;
                padding: 0.75rem 1rem;
            }
            .button-container {
                flex-direction: column;
            }
            .btn, .btn1, .btn2, .btn-delete, .btn-edit, .btn-add-to-local {
                flex: 1 1 100%;
            }
            .quantity-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            .quantity-controls input {
                width: 60px;
                margin: 0 5px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .saved-products3, .product-list-grid, .local-invoices-list, #productListContainerdata {
                grid-template-columns: 1fr;
                max-height: 300px;
            }
            .dashboard-view h1, .firebase-stats-combined-container h1 {
                font-size: 1.8em;
            }
            .dashboard-view h2, .firebase-stats-combined-container h2 {
                font-size: 1.5em;
            }
            .dashboard-view h3, .statistics-section h3, .low-stock-section-standalone h3 { /* Updated class */
                font-size: 1.3em;
            }
            .invoice h1 { font-size: 1.6em; }
            .invoice h2 { font-size: 1.3em; }
            .stat-card h3 { font-size: 0.9em; }
            .stat-card p { font-size: 1.2em; }
            .scrollable-list-in-card {
                font-size: 0.8em;
                padding: 4px 6px;
                max-height: 150px;
            }
            .low-stock-section-standalone .product-list-grid { /* Updated class */
                max-height: 200px;
            }
            .toast {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            .toast .icon {
                font-size: 1.2em;
            }
        }

        /* Accessible hidden content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

</head>
<body>
    <!-- Header section for main navigation -->
    <header class="main-controls">
        <!-- Dashboard button first as per user request -->
        <button type="button" class="btn-panel" id="showFirebaseDataButton">بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showDashboardButton">الرئيسية (الإدارة)</button>
    </header>

    <!-- Main content area -->
    <main class="container">

        <!-- Main Dashboard View Section -->
        <section id="mainDashboardView" class="dashboard-view fade-in-section" hidden>
            <h1>لوحة التحكم الرئيسية</h1>

            <!-- Product Management Section -->
            <section class="product-container" id="productFormContainer">
                <h2>إدارة المنتجات</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
                        <span class="validation-error-message">اسم المنتج مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">سعر الشراء مطلوب (غير سالب).</span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">سعر البيع مطلوب (غير سالب).</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
                        <span class="validation-error-message">اسم المورد مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
                        <span class="validation-error-message">عنوان المورد مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                        <span class="validation-error-message">رقم هاتف المورد مطلوب (10 أرقام).</span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantité initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                    </div>
                    <!-- NEW: Checkbox for Local Product -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="isLocalProduct" style="width: auto; margin-left: 0; margin-right: 0;">
                        <label for="isLocalProduct" style="margin-bottom: 0;">منتج محلي؟</label>
                    </div>

                    <div class="button-container">
                        <button type="submit" class="btn" id="addProduct">إضافة منتج</button>
                        <button type="submit" class="btn" id="saveEditProduct">تعديل المنتج</button>
                    </div>
                </form>
            </section>

            <!-- Client and Invoice Creation Section -->
            <section class="client-container" id="clientFormContainer">
                <h2>إنشاء الفواتير</h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message">تاريخ الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
                        <span class="validation-error-message">اسم العميل مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">اسم مالك الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la facture</label>
                        <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">عنوان مالك الفاتورة مطلوب.</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="on" pattern="[0-9]{10}">
                        <span class="validation-error-message">رقم هاتف مالك الفاتورة مطلوب (10 أرقام).</span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message">نسبة TVA مطلوبة (بين 0 و 100).</span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                        <input type="number" id="invoiceCommissionPercentage" placeholder="مثال: 10" value="0" min="0" max="100" step="0.01">
                        <span class="validation-error-message">نسبة العمولة للفاتورة (بين 0 و 100).</span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn" id="createInvoiceButton">إنشاء الفاتورة وعرضها</button>
                    </div>
                </form>
            </section>

            <!-- NEW: Wrapper for Local Invoice Archive and Low Stock Products -->
            <div class="dashboard-archive-stock-wrapper">
                <!-- Local Invoice Archive Section -->
                <section class="local-archive-container-embedded" id="localInvoiceArchive">
                    <h2>أرشيف الفواتير المحلية</h2>
                    <div class="form-group">
                        <label for="searchLocalInvoice" class="sr-only">البحث في الفواتير المحلية</label>
                        <input type="text" id="searchLocalInvoice" placeholder="البحث في الفواتير المحلية (العميل، المالك، التاريخ، المنتجات)">
                    </div>
                    <!-- Local Invoices List is now explicitly scrollable -->
                    <div class="local-invoices-list product-list-grid" id="localInvoicesList">
                        <p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>
                    </div>
                </section>

                <!-- Separate Low Stock Products Section -->
                <section class="low-stock-section-standalone" id="lowStockProductsContainer">
                    <h2>تتبع المخزون: المنتجات على وشك النفاد</h2>
                    <div class="product-list-grid" id="lowStockProductsList">
                        <p class="empty-list-message">لا توجد منتجات في المخزون المنخفض أو نفدت حالياً.</p>
                    </div>
                </section>
            </div>

            <!-- Saved Products Display Section -->
            <section class="saved-products" id="savedProductsDisplay">
                <div class="divider"></div>
                <div class="form-group">
                    <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                    <input type="text" id="searchProduct" placeholder="البحث عن منتج">
                </div>
                <div class="saved-products3 product-list-grid" id="savedProductsList"></div>
            </section>
        </section>

        <!-- Invoice Display Article -->
        <article class="invoice fade-in-section" id="invoiceDisplay" hidden>
            <button type="button" class="btn" id="savePdfButton">تحديث المخزون (بعد الفاتورة)</button>
            <h1>DEVIS</h1>

            <!-- Invoice Header Section (Client Details) -->
            <section class="invoice-header">
                <h2>تفاصيل العميل</h2>
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
                <p>Date de la facture: <time datetime="" id="displayInvoiceDate"></time></p>
            </section>

            <!-- Invoice Details Table Wrapper for Responsiveness -->
            <div class="table-responsive">
                <table class="invoice-table" id="invoiceDetails">
                    <thead>
                        <tr>
                            <th>N°</th>
                            <th>Nom du produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantité</th>
                            <th>Montant HT</th>
                        </tr>
                    </thead>
                    <tbody id="displayDetails">
                        <!-- Products details will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Invoice Summary Section -->
            <div class="invoice-header1">
                <h2>ملخص الفاتورة</h2>
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Invoice Footer Section (Owner Contact Info) -->
            <footer class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </footer>
            <div class="button-container">
                <button type="button" class="btn" id="printButton">طباعة الفاتورة</button>
            </div>
        </article>

        <!-- Firebase Products and Statistics Section -->
        <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay" hidden>
            <h1>بيانات Firebase والإحصائيات</h1>

            <div class="firebase-content-wrapper">
                <!-- Statistics Sub-Section -->
                <section class="statistics-section">
                    <h2>إحصائيات المبيعات التفصيلية</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي سعر الشراء</h3>
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي سعر البيع</h3>
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي العمولة</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي الأرباح</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>عدد الفواتير</h3>
                            <p id="invoiceCount">0</p>
                        </div>
                        <!-- Product selling and customer activity cards now span full width and are side-by-side -->
                        <div class="stat-card-list">
                            <div>
                                <h3>المنتجات الأكثر مبيعاً</h3>
                                <ul id="topSellingProducts" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                            <div>
                                <h3>العملاء الأكثر نشاطاً</h3>
                                <ul id="topCustomers" class="scrollable-list-in-card">
                                    <li>لا توجد بيانات</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Firebase Product List Sub-Section -->
                <section class="firebase-product-list-wrapper">
                    <h2>قائمة منتجات Firebase</h2>
                    <!-- Combined Filter Controls for Firebase Data - MOVED HERE -->
                    <div class="combined-firebase-filter-controls">
                        <div class="form-group">
                            <label for="commonPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                            <select id="commonPhoneDropdown">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commonSearchInput" class="sr-only">البحث في بيانات Firebase</label>
                            <input type="text" id="commonSearchInput" placeholder="البحث برقم الهاتف، الاسم، أو المنتج">
                        </div>
                    </div>
                    <!-- Changed class to saved-products3 to use consistent styling with local products list -->
                    <div class="saved-products3 product-list-grid" id="productListContainerdata"></div>
                </section>
            </div>
        </section>

    </main>

    <!-- Global Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ====== Global UI Elements ======
        const mainDashboardView = document.getElementById('mainDashboardView');
        const productFormContainer = document.getElementById('productFormContainer');
        const clientFormContainer = document.getElementById('clientFormContainer');
        const invoiceDisplay = document.getElementById('invoiceDisplay');
        const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay'); // Now combines Firebase data & Stats
        const lowStockProductsContainer = document.getElementById('lowStockProductsContainer'); // Reference to the new standalone section

        // ====== Main Navigation Buttons ======
        const showDashboardButton = document.getElementById('showDashboardButton');
        const showFirebaseDataButton = document.getElementById('showFirebaseDataButton');

        // Array of all navigation buttons for easy active state management
        const navButtons = [
            showDashboardButton, // Dashboard is now first as per user request
            showFirebaseDataButton
        ];

        // ====== Form Elements ======
        const productForm = document.getElementById('productForm');
        const productNameInput = document.getElementById('productName');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const supplierNameInput = document.getElementById('supplierName');
        const supplierAddressInput = document.getElementById('supplierAddress');
        const supplierPhoneInput = document.getElementById('supplierPhone');
        const productQuantityInput = document.getElementById('productQuantity');
        const isLocalProductCheckbox = document.getElementById('isLocalProduct'); // NEW: Reference to the checkbox


        const invoiceForm = document.getElementById('invoiceForm');
        const customerNameInput = document.getElementById('customerName');
        const invoiceOwnerInput = document.getElementById('invoiceOwner');
        const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
        const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const tvaInput = document.getElementById('tva');
        const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage');

        const addProductButton = document.getElementById('addProduct');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        const savedProductsList = document.getElementById('savedProductsList');
        const searchProductInput = document.getElementById('searchProduct');

        // Combined Firebase/Stats Filter Elements
        // NOTE: These are now children of firebaseProductListContainer for better grouping
        const commonPhoneDropdown = document.getElementById('commonPhoneDropdown');
        const commonSearchInput = document.getElementById('commonSearchInput');

        const firebaseProductListContainer = document.getElementById('productListContainerdata');


        const lowStockProductsList = document.getElementById('lowStockProductsList');

        // Local Invoice Archive elements (still need references)
        const localInvoicesList = document.getElementById('localInvoicesList');
        const searchLocalInvoiceInput = document.getElementById('searchLocalInvoice');

        // ====== Toast Notification Elements ======
        const toastContainer = document.getElementById('toast-container');

        // ====== Custom Confirmation Modal Elements ======
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmResolve;

        // Global array to hold all fetched Firebase invoices for statistics filtering
        let allFirebaseInvoicesData = [];

        // Global array to hold all fetched Firebase products for Firebase data view filtering
        let allFirebaseProducts = [];

        // Global array to hold all local invoices for local archive view
        let allLocalInvoices = [];

        // Reference to the main container to adjust its width
        const mainContainer = document.querySelector('main.container');


        // ====== Initial Setup on Window Load ======
        window.onload = function() {
            // Initially show Main Dashboard view and mark its button as active
            // This also ensures necessary data is fetched and displayed upon load.
            showSection(mainDashboardView); // Use the new function to show with animation
            setActiveButton(showDashboardButton);
            mainContainer.classList.remove('full-width'); // Ensure dashboard is not full width initially

            window.scrollTo({ top: 0, behavior: 'smooth' });

            saveEditProductButton.style.display = 'none';

            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-MA'); // Changed to Moroccan Arabic for date
            const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' }); // Changed to Moroccan Arabic for time
            invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
            // Set datetime attribute for the <time> element
            document.getElementById('displayInvoiceDate').setAttribute('datetime', now.toISOString());


            // Load saved data from Local Storage for persistent fields
            const savedInvoiceOwner = localStorage.getItem('invoiceOwner');
            const savedInvoiceOwnerPhone = localStorage.getItem('invoiceOwnerPhone');
            const savedInvoiceOwnerAddress = localStorage.getItem('invoiceOwnerAddress'); // Corrected key
            const savedSupplierName = localStorage.getItem('supplierName');
            const savedSupplierAddress = localStorage.getItem('supplierAddress');
            const savedSupplierPhone = localStorage.getItem('supplierPhone');
            const savedInvoiceCommission = localStorage.getItem('invoiceCommissionPercentage');

            if (savedInvoiceOwner) invoiceOwnerInput.value = savedInvoiceOwner;
            if (savedInvoiceOwnerPhone) invoiceOwnerPhoneInput.value = savedInvoiceOwnerPhone;
            if (savedInvoiceOwnerAddress) invoiceOwnerAddressInput.value = savedInvoiceOwnerAddress;
            if (savedSupplierName) supplierNameInput.value = savedSupplierName;
            if (savedSupplierAddress) supplierAddressInput.value = savedSupplierAddress;
            if (savedSupplierPhone) supplierPhoneInput.value = savedSupplierPhone;
            if (savedInvoiceCommission) invoiceCommissionPercentageInput.value = savedInvoiceCommission;

            // Initialize display for dashboard elements
            displayLocalInvoices();
            displayLowStockProducts();
            displaySavedProducts();

            // Firebase data will be fetched when its button is clicked.
        };

        // ====== UI Management Functions ======

        /**
         * Hides all main content sections with a fade-out animation.
         * After the animation, sets the hidden attribute.
         */
        function hideAllSections() {
            const sectionsToHide = [mainDashboardView, invoiceDisplay, firebaseProductsDisplay];
            sectionsToHide.forEach(section => {
                if (section.classList.contains('visible')) { // Only hide if currently visible
                    section.classList.remove('visible'); // Trigger fade-out
                    // Set hidden to true AFTER the fade-out animation completes
                    setTimeout(() => {
                        section.hidden = true;
                    }, 500); // Matches CSS transition duration (0.5s)
                }
            });
        }

        /**
         * Shows a specific section with a fade-in animation.
         * @param {HTMLElement} sectionToShow - The section element to display.
         */
        function showSection(sectionToShow) {
            // First, ensure all sections are fading out and will eventually be hidden.
            hideAllSections();

            // Immediately make the target section visible (display: block/flex)
            // but keep its opacity 0 (due to .fade-in-section)
            sectionToShow.hidden = false;

            // A small timeout ensures the browser registers the 'hidden = false'
            // before 'visible' class is added, which triggers the fade-in.
            setTimeout(() => {
                sectionToShow.classList.add('visible');
            }, 10); // A small delay (e.g., 10ms) is often sufficient
        }

        /**
         * Sets the active state for the navigation buttons.
         * @param {HTMLElement} activeBtn - The button that should be marked as active.
         */
        function setActiveButton(activeBtn) {
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            activeBtn.classList.add('active');
        }

        /**
         * Resets validation messages for a given form.
         * @param {HTMLFormElement} form - The form element to reset validation for.
         */
        function resetValidationMessages(form) {
            const fields = form.querySelectorAll('input[required], textarea[required]');
            fields.forEach(field => {
                field.style.borderColor = ''; // Reset border
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.style.display = 'none'; // Hide error message
                }
            });
        }

        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of toast (e.g., 'success', 'error', 'info').
         */
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let iconHtml = '';
            // Using simple unicode characters for icons as external libraries are not allowed by policy
            if (type === 'success') {
                iconHtml = '<span class="icon">&#10004;</span>'; // Checkmark icon
            } else if (type === 'error') {
                iconHtml = '<span class="icon">&#10006;</span>'; // Cross icon
            } else if (type === 'info') {
                iconHtml = '<span class="icon">&#8505;</span>'; // Info icon
            }
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            toastContainer.appendChild(toast);

            // Remove the toast after animation (4 seconds)
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} A promise that resolves to true if 'Yes' is clicked, false if 'No'.
         */
        function showConfirmModal(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;

                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalOverlay.hidden = false;
                confirmModalOverlay.classList.add('active');

                const handleYes = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }


        // ====== Section Display Functions ======

        // Dashboard Button Event Listener
        showDashboardButton.addEventListener('click', () => {
            showSection(mainDashboardView);
            setActiveButton(showDashboardButton);
            mainContainer.classList.remove('full-width'); // Reset to default width for dashboard
            displayLocalInvoices(); // Ensure local invoices are displayed
            displayLowStockProducts();
            displaySavedProducts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Firebase Data (now combined with Statistics) Button Event Listener
        showFirebaseDataButton.addEventListener('click', () => {
            showSection(firebaseProductsDisplay);
            setActiveButton(showFirebaseDataButton);
            mainContainer.classList.add('full-width'); // Make container full width and height for this section

            // Clear filter inputs when entering the combined view
            commonSearchInput.value = '';
            // Fetch and populate common dropdown with all available phone numbers
            populateCommonDropdown();
            // Fetch all Firebase data (products and invoices) and then display them based on current filters
            fetchAndDisplayCombinedFirebaseData();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ====== Form Validation Helper ======

        /**
         * Checks if all required fields in a form are filled.
         * Displays error messages and highlights empty fields.
         * @param {HTMLFormElement} form - The form element to check.
         * @returns {boolean} True if all required fields are filled, false otherwise.
         */
        function checkFields(form) {
            let allFieldsFilled = true;
            const fields = form.querySelectorAll('input[required], textarea[required]');
            fields.forEach(field => {
                const errorMessageSpan = field.nextElementSibling;
                const fieldValue = field.value.trim();

                if (!fieldValue) {
                    allFieldsFilled = false;
                    field.style.borderColor = 'var(--whatsapp-error-red)';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.style.display = 'block';
                        errorMessageSpan.textContent = field.placeholder + ' مطلوب.';
                    }
                }
                else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                        if (isNaN(numValue) || numValue < 0) {
                            allFieldsFilled = false;
                            field.style.borderColor = 'var(--whatsapp-error-red)';
                            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                                errorMessageSpan.textContent = 'القيمة يجب أن تكون رقماً موجباً.';
                                errorMessageSpan.style.display = 'block';
                            }
                        }
                    }
                    else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                        if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                            allFieldsFilled = false;
                            field.style.borderColor = 'var(--whatsapp-error-red)';
                            if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                                errorMessageSpan.textContent = 'النسبة يجب أن تكون بين 0 و 100.';
                                errorMessageSpan.style.display = 'block';
                            }
                        }
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    const regex = new RegExp(field.pattern);
                    if (!regex.test(fieldValue)) {
                        allFieldsFilled = false;
                        field.style.borderColor = 'var(--whatsapp-error-red)';
                        if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                            errorMessageSpan.textContent = 'صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                            errorMessageSpan.style.display = 'block';
                        }
                    }
                }
                else {
                    field.style.borderColor = '';
                    if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                        errorMessageSpan.style.display = 'none';
                    }
                }
            });
            return allFieldsFilled;
        }


        // ====== Product Management (Local Storage) ======

        /**
         * Saves a new product to Local Storage.
         */
        addProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            if (checkFields(productForm)) {
                const name = productNameInput.value.trim();
                const purchasePrice = parseFloat(purchasePriceInput.value);
                const sellingPrice = parseFloat(sellingPriceInput.value);
                const supplierName = supplierNameInput.value.trim();
                const supplierAddress = supplierAddressInput.value.trim();
                const supplierPhone = supplierPhoneInput.value.trim();
                const stockQuantity = parseInt(productQuantityInput.value);
                const isLocal = isLocalProductCheckbox.checked; // Get isLocal status
                const id = Date.now();
                const date = new Date().toLocaleDateString('ar-MA');

                localStorage.setItem('supplierName', supplierName);
                localStorage.setItem('supplierAddress', supplierAddress);
                localStorage.setItem('supplierPhone', supplierPhone);

                let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
                const productExists = products.some(product =>
                    product.name.toLowerCase() === name.toLowerCase() &&
                    product.supplierPhone === supplierPhone
                );

                if (productExists) {
                    showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
                    return;
                }

                const confirmed = await showConfirmModal("تأكيد الإضافة", "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟");
                if (confirmed) {
                    products.push({ id, name, purchasePrice, sellingPrice, commissionPercentage: 0, supplierName, supplierAddress, supplierPhone, stockQuantity, date, quantity: 0, minStockQuantity: 0, isLocal }); // Save isLocal
                    products.sort((a, b) => a.name.localeCompare(b.name));
                    localStorage.setItem('savedProducts', JSON.stringify(products));
                    displaySavedProducts();
                    displayLowStockProducts();
                    showToast("المنتج تم إضافته بنجاح.", 'success');
                    // Clear form fields
                    productForm.reset();
                    isLocalProductCheckbox.checked = false; // Reset checkbox
                } else {
                    showToast("تم إلغاء إضافة المنتج.", 'info');
                }
            } else {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
            }
        });

        /**
         * Handles editing an existing product. Populates the form with product data.
         * @param {number} productId - The ID of the product to edit.
         */
        function editProduct(productId) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productToEdit = savedProducts.find(p => p.id == productId);

            if (productToEdit) {
                showDashboardButton.click(); // Ensure dashboard is visible

                productNameInput.value = productToEdit.name;
                purchasePriceInput.value = productToEdit.purchasePrice;
                sellingPriceInput.value = productToEdit.sellingPrice;
                supplierNameInput.value = productToEdit.supplierName;
                supplierAddressInput.value = productToEdit.supplierAddress;
                supplierPhoneInput.value = productToEdit.supplierPhone;
                productQuantityInput.value = productToEdit.stockQuantity;
                isLocalProductCheckbox.checked = productToEdit.isLocal || false; // Set checkbox state

                addProductButton.style.display = 'none';
                saveEditProductButton.style.display = 'block';
                saveEditProductButton.dataset.editingId = productId;
                resetValidationMessages(productForm);
            } else {
                showToast("المنتج المراد تعديله غير موجود.", 'error');
            }
        }

        /**
         * Saves edited product data to Local Storage.
         */
        saveEditProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            if (checkFields(productForm)) {
                const idToEdit = event.target.dataset.editingId;
                if (!idToEdit) {
                    showToast("لا يوجد منتج محدد للتعديل.", 'error');
                    return;
                }

                const name = productNameInput.value.trim();
                const purchasePrice = parseFloat(purchasePriceInput.value);
                const sellingPrice = parseFloat(sellingPriceInput.value);
                const supplierName = supplierNameInput.value.trim();
                const supplierAddress = supplierAddressInput.value.trim();
                const supplierPhone = supplierPhoneInput.value.trim();
                const stockQuantity = parseInt(productQuantityInput.value);
                const isLocal = isLocalProductCheckbox.checked; // Get isLocal status
                const date = new Date().toLocaleDateString('ar-MA');

                localStorage.setItem('supplierName', supplierName);
                localStorage.setItem('supplierAddress', supplierAddress);
                localStorage.setItem('supplierPhone', supplierPhone);

                let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
                const productIndex = products.findIndex(p => p.id == idToEdit);

                if (productIndex !== -1) {
                    const duplicateCheck = products.some((p, idx) =>
                        idx !== productIndex &&
                        p.name.toLowerCase() === name.toLowerCase() &&
                        p.supplierPhone === supplierPhone
                    );

                    if (duplicateCheck) {
                        showToast("لا يمكن تعديل المنتج. يوجد منتج آخر بنفس الاسم ورقم هاتف المورد.", 'error');
                        return;
                    }

                    const confirmed = await showConfirmModal("تأكيد التعديل", "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟");
                    if (confirmed) {
                        products[productIndex].name = name;
                        products[productIndex].purchasePrice = purchasePrice;
                        products[productIndex].sellingPrice = sellingPrice;
                        products[productIndex].supplierName = supplierName;
                        products[productIndex].supplierAddress = supplierAddress;
                        products[productIndex].supplierPhone = supplierPhone;
                        products[productIndex].stockQuantity = stockQuantity;
                        products[productIndex].isLocal = isLocal; // Update isLocal
                        products[productIndex].date = date;
                        localStorage.setItem('savedProducts', JSON.stringify(products));
                        displaySavedProducts();
                        displayLowStockProducts();
                        showToast("تم تحديث المنتج بنجاح.", 'success');
                        // Reset form fields and buttons
                        productForm.reset();
                        isLocalProductCheckbox.checked = false;
                        addProductButton.style.display = 'block';
                        saveEditProductButton.style.display = 'none';
                        delete saveEditProductButton.dataset.editingId; // Clear editing ID
                    } else {
                        showToast("تم إلغاء تعديل المنتج.", 'info');
                    }
                } else {
                    showToast("المنتج المراد تعديله غير موجود.", 'error');
                }
            } else {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
            }
        });

        /**
         * Deletes a product from Local Storage.
         * @param {number} id - The ID of the product to delete.
         */
        async function deleteProduct(id) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
            if (confirmed) {
                let products = JSON.parse(localStorage.getItem('savedProducts')) || [];
                products = products.filter(product => product.id !== id);
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts();
                displayLowStockProducts();
                showToast("تم حذف المنتج بنجاح.", 'success');
            } else {
                showToast("تم إلغاء حذف المنتج.", 'info');
            }
        }

        searchProductInput.addEventListener('input', displaySavedProducts);

        /**
         * Resets the quantity selected for invoice for all products in Local Storage to 0.
         */
        function resetAllProductQuantities() {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            savedProducts.forEach(product => {
                product.quantity = 0;
            });
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        }

        /**
         * Displays products from Local Storage, filtered by search term and sorted by status.
         */
        function displaySavedProducts() {
            const searchTerm = searchProductInput.value.toLowerCase();
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            savedProductsList.innerHTML = '';

            const filteredProducts = savedProducts
                .filter(product => product.name.toLowerCase().includes(searchTerm))
                .sort((a, b) => {
                    const stockQuantityA = a.stockQuantity || 0;
                    const stockQuantityB = b.stockQuantity || 0;
                    const minStockQuantityA = a.minStockQuantity || 0;
                    const minStockQuantityB = b.minStockQuantity || 0;
                    const quantityA = a.quantity || 0;
                    const quantityB = b.quantity || 0;

                    const statusA = getProductStatusPriority(quantityA, stockQuantityA, minStockQuantityA);
                    const statusB = getProductStatusPriority(quantityB, stockQuantityB, minStockQuantityB);

                    if (statusA !== statusB) {
                        return statusA - statusB;
                    }

                    return stockQuantityB - stockQuantityA || a.name.localeCompare(b.name);
                });

            let index = filteredProducts.length;

            if (filteredProducts.length === 0) {
                savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
                return;
            }

            filteredProducts.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';

                // Add is-local class if the product is marked as local
                if (product.isLocal) {
                    productDiv.classList.add('is-local');
                }


                const quantityToDisplay = product.quantity || 0;
                const stockQuantityToDisplay = product.stockQuantity || 0;
                const minStockQuantityToDisplay = product.minStockQuantity || 0;

                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay);

                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>الاسم:</strong> ${product.name}</p>
                        <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName}</p>
                        <p><strong>هاتف المورد:</strong> ${product.supplierPhone}</p>
                    </div>

                    <p><strong>الكمية في المخزون:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustStock(${product.id}, 1)">+</button>
                        <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" onchange="updateStockFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustStock(${product.id}, -1)">-</button>
                    </div>

                    <p><strong>الحد الأدنى للمخزون:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustMinQuantity(${product.id}, 1)">+</button>
                        <input type="number" class="min-product-quantity" data-id="${product.id}" value="${minStockQuantityToDisplay}" min="0" onchange="updateMinStockFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustMinQuantity(${product.id}, -1)">-</button>
                    </div>

                    <p><strong>الكمية المحددة للفاتورة:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" onclick="adjustQuantity(${product.id}, 1)">+</button>
                        <input type="number" class="product-quantity" data-id="${product.id}" value="${quantityToDisplay}" min="0" onchange="updateQuantityFromInput(${product.id}, this.value)">
                        <button type="button" onclick="adjustQuantity(${product.id}, -1)">-</button>
                    </div>

                    <div class="product-actions">
                        <button type="button" class="btn-delete" onclick="deleteProduct(${product.id})">حذف</button>
                        <button type="button" class="btn-edit" data-product-id="${product.id}">تعديل</button>
                    </div>
                `;

                productDiv.querySelector('.btn-edit').addEventListener('click', (event) => {
                    event.stopPropagation();
                    const productId = event.target.dataset.productId;
                    editProduct(productId);
                });

                savedProductsList.appendChild(productDiv);
                index--;
            });
        }

        /**
         * Displays low stock products in the dedicated section within the Product List tab.
         */
        function displayLowStockProducts() {
            lowStockProductsList.innerHTML = ''; // Clear previous content
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

            const lowStockItems = savedProducts.filter(p => (p.stockQuantity || 0) < (p.minStockQuantity || 0) && (p.stockQuantity || 0) > 0);
            const outOfStockItems = savedProducts.filter(p => (p.stockQuantity || 0) === 0);

            if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
                lowStockProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات في المخزون المنخفض أو نفدت حالياً.</p>';
            } else {
                const combinedLowStock = [...lowStockItems, ...outOfStockItems];
                combinedLowStock.sort((a, b) => a.name.localeCompare(b.name));

                combinedLowStock.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('product');
                    if ((product.stockQuantity || 0) < (product.minStockQuantity || 0) && (product.stockQuantity || 0) > 0) {
                                productDiv.classList.add('low');
                    } else if ((product.stockQuantity || 0) === 0) {
                                productDiv.classList.add('status-insufficient');
                    }

                    productDiv.innerHTML = `
                        <div class="product-details">
                            <p><strong>المنتج:</strong> ${product.name}</p>
                            <p><strong>المخزون الحالي:</strong> ${product.stockQuantity || 0} ${ (product.stockQuantity || 0) === 0 ? '(نفد)' : '' }</p>
                            <p><strong>الحد الأدنى للمخزون:</strong> ${product.minStockQuantity || 0}</p>
                        </div>
                        <div class="product-actions">
                            <button type="button" class="btn1" onclick="showDashboardButton.click(); editProduct(${product.id});">تعديل</button>
                        </div>
                    `;
                    lowStockProductsList.appendChild(productDiv);
                });
            }
        }


        /**
         * Determines the priority of a product's display status for sorting.
         * Lower number means higher priority (appears earlier in the list).
         */
        function getProductStatusPriority(quantity, stock, minStock) {
            if (quantity > 0 && stock < quantity) return 1;
            if (stock < minStock && quantity === 0) return 2;
            if (stock < minStock) return 3;
            if (quantity > 0) return 4;
            if (stock > 0) return 5;
            return 6;
        }

        /**
         * Updates the CSS classes of a product div based on its stock and selected quantity status.
         * @param {HTMLElement} productDiv - The product div element.
         * @param {number} quantityToDisplay - The quantity selected for invoice.
         * @param {number} stockQuantityToDisplay - The current stock quantity.
         * @param {number} minStockQuantityToDisplay - The minimum stock quantity.
         */
        function updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, minStockQuantityToDisplay) {
            // Keep the 'is-local' class if it was already applied
            const isLocalClass = productDiv.classList.contains('is-local') ? 'is-local' : '';
            productDiv.className = 'product'; // Reset all other classes
            if (isLocalClass) {
                productDiv.classList.add(isLocalClass);
            }


            if (quantityToDisplay > 0 && stockQuantityToDisplay < quantityToDisplay) {
                productDiv.classList.add('status-insufficient');
            } else if (stockQuantityToDisplay < minStockQuantityToDisplay && quantityToDisplay === 0) {
                productDiv.classList.add('status-min-zero');
            } else if (stockQuantityToDisplay < minStockQuantityToDisplay) {
                productDiv.classList.add('status-min-positive');
            } else if (quantityToDisplay > 0) {
                productDiv.classList.add('status-selected-sufficient');
            } else if (stockQuantityToDisplay > 0) {
                productDiv.classList.add('status-stock-positive');
            } else {
                productDiv.classList.add('status-default');
            }
        }

        /**
         * Adjusts the stock quantity of a product.
         * @param {number} id - Product ID.
         * @param {number} amount - Amount to add/subtract.
         */
        function adjustStock(id, amount) {
            const stockInput = document.getElementById(`stock-${id}`);
            let stockQuantity = parseInt(stockInput.value) || 0;
            stockQuantity += amount;
            if (stockQuantity < 0) stockQuantity = 0;
            stockInput.value = stockQuantity;

            updateStockInLocalStorage(id, stockQuantity);
        }

        /**
         * Updates the stock quantity of a product based on input field value.
         * @param {number} id - Product ID.
         * @param {string} value - New stock quantity value from input.
         */
        function updateStockFromInput(id, value) {
            let stockQuantity = parseInt(value) || 0;
            if (stockQuantity < 0) stockQuantity = 0;
            updateStockInLocalStorage(id, stockQuantity);
        }

        /**
         * Helper function to update stock in Local Storage and refresh UI.
         * @param {number} id - Product ID.
         * @param {number} newStockQuantity - The new stock quantity.
         */
        function updateStockInLocalStorage(id, newStockQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].stockQuantity = newStockQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.getElementById(`stock-${id}`).closest('.product');
                const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, newStockQuantity, minStockQuantityToDisplay);
                displayLowStockProducts();
            }
        }

        /**
         * Adjusts the quantity selected for invoice.
         * @param {number} id - Product ID.
         * @param {number} amount - Amount to add/subtract.
         */
        function adjustQuantity(id, amount) {
            const quantityInput = document.querySelector(`.product-quantity[data-id="${id}"]`);
            let quantity = parseInt(quantityInput.value) || 0;
            quantity += amount;
            if (quantity < 0) quantity = 0;
            quantityInput.value = quantity;

            updateInvoiceQuantityInLocalStorage(id, quantity);
        }

        /**
         * Updates the quantity selected for invoice based on input field value.
         * @param {number} id - Product ID.
         * @param {string} value - New quantity value from input.
         */
        function updateQuantityFromInput(id, value) {
            let quantity = parseInt(value) || 0;
            if (quantity < 0) quantity = 0;
            updateInvoiceQuantityInLocalStorage(id, quantity);
        }

        /**
         * Helper function to update invoice quantity in Local Storage and refresh UI.
         * @param {number} id - Product ID.
         * @param {number} newQuantity - The new quantity selected for invoice.
         */
        function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].quantity = newQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product-quantity[data-id="${id}"]`).closest('.product');
                const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                const minStockQuantityToDisplay = savedProducts[productIndex].minStockQuantity || 0;
                updateProductDivClass(productDiv, newQuantity, stockQuantityToDisplay, minStockQuantityToDisplay); // Pass newQuantity to updateProductDivClass
            }
        }

        /**
         * Adjusts the minimum stock quantity for a product.
         * @param {number} id - Product ID.
         * @param {number} amount - Amount to add/subtract.
         */
        function adjustMinQuantity(id, amount) {
            const minQuantityInput = document.querySelector(`.min-product-quantity[data-id='${id}']`);
            let minQuantity = parseInt(minQuantityInput.value) || 0;
            minQuantity += amount;
            if (minQuantity < 0) minQuantity = 0;
            minQuantityInput.value = minQuantity;

            updateMinStockInLocalStorage(id, minQuantity);
        }

        /**
         * Updates the minimum stock quantity of a product based on input field value.
         * @param {number} id - Product ID.
         * @param {string} value - New min stock quantity value from input.
         */
        function updateMinStockFromInput(id, value) {
            let minQuantity = parseInt(value) || 0;
            if (minQuantity < 0) minQuantity = 0;
            updateMinStockInLocalStorage(id, minQuantity);
        }

        /**
         * Helper function to update min stock in Local Storage and refresh UI.
         * @param {number} id - Product ID.
         * @param {number} newMinQuantity - The new minimum stock quantity.
         */
        function updateMinStockInLocalStorage(id, newMinQuantity) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].minStockQuantity = newMinQuantity;
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.min-product-quantity[data-id='${id}']`).closest('.product');
                const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay, newMinQuantity);
                displayLowStockProducts();
            }
        }


        /* --- Invoice Generation and Display --- */

        /**
         * Creates and displays an invoice based on selected products and client data.
         * Also saves invoice data to Firebase.
         */
        document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
            e.preventDefault();

            if (checkFields(invoiceForm)) {
                let totalHTBeforeCommission = 0;
                let totalProfit = 0;
                let totalCommission = 0;
                let productNumber = 1;
                const detailsTbody = document.getElementById('displayDetails');
                detailsTbody.innerHTML = '';

                let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
                let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);

                if (selectedProductsForInvoice.length === 0) {
                    const confirmed = await showConfirmModal("تحديد المنتجات", "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة كل المنتجات الموجودة بكمية 1؟");
                    if (confirmed) {
                        allSavedProducts.forEach(product => {
                            product.quantity = 1;
                        });
                        localStorage.setItem('savedProducts', JSON.stringify(allSavedProducts));
                        selectedProductsForInvoice = allSavedProducts.filter(p => p.quantity === 1);
                    } else {
                        showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                        return;
                    }
                }

                if (selectedProductsForInvoice.length === 0) {
                    showToast("لا توجد منتجات لتضمينها في الفاتورة.", 'info');
                    return;
                }

                const invoiceCommissionRate = parseFloat(invoiceCommissionPercentageInput.value) || 0;
                localStorage.setItem('invoiceCommissionPercentage', invoiceCommissionRate);

                selectedProductsForInvoice.forEach((productData) => {
                    const quantity = productData.quantity;
                    const sellingPrice = parseFloat(productData.sellingPrice);
                    const purchasePrice = parseFloat(productData.purchasePrice);

                    const itemHT = sellingPrice * quantity;
                    totalHTBeforeCommission += itemHT;

                    const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0;
                    const commissionPerUnit = profitPerUnitBeforeCommission * (invoiceCommissionRate / 100);

                    const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;

                    totalProfit += actualProfitPerUnit * quantity;
                    totalCommission += commissionPerUnit * quantity;


                    const productDetails = document.createElement('tr');
                    productDetails.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${productData.name}</td>
                        <td>${sellingPrice.toFixed(2)} DH</td>
                        <td>${quantity}</td>
                        <td>${itemHT.toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetails);
                });

                const finalTotalHT = totalHTBeforeCommission - totalCommission;

                const tvaRate = parseFloat(tvaInput.value) / 100;
                const tva = (finalTotalHT * tvaRate).toFixed(2);
                const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);

                document.getElementById('displayCustomerName').textContent = customerNameInput.value;
                document.getElementById('displayInvoiceOwner').textContent = invoiceOwnerInput.value;
                document.getElementById('displayInvoiceDate').textContent = invoiceDateInput.value;
                document.getElementById('displayTotalAmountBeforeCommission').textContent = totalHTBeforeCommission.toFixed(2) + ' DH';
                document.getElementById('displayCommissionDeducted').textContent = totalCommission.toFixed(2) + ' DH';
                document.getElementById('displayTotalAmount').textContent = finalTotalHT.toFixed(2) + ' DH';
                document.getElementById('displayTVA').textContent = tva + ' DH';
                document.getElementById('displayTotalTTC').textContent = totalTTC + ' DH';

                document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceOwnerPhoneInput.value;
                document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceOwnerAddressInput.value;

                showSection(invoiceDisplay); // Use the new showSection function
                mainContainer.classList.remove('full-width'); // Invoice display doesn't need full width
                document.getElementById('savePdfButton').style.display = 'block'; // Make sure this is visible for new invoices
                window.scrollTo({ top: 0, behavior: 'smooth' });

                localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
                localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
                localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);

                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    originalViewportContent = viewportMeta.getAttribute('content');
                    viewportMeta.setAttribute('content', 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                } else {
                    const newViewportMeta = document.createElement('meta');
                    newViewportMeta.name = 'viewport';
                    newViewportMeta.content = 'width=1024, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    document.head.appendChild(newViewportMeta);
                }

                const productsToSaveToFirebase = [];
                selectedProductsForInvoice.forEach((productData) => {
                    const profitPerUnitBeforeCommissionFirebase = (parseFloat(productData.sellingPrice) - parseFloat(productData.purchasePrice)) || 0;
                    const commissionPerUnitFirebase = profitPerUnitBeforeCommissionFirebase * (invoiceCommissionRate / 100);
                    const actualProfitPerUnitFirebase = profitPerUnitBeforeCommissionFirebase - commissionPerUnitFirebase;

                    productsToSaveToFirebase.push({
                        ...productData,
                        quantityUsed: productData.quantity,
                        profitPerUnit: actualProfitPerUnitFirebase.toFixed(2),
                        commissionPerUnit: commissionPerUnitFirebase.toFixed(2)
                    });
                });

                const invoiceDataToSave = {
                    id: Date.now(), // Unique ID for local storage invoice
                    date: invoiceDateInput.value,
                    isoDate: new Date().toISOString(), // Added for <time> element
                    customerName: customerNameInput.value,
                    ownerName: invoiceOwnerInput.value,
                    ownerAddress: invoiceOwnerAddressInput.value,
                    ownerPhone: invoiceOwnerPhoneInput.value,
                    products: productsToSaveToFirebase,
                    totalHT: finalTotalHT.toFixed(2),
                    totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                    tva: tva,
                    totalTTC: totalTTC,
                    totalProfit: totalProfit.toFixed(2),
                    totalCommission: totalCommission.toFixed(2)
                };
                if (invoiceCommissionRate > 0) {
                    invoiceDataToSave.invoiceCommissionRate = invoiceCommissionRate;
                }

                // Save to Firebase
                if (productsToSaveToFirebase.length > 0) {
                    const alldataRef = database.ref(`alldata/${invoiceOwnerPhoneInput.value}`);
                    alldataRef.push(invoiceDataToSave)
                    .then(() => showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success'))
                    .catch(error => showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error'));
                }

                // Save to Local Storage
                saveInvoiceToLocalStorage(invoiceDataToSave);

            } else {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
            }
        });

        /**
         * Updates product stock in Local Storage based on the generated invoice.
         */
        document.getElementById('savePdfButton').addEventListener('click', async function() {
            const productsInInvoice = document.querySelectorAll('#invoiceDetails tbody tr');
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];

            let hasInsufficientStock = false;
            let productsToUpdate = [];

            productsInInvoice.forEach((row) => {
                const productName = row.cells[1].textContent;
                const quantityUsed = parseInt(row.cells[3].textContent);

                const productData = savedProducts.find(p => p.name === productName);

                if (productData) {
                    const currentStock = parseInt(productData.stockQuantity || 0);
                    if (currentStock < quantityUsed) {
                        hasInsufficientStock = true;
                        showToast(`تنبيه: كمية غير كافية للمنتج "${productName}". المخزون المتاح: ${currentStock}`, 'error');
                        return;
                    }
                    productsToUpdate.push({ productName, quantityUsed });
                }
            });

            if (hasInsufficientStock) {
                return;
            }

            const confirmed = await showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة؟");
            if (confirmed) {
                productsToUpdate.forEach(({ productName, quantityUsed }) => {
                    const productDataIndex = savedProducts.findIndex(p => p.name === productName);
                    if (productDataIndex !== -1) {
                        savedProducts[productDataIndex].stockQuantity -= quantityUsed;
                    }
                });

                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));

                showToast('تم تحديث المخزون بنجاح.', 'success');
                resetAllProductQuantities();
                showDashboardButton.click(); // Redirect to dashboard after stock update
            } else {
                showToast("تم إلغاء تحديث المخزون.", 'info');
            }
        });

        let originalViewportContent = '';

        /**
         * Prints the invoice.
         */
        document.getElementById('printButton').addEventListener('click', function() {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                originalViewportContent = viewportMeta.getAttribute('content');
                viewportMeta.setAttribute('content', 'width=1024');
            }

            this.style.display = 'none';
            document.getElementById('savePdfButton').style.display = 'none';

            window.print();

            setTimeout(() => {
                document.getElementById('savePdfButton').style.display = 'block';
                this.style.display = 'block';
                if (viewportMeta && originalViewportContent) {
                    viewportMeta.setAttribute('content', originalViewportContent);
                }
            }, 500);
        });

        /* --- Firebase Data Display and Statistics (Combined) --- */

        /**
         * Populates the common phone number dropdown from Firebase data.
         */
        function populateCommonDropdown() {
            const alldataRef = database.ref('alldata');
            alldataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                commonPhoneDropdown.innerHTML = '';

                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'عرض الكل';
                commonPhoneDropdown.appendChild(allOption);

                const phoneNumbers = new Set();
                if (data) {
                    for (const phoneKey in data) {
                        if (data.hasOwnProperty(phoneKey)) {
                            phoneNumbers.add(phoneKey);
                        }
                    }
                }

                const sortedPhoneNumbers = Array.from(phoneNumbers).sort();

                sortedPhoneNumbers.forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    commonPhoneDropdown.appendChild(option);
                });
            }, (error) => {
                showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
            });
        }

        /**
         * Fetches all Firebase data (products and invoices) and then applies filters to display them.
         */
        async function fetchAndDisplayCombinedFirebaseData() {
            const alldataRef = database.ref('alldata');
            let snapshot;
            try {
                snapshot = await alldataRef.once('value');
            } catch (error) {
                showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                return;
            }
            const data = snapshot.val();

            allFirebaseProducts = [];
            allFirebaseInvoicesData = [];

            if (data) {
                for (const phoneKey in data) {
                    if (data.hasOwnProperty(phoneKey)) {
                        const phoneData = data[phoneKey];
                        for (const invoiceKey in phoneData) {
                            if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                const invoiceDetails = phoneData[invoiceKey];
                                allFirebaseInvoicesData.push({ id: invoiceKey, ...invoiceDetails }); // Store full invoice for stats

                                invoiceDetails.products.forEach((product, index) => { // Added index for more unique ID
                                    allFirebaseProducts.push({
                                        // Generate a unique ID for Firebase products for consistency when displaying in the product grid
                                        // We use the invoiceKey + product index to make it unique within the combined list.
                                        id: `${invoiceKey}-${index}`, // More robust unique ID
                                        ...product,
                                        invoiceDate: invoiceDetails.date,
                                        customerName: invoiceDetails.customerName,
                                        ownerName: invoiceDetails.ownerName,
                                        ownerAddress: invoiceDetails.ownerAddress,
                                        ownerPhone: invoiceDetails.ownerPhone,
                                        totalHT: invoiceDetails.totalHT,
                                        totalTTC: invoiceDetails.totalTTC,
                                        totalProfit: invoiceDetails.totalProfit,
                                        totalCommission: invoiceDetails.totalCommission,
                                        firebaseInvoiceKey: invoiceKey
                                    });
                                });
                            }
                        }
                    }
                }
            }

            // Apply filters and display both products and statistics
            applyCombinedFilters();
        }

        /**
         * Checks if a Firebase product exists in local storage.
         * @param {Object} firebaseProduct - The Firebase product object.
         * @returns {Object|null} The matching local product object if found, otherwise null.
         */
        function findLocalProductMatch(firebaseProduct) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
            return savedProducts.find(localProduct =>
                localProduct.name.toLowerCase() === firebaseProduct.name.toLowerCase() &&
                localProduct.supplierPhone === firebaseProduct.ownerPhone // Assuming Firebase ownerPhone maps to local supplierPhone
            );
        }

        /**
         * Applies filters (from common dropdown and search input) to both Firebase products and statistics, then renders them.
         */
        function applyCombinedFilters() {
            const searchTerm = commonSearchInput.value.toLowerCase();
            const selectedPhoneNumber = commonPhoneDropdown.value;

            // Filter Products
            const filteredProducts = allFirebaseProducts.filter(product => {
                const matchesSearchInput = searchTerm ?
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.customerName && product.customerName.toLowerCase().includes(searchTerm)) ||
                    (product.ownerName && product.ownerName.toLowerCase().includes(searchTerm)) ||
                    (product.supplierName && product.supplierName.toLowerCase().includes(searchTerm)) ||
                    (product.ownerPhone && product.ownerPhone.includes(searchTerm))
                    : true;
                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || product.ownerPhone === selectedPhoneNumber);
                return matchesSearchInput && matchesPhoneNumber;
            });

            // For Firebase products, 'isDuplicate' isn't relevant in the same way as local products.
            // We can just sort them by date or name.
            filteredProducts.sort((a, b) => {
                // Assuming invoiceDate is a string like "DD/MM/YYYY HH:MM" or an ISO string
                const dateA = new Date(a.isoDate || a.invoiceDate);
                const dateB = new Date(b.isoDate || b.invoiceDate);
                return dateB - dateA; // Newest first
            });

            displayFirebaseProducts(filteredProducts);

            // Filter Statistics
            let filteredInvoices = allFirebaseInvoicesData.filter(invoice => {
                const matchesSearchInput = searchTerm ?
                    (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm))) ||
                    (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm))
                    : true;
                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || invoice.ownerPhone === selectedPhoneNumber);
                return matchesSearchInput && matchesPhoneNumber;
            });
            displayStatistics(filteredInvoices);
        }


        /**
         * Displays a list of products from Firebase, styled like local product cards.
         * Highlights products that match locally saved products.
         * @param {Array<Object>} products - Array of product objects to display.
         */
        function displayFirebaseProducts(products) {
            firebaseProductListContainer.innerHTML = ''; // Clear previous content

            if (products.length === 0) {
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد منتجات لعرضها.</p>';
                return;
            }

            products.forEach(product => {
                const productDiv = document.createElement('div');
                // Apply the 'product' class for consistent visual styling with local products
                productDiv.classList.add('product');

                // Check if this Firebase product matches any local product
                const matchingLocalProduct = findLocalProductMatch(product);
                if (matchingLocalProduct) {
                    productDiv.classList.add('is-local-match');
                }


                const purchasePrice = parseFloat(product.purchasePrice || 0);
                const sellingPrice = parseFloat(product.sellingPrice || 0);
                const quantityUsed = parseInt(product.quantityUsed || 0);

                // Replicate the structure of a local product item for visual consistency
                // For Firebase data, stock and min stock are not live inventory, so show 'N/A' and disable inputs.
                // "الكمية المحددة للفاتورة" is replaced with "الكمية المباعة (للفاتورة)".
                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>الاسم:</strong> ${product.name}</p>
                        <p><strong>سعر الشراء:</strong> ${purchasePrice.toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${sellingPrice.toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName}</p>
                        <p><strong>هاتف المورد:</strong> ${product.ownerPhone}</p>
                        <p><strong>تاريخ الفاتورة:</strong> ${product.invoiceDate || 'N/A'}</p>
                        <p><strong>العميل:</strong> ${product.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${product.ownerName || 'N/A'}</p>
                    </div>

                    <p><strong>الكمية المباعة (للفاتورة):</strong></p>
                    <div class="quantity-controls">
                        <input type="number" value="${quantityUsed}" min="0" readonly>
                    </div>

                    <div class="product-actions">
                        <!-- Use a unique ID for the edit button to link it to the specific Firebase product -->
                        <button type="button" class="btn-edit btn-add-to-local" data-firebase-product-id="${product.id}">تعديل (محلي)</button>
                    </div>
                `;

                // Add event listener to the "تعديل (محلي)" button to populate the local product form
                productDiv.querySelector('.btn-add-to-local').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent the click from bubbling up to the productDiv
                    const firebaseProductId = event.target.dataset.firebaseProductId;
                    addOrEditProductFromFirebase(firebaseProductId);
                });

                firebaseProductListContainer.appendChild(productDiv);
            });
        }


        /**
         * Adds or edits a product in local storage based on Firebase data.
         * @param {string} firebaseProductId - The unique ID of the Firebase product.
         */
        async function addOrEditProductFromFirebase(firebaseProductId) {
            const firebaseProduct = allFirebaseProducts.find(p => p.id == firebaseProductId);

            if (firebaseProduct) {
                const existingLocalProduct = findLocalProductMatch(firebaseProduct);

                if (existingLocalProduct) {
                    // Product already exists locally, load it for editing
                    showToast(`المنتج "${firebaseProduct.name}" موجود بالفعل محلياً. يتم تحميله للتعديل.`, 'info');
                    editProduct(existingLocalProduct.id);
                } else {
                    // Product does not exist locally, add it as a new local product
                    const confirmed = await showConfirmModal(
                        "إضافة منتج محلي",
                        `هل أنت متأكد من أنك تريد إضافة "${firebaseProduct.name}" كمنتج محلي جديد؟`
                    );

                    if (confirmed) {
                        let savedProducts = JSON.parse(localStorage.getItem('savedProducts')) || [];
                        const newLocalProductId = Date.now();
                        const newLocalProduct = {
                            id: newLocalProductId,
                            name: firebaseProduct.name,
                            purchasePrice: parseFloat(firebaseProduct.purchasePrice || 0),
                            sellingPrice: parseFloat(firebaseProduct.sellingPrice || 0),
                            supplierName: firebaseProduct.supplierName,
                            supplierAddress: firebaseProduct.supplierAddress,
                            supplierPhone: firebaseProduct.ownerPhone, // Use ownerPhone as supplierPhone for local storage
                            stockQuantity: 0, // Assume 0 initial stock for products added from Firebase sales
                            date: new Date().toLocaleDateString('ar-MA'),
                            quantity: 0,
                            minStockQuantity: 0,
                            isLocal: true // Mark as local
                        };
                        savedProducts.push(newLocalProduct);
                        savedProducts.sort((a, b) => a.name.localeCompare(b.name));
                        localStorage.setItem('savedProducts', JSON.stringify(savedProducts));

                        showToast(`تم إضافة "${firebaseProduct.name}" إلى المنتجات المحلية بنجاح.`, 'success');

                        // Now load the newly added local product into the form for editing
                        editProduct(newLocalProductId);
                        displaySavedProducts(); // Refresh local product list
                        displayLowStockProducts(); // Refresh low stock list
                    } else {
                        showToast(`تم إلغاء إضافة "${firebaseProduct.name}" إلى المنتجات المحلية.`, 'info');
                    }
                }
            } else {
                showToast("المنتج المراد تعديله غير موجود في بيانات Firebase الحالية.", 'error');
            }
        }


        // Event listeners for combined filter controls
        commonPhoneDropdown.addEventListener('change', applyCombinedFilters);
        commonSearchInput.addEventListener('input', applyCombinedFilters);


        /* --- Statistics and Tracking --- */

        /**
         * Displays statistics based on filtered invoices.
         * @param {Array<Object>} invoices - Array of filtered invoice objects.
         */
        function displayStatistics(invoices) {
            let totalSalesHT = 0;
            let totalTVA = 0;
            let totalSalesTTC = 0;
            let totalOverallProfit = 0;
            let totalOverallCommission = 0;
            let totalPurchaseCost = 0;
            let totalSellingPrice = 0;
            let invoiceCount = invoices.length;

            const productSales = {}; // { productName: { quantitySold: X } } - Simplified
            const customerActivity = {}; // { customerName: { invoiceCount: X, totalProfit: Y } } - Simplified

            invoices.forEach(invoice => {
                totalSalesHT += parseFloat(invoice.totalHT || 0);
                totalTVA += parseFloat(invoice.tva || 0);
                totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                totalOverallCommission += parseFloat(invoice.totalCommission || 0);

                if (invoice.products) {
                    invoice.products.forEach(product => {
                        const productName = product.name;
                        const quantityUsed = parseInt(product.quantityUsed || 0);
                        const purchasePrice = parseFloat(product.purchasePrice || 0);
                        const sellingPrice = parseFloat(product.sellingPrice || 0);

                        totalPurchaseCost += purchasePrice * quantityUsed;
                        totalSellingPrice += sellingPrice * quantityUsed;

                        if (!productSales[productName]) {
                            productSales[productName] = { quantitySold: 0 };
                        }
                        productSales[productName].quantitySold += quantityUsed;
                    });
                }

                const customer = invoice.customerName || 'N/A';
                const invoiceProfit = parseFloat(invoice.totalProfit || 0);

                if (!customerActivity[customer]) {
                    customerActivity[customer] = { invoiceCount: 0, totalProfit: 0 };
                }
                customerActivity[customer].invoiceCount += 1;
                customerActivity[customer].totalProfit += invoiceProfit;
            });

            document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCost.toFixed(2)} DH`;
            document.getElementById('totalSellingPrice').textContent = `${totalSellingPrice.toFixed(2)} DH`;
            document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`;
            document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`;
            document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`;
            document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
            document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;
            document.getElementById('invoiceCount').textContent = invoiceCount;


            const topSellingProductsList = document.getElementById('topSellingProducts');
            topSellingProductsList.innerHTML = '';
            const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b.quantitySold - a.quantitySold).slice(0, 5);
            if (sortedProducts.length > 0) {
                sortedProducts.forEach(([name, stats]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><strong>${name}</strong></span>
                        <span>${stats.quantitySold} وحدات</span>
                    `;
                    topSellingProductsList.appendChild(li);
                });
            } else {
                topSellingProductsList.innerHTML = '<li>لا توجد بيانات</li>';
            }

            const topCustomersList = document.getElementById('topCustomers');
            topCustomersList.innerHTML = '';
            const sortedCustomers = Object.entries(customerActivity).sort(([, a], [, b]) => b.invoiceCount - a.invoiceCount).slice(0, 5);
            if (sortedCustomers.length > 0) {
                sortedCustomers.forEach(([name, stats]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><strong>${name}</strong></span>
                        <span>${stats.invoiceCount} فواتير</span>
                    `;
                    topCustomersList.appendChild(li);
                });
            } else {
                topCustomersList.innerHTML = '<li>لا توجد بيانات</li>';
            }
        }


        /* --- Local Invoice Archive Functions --- */

        /**
         * Saves an invoice to Local Storage.
         * @param {object} invoiceData - The invoice object to save.
         */
        function saveInvoiceToLocalStorage(invoiceData) {
            let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
            localInvoices.push(invoiceData);
            localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
            showToast("تم حفظ الفاتورة محلياً.", 'success');
        }

        /**
         * Displays local invoices from Local Storage.
         */
        function displayLocalInvoices() {
            allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
            localInvoicesList.innerHTML = '';

            const searchTerm = searchLocalInvoiceInput.value.toLowerCase();

            const filteredInvoices = allLocalInvoices.filter(invoice => {
                const matchesSearch = searchTerm ?
                    (invoice.customerName && invoice.customerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.ownerName && invoice.ownerName.toLowerCase().includes(searchTerm)) ||
                    (invoice.date && invoice.date.toLowerCase().includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => p.name.toLowerCase().includes(searchTerm)))
                    : true;
                return matchesSearch;
            });

            if (filteredInvoices.length === 0) {
                localInvoicesList.innerHTML = '<p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>';
                return;
            }

            // Sort by date (newest first)
            filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date));

            filteredInvoices.forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.classList.add('local-invoice-item');

                invoiceDiv.innerHTML = `
                    <div class="invoice-summary-details">
                        <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                        <p><strong>تاريخ الفاتورة:</strong> ${invoice.date || 'N/A'}</p>
                        <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                        <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                    </div>
                    <div class="invoice-actions">
                        <button type="button" class="btn1" onclick="viewLocalInvoiceDetails(${invoice.id})">عرض التفاصيل</button>
                        <button type="button" class="btn-delete" onclick="deleteLocalInvoice(${invoice.id})">حذف</button>
                    </div>
                `;
                localInvoicesList.appendChild(invoiceDiv);
            });
        }

        /**
         * Views the details of a specific local invoice.
         * @param {number} invoiceId - The ID of the invoice to view.
         */
        function viewLocalInvoiceDetails(invoiceId) {
            const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);

            if (invoiceToView) {
                // Populate the invoice display section
                document.getElementById('displayCustomerName').textContent = invoiceToView.customerName;
                document.getElementById('displayInvoiceOwner').textContent = invoiceToView.ownerName;
                document.getElementById('displayInvoiceDate').textContent = invoiceToView.date;
                // Set datetime attribute for the <time> element when viewing archived invoice
                document.getElementById('displayInvoiceDate').setAttribute('datetime', invoiceToView.isoDate || invoiceToView.date);

                document.getElementById('displayTotalAmountBeforeCommission').textContent = parseFloat(invoiceToView.totalHTBeforeCommission || 0).toFixed(2) + ' DH';
                document.getElementById('displayCommissionDeducted').textContent = parseFloat(invoiceToView.totalCommission || 0).toFixed(2) + ' DH';
                document.getElementById('displayTotalAmount').textContent = parseFloat(invoiceToView.totalHT || 0).toFixed(2) + ' DH';
                document.getElementById('displayTVA').textContent = parseFloat(invoiceToView.tva || 0).toFixed(2) + ' DH';
                document.getElementById('displayTotalTTC').textContent = parseFloat(invoiceToView.totalTTC || 0).toFixed(2) + ' DH';

                document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceToView.ownerPhone;
                document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceToView.ownerAddress;

                const detailsTbody = document.getElementById('displayDetails');
                detailsTbody.innerHTML = '';
                let productNumber = 1;
                invoiceToView.products.forEach(productData => {
                    const productDetails = document.createElement('tr');
                    productDetails.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${productData.name}</td>
                        <td>${parseFloat(productData.sellingPrice).toFixed(2)} DH</td>
                        <td>${productData.quantityUsed}</td>
                        <td>${(parseFloat(productData.sellingPrice) * productData.quantityUsed).toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetails);
                });

                showSection(invoiceDisplay); // Use the new showSection function
                mainContainer.classList.remove('full-width'); // Invoice display doesn't need full width
                // Hide "Update Stock" button as this is an archive view and stock update only applies to new invoices
                document.getElementById('savePdfButton').style.display = 'none';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
            }
        }

        /**
         * Deletes a local invoice from Local Storage.
         * @param {number} invoiceId - The ID of the invoice to delete.
         */
        async function deleteLocalInvoice(invoiceId) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟");
            if (confirmed) {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices')) || [];
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي.", 'success');
                displayLocalInvoices(); // Refresh the list
            } else {
                showToast("تم إلغاء حذف الفاتورة.", 'info');
            }
        }

        // Event listener for local invoice search
        searchLocalInvoiceInput.addEventListener('input', displayLocalInvoices);
    </script>
</body>
</html>
