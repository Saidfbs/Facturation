<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المبيعات والمخزون - لوحة معلومات عصرية ومحدثة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* لوحة ألوان حديثة للوحة التحكم */
        :root {
            --primary-blue-dark: #2C3E50; /* أزرق داكن عميق للعناوين الرئيسية والخلفيات الداكنة */
            --primary-blue-medium: #34495E; /* أزرق أفتح قليلاً للعناصر البارزة */
            --primary-blue-light: #5D7A94; /* أزرق فاتح جداً للخلفيات الثانوية */
            --accent-green: #27AE60; /* أخضر حيوي للنجاح والتسليط الضوئي */
            --accent-orange: #F39C12; /* برتقالي دافئ للتحذيرات والأهمية */
            --accent-red: #E74C3C; /* أحمر نقي للأخطاء والإجراءات الخطيرة */
            --background-body: #ECF0F1; /* رمادي فاتح جداً ونظيف لخلفية الصفحة بشكل عام */
            --background-card: #FFFFFF; /* أبيض ناصع لخلفيات البطاقات */
            --text-dark: #34495E; /* أزرق داكن للنصوص الأساسية */
            --text-light: #FFFFFF; /* أبيض للنصوص على الخلفيات الداكنة */
            --border-color: #BDC3C7; /* رمادي متوسط للحدود والفواصل */
            --shadow-color: rgba(0, 0, 0, 0.15); /* ظل أغمق قليلاً لمزيد من العمق */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 14px;
            --border-radius-pill: 999px;
            --shadow-subtle: 0 1px 4px var(--shadow-color);
            --shadow-medium: 0 6px 12px var(--shadow-color);
            --shadow-strong: 0 10px 20px var(--shadow-color);
        }
        /* ضمان عمل سمة 'hidden' بشكل موثوق */
        [hidden] {
            display: none !important;
        }
        /* الأنماط الأساسية وإعادة التعيين */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif; /* استخدام خط القاهرة لجميع النصوص من أجل الاتساق ودعم اللغة العربية */
            direction: rtl; /* تعيين الاتجاه من اليمين إلى اليسار للغة العربية */
            background-color: var(--background-body); 
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            color: var(--text-dark);
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease; /* انتقال سلس للثيم */
        }
        body {
            padding: var(--spacing-md); 
            padding-bottom: calc(var(--spacing-md) + 60px); /* مسافة لشريط التنقل السفلي في الجوال */
        }
        /* عناصر التحكم الرئيسية للتنقل (شريط علوي لسطح المكتب، مخفي في الجوال) */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            padding: var(--spacing-sm);
            background-color: var(--primary-blue-dark); 
            border-radius: var(--border-radius-md); 
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
            display: none; /* مخفي افتراضياً، يظهر على سطح المكتب */
            transition: background-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .main-controls .btn-panel {
            flex: 1 1 auto;
            max-width: 200px;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-lg);
            text-align: center;
            background-color: var(--primary-blue-medium); 
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            font-weight: bold;
            font-size: 1em;
            box-shadow: var(--shadow-subtle);
            outline: none;
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-decoration: none; /* إزالة التسطير من الأزرار التي تشبه الروابط */
        }
        .main-controls .btn-panel .icon {
            font-size: 1.2em;
            line-height: 1;
        }
        .main-controls .btn-panel:hover {
            background-color: var(--primary-blue-light); /* ظل أفتح عند التحويم */
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .main-controls .btn-panel:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }
        .main-controls .btn-panel:focus-visible {
            outline: 2px solid var(--text-light);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(44, 62, 80, 0.4); /* ظل تركيز أزرق أغمق */
        }
        /* حالة الزر النشط - محسّنة */
        .main-controls .btn-panel.active {
            background-color: var(--background-card); /* خلفية بيضاء للزر النشط */
            color: var(--primary-blue-dark); /* نص بلون أساسي للزر النشط */
            box-shadow: var(--shadow-strong); /* ظل أقوى */
            transform: translateY(-4px); /* رفع أكثر وضوحاً */
            border: 2px solid var(--accent-green); /* حدود بلون التمييز */
        }
        .main-controls .btn-panel.active:hover {
            background-color: var(--background-card); /* الحفاظ على اللون الأبيض عند التحويم */
            transform: translateY(-4px); /* الحفاظ على الرفع */
        }
        /* شريط التنقل السفلي (ثابت في الجوال) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-blue-dark);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--spacing-sm) 0;
            box-shadow: 0 -4px 15px var(--shadow-color); /* ظل أقوى */
            z-index: 1000;
            display: none; /* مخفي افتراضياً، يظهر على الجوال */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .bottom-nav .nav-button {
            background: none;
            border: none;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xs);
            gap: var(--spacing-xs);
            font-size: 0.85em;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease;
            border-radius: var(--border-radius-md);
            flex: 1; 
            max-width: 120px; 
            position: relative; /* لتأثير التموج */
            overflow: hidden;
        }
        .bottom-nav .nav-button .icon {
            font-size: 1.8em;
            line-height: 1;
        }
        .bottom-nav .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.15); /* تحويم أكثر وضوحاً */
            transform: translateY(-3px);
        }
        /* تأثير التموج لأزرار التنقل في الجوال */
        .bottom-nav .nav-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, var(--text-light) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .bottom-nav .nav-button:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }
        /* زر التنقل النشط في الجوال - محسّن */
        .bottom-nav .nav-button.active {
            color: var(--accent-green); /* لون التمييز لزر التنقل النشط في الجوال */
            background-color: var(--primary-blue-medium);
            transform: translateY(-6px); /* رفع أكثر لزر النشط */
            box-shadow: inset 0 2px 8px var(--shadow-color), 0 6px 20px var(--shadow-color); /* ظل محسّن */
        }
        .bottom-nav .nav-button.active .icon {
            transform: scale(1.25); /* تكبير الأيقونة أكثر للحالة النشطة */
            transition: transform 0.3s ease;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 1200px; 
            margin: 0 auto;
            transition: max-width 0.3s ease, padding 0.3s ease; 
        }
        /* الحد الأقصى للعرض للأقسام كاملة العرض */
        .container.full-width {
            max-width: 100%; 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            box-sizing: border-box;
        }
        /* ضمان تمدد العناصر الفرعية المباشرة للحاوية كاملة العرض وتوفر مسافة داخلية */
        .container.full-width > section,
        .container.full-width > article {
            padding-left: var(--spacing-md); 
            padding-right: var(--spacing-md);
            box-sizing: border-box;
            flex-grow: 1; 
        }
        /* أنماط الحاوية الموحدة - لجميع أقسام المحتوى الرئيسية (البطاقات) */
        .product-container,
        .client-container,
        .invoice,
        .saved-products,
        .local-archive-container,
        .statistics-section,
        .firebase-product-list-wrapper {
            border: 1px solid var(--border-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card); 
            box-shadow: var(--shadow-subtle);
            margin-bottom: 0; 
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 100%;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* هذا هو التعديل الرئيسي لجعل "أرشيف الفواتير المحلية" دائماً بعرض محدود ومتوسط */
        .local-archive-container {
            max-width: 700px; /* تحديد أقصى عرض للحاوية بأكملها (يمكن تعديل القيمة) */
            margin-left: auto; /* توسيط الحاوية أفقياً */
            margin-right: auto;
            /* مع width: 100% من الأنماط العامة، ستكون متجاوبة (تصغر على الشاشات الصغيرة) */
        }

        /* نمط خاص للحاوية المدمجة لإحصائيات Firebase الرئيسية (غلاف شفاف) */
        .firebase-stats-combined-container {
            background-color: transparent; 
            box-shadow: none; 
            border: none; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-md); 
        }
        /* الفئة لتطبيق الرسوم المتحركة عند إخفاء/إظهار الأقسام */
        .fade-in-section {
            opacity: 0;
            transform: translateY(15px); /* تبدأ من الأسفل قليلاً */
            transition: opacity 0.6s ease-out, transform 0.6s ease-out; /* انتقال أبطأ وأكثر سلاسة */
        }
        .fade-in-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* أنماط عرض لوحة التحكم */
        .dashboard-view {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            align-items: flex-start;
            width: 100%;
        }
        /* العناوين الموحدة */
        .dashboard-view h1,
        .firebase-stats-combined-container h1,
        .local-archive-container h1,
        .invoice h1 {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-bottom: var(--spacing-xl);
            font-size: 2.4em; /* أكبر قليلاً */
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-blue-light);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }
        .dashboard-view h2,
        .firebase-stats-combined-container h2,
        .local-archive-container h2,
        .client-container h2,
        .product-container h2,
        .invoice h2 {
            width: 100%;
            text-align: center;
            color: var(--primary-blue-dark);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 2em; /* أكبر قليلاً */
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-blue-light);
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }
        .dashboard-view h2 .icon,
        .firebase-stats-combined-container h2 .icon,
        .local-archive-container h2 .icon,
        .client-container h2 .icon,
        .product-container h2 .icon,
        .invoice h2 .icon {
            font-size: 1.3em; /* أيقونة أكبر قليلاً */
            line-height: 1;
        }
        /* العناوين الفرعية للقوائم/الأقسام داخل الحاويات الرئيسية */
        .dashboard-view h3,
        .statistics-section h3,
        .firebase-product-list-wrapper h3,
        #dynamicStatsListContainer > div h3 {
            color: var(--primary-blue-medium); /* عنوان فرعي أغمق */
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            font-size: 1.6em; /* أكبر قليلاً */ 
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color); 
            text-align: center;
            width: 100%; 
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }
        /* تجاوز خاص لـ h3 في بطاقة الإحصائيات - صغير، بدون حدود، نص داكن */
        .stat-card h3 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2em; /* مُعدّل للاتساق */
            color: var(--text-dark);
            border-bottom: none;
            padding-bottom: 0;
        }
        /* ضبط عروض الحاويات الفردية داخل عرض لوحة التحكم */
        .dashboard-view > .product-container,
        .dashboard-view > .client-container {
            flex: 1 1 48%;
            min-width: 350px; 
        }
        /* قائمة المنتجات المحفوظة أسفل النماذج */
        .dashboard-view > .saved-products {
            flex: 1 1 100%; 
            margin-top: var(--spacing-md);
        }
        /* تخطيط حاوية Firebase/الإحصائيات المدمجة - هذا هو غلاف الإحصائيات وقائمة المنتجات */
        .firebase-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md); 
            width: 100%;
            flex-grow: 1; 
        }
        /* نمط لمرشحات قائمة منتجات Firebase (الآن داخل firebase-product-list-wrapper) */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            margin-bottom: var(--spacing-md);
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }
        /* أنماط القوائم التي يجب أن تعرض كل المحتوى بدون تمرير (المنتجات المحفوظة، منتجات Firebase) */
        .saved-products3,
        #productListContainerdata {
            flex-grow: 1;
            overflow-y: visible; /* ضمان رؤية المحتوى بالكامل */
            max-height: none;  /* السماح للمحتوى بتحديد الارتفاع */
            padding-right: 0;  /* لا يوجد حشو لشريط التمرير */
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid; /* استخدام شبكة لتخطيط بطاقة المنتج */
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card);
            padding: var(--spacing-md);
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        /* تخطيطات الأعمدة المحددة لهذه القوائم غير القابلة للتمرير */
        .saved-products3 {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
        #productListContainerdata {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        /* أنماط القوائم التي يجب أن يكون لها ارتفاع ثابت وقابلة للتمرير (الفواتير المحلية) */
        .local-invoices-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            -webkit-overflow-scrolling: touch;
            display: grid;
            gap: var(--spacing-md);
            align-content: start;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card);
            padding: var(--spacing-md);
            box-sizing: border-box;
            max-height: 450px; /* يمكن تعديل هذا الارتفاع حسب الحاجة */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-blue-light) var(--background-body);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            
            /* هذا يضمن عموداً واحداً دائماً */
            grid-template-columns: 1fr;
            justify-items: center; /* لتوسيط العناصر داخل العمود */
        }
        .local-invoices-list::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .local-invoices-list::-webkit-scrollbar-track {
            background: var(--background-body);
            border-radius: 10px;
        }
        .local-invoices-list::-webkit-scrollbar-thumb {
            background: var(--primary-blue-light);
            border-radius: 10px;
            border: 2px solid var(--background-body);
            transition: background-color 0.3s ease;
        }
        .local-invoices-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue-medium);
        }
        /* أنماط لـ .scrollable-list-in-card (تستخدم لقوائم الإحصائيات الديناميكية) - مظهر مكدس */
        .scrollable-list-in-card {
            padding-left: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--background-body); /* خلفية مختلفة قليلاً للتمييز البصري */
            margin-top: var(--spacing-sm);
            
            display: flex;
            flex-direction: column; /* تكديس العناصر عمودياً */
            flex-wrap: nowrap; /* منع الالتفاف الأفقي */
            gap: var(--spacing-xs); /* مسافة أصغر بين عناصر القائمة المكدسة */
            justify-content: flex-start;
            align-items: stretch; /* جعل العناصر تمتد لملء عرض الحاوية */
            padding: var(--spacing-md);
            list-style: none;
            margin-right: 0;
            margin-left: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-blue-light) var(--background-body);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .scrollable-list-in-card::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-list-in-card::-webkit-scrollbar-track {
            background: var(--background-body);
            border-radius: 10px;
        }
        .scrollable-list-in-card::-webkit-scrollbar-thumb {
            background: var(--primary-blue-light);
            border-radius: 10px;
            border: 2px solid var(--background-body);
            transition: background-color 0.3s ease;
        }
        .scrollable-list-in-card::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue-medium);
        }
        .scrollable-list-in-card li {
            background-color: var(--background-card);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column; /* تكديس عناصر Span داخل LI */
            justify-content: center;
            align-items: flex-end; /* محاذاة المحتوى إلى اليمين لـ RTL */
            width: 100%; /* جعل عنصر القائمة يأخذ العرض الكامل */
            box-sizing: border-box;
            text-align: right; /* محاذاة النص داخل LI */
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease, border-color 0.3s ease;
        }
        .scrollable-list-in-card li:hover { 
            background-color: #e8ebf0; /* تأثير تحويم خفيف */
            box-shadow: var(--shadow-medium); /* ظل أقوى عند التحويم */
            transform: translateY(-1px); /* رفع خفيف عند التحويم */
        }
        .scrollable-list-in-card li:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }
        .scrollable-list-in-card li span {
            display: block; /* كل عنصر Span في سطر خاص به */
            text-align: right; /* ضمان محاذاة النص إلى اليمين */
            white-space: normal;
            word-break: break-word;
        }
        .scrollable-list-in-card li span:first-child {
            font-weight: bold;
            color: var(--primary-blue-dark); /* الاسم الرئيسي باللون الأساسي */
            margin-bottom: var(--spacing-xs);
            font-size: 1.1em;
        }
        .scrollable-list-in-card li span:last-child {
            font-weight: normal; 
            font-size: 0.95em;
            color: var(--text-dark);
            flex-shrink: 0;
        }
        /* جعل #dynamicStatsListContainer شبكة لعناصرها الفرعية (بطاقات قائمة الإحصائيات الفردية) */
        #dynamicStatsListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: var(--spacing-md);
            flex: 1 1 auto; 
        }
        /* أنماط بطاقات القوائم الديناميكية الفردية (مثل أفضل المنتجات، أفضل العملاء) */
        #dynamicStatsListContainer > div {
            background-color: var(--background-card); 
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-subtle);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* أنماط خاصة بالرسوم البيانية */
        .chart-container {
            position: relative;
            height: 200px; /* ارتفاع ثابت للرسوم البيانية */
            width: 100%;
            margin-top: var(--spacing-md);
        }
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: center;
        }
        p {
            margin: 0;
            padding: 0;
        }
        .form-group {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
            position: relative;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: var(--text-dark);
            font-size: 0.95em;
            transition: color 0.3s ease;
        }
        .form-group label.required::after {
            content: ' *';
            color: var(--accent-red); /* لون الخطأ للمطلوب */
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--background-card); 
            border-radius: var(--border-radius-sm); 
            border: 1px solid var(--border-color);
            margin-bottom: 0;
            font-size: 1em;
            color: var(--text-dark);
            outline: none;
            transition: all 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-blue-medium); 
            box-shadow: 0 0 0 3px rgba(52, 73, 94, 0.3); /* ظل أزرق أغمق عند التركيز */
            transform: scale(1.005);
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown),
        .form-group input.error, .form-group select.error {
            border-color: var(--accent-red);
        }
        .form-group .validation-error-message {
            color: var(--accent-red);
            font-size: 0.85em; /* أكبر قليلاً لسهولة القراءة */
            padding-right: var(--spacing-xs);
            margin-top: 5px;
            display: none;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }
        .form-group input[required]:invalid:not(:focus):not(:placeholder-shown) + .validation-error-message,
        .form-group input.error + .validation-error-message, .form-group select.error + .validation-error-message {
            display: flex;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        /* أنماط الأزرار العامة */
        .btn, .btn1, .btn2, .btn-delete, .btn-edit, .btn-add-to-local {
            display: flex;
            flex: 1;
            height: 50px;
            padding: 1rem 0;
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-pill);
            text-align: center;
            margin-bottom: 0;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease, color 0.3s ease;
            box-shadow: var(--shadow-medium); /* ظل متوسط افتراضي */
            font-size: 0.95em;
            outline: none;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            background-image: linear-gradient(135deg, var(--primary-blue-medium), var(--primary-blue-dark)); /* تدرج لوني خفيف */
        }
        .btn:focus-visible, .btn1:focus-visible, .btn2:focus-visible, .btn-delete:focus-visible, .btn-edit:focus-visible, .btn-add-to-local:focus-visible {
            outline: 2px solid var(--primary-blue-dark);
            outline-offset: 3px; /* حدود خارجية أكثر وضوحاً */
            box-shadow: 0 0 0 5px rgba(44, 62, 80, 0.4); /* ظل تركيز أقوى */
        }
        .btn {
            background-color: var(--primary-blue-dark); /* Fallback */
            background-image: linear-gradient(135deg, var(--primary-blue-medium), var(--primary-blue-dark));
        }
        .btn:hover { 
            background-image: linear-gradient(135deg, var(--primary-blue-dark), var(--primary-blue-medium)); /* تدرج معكوس عند التحويم */
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn:active { 
            transform: translateY(0); 
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), var(--primary-blue-dark)); /* لون صلب عند النشاط */
        }
        .btn1, .btn2 {
            background-color: var(--accent-green);
            background-image: linear-gradient(135deg, var(--accent-green), #219d55); /* تدرج أخضر */
        }
        .btn1:hover, .btn2:hover { 
            background-image: linear-gradient(135deg, #219d55, var(--accent-green)); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-strong); 
        }

        .btn1:active, .btn2:active { 
            transform: translateY(0); 
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, #219d55, #219d55);
        }
        .btn-delete {
            background-color: var(--accent-red);
            background-image: linear-gradient(135deg, var(--accent-red), #c0392b); /* تدرج أحمر */
            margin-top: var(--spacing-sm);
        }
        .btn-delete:hover { 
            background-image: linear-gradient(135deg, #c0392b, var(--accent-red)); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-strong); 
        }

        .btn-delete:active { 
            transform: translateY(0); 
            box-shadow: var(--shadow-subtle);
            background-image: linear-gradient(135deg, #c0392b, #c0392b);
        }
        .btn-edit {
            background-color: var(--accent-orange);
            background-image: linear-gradient(135deg, var(--accent-orange), #e67e22); /* تدرج برتقالي */
            color: var(--text-dark); /* نص داكن على البرتقالي */
            margin-top: var(--spacing-sm);
        }
        .btn-edit:hover { 
            background-image: linear-gradient(135deg, #e67e22, var(--accent-orange)); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-strong); 
        }

        .btn-edit:active { 
            transform: translateY(0); 
            box-shadow: var(--shadow-subtle); 
            background-image: linear-gradient(135deg, #e67e22, #e67e22);
        }
        .btn-add-to-local {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-medium), var(--primary-blue-dark));
            color: var(--text-light);
        }
        .btn-add-to-local:hover {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), var(--primary-blue-medium));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }
        .btn-add-to-local:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }
        /* أنماط خاصة بالفاتورة (العرض الكامل) */
        .invoice-main-header { /* تم تغيير اسم الكلاس ليكون أكثر وضوحاً */
            border: none;
            background-color: var(--background-body); /* خلفية أفتح لهذه الأقسام */
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            transition: background-color 0.3s ease;
            display: flex; /* استخدام فليكس بوكس لترتيب المعلومات */
            flex-direction: column; /* الترتيب الافتراضي عمودي */
            gap: var(--spacing-sm);
            align-items: flex-end; /* محاذاة لليمين لـ RTL */
        }

        .invoice-main-header h2 { /* عنوان تفاصيل العميل */
            width: 100%;
            text-align: center;
            border-bottom: 1px dashed var(--border-color); /* خط متقطع */
            padding-bottom: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            color: var(--primary-blue-dark);
        }

        .invoice-main-header p {
            width: 100%; /* جعل كل فقرة تأخذ عرض كامل على الشاشات الصغيرة */
            text-align: right; /* محاذاة لليمين */
            font-size: 1em;
            color: var(--text-dark);
        }

        /* تحسين مظهر جدول ملخص الفاتورة */
        .invoice-summary-section { /* تم تغيير اسم الكلاس ليكون أكثر وضوحاً */
            background-color: var(--background-body);
            text-align: center;
            padding: var(--spacing-md); /* زيادة الحشوة */
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
            transition: background-color 0.3s ease;
        }
        .invoice-summary-section table {
            width: 100%;
            margin: 0 auto;
            border-collapse: separate; /* استخدام هذا مع border-spacing */
            border-spacing: 0 5px; /* مسافة بين الصفوف */
        }
        .invoice-summary-section tfoot tr td {
            text-align: right;
            font-weight: bold;
            padding: 0.5rem 1rem; /* زيادة الحشوة */
            color: var(--text-dark);
            background-color: var(--background-card); /* خلفية بيضاء لكل صف ملخص */
            border-radius: var(--border-radius-sm); /* حواف مستديرة لصفوف الملخص */
            box-shadow: var(--shadow-subtle); /* ظل خفيف لكل صف */
        }
        .invoice-summary-section tfoot tr:last-child td {
            background-color: var(--primary-blue-medium); /* لون مميز للإجمالي الكلي */
            color: var(--text-light);
            font-size: 1.1em;
            box-shadow: var(--shadow-medium);
        }
        /* غلاف الجدول المتجاوب */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            background-color: var(--background-card);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--background-card);
            font-size: 0.95em;
            border: none;
        }
        .invoice-table th,
        .invoice-table td {
            border: 1px solid var(--border-color);
            padding: 0.6rem;
            text-align: right;
            white-space: nowrap;
            transition: border-color 0.3s ease, color 0.3s ease;
        }
        .invoice-table th {
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #displayTotalAmountBeforeCommission,
        #displayCommissionDeducted,
        #displayTotalAmount,
        #displayTVA,
        #displayTotalTTC {
            text-align: left;
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.1em;
        }
        .invoice p {
            margin: 5px 0;
            line-height: 1.6;
            color: var(--text-dark);
        }
        .invoice .divider {
            border-top: 1px dashed var(--border-color);
            margin: var(--spacing-lg) 0;
            transition: border-color 0.3s ease;
        }
        /* بطاقات المنتج/العناصر الموحدة */
        .product {
            border: 1px solid var(--border-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md); 
            background-color: var(--background-card); 
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            text-align: right;
            font-size: 0.95em;
            line-height: 1.5;
            position: relative; 
            overflow: hidden;
        }
        .product:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
        }
        /* مؤشرات الحالة لبطاقات المنتج (الحد الأيسر) */
        .product::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0; /* محاذاة إلى اليسار لـ RTL */
            width: 8px;
            height: 100%;
            border-radius: var(--border-radius-md) 0 0 var(--border-radius-md);
            transition: background-color 0.3s ease;
        }
        /* أنماط بطاقات الفواتير المصغرة في الأرشيف المحلي */
        .local-invoice-item {
            border: 1px solid var(--border-color);
            border-right: 5px solid var(--primary-blue-light); /* حدود مميزة للفواتير */
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background-color: var(--background-card);
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            text-align: right;
            font-size: 0.85em; /* حجم خط أساسي أصغر للفواتير المصغرة */
            line-height: 1.4;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            /* تحديد أقصى عرض للبطاقة نفسها (لتجنب التمدد المفرط داخل العمود الواحد) */
            max-width: 500px; /* يمكنك تعديل هذا الرقم لضبط عرض البطاقة الفردية */
            margin: 0 auto; /* توسيط البطاقة الفردية داخل العمود */
        }
        .local-invoice-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-strong);
            border-right-color: var(--accent-green); /* تسليط الضوء عند التحويم */
        }

        
        .local-invoice-item .invoice-mini-header p,
        .local-invoice-item .invoice-mini-footer p {
            margin: 2px 0;
            color: var(--text-dark);
        }
        .local-invoice-item .invoice-mini-header p strong {
            color: var(--primary-blue-dark);
            font-size: 1.1em;
        }
        .local-invoice-item .invoice-mini-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.8em;
        }
        .local-invoice-item .invoice-mini-table th,
        .local-invoice-item .invoice-mini-table td {
            border: 1px solid var(--border-color);
            padding: 4px 6px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* اقتطاع النص الطويل */
        }
        .local-invoice-item .invoice-mini-table th {
            background-color: var(--primary-blue-light);
            color: var(--text-light);
            font-weight: bold;
        }
        .local-invoice-item .invoice-mini-table tbody tr:nth-child(odd) {
            background-color: var(--background-body); /* تلوين صفوف بديل */
        }
        .local-invoice-item .invoice-mini-footer {
            border-top: 1px dashed var(--border-color);
            padding-top: var(--spacing-sm);
            text-align: right;
            margin-top: var(--spacing-sm);
        }
        .local-invoice-item .invoice-mini-footer p strong {
            color: var(--accent-green);
            font-size: 1.1em;
        }
        .local-invoice-item .invoice-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        .local-invoice-item .invoice-actions .btn-delete {
            flex: 0 0 auto;
            width: fit-content;
            padding: 0.5rem 1rem;
            height: auto;
            font-size: 0.8em;
            margin-top: 0;
        }
        /* أنماط خاصة بالمنتجات المحلية/المطابقة */
        .product.is-local {
            background-color: var(--background-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: var(--shadow-subtle);
        }
        .product.is-local::before {
            background-color: var(--primary-blue-light);
        }
        .product.is-local p {
            color: var(--text-dark);
        }
        .product.is-local .btn-add-to-local {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-medium), var(--primary-blue-dark));
            color: var(--text-light);
        }
        .product.is-local .btn-add-to-local:hover {
            background-color: var(--primary-blue-dark);
            background-image: linear-gradient(135deg, var(--primary-blue-dark), var(--primary-blue-medium));
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }
        .product.is-local:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }
        .product.is-local-match {
            background-color: var(--accent-green) !important; 
            border-color: var(--accent-green) !important;
            color: var(--text-light) !important;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); /* ظل أخضر */
        }
        .product.is-local-match::before {
            background-color: var(--accent-green);
        }
        .product.is-local-match p {
            color: var(--text-light) !important;
        }
        .product.is-local-match .product-actions button {
            background-color: var(--background-card);
            color: var(--primary-blue-dark);
        }
        .product.is-local-match .product-actions button:hover {
            background-color: var(--background-body);
        }
        /* تفاصيل المنتج والإجراءات داخل البطاقات */
        .product .product-details, .local-invoice-item .invoice-summary-details {
            margin-bottom: var(--spacing-sm);
            flex-grow: 1;
            width: 100%;
        }
        .product .product-details p, .local-invoice-item .invoice-summary-details p {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: var(--text-dark);
        }
        .product .product-details p:first-child strong {
            font-size: 1.2em;
            color: var(--primary-blue-dark);
        }
        .product .product-actions, .local-invoice-item .invoice-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            width: 100%;
            margin-top: var(--spacing-sm);
            justify-content: center;
        }
        .product .product-actions button, .local-invoice-item .invoice-actions button {
            flex: 1 1 48%;
            min-width: 120px;
            height: 45px; 
            padding: 0.8rem 0;
            font-size: 0.9em;
        }
        /* أدوات التحكم بالكمية المشابهة للآلة الحاسبة */
        .quantity-controls {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            width: 100%;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .quantity-controls button {
            width: auto;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background-color: var(--primary-blue-dark);
            color: var(--text-light);
            border: none;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.3s ease;
            outline: none;
            flex-shrink: 0;
            margin-top: 0;
            box-shadow: none;
        }
        .quantity-controls button:first-child {
            border-top-right-radius: var(--border-radius-sm);
            border-bottom-right-radius: var(--border-radius-sm);
        }
        .quantity-controls button:last-child {
            border-top-left-radius: var(--border-radius-sm);
            border-bottom-left-radius: var(--border-radius-sm);
        }
        .quantity-controls button:hover { background-color: var(--primary-blue-medium); }
        .quantity-controls button:active { transform: scale(0.95); }
        .quantity-controls button:focus-visible {
            outline: 2px solid var(--primary-blue-dark);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(44, 62, 80, 0.4);
            z-index: 1;
        }
        .quantity-controls input {
            width: 100%;
            max-width: none;
            height: 45px;
            margin: 0;
            font-size: 1.1em;
            text-align: center;
            border-radius: 0;
            background-color: var(--background-card);
            border: none;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            color: var(--text-dark);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .quantity-controls input:focus {
            border-color: var(--primary-blue-medium);
            box-shadow: inset 0 0 0 2px rgba(52, 73, 94, 0.3);
        }
        /* ألوان حالة المنتج */
        .product.status-insufficient {
            background-color: var(--accent-red) !important;
            color: var(--text-light);
            border-color: var(--accent-red) !important;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }
        .product.status-insufficient::before {
            background-color: var(--accent-red);
        }
        .product.status-insufficient p { color: var(--text-light); }
        .product.status-selected-sufficient {
            background-color: var(--background-body) !important;
            border-color: var(--primary-blue-medium) !important;
            box-shadow: 0 2px 8px rgba(52, 73, 94, 0.3);
        }
        .product.status-selected-sufficient::before {
            background-color: var(--primary-blue-medium);
        }
        .product.status-stock-positive, .product.status-default {
            background-color: var(--background-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: var(--shadow-subtle);
        }
        .product.status-stock-positive::before, .product.status-default::before {
            background-color: var(--accent-green);
        }
        /* حقول البحث */
        #searchProduct, #searchLocalInvoice, #commonSearchInput {
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius-lg); 
            border: 1px solid var(--border-color);
            width: 100%;
            margin-bottom: var(--spacing-md);
            background-color: var(--background-card);
            box-shadow: inset 0 1px 3px var(--shadow-color);
            color: var(--text-dark);
            outline: none;
            text-align: right;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            padding-left: 45px;
            /* استخدام متغير CSS مباشرة في تعبئة SVG (قد يتطلب JS للتوافق الكامل) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2334495E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 18px;
        }
        #searchProduct:focus, #searchLocalInvoice:focus, #commonSearchInput:focus {
            border-color: var(--primary-blue-medium);
            box-shadow: 0 0 0 3px rgba(52, 73, 94, 0.3);
        }
        /* تعديلات حقل البحث مع زر المسح */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }
        .search-input-wrapper input {
            margin-bottom: 0;
        }
        .clear-search-btn {
            background-color: var(--accent-red);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-subtle);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 45px;
        }
        .clear-search-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        /* عناصر التحكم في الفلترة في قسم Firebase */
        .combined-firebase-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            width: 100%;
            padding: var(--spacing-sm);
            background-color: var(--background-body);
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 0 5px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        /* تجاوز المرشحات داخل غلاف قائمة منتجات Firebase لتكون شفافة */
        .firebase-product-list-wrapper > .combined-firebase-filter-controls {
            background-color: transparent;
            box-shadow: none;
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
            border-radius: 0;
        }
        .combined-firebase-filter-controls .form-group {
            flex: 1 1 48%;
            min-width: 250px;
            margin-bottom: 0;
        }
        .combined-firebase-filter-controls .form-group label {
            display: none;
        }
        /* أنماط عنصر التحديد (للقوائم المنسدلة) */
        .combined-firebase-filter-controls select {
            width: 100%;
            padding: 0.8rem 1rem;
            box-sizing: border-box;
            background-color: var(--background-card);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            font-size: 1em;
            color: var(--text-dark);
            outline: none;
            text-align: right;
            appearance: none;
            /* استخدام متغير CSS مباشرة في تعبئة SVG */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2334495E%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%00-13.2-5.4H18.6c-5%200-9.3%201.8-13.2%205.4A17.6%2017.6%200%200%000%2082.7c0%204.6%201.8%208.9%205.4%2012.8l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.5a17.6%2017.6%200%200%005.4-12.8c0-4.6-1.8-8.9-5.4-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: left 10px center;
            background-size: 12px;
            padding-left: 30px; 
            padding-right: 0.8rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .combined-firebase-filter-controls select:focus {
            border-color: var(--primary-blue-medium);
            box-shadow: 0 0 0 2px rgba(52, 73, 94, 0.3);
        }
        /* أنماط قسم الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        /* نمط خاص لبطاقات الإحصائيات التي تحتوي على قائمة لتمتد على عرض الشبكة الكامل */
        .stat-card-list {
            grid-column: 1 / -1; 
            display: flex; 
            flex-wrap: wrap;
            gap: var(--spacing-md); 
            align-items: stretch; 
            width: 100%;
        }
        /* بطاقات الإحصائيات الفردية - محسّنة */
        .stat-card {
            background: linear-gradient(135deg, var(--background-card), var(--background-body)); /* تدرج خفيف */
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 auto; 
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-medium);
        }
        /* العنصر المرئي خلف الأرقام */
        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px; /* الموضع لـ RTL */
            width: 80px;
            height: 80px;
            background-color: var(--primary-blue-light);
            border-radius: var(--border-radius-pill);
            opacity: 0.1;
            transform: scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
        }
        .stat-card:hover::before {
            transform: scale(1);
        }
        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-blue-dark);
            margin: 0;
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums;
        }
        .stat-card h3 {
            font-size: 1.2em;
            color: var(--text-dark);
            margin-bottom: var(--spacing-sm);
            position: relative;
            z-index: 1;
        }
        /* إشعارات التوست */
        #toast-container {
            position: fixed;
            bottom: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            pointer-events: none;
            align-items: center;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            padding: var(--spacing-md);
        }
        .toast {
            background-color: var(--background-card);
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-medium);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeinout 4s forwards;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
            direction: rtl;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .toast.success { border-right: 5px solid var(--accent-green); border-left: none;}
        .toast.error { border-right: 5px solid var(--accent-red); border-left: none;}
        .toast.info { border-right: 5px solid var(--primary-blue-medium); border-left: none;}
        .toast .icon { font-size: 1.5em; line-height: 1; }
        .toast.success .icon { color: var(--accent-green); }
        .toast.error .icon { color: var(--accent-red); }
        .toast.info .icon { color: var(--primary-blue-medium); }
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        /* نافذة التأكيد المخصصة */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #confirm-modal-dialog {
            background-color: var(--background-card);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px var(--shadow-color);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            direction: rtl;
        }
        #confirm-modal-overlay.active #confirm-modal-dialog { transform: scale(1); }
        #confirm-modal-dialog h3 {
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.6em;
        }
        #confirm-modal-dialog p {
            color: var(--text-dark);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }
        #confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
        }
        #confirm-modal-buttons button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-pill);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #confirm-yes-btn { background-color: var(--primary-blue-medium); color: var(--text-light); }
        #confirm-yes-btn:hover { background-color: var(--primary-blue-dark); }
        #confirm-no-btn { background-color: var(--border-color); color: var(--text-dark); }
        #confirm-no-btn:hover { background-color: #aeb5bb; } /* رمادي أغمق عند التحويم */
        /* استعلامات الوسائط للاستجابة */
        @media (min-width: 769px) {
            .main-controls {
                display: flex;
            }
            .bottom-nav {
                display: none;
            }
            body {
                padding-bottom: var(--spacing-md);
            }
            /* ترتيب تفاصيل الفاتورة في عمودين على الشاشات الكبيرة */
            .invoice-details-grid {
                grid-template-columns: 1fr 1fr;
            }
            .invoice-main-header p {
                width: auto; /* السماح للعناصر بأن تأخذ عرضها الطبيعي في الشبكة */
                text-align: right; /* الحفاظ على المحاذاة لليمين */
            }
        }
        @media (max-width: 1024px) {
            .container { max-width: 960px; }
            .main-controls .btn-panel { font-size: 0.9em; padding: 0.6rem 0.8rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); }
            .stat-card h3 { font-size: 1em; }
            .stat-card p { font-size: 1.4em; }
            #dynamicStatsListContainer {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }
        @media (max-width: 768px) {
            body { padding: var(--spacing-sm); padding-bottom: calc(var(--spacing-sm) + 60px); }
            .main-controls { display: none; }
            .bottom-nav { display: flex; }
            .container { max-width: 100%; }
            .dashboard-view > .product-container, .dashboard-view > .client-container { min-width: unset; flex: 1 1 100%; }
            .invoice h1 { font-size: 1.8em; }
            .invoice h2 { font-size: 1.4em; }
            .invoice-table th, .invoice-table td { padding: 0.5rem; font-size: 0.8em; }
            .saved-products3, #productListContainerdata {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                max-height: none;
                overflow-y: visible;
            }
            .local-invoices-list { 
                /* هذا يضمن عموداً واحداً دائماً */
                grid-template-columns: 1fr; 
                max-height: 200px; /* ارتفاع مقيد على الجوال لتجنب التمرير الزائد */
                overflow-y: auto;
            }
            .stat-card p { font-size: 1.3em; }
            .statistics-section h2 { font-size: 1.5em; }
            .toast { min-width: unset; max-width: 90%; }
            .toast .icon { font-size: 1.2em; }
            .dashboard-view > section { flex: 1 1 100%; }
            .combined-firebase-filter-controls .form-group { min-width: unset; flex: 1 1 100%; }
            .quantity-controls input { width: 60px; margin: 0 5px; }
            .stat-card-list { flex-direction: column; }
            .stat-card-list > div { flex: 1 1 100%; }
            #dynamicStatsListContainer {
                grid-template-columns: 1fr;
            }
            /* تعديل ترتيب عناصر رأس الفاتورة على الشاشات الصغيرة */
            .invoice-main-header {
                align-items: flex-start; /* محاذاة لليسار للشاشات الصغيرة */
                text-align: right; /* الحفاظ على محاذاة النص */
            }
            .invoice-main-header h2 {
                text-align: right;
            }
            .invoice-main-header p {
                text-align: right;
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            body { padding: var(--spacing-sm); padding-bottom: calc(var(--spacing-sm) + 60px); }
            .button-container { flex-direction: column; }
            .btn, .btn1, .btn2, .btn-delete, .btn-edit, .btn-add-to-local { flex: 1 1 100%; }
            .local-invoices-list { 
                grid-template-columns: 1fr;
                max-height: 180px; /* تقييد الارتفاع أكثر على الشاشات الأصغر جداً */
                overflow-y: auto;
            }
            .dashboard-view h1, .firebase-stats-combined-container h1 { font-size: 1.8em; }
            .dashboard-view h2, .firebase-stats-combined-container h2 { font-size: 1.5em; }
            .stat-card h3 { font-size: 0.9em; }
            .stat-card p { font-size: 1.2em; }
            .toast { padding: 10px 15px; font-size: 0.9em; }
            .toast .icon { font-size: 1.2em; }
        }
        /* أنماط الطباعة */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
                color: #000;
            }
            .main-controls,
            .bottom-nav,
            .theme-switch-wrapper,
            .invoice-actions-print-group {
                display: none !important;
            }
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 1cm !important;
            }
            .invoice {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background-color: #fff !important;
            }
            .invoice-table {
                border: 1px solid #000 !important;
            }
            .invoice-table th,
            .invoice-table td {
                border: 1px solid #000 !important;
                color: #000 !important;
                background-color: #fff !important;
            }
            .invoice-table th {
                background-color: #f2f2f2 !important;
            }
            #displayTotalAmountBeforeCommission,
            #displayCommissionDeducted,
            #displayTotalAmount,
            #displayTVA,
            #displayTotalTTC {
                color: #000 !important;
            }
            h1, h2, h3 {
                color: #000 !important;
                border-bottom-color: #ccc !important;
            }
            .icon {
                display: none;
            }
            /* إعادة ضبط هوامش وتذييل الفاتورة للطباعة */
            .invoice-main-header,
            .invoice-summary-section,
            .invoice-footer {
                background-color: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
                margin-bottom: 0.5cm !important; /* مسافة للطباعة */
            }
            .invoice-summary-section table {
                border-spacing: 0; /* إزالة المسافة للطباعة */
            }
            .invoice-summary-section tfoot tr td {
                background-color: transparent !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                color: #000 !important;
                padding: 0.3rem 0.5rem !important; /* حشوة أصغر للطباعة */
            }
            .invoice-main-header p {
                margin: 0; /* إزالة الهوامش الزائدة */
            }
            .invoice-main-header {
                display: grid; /* استخدام الشبكة لتوزيع المعلومات */
                grid-template-columns: 1fr 1fr; /* عمودين لملخص رأس الفاتورة */
                gap: 5px 20px; /* مسافة بين العناصر */
                align-items: start;
                text-align: right;
            }
            .invoice-main-header h2 {
                grid-column: 1 / -1; /* جعل العنوان يمتد على كامل العرض */
                text-align: center;
            }
            .invoice-main-header p:nth-of-type(1), /* Nom du client */
            .invoice-main-header p:nth-of-type(2), /* Propriétaire de la facture */
            .invoice-main-header p:nth-of-type(3) /* Date de la facture */ {
                text-align: right; /* محاذاة لليمين */
            }
            /* ضمان تخفيض حجم الخط لتناسب الطباعة */
            .invoice-table th,
            .invoice-table td,
            .invoice-main-header p,
            .invoice-summary-section tfoot tr td,
            .invoice-footer p {
                font-size: 10pt !important; /* حجم خط أصغر للطباعة */
            }
            .invoice h1 {
                font-size: 16pt !important;
            }
            .invoice h2 {
                font-size: 14pt !important;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- JsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
</head>
<body>
    <!-- شريط التنقل العلوي (لشاشات الكمبيوتر اللوحي والكمبيوتر المكتبي) -->
    <header class="main-controls" id="desktopNav">
        <button type="button" class="btn-panel" id="showDashboardButton"><span class="icon">🏠</span>الرئيسية (الإدارة)</button>
        <button type="button" class="btn-panel" id="showFirebaseDataButton"><span class="icon">📊</span>بيانات Firebase</button>
        <button type="button" class="btn-panel" id="showLocalArchiveButton"><span class="icon">🗄️</span>أرشيف الفواتير</button>
    </header>
    <main class="container">
        <!-- لوحة التحكم الرئيسية: إدارة المنتجات، إنشاء الفواتير، أرشيف -->
        <section id="mainDashboardView" class="dashboard-view fade-in-section">
            <h1>لوحة التحكم الرئيسية</h1>
            <!-- قسم إدارة المنتجات -->
            <section class="product-container" id="productFormContainer">
                <h2 id="productFormTitle"><span class="icon">📦</span>إدارة المنتجات</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName" class="required">Nom du produit</label>
                        <input type="text" id="productName" required placeholder="Nom du produit" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>اسم المنتج مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="purchasePrice" class="required">Prix d'achat (DH)</label>
                        <input type="number" id="purchasePrice" required placeholder="Prix d'achat" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>سعر الشراء مطلوب (غير سالب).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="sellingPrice" class="required">Prix de vente (DH)</label>
                        <input type="number" id="sellingPrice" required placeholder="Prix de vente" autocomplete="on" min="0" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>سعر البيع مطلوب (غير سالب).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierName" class="required">Nom du fournisseur</label>
                        <input type="text" id="supplierName" required placeholder="Nom du fournisseur" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>اسم المورد مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierAddress" class="required">Adresse du fournisseur</label>
                        <input type="text" id="supplierAddress" required placeholder="Adresse du fournisseur" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>عنوان المورد مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="supplierPhone" class="required">Téléphone du fournisseur</label>
                        <input type="tel" id="supplierPhone" required placeholder="مثال: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>رقم هاتف المورد مطلوب (10 أرقام).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantité initiale en stock</label>
                        <input type="number" id="productQuantity" placeholder="Quantité" value="0" min="0">
                    </div>
                    <div class="button-container">
                        <button type="submit" class="btn" id="addProduct"><span class="icon">➕</span>إضافة منتج</button>
                        <button type="submit" class="btn" id="saveEditProduct" style="display: none;"><span class="icon">✏️</span>تعديل المنتج</button>
                    </div>
                </form>
            </section>
            <!-- قسم إنشاء الفواتير -->
            <section class="client-container" id="clientFormContainer">
                <h2><span class="icon">📝</span>إنشاء الفواتير</h2>
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="invoiceDate" class="required">Date de la facture</label>
                        <input type="text" id="invoiceDate" required placeholder="Date de la facture" readonly>
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>تاريخ الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="customerName" class="required">Nom du client</label>
                        <input type="text" id="customerName" required placeholder="Nom du client" autocomplete="on" value="CLIENT">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>اسم العميل مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwner" class="required">Nom du Propriétaire de la facture</label>
                        <input type="text" id="invoiceOwner" required placeholder="Nom du Propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>اسم مالك الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerAddress" class="required">Adresse du propriétaire de la facture</label>
                        <input type="text" id="invoiceOwnerAddress" required placeholder="Adresse du propriétaire de la facture" autocomplete="on">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>عنوان مالك الفاتورة مطلوب.
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceOwnerPhone" class="required">Téléphone du propriétaire de la facture</label>
                        <input type="tel" id="invoiceOwnerPhone" required placeholder="مثال: 0612345678" autocomplete="tel" pattern="[0-9]{10}" inputmode="numeric">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>رقم هاتف مالك الفاتورة مطلوب (10 أرقام).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="tva">TVA (%)</label>
                        <input type="number" id="tva" required placeholder="TVA" value="0" min="0" max="100">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>نسبة TVA مطلوبة (بين 0 و 100).
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="invoiceCommissionPercentage">Taux de commission de la facture (%)</label>
                        <input type="number" id="invoiceCommissionPercentage" placeholder="مثال: 10" value="0" min="0" max="100" step="0.01">
                        <span class="validation-error-message">
                            <span class="icon">⚠️</span>نسبة العمولة للفاتورة (بين 0 و 100).
                        </span>
                    </div>
                    <div class="button-container">
                        <button type="button" class="btn" id="createInvoiceButton"><span class="icon">✅</span>إنشاء الفاتورة وعرضها</button>
                    </div>
                </form>
            </section>
            <!-- المنتجات المحفوظة -->
            <section class="saved-products" id="savedProductsDisplay">
                <div class="divider"></div>
                <h2><span class="icon">🛒</span>المنتجات المحفوظة (سلة الفاتورة)</h2>
                <div class="form-group">
                    <label for="searchProduct" class="sr-only">البحث عن منتج</label>
                    <input type="text" id="searchProduct" placeholder="البحث عن منتج">
                </div>
                <div class="saved-products3 product-list-grid" id="savedProductsList"></div>
            </section>
        </section>
        <!-- عرض الفاتورة (مخفي افتراضيًا) -->
        <article class="invoice fade-in-section" id="invoiceDisplay" hidden>
            <h1>DEVIS</h1>
            <section class="invoice-main-header"> <!-- تم تغيير الكلاس هنا -->
                <h2><span class="icon">👤</span>تفاصيل الفاتورة</h2>
                <p>Nom du client: <span id="displayCustomerName"></span></p>
                <p>Date de la facture: <time datetime="" id="displayInvoiceDate"></time></p>
                <p>Propriétaire de la facture: <span id="displayInvoiceOwner"></span></p>
            </section>

            <div class="table-responsive">
                <table class="invoice-table" id="invoiceDetails">
                    <thead>
                        <tr>
                            <th>N°</th>
                            <th>Nom du produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantité</th>
                            <th>Montant HT</th>
                        </tr>
                    </thead>
                    <tbody id="displayDetails">
                    </tbody>
                </table>
            </div>

            <div class="invoice-summary-section"> <!-- تم تغيير الكلاس هنا -->
                <h2><span class="icon">📊</span>ملخص الفاتورة</h2>
                <table>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>المجموع قبل العمولة (HT):</strong></td>
                            <td id="displayTotalAmountBeforeCommission"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>العمولة المخصومة:</strong></td>
                            <td id="displayCommissionDeducted"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>Montant total HT:</strong></td>
                            <td id="displayTotalAmount"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><strong>TVA:</strong></td>
                            <td id="displayTVA"></td>
                        </tr>
                        <tr>
                            <tr>
                            <td colspan="3"><strong>Montant total TTC:</strong></td>
                            <td id="displayTotalTTC"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <footer class="invoice-footer">
                <p>Adresse: <span id="displayInvoiceOwnerAddressFooter"></span></p>
                <p>Téléphone: <span id="displayInvoiceOwnerPhoneFooter"></span></p>
            </footer>

            <!-- أزرار لتحديث المخزون والطباعة -->
            <div class="button-container invoice-actions-print-group">
                <button type="button" class="btn" id="savePdfButton"><span class="icon">📦</span>تحديث المخزون (بعد الفاتورة)</button>
                <button type="button" class="btn" id="printButton"><span class="icon">🖨️</span>طباعة الفاتورة</button>
            </div>
        </article>
        <!-- بيانات Firebase والإحصائيات (مخفي افتراضيًا) -->
        <section class="firebase-stats-combined-container fade-in-section" id="firebaseProductsDisplay" hidden>
            <h1>بيانات Firebase والإحصائيات</h1>
            <div class="firebase-content-wrapper">
                <!-- قسم الإحصائيات -->
                <section class="statistics-section">
                    <h2><span class="icon">📈</span>إحصائيات المبيعات التفصيلية</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>إجمالي سعر الشراء</h3>
                            <p id="totalPurchaseCost">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي سعر البيع</h3>
                            <p id="totalSellingPrice">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي العمولة</h3>
                            <p id="totalCommission">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي الأرباح</h3>
                            <p id="totalProfit">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (HT)</h3>
                            <p id="totalSalesHT">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي TVA</h3>
                            <p id="totalTVA">0.00 DH</p>
                        </div>
                        <div class="stat-card">
                            <h3>إجمالي المبيعات (TTC)</h3>
                            <p id="totalSalesTTC">0.00 DH</p>
                        </div>
                        <div class="stat-card-list">
                            <div id="dynamicStatsListContainer">
                                <div>
                                    <h3>المنتجات الأكثر مبيعاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topSellingProductsChart"></canvas>
                                    </div>
                                    <ul id="topSellingProductsList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>العملاء الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topCustomersChart"></canvas>
                                    </div>
                                    <ul id="topCustomersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>أصحاب الفواتير الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topInvoiceOwnersChart"></canvas>
                                    </div>
                                    <ul id="topInvoiceOwnersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3>الموردون الأكثر نشاطاً</h3>
                                    <div class="chart-container">
                                        <canvas id="topSuppliersChart"></canvas>
                                    </div>
                                    <ul id="topSuppliersList" class="scrollable-list-in-card">
                                        <li>لا توجد بيانات</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-input-wrapper">
                        <input type="text" id="commonSearchInput" placeholder="البحث برقم الهاتف، الاسم، أو المنتج" list="allSearchOptions">
                        <datalist id="allSearchOptions"></datalist>
                        <button type="button" class="clear-search-btn" id="clearCommonSearchInput"><span class="icon">✖</span>مسح</button>
                    </div>
                </section>
                <!-- قسم قائمة منتجات Firebase -->
                <section class="firebase-product-list-wrapper">
                    <h2><span class="icon">☁️</span>قائمة منتجات Firebase (<span id="firebaseProductListCount">0</span>)</h2>
                    <div class="combined-firebase-filter-controls">
                        <div class="form-group">
                            <label for="commonPhoneDropdown" class="sr-only">تصفية حسب رقم الهاتف</label>
                            <select id="commonPhoneDropdown">
                                <!-- سيتم تعبئة خيارات أرقام الهواتف بواسطة JS -->
                            </select>
                        </div>
                    </div>
                    <div class="saved-products3 product-list-grid" id="productListContainerdata"></div>
                </section>
            </div>
        </section>
        <!-- أرشيف الفواتير المحلية (مخفي افتراضيًا) -->
        <section class="local-archive-container fade-in-section" id="localArchiveView" hidden>
            <h1>أرشيف الفواتير المحلية</h1>
            <h2><span class="icon">🗄️</span>الفواتير المحفوظة محلياً</h2>
            <div class="form-group">
                <label for="searchLocalInvoice" class="sr-only">البحث في الفواتير المحلية</label>
                <input type="text" id="searchLocalInvoice" placeholder="البحث في الفواتير المحلية">
            </div>
            <div class="local-invoices-list product-list-grid" id="localInvoicesList">
                <p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>
            </div>
        </section>
    </main>
    <!-- شريط التنقل السفلي (للجوال) -->
    <nav class="bottom-nav" id="mobileNav">
        <button type="button" class="nav-button" id="mobileShowDashboardButton">
            <span class="icon">🏠</span>
            <span>الرئيسية</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowFirebaseDataButton">
            <span class="icon">📊</span>
            <span>البيانات</span>
        </button>
        <button type="button" class="nav-button" id="mobileShowLocalArchiveButton">
            <span class="icon">🗄️</span>
            <span>الأرشيف</span>
        </button>
        <button type="button" class="nav-button" id="mobileCreateInvoiceButton">
            <span class="icon">📝</span>
            <span>فاتورة</span>
        </button>
    </nav>
    <!-- حاوية إشعارات التوست -->
    <div id="toast-container"></div>
    <!-- نافذة التأكيد المخصصة -->
    <div id="confirm-modal-overlay" hidden>
        <div id="confirm-modal-dialog">
            <h3 id="confirm-modal-title">تأكيد الإجراء</h3>
            <p id="confirm-modal-message">هل أنت متأكد من المتابعة؟</p>
            <div id="confirm-modal-buttons">
                <button type="button" id="confirm-yes-btn">نعم</button>
                <button type="button" id="confirm-no-btn">لا</button>
            </div>
        </div>
    </div>
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://said-rahil-default-rtdb.firebaseio.com",
        };
        // تهيئة تطبيق Firebase
        let firebaseApp;
        let database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("فشل تهيئة Firebase:", e);
            showToast("فشل تهيئة Firebase. قد لا تعمل الميزات المتعلقة بالبيانات السحابية.", 'error');
        }
        // معرف التطبيق لأسماء مساحات البيانات في Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ====== مراجع عناصر واجهة المستخدم العامة ======
        const mainDashboardView = document.getElementById('mainDashboardView');
        const productFormContainer = document.getElementById('productFormContainer');
        const clientFormContainer = document.getElementById('clientFormContainer');
        const invoiceDisplay = document.getElementById('invoiceDisplay');
        const firebaseProductsDisplay = document.getElementById('firebaseProductsDisplay');
        const localArchiveView = document.getElementById('localArchiveView');
        const desktopShowDashboardButton = document.getElementById('showDashboardButton');
        const desktopShowFirebaseDataButton = document.getElementById('showFirebaseDataButton');
        const desktopShowLocalArchiveButton = document.getElementById('showLocalArchiveButton');
        const desktopNavButtons = [desktopShowDashboardButton, desktopShowFirebaseDataButton, desktopShowLocalArchiveButton];
        const mobileShowDashboardButton = document.getElementById('mobileShowDashboardButton');
        const mobileShowFirebaseDataButton = document.getElementById('mobileShowFirebaseDataButton');
        const mobileShowLocalArchiveButton = document.getElementById('mobileShowLocalArchiveButton');
        const mobileCreateInvoiceButton = document.getElementById('mobileCreateInvoiceButton');
        const mobileNavButtons = [mobileShowDashboardButton, mobileShowFirebaseDataButton, mobileShowLocalArchiveButton, mobileCreateInvoiceButton];
        const productForm = document.getElementById('productForm');
        const productFormTitle = document.getElementById('productFormTitle'); 
        const productNameInput = document.getElementById('productName');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const supplierNameInput = document.getElementById('supplierName');
        const supplierAddressInput = document.getElementById('supplierAddress');
        const supplierPhoneInput = document.getElementById('supplierPhone');
        const productQuantityInput = document.getElementById('productQuantity');
        
        const invoiceForm = document.getElementById('invoiceForm');
        const customerNameInput = document.getElementById('customerName');
        const invoiceOwnerInput = document.getElementById('invoiceOwner');
        const invoiceOwnerPhoneInput = document.getElementById('invoiceOwnerPhone');
        const invoiceOwnerAddressInput = document.getElementById('invoiceOwnerAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const tvaInput = document.getElementById('tva');
        const invoiceCommissionPercentageInput = document.getElementById('invoiceCommissionPercentage');
        
        const addProductButton = document.getElementById('addProduct');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        const savedProductsList = document.getElementById('savedProductsList');
        const searchProductInput = document.getElementById('searchProduct'); 
        
        const commonPhoneDropdown = document.getElementById('commonPhoneDropdown');
        const commonSearchInput = document.getElementById('commonSearchInput');
        const clearCommonSearchInputButton = document.getElementById('clearCommonSearchInput'); 
        const allSearchOptionsDatalist = document.getElementById('allSearchOptions'); 
        const firebaseProductListCountSpan = document.getElementById('firebaseProductListCount');
        const firebaseProductListContainer = document.getElementById('productListContainerdata');
        const localInvoicesList = document.getElementById('localInvoicesList');
        const searchLocalInvoiceInput = document.getElementById('searchLocalInvoice');
        
        const dynamicStatsListContainer = document.getElementById('dynamicStatsListContainer');
        
        const toastContainer = document.getElementById('toast-container');
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        let confirmResolve; // لحل وعد التأكيد المخصص
        let allFirebaseInvoicesData = []; // ذاكرة تخزين مؤقتة لجميع فواتير Firebase
        let allFirebaseProducts = [];    // ذاكرة تخزين مؤقتة لجميع المنتجات الفردية من فواتير Firebase
        let allLocalInvoices = [];       // ذاكرة تخزين مؤقتة لجميع الفواتير المحلية
        const mainContainer = document.querySelector('main.container');
        let currentEditingProductId = null; // حالة وضع تحرير المنتج
        let isNewInvoice = false; // علامة لتتبع ما إذا كانت الفاتورة الحالية تم إنشاؤها حديثًا
        // مثيلات الرسوم البيانية (لتكون قادرة على تدميرها وإعادة إنشائها)
        let topSellingProductsChartInstance = null;
        let topCustomersChartInstance = null;
        let topInvoiceOwnersChartInstance = null;
        let topSuppliersChartInstance = null;
        // ====== وظائف مساعدة ======
        /**
         * تخفي جميع أقسام المحتوى الرئيسية.
         */
        function hideAllSections() {
            const sectionsToHide = [mainDashboardView, invoiceDisplay, firebaseProductsDisplay, localArchiveView]; 
            sectionsToHide.forEach(section => {
                if (section.classList.contains('visible')) {
                    section.classList.remove('visible');
                    // إضافة تأخير صغير لإكمال انتقال CSS قبل الإخفاء التام
                    setTimeout(() => { section.hidden = true; }, 500); 
                }
            });
        }
        /**
         * تعرض قسماً محدداً من المحتوى مع رسوم متحركة متلاشية.
         * @param {HTMLElement} sectionToShow - عنصر القسم المراد عرضه.
         * @returns {Promise<void>} وعد يحل عند ظهور القسم.
         */
        function showSection(sectionToShow) {
            return new Promise(resolve => {
                hideAllSections();
                sectionToShow.hidden = false;
                // تأخير للسماح بتطبيق display: block قبل بدء الانتقال
                setTimeout(() => {
                    sectionToShow.classList.add('visible');
                    resolve();
                }, 10);
            });
        }
        /**
         * تعيين الحالة النشطة لأزرار التنقل.
         * @param {HTMLElement} activeBtn - الزر المراد تمييزه كنشط.
         * @param {HTMLElement[]} buttonGroup - مصفوفة تحتوي على جميع الأزرار في المجموعة.
         */
        function setActiveButton(activeBtn, buttonGroup) {
            buttonGroup.forEach(btn => { btn.classList.remove('active'); });
            if (activeBtn) { // التأكد من أن activeBtn ليس فارغاً
                activeBtn.classList.add('active');
            }
        }
        /**
         * إعادة تعيين رسائل وأنماط أخطاء التحقق لنموذج معين.
         * @param {HTMLFormElement} form - عنصر النموذج المراد إعادة تعيينه.
         */
        function resetValidationMessages(form) {
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');
            fields.forEach(field => {
                field.classList.remove('error');
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.style.display = 'none';
                    errorMessageSpan.textContent = '';
                }
            });
        }
        /**
         * عرض إشعار توست.
         * @param {string} message - الرسالة المراد عرضها.
         * @param {'success'|'error'|'info'} type - نوع التوست (يحدد اللون/الأيقونة).
         */
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let iconHtml = '';
            if (type === 'success') { iconHtml = '<span class="icon">✔</span>'; }
            else if (type === 'error') { iconHtml = '<span class="icon">✖</span>'; }
            else if (type === 'info') { iconHtml = '<span class="icon">ℹ</span>'; }
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }
        /**
         * عرض نافذة تأكيد مخصصة وإرجاع وعد يحل إلى صحيح/خطأ.
         * @param {string} title - العنوان للنافذة.
         * @param {string} message - الرسالة للنافذة.
         * @returns {Promise<boolean>} يحل إلى صحيح إذا تم التأكيد، وإلا خطأ.
         */
        function showConfirmModal(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalOverlay.hidden = false;
                confirmModalOverlay.classList.add('active');
                const handleYes = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    confirmModalOverlay.classList.remove('active');
                    confirmModalOverlay.hidden = true;
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };
                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }
        // ====== معالجات أحداث التنقل ======
        desktopShowDashboardButton.addEventListener('click', async () => {
            await showSection(mainDashboardView);
            setActiveButton(desktopShowDashboardButton, desktopNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        desktopShowFirebaseDataButton.addEventListener('click', async () => {
            await showSection(firebaseProductsDisplay);
            setActiveButton(desktopShowFirebaseDataButton, desktopNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = ''; // مسح حقل البحث عند التنقل
            if (database) {
                populateCommonDropdown();
                fetchAndDisplayCombinedFirebaseData();
            } else {
                showToast("قاعدة بيانات Firebase غير مهيأة. لا يمكن جلب بيانات Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        desktopShowLocalArchiveButton.addEventListener('click', async () => {
            await showSection(localArchiveView);
            setActiveButton(desktopShowLocalArchiveButton, desktopNavButtons);
            mainContainer.classList.add('full-width');
            displayLocalInvoices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        // أزرار التنقل في الجوال
        mobileShowDashboardButton.addEventListener('click', async () => {
            await showSection(mainDashboardView);
            setActiveButton(mobileShowDashboardButton, mobileNavButtons);
            mainContainer.classList.remove('full-width');
            displayLocalInvoices();
            displaySavedProducts();
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        mobileShowFirebaseDataButton.addEventListener('click', async () => {
            await showSection(firebaseProductsDisplay);
            setActiveButton(mobileShowFirebaseDataButton, mobileNavButtons);
            mainContainer.classList.add('full-width');
            commonSearchInput.value = '';
            if (database) {
                populateCommonDropdown();
                fetchAndDisplayCombinedFirebaseData();
            } else {
                showToast("قاعدة بيانات Firebase غير مهيأة. لا يمكن جلب بيانات Firebase.", 'error');
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
                dynamicStatsListContainer.innerHTML = '<p class="empty-list-message">تعذر الاتصال بقاعدة بيانات Firebase.</p>';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        mobileShowLocalArchiveButton.addEventListener('click', async () => {
            await showSection(localArchiveView);
            setActiveButton(mobileShowLocalArchiveButton, mobileNavButtons);
            mainContainer.classList.add('full-width');
            displayLocalInvoices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        mobileCreateInvoiceButton.addEventListener('click', async () => {
            await showSection(mainDashboardView);
            setActiveButton(mobileCreateInvoiceButton, mobileNavButtons);
            mainContainer.classList.remove('full-width');
            window.scrollTo({ top: clientFormContainer.offsetTop, behavior: 'smooth' });
            resetAllProductQuantities();
            displaySavedProducts();
            showToast("يرجى تحديد المنتجات والكميات للفاتورة.", 'info');
        });
        // ====== التحقق من صحة النموذج ======
        /**
         * يتحقق من صحة جميع الحقول المطلوبة في نموذج.
         * @param {HTMLFormElement} form - عنصر النموذج للتحقق من صحته.
         * @returns {boolean} صحيح إذا كانت جميع الحقول المطلوبة صالحة، خطأ بخلاف ذلك.
         */
        function checkFields(form) {
            let allFieldsValid = true;
            const fields = form.querySelectorAll('input[required], textarea[required], select[required]');
            
            // إعادة تعيين جميع الأخطاء السابقة
            fields.forEach(field => {
                field.classList.remove('error');
                const errorMessageSpan = field.nextElementSibling;
                if (errorMessageSpan && errorMessageSpan.classList.contains('validation-error-message')) {
                    errorMessageSpan.style.display = 'none';
                    errorMessageSpan.textContent = '';
                }
            });
            // التحقق من صحة الحقول
            fields.forEach(field => {
                const fieldValue = field.value.trim();
                const errorMessageSpan = field.nextElementSibling;
                if (!fieldValue) {
                    allFieldsValid = false;
                    field.classList.add('error');
                    if (errorMessageSpan) {
                        errorMessageSpan.textContent = `⚠️ ${field.placeholder || field.labels[0].textContent} مطلوب.`;
                        errorMessageSpan.style.display = 'flex';
                    }
                } else if (field.type === 'number') {
                    const numValue = parseFloat(fieldValue);
                    if (field.id === 'purchasePrice' || field.id === 'sellingPrice' || field.id === 'productQuantity') {
                        if (isNaN(numValue) || numValue < 0) {
                            allFieldsValid = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.textContent = '⚠️ القيمة يجب أن تكون رقماً موجباً.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    } else if (field.id === 'tva' || field.id === 'invoiceCommissionPercentage') {
                        if (isNaN(numValue) || numValue < 0 || numValue > 100) {
                            allFieldsValid = false;
                            field.classList.add('error');
                            if (errorMessageSpan) {
                                errorMessageSpan.textContent = '⚠️ النسبة يجب أن تكون بين 0 و 100.';
                                errorMessageSpan.style.display = 'flex';
                            }
                        }
                    }
                } else if (field.type === 'tel' && field.pattern) {
                    const regex = new RegExp(field.pattern);
                    if (!regex.test(fieldValue)) {
                        allFieldsValid = false;
                        field.classList.add('error');
                        if (errorMessageSpan) {
                            errorMessageSpan.textContent = '⚠️ صيغة رقم الهاتف غير صحيحة (10 أرقام).';
                            errorMessageSpan.style.display = 'flex';
                        }
                    }
                }
            });
            return allFieldsValid;
        }
        // ====== إدارة المنتجات (التخزين المحلي) ======
        /**
         * يتعامل مع إرسال نموذج المنتج (إضافة أو تعديل).
         * @param {number|null} productId - معرف المنتج الذي يتم تعديله، أو null لمنتج جديد.
         */
        async function handleProductFormSubmission(productId = null) {
            if (!checkFields(productForm)) {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                return;
            }
            const name = productNameInput.value.trim();
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const sellingPrice = parseFloat(sellingPriceInput.value);
            const supplierName = supplierNameInput.value.trim();
            const supplierAddress = supplierAddressInput.value.trim();
            const supplierPhone = supplierPhoneInput.value.trim();
            const stockQuantity = parseInt(productQuantityInput.value);
            const date = new Date().toLocaleDateString('ar-MA');
            // حفظ معلومات المورد في التخزين المحلي (لأنها غالباً ما يعاد استخدامها)
            localStorage.setItem('supplierName', supplierName);
            localStorage.setItem('supplierAddress', supplierAddress);
            localStorage.setItem('supplierPhone', supplierPhone);
            let products = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let isEditing = productId !== null;
            let productIndex = -1;
            if (isEditing) {
                productIndex = products.findIndex(p => p.id == productId);
                if (productIndex === -1) {
                    showToast("المنتج المراد تعديله غير موجود.", 'error');
                    resetProductFormAndButtons();
                    return;
                }
            }
            // التحقق من وجود منتج مكرر (نفس الاسم ورقم هاتف المورد)
            const duplicateCheck = products.some((p, idx) =>
                (isEditing ? idx !== productIndex : true) &&
                (p.name || '').toLowerCase() === name.toLowerCase() &&
                p.supplierPhone === supplierPhone
            );
            if (duplicateCheck) {
                showToast("المنتج موجود بالفعل بنفس الاسم ورقم هاتف المورد.", 'info');
                return;
            }
            const confirmTitle = isEditing ? "تأكيد التعديل" : "تأكيد الإضافة";
            const confirmMessage = isEditing ? "هل أنت متأكد من أنك تريد تعديل هذا المنتج؟" : "هل أنت متأكد من أنك تريد إضافة هذا المنتج؟";
            const confirmed = await showConfirmModal(confirmTitle, confirmMessage);
            if (!confirmed) {
                showToast(isEditing ? "تم إلغاء تعديل المنتج." : "تم إلغاء إضافة المنتج.", 'info');
                return;
            }
            if (isEditing) {
                products[productIndex] = {
                    ...products[productIndex], // الحفاظ على الخصائص الموجودة مثل 'الكمية' إذا لم يتم تحديثها هنا
                    name, purchasePrice, sellingPrice, supplierName, supplierAddress, supplierPhone, stockQuantity, date
                };
                showToast("تم تحديث المنتج بنجاح.", 'success');
            } else {
                const newProduct = {
                    id: Date.now(), // معرف فريد للمنتجات المحلية
                    name, purchasePrice, sellingPrice, supplierName, supplierAddress, supplierPhone, stockQuantity, date,
                    quantity: 0, // الكمية المحددة للفاتورة الحالية (افتراضياً 0)
                    isLocal: true // علامة للإشارة إلى أنه منتج محلي مضاف
                };
                products.push(newProduct);
                showToast("المنتج تم إضافته بنجاح.", 'success');
            }
            products.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // الفرز أبجدياً
            localStorage.setItem('savedProducts', JSON.stringify(products));
            displaySavedProducts(); // تحديث القائمة
            resetProductFormAndButtons(); // مسح النموذج وإعادة تعيين الأزرار
        }
        // معالج حدث لإضافة منتج جديد
        addProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            handleProductFormSubmission(null);
        });
        // معالج حدث لحفظ منتج تم تعديله
        saveEditProductButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const idToEdit = event.target.dataset.editingId;
            handleProductFormSubmission(idToEdit);
        });
        /**
         * إعادة تعيين نموذج المنتج إلى حالته الأولية.
         */
        function resetProductFormAndButtons() {
            productForm.reset();
            productFormTitle.innerHTML = '<span class="icon">📦</span>إدارة المنتجات';
            addProductButton.style.display = 'block';
            saveEditProductButton.style.display = 'none';
            delete saveEditProductButton.dataset.editingId;
            resetValidationMessages(productForm);
        }
        /**
         * تعبئة نموذج المنتج ببيانات لتحرير منتج معين.
         * @param {number} productId - معرف المنتج المراد تحريره.
         */
        async function editProduct(productId) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productToEdit = savedProducts.find(p => p.id == productId);
            if (productToEdit) {
                await showSection(mainDashboardView); 
                // تفعيل زر التنقل المناسب
                if (window.innerWidth <= 768) {
                    setActiveButton(mobileShowDashboardButton, mobileNavButtons);
                } else {
                    setActiveButton(desktopShowDashboardButton, desktopNavButtons);
                }
                mainContainer.classList.remove('full-width');
                window.scrollTo({ top: productFormContainer.offsetTop, behavior: 'smooth' });
                productFormTitle.innerHTML = '<span class="icon">✏️</span>تعديل المنتج';
                productNameInput.value = productToEdit.name;
                purchasePriceInput.value = productToEdit.purchasePrice;
                sellingPriceInput.value = productToEdit.sellingPrice;
                supplierNameInput.value = productToEdit.supplierName;
                supplierAddressInput.value = productToEdit.supplierAddress;
                supplierPhoneInput.value = productToEdit.supplierPhone;
                productQuantityInput.value = productToEdit.stockQuantity;
                
                addProductButton.style.display = 'none';
                saveEditProductButton.style.display = 'block';
                saveEditProductButton.dataset.editingId = productId;
                resetValidationMessages(productForm);
            } else {
                showToast("المنتج المراد تعديله غير موجود.", 'error');
            }
        }
        /**
         * حذف منتج من التخزين المحلي.
         * @param {number} id - معرف المنتج المراد حذفه.
         */
        async function deleteProduct(id) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد مسح هذا المنتج؟");
            if (confirmed) {
                let products = JSON.parse(localStorage.getItem('savedProducts') || '[]');
                products = products.filter(product => product.id !== id);
                localStorage.setItem('savedProducts', JSON.stringify(products));
                displaySavedProducts(); // تحديث القائمة
                showToast("تم حذف المنتج بنجاح.", 'success');
            } else {
                showToast("تم إلغاء حذف المنتج.", 'info');
            }
        }
        /**
         * إعادة تعيين الكمية المحددة للفاتورة إلى صفر لجميع المنتجات.
         */
        function resetAllProductQuantities() {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            savedProducts.forEach(product => { product.quantity = 0; });
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
        }
        /**
         * عرض المنتجات من التخزين المحلي في قائمة "المنتجات المحفوظة".
         * يطبق مرشح البحث والفرز.
         */
        function displaySavedProducts() {
            const searchTerm = searchProductInput.value.toLowerCase(); 
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            savedProductsList.innerHTML = ''; // مسح العرض الحالي
            const filteredProducts = savedProducts
                .filter(product => (product.name || '').toLowerCase().includes(searchTerm))
                .sort((a, b) => {
                    const stockQuantityA = a.stockQuantity || 0;
                    const stockQuantityB = b.stockQuantity || 0;
                    const quantityA = a.quantity || 0;
                    const quantityB = b.quantity || 0;
                    // الأولوية: غير كافٍ > محدد للفاتورة > مخزون إيجابي > افتراضي
                    const statusA = getProductStatusPriority(quantityA, stockQuantityA); 
                    const statusB = getProductStatusPriority(quantityB, stockQuantityB); 
                    if (statusA !== statusB) { return statusA - statusB; }
                    if (a.isLocal && !b.isLocal) return -1; // المنتجات المحلية أولاً (إذا كانت الأولوية هي نفسها)
                    if (!a.isLocal && b.isLocal) return 1;
                    return stockQuantityB - stockQuantityA || (a.name || '').localeCompare(b.name || ''); // ثم حسب المخزون، ثم أبجدياً
                });
            if (filteredProducts.length === 0) {
                savedProductsList.innerHTML = '<p class="empty-list-message">لا توجد منتجات محفوظة لعرضها.</p>';
                return;
            }
            filteredProducts.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.dataset.id = product.id; // تعيين data-id لتفويض الأحداث
                if (product.isLocal) { productDiv.classList.add('is-local'); }
                const quantityToDisplay = product.quantity || 0;
                const stockQuantityToDisplay = product.stockQuantity || 0;
                updateProductDivClass(productDiv, quantityToDisplay, stockQuantityToDisplay); 
                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p><strong>سعر الشراء:</strong> ${parseFloat(product.purchasePrice || 0).toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName || 'N/A'}</p>
                        <p><strong>هاتف المورد:</strong> ${product.supplierPhone || 'N/A'}</p>
                    </div>
                    <p><strong>الكمية في المخزون:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" class="stock-adjust-btn" data-action="plus">+</button>
                        <input type="number" id="stock-${product.id}" value="${stockQuantityToDisplay}" min="0" data-product-id="${product.id}" class="stock-input">
                        <button type="button" class="stock-adjust-btn" data-action="minus">-</button>
                    </div>
                    <p><strong>الكمية المحددة للفاتورة:</strong></p>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-adjust-btn" data-action="plus">+</button>
                        <input type="number" class="product-quantity-input" data-id="${product.id}" value="${quantityToDisplay}" min="0">
                        <button type="button" class="quantity-adjust-btn" data-action="minus">-</button>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn-delete" data-product-id="${product.id}"><span class="icon">🗑️</span>حذف</button>
                        <button type="button" class="btn-edit" data-product-id="${product.id}"><span class="icon">✏️</span>تعديل</button>
                    </div>
                `;
                savedProductsList.appendChild(productDiv);
            });
        }
        // تفويض الأحداث لإجراءات قائمة المنتجات المحفوظة
        savedProductsList.addEventListener('click', (event) => {
            const target = event.target;
            const productDiv = target.closest('.product');
            if (!productDiv) return;
            const productId = parseInt(productDiv.dataset.id);
            if (isNaN(productId)) return;
            if (target.classList.contains('btn-edit')) {
                editProduct(productId);
            } else if (target.classList.contains('btn-delete')) {
                deleteProduct(productId);
            } else if (target.classList.contains('stock-adjust-btn')) {
                const stockInput = productDiv.querySelector('.stock-input');
                let currentVal = parseInt(stockInput.value) || 0;
                if (target.dataset.action === 'plus') currentVal++;
                else if (target.dataset.action === 'minus') currentVal--;
                stockInput.value = Math.max(0, currentVal); // تحديث حقل الإدخال
                updateStockInLocalStorage(productId, currentVal); // تحديث التخزين المحلي
            } else if (target.classList.contains('quantity-adjust-btn')) {
                const quantityInput = productDiv.querySelector('.product-quantity-input');
                let currentVal = parseInt(quantityInput.value) || 0;
                if (target.dataset.action === 'plus') currentVal++;
                else if (target.dataset.action === 'minus') currentVal--;
                quantityInput.value = Math.max(0, currentVal); // تحديث حقل الإدخال
                updateInvoiceQuantityInLocalStorage(productId, currentVal); // تحديث التخزين المحلي
            }
        });
        // معالجات أحداث لتغييرات الإدخال داخل قائمة المنتجات المحفوظة (المخزون والكمية)
        savedProductsList.addEventListener('change', (event) => {
            const target = event.target;
            const productDiv = target.closest('.product');
            if (!productDiv) return;
            const productId = parseInt(productDiv.dataset.id);
            if (isNaN(productId)) return;
            if (target.classList.contains('stock-input')) {
                updateStockInLocalStorage(productId, parseInt(target.value));
            } else if (target.classList.contains('product-quantity-input')) {
                updateInvoiceQuantityInLocalStorage(productId, parseInt(target.value));
            }
        });
        // معالج حدث للبحث في المنتجات المحفوظة
        searchProductInput.addEventListener('input', displaySavedProducts);
        /**
         * وظيفة مساعدة لتحديد أولوية حالة بطاقة المنتج للفرز والتصميم.
         * @param {number} quantitySelected - الكمية المحددة للفاتورة الحالية.
         * @param {number} stockQuantity - الكمية الحالية في المخزون.
         * @returns {number} قيمة الأولوية (الأقل يعني أولوية أعلى).
         */
        function getProductStatusPriority(quantitySelected, stockQuantity) { 
            if (quantitySelected > 0 && stockQuantity < quantitySelected) return 1; // محدد ولكن المخزون غير كافٍ
            if (quantitySelected > 0) return 4; // محدد للفاتورة (مخزون كافٍ)
            if (stockQuantity > 0) return 5; // مخزون إيجابي
            return 6; // افتراضي / لا توجد حالة محددة
        }
        /**
         * تحديث فئات CSS لبطاقة المنتج بناءً على حالة المخزون والكمية المحددة.
         * @param {HTMLElement} productDiv - عنصر div للمنتج.
         * @param {number} quantitySelected - الكمية المحددة للفاتورة.
         * @param {number} stockQuantity - الكمية الحالية في المخزون.
         */
        function updateProductDivClass(productDiv, quantitySelected, stockQuantity) { 
            const isLocalClass = productDiv.classList.contains('is-local') ? 'is-local' : '';
            const isLocalMatchClass = productDiv.classList.contains('is-local-match') ? 'is-local-match' : '';
            
            productDiv.className = 'product'; // إعادة تعيين جميع فئات الحالة
            if (isLocalClass) { productDiv.classList.add(isLocalClass); }
            if (isLocalMatchClass) { productDiv.classList.add(isLocalMatchClass); }
            if (quantitySelected > 0 && stockQuantity < quantitySelected) {
                productDiv.classList.add('status-insufficient');
            } else if (quantitySelected > 0) {
                productDiv.classList.add('status-selected-sufficient');
            } else if (stockQuantity > 0) {
                productDiv.classList.add('status-stock-positive');
            } else {
                productDiv.classList.add('status-default');
            }
        }
        /**
         * تحديث كمية المخزون في التخزين المحلي وتحديث واجهة المستخدم.
         * @param {number} id - معرف المنتج.
         * @param {number} newStockQuantity - قيمة المخزون الجديدة.
         */
        function updateStockInLocalStorage(id, newStockQuantity) {
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].stockQuantity = Math.max(0, newStockQuantity); // ضمان عدم وجود قيمة سالبة
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product[data-id="${id}"]`);
                if (productDiv) {
                    const quantityToDisplay = savedProducts[productIndex].quantity || 0;
                    updateProductDivClass(productDiv, quantityToDisplay, savedProducts[productIndex].stockQuantity); 
                }
            }
        }
        /**
         * تحديث كمية الفاتورة في التخزين المحلي وتحديث واجهة المستخدم.
         * @param {number} id - معرف المنتج.
         * @param {number} newQuantity - كمية الفاتورة الجديدة.
         */
        function updateInvoiceQuantityInLocalStorage(id, newQuantity) {
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const productIndex = savedProducts.findIndex(product => product.id === id);
            if (productIndex !== -1) {
                savedProducts[productIndex].quantity = Math.max(0, newQuantity); // ضمان عدم وجود قيمة سالبة
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                const productDiv = document.querySelector(`.product[data-id="${id}"]`);
                if (productDiv) {
                    const stockQuantityToDisplay = savedProducts[productIndex].stockQuantity || 0;
                    updateProductDivClass(productDiv, savedProducts[productIndex].quantity, stockQuantityToDisplay); 
                }
            }
        }
        // ====== إنشاء وعرض الفاتورة ======
        /**
         * يعرض فاتورة كاملة في قسم الفاتورة المخصص.
         * @param {object} invoiceData - كائن بيانات الفاتورة.
         * @param {boolean} isNew - صحيح إذا كانت فاتورة تم إنشاؤها حديثاً، خطأ إذا كانت من الأرشيف.
         */
        async function displayFullInvoice(invoiceData, isNew = false) {
            await showSection(invoiceDisplay);
            mainContainer.classList.add('full-width');
            // تعبئة تفاصيل الفاتورة
            document.getElementById('displayCustomerName').textContent = invoiceData.customerName || 'N/A';
            document.getElementById('displayInvoiceOwner').textContent = invoiceData.ownerName || 'N/A';
            document.getElementById('displayInvoiceDate').textContent = invoiceData.date || 'N/A';
            document.getElementById('displayTotalAmountBeforeCommission').textContent = `${parseFloat(invoiceData.totalHTBeforeCommission || 0).toFixed(2)} DH`;
            document.getElementById('displayCommissionDeducted').textContent = `${parseFloat(invoiceData.totalCommission || 0).toFixed(2)} DH`;
            document.getElementById('displayTotalAmount').textContent = `${parseFloat(invoiceData.totalHT || 0).toFixed(2)} DH`;
            document.getElementById('displayTVA').textContent = `${parseFloat(invoiceData.tva || 0).toFixed(2)} DH`;
            document.getElementById('displayTotalTTC').textContent = `${parseFloat(invoiceData.totalTTC || 0).toFixed(2)} DH`;
            document.getElementById('displayInvoiceOwnerPhoneFooter').textContent = invoiceData.ownerPhone || 'N/A';
            document.getElementById('displayInvoiceOwnerAddressFooter').textContent = invoiceData.ownerAddress || 'N/A';
            // تعبئة جدول المنتجات
            const detailsTbody = document.getElementById('displayDetails');
            detailsTbody.innerHTML = '';
            let productNumber = 1;
            if (invoiceData.products && invoiceData.products.length > 0) {
                invoiceData.products.forEach(product => {
                    const productDetailsRow = document.createElement('tr');
                    productDetailsRow.innerHTML = `
                        <td>${productNumber++}</td>
                        <td>${product.name || 'N/A'}</td>
                        <td>${parseFloat(product.sellingPrice || 0).toFixed(2)} DH</td>
                        <td>${product.quantityUsed || 0}</td>
                        <td>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</td>
                    `;
                    detailsTbody.appendChild(productDetailsRow);
                });
            } else {
                const noProductsRow = document.createElement('tr');
                noProductsRow.innerHTML = `<td colspan="5" style="text-align: center; font-style: italic;">لا توجد منتجات في هذه الفاتورة.</td>`;
                detailsTbody.appendChild(noProductsRow);
            }
            // إدارة رؤية زر "تحديث المخزون"
            const savePdfButton = document.getElementById('savePdfButton');
            savePdfButton.style.display = isNew ? 'flex' : 'none'; // يظهر فقط للفواتير الجديدة
            isNewInvoice = isNew; // تحديث العلامة العامة
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // معالج حدث لإنشاء فاتورة جديدة
        document.getElementById('createInvoiceButton').addEventListener('click', async function (e) {
            e.preventDefault();
            localStorage.setItem('tva', tvaInput.value);
            if (!checkFields(invoiceForm)) {
                showToast("يرجى ملء جميع الحقول المطلوبة بشكل صحيح.", 'error');
                return;
            }
            
            let totalHTBeforeCommission = 0;
            let totalProfit = 0;
            let totalCommission = 0;
            
            let allSavedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0);
            // مطالبة بالاختيار التلقائي لجميع المنتجات إذا لم يتم اختيار أي منها
            if (selectedProductsForInvoice.length === 0) {
                const confirmed = await showConfirmModal(
                    "تحديد المنتجات",
                    "لم يتم تحديد أي منتجات للفاتورة. هل تريد إضافة كل المنتجات الموجودة بكمية 1 (إذا كان المخزون متوفراً)؟"
                );
                if (confirmed) {
                    allSavedProducts.forEach(product => {
                        if (product.stockQuantity > 0 && (product.quantity || 0) === 0) {
                            product.quantity = 1;
                        }
                    });
                    localStorage.setItem('savedProducts', JSON.stringify(allSavedProducts));
                    selectedProductsForInvoice = allSavedProducts.filter(p => (p.quantity || 0) > 0); // إعادة التصفية بعد الاختيار التلقائي
                    if (selectedProductsForInvoice.length === 0) {
                        showToast("لا توجد منتجات لتضمينها في الفاتورة بعد التحديث.", 'info');
                        return;
                    }
                } else {
                    showToast("لم يتم إنشاء الفاتورة لعدم وجود منتجات مختارة.", 'info');
                    return;
                }
            }
            const invoiceCommissionRate = parseFloat(invoiceCommissionPercentageInput.value) || 0;
            localStorage.setItem('invoiceCommissionPercentage', invoiceCommissionRate);
            selectedProductsForInvoice.forEach((productData) => {
                const quantity = productData.quantity;
                const sellingPrice = parseFloat(productData.sellingPrice || 0);
                const purchasePrice = parseFloat(productData.purchasePrice || 0);
                const itemHT = sellingPrice * quantity;
                totalHTBeforeCommission += itemHT;
                const profitPerUnitBeforeCommission = (sellingPrice - purchasePrice) || 0;
                const commissionPerUnit = profitPerUnitBeforeCommission * (invoiceCommissionRate / 100);
                const actualProfitPerUnit = profitPerUnitBeforeCommission - commissionPerUnit;
                totalProfit += actualProfitPerUnit * quantity;
                totalCommission += commissionPerUnit * quantity;
            });
            const finalTotalHT = totalHTBeforeCommission - totalCommission;
            const tvaRate = parseFloat(tvaInput.value) / 100;
            const tva = (finalTotalHT * tvaRate).toFixed(2);
            const totalTTC = (finalTotalHT + parseFloat(tva)).toFixed(2);
            // حفظ تفاصيل الفاتورة المستخدمة بكثرة في التخزين المحلي
            localStorage.setItem('invoiceOwner', invoiceOwnerInput.value);
            localStorage.setItem('invoiceOwnerPhone', invoiceOwnerPhoneInput.value);
            localStorage.setItem('invoiceOwnerAddress', invoiceOwnerAddressInput.value);
            // إعداد بيانات الفاتورة لـ Firebase والأرشيف المحلي
            const productsToSaveToFirebase = selectedProductsForInvoice.map(productData => {
                const profitPerUnitBeforeCommissionFirebase = (parseFloat(productData.sellingPrice || 0) - parseFloat(productData.purchasePrice || 0)) || 0;
                const commissionPerUnitFirebase = profitPerUnitBeforeCommissionFirebase * (invoiceCommissionRate / 100);
                const actualProfitPerUnitFirebase = profitPerUnitBeforeCommissionFirebase - commissionPerUnitFirebase;
                return {
                    id: productData.id,
                    name: productData.name,
                    purchasePrice: productData.purchasePrice,
                    sellingPrice: productData.sellingPrice,
                    supplierName: productData.supplierName,
                    supplierAddress: productData.supplierAddress,
                    supplierPhone: productData.supplierPhone,
                    stockQuantity: productData.stockQuantity, // الكمية الحالية في المخزون وقت إنشاء الفاتورة
                    quantityUsed: productData.quantity,
                    profitPerUnit: actualProfitPerUnitFirebase.toFixed(2),
                    commissionPerUnit: commissionPerUnitFirebase.toFixed(2)
                };
            });
            const invoiceDataToSave = {
                id: Date.now(), // معرف فريد لهذه الفاتورة
                date: invoiceDateInput.value,
                isoDate: new Date().toISOString(), // للفرز المتسق
                customerName: customerNameInput.value,
                ownerName: invoiceOwnerInput.value,
                ownerAddress: invoiceOwnerAddressInput.value,
                ownerPhone: invoiceOwnerPhoneInput.value,
                products: productsToSaveToFirebase,
                totalHT: finalTotalHT.toFixed(2),
                totalHTBeforeCommission: totalHTBeforeCommission.toFixed(2),
                tva: tva,
                totalTTC: totalTTC,
                totalProfit: totalProfit.toFixed(2),
                totalCommission: totalCommission.toFixed(2),
                invoiceCommissionRate: invoiceCommissionRate // تخزين نسبة العمولة في بيانات الفاتورة
            };
            
            // عرض الفاتورة الجديدة
            await displayFullInvoice(invoiceDataToSave, true);
            // حفظ في قاعدة بيانات Firebase Realtime
            const firebasePath = `${appId}/alldata/${invoiceDataToSave.ownerPhone}`;
            if (database) {
                database.ref(firebasePath).push(invoiceDataToSave)
                    .then(() => showToast("تم حفظ بيانات الفاتورة في Firebase بنجاح.", 'success'))
                    .catch(error => showToast(`خطأ في حفظ بيانات الفاتورة إلى Firebase: ${error.message}`, 'error'));
            } else {
                showToast("لم يتم تهيئة قاعدة بيانات Firebase. لا يمكن حفظ الفاتورة.", 'error');
            }
            saveInvoiceToLocalStorage(invoiceDataToSave); // حفظ في الأرشيف المحلي
        });
        // معالج حدث لتحديث المخزون بعد تأكيد الفاتورة
        document.getElementById('savePdfButton').addEventListener('click', async function() {
            if (!isNewInvoice) {
                showToast("لا يمكن تحديث المخزون لفاتورة مؤرشفة. يجب أن تكون فاتورة جديدة.", 'info');
                return;
            }
            
            const productsInInvoiceRows = document.querySelectorAll('#invoiceDetails tbody tr');
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            let hasInsufficientStock = false;
            let productsToUpdate = [];
            
            productsInInvoiceRows.forEach((row) => {
                const productName = row.cells[1].textContent;
                const quantityUsed = parseInt(row.cells[3].textContent);
                const productData = savedProducts.find(p => (p.name || '') === productName); 
                
                if (productData) {
                    const currentStock = parseInt(productData.stockQuantity || 0);
                    if (currentStock < quantityUsed) {
                        hasInsufficientStock = true;
                        showToast(`تنبيه: كمية غير كافية للمنتج "${productName}". المخزون المتاح: ${currentStock}`, 'error');
                    }
                    productsToUpdate.push({ productId: productData.id, quantityUsed });
                }
            });
            if (hasInsufficientStock) {
                showToast("يرجى مراجعة المنتجات ذات المخزون غير الكافي قبل التحديث.", 'error');
                return;
            }
            const confirmed = await showConfirmModal("تأكيد تحديث المخزون", "هل أنت متأكد من تحديث المخزون بناءً على هذه الفاتورة؟");
            if (confirmed) {
                productsToUpdate.forEach(({ productId, quantityUsed }) => {
                    const productDataIndex = savedProducts.findIndex(p => p.id === productId);
                    if (productDataIndex !== -1) {
                        savedProducts[productDataIndex].stockQuantity -= quantityUsed;
                        savedProducts[productDataIndex].stockQuantity = Math.max(0, savedProducts[productDataIndex].stockQuantity);
                    }
                });
                localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                showToast('تم تحديث المخزون بنجاح.', 'success');
                resetAllProductQuantities();
                isNewInvoice = false;
                if (window.innerWidth <= 768) {
                    mobileShowDashboardButton.click();
                } else {
                    desktopShowDashboardButton.click();
                }
            } else {
                showToast("تم إلغاء تحديث المخزون.", 'info');
            }
        });
        // وظيفة زر الطباعة
        document.getElementById('printButton').addEventListener('click', function() {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            let originalViewportContent = '';
            if (viewportMeta) {
                originalViewportContent = viewportMeta.getAttribute('content');
                viewportMeta.setAttribute('content', 'width=1024');
            }
            const invoicePrintGroup = document.querySelector('.invoice-actions-print-group');
            if (invoicePrintGroup) {
                invoicePrintGroup.style.display = 'none';
            }
            window.print();
            setTimeout(() => {
                if (invoicePrintGroup) {
                    invoicePrintGroup.style.display = 'flex';
                }
                if (viewportMeta && originalViewportContent) {
                    viewportMeta.setAttribute('content', originalViewportContent);
                }
            }, 500);
        });
        // ====== عرض بيانات Firebase والإحصائيات ======
        /**
         * تعبئة قائمة البيانات للبحث المشترك بأسماء وأرقام هواتف فريدة من بيانات Firebase.
         */
        function populateAllSearchOptions() {
            const allOptions = new Set();
            allFirebaseProducts.forEach(p => {
                if (p.name) allOptions.add(p.name);
                if (p.customerName) allOptions.add(p.customerName);
                if (p.ownerName) allOptions.add(p.ownerName);
                if (p.supplierName) allOptions.add(p.supplierName);
                if (p.ownerPhone) allOptions.add(p.ownerPhone);
            });
            allFirebaseInvoicesData.forEach(inv => {
                if (inv.customerName) allOptions.add(inv.customerName);
                if (inv.ownerName) allOptions.add(inv.ownerName);
                if (inv.ownerPhone) allOptions.add(inv.ownerPhone);
            });
            allSearchOptionsDatalist.innerHTML = '';
            Array.from(allOptions).sort().forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                allSearchOptionsDatalist.appendChild(option);
            });
        }
        /**
         * تعبئة القائمة المنسدلة لرقم الهاتف لتصفية بيانات Firebase.
         */
        function populateCommonDropdown() {
            if (!database) {
                showToast("قاعدة بيانات Firebase غير جاهزة لملء أرقام الهواتف.", 'info');
                return;
            }
            const alldataRef = database.ref(`${appId}/alldata`);
            alldataRef.once('value', (snapshot) => {
                const data = snapshot.val();
                commonPhoneDropdown.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'عرض الكل';
                commonPhoneDropdown.appendChild(allOption);
                const phoneNumbers = new Set();
                if (data) {
                    for (const phoneKey in data) {
                        if (data.hasOwnProperty(phoneKey)) {
                            phoneNumbers.add(phoneKey);
                        }
                    }
                }
                Array.from(phoneNumbers).sort().forEach(phoneNumber => {
                    const option = document.createElement('option');
                    option.value = phoneNumber;
                    option.textContent = phoneNumber;
                    commonPhoneDropdown.appendChild(option);
                });
            }, (error) => {
                showToast(`خطأ في جلب أرقام الهواتف من Firebase: ${error.message}`, 'error');
            });
        }
        /**
         * جلب جميع البيانات من Firebase، معالجتها، ثم تطبيق المرشحات وعرضها.
         */
        async function fetchAndDisplayCombinedFirebaseData() {
            if (!database) {
                showToast("قاعدة بيانات Firebase غير جاهزة لجلب البيانات.", 'info');
                return;
            }
            const alldataRef = database.ref(`${appId}/alldata`);
            let snapshot;
            try {
                snapshot = await alldataRef.once('value');
            } catch (error) {
                showToast(`خطأ في جلب بيانات Firebase: ${error.message}`, 'error');
                return;
            }
            const data = snapshot.val();
            allFirebaseProducts = [];
            allFirebaseInvoicesData = [];
            if (data) {
                for (const phoneKey in data) {
                    if (data.hasOwnProperty(phoneKey)) {
                        const phoneData = data[phoneKey];
                        for (const invoiceKey in phoneData) {
                            if (phoneData.hasOwnProperty(invoiceKey) && phoneData[invoiceKey].products) {
                                const invoiceDetails = phoneData[invoiceKey];
                                allFirebaseInvoicesData.push({ id: invoiceKey, firebasePhoneKey: phoneKey, ...invoiceDetails });
                                invoiceDetails.products.forEach((product, index) => {
                                    allFirebaseProducts.push({
                                        id: `${invoiceKey}-${index}`, // معرف فريد لعرض المنتج ضمن هذا العرض
                                        ...product,
                                        invoiceDate: invoiceDetails.date,
                                        customerName: invoiceDetails.customerName,
                                        ownerName: invoiceDetails.ownerName,
                                        ownerAddress: invoiceDetails.ownerAddress,
                                        ownerPhone: invoiceDetails.ownerPhone,
                                        totalHT: invoiceDetails.totalHT,
                                        totalTTC: invoiceDetails.totalTTC,
                                        totalProfit: invoiceDetails.totalProfit,
                                        totalCommission: invoiceDetails.totalCommission,
                                        firebaseInvoiceKey: invoiceKey
                                    });
                                });
                            }
                        }
                    }
                }
            }
            populateAllSearchOptions(); 
            applyCombinedFilters(); // تطبيق المرشحات فوراً بعد الجلب
        }
        /**
         * العثور على منتج مطابق في التخزين المحلي لبيانات منتج Firebase معينة.
         * @param {object} firebaseProduct - كائن المنتج من Firebase.
         * @returns {object|undefined} المنتج المحلي المطابق أو غير محدد.
         */
        function findLocalProductMatch(firebaseProduct) {
            const savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            return savedProducts.find(localProduct =>
                (localProduct.name || '').toLowerCase() === (firebaseProduct.name || '').toLowerCase() &&
                (localProduct.supplierPhone === firebaseProduct.ownerPhone || localProduct.supplierPhone === firebaseProduct.supplierPhone)
            );
        }
        /**
         * تطبيق المرشحات على قائمة منتجات Firebase والإحصائيات بناءً على البحث والقائمة المنسدلة.
         */
        function applyCombinedFilters() {
            const searchTerm = commonSearchInput.value.toLowerCase();
            const selectedPhoneNumber = commonPhoneDropdown.value;
            // 1. تصفية المنتجات لقسم قائمة منتجات Firebase
            const filteredProductsForDisplay = allFirebaseProducts.filter(product => {
                const matchesSearchInput = searchTerm ?
                    ((product.name || '').toLowerCase().includes(searchTerm) ||
                    (product.customerName || '').toLowerCase().includes(searchTerm) ||
                    (product.ownerName || '').toLowerCase().includes(searchTerm) ||
                    (product.supplierName || '').toLowerCase().includes(searchTerm) ||
                    (product.ownerPhone && product.ownerPhone.includes(searchTerm)))
                    : true;
                const matchesPhoneNumber = (selectedPhoneNumber === 'all' || product.ownerPhone === selectedPhoneNumber);
                return matchesSearchInput && matchesPhoneNumber;
            });
            firebaseProductListCountSpan.textContent = filteredProductsForDisplay.length;
            filteredProductsForDisplay.sort((a, b) => {
                const dateA = new Date(a.isoDate || a.invoiceDate); 
                const dateB = new Date(b.isoDate || b.invoiceDate);
                return dateB - dateA; // الأحدث أولاً
            });
            displayFirebaseProducts(filteredProductsForDisplay);
            // 2. تصفية الفواتير لقسم الإحصائيات
            let invoicesForStatsCalculation = allFirebaseInvoicesData;
            if (selectedPhoneNumber !== 'all') {
                invoicesForStatsCalculation = invoicesForStatsCalculation.filter(invoice => 
                    invoice.ownerPhone === selectedPhoneNumber
                );
            }
            if (searchTerm) {
                invoicesForStatsCalculation = invoicesForStatsCalculation.filter(invoice =>
                    ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerPhone && invoice.ownerPhone.includes(searchTerm)) ||
                    (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm))))
                );
            }
            displayStatistics(invoicesForStatsCalculation);
        }
        /**
         * يعرض قائمة بمنتجات Firebase.
         * @param {Array<object>} products - مصفوفة من كائنات المنتج للعرض.
         */
        function displayFirebaseProducts(products) {
            firebaseProductListContainer.innerHTML = '';
            if (products.length === 0) {
                firebaseProductListContainer.innerHTML = '<p class="empty-list-message">لا توجد منتجات لعرضها.</p>';
                return;
            }
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product');
                const matchingLocalProduct = findLocalProductMatch(product);
                if (matchingLocalProduct) { productDiv.classList.add('is-local-match'); }
                const purchasePrice = parseFloat(product.purchasePrice || 0);
                const sellingPrice = parseFloat(product.sellingPrice || 0);
                const quantityUsed = parseInt(product.quantityUsed || 0);
                productDiv.innerHTML = `
                    <div class="product-details">
                        <p><strong>الاسم:</strong> ${product.name || 'N/A'}</p>
                        <p><strong>سعر الشراء:</strong> ${purchasePrice.toFixed(2)} DH</p>
                        <p><strong>سعر البيع:</strong> ${sellingPrice.toFixed(2)} DH</p>
                        <p><strong>المورد:</strong> ${product.supplierName || product.ownerName || 'N/A'}</p>
                        <p><strong>هاتف المورد:</strong> ${product.ownerPhone || 'N/A'}</p>
                        <p><strong>تاريخ الفاتورة:</strong> ${product.invoiceDate || 'N/A'}</p>
                        <p><strong>العميل:</strong> ${product.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${product.ownerName || 'N/A'}</p>
                    </div>
                    <p><strong>الكمية المباعة (للفاتورة):</strong></p>
                    <div class="quantity-controls">
                        <input type="number" value="${quantityUsed}" min="0" readonly>
                    </div>
                    <div class="product-actions">
                        <button type="button" class="btn-edit btn-add-to-local" data-firebase-product-id="${product.id}"><span class="icon">📝</span>إضافة/تعديل (محلي)</button>
                    </div>
                `;
                productDiv.querySelector('.btn-add-to-local').addEventListener('click', (event) => {
                    event.stopPropagation();
                    const firebaseProductId = event.target.dataset.firebaseProductId;
                    addOrEditProductFromFirebase(firebaseProductId);
                });
                firebaseProductListContainer.appendChild(productDiv);
            });
        }
        /**
         * إضافة أو تحديث منتج في التخزين المحلي بناءً على بيانات منتج Firebase.
         * @param {string} firebaseProductId - معرف منتج Firebase.
         */
        async function addOrEditProductFromFirebase(firebaseProductId) {
            const firebaseProduct = allFirebaseProducts.find(p => p.id == firebaseProductId);
            if (!firebaseProduct) {
                showToast("المنتج المراد إضافته/تعديله غير موجود في بيانات Firebase الحالية.", 'error');
                return;
            }
            
            let savedProducts = JSON.parse(localStorage.getItem('savedProducts') || '[]');
            const existingLocalProductIndex = savedProducts.findIndex(localP =>
                (localP.name || '').toLowerCase() === (firebaseProduct.name || '').toLowerCase() &&
                (localP.supplierPhone === firebaseProduct.ownerPhone || localP.supplierPhone === firebaseProduct.supplierPhone)
            );
            if (existingLocalProductIndex !== -1) {
                const confirmed = await showConfirmModal(
                    "تعديل المنتج المحلي",
                    `المنتج "${firebaseProduct.name}" موجود بالفعل محلياً. هل تريد تحديث بياناته في المنتجات المحلية؟`
                );
                if (confirmed) {
                    const existingLocalProduct = savedProducts[existingLocalProductIndex];
                    existingLocalProduct.purchasePrice = parseFloat(firebaseProduct.purchasePrice || 0);
                    existingLocalProduct.sellingPrice = parseFloat(firebaseProduct.sellingPrice || 0);
                    existingLocalProduct.supplierName = firebaseProduct.supplierName || firebaseProduct.ownerName || 'N/A';
                    existingLocalProduct.supplierAddress = firebaseProduct.ownerAddress || 'N/A';
                    existingLocalProduct.supplierPhone = firebaseProduct.ownerPhone;
                    existingLocalProduct.date = new Date().toLocaleDateString('ar-MA');
                    
                    localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
                    showToast(`تم تحديث بيانات "${firebaseProduct.name}" في المنتجات المحلية.`, 'success');
                } else {
                    showToast(`تم إلغاء تحديث "${firebaseProduct.name}".`, 'info');
                }
            } else {
                const confirmed = await showConfirmModal(
                    "إضافة منتج محلي",
                    `هل أنت متأكد من أنك تريد إضافة "${firebaseProduct.name}" كمنتج محلي جديد؟`
                );
                if (confirmed) {
                    const newLocalProductId = Date.now();
                    const newLocalProduct = {
                        id: newLocalProductId,
                        name: firebaseProduct.name,
                        purchasePrice: parseFloat(firebaseProduct.purchasePrice || 0),
                        sellingPrice: parseFloat(firebaseProduct.sellingPrice || 0),
                        supplierName: firebaseProduct.supplierName || firebaseProduct.ownerName || 'N/A',
                        supplierAddress: firebaseProduct.ownerAddress || 'N/A',
                        supplierPhone: firebaseProduct.ownerPhone,
                        stockQuantity: 0,
                        date: new Date().toLocaleDateString('ar-MA'),
                        quantity: 0,
                        isLocal: true
                    };
                    savedProducts.push(newLocalProduct);
                    showToast(`تم إضافة "${newLocalProduct.name}" إلى المنتجات المحلية بنجاح.`, 'success');
                } else {
                    showToast(`تم إلغاء إضافة "${firebaseProduct.name}".`, 'info');
                }
            }
            savedProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            localStorage.setItem('savedProducts', JSON.stringify(savedProducts));
            displaySavedProducts();
            applyCombinedFilters();
        }
        // معالج حدث لتغيير إدخال البحث المشترك
        commonSearchInput.addEventListener('input', applyCombinedFilters);
        // معالج حدث لمسح زر البحث المشترك
        clearCommonSearchInputButton.addEventListener('click', () => {
            commonSearchInput.value = '';
            applyCombinedFilters();
            showToast("تم مسح حقل البحث وتحديث القائمة.", 'info');
        });
        // معالج حدث لتغيير القائمة المنسدلة للهاتف المشترك
        commonPhoneDropdown.addEventListener('change', applyCombinedFilters);
        /**
         * يدمر مثيلات Chart.js الموجودة.
         */
        function destroyCharts() {
            if (topSellingProductsChartInstance) topSellingProductsChartInstance.destroy();
            if (topCustomersChartInstance) topCustomersChartInstance.destroy();
            if (topInvoiceOwnersChartInstance) topInvoiceOwnersChartInstance.destroy();
            if (topSuppliersChartInstance) topSuppliersChartInstance.destroy();
        }
        /**
         * يرسم الرسوم البيانية للإحصائيات باستخدام Chart.js.
         * @param {string} chartId - معرف عنصر canvas.
         * @param {string} chartTitle - عنوان الرسم البياني.
         * @param {string} labelPrefix - بادئة للتسميات (مثال: "كمية: ").
         * @param {string} valueSuffix - لاحقة للقيم (مثال: " DH").
         * @param {Array<object>} dataPoints - مصفوفة من كائنات {name, value}.
         * @param {'bar'|'pie'} chartType - نوع الرسم البياني المراد رسمه.
         * @param {Chart} chartInstance - مثيل Chart.js لتحديثه/إنشائه.
         * @param {function} onClickHandler - الوظيفة التي سيتم استدعاؤها عند النقر على عنصر الرسم البياني.
         * @returns {Chart} مثيل Chart.js الجديد.
         */
        function renderChart(chartId, chartTitle, labelPrefix, valueSuffix, dataPoints, chartType, chartInstance, onClickHandler) {
            const ctx = document.getElementById(chartId);
            if (!ctx) return null;
            // تدمير مثيل الرسم البياني الحالي إذا كان موجوداً
            if (chartInstance) {
                chartInstance.destroy();
            }
            const labels = dataPoints.map(item => item.name);
            const values = dataPoints.map(item => item.value);
            const backgroundColors = [
                'rgba(52, 73, 94, 0.8)',   // primary-blue-medium
                'rgba(39, 174, 96, 0.8)',  // accent-green
                'rgba(243, 156, 18, 0.8)', // accent-orange
                'rgba(231, 76, 60, 0.8)',  // accent-red
                'rgba(93, 122, 148, 0.8)', // primary-blue-light
                'rgba(149, 165, 166, 0.8)',
                'rgba(26, 188, 156, 0.8)',
                'rgba(155, 89, 182, 0.8)',
                'rgba(52, 152, 219, 0.8)',
                'rgba(241, 196, 15, 0.8)'
            ];
            const borderColors = [
                'rgba(44, 62, 80, 1)',     // primary-blue-dark
                'rgba(39, 174, 96, 1)',
                'rgba(243, 156, 18, 1)',
                'rgba(231, 76, 60, 1)',
                'rgba(93, 122, 148, 1)',
                'rgba(149, 165, 166, 1)',
                'rgba(26, 188, 156, 1)',
                'rgba(155, 89, 182, 1)',
                'rgba(52, 152, 219, 1)',
                'rgba(241, 196, 15, 1)'
            ];
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: values,
                        backgroundColor: chartType === 'pie' ? backgroundColors : backgroundColors[0],
                        borderColor: chartType === 'pie' ? borderColors : borderColors[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie', // إظهار الأسطورة للرسوم البيانية الدائرية
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'), // استخدام متغير CSS للون نص الأسطورة
                                font: {
                                    family: 'Cairo', // تعيين الخط للأسطورة
                                }
                            }
                        },
                        title: {
                            display: chartType !== 'pie', // إظهار العنوان للرسوم البيانية الشريطية
                            text: chartTitle,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--primary-blue-dark'), // استخدام متغير CSS للون العنوان
                            font: {
                                size: 16,
                                family: 'Cairo', // تعيين الخط للعنوان
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += labelPrefix + (context.parsed.y || context.parsed) + valueSuffix;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'), // لون تسمية المحور السيني
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') // لون شبكة المحور السيني
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'), // لون تسمية المحور الصادي
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') // لون شبكة المحور الصادي
                            }
                        }
                    } : {}
                }
            };
            const newChartInstance = new Chart(ctx, chartConfig);
            // إضافة معالج النقر لعناصر الرسم البياني
            if (onClickHandler) {
                ctx.onclick = function(evt) {
                    const activePoints = newChartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                    if (activePoints.length > 0) {
                        const firstPoint = activePoints[0];
                        const label = newChartInstance.data.labels[firstPoint.index];
                        onClickHandler(label);
                    }
                };
            }
            return newChartInstance;
        }
        /**
         * عرض الإحصائيات ورسم الرسوم البيانية بناءً على بيانات الفواتير المصفاة.
         * @param {Array<object>} invoices - مصفوفة من كائنات الفاتورة للحساب.
         */
        function displayStatistics(invoices) { 
            let totalSalesHT = 0;
            let totalTVA = 0;
            let totalSalesTTC = 0;
            let totalOverallProfit = 0;
            let totalOverallCommission = 0;
            let totalPurchaseCostAllProducts = 0;
            let totalSellingPriceAllProducts = 0;
            const productSales = {};
            const customerActivity = {};
            const invoiceOwnerActivity = {};
            const supplierActivity = {};
            
            invoices.forEach(invoice => {
                totalSalesHT += parseFloat(invoice.totalHT || 0);
                totalTVA += parseFloat(invoice.tva || 0);
                totalSalesTTC += parseFloat(invoice.totalTTC || 0);
                totalOverallProfit += parseFloat(invoice.totalProfit || 0);
                totalOverallCommission += parseFloat(invoice.totalCommission || 0);
                if (invoice.products) {
                    invoice.products.forEach(product => {
                        const productName = product.name || 'N/A';
                        const quantityUsed = parseInt(product.quantityUsed || 0);
                        const purchasePrice = parseFloat(product.purchasePrice || 0);
                        const sellingPrice = parseFloat(product.sellingPrice || 0);
                        const supplierName = product.supplierName || invoice.ownerName || 'N/A'; 
                        totalPurchaseCostAllProducts += purchasePrice * quantityUsed;
                        totalSellingPriceAllProducts += sellingPrice * quantityUsed;
                        if (!productSales[productName]) {
                            productSales[productName] = { quantitySold: 0, totalRevenue: 0 };
                        }
                        productSales[productName].quantitySold += quantityUsed;
                        productSales[productName].totalRevenue += sellingPrice * quantityUsed;
                        if (!supplierActivity[supplierName]) {
                            supplierActivity[supplierName] = { totalPurchaseCost: 0, productsCount: 0 };
                        }
                        supplierActivity[supplierName].totalPurchaseCost += purchasePrice * quantityUsed;
                        supplierActivity[supplierName].productsCount += quantityUsed;
                    });
                }
                const customer = invoice.customerName || 'N/A';
                const invoiceProfit = parseFloat(invoice.totalProfit || 0);
                const invoiceTTC = parseFloat(invoice.totalTTC || 0);
                const owner = invoice.ownerName || 'N/A';
                if (!customerActivity[customer]) {
                    customerActivity[customer] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                customerActivity[customer].invoiceCount += 1;
                customerActivity[customer].totalProfit += invoiceProfit;
                customerActivity[customer].totalTTC += invoiceTTC;
                if (!invoiceOwnerActivity[owner]) {
                    invoiceOwnerActivity[owner] = { invoiceCount: 0, totalProfit: 0, totalTTC: 0 };
                }
                invoiceOwnerActivity[owner].invoiceCount += 1;
                invoiceOwnerActivity[owner].totalProfit += invoiceProfit;
                invoiceOwnerActivity[owner].totalTTC += invoiceTTC;
            });
            // تحديث بطاقات الإحصائيات الرئيسية
            document.getElementById('totalPurchaseCost').textContent = `${totalPurchaseCostAllProducts.toFixed(2)} DH`;
            document.getElementById('totalSellingPrice').textContent = `${totalSellingPriceAllProducts.toFixed(2)} DH`;
            document.getElementById('totalCommission').textContent = `${totalOverallCommission.toFixed(2)} DH`;
            document.getElementById('totalProfit').textContent = `${totalOverallProfit.toFixed(2)} DH`;
            document.getElementById('totalSalesHT').textContent = `${totalSalesHT.toFixed(2)} DH`;
            document.getElementById('totalTVA').textContent = `${totalTVA.toFixed(2)} DH`;
            document.getElementById('totalSalesTTC').textContent = `${totalSalesTTC.toFixed(2)} DH`;
            // إعداد البيانات للرسوم البيانية والقوائم
            const topSellingProductsData = Object.entries(productSales)
                .sort(([, a], [, b]) => b.quantitySold - a.quantitySold)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.quantitySold, secondaryValue: stats.totalRevenue }));
            const topCustomersData = Object.entries(customerActivity)
                .sort(([, a], [, b]) => b.totalTTC - a.totalTTC)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalTTC }));
            const topInvoiceOwnersData = Object.entries(invoiceOwnerActivity)
                .sort(([, a], [, b]) => b.totalProfit - a.totalProfit)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.invoiceCount, secondaryValue: stats.totalProfit }));
            const topSuppliersData = Object.entries(supplierActivity)
                .sort(([, a], [, b]) => b.totalPurchaseCost - a.totalPurchaseCost)
                .slice(0, 10)
                .map(([name, stats]) => ({ name, value: stats.totalPurchaseCost, secondaryValue: stats.productsCount }));
            
            // رسم الرسوم البيانية
            topSellingProductsChartInstance = renderChart(
                'topSellingProductsChart', 'المنتجات الأكثر مبيعاً (الكمية)', 'الكمية: ', ' وحدة', topSellingProductsData, 'bar', topSellingProductsChartInstance, 
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); }
            );
            topCustomersChartInstance = renderChart(
                'topCustomersChart', 'العملاء الأكثر نشاطاً (الإجمالي TTC)', 'المبلغ: ', ' DH', topCustomersData, 'bar', topCustomersChartInstance, 
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); }
            );
            topInvoiceOwnersChartInstance = renderChart(
                'topInvoiceOwnersChart', 'أصحاب الفواتير الأكثر نشاطاً (الربح)', 'الربح: ', ' DH', topInvoiceOwnersData, 'bar', topInvoiceOwnersChartInstance, 
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); }
            );
            topSuppliersChartInstance = renderChart(
                'topSuppliersChart', 'الموردون الأكثر نشاطاً (تكلفة الشراء)', 'التكلفة: ', ' DH', topSuppliersData, 'bar', topSuppliersChartInstance, 
                (label) => { commonSearchInput.value = label; applyCombinedFilters(); }
            );
            // عرض القوائم البسيطة أسفل الرسوم البيانية (للعرض التفصيلي أو البديل)
            const renderSimpleList = (listId, data, primaryTextFn, secondaryTextFn) => {
                const listEl = document.getElementById(listId);
                if (!listEl) return;
                listEl.innerHTML = ''; // مسح المحتوى السابق
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span><strong>${primaryTextFn(item)}</strong></span>
                            <span>${secondaryTextFn(item)}</span>
                        `;
                        li.dataset.searchTerm = item.name; // للفلترة عند النقر
                        li.addEventListener('click', () => {
                            commonSearchInput.value = li.dataset.searchTerm;
                            applyCombinedFilters();
                        });
                        listEl.appendChild(li);
                    });
                } else {
                    listEl.innerHTML = '<li>لا توجد بيانات</li>';
                }
            };
            renderSimpleList(
                'topSellingProductsList', 
                topSellingProductsData, 
                (item) => item.name, 
                (item) => `الكمية: ${item.value} وحدة - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`
            );
            renderSimpleList(
                'topCustomersList', 
                topCustomersData, 
                (item) => item.name, 
                (item) => `فواتير: ${item.value} - الإجمالي: ${item.secondaryValue.toFixed(2)} DH`
            );
            renderSimpleList(
                'topInvoiceOwnersList', 
                topInvoiceOwnersData, 
                (item) => item.name, 
                (item) => `فواتير: ${item.value} - الربح: ${item.secondaryValue.toFixed(2)} DH`
            );
            renderSimpleList(
                'topSuppliersList', 
                topSuppliersData, 
                (item) => item.name, 
                (item) => `الشراء: ${item.value.toFixed(2)} DH - المنتجات: ${item.secondaryValue}`
            );
        }
        // ====== وظائف أرشيف الفواتير المحلية ======
        /**
         * حفظ فاتورة في التخزين المحلي.
         * @param {object} invoiceData - بيانات الفاتورة المراد حفظها.
         */
        function saveInvoiceToLocalStorage(invoiceData) {
            try {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices.push(invoiceData);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("تم حفظ الفاتورة محلياً.", 'success');
                displayLocalInvoices(); // تحديث قائمة الأرشيف
            } catch (e) {
                console.error("خطأ في حفظ الفاتورة إلى التخزين المحلي:", e);
                showToast("حدث خطأ أثناء حفظ الفاتورة محلياً.", 'error');
            }
        }
        /**
         * عرض الفواتير المحلية في قسم الأرشيف.
         * يتم عرض كل فاتورة كبطاقة "فاتورة مصغرة" مدمجة.
         */
        function displayLocalInvoices() {
            try {
                allLocalInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
            } catch (e) {
                console.error("خطأ في تحليل الفواتير المحلية من التخزين المحلي:", e);
                allLocalInvoices = []; // إعادة تعيين إذا كانت البيانات تالفة
                showToast("خطأ في قراءة أرشيف الفواتير المحلي. تم إعادة تعيينه.", 'error');
            }
            
            localInvoicesList.innerHTML = ''; // مسح القائمة الحالية
            const searchTerm = searchLocalInvoiceInput.value.toLowerCase();
            const filteredInvoices = allLocalInvoices.filter(invoice => {
                const matchesSearch = searchTerm ?
                    ((invoice.customerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.ownerName || '').toLowerCase().includes(searchTerm) ||
                    (invoice.date || '').toLowerCase().includes(searchTerm) ||
                    (invoice.products && invoice.products.some(p => (p.name || '').toLowerCase().includes(searchTerm))))
                    : true;
                return matchesSearch;
            });
            if (filteredInvoices.length === 0) {
                localInvoicesList.innerHTML = '<p class="empty-list-message">لا توجد فواتير محفوظة محلياً.</p>';
                return;
            }
            filteredInvoices.sort((a, b) => new Date(b.isoDate || b.date) - new Date(a.isoDate || a.date)); // الفرز حسب التاريخ (الأحدث أولاً)
            filteredInvoices.forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.classList.add('local-invoice-item'); 
                invoiceDiv.dataset.invoiceId = invoice.id; // تخزين معرف الفاتورة لمعالجة النقر
                // بناء محتوى الفاتورة المصغرة
                let productsTableHtml = '';
                if (invoice.products && invoice.products.length > 0) {
                    const productsToShow = invoice.products.slice(0, 3); // تحديد 3 منتجات فقط للعرض المصغر
                    productsTableHtml = `
                        <div class="table-responsive">
                            <table class="invoice-mini-table">
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        <th>الكمية</th>
                                        <th>الإجمالي (HT)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productsToShow.map(product => `
                                        <tr>
                                            <td>${product.name || 'N/A'}</td>
                                            <td>${product.quantityUsed || 0}</td>
                                            <td>${(parseFloat(product.sellingPrice || 0) * (product.quantityUsed || 0)).toFixed(2)} DH</td>
                                        </tr>
                                    `).join('')}
                                    ${invoice.products.length > 3 ? `<tr><td colspan="3" style="text-align:center;">... والمزيد (${invoice.products.length - 3})</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    productsTableHtml = '<p style="text-align: center; font-style: italic; color: var(--text-dark);">لا توجد منتجات في هذه الفاتورة.</p>';
                }
                invoiceDiv.innerHTML = `
                    <div class="invoice-mini-header">
                        <p><strong>العميل:</strong> ${invoice.customerName || 'N/A'}</p>
                        <p><strong>مالك الفاتورة:</strong> ${invoice.ownerName || 'N/A'}</p>
                        <p><strong>التاريخ:</strong> ${invoice.date || 'N/A'}</p>
                    </div>
                    ${productsTableHtml}
                    <div class="invoice-mini-footer">
                        <p><strong>الإجمالي (TTC):</strong> ${parseFloat(invoice.totalTTC || 0).toFixed(2)} DH</p>
                        <p><strong>الربح:</strong> ${parseFloat(invoice.totalProfit || 0).toFixed(2)} DH</p>
                    </div>
                    <div class="invoice-actions">
                        <button type="button" class="btn-delete" data-invoice-id="${invoice.id}"><span class="icon">🗑️</span>حذف</button>
                    </div>
                `;
                localInvoicesList.appendChild(invoiceDiv);
            });
        }
        // تفويض الأحداث لنقرات قائمة الفواتير المحلية (عرض وحذف)
        localInvoicesList.addEventListener('click', async (event) => {
            const target = event.target;
            const invoiceItem = target.closest('.local-invoice-item');
            if (!invoiceItem) return;
            const invoiceId = parseInt(invoiceItem.dataset.invoiceId);
            const invoiceToView = allLocalInvoices.find(inv => inv.id === invoiceId);
            if (target.classList.contains('btn-delete')) {
                event.stopPropagation(); // منع تشغيل عرض الفاتورة الكاملة إذا تم النقر على زر الحذف
                deleteLocalInvoice(invoiceId);
            } else if (invoiceToView) {
                event.stopPropagation(); // إيقاف انتشار الحدث لنقرة البطاقة
                await displayFullInvoice(invoiceToView, false); // عرض الفاتورة المؤرشفة (isNew = false)
            } else {
                showToast("الفاتورة غير موجودة في الأرشيف المحلي.", 'error');
            }
        });
        /**
         * حذف فاتورة من التخزين المحلي.
         * @param {number} invoiceId - معرف الفاتورة المراد حذفها.
         */
        async function deleteLocalInvoice(invoiceId) {
            const confirmed = await showConfirmModal("تأكيد الحذف", "هل أنت متأكد من أنك تريد حذف هذه الفاتورة من الأرشيف المحلي؟");
            if (confirmed) {
                let localInvoices = JSON.parse(localStorage.getItem('localInvoices') || '[]');
                localInvoices = localInvoices.filter(invoice => invoice.id !== invoiceId);
                localStorage.setItem('localInvoices', JSON.stringify(localInvoices));
                showToast("تم حذف الفاتورة بنجاح من الأرشيف المحلي.", 'success');
                displayLocalInvoices(); // تحديث قائمة الأرشيف
            } else {
                showToast("تم إلغاء حذف الفاتورة.", 'info');
            }
        }
        // معالج حدث للبحث في أرشيف الفواتير المحلية
        searchLocalInvoiceInput.addEventListener('input', displayLocalInvoices);
        
        // استدعاءات التحميل الأولية
        window.addEventListener('load', () => {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-MA', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const formattedTime = now.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' });
            invoiceDateInput.value = `${formattedDate} ${formattedTime}`;
            document.getElementById('displayInvoiceDate').setAttribute('datetime', now.toISOString());
            // تحميل قيم النموذج المحفوظة من التخزين المحلي
            invoiceOwnerInput.value = localStorage.getItem('invoiceOwner') || '';
            invoiceOwnerPhoneInput.value = localStorage.getItem('invoiceOwnerPhone') || '';
            invoiceOwnerAddressInput.value = localStorage.getItem('invoiceOwnerAddress') || '';
            supplierNameInput.value = localStorage.getItem('supplierName') || '';
            supplierAddressInput.value = localStorage.getItem('supplierAddress') || '';
            supplierPhoneInput.value = localStorage.getItem('supplierPhone') || '';
            invoiceCommissionPercentageInput.value = localStorage.getItem('invoiceCommissionPercentage') || '0';
            tvaInput.value = localStorage.getItem('tva') || '0';
            displayLocalInvoices();
            displaySavedProducts();
            // تعيين العرض الأولي للوحة التحكم وتفعيل الزر المقابل
            if (window.innerWidth <= 768) {
                setActiveButton(mobileShowDashboardButton, mobileNavButtons);
            } else {
                setActiveButton(desktopShowDashboardButton, desktopNavButtons);
            }
            mainContainer.classList.remove('full-width');
            resetProductFormAndButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>
