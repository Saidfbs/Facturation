<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" >
    <title>لوحة التحكم KC868-A16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .output-btn, .input-status, .ai-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 text-gray-800">

    <div class="container mx-auto max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-lg mt-8">
        
        <h1 class="text-4xl md:text-5xl font-bold text-center mb-6 text-gray-900">لوحة التحكم KC868-A16</h1>
        <p class="text-center text-lg mb-10 text-gray-600">مراقبة المداخل والتحكم بالمخارج الرقمية والتناظرية عبر الويب.</p>

        <!-- حقول إدخال بيانات Firebase -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-right border-r-4 border-blue-500 pr-3">إعدادات Firebase</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label for="db_url" class="text-sm font-medium mb-1 text-right">عنوان قاعدة البيانات (URL)</label>
                    <input type="text" id="db_url" placeholder="أدخل URL الخاص بقاعدة البيانات..." class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right">
                </div>
                <div class="flex flex-col">
                    <label for="db_device" class="text-sm font-medium mb-1 text-right">اسم الجهاز</label>
                    <input type="text" id="db_device" placeholder="أدخل اسم الجهاز..." class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right">
                </div>
            </div>
            <button id="save_btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition-colors duration-300">حفظ الإعدادات</button>
        </div>

        <!-- قسم المداخل الرقمية -->
        <div class="bg-gray-50 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-right border-r-4 border-blue-500 pr-3">المداخل الرقمية (قابلة للنقر)</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
                <div id="DI1" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI1</div>
                <div id="DI2" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI2</div>
                <div id="DI3" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI3</div>
                <div id="DI4" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI4</div>
                <div id="DI5" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI5</div>
                <div id="DI6" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI6</div>
                <div id="DI7" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI7</div>
                <div id="DI8" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI8</div>
                <div id="DI9" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI9</div>
                <div id="DI10" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI10</div>
                <div id="DI11" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI11</div>
                <div id="DI12" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI12</div>
                <div id="DI13" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI13</div>
                <div id="DI14" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI14</div>
                <div id="DI15" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI15</div>
                <div id="DI16" class="p-3 rounded-lg text-center font-bold text-white input-status cursor-pointer">DI16</div>
            </div>
        </div>

        <!-- قسم المداخل التناظرية -->
        <div class="bg-gray-50 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-right border-r-4 border-blue-500 pr-3">المداخل التناظرية (4–20mA)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-blue-100 rounded-lg shadow-sm text-right ai-container" id="AI1_container">
                    <div class="flex flex-col w-full">
                        <p class="font-bold text-lg">AI1</p>
                        <p id="AI1_current" class="text-sm text-gray-600">التيار: -- mA</p>
                        <p id="AI1_voltage" class="text-sm text-gray-600">الجهد: -- V</p>
                        <div class="mt-2 bg-gray-300 rounded-full h-2.5">
                            <div id="AI1_bar" class="bg-blue-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <input type="number" id="AI1_input" class="mt-2 text-right p-1 border border-gray-300 rounded-lg w-full" placeholder="أدخل قيمة">
                    </div>
                </div>
                <div class="p-4 bg-blue-100 rounded-lg shadow-sm text-right ai-container" id="AI2_container">
                    <div class="flex flex-col w-full">
                        <p class="font-bold text-lg">AI2</p>
                        <p id="AI2_current" class="text-sm text-gray-600">التيار: -- mA</p>
                        <p id="AI2_voltage" class="text-sm text-gray-600">الجهد: -- V</p>
                        <div class="mt-2 bg-gray-300 rounded-full h-2.5">
                            <div id="AI2_bar" class="bg-blue-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <input type="number" id="AI2_input" class="mt-2 text-right p-1 border border-gray-300 rounded-lg w-full" placeholder="أدخل قيمة">
                    </div>
                </div>
                <div class="p-4 bg-blue-100 rounded-lg shadow-sm text-right ai-container" id="AI3_container">
                    <div class="flex flex-col w-full">
                        <p class="font-bold text-lg">AI3</p>
                        <p id="AI3_current" class="text-sm text-gray-600">التيار: -- mA</p>
                        <p id="AI3_voltage" class="text-sm text-gray-600">الجهد: -- V</p>
                        <div class="mt-2 bg-gray-300 rounded-full h-2.5">
                            <div id="AI3_bar" class="bg-blue-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <input type="number" id="AI3_input" class="mt-2 text-right p-1 border border-gray-300 rounded-lg w-full" placeholder="أدخل قيمة">
                    </div>
                </div>
                <div class="p-4 bg-blue-100 rounded-lg shadow-sm text-right ai-container" id="AI4_container">
                    <div class="flex flex-col w-full">
                        <p class="font-bold text-lg">AI4</p>
                        <p id="AI4_current" class="text-sm text-gray-600">التيار: -- mA</p>
                        <p id="AI4_voltage" class="text-sm text-gray-600">الجهد: -- V</p>
                        <div class="mt-2 bg-gray-300 rounded-full h-2.5">
                            <div id="AI4_bar" class="bg-blue-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <input type="number" id="AI4_input" class="mt-2 text-right p-1 border border-gray-300 rounded-lg w-full" placeholder="أدخل قيمة">
                    </div>
                </div>
            </div>
        </div>

        <!-- قسم المخارج الرقمية -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-right border-r-4 border-blue-500 pr-3">المخارج الرقمية</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
                <a href="#" id="DO1" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO1</a>
                <a href="#" id="DO2" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO2</a>
                <a href="#" id="DO3" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO3</a>
                <a href="#" id="DO4" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO4</a>
                <a href="#" id="DO5" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO5</a>
                <a href="#" id="DO6" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO6</a>
                <a href="#" id="DO7" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO7</a>
                <a href="#" id="DO8" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO8</a>
                <a href="#" id="DO9" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO9</a>
                <a href="#" id="DO10" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO10</a>
                <a href="#" id="DO11" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO11</a>
                <a href="#" id="DO12" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO12</a>
                <a href="#" id="DO13" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO13</a>
                <a href="#" id="DO14" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO14</a>
                <a href="#" id="DO15" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO15</a>
                <a href="#" id="DO16" class="py-3 rounded-lg text-white font-bold transition-colors duration-300 transform hover:scale-105 shadow-md output-btn">DO16</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dbUrlInput = document.getElementById('db_url');
            const dbDeviceInput = document.getElementById('db_device');
            const saveBtn = document.getElementById('save_btn');

            const storedUrl = localStorage.getItem('firebaseURL');
            const storedDevice = localStorage.getItem('firebaseDevice');

            if (storedUrl) {
                dbUrlInput.value = storedUrl;
            }
            if (storedDevice) {
                dbDeviceInput.value = storedDevice;
            }

            saveBtn.addEventListener('click', () => {
                const newUrl = dbUrlInput.value.trim();
                const newDevice = dbDeviceInput.value.trim();

                if (newUrl && newDevice) {
                    localStorage.setItem('firebaseURL', newUrl);
                    localStorage.setItem('firebaseDevice', newDevice);
                    alert('تم حفظ الإعدادات بنجاح!');
                    location.reload();
                } else {
                    alert('الرجاء إدخال عنوان قاعدة البيانات واسم الجهاز.');
                }
            });

            if (storedUrl && storedDevice) {
                const firebaseConfig = {
                    databaseURL: storedUrl,
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const database = firebase.database();
                const deviceRef = database.ref(storedDevice);

                // دالة لتبديل الحالة بين 0 و 1
                const toggleState = (ref) => {
                    ref.once('value', snapshot => {
                        const currentValue = snapshot.val();
                        const newValue = (currentValue === 1) ? 0 : 1;
                        ref.set(newValue);
                    });
                };

                // دالة لتعيين القيم الافتراضية إذا لم تكن موجودة
                const setDefaultValues = () => {
                    // تعيين القيم الافتراضية للمداخل والمخارج الرقمية (1)
                    for (let i = 1; i <= 16; i++) {
                        const doRef = deviceRef.child('DO').child(`DO${i}`);
                        doRef.once('value', snapshot => {
                            if (!snapshot.exists()) {
                                doRef.set(1);
                            }
                        });
                        const diRef = deviceRef.child('DI').child(`DI${i}`);
                        diRef.once('value', snapshot => {
                            if (!snapshot.exists()) {
                                diRef.set(1);
                            }
                        });
                    }

                    // تعيين القيم الافتراضية للمداخل التناظرية (55)
                    for (let i = 1; i <= 4; i++) {
                        const aiRef = deviceRef.child('AI').child(`AI${i}`);
                        aiRef.once('value', snapshot => {
                            if (!snapshot.exists()) {
                                aiRef.set({
                                    current: 55,
                                    voltage: 55
                                });
                            }
                        });
                    }
                };
                setDefaultValues();

                // 1. التحكم في المخارج الرقمية (Digital Outputs - DO)
                const setupOutputControls = () => {
                    for (let i = 1; i <= 16; i++) {
                        const outputId = `DO${i}`;
                        const button = document.getElementById(outputId);
                        if (button) {
                            const doRef = deviceRef.child('DO').child(outputId);
                            button.addEventListener('click', (e) => {
                                e.preventDefault();
                                toggleState(doRef);
                            });
                            doRef.on('value', snapshot => {
                                const value = snapshot.val();
                                button.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-red-600', 'hover:bg-red-700');
                                if (value === 1) {
                                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                                } else {
                                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                                }
                            });
                        }
                    }
                };

                // 2. تحديث حالة المداخل الرقمية (Digital Inputs - DI)
                const updateDigitalInputs = () => {
                    for (let i = 1; i <= 16; i++) {
                        const inputId = `DI${i}`;
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            const diRef = deviceRef.child('DI').child(inputId);
                            inputElement.addEventListener('click', () => {
                                toggleState(diRef);
                            });
                            diRef.on('value', snapshot => {
                                const value = snapshot.val();
                                inputElement.classList.remove('bg-green-500', 'bg-red-500');
                                if (value === 1) {
                                    inputElement.classList.add('bg-green-500');
                                } else {
                                    inputElement.classList.add('bg-red-500');
                                }
                            });
                        }
                    }
                };

                // 3. تحديث قيم المداخل التناظرية (Analog Inputs - AI)
                const updateAnalogInputs = () => {
                    for (let i = 1; i <= 4; i++) {
                        const inputId = `AI${i}`;
                        const currentElement = document.getElementById(`${inputId}_current`);
                        const voltageElement = document.getElementById(`${inputId}_voltage`);
                        const inputElement = document.getElementById(`${inputId}_input`);
                        const barElement = document.getElementById(`${inputId}_bar`);

                        if (currentElement && voltageElement && inputElement && barElement) {
                            const aiRef = deviceRef.child('AI').child(inputId);
                            inputElement.addEventListener('change', () => {
                                const newValue = parseFloat(inputElement.value);
                                if (!isNaN(newValue)) {
                                    aiRef.set({
                                        current: newValue,
                                        voltage: newValue
                                    });
                                } else {
                                    alert('الرجاء إدخال قيمة رقمية صحيحة.');
                                }
                            });

                            aiRef.on('value', snapshot => {
                                const value = snapshot.val();
                                if (value && typeof value === 'object') {
                                    const current = value.current;
                                    currentElement.textContent = `التيار: ${current.toFixed(2)} mA`;
                                    voltageElement.textContent = `الجهد: ${value.voltage.toFixed(2)} V`;
                                    inputElement.value = current;

                                    const percentage = Math.min(Math.max((current - 4) / 16 * 100, 0), 100);
                                    barElement.style.width = `${percentage}%`;
                                    
                                } else {
                                    currentElement.textContent = `التيار: -- mA`;
                                    voltageElement.textContent = `الجهد: -- V`;
                                    inputElement.value = '';
                                    barElement.style.width = '0%';
                                }
                            });
                        }
                    }
                };

                setupOutputControls();
                updateDigitalInputs();
                updateAnalogInputs();
            }
        });
    </script>
</body>
</html>
